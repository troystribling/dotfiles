"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_1 = __importDefault(require("fs"));
const jmp_1 = require("@aminya/jmp");
const uuid_1 = require("uuid");
const spawnteract_1 = require("spawnteract");
const config_1 = __importDefault(require("./config"));
const kernel_transport_1 = __importDefault(require("./kernel-transport"));
const utils_1 = require("./utils");
class ZMQKernel extends kernel_transport_1.default {
    constructor(kernelSpec, grammar, options, onStarted) {
        super(kernelSpec, grammar);
        this.executionCallbacks = {};
        this.options = options || {};
        options.cleanupConnectionFile = false;
        spawnteract_1.launchSpec(kernelSpec, options).then(({ config, connectionFile, spawn }) => {
            this.connection = config;
            this.connectionFile = connectionFile;
            this.kernelProcess = spawn;
            this.monitorNotifications(spawn);
            this.connect(() => {
                this._executeStartupCode();
                if (onStarted) {
                    onStarted(this);
                }
            });
        });
    }
    connect(done) {
        const scheme = this.connection.signature_scheme.slice("hmac-".length);
        const { key } = this.connection;
        this.shellSocket = new jmp_1.Socket("dealer", scheme, key);
        this.stdinSocket = new jmp_1.Socket("dealer", scheme, key);
        this.ioSocket = new jmp_1.Socket("sub", scheme, key);
        const id = uuid_1.v4();
        this.shellSocket.identity = `dealer${id}`;
        this.stdinSocket.identity = `dealer${id}`;
        this.ioSocket.identity = `sub${id}`;
        const address = `${this.connection.transport}://${this.connection.ip}:`;
        this.shellSocket.connect(address + this.connection.shell_port);
        this.ioSocket.connect(address + this.connection.iopub_port);
        this.ioSocket.subscribe("");
        this.stdinSocket.connect(address + this.connection.stdin_port);
        this.shellSocket.on("message", this.onShellMessage.bind(this));
        this.ioSocket.on("message", this.onIOMessage.bind(this));
        this.stdinSocket.on("message", this.onStdinMessage.bind(this));
        this.monitor(done);
    }
    monitorNotifications(childProcess) {
        childProcess.stdout.on("data", (data) => {
            data = data.toString();
            if (atom.config.get("Hydrogen.kernelNotifications")) {
                atom.notifications.addInfo(this.kernelSpec.display_name, {
                    description: data,
                    dismissable: true,
                });
            }
            else {
                utils_1.log("ZMQKernel: stdout:", data);
            }
        });
        childProcess.stderr.on("data", (data) => {
            atom.notifications.addError(this.kernelSpec.display_name, {
                description: data.toString(),
                dismissable: true,
            });
        });
    }
    monitor(done) {
        try {
            const socketNames = ["shellSocket", "ioSocket"];
            let waitGroup = socketNames.length;
            const onConnect = ({ socketName, socket }) => {
                utils_1.log(`ZMQKernel: ${socketName} connected`);
                socket.unmonitor();
                waitGroup--;
                if (waitGroup === 0) {
                    utils_1.log("ZMQKernel: all main sockets connected");
                    this.setExecutionState("idle");
                    if (done) {
                        done();
                    }
                }
            };
            const monitor = (socketName, socket) => {
                utils_1.log(`ZMQKernel: monitor ${socketName}`);
                socket.on("connect", onConnect.bind(this, {
                    socketName,
                    socket,
                }));
                socket.monitor();
            };
            monitor("shellSocket", this.shellSocket);
            monitor("ioSocket", this.ioSocket);
        }
        catch (err) {
            utils_1.log("ZMQKernel:", err);
        }
    }
    interrupt() {
        if (process.platform === "win32") {
            atom.notifications.addWarning("Cannot interrupt this kernel", {
                detail: "Kernel interruption is currently not supported in Windows.",
            });
        }
        else {
            utils_1.log("ZMQKernel: sending SIGINT");
            this.kernelProcess.kill("SIGINT");
        }
    }
    _kill() {
        utils_1.log("ZMQKernel: sending SIGKILL");
        this.kernelProcess.kill("SIGKILL");
    }
    _executeStartupCode() {
        const displayName = this.kernelSpec.display_name;
        let startupCode = config_1.default.getJson("startupCode")[displayName];
        if (startupCode) {
            utils_1.log("KernelManager: Executing startup code:", startupCode);
            startupCode += "\n";
            this.execute(startupCode, (message, channel) => { });
        }
    }
    shutdown() {
        this._socketShutdown();
    }
    restart(onRestarted) {
        this._socketRestart(onRestarted);
    }
    _socketShutdown(restart = false) {
        const requestId = `shutdown_${uuid_1.v4()}`;
        const message = _createMessage("shutdown_request", requestId);
        message.content = {
            restart,
        };
        this.shellSocket.send(new jmp_1.Message(message));
    }
    _socketRestart(onRestarted) {
        if (this.executionState === "restarting") {
            return;
        }
        this.setExecutionState("restarting");
        this._socketShutdown(true);
        this._kill();
        const { spawn } = spawnteract_1.launchSpecFromConnectionInfo(this.kernelSpec, this.connection, this.connectionFile, this.options);
        this.kernelProcess = spawn;
        this.monitor(() => {
            this._executeStartupCode();
            if (onRestarted) {
                onRestarted();
            }
        });
    }
    execute(code, onResults) {
        utils_1.log("ZMQKernel.execute:", code);
        const requestId = `execute_${uuid_1.v4()}`;
        const message = _createMessage("execute_request", requestId);
        message.content = {
            code,
            silent: false,
            store_history: true,
            user_expressions: {},
            allow_stdin: true,
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    complete(code, onResults) {
        utils_1.log("ZMQKernel.complete:", code);
        const requestId = `complete_${uuid_1.v4()}`;
        const message = _createMessage("complete_request", requestId);
        message.content = {
            code,
            text: code,
            line: code,
            cursor_pos: utils_1.js_idx_to_char_idx(code.length, code),
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    inspect(code, cursorPos, onResults) {
        utils_1.log("ZMQKernel.inspect:", code, cursorPos);
        const requestId = `inspect_${uuid_1.v4()}`;
        const message = _createMessage("inspect_request", requestId);
        message.content = {
            code,
            cursor_pos: cursorPos,
            detail_level: 0,
        };
        this.executionCallbacks[requestId] = onResults;
        this.shellSocket.send(new jmp_1.Message(message));
    }
    inputReply(input) {
        const requestId = `input_reply_${uuid_1.v4()}`;
        const message = _createMessage("input_reply", requestId);
        message.content = {
            value: input,
        };
        this.stdinSocket.send(new jmp_1.Message(message));
    }
    onShellMessage(message) {
        utils_1.log("shell message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "shell");
        }
    }
    onStdinMessage(message) {
        utils_1.log("stdin message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "stdin");
        }
    }
    onIOMessage(message) {
        utils_1.log("IO message:", message);
        if (!_isValidMessage(message)) {
            return;
        }
        const { msg_type } = message.header;
        if (msg_type === "status") {
            const status = message.content.execution_state;
            this.setExecutionState(status);
        }
        const { msg_id } = message.parent_header;
        let callback;
        if (msg_id) {
            callback = this.executionCallbacks[msg_id];
        }
        if (callback) {
            callback(message, "iopub");
        }
    }
    destroy() {
        utils_1.log("ZMQKernel: destroy:", this);
        this.shutdown();
        this._kill();
        fs_1.default.unlinkSync(this.connectionFile);
        this.shellSocket.close();
        this.ioSocket.close();
        this.stdinSocket.close();
        super.destroy();
    }
}
exports.default = ZMQKernel;
function _isValidMessage(message) {
    if (!message) {
        utils_1.log("Invalid message: null");
        return false;
    }
    if (!message.content) {
        utils_1.log("Invalid message: Missing content");
        return false;
    }
    if (message.content.execution_state === "starting") {
        utils_1.log("Dropped starting status IO message");
        return false;
    }
    if (!message.parent_header) {
        utils_1.log("Invalid message: Missing parent_header");
        return false;
    }
    if (!message.parent_header.msg_id) {
        utils_1.log("Invalid message: Missing parent_header.msg_id");
        return false;
    }
    if (!message.parent_header.msg_type) {
        utils_1.log("Invalid message: Missing parent_header.msg_type");
        return false;
    }
    if (!message.header) {
        utils_1.log("Invalid message: Missing header");
        return false;
    }
    if (!message.header.msg_id) {
        utils_1.log("Invalid message: Missing header.msg_id");
        return false;
    }
    if (!message.header.msg_type) {
        utils_1.log("Invalid message: Missing header.msg_type");
        return false;
    }
    return true;
}
function _getUsername() {
    return (process.env.LOGNAME ||
        process.env.USER ||
        process.env.LNAME ||
        process.env.USERNAME);
}
function _createMessage(msgType, msgId = uuid_1.v4()) {
    const message = {
        header: {
            username: _getUsername(),
            session: "00000000-0000-0000-0000-000000000000",
            msg_type: msgType,
            msg_id: msgId,
            date: new Date(),
            version: "5.0",
        },
        metadata: {},
        parent_header: {},
        content: {},
    };
    return message;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem1xLWtlcm5lbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi96bXEta2VybmVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUEsNENBQW9CO0FBQ3BCLHFDQUE4QztBQUM5QywrQkFBMEI7QUFDMUIsNkNBQXVFO0FBQ3ZFLHNEQUE4QjtBQUM5QiwwRUFBaUQ7QUFFakQsbUNBQWtEO0FBZWxELE1BQXFCLFNBQVUsU0FBUSwwQkFBZTtJQVVwRCxZQUNFLFVBQThCLEVBQzlCLE9BQWdCLEVBQ2hCLE9BQTRCLEVBQzVCLFNBQTREO1FBRTVELEtBQUssQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFmN0IsdUJBQWtCLEdBQXdCLEVBQUUsQ0FBQztRQWdCM0MsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLElBQUksRUFBRSxDQUFDO1FBRTdCLE9BQU8sQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFDdEMsd0JBQVUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUNsQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGNBQWMsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBQ3BDLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO1lBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1lBQzNCLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRTtnQkFDaEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7Z0JBRTNCLElBQUksU0FBUyxFQUFFO29CQUNiLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDakI7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVELE9BQU8sQ0FBQyxJQUF1RDtRQUM3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dCB7IEdyYW1tYXIgfSBmcm9tIFwiYXRvbVwiO1xuaW1wb3J0IHsgQ2hpbGRQcm9jZXNzIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IE1lc3NhZ2UsIFNvY2tldCB9IGZyb20gXCJAYW1pbnlhL2ptcFwiO1xuaW1wb3J0IHsgdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgbGF1bmNoU3BlYywgbGF1bmNoU3BlY0Zyb21Db25uZWN0aW9uSW5mbyB9IGZyb20gXCJzcGF3bnRlcmFjdFwiO1xuaW1wb3J0IENvbmZpZyBmcm9tIFwiLi9jb25maWdcIjtcbmltcG9ydCBLZXJuZWxUcmFuc3BvcnQgZnJvbSBcIi4va2VybmVsLXRyYW5zcG9ydFwiO1xuaW1wb3J0IHR5cGUgeyBSZXN1bHRzQ2FsbGJhY2sgfSBmcm9tIFwiLi9rZXJuZWwtdHJhbnNwb3J0XCI7XG5pbXBvcnQgeyBsb2csIGpzX2lkeF90b19jaGFyX2lkeCB9IGZyb20gXCIuL3V0aWxzXCI7XG5pbXBvcnQgdHlwZSB7IEtlcm5lbHNwZWNNZXRhZGF0YSB9IGZyb20gXCJAbnRlcmFjdC90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBDb25uZWN0aW9uID0ge1xuICBjb250cm9sX3BvcnQ6IG51bWJlcjtcbiAgaGJfcG9ydDogbnVtYmVyO1xuICBpb3B1Yl9wb3J0OiBudW1iZXI7XG4gIGlwOiBzdHJpbmc7XG4gIGtleTogc3RyaW5nO1xuICBzaGVsbF9wb3J0OiBudW1iZXI7XG4gIHNpZ25hdHVyZV9zY2hlbWU6IHN0cmluZztcbiAgc3RkaW5fcG9ydDogbnVtYmVyO1xuICB0cmFuc3BvcnQ6IHN0cmluZztcbiAgdmVyc2lvbjogbnVtYmVyO1xufTtcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFpNUUtlcm5lbCBleHRlbmRzIEtlcm5lbFRyYW5zcG9ydCB7XG4gIGV4ZWN1dGlvbkNhbGxiYWNrczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICBjb25uZWN0aW9uOiBDb25uZWN0aW9uO1xuICBjb25uZWN0aW9uRmlsZTogc3RyaW5nO1xuICBrZXJuZWxQcm9jZXNzOiBDaGlsZFByb2Nlc3M7XG4gIG9wdGlvbnM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIHNoZWxsU29ja2V0OiBTb2NrZXQ7XG4gIHN0ZGluU29ja2V0OiBTb2NrZXQ7XG4gIGlvU29ja2V0OiBTb2NrZXQ7XG5cbiAgY29uc3RydWN0b3IoXG4gICAga2VybmVsU3BlYzogS2VybmVsc3BlY01ldGFkYXRhLFxuICAgIGdyYW1tYXI6IEdyYW1tYXIsXG4gICAgb3B0aW9uczogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBvblN0YXJ0ZWQ6ICgoLi4uYXJnczogQXJyYXk8YW55PikgPT4gYW55KSB8IG51bGwgfCB1bmRlZmluZWRcbiAgKSB7XG4gICAgc3VwZXIoa2VybmVsU3BlYywgZ3JhbW1hcik7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcbiAgICAvLyBPdGhlcndpc2Ugc3Bhd250ZXJhY3QgZGVsZXRlcyB0aGUgZmlsZSBhbmQgaHlkcm9nZW4ncyByZXN0YXJ0IGtlcm5lbCBmYWlsc1xuICAgIG9wdGlvbnMuY2xlYW51cENvbm5lY3Rpb25GaWxlID0gZmFsc2U7XG4gICAgbGF1bmNoU3BlYyhrZXJuZWxTcGVjLCBvcHRpb25zKS50aGVuKFxuICAgICAgKHsgY29uZmlnLCBjb25uZWN0aW9uRmlsZSwgc3Bhd24gfSkgPT4ge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24gPSBjb25maWc7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbkZpbGUgPSBjb25uZWN0aW9uRmlsZTtcbiAgICAgICAgdGhpcy5rZXJuZWxQcm9jZXNzID0gc3Bhd247XG4gICAgICAgIHRoaXMubW9uaXRvck5vdGlmaWNhdGlvbnMoc3Bhd24pO1xuICAgICAgICB0aGlzLmNvbm5lY3QoKCkgPT4ge1xuICAgICAgICAgIHRoaXMuX2V4ZWN1dGVTdGFydHVwQ29kZSgpO1xuXG4gICAgICAgICAgaWYgKG9uU3RhcnRlZCkge1xuICAgICAgICAgICAgb25TdGFydGVkKHRoaXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGNvbm5lY3QoZG9uZTogKCguLi5hcmdzOiBBcnJheTxhbnk+KSA9PiBhbnkpIHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICAgIGNvbnN0IHNjaGVtZSA9IHRoaXMuY29ubmVjdGlvbi5zaWduYXR1cmVfc2NoZW1lLnNsaWNlKFwiaG1hYy1cIi5sZW5ndGgpO1xuICAgIGNvbnN0IHsga2V5IH0gPSB0aGlzLmNvbm5lY3Rpb247XG4gICAgdGhpcy5zaGVsbFNvY2tldCA9IG5ldyBTb2NrZXQoXCJkZWFsZXJcIiwgc2NoZW1lLCBrZXkpO1xuICAgIHRoaXMuc3RkaW5Tb2NrZXQgPSBuZXcgU29ja2V0KFwiZGVhbGVyXCIsIHNjaGVtZSwga2V5KTtcbiAgICB0aGlzLmlvU29ja2V0ID0gbmV3IFNvY2tldChcInN1YlwiLCBzY2hlbWUsIGtleSk7XG4gICAgY29uc3QgaWQgPSB2NCgpO1xuICAgIHRoaXMuc2hlbGxTb2NrZXQuaWRlbnRpdHkgPSBgZGVhbGVyJHtpZH1gO1xuICAgIHRoaXMuc3RkaW5Tb2NrZXQuaWRlbnRpdHkgPSBgZGVhbGVyJHtpZH1gO1xuICAgIHRoaXMuaW9Tb2NrZXQuaWRlbnRpdHkgPSBgc3ViJHtpZH1gO1xuICAgIGNvbnN0IGFkZHJlc3MgPSBgJHt0aGlzLmNvbm5lY3Rpb24udHJhbnNwb3J0fTovLyR7dGhpcy5jb25uZWN0aW9uLmlwfTpgO1xuICAgIHRoaXMuc2hlbGxTb2NrZXQuY29ubmVjdChhZGRyZXNzICsgdGhpcy5jb25uZWN0aW9uLnNoZWxsX3BvcnQpO1xuICAgIHRoaXMuaW9Tb2NrZXQuY29ubmVjdChhZGRyZXNzICsgdGhpcy5jb25uZWN0aW9uLmlvcHViX3BvcnQpO1xuICAgIHRoaXMuaW9Tb2NrZXQuc3Vic2NyaWJlKFwiXCIpO1xuICAgIHRoaXMuc3RkaW5Tb2NrZXQuY29ubmVjdChhZGRyZXNzICsgdGhpcy5jb25uZWN0aW9uLnN0ZGluX3BvcnQpO1xuICAgIHRoaXMuc2hlbGxTb2NrZXQub24oXCJtZXNzYWdlXCIsIHRoaXMub25TaGVsbE1lc3NhZ2UuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5pb1NvY2tldC5vbihcIm1lc3NhZ2VcIiwgdGhpcy5vbklPTWVzc2FnZS5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnN0ZGluU29ja2V0Lm9uKFwibWVzc2FnZVwiLCB0aGlzLm9uU3RkaW5NZXNzYWdlLmJpbmQodGhpcykpO1xuICAgIHRoaXMubW9uaXRvcihkb25lKTtcbiAgfVxuXG4gIG1vbml0b3JOb3RpZmljYXRpb25zKGNoaWxkUHJvY2VzczogQ2hpbGRQcm9jZXNzKSB7XG4gICAgY2hpbGRQcm9jZXNzLnN0ZG91dC5vbihcImRhdGFcIiwgKGRhdGE6IHN0cmluZyB8IEJ1ZmZlcikgPT4ge1xuICAgICAgZGF0YSA9IGRhdGEudG9TdHJpbmcoKTtcblxuICAgICAgaWYgKGF0b20uY29uZmlnLmdldChcIkh5ZHJvZ2VuLmtlcm5lbE5vdGlmaWNhdGlvbnNcIikpIHtcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8odGhpcy5rZXJuZWxTcGVjLmRpc3BsYXlfbmFtZSwge1xuICAgICAgICAgIGRlc2NyaXB0aW9uOiBkYXRhLFxuICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZyhcIlpNUUtlcm5lbDogc3Rkb3V0OlwiLCBkYXRhKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjaGlsZFByb2Nlc3Muc3RkZXJyLm9uKFwiZGF0YVwiLCAoZGF0YTogc3RyaW5nIHwgQnVmZmVyKSA9PiB7XG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IodGhpcy5rZXJuZWxTcGVjLmRpc3BsYXlfbmFtZSwge1xuICAgICAgICBkZXNjcmlwdGlvbjogZGF0YS50b1N0cmluZygpLFxuICAgICAgICBkaXNtaXNzYWJsZTogdHJ1ZSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgbW9uaXRvcihkb25lOiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHNvY2tldE5hbWVzID0gW1wic2hlbGxTb2NrZXRcIiwgXCJpb1NvY2tldFwiXTtcbiAgICAgIGxldCB3YWl0R3JvdXAgPSBzb2NrZXROYW1lcy5sZW5ndGg7XG5cbiAgICAgIGNvbnN0IG9uQ29ubmVjdCA9ICh7IHNvY2tldE5hbWUsIHNvY2tldCB9KSA9PiB7XG4gICAgICAgIGxvZyhgWk1RS2VybmVsOiAke3NvY2tldE5hbWV9IGNvbm5lY3RlZGApO1xuICAgICAgICBzb2NrZXQudW5tb25pdG9yKCk7XG4gICAgICAgIHdhaXRHcm91cC0tO1xuXG4gICAgICAgIGlmICh3YWl0R3JvdXAgPT09IDApIHtcbiAgICAgICAgICBsb2coXCJaTVFLZXJuZWw6IGFsbCBtYWluIHNvY2tldHMgY29ubmVjdGVkXCIpO1xuICAgICAgICAgIHRoaXMuc2V0RXhlY3V0aW9uU3RhdGUoXCJpZGxlXCIpO1xuICAgICAgICAgIGlmIChkb25lKSB7XG4gICAgICAgICAgICBkb25lKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgICBjb25zdCBtb25pdG9yID0gKHNvY2tldE5hbWUsIHNvY2tldCkgPT4ge1xuICAgICAgICBsb2coYFpNUUtlcm5lbDogbW9uaXRvciAke3NvY2tldE5hbWV9YCk7XG4gICAgICAgIHNvY2tldC5vbihcbiAgICAgICAgICBcImNvbm5lY3RcIixcbiAgICAgICAgICBvbkNvbm5lY3QuYmluZCh0aGlzLCB7XG4gICAgICAgICAgICBzb2NrZXROYW1lLFxuICAgICAgICAgICAgc29ja2V0LFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICAgIHNvY2tldC5tb25pdG9yKCk7XG4gICAgICB9O1xuXG4gICAgICBtb25pdG9yKFwic2hlbGxTb2NrZXRcIiwgdGhpcy5zaGVsbFNvY2tldCk7XG4gICAgICBtb25pdG9yKFwiaW9Tb2NrZXRcIiwgdGhpcy5pb1NvY2tldCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2coXCJaTVFLZXJuZWw6XCIsIGVycik7XG4gICAgfVxuICB9XG5cbiAgaW50ZXJydXB0KCkge1xuICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIpIHtcbiAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRXYXJuaW5nKFwiQ2Fubm90IGludGVycnVwdCB0aGlzIGtlcm5lbFwiLCB7XG4gICAgICAgIGRldGFpbDogXCJLZXJuZWwgaW50ZXJydXB0aW9uIGlzIGN1cnJlbnRseSBub3Qgc3VwcG9ydGVkIGluIFdpbmRvd3MuXCIsXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nKFwiWk1RS2VybmVsOiBzZW5kaW5nIFNJR0lOVFwiKTtcbiAgICAgIHRoaXMua2VybmVsUHJvY2Vzcy5raWxsKFwiU0lHSU5UXCIpO1xuICAgIH1cbiAgfVxuXG4gIF9raWxsKCkge1xuICAgIGxvZyhcIlpNUUtlcm5lbDogc2VuZGluZyBTSUdLSUxMXCIpO1xuICAgIHRoaXMua2VybmVsUHJvY2Vzcy5raWxsKFwiU0lHS0lMTFwiKTtcbiAgfVxuXG4gIF9leGVjdXRlU3RhcnR1cENvZGUoKSB7XG4gICAgY29uc3QgZGlzcGxheU5hbWUgPSB0aGlzLmtlcm5lbFNwZWMuZGlzcGxheV9uYW1lO1xuICAgIGxldCBzdGFydHVwQ29kZSA9IENvbmZpZy5nZXRKc29uKFwic3RhcnR1cENvZGVcIilbZGlzcGxheU5hbWVdO1xuXG4gICAgaWYgKHN0YXJ0dXBDb2RlKSB7XG4gICAgICBsb2coXCJLZXJuZWxNYW5hZ2VyOiBFeGVjdXRpbmcgc3RhcnR1cCBjb2RlOlwiLCBzdGFydHVwQ29kZSk7XG4gICAgICBzdGFydHVwQ29kZSArPSBcIlxcblwiO1xuICAgICAgdGhpcy5leGVjdXRlKHN0YXJ0dXBDb2RlLCAobWVzc2FnZSwgY2hhbm5lbCkgPT4ge30pO1xuICAgIH1cbiAgfVxuXG4gIHNodXRkb3duKCkge1xuICAgIHRoaXMuX3NvY2tldFNodXRkb3duKCk7XG4gIH1cblxuICByZXN0YXJ0KG9uUmVzdGFydGVkOiAoKC4uLmFyZ3M6IEFycmF5PGFueT4pID0+IGFueSkgfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5fc29ja2V0UmVzdGFydChvblJlc3RhcnRlZCk7XG4gIH1cblxuICBfc29ja2V0U2h1dGRvd24ocmVzdGFydDogYm9vbGVhbiB8IG51bGwgfCB1bmRlZmluZWQgPSBmYWxzZSkge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBzaHV0ZG93bl8ke3Y0KCl9YDtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBfY3JlYXRlTWVzc2FnZShcInNodXRkb3duX3JlcXVlc3RcIiwgcmVxdWVzdElkKTtcblxuICAgIG1lc3NhZ2UuY29udGVudCA9IHtcbiAgICAgIHJlc3RhcnQsXG4gICAgfTtcbiAgICB0aGlzLnNoZWxsU29ja2V0LnNlbmQobmV3IE1lc3NhZ2UobWVzc2FnZSkpO1xuICB9XG5cbiAgX3NvY2tldFJlc3RhcnQoXG4gICAgb25SZXN0YXJ0ZWQ6ICgoLi4uYXJnczogQXJyYXk8YW55PikgPT4gYW55KSB8IG51bGwgfCB1bmRlZmluZWRcbiAgKSB7XG4gICAgaWYgKHRoaXMuZXhlY3V0aW9uU3RhdGUgPT09IFwicmVzdGFydGluZ1wiKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5zZXRFeGVjdXRpb25TdGF0ZShcInJlc3RhcnRpbmdcIik7XG5cbiAgICB0aGlzLl9zb2NrZXRTaHV0ZG93bih0cnVlKTtcblxuICAgIHRoaXMuX2tpbGwoKTtcblxuICAgIGNvbnN0IHsgc3Bhd24gfSA9IGxhdW5jaFNwZWNGcm9tQ29ubmVjdGlvbkluZm8oXG4gICAgICB0aGlzLmtlcm5lbFNwZWMsXG4gICAgICB0aGlzLmNvbm5lY3Rpb24sXG4gICAgICB0aGlzLmNvbm5lY3Rpb25GaWxlLFxuICAgICAgdGhpcy5vcHRpb25zXG4gICAgKTtcbiAgICB0aGlzLmtlcm5lbFByb2Nlc3MgPSBzcGF3bjtcbiAgICB0aGlzLm1vbml0b3IoKCkgPT4ge1xuICAgICAgdGhpcy5fZXhlY3V0ZVN0YXJ0dXBDb2RlKCk7XG5cbiAgICAgIGlmIChvblJlc3RhcnRlZCkge1xuICAgICAgICBvblJlc3RhcnRlZCgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLy8gb25SZXN1bHRzIGlzIGEgY2FsbGJhY2sgdGhhdCBtYXkgYmUgY2FsbGVkIG11bHRpcGxlIHRpbWVzXG4gIC8vIGFzIHJlc3VsdHMgY29tZSBpbiBmcm9tIHRoZSBrZXJuZWxcbiAgZXhlY3V0ZShjb2RlOiBzdHJpbmcsIG9uUmVzdWx0czogUmVzdWx0c0NhbGxiYWNrKSB7XG4gICAgbG9nKFwiWk1RS2VybmVsLmV4ZWN1dGU6XCIsIGNvZGUpO1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBleGVjdXRlXyR7djQoKX1gO1xuXG4gICAgY29uc3QgbWVzc2FnZSA9IF9jcmVhdGVNZXNzYWdlKFwiZXhlY3V0ZV9yZXF1ZXN0XCIsIHJlcXVlc3RJZCk7XG5cbiAgICBtZXNzYWdlLmNvbnRlbnQgPSB7XG4gICAgICBjb2RlLFxuICAgICAgc2lsZW50OiBmYWxzZSxcbiAgICAgIHN0b3JlX2hpc3Rvcnk6IHRydWUsXG4gICAgICB1c2VyX2V4cHJlc3Npb25zOiB7fSxcbiAgICAgIGFsbG93X3N0ZGluOiB0cnVlLFxuICAgIH07XG4gICAgdGhpcy5leGVjdXRpb25DYWxsYmFja3NbcmVxdWVzdElkXSA9IG9uUmVzdWx0cztcbiAgICB0aGlzLnNoZWxsU29ja2V0LnNlbmQobmV3IE1lc3NhZ2UobWVzc2FnZSkpO1xuICB9XG5cbiAgY29tcGxldGUoY29kZTogc3RyaW5nLCBvblJlc3VsdHM6IFJlc3VsdHNDYWxsYmFjaykge1xuICAgIGxvZyhcIlpNUUtlcm5lbC5jb21wbGV0ZTpcIiwgY29kZSk7XG4gICAgY29uc3QgcmVxdWVzdElkID0gYGNvbXBsZXRlXyR7djQoKX1gO1xuXG4gICAgY29uc3QgbWVzc2FnZSA9IF9jcmVhdGVNZXNzYWdlKFwiY29tcGxldGVfcmVxdWVzdFwiLCByZXF1ZXN0SWQpO1xuXG4gICAgbWVzc2FnZS5jb250ZW50ID0ge1xuICAgICAgY29kZSxcbiAgICAgIHRleHQ6IGNvZGUsXG4gICAgICBsaW5lOiBjb2RlLFxuICAgICAgY3Vyc29yX3BvczoganNfaWR4X3RvX2NoYXJfaWR4KGNvZGUubGVuZ3RoLCBjb2RlKSxcbiAgICB9O1xuICAgIHRoaXMuZXhlY3V0aW9uQ2FsbGJhY2tzW3JlcXVlc3RJZF0gPSBvblJlc3VsdHM7XG4gICAgdGhpcy5zaGVsbFNvY2tldC5zZW5kKG5ldyBNZXNzYWdlKG1lc3NhZ2UpKTtcbiAgfVxuXG4gIGluc3BlY3QoY29kZTogc3RyaW5nLCBjdXJzb3JQb3M6IG51bWJlciwgb25SZXN1bHRzOiBSZXN1bHRzQ2FsbGJhY2spIHtcbiAgICBsb2coXCJaTVFLZXJuZWwuaW5zcGVjdDpcIiwgY29kZSwgY3Vyc29yUG9zKTtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBgaW5zcGVjdF8ke3Y0KCl9YDtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBfY3JlYXRlTWVzc2FnZShcImluc3BlY3RfcmVxdWVzdFwiLCByZXF1ZXN0SWQpO1xuXG4gICAgbWVzc2FnZS5jb250ZW50ID0ge1xuICAgICAgY29kZSxcbiAgICAgIGN1cnNvcl9wb3M6IGN1cnNvclBvcyxcbiAgICAgIGRldGFpbF9sZXZlbDogMCxcbiAgICB9O1xuICAgIHRoaXMuZXhlY3V0aW9uQ2FsbGJhY2tzW3JlcXVlc3RJZF0gPSBvblJlc3VsdHM7XG4gICAgdGhpcy5zaGVsbFNvY2tldC5zZW5kKG5ldyBNZXNzYWdlKG1lc3NhZ2UpKTtcbiAgfVxuXG4gIGlucHV0UmVwbHkoaW5wdXQ6IHN0cmluZykge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGBpbnB1dF9yZXBseV8ke3Y0KCl9YDtcblxuICAgIGNvbnN0IG1lc3NhZ2UgPSBfY3JlYXRlTWVzc2FnZShcImlucHV0X3JlcGx5XCIsIHJlcXVlc3RJZCk7XG5cbiAgICBtZXNzYWdlLmNvbnRlbnQgPSB7XG4gICAgICB2YWx1ZTogaW5wdXQsXG4gICAgfTtcbiAgICB0aGlzLnN0ZGluU29ja2V0LnNlbmQobmV3IE1lc3NhZ2UobWVzc2FnZSkpO1xuICB9XG5cbiAgb25TaGVsbE1lc3NhZ2UobWVzc2FnZTogTWVzc2FnZSkge1xuICAgIGxvZyhcInNoZWxsIG1lc3NhZ2U6XCIsIG1lc3NhZ2UpO1xuXG4gICAgaWYgKCFfaXNWYWxpZE1lc3NhZ2UobWVzc2FnZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IG1zZ19pZCB9ID0gbWVzc2FnZS5wYXJlbnRfaGVhZGVyO1xuICAgIGxldCBjYWxsYmFjaztcblxuICAgIGlmIChtc2dfaWQpIHtcbiAgICAgIGNhbGxiYWNrID0gdGhpcy5leGVjdXRpb25DYWxsYmFja3NbbXNnX2lkXTtcbiAgICB9XG5cbiAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgIGNhbGxiYWNrKG1lc3NhZ2UsIFwic2hlbGxcIik7XG4gICAgfVxuICB9XG5cbiAgb25TdGRpbk1lc3NhZ2UobWVzc2FnZTogTWVzc2FnZSkge1xuICAgIGxvZyhcInN0ZGluIG1lc3NhZ2U6XCIsIG1lc3NhZ2UpO1xuXG4gICAgaWYgKCFfaXNWYWxpZE1lc3NhZ2UobWVzc2FnZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBpbnB1dF9yZXF1ZXN0IG1lc3NhZ2VzIGFyZSBhdHRyaWJ1dGFibGUgdG8gcGFydGljdWxhciBleGVjdXRpb24gcmVxdWVzdHMsXG4gICAgLy8gYW5kIHNob3VsZCBwYXNzIHRocm91Z2ggdGhlIG1pZGRsZXdhcmUgc3RhY2sgdG8gYWxsb3cgcGx1Z2lucyB0byBzZWUgdGhlbVxuICAgIGNvbnN0IHsgbXNnX2lkIH0gPSBtZXNzYWdlLnBhcmVudF9oZWFkZXI7XG4gICAgbGV0IGNhbGxiYWNrO1xuXG4gICAgaWYgKG1zZ19pZCkge1xuICAgICAgY2FsbGJhY2sgPSB0aGlzLmV4ZWN1dGlvbkNhbGxiYWNrc1ttc2dfaWRdO1xuICAgIH1cblxuICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgY2FsbGJhY2sobWVzc2FnZSwgXCJzdGRpblwiKTtcbiAgICB9XG4gIH1cblxuICBvbklPTWVzc2FnZShtZXNzYWdlOiBNZXNzYWdlKSB7XG4gICAgbG9nKFwiSU8gbWVzc2FnZTpcIiwgbWVzc2FnZSk7XG5cbiAgICBpZiAoIV9pc1ZhbGlkTWVzc2FnZShtZXNzYWdlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgbXNnX3R5cGUgfSA9IG1lc3NhZ2UuaGVhZGVyO1xuXG4gICAgaWYgKG1zZ190eXBlID09PSBcInN0YXR1c1wiKSB7XG4gICAgICBjb25zdCBzdGF0dXMgPSBtZXNzYWdlLmNvbnRlbnQuZXhlY3V0aW9uX3N0YXRlO1xuICAgICAgdGhpcy5zZXRFeGVjdXRpb25TdGF0ZShzdGF0dXMpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgbXNnX2lkIH0gPSBtZXNzYWdlLnBhcmVudF9oZWFkZXI7XG4gICAgbGV0IGNhbGxiYWNrO1xuXG4gICAgaWYgKG1zZ19pZCkge1xuICAgICAgY2FsbGJhY2sgPSB0aGlzLmV4ZWN1dGlvbkNhbGxiYWNrc1ttc2dfaWRdO1xuICAgIH1cblxuICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgY2FsbGJhY2sobWVzc2FnZSwgXCJpb3B1YlwiKTtcbiAgICB9XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIGxvZyhcIlpNUUtlcm5lbDogZGVzdHJveTpcIiwgdGhpcyk7XG4gICAgdGhpcy5zaHV0ZG93bigpO1xuXG4gICAgdGhpcy5fa2lsbCgpO1xuXG4gICAgZnMudW5saW5rU3luYyh0aGlzLmNvbm5lY3Rpb25GaWxlKTtcbiAgICB0aGlzLnNoZWxsU29ja2V0LmNsb3NlKCk7XG4gICAgdGhpcy5pb1NvY2tldC5jbG9zZSgpO1xuICAgIHRoaXMuc3RkaW5Tb2NrZXQuY2xvc2UoKTtcbiAgICBzdXBlci5kZXN0cm95KCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gX2lzVmFsaWRNZXNzYWdlKG1lc3NhZ2U6IE1lc3NhZ2UpIHtcbiAgaWYgKCFtZXNzYWdlKSB7XG4gICAgbG9nKFwiSW52YWxpZCBtZXNzYWdlOiBudWxsXCIpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlmICghbWVzc2FnZS5jb250ZW50KSB7XG4gICAgbG9nKFwiSW52YWxpZCBtZXNzYWdlOiBNaXNzaW5nIGNvbnRlbnRcIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKG1lc3NhZ2UuY29udGVudC5leGVjdXRpb25fc3RhdGUgPT09IFwic3RhcnRpbmdcIikge1xuICAgIC8vIEtlcm5lbHMgc2VuZCBhIHN0YXJ0aW5nIHN0YXR1cyBtZXNzYWdlIHdpdGggYW4gZW1wdHkgcGFyZW50X2hlYWRlclxuICAgIGxvZyhcIkRyb3BwZWQgc3RhcnRpbmcgc3RhdHVzIElPIG1lc3NhZ2VcIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKCFtZXNzYWdlLnBhcmVudF9oZWFkZXIpIHtcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgcGFyZW50X2hlYWRlclwiKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpZiAoIW1lc3NhZ2UucGFyZW50X2hlYWRlci5tc2dfaWQpIHtcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgcGFyZW50X2hlYWRlci5tc2dfaWRcIik7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgaWYgKCFtZXNzYWdlLnBhcmVudF9oZWFkZXIubXNnX3R5cGUpIHtcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgcGFyZW50X2hlYWRlci5tc2dfdHlwZVwiKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpZiAoIW1lc3NhZ2UuaGVhZGVyKSB7XG4gICAgbG9nKFwiSW52YWxpZCBtZXNzYWdlOiBNaXNzaW5nIGhlYWRlclwiKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBpZiAoIW1lc3NhZ2UuaGVhZGVyLm1zZ19pZCkge1xuICAgIGxvZyhcIkludmFsaWQgbWVzc2FnZTogTWlzc2luZyBoZWFkZXIubXNnX2lkXCIpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGlmICghbWVzc2FnZS5oZWFkZXIubXNnX3R5cGUpIHtcbiAgICBsb2coXCJJbnZhbGlkIG1lc3NhZ2U6IE1pc3NpbmcgaGVhZGVyLm1zZ190eXBlXCIpO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBfZ2V0VXNlcm5hbWUoKSB7XG4gIHJldHVybiAoXG4gICAgcHJvY2Vzcy5lbnYuTE9HTkFNRSB8fFxuICAgIHByb2Nlc3MuZW52LlVTRVIgfHxcbiAgICBwcm9jZXNzLmVudi5MTkFNRSB8fFxuICAgIHByb2Nlc3MuZW52LlVTRVJOQU1FXG4gICk7XG59XG5cbmZ1bmN0aW9uIF9jcmVhdGVNZXNzYWdlKG1zZ1R5cGU6IHN0cmluZywgbXNnSWQ6IHN0cmluZyA9IHY0KCkpIHtcbiAgY29uc3QgbWVzc2FnZSA9IHtcbiAgICBoZWFkZXI6IHtcbiAgICAgIHVzZXJuYW1lOiBfZ2V0VXNlcm5hbWUoKSxcbiAgICAgIHNlc3Npb246IFwiMDAwMDAwMDAtMDAwMC0wMDAwLTAwMDAtMDAwMDAwMDAwMDAwXCIsXG4gICAgICBtc2dfdHlwZTogbXNnVHlwZSxcbiAgICAgIG1zZ19pZDogbXNnSWQsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgdmVyc2lvbjogXCI1LjBcIixcbiAgICB9LFxuICAgIG1ldGFkYXRhOiB7fSxcbiAgICBwYXJlbnRfaGVhZGVyOiB7fSxcbiAgICBjb250ZW50OiB7fSxcbiAgfTtcbiAgcmV0dXJuIG1lc3NhZ2U7XG59XG4iXX0=