"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var vega_util_1 = require("vega-util");
var selection_1 = require("./compile/selection/selection");
var datetime_1 = require("./datetime");
var fielddef_1 = require("./fielddef");
var timeunit_1 = require("./timeunit");
var util_1 = require("./util");
function isSelectionPredicate(predicate) {
    return predicate && predicate['selection'];
}
exports.isSelectionPredicate = isSelectionPredicate;
function isFieldEqualPredicate(predicate) {
    return predicate && !!predicate.field && predicate.equal !== undefined;
}
exports.isFieldEqualPredicate = isFieldEqualPredicate;
function isFieldLTPredicate(predicate) {
    return predicate && !!predicate.field && predicate.lt !== undefined;
}
exports.isFieldLTPredicate = isFieldLTPredicate;
function isFieldLTEPredicate(predicate) {
    return predicate && !!predicate.field && predicate.lte !== undefined;
}
exports.isFieldLTEPredicate = isFieldLTEPredicate;
function isFieldGTPredicate(predicate) {
    return predicate && !!predicate.field && predicate.gt !== undefined;
}
exports.isFieldGTPredicate = isFieldGTPredicate;
function isFieldGTEPredicate(predicate) {
    return predicate && !!predicate.field && predicate.gte !== undefined;
}
exports.isFieldGTEPredicate = isFieldGTEPredicate;
function isFieldRangePredicate(predicate) {
    if (predicate && predicate.field) {
        if (vega_util_1.isArray(predicate.range) && predicate.range.length === 2) {
            return true;
        }
    }
    return false;
}
exports.isFieldRangePredicate = isFieldRangePredicate;
function isFieldOneOfPredicate(predicate) {
    return predicate && !!predicate.field && (vega_util_1.isArray(predicate.oneOf) ||
        vega_util_1.isArray(predicate.in) // backward compatibility
    );
}
exports.isFieldOneOfPredicate = isFieldOneOfPredicate;
function isFieldPredicate(predicate) {
    return isFieldOneOfPredicate(predicate) || isFieldEqualPredicate(predicate) || isFieldRangePredicate(predicate) || isFieldLTPredicate(predicate) || isFieldGTPredicate(predicate) || isFieldLTEPredicate(predicate) || isFieldGTEPredicate(predicate);
}
exports.isFieldPredicate = isFieldPredicate;
/**
 * Converts a predicate into an expression.
 */
// model is only used for selection filters.
function expression(model, filterOp, node) {
    return util_1.logicalExpr(filterOp, function (predicate) {
        if (vega_util_1.isString(predicate)) {
            return predicate;
        }
        else if (isSelectionPredicate(predicate)) {
            return selection_1.selectionPredicate(model, predicate.selection, node);
        }
        else { // Filter Object
            return fieldFilterExpression(predicate);
        }
    });
}
exports.expression = expression;
// This method is used by Voyager.  Do not change its behavior without changing Voyager.
function fieldFilterExpression(predicate, useInRange) {
    if (useInRange === void 0) { useInRange = true; }
    var fieldExpr = predicate.timeUnit ?
        // For timeUnit, cast into integer with time() so we can use ===, inrange, indexOf to compare values directly.
        // TODO: We calculate timeUnit on the fly here. Consider if we would like to consolidate this with timeUnit pipeline
        // TODO: support utc
        ('time(' + timeunit_1.fieldExpr(predicate.timeUnit, predicate.field) + ')') :
        fielddef_1.vgField(predicate, { expr: 'datum' });
    if (isFieldEqualPredicate(predicate)) {
        return fieldExpr + '===' + valueExpr(predicate.equal, predicate.timeUnit);
    }
    else if (isFieldLTPredicate(predicate)) {
        var upper = predicate.lt;
        return fieldExpr + "<" + valueExpr(upper, predicate.timeUnit);
    }
    else if (isFieldGTPredicate(predicate)) {
        var lower = predicate.gt;
        return fieldExpr + ">" + valueExpr(lower, predicate.timeUnit);
    }
    else if (isFieldLTEPredicate(predicate)) {
        var upper = predicate.lte;
        return fieldExpr + "<=" + valueExpr(upper, predicate.timeUnit);
    }
    else if (isFieldGTEPredicate(predicate)) {
        var lower = predicate.gte;
        return fieldExpr + ">=" + valueExpr(lower, predicate.timeUnit);
    }
    else if (isFieldOneOfPredicate(predicate)) {
        // "oneOf" was formerly "in" -- so we need to add backward compatibility
        var oneOf = predicate.oneOf || predicate['in'];
        return 'indexof([' +
            oneOf.map(function (v) { return valueExpr(v, predicate.timeUnit); }).join(',') +
            '], ' + fieldExpr + ') !== -1';
    }
    else if (isFieldRangePredicate(predicate)) {
        var lower = predicate.range[0];
        var upper = predicate.range[1];
        if (lower !== null && upper !== null && useInRange) {
            return 'inrange(' + fieldExpr + ', [' +
                valueExpr(lower, predicate.timeUnit) + ', ' +
                valueExpr(upper, predicate.timeUnit) + '])';
        }
        var exprs = [];
        if (lower !== null) {
            exprs.push(fieldExpr + " >= " + valueExpr(lower, predicate.timeUnit));
        }
        if (upper !== null) {
            exprs.push(fieldExpr + " <= " + valueExpr(upper, predicate.timeUnit));
        }
        return exprs.length > 0 ? exprs.join(' && ') : 'true';
    }
    /* istanbul ignore next: it should never reach here */
    throw new Error("Invalid field predicate: " + JSON.stringify(predicate));
}
exports.fieldFilterExpression = fieldFilterExpression;
function valueExpr(v, timeUnit) {
    if (datetime_1.isDateTime(v)) {
        var expr = datetime_1.dateTimeExpr(v, true);
        return 'time(' + expr + ')';
    }
    if (timeunit_1.isLocalSingleTimeUnit(timeUnit)) {
        var datetime = {};
        datetime[timeUnit] = v;
        var expr = datetime_1.dateTimeExpr(datetime, true);
        return 'time(' + expr + ')';
    }
    else if (timeunit_1.isUtcSingleTimeUnit(timeUnit)) {
        return valueExpr(v, timeunit_1.getLocalTimeUnit(timeUnit));
    }
    return JSON.stringify(v);
}
function normalizePredicate(f) {
    if (isFieldPredicate(f) && f.timeUnit) {
        return tslib_1.__assign({}, f, { timeUnit: timeunit_1.normalizeTimeUnit(f.timeUnit) });
    }
    return f;
}
exports.normalizePredicate = normalizePredicate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZGljYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3ByZWRpY2F0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx1Q0FBNEM7QUFHNUMsMkRBQWlFO0FBQ2pFLHVDQUE4RDtBQUM5RCx1Q0FBbUM7QUFFbkMsdUNBQXFKO0FBQ3JKLCtCQUFtQztBQXNCbkMsOEJBQXFDLFNBQW9DO0lBQ3ZFLE9BQU8sU0FBUyxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM3QyxDQUFDO0FBRkQsb0RBRUM7QUF3QkQsK0JBQXNDLFNBQWM7SUFDbEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUM7QUFDekUsQ0FBQztBQUZELHNEQUVDO0FBVUQsNEJBQW1DLFNBQWM7SUFDL0MsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEVBQUUsS0FBSyxTQUFTLENBQUM7QUFDdEUsQ0FBQztBQUZELGdEQUVDO0FBV0QsNkJBQW9DLFNBQWM7SUFDaEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUM7QUFDdkUsQ0FBQztBQUZELGtEQUVDO0FBV0QsNEJBQW1DLFNBQWM7SUFDL0MsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEVBQUUsS0FBSyxTQUFTLENBQUM7QUFDdEUsQ0FBQztBQUZELGdEQUVDO0FBVUQsNkJBQW9DLFNBQWM7SUFDaEQsT0FBTyxTQUFTLElBQUksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLEdBQUcsS0FBSyxTQUFTLENBQUM7QUFDdkUsQ0FBQztBQUZELGtEQUVDO0FBWUQsK0JBQXNDLFNBQWM7SUFD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SUFBSSw4QkFBbUIsQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUN4QyxPQUFPLFNBQVMsQ0FBQyxDQUFDLEVBQUUsMkJBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztLQUNqRDtJQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixDQUFDO0FBRUQsNEJBQW1DLENBQVk7SUFDN0MsSUFBSSxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO1FBQ3JDLDRCQUNLLENBQUMsSUFDSixRQUFRLEVBQUUsNEJBQWlCLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUN2QztLQUNIO0lBQ0QsT0FBTyxDQUFDLENBQUM7QUFDWCxDQUFDO0FBUkQsZ0RBUUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lzQXJyYXksIGlzU3RyaW5nfSBmcm9tICd2ZWdhLXV0aWwnO1xuaW1wb3J0IHtEYXRhRmxvd05vZGV9IGZyb20gJy4vY29tcGlsZS9kYXRhL2RhdGFmbG93JztcbmltcG9ydCB7TW9kZWx9IGZyb20gJy4vY29tcGlsZS9tb2RlbCc7XG5pbXBvcnQge3NlbGVjdGlvblByZWRpY2F0ZX0gZnJvbSAnLi9jb21waWxlL3NlbGVjdGlvbi9zZWxlY3Rpb24nO1xuaW1wb3J0IHtEYXRlVGltZSwgZGF0ZVRpbWVFeHByLCBpc0RhdGVUaW1lfSBmcm9tICcuL2RhdGV0aW1lJztcbmltcG9ydCB7dmdGaWVsZH0gZnJvbSAnLi9maWVsZGRlZic7XG5pbXBvcnQge0xvZ2ljYWxPcGVyYW5kfSBmcm9tICcuL2xvZ2ljYWwnO1xuaW1wb3J0IHtmaWVsZEV4cHIgYXMgdGltZVVuaXRGaWVsZEV4cHIsIGdldExvY2FsVGltZVVuaXQsIGlzTG9jYWxTaW5nbGVUaW1lVW5pdCwgaXNVdGNTaW5nbGVUaW1lVW5pdCwgbm9ybWFsaXplVGltZVVuaXQsIFRpbWVVbml0fSBmcm9tICcuL3RpbWV1bml0JztcbmltcG9ydCB7bG9naWNhbEV4cHJ9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCB0eXBlIFByZWRpY2F0ZSA9XG4gIC8vIGEpIEZpZWxkUHJlZGljYXRlIChidXQgd2UgZG9uJ3QgdHlwZSBGaWVsZEZpbHRlciBoZXJlIHNvIHRoZSBzY2hlbWEgaGFzIG5vIG5lc3RpbmdcbiAgLy8gYW5kIHRodXMgdGhlIGRvY3VtZW50YXRpb24gc2hvd3MgYWxsIG9mIHRoZSB0eXBlcyBjbGVhcmx5KVxuICBGaWVsZEVxdWFsUHJlZGljYXRlIHwgRmllbGRSYW5nZVByZWRpY2F0ZSB8IEZpZWxkT25lT2ZQcmVkaWNhdGUgfCBGaWVsZExUUHJlZGljYXRlIHwgRmllbGRHVFByZWRpY2F0ZSB8IEZpZWxkTFRFUHJlZGljYXRlIHwgRmllbGRHVEVQcmVkaWNhdGUgfFxuICAvLyBiKSBTZWxlY3Rpb24gUHJlZGljYXRlXG4gIFNlbGVjdGlvblByZWRpY2F0ZSB8XG4gIC8vIGMpIFZlZ2EgRXhwcmVzc2lvbiBzdHJpbmdcbiAgc3RyaW5nO1xuXG5cblxuZXhwb3J0IHR5cGUgRmllbGRQcmVkaWNhdGUgPSBGaWVsZEVxdWFsUHJlZGljYXRlIHwgRmllbGRMVFByZWRpY2F0ZSB8IEZpZWxkR1RQcmVkaWNhdGUgfCBGaWVsZExURVByZWRpY2F0ZSB8IEZpZWxkR1RFUHJlZGljYXRlIHxGaWVsZFJhbmdlUHJlZGljYXRlIHwgRmllbGRPbmVPZlByZWRpY2F0ZTtcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3Rpb25QcmVkaWNhdGUge1xuICAvKipcbiAgICogRmlsdGVyIHVzaW5nIGEgc2VsZWN0aW9uIG5hbWUuXG4gICAqL1xuICBzZWxlY3Rpb246IExvZ2ljYWxPcGVyYW5kPHN0cmluZz47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NlbGVjdGlvblByZWRpY2F0ZShwcmVkaWNhdGU6IExvZ2ljYWxPcGVyYW5kPFByZWRpY2F0ZT4pOiBwcmVkaWNhdGUgaXMgU2VsZWN0aW9uUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiBwcmVkaWNhdGVbJ3NlbGVjdGlvbiddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8vIFRPRE86IHN1cHBvcnQgYWdncmVnYXRlXG5cbiAgLyoqXG4gICAqIFRpbWUgdW5pdCBmb3IgdGhlIGZpZWxkIHRvIGJlIGZpbHRlcmVkLlxuICAgKi9cbiAgdGltZVVuaXQ/OiBUaW1lVW5pdDtcblxuICAvKipcbiAgICogRmllbGQgdG8gYmUgZmlsdGVyZWQuXG4gICAqL1xuICBmaWVsZDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkRXF1YWxQcmVkaWNhdGUgZXh0ZW5kcyBGaWVsZFByZWRpY2F0ZUJhc2Uge1xuICAvKipcbiAgICogVGhlIHZhbHVlIHRoYXQgdGhlIGZpZWxkIHNob3VsZCBiZSBlcXVhbCB0by5cbiAgICovXG4gIGVxdWFsOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgRGF0ZVRpbWU7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZEVxdWFsUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUuZXF1YWwgIT09IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZExUUHJlZGljYXRlIGV4dGVuZHMgRmllbGRQcmVkaWNhdGVCYXNlIHtcbiAgLyoqXG4gICAqIFRoZSB2YWx1ZSB0aGF0IHRoZSBmaWVsZCBzaG91bGQgYmUgbGVzcyB0aGFuLlxuICAgKi9cbiAgbHQ6IHN0cmluZyB8IG51bWJlciB8IERhdGVUaW1lO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkTFRQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRMVFByZWRpY2F0ZSB7XG4gIHJldHVybiBwcmVkaWNhdGUgJiYgISFwcmVkaWNhdGUuZmllbGQgJiYgcHJlZGljYXRlLmx0ICE9PSB1bmRlZmluZWQ7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZExURVByZWRpY2F0ZSBleHRlbmRzIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8qKlxuICAgKiBUaGUgdmFsdWUgdGhhdCB0aGUgZmllbGQgc2hvdWxkIGJlIGxlc3MgdGhhbiBvciBlcXVhbHMgdG8uXG4gICAqL1xuICBsdGU6IHN0cmluZyB8IG51bWJlciB8IERhdGVUaW1lO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkTFRFUHJlZGljYXRlKHByZWRpY2F0ZTogYW55KTogcHJlZGljYXRlIGlzIEZpZWxkTFRFUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUubHRlICE9PSB1bmRlZmluZWQ7XG59XG5cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZEdUUHJlZGljYXRlIGV4dGVuZHMgRmllbGRQcmVkaWNhdGVCYXNlIHtcbiAgLyoqXG4gICAqIFRoZSB2YWx1ZSB0aGF0IHRoZSBmaWVsZCBzaG91bGQgYmUgZ3JlYXRlciB0aGFuLlxuICAgKi9cbiAgZ3Q6IHN0cmluZyB8IG51bWJlciB8IERhdGVUaW1lO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkR1RQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRHVFByZWRpY2F0ZSB7XG4gIHJldHVybiBwcmVkaWNhdGUgJiYgISFwcmVkaWNhdGUuZmllbGQgJiYgcHJlZGljYXRlLmd0ICE9PSB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRHVEVQcmVkaWNhdGUgZXh0ZW5kcyBGaWVsZFByZWRpY2F0ZUJhc2Uge1xuICAvKipcbiAgICogVGhlIHZhbHVlIHRoYXQgdGhlIGZpZWxkIHNob3VsZCBiZSBncmVhdGVyIHRoYW4gb3IgZXF1YWxzIHRvLlxuICAgKi9cbiAgZ3RlOiBzdHJpbmcgfCBudW1iZXIgfCBEYXRlVGltZTtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNGaWVsZEdURVByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZEdURVByZWRpY2F0ZSB7XG4gIHJldHVybiBwcmVkaWNhdGUgJiYgISFwcmVkaWNhdGUuZmllbGQgJiYgcHJlZGljYXRlLmd0ZSAhPT0gdW5kZWZpbmVkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkUmFuZ2VQcmVkaWNhdGUgZXh0ZW5kcyBGaWVsZFByZWRpY2F0ZUJhc2Uge1xuICAvKipcbiAgICogQW4gYXJyYXkgb2YgaW5jbHVzaXZlIG1pbmltdW0gYW5kIG1heGltdW0gdmFsdWVzXG4gICAqIGZvciBhIGZpZWxkIHZhbHVlIG9mIGEgZGF0YSBpdGVtIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBmaWx0ZXJlZCBkYXRhLlxuICAgKiBAbWF4SXRlbXMgMlxuICAgKiBAbWluSXRlbXMgMlxuICAgKi9cbiAgcmFuZ2U6IChudW1iZXJ8RGF0ZVRpbWV8bnVsbClbXTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRSYW5nZVByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZFJhbmdlUHJlZGljYXRlIHtcbiAgaWYgKHByZWRpY2F0ZSAmJiBwcmVkaWNhdGUuZmllbGQpIHtcbiAgICBpZiAoaXNBcnJheShwcmVkaWNhdGUucmFuZ2UpICYmIHByZWRpY2F0ZS5yYW5nZS5sZW5ndGggPT09IDIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRPbmVPZlByZWRpY2F0ZSBleHRlbmRzIEZpZWxkUHJlZGljYXRlQmFzZSB7XG4gIC8qKlxuICAgKiBBIHNldCBvZiB2YWx1ZXMgdGhhdCB0aGUgYGZpZWxkYCdzIHZhbHVlIHNob3VsZCBiZSBhIG1lbWJlciBvZixcbiAgICogZm9yIGEgZGF0YSBpdGVtIGluY2x1ZGVkIGluIHRoZSBmaWx0ZXJlZCBkYXRhLlxuICAgKi9cbiAgb25lT2Y6IHN0cmluZ1tdIHwgbnVtYmVyW10gfCBib29sZWFuW10gfCBEYXRlVGltZVtdO1xuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlOiBhbnkpOiBwcmVkaWNhdGUgaXMgRmllbGRPbmVPZlByZWRpY2F0ZSB7XG4gIHJldHVybiBwcmVkaWNhdGUgJiYgISFwcmVkaWNhdGUuZmllbGQgJiYgKFxuICAgIGlzQXJyYXkocHJlZGljYXRlLm9uZU9mKSB8fFxuICAgIGlzQXJyYXkocHJlZGljYXRlLmluKSAvLyBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0ZpZWxkUHJlZGljYXRlKHByZWRpY2F0ZTogUHJlZGljYXRlKTogcHJlZGljYXRlIGlzIEZpZWxkT25lT2ZQcmVkaWNhdGUgfCBGaWVsZEVxdWFsUHJlZGljYXRlIHwgRmllbGRSYW5nZVByZWRpY2F0ZSB8IEZpZWxkTFRQcmVkaWNhdGUgfCBGaWVsZEdUUHJlZGljYXRlIHwgRmllbGRMVEVQcmVkaWNhdGUgfCBGaWVsZEdURVByZWRpY2F0ZSB7XG4gIHJldHVybiBpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkRXF1YWxQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkUmFuZ2VQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkTFRQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkR1RQcmVkaWNhdGUocHJlZGljYXRlKSB8fCBpc0ZpZWxkTFRFUHJlZGljYXRlKHByZWRpY2F0ZSkgfHwgaXNGaWVsZEdURVByZWRpY2F0ZShwcmVkaWNhdGUpO1xufVxuXG4vKipcbiAqIENvbnZlcnRzIGEgcHJlZGljYXRlIGludG8gYW4gZXhwcmVzc2lvbi5cbiAqL1xuLy8gbW9kZWwgaXMgb25seSB1c2VkIGZvciBzZWxlY3Rpb24gZmlsdGVycy5cbmV4cG9ydCBmdW5jdGlvbiBleHByZXNzaW9uKG1vZGVsOiBNb2RlbCwgZmlsdGVyT3A6IExvZ2ljYWxPcGVyYW5kPFByZWRpY2F0ZT4sIG5vZGU/OiBEYXRhRmxvd05vZGUpOiBzdHJpbmcge1xuICByZXR1cm4gbG9naWNhbEV4cHIoZmlsdGVyT3AsIChwcmVkaWNhdGU6IFByZWRpY2F0ZSkgPT4ge1xuICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gcHJlZGljYXRlO1xuICAgIH0gZWxzZSBpZiAoaXNTZWxlY3Rpb25QcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgICAgcmV0dXJuIHNlbGVjdGlvblByZWRpY2F0ZShtb2RlbCwgcHJlZGljYXRlLnNlbGVjdGlvbiwgbm9kZSk7XG4gICAgfSBlbHNlIHsgLy8gRmlsdGVyIE9iamVjdFxuICAgICAgcmV0dXJuIGZpZWxkRmlsdGVyRXhwcmVzc2lvbihwcmVkaWNhdGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vIFRoaXMgbWV0aG9kIGlzIHVzZWQgYnkgVm95YWdlci4gIERvIG5vdCBjaGFuZ2UgaXRzIGJlaGF2aW9yIHdpdGhvdXQgY2hhbmdpbmcgVm95YWdlci5cbmV4cG9ydCBmdW5jdGlvbiBmaWVsZEZpbHRlckV4cHJlc3Npb24ocHJlZGljYXRlOiBGaWVsZFByZWRpY2F0ZSwgdXNlSW5SYW5nZT10cnVlKSB7XG4gIGNvbnN0IGZpZWxkRXhwciA9IHByZWRpY2F0ZS50aW1lVW5pdCA/XG4gICAgLy8gRm9yIHRpbWVVbml0LCBjYXN0IGludG8gaW50ZWdlciB3aXRoIHRpbWUoKSBzbyB3ZSBjYW4gdXNlID09PSwgaW5yYW5nZSwgaW5kZXhPZiB0byBjb21wYXJlIHZhbHVlcyBkaXJlY3RseS5cbiAgICAgIC8vIFRPRE86IFdlIGNhbGN1bGF0ZSB0aW1lVW5pdCBvbiB0aGUgZmx5IGhlcmUuIENvbnNpZGVyIGlmIHdlIHdvdWxkIGxpa2UgdG8gY29uc29saWRhdGUgdGhpcyB3aXRoIHRpbWVVbml0IHBpcGVsaW5lXG4gICAgICAvLyBUT0RPOiBzdXBwb3J0IHV0Y1xuICAgICgndGltZSgnICsgdGltZVVuaXRGaWVsZEV4cHIocHJlZGljYXRlLnRpbWVVbml0LCBwcmVkaWNhdGUuZmllbGQpICsgJyknKSA6XG4gICAgdmdGaWVsZChwcmVkaWNhdGUsIHtleHByOiAnZGF0dW0nfSk7XG5cbiAgaWYgKGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGUpKSB7XG4gICAgcmV0dXJuIGZpZWxkRXhwciArICc9PT0nICsgdmFsdWVFeHByKHByZWRpY2F0ZS5lcXVhbCwgcHJlZGljYXRlLnRpbWVVbml0KTtcbiAgfSBlbHNlIGlmIChpc0ZpZWxkTFRQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IHVwcGVyID0gcHJlZGljYXRlLmx0O1xuICAgIHJldHVybiBgJHtmaWVsZEV4cHJ9PCR7dmFsdWVFeHByKHVwcGVyLCBwcmVkaWNhdGUudGltZVVuaXQpfWA7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZEdUUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICBjb25zdCBsb3dlciA9IHByZWRpY2F0ZS5ndDtcbiAgICByZXR1cm4gYCR7ZmllbGRFeHByfT4ke3ZhbHVlRXhwcihsb3dlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gO1xuICB9IGVsc2UgaWYgKGlzRmllbGRMVEVQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IHVwcGVyID0gcHJlZGljYXRlLmx0ZTtcbiAgICByZXR1cm4gYCR7ZmllbGRFeHByfTw9JHt2YWx1ZUV4cHIodXBwZXIsIHByZWRpY2F0ZS50aW1lVW5pdCl9YDtcbiAgfSBlbHNlIGlmIChpc0ZpZWxkR1RFUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICBjb25zdCBsb3dlciA9IHByZWRpY2F0ZS5ndGU7XG4gICAgcmV0dXJuIGAke2ZpZWxkRXhwcn0+PSR7dmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpfWA7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZE9uZU9mUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICAvLyBcIm9uZU9mXCIgd2FzIGZvcm1lcmx5IFwiaW5cIiAtLSBzbyB3ZSBuZWVkIHRvIGFkZCBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICAgY29uc3Qgb25lT2Y6IEZpZWxkT25lT2ZQcmVkaWNhdGVbXSA9IHByZWRpY2F0ZS5vbmVPZiB8fCBwcmVkaWNhdGVbJ2luJ107XG4gICAgcmV0dXJuICdpbmRleG9mKFsnICtcbiAgICAgIG9uZU9mLm1hcCgodikgPT4gdmFsdWVFeHByKHYsIHByZWRpY2F0ZS50aW1lVW5pdCkpLmpvaW4oJywnKSArXG4gICAgICAnXSwgJyArIGZpZWxkRXhwciArICcpICE9PSAtMSc7XG4gIH0gZWxzZSBpZiAoaXNGaWVsZFJhbmdlUHJlZGljYXRlKHByZWRpY2F0ZSkpIHtcbiAgICBjb25zdCBsb3dlciA9IHByZWRpY2F0ZS5yYW5nZVswXTtcbiAgICBjb25zdCB1cHBlciA9IHByZWRpY2F0ZS5yYW5nZVsxXTtcblxuICAgIGlmIChsb3dlciAhPT0gbnVsbCAmJiB1cHBlciAhPT0gbnVsbCAmJiB1c2VJblJhbmdlKSB7XG4gICAgICByZXR1cm4gJ2lucmFuZ2UoJyArIGZpZWxkRXhwciArICcsIFsnICtcbiAgICAgICAgdmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpICsgJywgJyArXG4gICAgICAgIHZhbHVlRXhwcih1cHBlciwgcHJlZGljYXRlLnRpbWVVbml0KSArICddKSc7XG4gICAgfVxuXG4gICAgY29uc3QgZXhwcnMgPSBbXTtcbiAgICBpZiAobG93ZXIgIT09IG51bGwpIHtcbiAgICAgIGV4cHJzLnB1c2goYCR7ZmllbGRFeHByfSA+PSAke3ZhbHVlRXhwcihsb3dlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gKTtcbiAgICB9XG4gICAgaWYgKHVwcGVyICE9PSBudWxsKSB7XG4gICAgICBleHBycy5wdXNoKGAke2ZpZWxkRXhwcn0gPD0gJHt2YWx1ZUV4cHIodXBwZXIsIHByZWRpY2F0ZS50aW1lVW5pdCl9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cHJzLmxlbmd0aCA+IDAgPyBleHBycy5qb2luKCcgJiYgJykgOiAndHJ1ZSc7XG4gIH1cblxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dDogaXQgc2hvdWxkIG5ldmVyIHJlYWNoIGhlcmUgKi9cbiAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGZpZWxkIHByZWRpY2F0ZTogJHtKU09OLnN0cmluZ2lmeShwcmVkaWNhdGUpfWApO1xufVxuXG5mdW5jdGlvbiB2YWx1ZUV4cHIodjogYW55LCB0aW1lVW5pdDogVGltZVVuaXQpOiBzdHJpbmcge1xuICBpZiAoaXNEYXRlVGltZSh2KSkge1xuICAgIGNvbnN0IGV4cHIgPSBkYXRlVGltZUV4cHIodiwgdHJ1ZSk7XG4gICAgcmV0dXJuICd0aW1lKCcgKyBleHByICsgJyknO1xuICB9XG4gIGlmIChpc0xvY2FsU2luZ2xlVGltZVVuaXQodGltZVVuaXQpKSB7XG4gICAgY29uc3QgZGF0ZXRpbWU6IERhdGVUaW1lID0ge307XG4gICAgZGF0ZXRpbWVbdGltZVVuaXRdID0gdjtcbiAgICBjb25zdCBleHByID0gZGF0ZVRpbWVFeHByKGRhdGV0aW1lLCB0cnVlKTtcbiAgICByZXR1cm4gJ3RpbWUoJyArIGV4cHIgKyAnKSc7XG4gIH0gZWxzZSBpZiAoaXNVdGNTaW5nbGVUaW1lVW5pdCh0aW1lVW5pdCkpIHtcbiAgICByZXR1cm4gdmFsdWVFeHByKHYsIGdldExvY2FsVGltZVVuaXQodGltZVVuaXQpKTtcbiAgfVxuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodik7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVQcmVkaWNhdGUoZjogUHJlZGljYXRlKTogUHJlZGljYXRlIHtcbiAgaWYgKGlzRmllbGRQcmVkaWNhdGUoZikgJiYgZi50aW1lVW5pdCkge1xuICAgIHJldHVybiB7XG4gICAgICAuLi5mLFxuICAgICAgdGltZVVuaXQ6IG5vcm1hbGl6ZVRpbWVVbml0KGYudGltZVVuaXQpXG4gICAgfTtcbiAgfVxuICByZXR1cm4gZjtcbn1cbiJdfQ==