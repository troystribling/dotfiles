"use strict";
var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var selection_1 = require("./compile/selection/selection");
var datetime_1 = require("./datetime");
var fielddef_1 = require("./fielddef");
var timeunit_1 = require("./timeunit");
var util_1 = require("./util");
function isSelectionPredicate(predicate) {
    return predicate && predicate['selection'];
}
exports.isSelectionPredicate = isSelectionPredicate;
function isFieldEqualPredicate(predicate) {
    return predicate && !!predicate.field && predicate.equal !== undefined;
}
exports.isFieldEqualPredicate = isFieldEqualPredicate;
function isFieldRangePredicate(predicate) {
    if (predicate && predicate.field) {
        if (util_1.isArray(predicate.range) && predicate.range.length === 2) {
            return true;
        }
    }
    return false;
}
exports.isFieldRangePredicate = isFieldRangePredicate;
function isFieldOneOfPredicate(predicate) {
    return predicate && !!predicate.field && (util_1.isArray(predicate.oneOf) ||
        util_1.isArray(predicate.in) // backward compatibility
    );
}
exports.isFieldOneOfPredicate = isFieldOneOfPredicate;
function isFieldPredicate(predicate) {
    return isFieldOneOfPredicate(predicate) || isFieldEqualPredicate(predicate) || isFieldRangePredicate(predicate);
}
exports.isFieldPredicate = isFieldPredicate;
/**
 * Converts a predicate into an expression.
 */
// model is only used for selection filters.
function expression(model, filterOp, node) {
    return util_1.logicalExpr(filterOp, function (predicate) {
        if (util_1.isString(predicate)) {
            return predicate;
        }
        else if (isSelectionPredicate(predicate)) {
            return selection_1.selectionPredicate(model, predicate.selection, node);
        }
        else {
            return fieldFilterExpression(predicate);
        }
    });
}
exports.expression = expression;
// This method is used by Voyager.  Do not change its behavior without changing Voyager.
function fieldFilterExpression(predicate, useInRange) {
    if (useInRange === void 0) { useInRange = true; }
    var fieldExpr = predicate.timeUnit ?
        // For timeUnit, cast into integer with time() so we can use ===, inrange, indexOf to compare values directly.
        // TODO: We calculate timeUnit on the fly here. Consider if we would like to consolidate this with timeUnit pipeline
        // TODO: support utc
        ('time(' + timeunit_1.fieldExpr(predicate.timeUnit, predicate.field) + ')') :
        fielddef_1.vgField(predicate, { expr: 'datum' });
    if (isFieldEqualPredicate(predicate)) {
        return fieldExpr + '===' + valueExpr(predicate.equal, predicate.timeUnit);
    }
    else if (isFieldOneOfPredicate(predicate)) {
        // "oneOf" was formerly "in" -- so we need to add backward compatibility
        var oneOf = predicate.oneOf || predicate['in'];
        return 'indexof([' +
            oneOf.map(function (v) { return valueExpr(v, predicate.timeUnit); }).join(',') +
            '], ' + fieldExpr + ') !== -1';
    }
    else if (isFieldRangePredicate(predicate)) {
        var lower = predicate.range[0];
        var upper = predicate.range[1];
        if (lower !== null && upper !== null && useInRange) {
            return 'inrange(' + fieldExpr + ', [' +
                valueExpr(lower, predicate.timeUnit) + ', ' +
                valueExpr(upper, predicate.timeUnit) + '])';
        }
        var exprs = [];
        if (lower !== null) {
            exprs.push(fieldExpr + " >= " + valueExpr(lower, predicate.timeUnit));
        }
        if (upper !== null) {
            exprs.push(fieldExpr + " <= " + valueExpr(upper, predicate.timeUnit));
        }
        return exprs.length > 0 ? exprs.join(' && ') : 'true';
    }
    /* istanbul ignore next: it should never reach here */
    throw new Error("Invalid field predicate: " + JSON.stringify(predicate));
}
exports.fieldFilterExpression = fieldFilterExpression;
function valueExpr(v, timeUnit) {
    if (datetime_1.isDateTime(v)) {
        var expr = datetime_1.dateTimeExpr(v, true);
        return 'time(' + expr + ')';
    }
    if (timeunit_1.isLocalSingleTimeUnit(timeUnit)) {
        var datetime = {};
        datetime[timeUnit] = v;
        var expr = datetime_1.dateTimeExpr(datetime, true);
        return 'time(' + expr + ')';
    }
    else if (timeunit_1.isUtcSingleTimeUnit(timeUnit)) {
        return valueExpr(v, timeunit_1.getLocalTimeUnit(timeUnit));
    }
    return JSON.stringify(v);
}
function normalizePredicate(f) {
    if (isFieldPredicate(f) && f.timeUnit) {
        return __assign({}, f, { timeUnit: timeunit_1.normalizeTimeUnit(f.timeUnit) });
    }
    return f;
}
exports.normalizePredicate = normalizePredicate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZGljYXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3ByZWRpY2F0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBRUEsMkRBQWlFO0FBQ2pFLHVDQUE4RDtBQUM5RCx1Q0FBbUM7QUFFbkMsdUNBQXFKO0FBQ3JKLCtCQUFzRDtBQXNCdEQsOEJBQXFDLFNBQW9DO0lBQ3ZFLE1BQU0sQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFGRCxvREFFQztBQXNCRCwrQkFBc0MsU0FBYztJQUNsRCxNQUFNLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxJQUFJLFNBQVMsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDO0FBQ3pFLENBQUM7QUFGRCxzREFFQztBQXlCRCwrQkFBc0MsU0FBYztJQUNsRCxFQUFFLENBQUMsQ0FBQyxTQUFTLElBQUksU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDakMsRUFBRSxDQUFDLENBQUMsY0FBTyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdELE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUNELE1BQU0sQ0FBQyxLQUFLLENBQUM7QUFDZixDQUFDO0FBUEQsc0RBT0M7QUF1QkQsK0JBQXNDLFNBQWM7SUFDbEQsTUFBTSxDQUFDLFNBQVMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLEtBQUssSUFBSSxDQUN2QyxjQUFPLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztRQUN4QixjQUFPLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxDQUFDLHlCQUF5QjtLQUNoRCxDQUFDO0FBQ0osQ0FBQztBQUxELHNEQUtDO0FBRUQsMEJBQWlDLFNBQW9CO0lBQ25ELE1BQU0s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QztRQUN2QixJQUFNLElBQUksR0FBRyx1QkFBWSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxQyxNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksR0FBRyxHQUFHLENBQUM7SUFDOUIsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyw4QkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsMkJBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0IsQ0FBQztBQUVELDRCQUFtQyxDQUFZO0lBQzdDLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sY0FDRCxDQUFDLElBQ0osUUFBUSxFQUFFLDRCQUFpQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFDdkM7SUFDSixDQUFDO0lBQ0QsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNYLENBQUM7QUFSRCxnREFRQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RGF0YUZsb3dOb2RlfSBmcm9tICcuL2NvbXBpbGUvZGF0YS9kYXRhZmxvdyc7XG5pbXBvcnQge01vZGVsfSBmcm9tICcuL2NvbXBpbGUvbW9kZWwnO1xuaW1wb3J0IHtzZWxlY3Rpb25QcmVkaWNhdGV9IGZyb20gJy4vY29tcGlsZS9zZWxlY3Rpb24vc2VsZWN0aW9uJztcbmltcG9ydCB7RGF0ZVRpbWUsIGRhdGVUaW1lRXhwciwgaXNEYXRlVGltZX0gZnJvbSAnLi9kYXRldGltZSc7XG5pbXBvcnQge3ZnRmllbGR9IGZyb20gJy4vZmllbGRkZWYnO1xuaW1wb3J0IHtMb2dpY2FsT3BlcmFuZH0gZnJvbSAnLi9sb2dpY2FsJztcbmltcG9ydCB7ZmllbGRFeHByIGFzIHRpbWVVbml0RmllbGRFeHByLCBnZXRMb2NhbFRpbWVVbml0LCBpc0xvY2FsU2luZ2xlVGltZVVuaXQsIGlzVXRjU2luZ2xlVGltZVVuaXQsIG5vcm1hbGl6ZVRpbWVVbml0LCBUaW1lVW5pdH0gZnJvbSAnLi90aW1ldW5pdCc7XG5pbXBvcnQge2lzQXJyYXksIGlzU3RyaW5nLCBsb2dpY2FsRXhwcn0gZnJvbSAnLi91dGlsJztcblxuZXhwb3J0IHR5cGUgUHJlZGljYXRlID1cbiAgLy8gYSkgRmllbGRQcmVjaWRhdGUgKGJ1dCB3ZSBkb24ndCB0eXBlIEZpZWxkRmlsdGVyIGhlcmUgc28gdGhlIHNjaGVtYSBoYXMgbm8gbmVzdGluZ1xuICAvLyBhbmQgdGh1cyB0aGUgZG9jdW1lbnRhdGlvbiBzaG93cyBhbGwgb2YgdGhlIHR5cGVzIGNsZWFybHkpXG4gIEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZFJhbmdlUHJlZGljYXRlIHwgRmllbGRPbmVPZlByZWRpY2F0ZSB8XG4gIC8vIGIpIFNlbGVjdGlvbiBQcmVkaWNhdGVcbiAgU2VsZWN0aW9uUHJlZGljYXRlIHxcbiAgLy8gYykgVmVnYSBFeHByZXNzaW9uIHN0cmluZ1xuICBzdHJpbmc7XG5cblxuXG5leHBvcnQgdHlwZSBGaWVsZFByZWRpY2F0ZSA9IEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZFJhbmdlUHJlZGljYXRlIHwgRmllbGRPbmVPZlByZWRpY2F0ZTtcblxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3Rpb25QcmVkaWNhdGUge1xuICAvKipcbiAgICogRmlsdGVyIHVzaW5nIGEgc2VsZWN0aW9uIG5hbWUuXG4gICAqL1xuICBzZWxlY3Rpb246IExvZ2ljYWxPcGVyYW5kPHN0cmluZz47XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NlbGVjdGlvblByZWRpY2F0ZShwcmVkaWNhdGU6IExvZ2ljYWxPcGVyYW5kPFByZWRpY2F0ZT4pOiBwcmVkaWNhdGUgaXMgU2VsZWN0aW9uUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiBwcmVkaWNhdGVbJ3NlbGVjdGlvbiddO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEZpZWxkRXF1YWxQcmVkaWNhdGUge1xuICAvLyBUT0RPOiBzdXBwb3J0IGFnZ3JlZ2F0ZVxuXG4gIC8qKlxuICAgKiBUaW1lIHVuaXQgZm9yIHRoZSBmaWVsZCB0byBiZSBmaWx0ZXJlZC5cbiAgICovXG4gIHRpbWVVbml0PzogVGltZVVuaXQ7XG5cbiAgLyoqXG4gICAqIEZpZWxkIHRvIGJlIGZpbHRlcmVkLlxuICAgKi9cbiAgZmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogVGhlIHZhbHVlIHRoYXQgdGhlIGZpZWxkIHNob3VsZCBiZSBlcXVhbCB0by5cbiAgICovXG4gIGVxdWFsOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgRGF0ZVRpbWU7XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZEVxdWFsUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiBwcmVkaWNhdGUuZXF1YWwgIT09IHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGaWVsZFJhbmdlUHJlZGljYXRlIHtcbiAgLy8gVE9ETzogc3VwcG9ydCBhZ2dyZWdhdGVcblxuICAvKipcbiAgICogdGltZSB1bml0IGZvciB0aGUgZmllbGQgdG8gYmUgZmlsdGVyZWQuXG4gICAqL1xuICB0aW1lVW5pdD86IFRpbWVVbml0O1xuXG4gIC8qKlxuICAgKiBGaWVsZCB0byBiZSBmaWx0ZXJlZFxuICAgKi9cbiAgZmllbGQ6IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYXJyYXkgb2YgaW5jbHVzaXZlIG1pbmltdW0gYW5kIG1heGltdW0gdmFsdWVzXG4gICAqIGZvciBhIGZpZWxkIHZhbHVlIG9mIGEgZGF0YSBpdGVtIHRvIGJlIGluY2x1ZGVkIGluIHRoZSBmaWx0ZXJlZCBkYXRhLlxuICAgKiBAbWF4SXRlbXMgMlxuICAgKiBAbWluSXRlbXMgMlxuICAgKi9cbiAgcmFuZ2U6IChudW1iZXJ8RGF0ZVRpbWUpW107XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRSYW5nZVByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZFJhbmdlUHJlZGljYXRlIHtcbiAgaWYgKHByZWRpY2F0ZSAmJiBwcmVkaWNhdGUuZmllbGQpIHtcbiAgICBpZiAoaXNBcnJheShwcmVkaWNhdGUucmFuZ2UpICYmIHByZWRpY2F0ZS5yYW5nZS5sZW5ndGggPT09IDIpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZmFsc2U7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmllbGRPbmVPZlByZWRpY2F0ZSB7XG4gIC8vIFRPRE86IHN1cHBvcnQgYWdncmVnYXRlXG5cbiAgLyoqXG4gICAqIHRpbWUgdW5pdCBmb3IgdGhlIGZpZWxkIHRvIGJlIGZpbHRlcmVkLlxuICAgKi9cbiAgdGltZVVuaXQ/OiBUaW1lVW5pdDtcblxuICAvKipcbiAgICogRmllbGQgdG8gYmUgZmlsdGVyZWRcbiAgICovXG4gIGZpZWxkOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEEgc2V0IG9mIHZhbHVlcyB0aGF0IHRoZSBgZmllbGRgJ3MgdmFsdWUgc2hvdWxkIGJlIGEgbWVtYmVyIG9mLFxuICAgKiBmb3IgYSBkYXRhIGl0ZW0gaW5jbHVkZWQgaW4gdGhlIGZpbHRlcmVkIGRhdGEuXG4gICAqL1xuICBvbmVPZjogc3RyaW5nW10gfCBudW1iZXJbXSB8IGJvb2xlYW5bXSB8IERhdGVUaW1lW107XG5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRPbmVPZlByZWRpY2F0ZShwcmVkaWNhdGU6IGFueSk6IHByZWRpY2F0ZSBpcyBGaWVsZE9uZU9mUHJlZGljYXRlIHtcbiAgcmV0dXJuIHByZWRpY2F0ZSAmJiAhIXByZWRpY2F0ZS5maWVsZCAmJiAoXG4gICAgaXNBcnJheShwcmVkaWNhdGUub25lT2YpIHx8XG4gICAgaXNBcnJheShwcmVkaWNhdGUuaW4pIC8vIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRmllbGRQcmVkaWNhdGUocHJlZGljYXRlOiBQcmVkaWNhdGUpOiBwcmVkaWNhdGUgaXMgRmllbGRPbmVPZlByZWRpY2F0ZSB8IEZpZWxkRXF1YWxQcmVkaWNhdGUgfCBGaWVsZFJhbmdlUHJlZGljYXRlIHtcbiAgcmV0dXJuIGlzRmllbGRPbmVPZlByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGUpIHx8IGlzRmllbGRSYW5nZVByZWRpY2F0ZShwcmVkaWNhdGUpO1xufVxuXG4vKipcbiAqIENvbnZlcnRzIGEgcHJlZGljYXRlIGludG8gYW4gZXhwcmVzc2lvbi5cbiAqL1xuLy8gbW9kZWwgaXMgb25seSB1c2VkIGZvciBzZWxlY3Rpb24gZmlsdGVycy5cbmV4cG9ydCBmdW5jdGlvbiBleHByZXNzaW9uKG1vZGVsOiBNb2RlbCwgZmlsdGVyT3A6IExvZ2ljYWxPcGVyYW5kPFByZWRpY2F0ZT4sIG5vZGU/OiBEYXRhRmxvd05vZGUpOiBzdHJpbmcge1xuICByZXR1cm4gbG9naWNhbEV4cHIoZmlsdGVyT3AsIChwcmVkaWNhdGU6IFByZWRpY2F0ZSkgPT4ge1xuICAgIGlmIChpc1N0cmluZyhwcmVkaWNhdGUpKSB7XG4gICAgICByZXR1cm4gcHJlZGljYXRlO1xuICAgIH0gZWxzZSBpZiAoaXNTZWxlY3Rpb25QcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgICAgcmV0dXJuIHNlbGVjdGlvblByZWRpY2F0ZShtb2RlbCwgcHJlZGljYXRlLnNlbGVjdGlvbiwgbm9kZSk7XG4gICAgfSBlbHNlIHsgLy8gRmlsdGVyIE9iamVjdFxuICAgICAgcmV0dXJuIGZpZWxkRmlsdGVyRXhwcmVzc2lvbihwcmVkaWNhdGUpO1xuICAgIH1cbiAgfSk7XG59XG5cbi8vIFRoaXMgbWV0aG9kIGlzIHVzZWQgYnkgVm95YWdlci4gIERvIG5vdCBjaGFuZ2UgaXRzIGJlaGF2aW9yIHdpdGhvdXQgY2hhbmdpbmcgVm95YWdlci5cbmV4cG9ydCBmdW5jdGlvbiBmaWVsZEZpbHRlckV4cHJlc3Npb24ocHJlZGljYXRlOiBGaWVsZFByZWRpY2F0ZSwgdXNlSW5SYW5nZT10cnVlKSB7XG4gIGNvbnN0IGZpZWxkRXhwciA9IHByZWRpY2F0ZS50aW1lVW5pdCA/XG4gICAgLy8gRm9yIHRpbWVVbml0LCBjYXN0IGludG8gaW50ZWdlciB3aXRoIHRpbWUoKSBzbyB3ZSBjYW4gdXNlID09PSwgaW5yYW5nZSwgaW5kZXhPZiB0byBjb21wYXJlIHZhbHVlcyBkaXJlY3RseS5cbiAgICAgIC8vIFRPRE86IFdlIGNhbGN1bGF0ZSB0aW1lVW5pdCBvbiB0aGUgZmx5IGhlcmUuIENvbnNpZGVyIGlmIHdlIHdvdWxkIGxpa2UgdG8gY29uc29saWRhdGUgdGhpcyB3aXRoIHRpbWVVbml0IHBpcGVsaW5lXG4gICAgICAvLyBUT0RPOiBzdXBwb3J0IHV0Y1xuICAgICgndGltZSgnICsgdGltZVVuaXRGaWVsZEV4cHIocHJlZGljYXRlLnRpbWVVbml0LCBwcmVkaWNhdGUuZmllbGQpICsgJyknKSA6XG4gICAgdmdGaWVsZChwcmVkaWNhdGUsIHtleHByOiAnZGF0dW0nfSk7XG5cbiAgaWYgKGlzRmllbGRFcXVhbFByZWRpY2F0ZShwcmVkaWNhdGUpKSB7XG4gICAgcmV0dXJuIGZpZWxkRXhwciArICc9PT0nICsgdmFsdWVFeHByKHByZWRpY2F0ZS5lcXVhbCwgcHJlZGljYXRlLnRpbWVVbml0KTtcbiAgfSBlbHNlIGlmIChpc0ZpZWxkT25lT2ZQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIC8vIFwib25lT2ZcIiB3YXMgZm9ybWVybHkgXCJpblwiIC0tIHNvIHdlIG5lZWQgdG8gYWRkIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICBjb25zdCBvbmVPZjogRmllbGRPbmVPZlByZWRpY2F0ZVtdID0gcHJlZGljYXRlLm9uZU9mIHx8IHByZWRpY2F0ZVsnaW4nXTtcbiAgICByZXR1cm4gJ2luZGV4b2YoWycgK1xuICAgICAgb25lT2YubWFwKCh2KSA9PiB2YWx1ZUV4cHIodiwgcHJlZGljYXRlLnRpbWVVbml0KSkuam9pbignLCcpICtcbiAgICAgICddLCAnICsgZmllbGRFeHByICsgJykgIT09IC0xJztcbiAgfSBlbHNlIGlmIChpc0ZpZWxkUmFuZ2VQcmVkaWNhdGUocHJlZGljYXRlKSkge1xuICAgIGNvbnN0IGxvd2VyID0gcHJlZGljYXRlLnJhbmdlWzBdO1xuICAgIGNvbnN0IHVwcGVyID0gcHJlZGljYXRlLnJhbmdlWzFdO1xuXG4gICAgaWYgKGxvd2VyICE9PSBudWxsICYmIHVwcGVyICE9PSBudWxsICYmIHVzZUluUmFuZ2UpIHtcbiAgICAgIHJldHVybiAnaW5yYW5nZSgnICsgZmllbGRFeHByICsgJywgWycgK1xuICAgICAgICB2YWx1ZUV4cHIobG93ZXIsIHByZWRpY2F0ZS50aW1lVW5pdCkgKyAnLCAnICtcbiAgICAgICAgdmFsdWVFeHByKHVwcGVyLCBwcmVkaWNhdGUudGltZVVuaXQpICsgJ10pJztcbiAgICB9XG5cbiAgICBjb25zdCBleHBycyA9IFtdO1xuICAgIGlmIChsb3dlciAhPT0gbnVsbCkge1xuICAgICAgZXhwcnMucHVzaChgJHtmaWVsZEV4cHJ9ID49ICR7dmFsdWVFeHByKGxvd2VyLCBwcmVkaWNhdGUudGltZVVuaXQpfWApO1xuICAgIH1cbiAgICBpZiAodXBwZXIgIT09IG51bGwpIHtcbiAgICAgIGV4cHJzLnB1c2goYCR7ZmllbGRFeHByfSA8PSAke3ZhbHVlRXhwcih1cHBlciwgcHJlZGljYXRlLnRpbWVVbml0KX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXhwcnMubGVuZ3RoID4gMCA/IGV4cHJzLmpvaW4oJyAmJiAnKSA6ICd0cnVlJztcbiAgfVxuXG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0OiBpdCBzaG91bGQgbmV2ZXIgcmVhY2ggaGVyZSAqL1xuICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgZmllbGQgcHJlZGljYXRlOiAke0pTT04uc3RyaW5naWZ5KHByZWRpY2F0ZSl9YCk7XG59XG5cbmZ1bmN0aW9uIHZhbHVlRXhwcih2OiBhbnksIHRpbWVVbml0OiBUaW1lVW5pdCk6IHN0cmluZyB7XG4gIGlmIChpc0RhdGVUaW1lKHYpKSB7XG4gICAgY29uc3QgZXhwciA9IGRhdGVUaW1lRXhwcih2LCB0cnVlKTtcbiAgICByZXR1cm4gJ3RpbWUoJyArIGV4cHIgKyAnKSc7XG4gIH1cbiAgaWYgKGlzTG9jYWxTaW5nbGVUaW1lVW5pdCh0aW1lVW5pdCkpIHtcbiAgICBjb25zdCBkYXRldGltZTogRGF0ZVRpbWUgPSB7fTtcbiAgICBkYXRldGltZVt0aW1lVW5pdF0gPSB2O1xuICAgIGNvbnN0IGV4cHIgPSBkYXRlVGltZUV4cHIoZGF0ZXRpbWUsIHRydWUpO1xuICAgIHJldHVybiAndGltZSgnICsgZXhwciArICcpJztcbiAgfSBlbHNlIGlmIChpc1V0Y1NpbmdsZVRpbWVVbml0KHRpbWVVbml0KSkge1xuICAgIHJldHVybiB2YWx1ZUV4cHIodiwgZ2V0TG9jYWxUaW1lVW5pdCh0aW1lVW5pdCkpO1xuICB9XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh2KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG5vcm1hbGl6ZVByZWRpY2F0ZShmOiBQcmVkaWNhdGUpOiBQcmVkaWNhdGUge1xuICBpZiAoaXNGaWVsZFByZWRpY2F0ZShmKSAmJiBmLnRpbWVVbml0KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLmYsXG4gICAgICB0aW1lVW5pdDogbm9ybWFsaXplVGltZVVuaXQoZi50aW1lVW5pdClcbiAgICB9O1xuICB9XG4gIHJldHVybiBmO1xufVxuIl19