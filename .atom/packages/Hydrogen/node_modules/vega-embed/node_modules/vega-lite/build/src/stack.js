"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var vega_util_1 = require("vega-util");
var aggregate_1 = require("./aggregate");
var channel_1 = require("./channel");
var encoding_1 = require("./encoding");
var fielddef_1 = require("./fielddef");
var log = require("./log");
var mark_1 = require("./mark");
var scale_1 = require("./scale");
var util_1 = require("./util");
var STACK_OFFSET_INDEX = {
    zero: 1,
    center: 1,
    normalize: 1
};
function isStackOffset(s) {
    return !!STACK_OFFSET_INDEX[s];
}
exports.isStackOffset = isStackOffset;
exports.STACKABLE_MARKS = [mark_1.BAR, mark_1.AREA, mark_1.RULE, mark_1.POINT, mark_1.CIRCLE, mark_1.SQUARE, mark_1.LINE, mark_1.TEXT, mark_1.TICK];
exports.STACK_BY_DEFAULT_MARKS = [mark_1.BAR, mark_1.AREA];
function potentialStackedChannel(encoding) {
    var xDef = encoding.x;
    var yDef = encoding.y;
    if (fielddef_1.isFieldDef(xDef) && fielddef_1.isFieldDef(yDef)) {
        if (xDef.type === 'quantitative' && yDef.type === 'quantitative') {
            if (xDef.stack) {
                return 'x';
            }
            else if (yDef.stack) {
                return 'y';
            }
            // if there is no explicit stacking, only apply stack if there is only one aggregate for x or y
            if ((!!xDef.aggregate) !== (!!yDef.aggregate)) {
                return xDef.aggregate ? 'x' : 'y';
            }
        }
        else if (xDef.type === 'quantitative') {
            return 'x';
        }
        else if (yDef.type === 'quantitative') {
            return 'y';
        }
    }
    else if (fielddef_1.isFieldDef(xDef) && xDef.type === 'quantitative') {
        return 'x';
    }
    else if (fielddef_1.isFieldDef(yDef) && yDef.type === 'quantitative') {
        return 'y';
    }
    return undefined;
}
// Note: CompassQL uses this method and only pass in required properties of each argument object.
// If required properties change, make sure to update CompassQL.
function stack(m, encoding, stackConfig) {
    var mark = mark_1.isMarkDef(m) ? m.type : m;
    // Should have stackable mark
    if (!util_1.contains(exports.STACKABLE_MARKS, mark)) {
        return null;
    }
    var fieldChannel = potentialStackedChannel(encoding);
    if (!fieldChannel) {
        return null;
    }
    var stackedFieldDef = encoding[fieldChannel];
    var stackedField = fielddef_1.isStringFieldDef(stackedFieldDef) ? fielddef_1.vgField(stackedFieldDef, {}) : undefined;
    var dimensionChannel = fieldChannel === 'x' ? 'y' : 'x';
    var dimensionDef = encoding[dimensionChannel];
    var dimensionField = fielddef_1.isStringFieldDef(dimensionDef) ? fielddef_1.vgField(dimensionDef, {}) : undefined;
    // Should have grouping level of detail that is different from the dimension field
    var stackBy = channel_1.NONPOSITION_CHANNELS.reduce(function (sc, channel) {
        if (encoding_1.channelHasField(encoding, channel)) {
            var channelDef = encoding[channel];
            (vega_util_1.isArray(channelDef) ? channelDef : [channelDef]).forEach(function (cDef) {
                var fieldDef = fielddef_1.getFieldDef(cDef);
                if (fieldDef.aggregate) {
                    return;
                }
                // Check whether the channel's field is identical to x/y's field or if the channel is a repeat
                var f = fielddef_1.isStringFieldDef(fieldDef) ? fielddef_1.vgField(fieldDef, {}) : undefined;
                if (
                // if fielddef is a repeat, just include it in the stack by
                !f ||
                    // otherwise, the field must be different from x and y fields.
                    (f !== dimensionField && f !== stackedField)) {
                    sc.push({ channel: channel, fieldDef: fieldDef });
                }
            });
        }
        return sc;
    }, []);
    if (stackBy.length === 0) {
        return null;
    }
    // Automatically determine offset
    var offset = undefined;
    if (stackedFieldDef.stack !== undefined) {
        offset = stackedFieldDef.stack;
    }
    else if (util_1.contains(exports.STACK_BY_DEFAULT_MARKS, mark)) {
        // Bar and Area with sum ops are automatically stacked by default
        offset = stackConfig === undefined ? 'zero' : stackConfig;
    }
    else {
        offset = stackConfig;
    }
    if (!offset || !isStackOffset(offset)) {
        return null;
    }
    // warn when stacking non-linear
    if (stackedFieldDef.scale && stackedFieldDef.scale.type && stackedFieldDef.scale.type !== scale_1.ScaleType.LINEAR) {
        log.warn(log.message.cannotStackNonLinearScale(stackedFieldDef.scale.type));
    }
    // Check if it is a ranged mark
    if (encoding_1.channelHasField(encoding, fieldChannel === channel_1.X ? channel_1.X2 : channel_1.Y2)) {
        log.warn(log.message.cannotStackRangedMark(fieldChannel));
        return null;
    }
    // Warn if stacking summative aggregate
    if (stackedFieldDef.aggregate && !util_1.contains(aggregate_1.SUM_OPS, stackedFieldDef.aggregate)) {
        log.warn(log.message.stackNonSummativeAggregate(stackedFieldDef.aggregate));
    }
    return {
        groupbyChannel: dimensionDef ? dimensionChannel : undefined,
        fieldChannel: fieldChannel,
        impute: mark_1.isPathMark(mark),
        stackBy: stackBy,
        offset: offset
    };
}
exports.stack = stack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBa0M7QUFDbEMseUNBQW9DO0FBQ3BDLHFDQUE4RTtBQUM5RSx1Q0FBcUQ7QUFDckQsdUNBQWlIO0FBQ2pILDJCQUE2QjtBQUM3QiwrQkFBc0g7QUFDdEgsaUNBQWtDO0FBQ2xDLCtCQUFzQztBQUt0QyxJQUFNLGtCQUFrQixHQUFzQjtJQUM1QyxJQUFJLEVBQUUsQ0FBQztJQUNQLE1BQU0sRUFBRSxDQUFDO0lBQ1QsU0FBUyxFQUFFLENBQUM7Q0FDYixDQUFDO0FBRUYsdUJBQThCLENBQVM7SUFDckMsT0FBTyxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDakMsQ0FBQztBQUZELHNDQUVDO0FBMEJZLFFBQUEsZUFBZSxHQUFHLENBQUMsVUFBRyxFQUFFLFdBQUksRUFBRSxXQUFJLEVBQUUsWUFBSyxFQUFFLGFBQU0sRUFBRSxhQUFNLEVBQUUsV0FBSSxFQUFFLFdBQUksRUFBRSxXQUFJLENBQUMsQ0FBQztBQUM3RSxRQUFBLHNCQUFzQixHQUFHLENBQUMsVUFBRyxFQUFFLFdBQUksQ0FBQyxDQUFDO0FBR2xELGlDQUFpQyxRQUF5QjtJQUN4RCxJQUFNLElBQUksR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3hCLElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7SUFFeEIsSUFBSSxxQkFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLHFCQUFVLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDeEMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGNBQWMsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLGNBQWMsRUFBRTtZQUNoRSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ2QsT0FBTyxHQUFHLENBQUM7YUFDWjtpQkFBTSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7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QyxPQUFPLENBQUMseUJBQXlCLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0tBQzdFO0lBRUQsK0JBQStCO0lBQy9CLElBQUksMEJBQWUsQ0FBQyxRQUFRLEVBQUUsWUFBWSxLQUFLLFdBQUMsQ0FBQyxDQUFDLENBQUMsWUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFFLENBQUMsRUFBRTtRQUMzRCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUMxRCxPQUFPLElBQUksQ0FBQztLQUNiO0lBRUQsdUNBQXVDO0lBQ3ZDLElBQUksZUFBZSxDQUFDLFNBQVMsSUFBSSxDQUFDLGVBQVEsQ0FBQyxtQkFBTyxFQUFFLGVBQWUsQ0FBQyxTQUFTLENBQUMsRUFBRTtRQUM5RSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsMEJBQTBCLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7S0FDN0U7SUFFRCxPQUFPO1FBQ0wsY0FBYyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDM0QsWUFBWSxjQUFBO1FBQ1osTUFBTSxFQUFFLGlCQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3hCLE9BQU8sU0FBQTtRQUNQLE1BQU0sUUFBQTtLQUNQLENBQUM7QUFDSixDQUFDO0FBdEZELHNCQXNGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7aXNBcnJheX0gZnJvbSAndmVnYS11dGlsJztcbmltcG9ydCB7U1VNX09QU30gZnJvbSAnLi9hZ2dyZWdhdGUnO1xuaW1wb3J0IHtOT05QT1NJVElPTl9DSEFOTkVMUywgTm9uUG9zaXRpb25DaGFubmVsLCBYLCBYMiwgWTJ9IGZyb20gJy4vY2hhbm5lbCc7XG5pbXBvcnQge2NoYW5uZWxIYXNGaWVsZCwgRW5jb2Rpbmd9IGZyb20gJy4vZW5jb2RpbmcnO1xuaW1wb3J0IHtGaWVsZCwgRmllbGREZWYsIGdldEZpZWxkRGVmLCBpc0ZpZWxkRGVmLCBpc1N0cmluZ0ZpZWxkRGVmLCBQb3NpdGlvbkZpZWxkRGVmLCB2Z0ZpZWxkfSBmcm9tICcuL2ZpZWxkZGVmJztcbmltcG9ydCAqIGFzIGxvZyBmcm9tICcuL2xvZyc7XG5pbXBvcnQge0FSRUEsIEJBUiwgQ0lSQ0xFLCBpc01hcmtEZWYsIGlzUGF0aE1hcmssIExJTkUsIE1hcmssIE1hcmtEZWYsIFBPSU5ULCBSVUxFLCBTUVVBUkUsIFRFWFQsIFRJQ0t9IGZyb20gJy4vbWFyayc7XG5pbXBvcnQge1NjYWxlVHlwZX0gZnJvbSAnLi9zY2FsZSc7XG5pbXBvcnQge2NvbnRhaW5zLCBGbGFnfSBmcm9tICcuL3V0aWwnO1xuXG5cbmV4cG9ydCB0eXBlIFN0YWNrT2Zmc2V0ID0gJ3plcm8nIHwgJ2NlbnRlcicgfCAnbm9ybWFsaXplJztcblxuY29uc3QgU1RBQ0tfT0ZGU0VUX0lOREVYOiBGbGFnPFN0YWNrT2Zmc2V0PiA9IHtcbiAgemVybzogMSxcbiAgY2VudGVyOiAxLFxuICBub3JtYWxpemU6IDFcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1N0YWNrT2Zmc2V0KHM6IHN0cmluZyk6IHMgaXMgU3RhY2tPZmZzZXQge1xuICByZXR1cm4gISFTVEFDS19PRkZTRVRfSU5ERVhbc107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3RhY2tQcm9wZXJ0aWVzIHtcbiAgLyoqIERpbWVuc2lvbiBheGlzIG9mIHRoZSBzdGFjay4gKi9cbiAgZ3JvdXBieUNoYW5uZWw6ICd4JyB8ICd5JztcblxuICAvKiogTWVhc3VyZSBheGlzIG9mIHRoZSBzdGFjay4gKi9cbiAgZmllbGRDaGFubmVsOiAneCcgfCAneSc7XG5cbiAgLyoqIFN0YWNrLWJ5IGZpZWxkcyBlLmcuLCBjb2xvciwgZGV0YWlsICovXG4gIHN0YWNrQnk6IHtcbiAgICBmaWVsZERlZjogRmllbGREZWY8c3RyaW5nPixcbiAgICBjaGFubmVsOiBOb25Qb3NpdGlvbkNoYW5uZWxcbiAgfVtdO1xuXG4gIC8qKlxuICAgKiBTZWUgYFwic3RhY2tcImAgcHJvcGVydHkgb2YgUG9zaXRpb24gRmllbGQgRGVmLlxuICAgKi9cbiAgb2Zmc2V0OiBTdGFja09mZnNldDtcblxuICAvKipcbiAgICogV2hldGhlciB0aGlzIHN0YWNrIHdpbGwgcHJvZHVjZSBpbXB1dGUgdHJhbnNmb3JtXG4gICAqL1xuICBpbXB1dGU6IGJvb2xlYW47XG59XG5cbmV4cG9ydCBjb25zdCBTVEFDS0FCTEVfTUFSS1MgPSBbQkFSLCBBUkVBLCBSVUxFLCBQT0lOVCwgQ0lSQ0xFLCBTUVVBUkUsIExJTkUsIFRFWFQsIFRJQ0tdO1xuZXhwb3J0IGNvbnN0IFNUQUNLX0JZX0RFRkFVTFRfTUFSS1MgPSBbQkFSLCBBUkVBXTtcblxuXG5mdW5jdGlvbiBwb3RlbnRpYWxTdGFja2VkQ2hhbm5lbChlbmNvZGluZzogRW5jb2Rpbmc8RmllbGQ+KTogJ3gnIHwgJ3knIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgeERlZiA9IGVuY29kaW5nLng7XG4gIGNvbnN0IHlEZWYgPSBlbmNvZGluZy55O1xuXG4gIGlmIChpc0ZpZWxkRGVmKHhEZWYpICYmIGlzRmllbGREZWYoeURlZikpIHtcbiAgICBpZiAoeERlZi50eXBlID09PSAncXVhbnRpdGF0aXZlJyAmJiB5RGVmLnR5cGUgPT09ICdxdWFudGl0YXRpdmUnKSB7XG4gICAgICBpZiAoeERlZi5zdGFjaykge1xuICAgICAgICByZXR1cm4gJ3gnO1xuICAgICAgfSBlbHNlIGlmICh5RGVmLnN0YWNrKSB7XG4gICAgICAgIHJldHVybiAneSc7XG4gICAgICB9XG4gICAgICAvLyBpZiB0aGVyZSBpcyBubyBleHBsaWNpdCBzdGFja2luZywgb25seSBhcHBseSBzdGFjayBpZiB0aGVyZSBpcyBvbmx5IG9uZSBhZ2dyZWdhdGUgZm9yIHggb3IgeVxuICAgICAgaWYgKCghIXhEZWYuYWdncmVnYXRlKSAhPT0gKCEheURlZi5hZ2dyZWdhdGUpKSB7XG4gICAgICAgIHJldHVybiB4RGVmLmFnZ3JlZ2F0ZSA/ICd4JyA6ICd5JztcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHhEZWYudHlwZSA9PT0gJ3F1YW50aXRhdGl2ZScpIHtcbiAgICAgIHJldHVybiAneCc7XG4gICAgfSBlbHNlIGlmICh5RGVmLnR5cGUgPT09ICdxdWFudGl0YXRpdmUnKSB7XG4gICAgICByZXR1cm4gJ3knO1xuICAgIH1cbiAgfSBlbHNlIGlmIChpc0ZpZWxkRGVmKHhEZWYpICYmIHhEZWYudHlwZSA9PT0gJ3F1YW50aXRhdGl2ZScpIHtcbiAgICByZXR1cm4gJ3gnO1xuICB9IGVsc2UgaWYgKGlzRmllbGREZWYoeURlZikgJiYgeURlZi50eXBlID09PSAncXVhbnRpdGF0aXZlJykge1xuICAgIHJldHVybiAneSc7XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuLy8gTm90ZTogQ29tcGFzc1FMIHVzZXMgdGhpcyBtZXRob2QgYW5kIG9ubHkgcGFzcyBpbiByZXF1aXJlZCBwcm9wZXJ0aWVzIG9mIGVhY2ggYXJndW1lbnQgb2JqZWN0LlxuLy8gSWYgcmVxdWlyZWQgcHJvcGVydGllcyBjaGFuZ2UsIG1ha2Ugc3VyZSB0byB1cGRhdGUgQ29tcGFzc1FMLlxuZXhwb3J0IGZ1bmN0aW9uIHN0YWNrKG06IE1hcmsgfCBNYXJrRGVmLCBlbmNvZGluZzogRW5jb2Rpbmc8RmllbGQ+LCBzdGFja0NvbmZpZzogU3RhY2tPZmZzZXQpOiBTdGFja1Byb3BlcnRpZXMge1xuICBjb25zdCBtYXJrID0gaXNNYXJrRGVmKG0pID8gbS50eXBlIDogbTtcbiAgLy8gU2hvdWxkIGhhdmUgc3RhY2thYmxlIG1hcmtcbiAgaWYgKCFjb250YWlucyhTVEFDS0FCTEVfTUFSS1MsIG1hcmspKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBmaWVsZENoYW5uZWwgPSBwb3RlbnRpYWxTdGFja2VkQ2hhbm5lbChlbmNvZGluZyk7XG4gIGlmICghZmllbGRDaGFubmVsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBzdGFja2VkRmllbGREZWYgPSBlbmNvZGluZ1tmaWVsZENoYW5uZWxdIGFzIFBvc2l0aW9uRmllbGREZWY8c3RyaW5nPjtcbiAgY29uc3Qgc3RhY2tlZEZpZWxkID0gaXNTdHJpbmdGaWVsZERlZihzdGFja2VkRmllbGREZWYpID8gdmdGaWVsZChzdGFja2VkRmllbGREZWYsIHt9KSA6IHVuZGVmaW5lZDtcblxuICBjb25zdCBkaW1lbnNpb25DaGFubmVsID0gZmllbGRDaGFubmVsID09PSAneCcgPyAneScgOiAneCc7XG4gIGNvbnN0IGRpbWVuc2lvbkRlZiA9IGVuY29kaW5nW2RpbWVuc2lvbkNoYW5uZWxdO1xuICBjb25zdCBkaW1lbnNpb25GaWVsZCA9IGlzU3RyaW5nRmllbGREZWYoZGltZW5zaW9uRGVmKSA/IHZnRmllbGQoZGltZW5zaW9uRGVmLCB7fSkgOiB1bmRlZmluZWQ7XG5cbiAgLy8gU2hvdWxkIGhhdmUgZ3JvdXBpbmcgbGV2ZWwgb2YgZGV0YWlsIHRoYXQgaXMgZGlmZmVyZW50IGZyb20gdGhlIGRpbWVuc2lvbiBmaWVsZFxuICBjb25zdCBzdGFja0J5ID0gTk9OUE9TSVRJT05fQ0hBTk5FTFMucmVkdWNlKChzYywgY2hhbm5lbCkgPT4ge1xuICAgIGlmIChjaGFubmVsSGFzRmllbGQoZW5jb2RpbmcsIGNoYW5uZWwpKSB7XG4gICAgICBjb25zdCBjaGFubmVsRGVmID0gZW5jb2RpbmdbY2hhbm5lbF07XG4gICAgICAoaXNBcnJheShjaGFubmVsRGVmKSA/IGNoYW5uZWxEZWYgOiBbY2hhbm5lbERlZl0pLmZvckVhY2goKGNEZWYpID0+IHtcbiAgICAgICAgY29uc3QgZmllbGREZWYgPSBnZXRGaWVsZERlZihjRGVmKTtcbiAgICAgICAgaWYgKGZpZWxkRGVmLmFnZ3JlZ2F0ZSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIHdoZXRoZXIgdGhlIGNoYW5uZWwncyBmaWVsZCBpcyBpZGVudGljYWwgdG8geC95J3MgZmllbGQgb3IgaWYgdGhlIGNoYW5uZWwgaXMgYSByZXBlYXRcbiAgICAgICAgY29uc3QgZiA9IGlzU3RyaW5nRmllbGREZWYoZmllbGREZWYpID8gdmdGaWVsZChmaWVsZERlZiwge30pIDogdW5kZWZpbmVkO1xuICAgICAgICBpZiAoXG4gICAgICAgICAgLy8gaWYgZmllbGRkZWYgaXMgYSByZXBlYXQsIGp1c3QgaW5jbHVkZSBpdCBpbiB0aGUgc3RhY2sgYnlcbiAgICAgICAgICAhZiB8fFxuICAgICAgICAgIC8vIG90aGVyd2lzZSwgdGhlIGZpZWxkIG11c3QgYmUgZGlmZmVyZW50IGZyb20geCBhbmQgeSBmaWVsZHMuXG4gICAgICAgICAgKGYgIT09IGRpbWVuc2lvbkZpZWxkICYmIGYgIT09IHN0YWNrZWRGaWVsZClcbiAgICAgICAgKSB7XG4gICAgICAgICAgc2MucHVzaCh7Y2hhbm5lbCwgZmllbGREZWZ9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBzYztcbiAgfSwgW10pO1xuXG4gIGlmIChzdGFja0J5Lmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gQXV0b21hdGljYWxseSBkZXRlcm1pbmUgb2Zmc2V0XG4gIGxldCBvZmZzZXQ6IFN0YWNrT2Zmc2V0ID0gdW5kZWZpbmVkO1xuICBpZiAoc3RhY2tlZEZpZWxkRGVmLnN0YWNrICE9PSB1bmRlZmluZWQpIHtcbiAgICBvZmZzZXQgPSBzdGFja2VkRmllbGREZWYuc3RhY2s7XG4gIH0gZWxzZSBpZiAoY29udGFpbnMoU1RBQ0tfQllfREVGQVVMVF9NQVJLUywgbWFyaykpIHtcbiAgICAvLyBCYXIgYW5kIEFyZWEgd2l0aCBzdW0gb3BzIGFyZSBhdXRvbWF0aWNhbGx5IHN0YWNrZWQgYnkgZGVmYXVsdFxuICAgIG9mZnNldCA9IHN0YWNrQ29uZmlnID09PSB1bmRlZmluZWQgPyAnemVybycgOiBzdGFja0NvbmZpZztcbiAgfSBlbHNlIHtcbiAgICBvZmZzZXQgPSBzdGFja0NvbmZpZztcbiAgfVxuXG4gIGlmICghb2Zmc2V0IHx8ICFpc1N0YWNrT2Zmc2V0KG9mZnNldCkpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIC8vIHdhcm4gd2hlbiBzdGFja2luZyBub24tbGluZWFyXG4gIGlmIChzdGFja2VkRmllbGREZWYuc2NhbGUgJiYgc3RhY2tlZEZpZWxkRGVmLnNjYWxlLnR5cGUgJiYgc3RhY2tlZEZpZWxkRGVmLnNjYWxlLnR5cGUgIT09IFNjYWxlVHlwZS5MSU5FQVIpIHtcbiAgICBsb2cud2Fybihsb2cubWVzc2FnZS5jYW5ub3RTdGFja05vbkxpbmVhclNjYWxlKHN0YWNrZWRGaWVsZERlZi5zY2FsZS50eXBlKSk7XG4gIH1cblxuICAvLyBDaGVjayBpZiBpdCBpcyBhIHJhbmdlZCBtYXJrXG4gIGlmIChjaGFubmVsSGFzRmllbGQoZW5jb2RpbmcsIGZpZWxkQ2hhbm5lbCA9PT0gWCA/IFgyIDogWTIpKSB7XG4gICAgbG9nLndhcm4obG9nLm1lc3NhZ2UuY2Fubm90U3RhY2tSYW5nZWRNYXJrKGZpZWxkQ2hhbm5lbCkpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLy8gV2FybiBpZiBzdGFja2luZyBzdW1tYXRpdmUgYWdncmVnYXRlXG4gIGlmIChzdGFja2VkRmllbGREZWYuYWdncmVnYXRlICYmICFjb250YWlucyhTVU1fT1BTLCBzdGFja2VkRmllbGREZWYuYWdncmVnYXRlKSkge1xuICAgIGxvZy53YXJuKGxvZy5tZXNzYWdlLnN0YWNrTm9uU3VtbWF0aXZlQWdncmVnYXRlKHN0YWNrZWRGaWVsZERlZi5hZ2dyZWdhdGUpKTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZ3JvdXBieUNoYW5uZWw6IGRpbWVuc2lvbkRlZiA/IGRpbWVuc2lvbkNoYW5uZWwgOiB1bmRlZmluZWQsXG4gICAgZmllbGRDaGFubmVsLFxuICAgIGltcHV0ZTogaXNQYXRoTWFyayhtYXJrKSxcbiAgICBzdGFja0J5LFxuICAgIG9mZnNldFxuICB9O1xufVxuIl19