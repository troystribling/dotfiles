{"version":3,"file":"interval.js","sourceRoot":"","sources":["../../../../src/compile/selection/interval.ts"],"names":[],"mappings":"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","sourcesContent":["import {NewSignal, OnEvent} from 'vega';\nimport {stringValue} from 'vega-util';\nimport {SelectionCompiler, SelectionComponent, STORE, TUPLE, unitName} from '.';\nimport {ScaleChannel, X, Y} from '../../channel';\nimport {warn} from '../../log';\nimport {hasContinuousDomain} from '../../scale';\nimport {SelectionInitInterval} from '../../selection';\nimport {keys} from '../../util';\nimport {EventStream} from '../../vega.schema';\nimport {UnitModel} from '../unit';\nimport {assembleInit} from './assemble';\nimport {SelectionProjection, TUPLE_FIELDS} from './transforms/project';\nimport scales from './transforms/scales';\n\nexport const BRUSH = '_brush';\nexport const SCALE_TRIGGER = '_scale_trigger';\n\nconst interval: SelectionCompiler<'interval'> = {\n  signals: (model, selCmpt) => {\n    const name = selCmpt.name;\n    const fieldsSg = name + TUPLE_FIELDS;\n    const hasScales = scales.has(selCmpt);\n    const signals: NewSignal[] = [];\n    const dataSignals: string[] = [];\n    const scaleTriggers: {\n      scaleName: string;\n      expr: string;\n    }[] = [];\n\n    if (selCmpt.translate && !hasScales) {\n      const filterExpr = `!event.item || event.item.mark.name !== ${stringValue(name + BRUSH)}`;\n      events(selCmpt, (_: OnEvent[], evt: EventStream) => {\n        const filters = evt.between[0].filter || (evt.between[0].filter = []);\n        if (filters.indexOf(filterExpr) < 0) {\n          filters.push(filterExpr);\n        }\n      });\n    }\n\n    selCmpt.project.items.forEach((proj, i) => {\n      const channel = proj.channel;\n      if (channel !== X && channel !== Y) {\n        warn('Interval selections only support x and y encoding channels.');\n        return;\n      }\n\n      const init = selCmpt.init ? selCmpt.init[i] : null;\n      const cs = channelSignals(model, selCmpt, proj, init);\n      const dname = proj.signals.data;\n      const vname = proj.signals.visual;\n      const scaleName = stringValue(model.scaleName(channel));\n      const scaleType = model.getScaleComponent(channel).get('type');\n      const toNum = hasContinuousDomain(scaleType) ? '+' : '';\n\n      signals.push(...cs);\n      dataSignals.push(dname);\n\n      scaleTriggers.push({\n        scaleName: model.scaleName(channel),\n        expr:\n          `(!isArray(${dname}) || ` +\n          `(${toNum}invert(${scaleName}, ${vname})[0] === ${toNum}${dname}[0] && ` +\n          `${toNum}invert(${scaleName}, ${vname})[1] === ${toNum}${dname}[1]))`\n      });\n    });\n\n    // Proxy scale reactions to ensure that an infinite loop doesn't occur\n    // when an interval selection filter touches the scale.\n    if (!hasScales) {\n      signals.push({\n        name: name + SCALE_TRIGGER,\n        value: {},\n        on: [\n          {\n            events: scaleTriggers.map(t => ({scale: t.scaleName})),\n            update: scaleTriggers.map(t => t.expr).join(' && ') + ` ? ${name + SCALE_TRIGGER} : {}`\n          }\n        ]\n      });\n    }\n\n    // Only add an interval to the store if it has valid data extents. Data extents\n    // are set to null if pixel extents are equal to account for intervals over\n    // ordinal/nominal domains which, when inverted, will still produce a valid datum.\n    const init = selCmpt.init;\n    const update = `unit: ${unitName(model)}, fields: ${fieldsSg}, values`;\n    return signals.concat({\n      name: name + TUPLE,\n      ...(init ? {init: `{${update}: ${assembleInit(init)}}`} : {}),\n      on: [\n        {\n          events: [{signal: dataSignals.join(' || ')}], // Prevents double invocation, see https://github.com/vega/vega#1672.\n          update: dataSignals.join(' && ') + ` ? {${update}: [${dataSignals}]} : null`\n        }\n      ]\n    });\n  },\n\n  modifyExpr: (model, selCmpt) => {\n    const tpl = selCmpt.name + TUPLE;\n    return tpl + ', ' + (selCmpt.resolve === 'global' ? 'true' : `{unit: ${unitName(model)}}`);\n  },\n\n  marks: (model, selCmpt, marks) => {\n    const name = selCmpt.name;\n    const {x, y} = selCmpt.project.has;\n    const xvname = x && x.signals.visual;\n    const yvname = y && y.signals.visual;\n    const store = `data(${stringValue(selCmpt.name + STORE)})`;\n\n    // Do not add a brush if we're binding to scales.\n    if (scales.has(selCmpt)) {\n      return marks;\n    }\n\n    const update: any = {\n      x: x !== undefined ? {signal: `${xvname}[0]`} : {value: 0},\n      y: y !== undefined ? {signal: `${yvname}[0]`} : {value: 0},\n      x2: x !== undefined ? {signal: `${xvname}[1]`} : {field: {group: 'width'}},\n      y2: y !== undefined ? {signal: `${yvname}[1]`} : {field: {group: 'height'}}\n    };\n\n    // If the selection is resolved to global, only a single interval is in\n    // the store. Wrap brush mark's encodings with a production rule to test\n    // this based on the `unit` property. Hide the brush mark if it corresponds\n    // to a unit different from the one in the store.\n    if (selCmpt.resolve === 'global') {\n      for (const key of keys(update)) {\n        update[key] = [\n          {\n            test: `${store}.length && ${store}[0].unit === ${unitName(model)}`,\n            ...update[key]\n          },\n          {value: 0}\n        ];\n      }\n    }\n\n    // Two brush marks ensure that fill colors and other aesthetic choices do\n    // not interefere with the core marks, but that the brushed region can still\n    // be interacted with (e.g., dragging it around).\n    const {fill, fillOpacity, ...stroke} = selCmpt.mark;\n    const vgStroke = keys(stroke).reduce((def, k) => {\n      def[k] = [\n        {\n          test: [x !== undefined && `${xvname}[0] !== ${xvname}[1]`, y !== undefined && `${yvname}[0] !== ${yvname}[1]`]\n            .filter(t => t)\n            .join(' && '),\n          value: stroke[k]\n        },\n        {value: null}\n      ];\n      return def;\n    }, {});\n\n    return [\n      {\n        name: name + BRUSH + '_bg',\n        type: 'rect',\n        clip: true,\n        encode: {\n          enter: {\n            fill: {value: fill},\n            fillOpacity: {value: fillOpacity}\n          },\n          update: update\n        }\n      },\n      ...marks,\n      {\n        name: name + BRUSH,\n        type: 'rect',\n        clip: true,\n        encode: {\n          enter: {\n            fill: {value: 'transparent'}\n          },\n          update: {...update, ...vgStroke}\n        }\n      }\n    ];\n  }\n};\nexport default interval;\n\n/**\n * Returns the visual and data signals for an interval selection.\n */\nfunction channelSignals(\n  model: UnitModel,\n  selCmpt: SelectionComponent<'interval'>,\n  proj: SelectionProjection,\n  init?: SelectionInitInterval\n): NewSignal[] {\n  const channel = proj.channel;\n  const vname = proj.signals.visual;\n  const dname = proj.signals.data;\n  const hasScales = scales.has(selCmpt);\n  const scaleName = stringValue(model.scaleName(channel));\n  const scale = model.getScaleComponent(channel as ScaleChannel);\n  const scaleType = scale ? scale.get('type') : undefined;\n  const scaled = (str: string) => `scale(${scaleName}, ${str})`;\n  const size = model.getSizeSignalRef(channel === X ? 'width' : 'height').signal;\n  const coord = `${channel}(unit)`;\n\n  const on = events(selCmpt, (def: OnEvent[], evt: EventStream) => {\n    return [\n      ...def,\n      {events: evt.between[0], update: `[${coord}, ${coord}]`}, // Brush Start\n      {events: evt, update: `[${vname}[0], clamp(${coord}, 0, ${size})]`} // Brush End\n    ];\n  });\n\n  // React to pan/zooms of continuous scales. Non-continuous scales\n  // (band, point) cannot be pan/zoomed and any other changes\n  // to their domains (e.g., filtering) should clear the brushes.\n  on.push({\n    events: {signal: selCmpt.name + SCALE_TRIGGER},\n    update: hasContinuousDomain(scaleType) ? `[${scaled(`${dname}[0]`)}, ${scaled(`${dname}[1]`)}]` : `[0, 0]`\n  });\n\n  return hasScales\n    ? [{name: dname, on: []}]\n    : [\n        {\n          name: vname,\n          ...(init ? {init: assembleInit(init, scaled)} : {value: []}),\n          on: on\n        },\n        {\n          name: dname,\n          ...(init ? {init: assembleInit(init)} : {}), // Cannot be `value` as `init` may require datetime exprs.\n          on: [\n            {\n              events: {signal: vname},\n              update: `${vname}[0] === ${vname}[1] ? null : invert(${scaleName}, ${vname})`\n            }\n          ]\n        }\n      ];\n}\n\nfunction events(selCmpt: SelectionComponent<'interval'>, cb: (...args: any[]) => void) {\n  return selCmpt.events.reduce((on: OnEvent[], evt: EventStream) => {\n    if (!evt.between) {\n      warn(`${evt} is not an ordered event stream for interval selections`);\n      return on;\n    }\n    return cb(on, evt);\n  }, []);\n}\n"]}