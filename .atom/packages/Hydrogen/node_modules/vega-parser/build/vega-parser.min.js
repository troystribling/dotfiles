!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-expression"),require("vega-statistics"),require("d3-color"),require("d3-array"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("vega-scenegraph"),require("vega-event-selector")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-expression","vega-statistics","d3-color","d3-array","d3-format","d3-time-format","vega-scale","vega-scenegraph","vega-event-selector"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.vega,e.d3,e.d3,e.d3,e.d3,e.vega,e.vega,e.vega)}(this,function(e,t,n,r,i,a,o,l,u,s,d,f){"use strict";function c(e){return+e||0}function p(e){return{top:e,bottom:e,left:e,right:e}}function g(e,n){t.error(e+' for "outer" push: '+t.stringValue(n))}function h(e,t,n){var r=e+":"+n,i=yt[r];return i&&i[0]===t||(yt[r]=i=[t,t(n)]),i[1]}function m(e,t){return h("timeFormat",u.timeFormat,t)(e)}function v(e,t,n){return bt.setMonth(e),bt.setDate(t),m(bt,n)}function y(e,t,n){try{e[t].apply(e,["EXPRESSION"].concat([].slice.call(n)))}catch(t){e.warn(t)}return n[n.length-1]}function b(e,n){var r;return t.isFunction(e)?e:t.isString(e)?(r=n.scales[e])&&r.value:void 0}function x(e,t,n){var r=wt+n;if(!t.hasOwnProperty(r))try{t[r]=e.scaleRef(n)}catch(e){}}function k(e,t,n,r){if(t[0].type===kt)x(n,r,t[0].value);else if(t[0].type===St)for(e in n.scales)x(n,r,e)}function S(e){return function(t,n,r){var i=b(t,(r||this).context);return i&&i.path[e](n)}}function R(e){var t=this.context.data[e];return t?t.values.value:[]}function w(e,n,r,i){n[0].type!==kt&&t.error("First argument to data functions must be a string literal.");var a=n[0].value,o=Ot+a;i.hasOwnProperty(o)||(i[o]=r.getData(a).tuplesRef())}function O(e){return e.data}function z(e,t){var n=R.call(t,e);return n.root&&n.root.lookup||Dt}function P(e,n){return e===n||e!==e&&n!==n||!(!t.isArray(e)||!t.isArray(n)||e.length!==n.length)&&j(e,n)}function j(e,t){for(var n=0,r=e.length;n<r;++n)if(!P(e[n],t[n]))return!1;return!0}function D(e){return function(t){for(var n in e)if(!P(t[n],e[n]))return!1;return!0}}function $(e,n){for(var r,i=n.fields,a=n.values,o=n.getter||(n.getter=[]),l=i.length,u=0;u<l;++u)if(o[u]=o[u]||t.field(i[u]),r=o[u](e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(a[u])&&(a[u]=t.toNumber(a[u])),n[Et+i[u]]){if(t.isDate(a[u][0])&&(a[u]=a[u].map(t.toNumber)),!$t(r,a[u],!0,!1))return!1}else if(r!==a[u])return!1;return!0}function E(e,n){for(var r,i,a,o=n.intervals,l=o.length,u=0;u<l;++u){if(i=o[u].extent,r=o[u].getter||(o[u].getter=t.field(o[u].field)),a=r(e),!i||i[0]===i[1])return!1;if(t.isDate(a)&&(a=t.toNumber(a)),t.isDate(i[0])&&(i=o[u].extent=i.map(t.toNumber)),t.isNumber(i[0])&&!$t(a,i))return!1;if(t.isString(i[0])&&i.indexOf(a)<0)return!1}return!0}function _(e,t,n,r){for(var i,a,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=s?s[Vt]&&s[Vt].value:void 0,c=n===_t,p=d.length,g=0;g<p;++g)if(i=d[g],f&&c){if(a=a||{},-1===(o=a[l=i.unit]||0))continue;if(u=r(t,i),a[l]=u?-1:++o,u&&1===f.size)return!0;if(!u&&o===f.get(l).count)return!1}else if(u=r(t,i),c^u)return u;return p&&c}function F(e,t,n){return _.call(this,e,t,n,$)}function V(e,n,r,i){n[0].type!==kt&&t.error("First argument to indata must be a string literal.");var a=n[0].value,o=n.length>=2&&n[n.length-1].value,l=Rt+"unit";o!==_t||i.hasOwnProperty(l)||(i[l]=r.getData(a).indataRef(r,"unit")),w(e,n,r,i)}function W(e,t,n,r){var i,a,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=s?s[Vt]&&s[Vt].value:void 0,c=d[0],p=0;if(c){for(i=t?c.encodings.length:c.fields.length;p<i;++p)if(t&&c.encodings[p]===t||n&&c.fields[p]===n){a=p,l=c[Et+c.fields[p]];break}return f&&1===f.size&&(r=Ft),f&&r===_t?(u=d.reduce(function(e,t){return(e[t.unit]||(e[t.unit]=[])).push({unit:t.unit,value:t.values[a]}),e},{}),o=Object.keys(u).map(function(e){return{unit:e,value:l?M(u[e],Ft):A(u[e],Ft)}})):o=d.map(function(e){return{unit:e.unit,value:e.values[a]}}),l?M(o,r):A(o,r)}}function A(e,t){for(var n,r,i,a,o={},l=0,u={},s=[],d=0,f=e.length;d<f;++d)r=(n=e[d]).unit,a=n.value,o[r]||(o[r]=++l),(i=u[a])||(u[a]=i={value:a,units:{},count:0}),i.units[r]||(i.units[r]=++i.count);for(a in u)i=u[a],t===_t&&i.count!==l||s.push(i.value);return s.length?s:void 0}function M(e,n){for(var r,i,a,o,l=n===_t?C:L,u=0,s=e.length;u<s;++u)r=e[u].value,t.isDate(r[0])&&(r=r.map(t.toNumber)),(a=r[0])>(o=r[1])&&(o=r[0],a=r[1]),i=i?l(i,a,o):[a,o];return i&&i.length&&+i[0]!=+i[1]?i:void 0}function L(e,t,n){return e[0]>t&&(e[0]=t),e[1]<n&&(e[1]=n),e}function C(e,t,n){return n<e[0]||e[1]<t?[]:(e[0]<t&&(e[0]=t),e[1]>n&&(e[1]=n),e)}function q(e,t,n){return 1===arguments.length?Wt[e]:(Wt[e]=t,n&&(Ct[e]=n),Bt&&(Bt.functions[e]=Lt+e),this)}function B(e){return e===Tt?Ut:e||Ut}function N(e,n){return(e.merge?U:e.stream?T:e.type?I:t.error("Invalid stream specification: "+t.stringValue(e)))(e,n)}function U(e,t){var n=X({merge:e.merge.map(function(e){return N(e,t)})},e,t);return t.addStream(n).id}function T(e,t){var n=X({stream:N(e.stream,t)},e,t);return t.addStream(n).id}function I(e,t){var n=t.event(B(e.source),e.type),r=X({stream:n},e,t);return 1===Object.keys(r).length?n:t.addStream(r).id}function X(e,n,r){var i=n.between;return i&&(2!==i.length&&t.error('Stream "between" parameter must have 2 entries: '+t.stringValue(n)),e.between=[N(i[0],r),N(i[1],r)]),i=n.filter?t.array(n.filter):[],(n.marktype||n.markname||n.markrole)&&i.push(H(n.marktype,n.markname,n.markrole)),n.source===Tt&&i.push("inScope(event.item)"),i.length&&(e.filter=Nt("("+i.join(")&&(")+")").$expr),null!=(i=n.throttle)&&(e.throttle=+i),null!=(i=n.debounce)&&(e.debounce=+i),n.consume&&(e.consume=!0),e}function H(e,t,n){var r="event.item";return r+(e&&"*"!==e?"&&"+r+".mark.marktype==='"+e+"'":"")+(n?"&&"+r+".mark.role==='"+n+"'":"")+(t?"&&"+r+".mark.name==='"+t+"'":"")}function Y(e,t,n,r){this.id=-1,this.type=e,this.value=t,this.params=n,r&&(this.parent=r)}function G(e,t,n,r){return new Y(e,t,n,r)}function J(e,t){return G("operator",e,t)}function K(e){var t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}function Q(e,t){return t?{$field:e,$name:t}:{$field:e}}function Z(e,t){return{$compare:e,$order:t}}function ee(e,t){var n={$key:e};return t&&(n.$flat=!0),n}function te(e){return t.isObject(e)?(e.order===Kt?"-":"+")+ne(e.op,e.field):""}function ne(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}function re(e){return e&&e.signal}function ie(e,t){return null!=e?e:t}function ae(e){return function(t,n,r){return G(e,n,t||void 0,r)}}function oe(e){return jn.hasOwnProperty(e)}function le(e){return"quantile"===e}function ue(e,n){var r=e.type||"linear";Pn.hasOwnProperty(r)||t.error("Unrecognized scale type: "+t.stringValue(r)),n.addScale(e.name,{type:r,domain:void 0})}function se(e,t){var n,r=t.getScale(e.name).params;r.domain=pe(e.domain,e,t),null!=e.range&&(r.range=we(e,t,r)),null!=e.interpolate&&Re(e.interpolate,r),null!=e.nice&&Se(e.nice,r);for(n in e)r.hasOwnProperty(n)||"name"===n||(r[n]=de(e[n],t))}function de(e,n){return t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported object: "+t.stringValue(e)):e}function fe(e,t){return e.signal?t.signalRef(e.signal):e.map(function(e){return de(e,t)})}function ce(e){t.error("Can not find data set: "+t.stringValue(e))}function pe(e,n,r){if(e)return e.signal?r.signalRef(e.signal):(t.isArray(e)?ge:e.fields?me:he)(e,n,r);null==n.domainMin&&null==n.domainMax||t.error("No scale domain defined for domainMin/domainMax to override.")}function ge(e,t,n){return e.map(function(e){return de(e,n)})}function he(e,t,n){var r=n.getData(e.data);return r||ce(e.data),oe(t.type)?r.valuesRef(n,e.field,be(e.sort,!1)):le(t.type)?r.domainRef(n,e.field):r.extentRef(n,e.field)}function me(e,n,r){var i=e.data,a=e.fields.reduce(function(e,n){return n=t.isString(n)?{data:i,field:n}:t.isArray(n)||n.signal?ve(n,r):n,e.push(n),e},[]);return(oe(n.type)?ye:le(n.type)?xe:ke)(e,r,a)}function ve(e,n){var r="_:vega:_"+On++,i=tn({});if(t.isArray(e))i.value={$ingest:e};else if(e.signal){var a="setdata("+t.stringValue(r)+","+e.signal+")";i.params.input=n.signalRef(a)}return n.addDataPipeline(r,[i,kn({})]),{data:r,field:"data"}}function ye(e,t,n){var r,i,a,o;return r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.countsRef(t,e.field)}),i=t.add(Qt({groupby:Jt,ops:["sum"],fields:[t.fieldRef("count")],as:["count"],pulse:r})),a=t.add(tn({pulse:K(i)})),o=t.add(wn({field:Jt,sort:t.sortRef(be(e.sort,!0)),pulse:K(a)})),K(o)}function be(e,n){return e&&(e.field||e.op?e.field||"count"===e.op?n&&e.field?t.error("Multiple domain scales can not sort by field."):n&&e.op&&"count"!==e.op&&t.error("Multiple domain scales support op count only."):t.error("No field provided for sort aggregate op: "+e.op):t.isObject(e)?e.field="key":e={field:"key"}),e}function xe(e,t,n){var r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.domainRef(t,e.field)});return K(t.add(cn({values:r})))}function ke(e,t,n){var r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.extentRef(t,e.field)});return K(t.add(fn({extents:r})))}function Se(e,n){n.nice=t.isObject(e)?{interval:de(e.interval),step:de(e.step)}:de(e)}function Re(e,t){t.interpolate=de(e.type||e),null!=e.gamma&&(t.interpolateGamma=de(e.gamma))}function we(e,n,r){var i=e.range,a=n.config.range;if(i.signal)return n.signalRef(i.signal);if(t.isString(i)){if(a&&a.hasOwnProperty(i))return e=t.extend({},e,{range:a[i]}),we(e,n,r);"width"===i?i=[0,{signal:"width"}]:"height"===i?i=oe(e.type)?[0,{signal:"height"}]:[{signal:"height"},0]:t.error("Unrecognized scale range value: "+t.stringValue(i))}else{if(i.scheme)return r.scheme=de(i.scheme,n),i.extent&&(r.schemeExtent=fe(i.extent,n)),void(i.count&&(r.schemeCount=de(i.count,n)));if(i.step)return void(r.rangeStep=de(i.step,n));if(oe(e.type)&&!t.isArray(i))return pe(i,e,n);t.isArray(i)||t.error("Unsupported range type: "+t.stringValue(i))}return i.map(function(e){return de(e,n)})}function Oe(e,n){return t.isArray(e)?e.map(function(e){return Oe(e,n)}):t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported parameter object: "+t.stringValue(e)):e}function ze(e,n,r,i){var a,o,l;if(e.signal)a="datum",l=Nn(e.signal,n,r,i);else if(e.group||e.parent){for(o=Math.max(1,e.level||1),a="item";o-- >0;)a+=".mark.group";e.parent?(l=e.parent,a+=".datum"):l=e.group}else e.datum?(a="datum",l=e.datum):t.error("Invalid field reference: "+t.stringValue(e));return e.signal||(t.isString(l)?(i[l]=1,l=t.splitAccessPath(l).map(t.stringValue).join("][")):l=ze(l,n,r,i)),a+"["+l+"]"}function Pe(e,n){if(!t.isString(e))return-1;var r=n.scaleType(e);return"band"===r||"point"===r?1:0}function je(e,n,r,i){var a;if(t.isString(e))a=wt+e,r.hasOwnProperty(a)||(r[a]=n.scaleRef(e)),a=t.stringValue(a);else{for(a in n.scales)r[wt+a]=n.scaleRef(a);a=t.stringValue(wt)+"+"+(e.signal?"("+Nn(e.signal,n,r,i)+")":Un(e,n,r,i))}return"_["+a+"]"}function De(e,n,r,i){var a,o,l,u={},s="var o=item,datum=o.datum,$;";for(a in e)o=e[a],t.isArray(o)?s+=Gn(a,o,i,r,u):(l=Hn(a,o,i,r,u),s+=Yn("o",a,l));return s+=qn(e,n),s+="return 1;",{$expr:s,$fields:Object.keys(u),$output:Object.keys(e)}}function $e(e){return t.isObject(e)?e:{value:e}}function Ee(e,n,r){return null!=r?(e[n]=t.isObject(r)&&!t.isArray(r)?r:{value:r},1):0}function _e(e,n,r){for(var i in n)r&&r.hasOwnProperty(i)||(e[i]=t.extend(e[i]||{},n[i]));return e}function Fe(e,t,n,r,i,a){var o,l;(a=a||{}).encoders={$encode:o={}},e=Ve(e,t,n,r,i.config);for(l in e)o[l]=De(e[l],t,a,i);return a}function Ve(e,n,r,i,a){var o,l,u={};"legend"!=r&&0!==String(r).indexOf("axis")||(r=null),l=r===Kn?a.group:r===Jn?t.extend({},a.mark,a[n]):null;for(o in l)We(o,e)||("fill"===o||"stroke"===o)&&(We("fill",e)||We("stroke",e))||(u[o]={value:l[o]});return t.array(i).forEach(function(t){var n=a.style&&a.style[t];for(var r in n)We(r,e)||(u[r]={value:n[r]})}),e=t.extend({},e),e.enter=t.extend(u,e.enter),e}function We(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}function Ae(e,t,n){var r,i,a,o={};for(i=0,a=e.params.length;i<a;++i)o[(r=e.params[i]).name]=Me(r,t,n);return o}function Me(e,n,r){var i=e.type,a=n[e.name];if("index"===i)return Ce(e,n,r);{if(void 0!==a)return"param"===i?qe(e,n,r):"projection"===i?r.projectionRef(n[e.name]):e.array&&!re(a)?a.map(function(t){return Le(e,t,r)}):Le(e,a,r);e.required&&t.error("Missing required "+t.stringValue(n.type)+" parameter: "+t.stringValue(e.name))}}function Le(e,n,r){var i=e.type;if(re(n))return Ie(i)?t.error("Expression references can not be signals."):Xe(i)?r.fieldRef(n):He(i)?r.compareRef(n):r.signalRef(n.signal);var a=e.expr||Xe(i);return a&&Ne(n)?Nt(n.expr,r):a&&Ue(n)?Q(n.field):Ie(i)?Nt(n,r):Te(i)?K(r.getData(n).values):Xe(i)?Q(n):He(i)?r.compareRef(n):n}function Ce(e,n,r){return t.isString(n.from)||t.error('Lookup "from" parameter must be a string literal.'),r.getData(n.from).lookupRef(r,n.key)}function qe(e,n,r){var i=n[e.name];return e.array?(t.isArray(i)||t.error("Expected an array of sub-parameters. Instead: "+t.stringValue(i)),i.map(function(t){return Be(e,t,r)})):Be(e,i,r)}function Be(e,n,r){var i,a,o,l,u;for(l=0,u=e.params.length;l<u;++l){a=e.params[l];for(o in a.key)if(a.key[o]!==n[o]){a=null;break}if(a)break}return a||t.error("Unsupported parameter: "+t.stringValue(n)),i=t.extend(Ae(a,n,r),a.key),K(r.add(gn(i)))}function Ne(e){return e&&e.expr}function Ue(e){return e&&e.field}function Te(e){return"data"===e}function Ie(e){return"expr"===e}function Xe(e){return"field"===e}function He(e){return"compare"===e}function Ye(e,t,n,r,i){this.scope=e,this.input=t,this.output=n,this.values=r,this.aggregate=i,this.index={}}function Ge(e){return t.isString(e)?e:null}function Je(e,t,n){var r,i=ne(n.op,n.field);if(t.ops){for(var a=0,o=t.as.length;a<o;++a)if(t.as[a]===i)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((r=n.op.signal)?e.signalRef(r):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(i))}function Ke(e,t,n,r,i,a,o){var l,u,s=t[n]||(t[n]={}),d=te(a),f=Ge(i);if(null!=f&&(e=t.scope,l=s[f+=d?"|"+d:""]),!l){var c=a?{field:Jt,pulse:t.countsRef(e,i,a)}:{field:e.fieldRef(i),pulse:K(t.output)};d&&(c.sort=e.sortRef(a)),u=e.add(G(r,void 0,c)),o&&(t.index[i]=u),l=K(u),null!=f&&(s[f]=l)}return l}function Qe(e,t,n){var r=et(t,n[1].encode,"fontSize",Vn);if(e.size)return{$expr:"Math.max(Math.ceil(Math.sqrt(_.scale(datum))),"+r+")"};var i=et(t,n[0].encode,"size");return Math.max(Math.ceil(Math.sqrt(i)),r)}function Ze(e){var t={};return Ee(t,"fill",e.fillColor)+Ee(t,"stroke",e.strokeColor)+Ee(t,"strokeWidth",e.strokeWidth)+Ee(t,"strokeDash",e.strokeDash)+Ee(t,"cornerRadius",e.cornerRadius)?t:void 0}function et(e,t,n,r){var i=t&&(t.update&&t.update[n]||t.enter&&t.enter[n]);return+(i?i.value:r&&(i=e.config.style[r])&&i[n])}function tt(e,n,r,i){var a,o,l,u,s,d,f=e.text,c=e.orient||n.orient,p=e.anchor||n.anchor,g=c===En||c===$n?-1:1,h=c===$n||c===_n,m={group:h?"width":"height"},v={};return v.enter=a={opacity:{value:0}},Ee(a,"fill",n.color),Ee(a,"font",n.font),Ee(a,"fontSize",n.fontSize),Ee(a,"fontWeight",n.fontWeight),v.exit={opacity:{value:0}},v.update=o={opacity:{value:1},text:t.isObject(f)?f:{value:f+""},offset:$e((null!=e.offset?e.offset:n.offset)||0)},"start"===p?(s=0,d="left"):"end"===p?(s=1,d="right"):(s=.5,d="center"),l={field:m,mult:s},u=g<0?{value:0}:h?{field:{group:"height"}}:{field:{group:"width"}},h?(o.x=l,o.y=u,o.angle={value:0},o.baseline={value:c===$n?"bottom":"top"}):(o.x=u,o.y=l,o.angle={value:90*g},o.baseline={value:"bottom"}),o.align={value:d},o.limit={field:m},Ee(o,"angle",n.angle),Ee(o,"baseline",n.baseline),Ee(o,"limit",n.limit),Zn(tr,Qn,e.style||Wn,null,i,v,r)}function nt(e,t){var n=[];e.transform&&e.transform.forEach(function(e){n.push(dr(e,t))}),e.on&&e.on.forEach(function(n){hr(n,t,e.name)}),t.addDataPipeline(e.name,rt(e,t,n))}function rt(e,n,r){var i,a,o,l,u,s=[],d=null,f=!1,c=!1;for(e.values?s.push(d=it({$ingest:e.values,$format:e.format})):e.url?s.push(d=it({$request:e.url,$format:e.format})):e.source&&(d=i=t.array(e.source).map(function(e){return K(n.getData(e).output)}),s.push(null)),a=0,o=r.length;a<o;++a)u=(l=r[a]).metadata,d||u.source||s.push(d=it()),s.push(l),u.generates&&(c=!0),u.modifies&&!c&&(f=!0),u.source?d=l:u.changes&&(d=null);return i&&(o=i.length-1,s[0]=yn({derive:f,pulse:o?i:i[0]}),(f||o)&&s.splice(1,0,it())),d||s.push(it()),s.push(kn({})),s}function it(e){var t=tn({},e);return t.metadata={source:!0},t}function at(e,t){return{scale:e.scale,range:t}}function ot(e,t,n,r,i){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+r+","+i+")"}}function lt(e,n){var r,i,a,o,l,u=n.config;return n.background=e.background||u.background,n.eventConfig=u.events,l=K(n.root=n.add(J())),n.addSignal("width",e.width||0),n.addSignal("height",e.height||0),n.addSignal("padding",ht(e.padding,u)),n.addSignal("autosize",gt(e.autosize,u)),t.array(e.signals).forEach(function(e){Pr[e.name]||vt(e,n)}),i=n.add(tn()),a=_e({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},e.encode),a=n.add(an(Fe(a,er,Kn,e.style,n,{pulse:K(i)}))),o=n.add(Rn({layout:n.objectProperty(e.layout),legendMargin:u.legendMargin,autosize:n.signalRef("autosize"),mark:l,pulse:K(a)})),n.operators.pop(),n.pushState(K(a),K(o),null),zr(e,n,!0),n.operators.push(o),r=n.add(en({mark:l,pulse:K(o)})),r=n.add(bn({pulse:K(r)})),r=n.add(kn({pulse:K(r)})),n.addData("root",new Ye(n,i,i,r)),n}function ut(e){this.config=e,this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.background=null,this.eventConfig=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function st(e){this.config=e.config,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}function dt(e){return(t.isArray(e)?ft:ct)(e)}function ft(e){for(var n,r="[",i=0,a=e.length;i<a;++i)n=e[i],r+=(i>0?",":"")+(t.isObject(n)?n.signal||dt(n):t.stringValue(n));return r+"]"}function ct(e){var n,r,i="{",a=0;for(n in e)r=e[n],i+=(++a>1?",":"")+t.stringValue(n)+":"+(t.isObject(r)?r.signal||dt(r):t.stringValue(r));return i+"}"}function pt(){return{padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:Fr},area:{fill:Fr},image:null,line:{stroke:Fr,strokeWidth:_r},path:{stroke:Fr},rect:{fill:Fr},rule:{stroke:Vr},shape:{stroke:Fr},symbol:{fill:Fr,size:64},text:{fill:Vr,font:$r,fontSize:11},style:{"guide-label":{fill:Vr,font:$r,fontSize:10},"guide-title":{fill:Vr,font:$r,fontSize:11,fontWeight:"bold"},"group-title":{fill:Vr,font:$r,fontSize:13,fontWeight:"bold"},point:{size:Er,strokeWidth:_r,shape:"circle"},circle:{size:Er,strokeWidth:_r},square:{size:Er,strokeWidth:_r,shape:"square"},cell:{fill:"transparent",stroke:Ar}},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:Wr,grid:!1,gridWidth:1,gridColor:Ar,gridOpacity:1,labels:!0,labelAngle:0,labelLimit:180,labelPadding:2,ticks:!0,tickColor:Wr,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titleAlign:"center",titlePadding:4},axisBand:{tickOffset:-1},legend:{orient:"right",offset:18,padding:0,entryPadding:5,titlePadding:5,gradientWidth:100,gradientHeight:20,gradientStrokeColor:Ar,gradientStrokeWidth:0,gradientLabelBaseline:"top",gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelOffset:8,labelLimit:160,symbolType:"circle",symbolSize:100,symbolFillColor:"transparent",symbolStrokeColor:Wr,symbolStrokeWidth:1.5,titleAlign:"left",titleBaseline:"top",titleLimit:180},title:{orient:"top",anchor:"middle",offset:4},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues",extent:[.2,1]},heatmap:{scheme:"viridis"},ramp:{scheme:"blues",extent:[.2,1]},diverging:{scheme:"blueorange"},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}}}var gt=function(e,n){return e=e||n.autosize,t.isObject(e)?e:(e=e||"pad",{type:e})},ht=function(e,n){return e=e||n.padding,t.isObject(e)?{top:c(e.top),bottom:c(e.bottom),left:c(e.left),right:c(e.right)}:p(c(e))},mt=["value","update","react","bind"],vt=function(e,t){var n=e.name;if("outer"===e.push)t.signals[n]||g("No prior signal definition",n),mt.forEach(function(t){void 0!==e[t]&&g("Invalid property ",t)});else{var r=t.addSignal(n,e.value);!1===e.react&&(r.react=!1),e.bind&&t.addBinding(n,e.bind)}},yt={},bt=new Date(2e3,0,1),xt="undefined"!=typeof window&&window||null,kt="Literal",St="Identifier",Rt="@",wt="%",Ot=":",zt=S("area"),Pt=S("bounds"),jt=S("centroid"),Dt={},$t=function(e,t,n,r){var i,a=t[0],o=t[t.length-1];return a>o&&(i=a,a=o,o=i),n=void 0===n||n,r=void 0===r||r,(n?a<=e:a<e)&&(r?e<=o:e<o)},Et="bin_",_t="intersect",Ft="union",Vt="index:unit",Wt={random:function(){return i.random()},isArray:t.isArray,isBoolean:t.isBoolean,isDate:t.isDate,isNumber:t.isNumber,isObject:t.isObject,isRegExp:t.isRegExp,isString:t.isString,isTuple:n.isTuple,toBoolean:t.toBoolean,toDate:t.toDate,toNumber:t.toNumber,toString:t.toString,pad:t.pad,peek:t.peek,truncate:t.truncate,rgb:a.rgb,lab:a.lab,hcl:a.hcl,hsl:a.hsl,sequence:o.range,format:function(e,t){return h("format",l.format,t)(e)},utcFormat:function(e,t){return h("utcFormat",u.utcFormat,t)(e)},utcParse:function(e,t){return h("utcParse",u.utcParse,t)(e)},timeFormat:m,timeParse:function(e,t){return h("timeParse",u.timeParse,t)(e)},monthFormat:function(e){return v(e,1,"%B")},monthAbbrevFormat:function(e){return v(e,1,"%b")},dayFormat:function(e){return v(0,2+e,"%A")},dayAbbrevFormat:function(e){return v(0,2+e,"%a")},quarter:function(e){return 1+~~(new Date(e).getMonth()/3)},utcquarter:function(e){return 1+~~(new Date(e).getUTCMonth()/3)},warn:function(){return y(this.context.dataflow,"warn",arguments)},info:function(){return y(this.context.dataflow,"info",arguments)},debug:function(){return y(this.context.dataflow,"debug",arguments)},inScope:function(e){var t=this.context.group,n=!1;if(t)for(;e;){if(e===t){n=!0;break}e=e.mark.group}return n},clampRange:function(e,t,n){var r,i=e[0],a=e[1];return a<i&&(r=a,a=i,i=r),(r=a-i)>=n-t?[t,n]:[Math.min(Math.max(i,t),n-r),Math.min(Math.max(a,r),n)]},pinchDistance:function(e){var t=e.touches,n=t[0].clientX-t[1].clientX,r=t[0].clientY-t[1].clientY;return Math.sqrt(n*n+r*r)},pinchAngle:function(e){var t=e.touches;return Math.atan2(t[0].clientY-t[1].clientY,t[0].clientX-t[1].clientX)},screen:function(){return xt?xt.screen:{}},containerSize:function(){var e=this.context.dataflow,t=e.container&&e.container();return t?[t.clientWidth,t.clientHeight]:[void 0,void 0]},windowSize:function(){return xt?[xt.innerWidth,xt.innerHeight]:[void 0,void 0]},span:function(e){return e[e.length-1]-e[0]||0},flush:function(e,n,r,i,a,o){var l=Math.abs(n-e[0]),u=Math.abs(t.peek(e)-n);return l<u&&l<=r?i:u<=r?a:o},bandspace:function(e,t,n){return s.bandSpace(e||0,t||0,n||0)},inrange:$t,setdata:function(e,n){var r=this.context.dataflow,i=this.context.data[e].input;return r.pulse(i,r.changeset().remove(t.truthy).insert(n)),1},panLinear:t.panLinear,panLog:t.panLog,panPow:t.panPow,zoomLinear:t.zoomLinear,zoomLog:t.zoomLog,zoomPow:t.zoomPow,encode:function(e,t,n){if(e){var r=this.context.dataflow,i=e.mark.source;r.pulse(i,r.changeset().encode(e,t))}return void 0!==n?n:e},modify:function(e,r,i,a,o,l){var u,s,d=this.context.dataflow,f=this.context.data[e],c=f.input,p=f.changes,g=d.stamp();if(!1===d._trigger||!(c.value.length||r||a))return 0;if((!p||p.stamp<g)&&(f.changes=p=d.changeset(),p.stamp=g,d.runAfter(function(){f.modified=!0,d.pulse(c,p).run()},!0)),i&&(u=!0===i?t.truthy:t.isArray(i)||n.isTuple(i)?i:D(i),p.remove(u)),r&&p.insert(r),a&&(u=D(a),c.value.some(u)?p.remove(u):p.insert(a)),o)for(s in l)p.modify(o,s,l[s]);return 1}},At=["view","item","group","xy","x","y"],Mt="event.vega.",Lt="this.",Ct={};q("bandwidth",function(e,t){var n=b(e,(t||this).context);return n&&n.bandwidth?n.bandwidth():0},k),q("copy",function(e,t){var n=b(e,(t||this).context);return n?n.copy():void 0},k),q("domain",function(e,t){var n=b(e,(t||this).context);return n?n.domain():[]},k),q("range",function(e,t){var n=b(e,(t||this).context);return n&&n.range?n.range():[]},k),q("invert",function(e,n,r){var i=b(e,(r||this).context);return i?t.isArray(n)?(i.invertRange||i.invert)(n):(i.invert||i.invertExtent)(n):void 0},k),q("scale",function(e,t,n){var r=b(e,(n||this).context);return r?r(t):void 0},k),q("gradient",function(e,t,n,r){var i=d.Gradient(t,n),a=e.domain(),o=a[0],l=a[a.length-1],u=s.scaleFraction(e,o,l);e.ticks&&(o!==(a=e.ticks(+r||15))[0]&&a.unshift(o),l!==a[a.length-1]&&a.push(l));for(var f=0,c=a.length;f<c;++f)i.stop(u(a[f]),e(a[f]));return i},k),q("geoArea",zt,k),q("geoBounds",Pt,k),q("geoCentroid",jt,k),q("indata",function(e,t,n){var r=this.context.data[e]["index:"+t],i=r?r.value.get(n):void 0;return i?i.count:i},function(e,n,r,i){n[0].type!==kt&&t.error("First argument to indata must be a string literal."),n[1].type!==kt&&t.error("Second argument to indata must be a string literal.");var a=n[0].value,o=n[1].value,l=Rt+o;i.hasOwnProperty(l)||(i[l]=r.getData(a).indataRef(r,o))}),q("data",R,w),q("vlSingle",F,w),q("vlSingleDomain",W,w),q("vlMulti",F,V),q("vlMultiDomain",W,V),q("vlInterval",function(e,t,n){return _.call(this,e,t,n,E)},w),q("vlIntervalDomain",function(e,t,n,r){var i,a,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=d[0],c=0;if(f){for(i=f.intervals.length;c<i;++c)if(a=f.intervals[c],t&&a.encoding===t||n&&a.field===n){if(!a.extent)return;o=c,u=a.extent.length>2;break}return l=d.reduce(function(e,t){var n=t.intervals[o].extent,r=u?n.map(function(e){return{unit:t.unit,value:e}}):{unit:t.unit,value:n};return u?e.push.apply(e,r):e.push(r),e},[]),u?A(l,r):M(l,r)}},w),q("treePath",function(e,t,n){var r=z(e,this),i=r[t],a=r[n];return i&&a?i.path(a).map(O):void 0},w),q("treeAncestors",function(e,t){var n=z(e,this)[t];return n?n.ancestors().map(O):void 0},w);var qt={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(e){return"_["+t.stringValue("$"+e)+"]"},functions:function(e){var t=r.functions(e);At.forEach(function(e){t[e]=Mt+e});for(var n in Wt)t[n]=Lt+n;return t},constants:r.constants,visitors:Ct},Bt=r.codegen(qt),Nt=function(e,n,i){var a,o,l={};try{a=r.parse(e)}catch(n){t.error("Expression parse error: "+t.stringValue(e))}return a.visit(function(e){if("CallExpression"===e.type){var t=e.callee.name,r=qt.visitors[t];r&&r(t,e.arguments,n,l)}}),(o=Bt(a)).globals.forEach(function(e){var t="$"+e;!l.hasOwnProperty(t)&&n.getSignal(e)&&(l[t]=n.signalRef(e))}),{$expr:i?i+"return("+o.code+");":o.code,$fields:o.fields,$params:l}},Ut="view",Tt="scope",It=function(e,t){return e.signal?t.getSignal(e.signal).id:e.scale?t.getScale(e.scale).id:N(e,t)},Xt="var datum=event.item&&event.item.datum;",Ht=function(e,n,r){var i,a=e.events,o=e.update,l=e.encode,u=[],s="";a||t.error("Signal update missing events specification."),t.isString(a)&&(a=f.selector(a)),(a=t.array(a).filter(function(e){return e.signal||e.scale?(u.push(e),0):1})).length&&u.push(a.length>1?{merge:a}:a[0]),null!=l&&(o&&t.error("Signal encode and update are mutually exclusive."),o="encode(item(),"+t.stringValue(l)+")"),s=t.isString(o)?Nt(o,n,Xt):null!=o.expr?Nt(o.expr,n,Xt):null!=o.value?o.value:null!=o.signal?{$expr:"_.value",$params:{value:n.signalRef(o.signal)}}:t.error("Invalid signal update specification."),i={target:r,update:s},e.force&&(i.options={force:!0}),u.forEach(function(e){e={source:It(e,n)},n.addUpdate(t.extend(e,i))})},Yt=function(e,t){var n=t.getSignal(e.name);if(e.update){var r=Nt(e.update,t);n.update=r.$expr,n.params=r.$params}e.on&&e.on.forEach(function(e){Ht(e,t,n.id)})},Gt={$tupleid:1,toString:function(){return":_tupleid_:"}},Jt=Q("key"),Kt="descending",Qt=ae("aggregate"),Zt=ae("axisticks"),en=ae("bound"),tn=ae("collect"),nn=ae("compare"),rn=ae("datajoin"),an=ae("encode"),on=ae("facet"),ln=ae("field"),un=ae("key"),sn=ae("legendentries"),dn=ae("mark"),fn=ae("multiextent"),cn=ae("multivalues"),pn=ae("overlap"),gn=ae("params"),hn=ae("prefacet"),mn=ae("projection"),vn=ae("proxy"),yn=ae("relay"),bn=ae("render"),xn=ae("scale"),kn=ae("sieve"),Sn=ae("sortitems"),Rn=ae("viewlayout"),wn=ae("values"),On=0,zn=["identity","ordinal","band","point","bin-linear","bin-ordinal","linear","pow","sqrt","log","sequential","time","utc","quantize","quantile","threshold"],Pn=t.toSet(zn),jn=t.toSet(zn.slice(1,6)),Dn=function(e,t){var n={};for(var r in e)"name"!==r&&(n[r]=Oe(e[r],t));t.addProjection(e.name,n)},$n="top",En="left",_n="bottom",Fn="value",Vn="guide-label",Wn="group-title",An=["shape","size","fill","stroke","strokeDash","opacity"],Mn={name:1,interactive:1},Ln=t.toSet(["rule"]),Cn=t.toSet(["group","image","rect"]),qn=function(e,t){var n="";return Ln[t]?n:(e.x2&&(e.x?(Cn[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(Cn[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;"),n)},Bn=function(e,t,n,r){function i(e,i,a,o){return"this."+e+"("+[Hn(null,i,t,n,r),Hn(null,a,t,n,r),Hn(null,o,t,n,r)].join(",")+").toString()"}return e.c?i("hcl",e.h,e.c,e.l):e.h||e.s?i("hsl",e.h,e.s,e.l):e.l||e.a?i("lab",e.l,e.a,e.b):e.r||e.g||e.b?i("rgb",e.r,e.g,e.b):null},Nn=function(e,n,r,i){var a=Nt(e,n);return a.$fields.forEach(function(e){i[e]=1}),t.extend(r,a.$params),a.$expr},Un=function(e,n,r,i){return ze(t.isObject(e)?e:{datum:e},n,r,i)},Tn=function(e,t,n,r,i){var a,o,l,u=je(e.scale,n,r,i);return null!=e.range?(o=u+".range()",t=0===(a=+e.range)?o+"[0]":"($="+o+","+(1===a?"$[$.length-1]":"$[0]+"+a+"*($[$.length-1]-$[0])")+")"):(void 0!==t&&(t=u+"("+t+")"),e.band&&(l=Pe(e.scale,n))&&(a=(o=u+".bandwidth")+"()"+(1===(a=+e.band)?"":"*"+a),l<0&&(a="("+o+"?"+a+":0)"),t=(t?t+"+":"")+a,e.extra&&(t="(datum.extra?"+u+"(datum.extra.value):"+t+")")),null==t&&(t="0")),t},In=function(e,n,r,i){return"this.gradient("+je(e.gradient,n,r,i)+","+t.stringValue(e.start)+","+t.stringValue(e.stop)+","+t.stringValue(e.count)+")"},Xn=function(e,n,r,i){return t.isObject(e)?"("+Hn(null,e,n,r,i)+")":e},Hn=function(e,n,r,i,a){if(null!=n.gradient)return In(n,r,i,a);var o=n.signal?Nn(n.signal,r,i,a):n.color?Bn(n.color,r,i,a):null!=n.field?Un(n.field,r,i,a):void 0!==n.value?t.stringValue(n.value):void 0;return null!=n.scale&&(o=Tn(n,o,r,i,a)),void 0===o&&(o=null),null!=n.exponent&&(o="Math.pow("+o+","+Xn(n.exponent,r,i,a)+")"),null!=n.mult&&(o+="*"+Xn(n.mult,r,i,a)),null!=n.offset&&(o+="+"+Xn(n.offset,r,i,a)),n.round&&(o="Math.round("+o+")"),o},Yn=function(e,n,r){return e+"["+t.stringValue(n)+"]="+r+";"},Gn=function(e,t,n,r,i){var a="";return t.forEach(function(t){var o=Hn(e,t,n,r,i);a+=t.test?Nn(t.test,n,r,i)+"?"+o+":":o}),Yn("o",e,a)},Jn="mark",Kn="frame",Qn="title",Zn=function(e,t,n,r,i,a,o){return{type:e,name:o?o.name:void 0,role:t,style:o&&o.style||n,key:r,from:i,interactive:!(!o||!o.interactive),encode:_e(a,o,Mn)}},er="group",tr="text",nr=function(e,t,n,r){var i,a,o={value:0},l={};return l.enter=i={opacity:o,x:o,y:o},Ee(i,"width",n.gradientWidth),Ee(i,"height",n.gradientHeight),Ee(i,"stroke",n.gradientStrokeColor),Ee(i,"strokeWidth",n.gradientStrokeWidth),l.exit={opacity:o},l.update=a={x:o,y:o,fill:{gradient:t},opacity:{value:1}},Ee(a,"width",n.gradientWidth),Ee(a,"height",n.gradientHeight),Zn("rect","legend-gradient",null,void 0,void 0,l,r)},rr=function(e,t,n,r){var i,a,o={value:0},l={};return l.enter=i={opacity:o},Ee(i,"fill",t.labelColor),Ee(i,"font",t.labelFont),Ee(i,"fontSize",t.labelFontSize),Ee(i,"fontWeight",t.labelFontWeight),Ee(i,"baseline",t.gradientLabelBaseline),Ee(i,"limit",t.gradientLabelLimit),l.exit={opacity:o},l.update=a={opacity:{value:1},text:{field:"label"}},i.x=a.x={field:"perc",mult:t.gradientWidth},i.y=a.y={value:t.gradientHeight,offset:t.gradientLabelOffset},i.align=a.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},Zn(tr,"legend-label",Vn,"perc",r,l,n)},ir=function(e,t,n,r){var i,a,o={value:0},l={};return l.enter=i={opacity:o},Ee(i,"align",t.labelAlign),Ee(i,"baseline",t.labelBaseline),Ee(i,"fill",t.labelColor),Ee(i,"font",t.labelFont),Ee(i,"fontSize",t.labelFontSize),Ee(i,"fontWeight",t.labelFontWeight),Ee(i,"limit",t.labelLimit),l.exit={opacity:o},l.update=a={opacity:{value:1},text:{field:"label"}},i.x=a.x={field:"offset",offset:t.labelOffset},i.y=a.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Zn(tr,"legend-label",Vn,Fn,r,l,n)},ar=function(e,t,n,r){var i,a,o={value:0},l={};return l.enter=i={opacity:o},Ee(i,"shape",t.symbolType),Ee(i,"size",t.symbolSize),Ee(i,"strokeWidth",t.symbolStrokeWidth),e.fill||(Ee(i,"fill",t.symbolFillColor),Ee(i,"stroke",t.symbolStrokeColor)),l.exit={opacity:o},l.update=a={opacity:{value:1}},i.x=a.x={field:"offset",mult:.5},i.y=a.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},An.forEach(function(t){e[t]&&(a[t]=i[t]={scale:e[t],field:Fn})}),Zn("symbol","legend-symbol",null,Fn,r,l,n)},or=function(e,t,n,r){var i,a={value:0},o=e.title,l={};return l.enter=i={x:{field:{group:"padding"}},y:{field:{group:"padding"}},opacity:a},Ee(i,"align",t.titleAlign),Ee(i,"baseline",t.titleBaseline),Ee(i,"fill",t.titleColor),Ee(i,"font",t.titleFont),Ee(i,"fontSize",t.titleFontSize),Ee(i,"fontWeight",t.titleFontWeight),Ee(i,"limit",t.titleLimit),l.exit={opacity:a},l.update={opacity:{value:1},text:o&&o.signal?{signal:o.signal}:{value:o+""}},Zn(tr,"legend-title","guide-title",null,r,l,n)},lr=function(e,t,n,r,i,a,o){return{type:er,name:n,role:e,style:t,from:r,interactive:i,encode:a,marks:o}},ur=function(e){var t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")?e.type===er?"scope":t||Jn:t},sr=function(e){return{clip:e.clip||!1,interactive:!1!==e.interactive,marktype:e.type,name:e.name||void 0,role:e.role||ur(e),zindex:+e.zindex||void 0}},dr=function(e,r){var i=n.definition(e.type);i||t.error("Unrecognized transform type: "+t.stringValue(e.type));var a=G(i.type.toLowerCase(),null,Ae(i,e,r));return e.signal&&r.addSignal(e.signal,r.proxy(a)),a.metadata=i.metadata||{},a},fr=function(e,n,r){var i,a,o,l,u;return e?(i=e.facet)&&(n||t.error("Only group marks can be faceted."),null!=i.field?l=u=K(r.getData(i.data).output):(e.data?u=K(r.getData(e.data).aggregate):((o=dr(t.extend({type:"aggregate",groupby:t.array(i.groupby)},i.aggregate),r)).params.key=r.keyRef(i.groupby),o.params.pulse=K(r.getData(i.data).output),l=u=K(r.add(o))),a=r.keyRef(i.groupby,!0))):l=K(r.add(tn(null,[{}]))),l||(l=e.$ref?e:K(r.getData(e.data).output)),{key:a,pulse:l,parent:u}};Ye.fromEntries=function(e,t){var n=t.length,r=1,i=t[0],a=t[n-1],o=t[n-2],l=null;for(e.add(t[0]);r<n;++r)t[r].params.pulse=K(t[r-1]),e.add(t[r]),"aggregate"===t[r].type&&(l=t[r]);return new Ye(e,i,o,a,l)};var cr=Ye.prototype;cr.countsRef=function(e,t,n){var r,i,a,o=this,l=o.counts||(o.counts={}),u=Ge(t);return null!=u&&(e=o.scope,r=l[u]),r?n&&n.field&&Je(e,r.agg.params,n):(a={groupby:e.fieldRef(t,"key"),pulse:K(o.output)},n&&n.field&&Je(e,a,n),r={agg:i=e.add(Qt(a)),ref:K(r=e.add(tn({pulse:K(i)})))},null!=u&&(l[u]=r)),r.ref},cr.tuplesRef=function(){return K(this.values)},cr.extentRef=function(e,t){return Ke(e,this,"extent","extent",t,!1)},cr.domainRef=function(e,t){return Ke(e,this,"domain","values",t,!1)},cr.valuesRef=function(e,t,n){return Ke(e,this,"vals","values",t,n||!0)},cr.lookupRef=function(e,t){return Ke(e,this,"lookup","tupleindex",t,!1)},cr.indataRef=function(e,t){return Ke(e,this,"indata","tupleindex",t,!0,!0)};var pr=function(e,n,r){var i,a,o,l,u=e.from.facet,s=u.name,d=K(n.getData(u.data).output);u.name||t.error("Facet must have a name: "+t.stringValue(u)),u.data||t.error("Facet must reference a data set: "+t.stringValue(u)),u.field?l=n.add(hn({field:n.fieldRef(u.field),pulse:d})):u.groupby?l=n.add(on({key:n.keyRef(u.groupby),group:K(n.proxy(r.parent)),pulse:d})):t.error("Facet must specify groupby or field: "+t.stringValue(u)),a=(i=n.fork()).add(tn()),o=i.add(kn({pulse:K(a)})),i.addData(s,new Ye(i,a,a,o)),i.addSignal("parent",null),l.params.subflow={$subflow:zr(e,i).toRuntime()}},gr=function(e,t,n){var r=t.add(hn({pulse:n.pulse})),i=t.fork();i.add(kn()),i.addSignal("parent",null),r.params.subflow={$subflow:zr(e,i).toRuntime()}},hr=function(e,t,n){var r,i,a=e.remove,o=e.insert,l=e.toggle,u=e.modify,s=e.values,d=t.add(J());r="if("+e.trigger+',modify("'+n+'",'+[o,a,l,u,s].map(function(e){return null==e?"null":e}).join(",")+"),0)",i=Nt(r,t),d.update=i.$expr,d.params=i.$params},mr=function(e,n){var r,i,a,o,l,u,s,d,f,c,p,g,h,m=ur(e),v=e.type===er,y=e.from&&e.from.facet,b=e.layout||"scope"===m||m===Kn,x=m===Jn||b||y,k=e.overlap;a=fr(e.from,v,n),f=K(i=n.add(rn({key:a.key||(e.key?Q(e.key):void 0),pulse:a.pulse,clean:!v}))),i=o=n.add(tn({pulse:f})),c=K(i=n.add(dn({markdef:sr(e),context:{$context:!0},groups:n.lookup(),parent:n.signals.parent?n.signalRef("parent"):null,index:n.markpath(),pulse:K(i)}))),(i=n.add(an(Fe(e.encode,e.type,m,e.style,n,{pulse:c})))).params.parent=n.encode(),e.transform&&e.transform.forEach(function(e){var r=dr(e,n);(r.metadata.generates||r.metadata.changes)&&t.error("Mark transforms should not generate new data."),r.params.pulse=K(i),n.add(i=r)}),e.sort&&(i=n.add(Sn({sort:n.compareRef(e.sort),pulse:K(i)}))),p=K(i),(y||b)&&(g=K(b=n.add(Rn({layout:n.objectProperty(e.layout),legendMargin:n.config.legendMargin,mark:c,pulse:p})))),h=K(l=n.add(en({mark:c,pulse:g||p}))),v&&(x&&((r=n.operators).pop(),b&&r.pop()),n.pushState(p,g||h,f),y?pr(e,n,a):x?gr(e,n,a):zr(e,n),n.popState(),x&&(b&&r.push(b),r.push(l))),k&&(i={method:!0===k.method?"parity":k.method,pulse:h},k.order&&(i.sort=n.compareRef({field:k.order})),k.bound&&(i.boundScale=n.scaleRef(k.bound.scale),i.boundOrient=k.bound.orient,i.boundTolerance=k.bound.tolerance),h=K(n.add(pn(i)))),u=n.add(bn({pulse:h})),s=n.add(kn({pulse:K(u)},void 0,n.parent())),null!=e.name&&(d=e.name,n.addData(d,new Ye(n,o,u,s)),e.on&&e.on.forEach(function(e){(e.insert||e.remove||e.toggle)&&t.error("Marks only support modify triggers."),hr(e,n,d)}))},vr=function(e,n){var r,i,a,o,l,u,s,d,f=e.type||"symbol",c=n.config.legend,p=e.encode||{},g=p.legend||{},h=g.name||void 0,m=!!g.interactive,v=g.style,y=e.size||e.shape||e.fill||e.stroke||e.strokeDash||e.opacity;return y||t.error("Missing valid scale for legend."),r={orient:ie(e.orient,c.orient),title:null!=e.title},i=K(n.add(tn(null,[r]))),g=_e({enter:Ze(c),update:{offset:$e(ie(e.offset,c.offset)),padding:$e(ie(e.padding,c.padding)),titlePadding:$e(ie(e.titlePadding,c.titlePadding))}},g,Mn),u={update:{x:{field:{group:"padding"}},y:{field:{group:"padding"}},entryPadding:$e(ie(e.entryPadding,c.entryPadding))}},"gradient"===f?(a=K(n.add(sn({type:"gradient",scale:n.scaleRef(y),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[nr(0,y,c,p.gradient),rr(0,c,p.labels,a)]):(a=K(n.add(sn(s={scale:n.scaleRef(y),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[ar(e,c,p.symbols,a),ir(0,c,p.labels,a)],s.size=Qe(e,n,d)),d=[lr("legend-entry",null,null,i,m,u,d)],r.title&&(l=or(e,c,p.title,i),u.update.y.offset={field:{group:"titlePadding"},offset:et(n,l.encode,"fontSize","guide-title")},d.push(l)),o=lr("legend",v,h,i,m,g,d),e.zindex&&(o.zindex=e.zindex),mr(o,n)},yr=function(e,n){e=t.isString(e)?{text:e}:e;var r,i,a,o=n.config.title,l=t.extend({},e.encode);return r={orient:null!=e.orient?e.orient:o.orient},i=K(n.add(tn(null,[r]))),l.name=e.name,l.interactive=e.interactive,a=tt(e,o,l,i),e.zindex&&(a.zindex=e.zindex),mr(a,n)},br=function(e,n){var r=n.config,i=e.orient,a=i===$n||i===_n?r.axisX:r.axisY,o=r["axis"+i[0].toUpperCase()+i.slice(1)],l="band"===n.scaleType(e.scale)&&r.axisBand;return a||o||l?t.extend({},r.axis,a,o,l):r.axis},xr=function(e,t,n,r){var i,a,o,l,u,s=e.orient,d={value:0},f={};return f.enter=i={opacity:d},Ee(i,"stroke",t.domainColor),Ee(i,"strokeWidth",t.domainWidth),f.exit={opacity:d},f.update=a={opacity:{value:1}},s===$n||s===_n?(o="x",u="y"):(o="y",u="x"),l=o+"2",i[u]=d,a[o]=i[o]=at(e,0),a[l]=i[l]=at(e,1),Zn("rule","axis-domain",null,null,r,f,n)},kr=function(e,t,n,r){var i,a,o,l,u,s,d,f,c=e.orient,p=e.gridScale,g=c===En||c===$n?1:-1,h=g*e.offset||0,m={value:0},v={};return v.enter=i={opacity:m},Ee(i,"stroke",t.gridColor),Ee(i,"strokeWidth",t.gridWidth),Ee(i,"strokeDash",t.gridDash),v.exit=a={opacity:m},v.update=o={},Ee(o,"opacity",t.gridOpacity),l={scale:e.scale,field:Fn,band:t.bandPosition,round:t.tickRound,extra:t.tickExtra,offset:t.tickOffset},c===$n||c===_n?(u="x",s="y",f="height"):(u="y",s="x",f="width"),d=s+"2",o[u]=i[u]=a[u]=l,p?(i[s]={scale:p,range:0,mult:g,offset:h},o[d]=i[d]={scale:p,range:1,mult:g,offset:h}):(i[s]={value:h},o[d]=i[d]={signal:f,mult:g,offset:h}),Zn("rule","axis-grid",null,Fn,r,v,n)},Sr=function(e,t,n,r,i){var a,o,l,u,s,d=e.orient,f=d===En||d===$n?-1:1,c={value:0},p={};return p.enter=a={opacity:c},Ee(a,"stroke",t.tickColor),Ee(a,"strokeWidth",t.tickWidth),p.exit=o={opacity:c},p.update=l={opacity:{value:1}},u=$e(i),u.mult=f,s={scale:e.scale,field:Fn,band:t.bandPosition,round:t.tickRound,extra:t.tickExtra,offset:t.tickOffset},d===$n||d===_n?(l.y=a.y=c,l.y2=a.y2=u,l.x=a.x=o.x=s):(l.x=a.x=c,l.x2=a.x2=u,l.y=a.y=o.y=s),Zn("rule","axis-tick",null,Fn,r,p,n)},Rr=function(e,t,n,r,i){var a,o,l,u,s,d=e.orient,f=d===En||d===$n?-1:1,c=e.scale,p=ie(e.labelPadding,t.labelPadding),g=ie(e.labelBound,t.labelBound),h=ie(e.labelFlush,t.labelFlush),m=null!=h&&!1!==h&&(h=+h)===h,v=+ie(e.labelFlushOffset,t.labelFlushOffset),y=ie(e.labelOverlap,t.labelOverlap),b={value:0},x={};return x.enter=a={opacity:b},Ee(a,"angle",t.labelAngle),Ee(a,"fill",t.labelColor),Ee(a,"font",t.labelFont),Ee(a,"fontSize",t.labelFontSize),Ee(a,"fontWeight",t.labelFontWeight),Ee(a,"limit",t.labelLimit),x.exit=o={opacity:b},x.update=l={opacity:{value:1},text:{field:"label"}},u=$e(i),u.mult=f,u.offset=$e(p),u.offset.mult=f,s={scale:c,field:Fn,band:.5,offset:t.tickOffset},d===$n||d===_n?(l.y=a.y=u,l.x=a.x=o.x=s,Ee(l,"align",m?ot(c,h,'"left"','"right"','"center"'):"center"),m&&v&&Ee(l,"dx",ot(c,h,-v,v,0)),Ee(l,"baseline",d===$n?"bottom":"top")):(l.x=a.x=u,l.y=a.y=o.y=s,Ee(l,"align","right"===d?"left":"right"),Ee(l,"baseline",m?ot(c,h,'"bottom"','"top"','"middle"'):"middle"),m&&v&&Ee(l,"dy",ot(c,h,v,-v,0))),e=Zn(tr,"axis-label",Vn,Fn,r,x,n),(y||g)&&(e.overlap={method:y,order:"datum.index",bound:g?{scale:c,orient:d,tolerance:+g}:null}),e},wr=function(e,t,n,r){var i,a,o,l=e.orient,u=e.title,s=l===En||l===$n?-1:1,d=l===$n||l===_n,f={};return f.enter=i={opacity:{value:0}},Ee(i,"align",t.titleAlign),Ee(i,"fill",t.titleColor),Ee(i,"font",t.titleFont),Ee(i,"fontSize",t.titleFontSize),Ee(i,"fontWeight",t.titleFontWeight),Ee(i,"limit",t.titleLimit),f.exit={opacity:{value:0}},f.update=a={opacity:{value:1},text:u&&u.signal?{signal:u.signal}:{value:u+""}},o={scale:e.scale,range:.5},d?(a.x=o,a.angle={value:0},a.baseline={value:l===$n?"bottom":"top"}):(a.y=o,a.angle={value:90*s},a.baseline={value:"bottom"}),Ee(a,"angle",t.titleAngle),Ee(a,"baseline",t.titleBaseline),!Ee(a,"x",t.titleX)&&d&&!We("x",n)&&(f.enter.auto={value:!0}),!Ee(a,"y",t.titleY)&&!d&&!We("y",n)&&(f.enter.auto={value:!0}),Zn(tr,"axis-title","guide-title",null,r,f,n)},Or=function(e,t){var n,r,i,a,o,l,u=br(e,t),s=e.encode||{},d=s.axis||{},f=d.name||void 0,c=!!d.interactive,p=d.style;return n={orient:e.orient,ticks:!!ie(e.ticks,u.ticks),labels:!!ie(e.labels,u.labels),grid:!!ie(e.grid,u.grid),domain:!!ie(e.domain,u.domain),title:!!ie(e.title,!1)},r=K(t.add(tn({},[n]))),d=_e({update:{range:{signal:'abs(span(range("'+e.scale+'")))'},offset:$e(ie(e.offset,0)),position:$e(ie(e.position,0)),titlePadding:$e(ie(e.titlePadding,u.titlePadding)),minExtent:$e(ie(e.minExtent,u.minExtent)),maxExtent:$e(ie(e.maxExtent,u.maxExtent))}},s.axis,Mn),i=K(t.add(Zt({scale:t.scaleRef(e.scale),extra:u.tickExtra,count:t.objectProperty(e.tickCount),values:t.objectProperty(e.values),formatSpecifier:t.property(e.format)}))),l=[],n.grid&&l.push(kr(e,u,s.grid,i)),n.ticks&&(a=ie(e.tickSize,u.tickSize),l.push(Sr(e,u,s.ticks,i,a))),n.labels&&(a=n.ticks?a:0,l.push(Rr(e,u,s.labels,i,a))),n.domain&&l.push(xr(e,u,s.domain,r)),n.title&&l.push(wr(e,u,s.title,r)),o=lr("axis",p,f,r,c,d,l),e.zindex&&(o.zindex=e.zindex),mr(o,t)},zr=function(e,n,r){var i=t.array(e.signals),a=t.array(e.scales);return r||i.forEach(function(e){vt(e,n)}),t.array(e.projections).forEach(function(e){Dn(e,n)}),a.forEach(function(e){ue(e,n)}),t.array(e.data).forEach(function(e){nt(e,n)}),a.forEach(function(e){se(e,n)}),i.forEach(function(e){Yt(e,n)}),t.array(e.axes).forEach(function(e){Or(e,n)}),t.array(e.marks).forEach(function(e){mr(e,n)}),t.array(e.legends).forEach(function(e){vr(e,n)}),e.title&&yr(e.title,n),n.parseLambdas(),n},Pr=t.toSet(["width","height","padding","autosize"]),jr=ut.prototype=st.prototype;jr.fork=function(){return new st(this)},jr.toRuntime=function(){return this.finish(),{background:this.background,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig}},jr.id=function(){return(this._subid?this._subid+":":0)+this._id++},jr.add=function(e){return this.operators.push(e),e.id=this.id(),e.refs&&(e.refs.forEach(function(t){t.$ref=e.id}),e.refs=null),e},jr.proxy=function(e){var t=e instanceof Y?K(e):e;return this.add(vn({value:t}))},jr.addStream=function(e){return this.streams.push(e),e.id=this.id(),e},jr.addUpdate=function(e){return this.updates.push(e),e},jr.finish=function(){function e(e,t,n){var r;e&&((r=e.data||(e.data={}))[t]||(r[t]=[])).push(n)}var t,n;this.root&&(this.root.root=!0);for(t in this.signals)this.signals[t].signal=t;for(t in this.scales)this.scales[t].scale=t;for(t in this.data){e((n=this.data[t]).input,t,"input"),e(n.output,t,"output"),e(n.values,t,"values");for(var r in n.index)e(n.index[r],t,"index:"+r)}return this},jr.pushState=function(e,t,n){this._encode.push(K(this.add(kn({pulse:e})))),this._parent.push(t),this._lookup.push(n?K(this.proxy(n)):null),this._markpath.push(-1)},jr.popState=function(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},jr.parent=function(){return t.peek(this._parent)},jr.encode=function(){return t.peek(this._encode)},jr.lookup=function(){return t.peek(this._lookup)},jr.markpath=function(){var e=this._markpath;return++e[e.length-1]},jr.fieldRef=function(e,n){if(t.isString(e))return Q(e,n);e.signal||t.error("Unsupported field reference: "+t.stringValue(e));var r,i=e.signal,a=this.field[i];return a||(r={name:this.signalRef(i)},n&&(r.as=n),this.field[i]=a=K(this.add(ln(r)))),a},jr.compareRef=function(e){function n(e){return re(e)?(i=!0,K(r[e.signal])):e}var r=this.signals,i=!1,a=t.array(e.field).map(n),o=t.array(e.order).map(n);return i?K(this.add(nn({fields:a,orders:o}))):Z(a,o)},jr.keyRef=function(e,n){var r=this.signals,i=!1;return e=t.array(e).map(function(e){return re(e)?(i=!0,K(r[e.signal])):e}),i?K(this.add(un({fields:e,flat:n}))):ee(e,n)},jr.sortRef=function(e){if(!e)return e;var t=[ne(e.op,e.field),Gt],n=e.order||"ascending";return n.signal?K(this.add(nn({fields:t,orders:[n=this.signalRef(n.signal),n]}))):Z(t,[n,n])},jr.event=function(e,t){var n=e+":"+t;if(!this.events[n]){var r=this.id();this.streams.push({id:r,source:e,type:t}),this.events[n]=r}return this.events[n]},jr.addSignal=function(e,n){this.signals.hasOwnProperty(e)&&t.error("Duplicate signal name: "+t.stringValue(e));var r=n instanceof Y?n:this.add(J(n));return this.signals[e]=r},jr.getSignal=function(e){return this.signals[e]||t.error("Unrecognized signal name: "+t.stringValue(e)),this.signals[e]},jr.signalRef=function(e){return this.signals[e]?K(this.signals[e]):(this.lambdas.hasOwnProperty(e)||(this.lambdas[e]=this.add(J(null))),K(this.lambdas[e]))},jr.parseLambdas=function(){for(var e=Object.keys(this.lambdas),t=0,n=e.length;t<n;++t){var r=e[t],i=Nt(r,this),a=this.lambdas[r];a.params=i.$params,a.update=i.$expr}},jr.property=function(e){return e&&e.signal?this.signalRef(e.signal):e},jr.objectProperty=function(e){return e&&t.isObject(e)?this.signalRef(e.signal||dt(e)):e},jr.addBinding=function(e,n){this.bindings||t.error("Nested signals do not support binding: "+t.stringValue(e)),this.bindings.push(t.extend({signal:e},n))},jr.addScaleProj=function(e,n){this.scales.hasOwnProperty(e)&&t.error("Duplicate scale or projection name: "+t.stringValue(e)),this.scales[e]=this.add(n)},jr.addScale=function(e,t){this.addScaleProj(e,xn(t))},jr.addProjection=function(e,t){this.addScaleProj(e,mn(t))},jr.getScale=function(e){return this.scales[e]||t.error("Unrecognized scale name: "+t.stringValue(e)),this.scales[e]},jr.projectionRef=jr.scaleRef=function(e){return K(this.getScale(e))},jr.projectionType=jr.scaleType=function(e){return this.getScale(e).params.type},jr.addData=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.data[e]=n},jr.getData=function(e){return this.data[e]||t.error("Undefined data set name: "+t.stringValue(e)),this.data[e]},jr.addDataPipeline=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.addData(e,Ye.fromEntries(this,n))};var Dr=function(e){var n=pt();return(e||[]).forEach(function(e){var r,i,a;if(e)for(r in e)if("style"===r){a=n.style||(n.style={});for(r in e.style)a[r]=t.extend(a[r]||{},e.style[r])}else i=e[r],n[r]=t.isObject(i)&&!t.isArray(i)?t.extend(t.isObject(n[r])?n[r]:{},i):i}),n},$r="sans-serif",Er=30,_r=2,Fr="#4c78a8",Vr="#000",Wr="#888",Ar="#ddd";e.parse=function(e,n){return t.isObject(e)||t.error("Input Vega specification must be an object."),lt(e,new ut(Dr([n,e.config]))).toRuntime()},e.config=Dr,e.signal=vt,e.signalUpdates=Yt,e.stream=It,e.codeGenerator=Bt,e.functionContext=Wt,e.expressionFunction=q,e.MarkRole=Jn,e.FrameRole=Kn,e.ScopeRole="scope",e.AxisRole="axis",e.AxisDomainRole="axis-domain",e.AxisGridRole="axis-grid",e.AxisLabelRole="axis-label",e.AxisTickRole="axis-tick",e.AxisTitleRole="axis-title",e.LegendRole="legend",e.LegendEntryRole="legend-entry",e.LegendLabelRole="legend-label",e.LegendSymbolRole="legend-symbol",e.LegendTitleRole="legend-title",e.Scope=ut,e.DataScope=Ye,e.formatLocale=l.formatDefaultLocale,e.timeFormatLocale=u.timeFormatDefaultLocale,Object.defineProperty(e,"__esModule",{value:!0})});