!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-util"),require("vega-dataflow"),require("vega-statistics"),require("d3-array")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-statistics","d3-array"],e):e((t.vega=t.vega||{},t.vega.transforms=t.vega.transforms||{}),t.vega,t.vega,t.vega,t.d3)}(this,function(t,e,i,n,r){"use strict";function a(t){return function(e){for(var i=t.length,n=1,r=String(t[0](e));n<i;++n)r+="|"+t[n](e);return r}}function s(t){return t&&t.length?1===t.length?t[0]:a(t):function(){return""}}function u(t,e,i){return i||t+(e?"_"+e:"")}function o(t,e){return ht[t](e)}function l(t){return function(i){var n=e.extend({init:"",add:"",rem:"",idx:0},t);return n.out=i||t.name,n}}function f(t,e){return t.idx-e.idx}function d(t,e){function i(t,n){function r(e){t[e]||i(t,t[e]=ht[e]())}return n.req&&n.req.forEach(r),e&&n.str&&n.str.forEach(r),t}var n,r=t.reduce(i,t.reduce(function(t,e){return t[e.name]=e,t},{})),a=[];for(n in r)a.push(r[n]);return a.sort(f)}function m(t,i){var n=i||e.identity,r="var cell = this.cell; this.valid = 0; this.missing = 0;",a="this.cell = cell; this.init();",s="if(v==null){++this.missing; return;} if(v!==v) return; ++this.valid;",u="if(v==null){--this.missing; return;} if(v!==v) return; --this.valid;",o="var cell = this.cell;";return d(t,!0).forEach(function(t){r+=t.init,s+=t.add,u+=t.rem}),t.slice().sort(f).forEach(function(t){o+="t['"+t.out+"']="+t.set+";"}),o+="return t;",a=Function("cell",a),a.prototype.init=Function(r),a.prototype.add=Function("v","t",s),a.prototype.rem=Function("v","t",u),a.prototype.set=Function("t",o),a.prototype.get=n,a.fields=t.map(function(t){return t.out}),a}function h(t){this._key=t?e.field(t):i.tupleid,this.reset()}function c(t){i.Transform.call(this,null,t),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}function p(t){i.Transform.call(this,null,t)}function v(t){i.Transform.call(this,[],t)}function g(t){i.Operator.call(this,null,y,t)}function y(t){return this.value&&!t.modified()?this.value:e.compare(t.fields,t.orders)}function _(t){i.Transform.call(this,null,t)}function x(t,e,i){switch(e){case"upper":t=t.toUpperCase();break;case"lower":t=t.toLowerCase()}return t.match(i)}function D(t){i.Transform.call(this,null,t)}function O(t,e,n,r){for(var a,s,u=[],o={},l=t.length,f=0;f<l;++f)for(o[e]=s=t[f],a=0;a<l;++a)o[n]=t[a],r(o)&&(u.push(i.ingest(o)),(o={})[e]=s);return u}function b(t,i){var n=t[Ot];xt.hasOwnProperty(n)||e.error("Unknown distribution function: "+n);var r=xt[n]();for(var a in t)a===bt?r.data((t.from||i()).map(t[a])):a===Dt?r[a](t[a].map(function(t){return b(t,i)})):typeof r[a]===Ot&&r[a](t[a]);return r}function k(t){i.Transform.call(this,null,t)}function q(t){return function(){return t.materialize(t.SOURCE).source}}function E(t){i.Transform.call(this,[1/0,-1/0],t)}function w(t,e){i.Operator.call(this,t),this.parent=e}function T(t){i.Transform.call(this,{},t),this._keys=e.fastmap();var n=this._targets=[];n.active=0,n.forEach=function(t){for(var e=0,i=n.active;e<i;++e)t(n[e],e,n)}}function M(t){i.Operator.call(this,null,R,t)}function R(t){return this.value&&!t.modified()?this.value:e.isArray(t.name)?e.array(t.name).map(function(t){return e.field(t)}):e.field(t.name,t.as)}function N(t){i.Transform.call(this,e.fastmap(),t)}function A(t){i.Transform.call(this,{},t)}function S(t){return t.fields.join("|")}function C(t){i.Transform.call(this,null,t)}function U(t){i.Transform.call(this,[],t)}function F(t){i.Transform.call(this,[],t)}function z(t){var i,n=t.method||Tt.value;if(null!=Tt[n])return n===Tt.value?(i=void 0!==t.value?t.value:0,function(){return i}):Tt[n];e.error("Unrecognized imputation method: "+n)}function L(t){var e=t.field;return function(t){return t?e(t):NaN}}function P(t,e,i,n){var r,a,s,u,o,l,f,d,m=[],h=n?n.slice():[],c={},p={};for(h.forEach(function(t,e){c[t]=e+1}),u=0,f=t.length;u<f;++u)l=i(d=t[u]),o=c[l]||(c[l]=h.push(l)),(s=p[a=(r=e?e.map(function(t){return t(d)}):Mt)+""])||(s=p[a]=[],m.push(s),s.values=r),s[o-1]=d;return m.domain=h,m}function j(t){c.call(this,t)}function I(t){i.Operator.call(this,null,W,t)}function W(t){return this.value&&!t.modified()?this.value:e.key(t.fields,t.flat)}function B(t){i.Transform.call(this,{},t)}function J(t){i.Operator.call(this,null,K,t)}function K(t){if(this.value&&!t.modified())return this.value;var e,i,n,r=1/0,a=-1/0,s=t.extents;for(e=0,i=s.length;e<i;++e)(n=s[e])[0]<r&&(r=n[0]),n[1]>a&&(a=n[1]);return[r,a]}function $(t){i.Operator.call(this,null,G,t)}function G(t){return this.value&&!t.modified()?this.value:t.values.reduce(function(t,e){return t.concat(e)},[])}function H(t){i.Transform.call(this,null,t)}function Q(t){T.call(this,t)}function V(t){i.Transform.call(this,null,t)}function X(t,i){return t?t.map(function(t,n){return i[n]||e.accessorName(t)}):null}function Y(t,e,i,n){for(var r=0,a=i.length;r<a;++r)e[n[r]]=i[r](t);return e}function Z(t){i.Transform.call(this,null,t)}function tt(t){i.Transform.call(this,null,t)}function et(t){i.Transform.call(this,[],t),this.count=0}function it(t){i.Transform.call(this,null,t)}function nt(t){i.Transform.call(this,null,t),this.modified(!0)}function rt(t){i.Transform.call(this,e.fastmap(),t)}function at(t){i.Transform.call(this,null,t)}function st(t,i,n,r){var a=Nt[t](i,n);return{init:a.init||e.zero,update:function(t,e){e[r]=a.next(t)}}}function ut(t){function i(t){e.array(e.accessorFields(t)).forEach(function(t){m[t]=1})}var n=this,r=e.array(t.ops),a=e.array(t.fields),s=e.array(t.params),l=e.array(t.as),f=n.outputs=[],d=n.windows=[],m={},h={},c=!0,p=[],v=[];i(t.sort),r.forEach(function(t,n){var r=a[n],m=e.accessorName(r),g=u(t,m,l[n]);if(i(r),f.push(g),Nt.hasOwnProperty(t))d.push(st(t,a[n],s[n],g));else{if(null==r&&"count"!==t&&e.error("Null aggregate field specified."),"count"===t)return void p.push(g);c=!1;var y=h[m];y||((y=h[m]=[]).field=r,v.push(y)),y.push(o(t,g))}}),(p.length||v.length)&&(n.cell=ot(v,p,c)),n.inputs=Object.keys(m)}function ot(t,e,i){t=t.map(function(t){return m(t,t.field)});var n={num:0,agg:null,store:!1,count:e};if(!i)for(var r=t.length,a=n.agg=Array(r),s=0;s<r;++s)a[s]=new t[s](n);if(n.store)var u=n.data=new h;return n.add=function(t){if(n.num+=1,!i){u&&u.add(t);for(var e=0;e<r;++e)a[e].add(a[e].get(t),t)}},n.rem=function(t){if(n.num-=1,!i){u&&u.rem(t);for(var e=0;e<r;++e)a[e].rem(a[e].get(t),t)}},n.set=function(t){var r,s;for(u&&u.values(),r=0,s=e.length;r<s;++r)t[e[r]]=n.num;if(!i)for(r=0,s=a.length;r<s;++r)a[r].set(t)},n.init=function(){n.num=0,u&&u.reset();for(var t=0;t<r;++t)a[t].init()},n}function lt(t){i.Transform.call(this,{},t),this._mlen=0,this._mods=[]}function ft(t,i,n){var a=n.sort,s=a&&!n.ignorePeers,u=n.frame||[null,0],o=t.data(a),l=o.length,f=0,d=s?r.bisector(a):null,m={i0:0,i1:0,p0:0,p1:0,index:0,data:o,compare:a||e.constant(-1)};for(i.init();f<l;++f)dt(m,u,f,l),s&&mt(m,d),i.update(m,o[f])}function dt(t,e,i,n){t.p0=t.i0,t.p1=t.i1,t.i0=null==e[0]?0:Math.max(0,i-Math.abs(e[0])),t.i1=null==e[1]?n:Math.min(n,i+Math.abs(e[1])+1),t.index=i}function mt(t,e){var i=t.i0,n=t.i1-1,r=t.compare,a=t.data,s=a.length-1;i>0&&!r(a[i],a[i-1])&&(t.i0=e.left(a,a[i])),n<s&&!r(a[n],a[n+1])&&(t.i1=e.right(a,a[n]))}var ht={values:l({name:"values",init:"cell.store = true;",set:"cell.data.values()",idx:-1}),count:l({name:"count",set:"cell.num"}),missing:l({name:"missing",set:"this.missing"}),valid:l({name:"valid",set:"this.valid"}),sum:l({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),mean:l({name:"mean",init:"this.mean = 0;",add:"var d = v - this.mean; this.mean += d / this.valid;",rem:"var d = v - this.mean; this.mean -= this.valid ? d / this.valid : this.mean;",set:"this.mean"}),average:l({name:"average",set:"this.mean",req:["mean"],idx:1}),variance:l({name:"variance",init:"this.dev = 0;",add:"this.dev += d * (v - this.mean);",rem:"this.dev -= d * (v - this.mean);",set:"this.valid > 1 ? this.dev / (this.valid-1) : 0",req:["mean"],idx:1}),variancep:l({name:"variancep",set:"this.valid > 1 ? this.dev / this.valid : 0",req:["variance"],idx:2}),stdev:l({name:"stdev",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid-1)) : 0",req:["variance"],idx:2}),stdevp:l({name:"stdevp",set:"this.valid > 1 ? Math.sqrt(this.dev / this.valid) : 0",req:["variance"],idx:2}),stderr:l({name:"stderr",set:"this.valid > 1 ? Math.sqrt(this.dev / (this.valid * (this.valid-1))) : 0",req:["variance"],idx:2}),distinct:l({name:"distinct",set:"cell.data.distinct(this.get)",req:["values"],idx:3}),ci0:l({name:"ci0",set:"cell.data.ci0(this.get)",req:["values"],idx:3}),ci1:l({name:"ci1",set:"cell.data.ci1(this.get)",req:["values"],idx:3}),median:l({name:"median",set:"cell.data.q2(this.get)",req:["values"],idx:3}),q1:l({name:"q1",set:"cell.data.q1(this.get)",req:["values"],idx:3}),q3:l({name:"q3",set:"cell.data.q3(this.get)",req:["values"],idx:3}),argmin:l({name:"argmin",init:"this.argmin = null;",add:"if (v < this.min) this.argmin = t;",rem:"if (v <= this.min) this.argmin = null;",set:"this.argmin || cell.data.argmin(this.get)",req:["min"],str:["values"],idx:3}),argmax:l({name:"argmax",init:"this.argmax = null;",add:"if (v > this.max) this.argmax = t;",rem:"if (v >= this.max) this.argmax = null;",set:"this.argmax || cell.data.argmax(this.get)",req:["max"],str:["values"],idx:3}),min:l({name:"min",init:"this.min = null;",add:"if (v < this.min || this.min === null) this.min = v;",rem:"if (v <= this.min) this.min = NaN;",set:"this.min = (isNaN(this.min) ? cell.data.min(this.get) : this.min)",str:["values"],idx:4}),max:l({name:"max",init:"this.max = null;",add:"if (v > this.max || this.max === null) this.max = v;",rem:"if (v >= this.max) this.max = NaN;",set:"this.max = (isNaN(this.max) ? cell.data.max(this.get) : this.max)",str:["values"],idx:4})},ct=Object.keys(ht),pt=h.prototype;pt.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},pt.add=function(t){this._add.push(t)},pt.rem=function(t){this._rem.push(t)},pt.values=function(){if(this._get=null,0===this._rem.length)return this._add;var t,e,i,n=this._add,r=this._rem,a=this._key,s=n.length,u=r.length,o=Array(s-u),l={};for(t=0;t<u;++t)l[a(r[t])]=1;for(t=0,e=0;t<s;++t)l[a(i=n[t])]?l[a(i)]=0:o[e++]=i;return this._rem=[],this._add=o},pt.distinct=function(t){for(var e,i=this.values(),n=i.length,r={},a=0;--n>=0;)e=t(i[n])+"",r.hasOwnProperty(e)||(r[e]=1,++a);return a},pt.extent=function(t){if(this._get!==t||!this._ext){var i=this.values(),n=e.extentIndex(i,t);this._ext=[i[n[0]],i[n[1]]],this._get=t}return this._ext},pt.argmin=function(t){return this.extent(t)[0]||{}},pt.argmax=function(t){return this.extent(t)[1]||{}},pt.min=function(t){var e=this.extent(t)[0];return null!=e?t(e):1/0},pt.max=function(t){var e=this.extent(t)[1];return null!=e?t(e):-1/0},pt.quartile=function(t){return this._get===t&&this._q||(this._q=n.quartiles(this.values(),t),this._get=t),this._q},pt.q1=function(t){return this.quartile(t)[0]},pt.q2=function(t){return this.quartile(t)[1]},pt.q3=function(t){return this.quartile(t)[2]},pt.ci=function(t){return this._get===t&&this._ci||(this._ci=n.bootstrapCI(this.values(),1e3,.05,t),this._get=t),this._ci},pt.ci0=function(t){return this.ci(t)[0]},pt.ci1=function(t){return this.ci(t)[1]},c.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:ct},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]};var vt=e.inherits(c,i.Transform);vt.transform=function(t,e){var i,n=this,r=e.fork(e.NO_SOURCE|e.NO_FIELDS);return this.stamp=r.stamp,this.value&&((i=t.modified())||e.modified(this._inputs))?(this._prev=this.value,this.value=i?this.init(t):{},e.visit(e.SOURCE,function(t){n.add(t)})):(this.value=this.value||this.init(t),e.visit(e.REM,function(t){n.rem(t)}),e.visit(e.ADD,function(t){n.add(t)})),r.modifies(this._outputs),n._drop=!1!==t.drop,t.cross&&n._dims.length>1&&(n._drop=!1,this.cross()),n.changes(r)},vt.cross=function(){function t(t){var e,i,n,u;for(e in t)for(n=t[e].tuple,i=0;i<s;++i)a[i][u=n[r[i]]]=u}function e(t,u,o){var l,f,d=r[o],m=a[o++];for(l in m)u[d]=m[l],f=t?t+"|"+l:l,o<s?e(f,u,o):n[f]||i.cell(f,u)}var i=this,n=i.value,r=i._dnames,a=r.map(function(){return{}}),s=r.length;t(i._prev),t(n),e("",{},0)},vt.init=function(t){function i(t){for(var i,r=e.array(e.accessorFields(t)),s=0,u=r.length;s<u;++s)a[i=r[s]]||(a[i]=1,n.push(i))}var n=this._inputs=[],r=this._outputs=[],a={};this._dims=e.array(t.groupby),this._dnames=this._dims.map(function(t){var n=e.accessorName(t);return i(t),r.push(n),n}),this.cellkey=t.key?t.key:s(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];var l,f,d,h,c,p,v=t.fields||[null],g=t.ops||["count"],y=t.as||[],_=v.length,x={};for(_!==g.length&&e.error("Unmatched number of fields and aggregate ops."),p=0;p<_;++p)l=v[p],f=g[p],null==l&&"count"!==f&&e.error("Null aggregate field specified."),c=u(f,h=e.accessorName(l),y[p]),r.push(c),"count"!==f?((d=x[h])||(i(l),(d=x[h]=[]).field=l,this._measures.push(d)),"count"!==f&&(this._countOnly=!1),d.push(o(f,c))):this._counts.push(c);return this._measures=this._measures.map(function(t){return m(t,t.field)}),{}},vt.cellkey=s(),vt.cell=function(t,e){var i=this.value[t];return i?0===i.num&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[t]=this.newcell(t,e),this._adds[this._alen++]=i),i},vt.newcell=function(t,e){var i={key:t,num:0,agg:null,tuple:this.newtuple(e,this._prev&&this._prev[t]),stamp:this.stamp,store:!1};if(!this._countOnly){var n,r=this._measures,a=r.length;for(i.agg=Array(a),n=0;n<a;++n)i.agg[n]=new r[n](i)}return i.store&&(i.data=new h),i},vt.newtuple=function(t,e){var n,r,a=this._dnames,s=this._dims,u={};for(n=0,r=s.length;n<r;++n)u[a[n]]=s[n](t);return e?i.replace(e.tuple,u):i.ingest(u)},vt.add=function(t){var e,i,n,r=this.cellkey(t),a=this.cell(r,t);if(a.num+=1,!this._countOnly)for(a.store&&a.data.add(t),i=0,n=(e=a.agg).length;i<n;++i)e[i].add(e[i].get(t),t)},vt.rem=function(t){var e,i,n,r=this.cellkey(t),a=this.cell(r,t);if(a.num-=1,!this._countOnly)for(a.store&&a.data.rem(t),i=0,n=(e=a.agg).length;i<n;++i)e[i].rem(e[i].get(t),t)},vt.celltuple=function(t){var e,i,n,r=t.tuple,a=this._counts;for(t.store&&t.data.values(),i=0,n=a.length;i<n;++i)r[a[i]]=t.num;if(!this._countOnly)for(i=0,n=(e=t.agg).length;i<n;++i)e[i].set(r);return r},vt.changes=function(t){var e,i,n,r,a=this._adds,s=this._mods,u=this._prev,o=this._drop,l=t.add,f=t.rem,d=t.mod;if(u)for(i in u)e=u[i],o&&!e.num||f.push(e.tuple);for(n=0,r=this._alen;n<r;++n)l.push(this.celltuple(a[n])),a[n]=null;for(n=0,r=this._mlen;n<r;++n)(0===(e=s[n]).num&&o?f:d).push(this.celltuple(e)),s[n]=null;return this._alen=this._mlen=0,this._prev=null,t},p.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]};var gt=e.inherits(p,i.Transform);gt.transform=function(t,i){var n,r=this._bins(t),a=r.start,s=r.step,u=t.as||["bin0","bin1"],o=u[0],l=u[1];return n=t.modified()?(i=i.reflow(!0)).SOURCE:i.modified(e.accessorFields(t.field))?i.ADD_MOD:i.ADD,i.visit(n,function(t){var e=r(t);t[o]=e,t[l]=null==e?null:a+s*(1+(e-a)/s)}),i.modifies(u)},gt._bins=function(t){if(this.value&&!t.modified())return this.value;var i,r,a=t.field,s=n.bin(t),u=s.start,o=s.stop,l=s.step;null!=(i=t.anchor)&&(r=i-(u+l*Math.floor((i-u)/l)),u+=r,o+=r);var f=function(t){var e=a(t);return null==e?null:(e=Math.max(u,Math.min(+e,o-l)),u+l*Math.floor((e-u)/l))};return f.start=u,f.stop=o,f.step=l,this.value=e.accessor(f,e.accessorFields(a),t.name||"bin_"+e.accessorName(a))};var yt=function(t,i,n){var r=t,a=i||[],s=n||[],u={},o=0;return{add:function(t){s.push(t)},remove:function(t){u[r(t)]=++o},size:function(){return a.length},data:function(t,i){return o&&(a=a.filter(function(t){return!u[r(t)]}),u={},o=0),i&&t&&a.sort(t),s.length&&(a=t?e.merge(t,a,s.sort(t)):a.concat(s),s=[]),a}}};v.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},e.inherits(v,i.Transform).transform=function(t,e){var n=e.fork(e.ALL),r=yt(i.tupleid,this.value,n.materialize(n.ADD).add),a=t.sort,s=e.changed()||a&&(t.modified("sort")||e.modified(a.fields));return n.visit(n.REM,r.remove),this.modified(s),this.value=n.source=r.data(a,s),n},e.inherits(g,i.Operator),_.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};var _t=e.inherits(_,i.Transform);_t.transform=function(t,e){function i(e){return function(i){for(var n,r=x(u(i),t.case,a)||[],o=0,l=r.length;o<l;++o)s.test(n=r[o])||e(n)}}var n=this._parameterCheck(t,e),r=this._counts,a=this._match,s=this._stop,u=t.field,o=t.as||["text","count"],l=i(function(t){r[t]=1+(r[t]||0)}),f=i(function(t){r[t]-=1});return n?e.visit(e.SOURCE,l):(e.visit(e.ADD,l),e.visit(e.REM,f)),this._finish(e,o)},_t._parameterCheck=function(t,e){var i=!1;return!t.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(t.stopwords||"")+"$","i"),i=!0),!t.modified("pattern")&&this._match||(this._match=new RegExp(t.pattern||"[\\w']+","g"),i=!0),(t.modified("field")||e.modified(t.field.fields))&&(i=!0),i&&(this._counts={}),i},_t._finish=function(t,e){var n,r,a,s=this._counts,u=this._tuples||(this._tuples={}),o=e[0],l=e[1],f=t.fork();for(n in s)r=u[n],a=s[n]||0,!r&&a?(u[n]=r=i.ingest({}),r[o]=n,r[l]=a,f.add.push(r)):0===a?(r&&f.rem.push(r),s[n]=null,u[n]=null):r[l]!==a&&(r[l]=a,f.mod.push(r));return f.modifies(e)},D.Definition={type:"Cross",metadata:{source:!0,generates:!0,changes:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},e.inherits(D,i.Transform).transform=function(t,i){var n=i.fork(i.NO_SOURCE),r=this.value,a=t.as||["a","b"],s=a[0],u=a[1];return!r||i.changed(i.ADD_REM)||t.modified("as")||t.modified("filter")?(r&&(n.rem=r),n.add=this.value=O(i.source,s,u,t.filter||e.truthy)):n.mod=r,n.source=this.value,n.modifies(a)};var xt={kde:n.randomKDE,mixture:n.randomMixture,normal:n.randomNormal,uniform:n.randomUniform},Dt="distributions",Ot="function",bt="field",kt=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],qt={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:kt},{name:"weights",type:"number",array:!0}]};k.Definition={type:"Density",metadata:{generates:!0,source:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number",default:100},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:kt.concat(qt)},{name:"as",type:"string",array:!0,default:["value","density"]}]},e.inherits(k,i.Transform).transform=function(t,n){var a=n.fork(n.NO_SOURCE|n.NO_FIELDS);if(!this.value||n.changed()||t.modified()){var s=b(t.distribution,q(n)),u=t.method||"pdf";"pdf"!==u&&"cdf"!==u&&e.error("Invalid density method: "+u),t.extent||s.data||e.error("Missing density extent parameter."),u=s[u];var o=t.as||["value","density"],l=t.extent||r.extent(s.data()),f=(l[1]-l[0])/(t.steps||100),d=r.range(l[0],l[1]+f/2,f).map(function(t){var e={};return e[o[0]]=t,e[o[1]]=u(t),i.ingest(e)});this.value&&(a.rem=this.value),this.value=a.add=a.source=d}return a},E.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},e.inherits(E,i.Transform).transform=function(t,e){var i=this.value,n=t.field,r=i[0],a=i[1],s=e.ADD;(e.changed()||e.modified(n.fields)||t.modified("field"))&&(s=e.SOURCE,r=1/0,a=-1/0),e.visit(s,function(t){var e=n(t);null!=e&&(e<r&&(r=e),e>a&&(a=e))}),this.value=[r,a]};var Et=e.inherits(w,i.Operator);Et.connect=function(t){return this.targets().add(t),t.source=this},Et.add=function(t){this.value.add.push(t)},Et.rem=function(t){this.value.rem.push(t)},Et.mod=function(t){this.value.mod.push(t)},Et.init=function(t){this.value.init(t,t.NO_SOURCE)},Et.evaluate=function(){return this.value};var wt=e.inherits(T,i.Transform);wt.activate=function(t){this._targets[this._targets.active++]=t},wt.subflow=function(t,e,i,n){var r,a,s=this.value,u=s.hasOwnProperty(t)&&s[t];return u?u.value.stamp<i.stamp&&(u.init(i),this.activate(u)):(a=n||(a=this._group[t])&&a.tuple,u=(r=i.dataflow).add(new w(i.fork(i.NO_SOURCE),this)).connect(e(r,t,a)),s[t]=u,this.activate(u)),u},wt.transform=function(t,e){function n(t){return a.subflow(t,u,e)}var r=e.dataflow,a=this,s=t.key,u=t.subflow,o=this._keys,l=t.modified("key");return this._group=t.group||{},this._targets.active=0,e.visit(e.REM,function(t){var e=i.tupleid(t),r=o.get(e);void 0!==r&&(o.delete(e),n(r).rem(t))}),e.visit(e.ADD,function(t){var e=s(t);o.set(i.tupleid(t),e),n(e).add(t)}),l||e.modified(s.fields)?e.visit(e.MOD,function(t){var e=i.tupleid(t),r=o.get(e),a=s(t);r===a?n(a).mod(t):(o.set(e,a),n(r).rem(t),n(a).add(t))}):e.changed(e.MOD)&&e.visit(e.MOD,function(t){n(o.get(i.tupleid(t))).mod(t)}),l&&e.visit(e.REFLOW,function(t){var e=i.tupleid(t),r=o.get(e),a=s(t);r!==a&&(o.set(e,a),n(r).rem(t),n(a).add(t))}),o.empty>r.cleanThreshold&&r.runAfter(o.clean),e},e.inherits(M,i.Operator),N.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},e.inherits(N,i.Transform).transform=function(t,e){function n(e){var n=i.tupleid(e),r=f(e,t),s=a.get(n);r&&s?(a.delete(n),u.push(e)):r||s?d&&r&&!s&&l.push(e):(a.set(n,1),o.push(e))}var r=e.dataflow,a=this.value,s=e.fork(),u=s.add,o=s.rem,l=s.mod,f=t.expr,d=!0;return e.visit(e.REM,function(t){var e=i.tupleid(t);a.has(e)?a.delete(e):o.push(t)}),e.visit(e.ADD,function(e){f(e,t)?u.push(e):a.set(i.tupleid(e),1)}),e.visit(e.MOD,n),t.modified()&&(d=!1,e.visit(e.REFLOW,n)),a.empty>r.cleanThreshold&&r.runAfter(a.clean),s},A.Definition={type:"Fold",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},e.inherits(A,i.Transform).transform=function(t,e){function n(t){for(var e,n=a[i.tupleid(t)]=Array(m),r=0;r<m;++r)(e=n[r]=i.derive(t))[l]=d[r],e[f]=u[r](t),c.add.push(e)}var r,a=this.value,s=t.modified("fields"),u=t.fields,o=t.as||["key","value"],l=o[0],f=o[1],d=u.map(S),m=u.length,h=e.stamp,c=e.fork(e.NO_SOURCE),p=0,v=0;if(s){for(r in a)c.rem.push.apply(c.rem,a[r]);a=this.value={},e.visit(e.SOURCE,n)}else{for(e.visit(e.ADD,n);p<m;++p)e.modified(u[p].fields)&&(v|=1<<p);v&&e.visit(e.MOD,function(t){for(var e,n=a[i.tupleid(t)],r=0;r<m;++r)v&1<<r&&((e=i.rederive(t,n[r],h))[l]=d[r],e[f]=u[r](t),c.mod.push(e))}),e.visit(e.REM,function(t){var e=i.tupleid(t);c.rem.push.apply(c.rem,a[e]),a[e]=null})}return c.modifies(o)},C.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},e.inherits(C,i.Transform).transform=function(t,e){var i=t.expr,n=t.as,r=t.modified(),a=t.initonly?e.ADD:r?e.SOURCE:e.modified(i.fields)?e.ADD_MOD:e.ADD;return r&&(e=e.materialize().reflow(!0)),t.initonly||e.modifies(n),e.visit(a,function(e){e[n]=i(e,t)})},e.inherits(U,i.Transform).transform=function(t,e){var n,r,a,s=this.value,u=e.fork(e.ALL),o=t.size-s.length,l=t.generator;if(o>0){for(n=[];--o>=0;)n.push(a=i.ingest(l(t))),s.push(a);u.add=u.add.length?u.materialize(u.ADD).add.concat(n):n}else r=s.slice(0,-o),u.rem=u.rem.length?u.materialize(u.REM).rem.concat(r):r,s=s.slice(-o);return u.source=this.value=s,u};var Tt={value:"value",median:r.median,mean:r.mean,min:r.min,max:r.max},Mt=[];F.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},e.inherits(F,i.Transform).transform=function(t,n){var r,a,s,u,o,l,f,d,m,h,c=n.fork(n.ALL),p=z(t),v=L(t),g=e.accessorName(t.field),y=e.accessorName(t.key),_=(t.groupby||[]).map(e.accessorName),x=P(n.source,t.groupby,t.key,t.keyvals),D=[],O=this.value,b=x.domain.length;for(o=0,d=x.length;o<d;++o)for(s=(r=x[o]).values,a=NaN,f=0;f<b;++f)if(null==r[f]){for(u=x.domain[f],h={_impute:!0},l=0,m=s.length;l<m;++l)h[_[l]]=s[l];h[y]=u,h[g]=isNaN(a)?a=p(r,v):a,D.push(i.ingest(h))}return D.length&&(c.add=c.materialize(c.ADD).add.concat(D)),O.length&&(c.rem=c.materialize(c.REM).rem.concat(O)),this.value=D,c},j.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:ct},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]};var Rt=e.inherits(j,c);Rt.transform=function(t,i){var n,r=this,a=t.modified();return r.value&&(a||i.modified(r._inputs))?(n=r.value=a?r.init(t):{},i.visit(i.SOURCE,function(t){r.add(t)})):(n=r.value=r.value||this.init(t),i.visit(i.REM,function(t){r.rem(t)}),i.visit(i.ADD,function(t){r.add(t)})),r.changes(),i.visit(i.SOURCE,function(t){e.extend(t,n[r.cellkey(t)].tuple)}),i.reflow(a).modifies(this._outputs)},Rt.changes=function(){var t,e,i=this._adds,n=this._mods;for(t=0,e=this._alen;t<e;++t)this.celltuple(i[t]),i[t]=null;for(t=0,e=this._mlen;t<e;++t)this.celltuple(n[t]),n[t]=null;this._alen=this._mlen=0},e.inherits(I,i.Operator),B.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},e.inherits(B,i.Transform).transform=function(t,i){var n,r,a=i,s=t.as,u=t.fields,o=t.index,l=t.values,f=null==t.default?null:t.default,d=t.modified(),m=d?i.SOURCE:i.ADD,h=u.length;return l?(r=l.length,h>1&&!s&&e.error('Multi-field lookup requires explicit "as" parameter.'),s&&s.length!==h*r&&e.error('The "as" parameter has too few output field names.'),s=s||l.map(e.accessorName),n=function(t){for(var e,i,n=0,a=0;n<h;++n)if(null==(i=o.get(u[n](t))))for(e=0;e<r;++e,++a)t[s[a]]=f;else for(e=0;e<r;++e,++a)t[s[a]]=l[e](i)}):(s||e.error("Missing output field names."),n=function(t){for(var e,i=0;i<h;++i)e=o.get(u[i](t)),t[s[i]]=null==e?f:e}),d?a=i.reflow(!0):m|=u.some(function(t){return i.modified(t.fields)})?i.MOD:0,i.visit(m,n),a.modifies(s)},e.inherits(J,i.Operator),e.inherits($,i.Operator),e.inherits(H,i.Transform),H.prototype.transform=function(t,e){return this.modified(t.modified()),this.value=t,e.fork(e.NO_SOURCE|e.NO_FIELDS)},e.inherits(Q,T).transform=function(t,n){var r=this,a=t.subflow,s=t.field;return(t.modified("field")||s&&n.modified(e.accessorFields(s)))&&e.error("PreFacet does not support field modification."),this._targets.active=0,n.visit(n.MOD,function(t){var e=r.subflow(i.tupleid(t),a,n,t);s?s(t).forEach(function(t){e.mod(t)}):e.mod(t)}),n.visit(n.ADD,function(t){var e=r.subflow(i.tupleid(t),a,n,t);s?s(t).forEach(function(t){e.add(i.ingest(t))}):e.add(t)}),n.visit(n.REM,function(t){var e=r.subflow(i.tupleid(t),a,n,t);s?s(t).forEach(function(t){e.rem(t)}):e.rem(t)}),n},V.Definition={type:"Project",metadata:{generates:!0,changes:!0,modifies:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},e.inherits(V,i.Transform).transform=function(t,e){var n,r,a=t.fields,s=X(t.fields,t.as||[]),u=a?function(t,e){return Y(t,e,a,s)}:i.rederive;return this.value?r=this.value:(e=e.addAll(),r=this.value={}),n=e.fork(),e.visit(e.REM,function(t){var e=i.tupleid(t);n.rem.push(r[e]),r[e]=null}),e.visit(e.ADD,function(t){var e=u(t,i.ingest({}));r[i.tupleid(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(u(t,r[i.tupleid(t)]))}),n},e.inherits(Z,i.Transform).transform=function(t,e){return this.value=t.value,t.modified("value")?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(tt,i.Transform).transform=function(t,e){var n,r;return this.value?r=this.value:(n=e=e.addAll(),r=this.value={}),t.derive&&(n=e.fork(),e.visit(e.REM,function(t){var e=i.tupleid(t);n.rem.push(r[e]),r[e]=null}),e.visit(e.ADD,function(t){var e=i.derive(t);r[i.tupleid(t)]=e,n.add.push(e)}),e.visit(e.MOD,function(t){n.mod.push(i.rederive(t,r[i.tupleid(t)]))})),n},et.Definition={type:"Sample",metadata:{source:!0,changes:!0},params:[{name:"size",type:"number",default:1e3}]},e.inherits(et,i.Transform).transform=function(t,e){function r(t){var e,r;o.length<u?o.push(t):(r=~~((l+1)*n.random()))<o.length&&r>=f&&(e=o[r],d[i.tupleid(e)]&&a.rem.push(e),o[r]=t),++l}var a=e.fork(),s=t.modified("size"),u=t.size,o=this.value,l=this.count,f=0,d=o.reduce(function(t,e){return t[i.tupleid(e)]=1,t},{});if(e.rem.length&&(e.visit(e.REM,function(t){var e=i.tupleid(t);d[e]&&(d[e]=-1,a.rem.push(t)),--l}),o=o.filter(function(t){return-1!==d[i.tupleid(t)]})),(e.rem.length||s)&&o.length<u&&e.source&&(f=l=o.length,e.visit(e.SOURCE,function(t){d[i.tupleid(t)]||r(t)}),f=-1),s&&o.length>u){for(var m=0,h=o.length-u;m<h;++m)d[i.tupleid(o[m])]=-1,a.rem.push(o[m]);o=o.slice(h)}return e.mod.length&&e.visit(e.MOD,function(t){d[i.tupleid(t)]&&a.mod.push(t)}),e.add.length&&e.visit(e.ADD,r),(e.add.length||f<0)&&(a.add=o.filter(function(t){return!d[i.tupleid(t)]})),this.count=l,this.value=a.source=o,a},it.Definition={type:"Sequence",metadata:{generates:!0,source:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1}],output:["value"]},e.inherits(it,i.Transform).transform=function(t,e){if(!this.value||t.modified()){var n=e.materialize().fork(e.MOD);return n.rem=this.value?e.rem.concat(this.value):e.rem,n.source=this.value=r.range(t.start,t.stop,t.step||1).map(i.ingest),n.add=e.add.concat(this.value),n}},e.inherits(nt,i.Transform).transform=function(t,e){return this.value=e.source,e.changed()?e.fork(e.NO_SOURCE|e.NO_FIELDS):e.StopPropagation},e.inherits(rt,i.Transform).transform=function(t,e){function i(t){a.set(r(t),t)}var n=e.dataflow,r=t.field,a=this.value,s=!0;return t.modified("field")||e.modified(r.fields)?(a.clear(),e.visit(e.SOURCE,i)):e.changed()?(e.visit(e.REM,function(t){a.delete(r(t))}),e.visit(e.ADD,i)):s=!1,this.modified(s),a.empty>n.cleanThreshold&&n.runAfter(a.clean),e.fork()},e.inherits(at,i.Transform).transform=function(t,e){(!this.value||t.modified("field")||t.modified("sort")||e.changed()||t.sort&&e.modified(t.sort.fields))&&(this.value=(t.sort?e.source.slice().sort(t.sort):e.source).map(t.field))};var Nt={row_number:function(){return{next:function(t){return t.index+1}}},rank:function(){var t;return{init:function(){t=1},next:function(e){var i=e.index,n=e.data;return i&&e.compare(n[i-1],n[i])?t=i+1:t}}},dense_rank:function(){var t;return{init:function(){t=1},next:function(e){var i=e.index,n=e.data;return i&&e.compare(n[i-1],n[i])?++t:t}}},percent_rank:function(){var t=Nt.rank(),e=t.next;return{init:t.init,next:function(t){return(e(t)-1)/(t.data.length-1)}}},cume_dist:function(){var t;return{init:function(){t=0},next:function(e){var i=e.index,n=e.data,r=e.compare;if(t<i){for(;i+1<n.length&&!r(n[i],n[i+1]);)++i;t=i}return(1+t)/n.length}}},ntile:function(t,i){(i=+i)>0||e.error("ntile num must be greater than zero.");var n=Nt.cume_dist(),r=n.next;return{init:n.init,next:function(t){return Math.ceil(i*r(t))}}},lag:function(t,e){return e=+e||1,{next:function(i){var n=i.index-e;return n>=0?t(i.data[n]):null}}},lead:function(t,e){return e=+e||1,{next:function(i){var n=i.index+e,r=i.data;return n<r.length?t(r[n]):null}}},first_value:function(t){return{next:function(e){return t(e.data[e.i0])}}},last_value:function(t){return{next:function(e){return t(e.data[e.i1-1])}}},nth_value:function(t,i){return(i=+i)>0||e.error("nth_value nth must be greater than zero."),{next:function(e){var n=e.i0+(i-1);return n<e.i1?t(e.data[n]):null}}}},At=Object.keys(Nt),St=ut.prototype;St.init=function(){this.windows.forEach(function(t){t.init()}),this.cell&&this.cell.init()},St.update=function(t,e){var i,n=this,r=n.cell,a=n.windows,s=t.data,u=a&&a.length;if(r){for(i=t.p0;i<t.i0;++i)r.rem(s[i]);for(i=t.p1;i<t.i1;++i)r.add(s[i]);r.set(e)}for(i=0;i<u;++i)a[i].update(t,e)},lt.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:At.concat(ct)},{name:"params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]};var Ct=e.inherits(lt,i.Transform);Ct.transform=function(t,e){function i(t){return a.group(l(t))}var n,r,a=this,u=a.state,o=t.modified();this.stamp=e.stamp,u&&!o||(u=a.state=new ut(t));var l=s(t.groupby);for(o||e.modified(u.inputs)?(a.value={},e.visit(e.SOURCE,function(t){i(t).add(t)})):(e.visit(e.REM,function(t){i(t).remove(t)}),e.visit(e.ADD,function(t){i(t).add(t)})),n=0,r=a._mlen;n<r;++n)ft(a._mods[n],u,t);return a._mlen=0,a._mods=[],e.reflow(o).modifies(u.outputs)},Ct.group=function(t){var e=this,n=e.value[t];return n||((n=e.value[t]=yt(i.tupleid)).stamp=-1),n.stamp<e.stamp&&(n.stamp=e.stamp,e._mods[e._mlen++]=n),n},t.aggregate=c,t.bin=p,t.collect=v,t.compare=g,t.countpattern=_,t.cross=D,t.density=k,t.extent=E,t.facet=T,t.field=M,t.filter=N,t.fold=A,t.formula=C,t.generate=U,t.impute=F,t.joinaggregate=j,t.key=I,t.lookup=B,t.multiextent=J,t.multivalues=$,t.params=H,t.prefacet=Q,t.project=V,t.proxy=Z,t.relay=tt,t.sample=et,t.sequence=it,t.sieve=nt,t.subflow=w,t.tupleindex=rt,t.values=at,t.window=lt,Object.defineProperty(t,"__esModule",{value:!0})});