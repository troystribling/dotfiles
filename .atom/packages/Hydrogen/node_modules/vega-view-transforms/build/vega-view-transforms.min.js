!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],t):t((n.vega=n.vega||{},n.vega.transforms=n.vega.transforms||{}),n.vega,n.vega,n.vega)}(this,function(n,t,e,o){"use strict";function r(n){t.Transform.call(this,null,n)}function a(n,t,e){return t(n.bounds.clear(),n,e)}function i(n){t.Transform.call(this,0,n)}function u(n){t.Transform.call(this,null,n)}function s(n){t.Transform.call(this,null,n)}function d(n,t){return!(n.x2-1<t.x1||n.x1+1>t.x2||n.y2-1<t.y1||n.y1+1>t.y2)}function l(n){for(var t,e=1,o=n.length,r=n[0].bounds;e<o;r=t,++e)if(d(r,t=n[e].bounds))return!0}function c(n){var t=n.bounds;return t.width()>1&&t.height()>1}function f(n){t.Transform.call(this,null,n)}function h(n,t){for(var e=0,o=n.length;e<o;++e)t.push(n[e])}function m(n,t,e){var r=o.isObject(n)?n[t]:n;return null!=r?r:void 0!==e?e:0}function b(n){return n<0?Math.ceil(-n):0}function g(n,t,o){function r(n,t){return Math.floor(Math.min(n,t))}function a(n,t){return Math.ceil(Math.max(n,t))}var i,u,s,d,l,c,f,g,p,v,w,k,M,T=function(n){for(var t,e,o=n.items,r=o.length,a=0,i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};a<r;++a)if(t=o[a],e=t.items,"group"===t.marktype)switch(t.role){case j:case S:break;case q:h(e,i.rowheaders);break;case A:h(e,i.rowfooters);break;case F:h(e,i.colheaders);break;case G:h(e,i.colfooters);break;case I:i.rowtitle=e[0];break;case H:i.coltitle=e[0];break;default:h(e,i.marks)}return i}(t),B=T.marks,E="flush"===o.bounds,z=E?function(n){return{x1:0,y1:0,x2:n.width||0,y2:n.height||0}}:function(n){var t=n.bounds.clone();return t.empty()?t.set(0,0,0,0):t.translate(-(n.x||0),-(n.y||0))},D=new e.Bounds(0,0,0,0),_=m(o.align,"column"),O=m(o.align,"row"),L=m(o.padding,"column"),P=m(o.padding,"row"),R=o.offset,C=t.columns||o.columns||B.length,U=C<0?1:Math.ceil(B.length/C),V=U*C,W=[],J=[],K=[],N=[],Q=B.length;for(u=0;u<C;++u)J[u]=0;for(u=0;u<U;++u)N[u]=0;for(u=0;u<Q;++u)l=z(B[u]),d=~~(u/C),f=(s=u%C)?Math.ceil(z(B[u-1]).x2):0,g=d?Math.ceil(z(B[u-C]).y2):0,J[s]=Math.max(J[s],f),N[d]=Math.max(N[d],g),W.push(L+b(l.x1)),K.push(P+b(l.y1)),n.dirty(B[u]);for(u=0;u<Q;++u)u%C==0&&(W[u]=0),u<C&&(K[u]=0);if("each"===_)for(s=1;s<C;++s){for(M=0,u=s;u<Q;u+=C)M<W[u]&&(M=W[u]);for(u=s;u<Q;u+=C)W[u]=M+J[s]}else if("all"===_){for(k=0,s=1;s<C;++s)k<J[s]&&(k=J[s]);for(M=0,u=0;u<Q;++u)u%C&&M<W[u]&&(M=W[u]);for(u=0;u<Q;++u)u%C&&(W[u]=M+k)}else for(s=1;s<C;++s)for(u=s;u<Q;u+=C)W[u]+=J[s];if("each"===O)for(d=1;d<U;++d){for(M=0,i=(u=d*C)+C;u<i;++u)M<K[u]&&(M=K[u]);for(u=d*C;u<i;++u)K[u]=M+N[d]}else if("all"===O){for(k=0,d=1;d<U;++d)k<N[d]&&(k=N[d]);for(M=0,u=C;u<Q;++u)M<K[u]&&(M=K[u]);for(u=C;u<Q;++u)K[u]=M+k}else for(d=1;d<U;++d)for(i=(u=d*C)+C;u<i;++u)K[u]+=N[d];for(p=0,u=0;u<Q;++u)f=(c=B[u]).x||0,c.x=p=W[u]+(u%C?p:0),c.bounds.translate(p-f,0);for(s=0;s<C;++s)for(v=0,u=s;u<Q;u+=C)g=(c=B[u]).y||0,c.y=v+=K[u],c.bounds.translate(0,v-g);for(u=0;u<Q;++u)B[u].mark.bounds.clear();for(u=0;u<Q;++u)c=B[u],n.dirty(c),D.union(c.mark.bounds.union(c.bounds));z=E?function(n,t){return"x1"===t?n.x||0:"y1"===t?n.y||0:"x2"===t?(n.x||0)+(n.width||0):"y2"===t?(n.y||0)+(n.height||0):void 0}:function(n,t){return n.bounds[t]},w=m(o.headerBand,"row",null),p=y(n,T.rowheaders,B,C,U,-m(R,"rowHeader"),r,0,z,"x1",0,C,1,w),w=m(o.headerBand,"column",null),v=y(n,T.colheaders,B,C,C,-m(R,"columnHeader"),r,1,z,"y1",0,1,C,w),w=m(o.footerBand,"row",null),y(n,T.rowfooters,B,C,U,m(R,"rowFooter"),a,0,z,"x2",C-1,C,1,w),w=m(o.footerBand,"column",null),y(n,T.colfooters,B,C,C,m(R,"columnFooter"),a,1,z,"y2",V-C,1,C,w),T.rowtitle&&(M=p-m(R,"rowTitle"),w=m(o.titleBand,"row",.5),x(n,T.rowtitle,M,0,D,w)),T.coltitle&&(M=v-m(R,"columnTitle"),w=m(o.titleBand,"column",.5),x(n,T.coltitle,M,1,D,w))}function y(n,t,e,o,r,a,i,u,s,d,l,c,f,h){var m,b,g,y,x,p,v,w,k,M=e.length,T=0,B=0;if(!M)return T;for(m=l;m<M;m+=c)e[m]&&(T=i(T,s(e[m],d)));if(!t.length)return T;for(t.length>r&&(n.warn("Grid headers exceed limit: "+r),t=t.slice(0,r)),T+=a,b=0,y=t.length;b<y;++b)n.dirty(t[b]),t[b].mark.bounds.clear();for(m=l,b=0,y=t.length;b<y;++b,m+=c){for(x=(p=t[b]).mark.bounds,g=m;g>=0&&null==(v=e[g]);g-=f);u?(w=null==h?v.x:Math.round(v.bounds.x1+h*v.bounds.width()),k=T):(w=T,k=null==h?v.y:Math.round(v.bounds.y1+h*v.bounds.height())),x.union(p.bounds.translate(w-(p.x||0),k-(p.y||0))),p.x=w,p.y=k,n.dirty(p),B=i(B,x[d])}return B}function x(n,t,e,o,r,a){if(t){n.dirty(t);var i=e,u=e;o?i=Math.round(r.x1+a*r.width()):u=Math.round(r.y1+a*r.height()),t.bounds.translate(i-(t.x||0),u-(t.y||0)),t.mark.bounds.clear().union(t.bounds),t.x=i,t.y=u,n.dirty(t)}}function p(n){t.Transform.call(this,null,n)}function v(n,t,o){var r,a,i,u,s,d,l=t.items,c=Math.max(0,t.width||0),f=Math.max(0,t.height||0),h=(new e.Bounds).set(0,0,c,f),m=h.clone(),b=h.clone(),g=h.clone(),y=[];for(s=0,d=l.length;s<d;++s)switch((a=l[s]).role){case U:m.union(u=function(n,t,o,r){var a,i,u=t.items[0],s=u.datum,d=s.orient,l=function(n){var t=+n.grid;return[n.ticks?t++:-1,n.labels?t++:-1,t+ +n.domain]}(s),c=u.range,f=u.offset,h=u.position,m=u.minExtent,b=u.maxExtent,g=s.title&&u.items[l[2]].items[0],y=u.titlePadding,x=u.bounds,p=0,v=0;$.clear().union(x),x.clear(),(a=l[0])>-1&&x.union(u.items[a].bounds);(a=l[1])>-1&&x.union(u.items[a].bounds);switch(d){case E:p=h||0,v=-f,i=Math.max(m,Math.min(b,-x.y1)),g&&(g.auto?(i+=y,g.y=-i,i+=g.bounds.height(),x.add(g.bounds.x1,0).add(g.bounds.x2,0)):x.union(g.bounds)),x.add(0,-i).add(c,0);break;case z:p=-f,v=h||0,i=Math.max(m,Math.min(b,-x.x1)),g&&(g.auto?(i+=y,g.x=-i,i+=g.bounds.width(),x.add(0,g.bounds.y1).add(0,g.bounds.y2)):x.union(g.bounds)),x.add(-i,0).add(0,c);break;case D:p=o+f,v=h||0,i=Math.max(m,Math.min(b,x.x2)),g&&(g.auto?(i+=y,g.x=i,i+=g.bounds.width(),x.add(0,g.bounds.y1).add(0,g.bounds.y2)):x.union(g.bounds)),x.add(0,0).add(i,c);break;case _:p=h||0,v=r+f,i=Math.max(m,Math.min(b,x.y2)),g&&(g.auto?(i+=y,g.y=i,i+=g.bounds.height(),x.add(g.bounds.x1,0).add(g.bounds.x2,0)):x.union(g.bounds)),x.add(0,0).add(c,i);break;default:p=u.x,v=u.y}e.boundStroke(x.translate(p,v),u),w(u,"x",p+Z)|w(u,"y",v+Z)&&(u.bounds=$,n.dirty(u),u.bounds=x,n.dirty(u));return u.mark.bounds.clear().union(x)}(n,a,c,f)),(k(a)?b:g).union(u);break;case V:r=a;break;case J:y.push(a);break;case W:case K:case N:case Q:case X:case Y:b.union(a.bounds),g.union(a.bounds);break;default:h.union(a.bounds)}if(r&&(m.union(u=function(n,t,e){var o=t.items[0],r=o.datum.orient,a=o.offset,i=o.bounds,u=0,s=0;switch($.clear().union(i),r){case E:u=o.x,s=e.y1-a;break;case z:u=e.x1-a,s=o.y;break;case D:u=e.x2+a,s=o.y;break;case _:u=o.x,s=e.y2+a;break;default:u=o.x,s=o.y}i.translate(u-o.x,s-o.y),w(o,"x",u)|w(o,"y",s)&&(o.bounds=$,n.dirty(o),o.bounds=i,n.dirty(o));return t.bounds.clear().union(i)}(n,r,m)),(k(r)?b:g).union(u)),y.length)for(i={left:0,right:0,top:0,bottom:0,margin:o.legendMargin||8},s=0,d=y.length;s<d;++s)if(u=function(n,t,o,r,a,i,u){var s,d,l,c=t.items[0],f=c.datum.orient,h=c.offset,m=c.bounds,b=0,g=0;f===E||f===_?(l=a,b=o[f]):f!==z&&f!==D||(l=r,g=o[f]);switch($.clear().union(m),m.clear(),c.items.forEach(function(n){m.union(n.bounds)}),s=Math.round(m.width())+2*c.padding-1,d=Math.round(m.height())+2*c.padding-1,f){case z:b-=s+h-Math.floor(l.x1),o.left+=d+o.margin;break;case D:b+=h+Math.ceil(l.x2),o.right+=d+o.margin;break;case E:g-=d+h-Math.floor(l.y1),o.top+=s+o.margin;break;case _:g+=h+Math.ceil(l.y2),o.bottom+=s+o.margin;break;case"top-left":b+=h,g+=h;break;case"top-right":b+=i-s-h,g+=h;break;case"bottom-left":b+=h,g+=u-d-h;break;case"bottom-right":b+=i-s-h,g+=u-d-h;break;default:b=c.x,g=c.y}e.boundStroke(m.set(b,g,b+s,g+d),c),w(c,"x",b)|w(c,"width",s)|w(c,"y",g)|w(c,"height",d)&&(c.bounds=$,n.dirty(c),c.bounds=m,n.dirty(c));return c.mark.bounds.clear().union(m)}(n,y[s],i,b,g,c,f),o.autosize&&o.autosize.type===L){var x=y[s].items[0].datum.orient;x===z||x===D?h.add(u.x1,0).add(u.x2,0):x!==E&&x!==_||h.add(0,u.y1).add(0,u.y2)}else h.union(u);h.union(b).union(g).union(m),function(n,t,e,o){var r=o.autosize||{},a=r.type,i=n._width,u=n._height,s=n.padding();if(n._autosize<1||!a)return;var d=Math.max(0,t.width||0),l=Math.max(0,Math.ceil(-e.x1)),c=Math.max(0,Math.ceil(e.x2-d)),f=Math.max(0,t.height||0),h=Math.max(0,Math.ceil(-e.y1)),m=Math.max(0,Math.ceil(e.y2-f));r.contains===C&&(i-=s.left+s.right,u-=s.top+s.bottom);a===R?(l=0,h=0,d=i,f=u):a===L?(d=Math.max(0,i-l-c),f=Math.max(0,u-h-m)):a===P&&(i=d+l+c,u=f+h+m);n._resizeView(i,u,d,f,[l,h],r.resize)}(n,t,h,o)}function w(n,t,e){return n[t]===e?0:(n[t]=e,1)}function k(n){var t=n.items[0].datum.orient;return t===z||t===D}var M=o.inherits(r,t.Transform),T=new e.Bounds;M.transform=function(n,t){var o,r=t.dataflow,i=n.mark,u=i.marktype,s=e.Marks[u],d=s.bound,l=i.clip,c=i.bounds;return s.nested?(i.items.length&&r.dirty(i.items[0]),c=a(i,d),i.items.forEach(function(n){n.bounds.clear().union(c)})):"group"===u||n.modified()?(t.visit(t.MOD,function(n){r.dirty(n)}),c.clear(),i.items.forEach(function(n){c.union(a(n,d))})):(o=t.changed(t.REM),t.visit(t.ADD,function(n){c.union(a(n,d))}),t.visit(t.MOD,function(n){o=o||c.alignsWith(n.bounds),r.dirty(n),c.union(a(n,d))}),o&&!l&&(c.clear(),i.items.forEach(function(n){c.union(n.bounds)}))),l&&c.intersect(T.set(0,0,i.group.width,i.group.height)),t.modifies("bounds")};var B=":vega_identifier:";i.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]};o.inherits(i,t.Transform).transform=function(n,t){var e=function(n){var t=n._signals[B];return t||(n._signals[B]=t=n.add(0)),t}(t.dataflow),o=e.value,r=n.as;return t.visit(t.ADD,function(n){n[r]||(n[r]=++o)}),e.set(this.value=o),t};o.inherits(u,t.Transform).transform=function(n,t){var o=this.value;o||((o=t.dataflow.scenegraph().mark(n.markdef,function(n){var t=n.groups,e=n.parent;return t&&1===t.size?t.get(Object.keys(t.object)[0]):t&&e?t.lookup(e):null}(n),n.index)).group.context=n.context,n.context.group||(n.context.group=o.group),o.source=this,this.value=o);var r="group"===o.marktype?e.GroupItem:e.Item;return t.visit(t.ADD,function(n){r.call(n,o)}),o.items=t.source,t};var E="top",z="left",D="right",_="bottom",O={parity:function(n){return n.filter(function(n,t){return t%2?n.opacity=0:1})},greedy:function(n){var t;return n.filter(function(n,e){return e&&d(t.bounds,n.bounds)?n.opacity=0:(t=n,1)})}};o.inherits(s,t.Transform).transform=function(n,t){var r=O[n.method]||O.parity,a=t.materialize(t.SOURCE).source;if(a){n.sort&&(a=a.slice().sort(n.sort)),"greedy"===n.method&&(a=a.filter(c)),a.forEach(function(n){n.opacity=1});var i=a;if(i.length>=3&&l(i)){t=t.reflow(n.modified()).modifies("opacity");do{i=r(i)}while(i.length>=3&&l(i));i.length<3&&!o.peek(a).opacity&&(i.length>1&&(o.peek(i).opacity=0),o.peek(a).opacity=1)}if(n.boundScale){var u=function(n,t,o){var r=n.range(),a=new e.Bounds;return t===E||t===_?a.set(r[0],-1/0,r[1],1/0):a.set(-1/0,r[0],1/0,r[1]),a.expand(o||1),function(n){return a.encloses(n.bounds)}}(n.boundScale,n.boundOrient,n.boundTolerance);a.forEach(function(n){u(n)||(n.opacity=0)})}return t}};o.inherits(f,t.Transform).transform=function(n,t){var e=t.dataflow;if(t.visit(t.ALL,function(n){e.dirty(n)}),t.fields&&t.fields.zindex){var o=t.source&&t.source[0];o&&(o.mark.zdirty=!0)}};var j="axis",S="legend",q="row-header",A="row-footer",I="row-title",F="column-header",G="column-footer",H="column-title",L="fit",P="pad",R="none",C="padding",U="axis",V="title",W="frame",J="legend",K="scope",N="row-header",Q="row-footer",X="column-header",Y="column-footer",Z=.5,$=new e.Bounds;o.inherits(p,t.Transform).transform=function(n,t){var e=t.dataflow;return n.mark.items.forEach(function(t){n.layout&&g(e,t,n.layout),v(e,t,n)}),t},n.bound=r,n.identifier=i,n.mark=u,n.overlap=s,n.render=f,n.viewlayout=p,Object.defineProperty(n,"__esModule",{value:!0})});