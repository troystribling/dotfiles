!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("vega-util"),require("vega-dataflow"),require("vega-scenegraph"),require("d3-array"),require("vega-parser"),require("vega-runtime")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-scenegraph","d3-array","vega-parser","vega-runtime"],n):n(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega)}(this,function(e,n,t,r,i,a,u){"use strict";function o(e){"undefined"!=typeof document&&document.body&&(document.body.style.cursor=e)}function s(e,t){var r=e._runtime.data;return r.hasOwnProperty(t)||n.error("Unrecognized data set: "+t),r[t]}function d(e,r){t.isChangeSet(r)||n.error("Second argument to changes must be a changeset.");var i=s(this,e);return i.modified=!0,this.pulse(i.input,r)}function l(e){var n=e.padding();return Math.max(0,e._viewWidth+n.left+n.right)}function c(e){var n=e.padding();return Math.max(0,e._viewHeight+n.top+n.bottom)}function h(e){var n=e.padding(),t=e._origin;return[n.left+t[0],n.top+t[1]]}function f(e){var n=h(e);e._renderer.background(e._background),e._renderer.resize(l(e),c(e),n),e._handler.origin(n)}function g(e,t,r){function i(e){var n,r=u;if(e)for(n=t;n;n=n.mark.group)if(n.mark.name===e){r=n;break}return r&&r.mark&&r.mark.interactive?r:{}}function a(e){if(!e)return r;n.isString(e)&&(e=i(e));for(var t=r.slice();e;)t[0]-=e.x||0,t[1]-=e.y||0,e=e.mark&&e.mark.group;return t}var u=t?"group"===t.mark.marktype?t:t.mark.group:null;return{view:n.constant(e),item:n.constant(t||{}),group:i,xy:a,x:function(e){return a(e)[0]},y:function(e){return a(e)[1]}}}function v(e){var t=(e=n.extend({},e)).defaults;return t&&(n.isArray(t.prevent)&&(t.prevent=n.toSet(t.prevent)),n.isArray(t.allow)&&(t.allow=n.toSet(t.allow))),e}function p(e,n){var t=e._eventConfig.defaults,r=t&&t.prevent,i=t&&t.allow;return!1!==r&&!0!==i&&(!0===r||!1===i||(r?r[n]:i?!i[n]:e.preventDefault()))}function _(e){return e.item}function m(e){var n=e.item.mark.source;return n.source||n}function w(e){return function(n,t){return t.vega.view().changeset().encode(t.item,e)}}function y(e,n,t,r){var i=P("div",{class:j});i.appendChild(P("span",{class:G},t.name||t.signal)),n.appendChild(i);var a=z;switch(t.input){case"checkbox":a=b;break;case"select":a=k;break;case"radio":a=C;break;case"range":a=x}a(e,i,t,r)}function z(e,n,t,r){var i=P("input");for(var a in t)"signal"!==a&&"element"!==a&&i.setAttribute("input"===a?"type":a,t[a]);i.setAttribute("name",t.signal),i.value=r,n.appendChild(i),i.addEventListener("input",function(){e.update(i.value)}),e.elements=[i],e.set=function(e){i.value=e}}function b(e,n,t,r){var i={type:"checkbox",name:t.signal};r&&(i.checked=!0);var a=P("input",i);n.appendChild(a),a.addEventListener("change",function(){e.update(a.checked)}),e.elements=[a],e.set=function(e){a.checked=!!e||null}}function k(e,n,t,r){var i=P("select",{name:t.signal});t.options.forEach(function(e){var n={value:e};L(e,r)&&(n.selected=!0),i.appendChild(P("option",n,e+""))}),n.appendChild(i),i.addEventListener("change",function(){e.update(t.options[i.selectedIndex])}),e.elements=[i],e.set=function(e){for(var n=0,r=t.options.length;n<r;++n)if(L(t.options[n],e))return void(i.selectedIndex=n)}}function C(e,n,t,r){var i=P("span",{class:I});n.appendChild(i),e.elements=t.options.map(function(n){var a=B+t.signal+"-"+n,u={id:a,type:"radio",name:t.signal,value:n};L(n,r)&&(u.checked=!0);var o=P("input",u);return o.addEventListener("change",function(){e.update(n)}),i.appendChild(o),i.appendChild(P("label",{for:a},n+"")),o}),e.set=function(n){for(var t=e.elements,r=0,i=t.length;r<i;++r)L(t[r].value,n)&&(t[r].checked=!0)}}function x(e,n,t,r){function a(){l.textContent=d.value,e.update(+d.value)}r=void 0!==r?r:(+t.max+ +t.min)/2;var u=t.min||Math.min(0,+r)||0,o=t.max||Math.max(100,+r)||100,s=t.step||i.tickStep(u,o,100),d=P("input",{type:"range",name:t.signal,min:u,max:o,step:s});d.value=r;var l=P("label",{},+r);n.appendChild(d),n.appendChild(l),d.addEventListener("input",a),d.addEventListener("change",a),e.elements=[d],e.set=function(e){d.value=e,l.textContent=e}}function L(e,n){return e===n||e+""==n+""}function S(e,n){if("string"==typeof n){if("undefined"==typeof document)return e.error("DOM document instance not found."),null;if(!(n=document.querySelector(n)))return e.error("Signal bind element not found: "+n),null}if(n)try{n.innerHTML=""}catch(t){n=null,e.error(t)}return n}function T(e,n){var t=new Blob([e],{type:n});return window.URL.createObjectURL(t)}function E(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===X?r.left+r.right:0)}function H(e,n){var t=e.autosize(),r=e.padding();return n-(t&&t.contains===X?r.top+r.bottom:0)}function A(e){function n(){e._autosize=e._resize=1}var t=e._signals,r=t.width,i=t.height,a=t.padding;e._resizeWidth=e.add(null,function(t){e._width=t.size,e._viewWidth=E(e,t.size),n()},{size:r}),e._resizeHeight=e.add(null,function(t){e._height=t.size,e._viewHeight=H(e,t.size),n()},{size:i});var u=e.add(null,n,{pad:a});e._resizeWidth.rank=r.rank+1,e._resizeHeight.rank=i.rank+1,u.rank=a.rank+1}function D(e,t){return t.modified&&n.isArray(t.input.value)&&e.indexOf("_:vega:_")}function R(e,n){return!("parent"===e||n instanceof t.transforms.proxy)}function M(e,i){var a=this;i=i||{},t.Dataflow.call(a),a.loader(i.loader||a._loader),a.logLevel(i.logLevel||0),a._el=null,a._renderType=i.renderer||r.RenderType.Canvas,a._scenegraph=new r.Scenegraph;var u=a._scenegraph.root;a._renderer=null,a._redraw=!0,a._handler=(new r.CanvasHandler).scene(u),a._eventListeners=[],a._preventDefault=!1;var o=Q(a,e,i.functions);a._runtime=o,a._signals=o.signals,a._bind=(e.bindings||[]).map(function(e){return{state:null,param:n.extend({},e)}}),o.root&&o.root.set(u),u.source=o.data.root.input,a.pulse(o.data.root.input,a.changeset().insert(u.items)),a._background=o.background||null,a._eventConfig=v(o.eventConfig),a._width=a.width(),a._height=a.height(),a._viewWidth=E(a,a._width),a._viewHeight=H(a,a._height),a._origin=[0,0],a._resize=0,a._autosize=1,A(a),q(a)}function U(e,t){return e._signals.hasOwnProperty(t)?e._signals[t]:n.error("Unrecognized signal name: "+n.stringValue(t))}var q=function(e){var t=e._signals.cursor;t||(e._signals.cursor=t=e.add({user:"default",item:null})),e.on(e.events("view","mousemove"),t,function(e,r){var i=t.value,a=i?n.isString(i)?i:i.user:"default",u=r.item&&r.item.cursor||null;return i&&a===i.user&&u==i.item?i:{user:a,item:u}}),e.add(null,function(e){var t=e.cursor,r=this.value;return n.isString(t)||(r=t.item,t=t.user),o(t&&"default"!==t?t:r||t),r},{cursor:t})},W=function(e,n,t){var i,a,u,o=e._renderer.scene();return o&&(u=h(e),a=n.changedTouches?n.changedTouches[0]:n,(i=r.point(a,o))[0]-=u[0],i[1]-=u[1]),n.dataflow=e,n.vega=g(e,t,i),n.item=t,n},V="view",O="window",P=function(e,n,t){var r=document.createElement(e);for(var i in n)r.setAttribute(i,n[i]);return null!=t&&(r.textContent=t),r},j="vega-bind",G="vega-bind-name",I="vega-bind-radio",B="vega-option-",N=function(e,t,r){if(t){var i=r.param,a=r.state;return a||(a=r.state={elements:null,active:!1,set:null,update:function(n){a.source=!0,e.signal(i.signal,n).run()}},i.debounce&&(a.update=n.debounce(i.debounce,a.update))),y(a,t,i,e.signal(i.signal)),a.active||(e.on(e._signals[i.signal],null,function(){a.source?a.source=!1:a.set(e.signal(i.signal))}),a.active=!0),a}},F=function(e,n,t,r,i){return(n=n||new r(e.loader())).initialize(t,l(e),c(e),h(e),i).background(e._background)},J=function(e,n,t,r){var i=(new r).scene(e.scenegraph().root).initialize(t,h(e),e);return n&&(i.handleTooltip=n.handleTooltip,n.handlers().forEach(function(e){i.on(e.type,e.handler)})),i},K=function(e,n,t){var i=r.renderModule(n),a=i&&i.headless;return a?e.runAsync().then(function(){return F(e,null,null,a,t).renderAsync(e._scenegraph.root)}):Promise.reject("Unrecognized renderer type: "+n)},Q=function(e,n,r){var i=r||a.functionContext;return u.parse(n,u.context(e,t.transforms,i))},X="padding",Y=n.inherits(M,t.Dataflow);Y.run=function(e){if(t.Dataflow.prototype.run.call(this,e),this._redraw||this._resize)try{this.render()}catch(e){this.error(e)}return this},Y.render=function(){return this._renderer&&(this._resize&&(this._resize=0,f(this)),this._renderer.render(this._scenegraph.root)),this._redraw=!1,this},Y.dirty=function(e){this._redraw=!0,this._renderer&&this._renderer.dirty(e)},Y.container=function(){return this._el},Y.scenegraph=function(){return this._scenegraph},Y.signal=function(e,n,t){var r=U(this,e);return 1===arguments.length?r.value:this.update(r,n,t)},Y.background=function(e){return arguments.length?(this._background=e,this._resize=1,this):this._background},Y.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},Y.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},Y.padding=function(e){return arguments.length?this.signal("padding",e):this.signal("padding")},Y.autosize=function(e){return arguments.length?this.signal("autosize",e):this.signal("autosize")},Y.renderer=function(e){return arguments.length?(r.renderModule(e)||n.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._renderType},Y.loader=function(e){return arguments.length?(e!==this._loader&&(t.Dataflow.prototype.loader.call(this,e),this._renderer&&(this._renderer=null,this.initialize(this._el))),this):this._loader},Y.resize=function(){return this._autosize=1,this},Y._resizeView=function(e,n,t,r,i,a){this.runAfter(function(u){var o=0;u._autosize=0,u.width()!==t&&(o=1,u.width(t),u._resizeWidth.skip(!0)),u.height()!==r&&(o=1,u.height(r),u._resizeHeight.skip(!0)),u._viewWidth!==e&&(u._resize=1,u._viewWidth=e),u._viewHeight!==n&&(u._resize=1,u._viewHeight=n),u._origin[0]===i[0]&&u._origin[1]===i[1]||(u._resize=1,u._origin=i),o&&u.run("enter"),a&&u.runAfter(function(){u.resize()})})},Y.addEventListener=function(e,n){return this._handler.on(e,n),this},Y.removeEventListener=function(e,n){return this._handler.off(e,n),this},Y.addSignalListener=function(e,n){var t=U(this,e),r=function(){n(e,t.value)};return r.handler=n,this.on(t,null,r),this},Y.removeSignalListener=function(e,n){var t=U(this,e)._targets||[],r=t.filter(function(e){var t=e._update;return t&&t.handler===n});return r.length&&t.remove(r[0]),this},Y.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},Y.tooltipHandler=function(e){var n=this._handler;return arguments.length?(n.handleTooltip=e||r.Handler.prototype.handleTooltip,this):n.handleTooltip},Y.events=function(e,n,r){var i,a=this,u=new t.EventStream(r),o=function(t,r){e===V&&p(a,n)&&t.preventDefault();try{u.receive(W(a,t,r))}catch(e){a.error(e)}finally{a.run()}};if(e===V)return a.addEventListener(n,o),u;if(e===O?"undefined"!=typeof window&&(i=[window]):"undefined"!=typeof document&&(i=document.querySelectorAll(e)),!i)return a.warn("Can not resolve event source: "+e),u;for(var s=0,d=i.length;s<d;++s)i[s].addEventListener(n,o);return a._eventListeners.push({type:n,sources:i,handler:o}),u},Y.finalize=function(){for(var e,n,t=this._eventListeners,r=t.length;--r>=0;)for(e=(n=t[r]).sources.length;--e>=0;)n.sources[e].removeEventListener(n.type,n.handler)},Y.hover=function(e,n){return e=[e||"hover"],n=[n||"update",e],this.on(this.events("view","mouseover",_),m,w(e)),this.on(this.events("view","mouseout",_),m,w(n)),this},Y.data=function(e){return s(this,e).values.value},Y.change=d,Y.insert=function(e,n){return d.call(this,e,t.changeset().insert(n))},Y.remove=function(e,n){return d.call(this,e,t.changeset().remove(n))},Y.initialize=function(e,n){var t,i,a=this,u=a._renderType,o=r.renderModule(u);return e=a._el=e?S(a,e):null,o||a.error("Unrecognized renderer type: "+u),t=o.handler||r.CanvasHandler,i=e?o.renderer:o.headless,a._renderer=i?F(a,a._renderer,e,i):null,a._handler=J(a,a._handler,e,t),a._redraw=!0,e&&(n=n?S(a,n):e.appendChild(P("div",{class:"vega-bindings"})),a._bind.forEach(function(e){e.param.element&&(e.element=S(a,e.param.element))}),a._bind.forEach(function(e){N(a,e.element||n,e)})),a},Y.toImageURL=function(e,n){return e!==r.RenderType.Canvas&&e!==r.RenderType.SVG&&e!==r.RenderType.PNG?Promise.reject("Unrecognized image type: "+e):K(this,e,n).then(function(n){return e===r.RenderType.SVG?T(n.svg(),"image/svg+xml"):n.canvas().toDataURL("image/png")})},Y.toCanvas=function(e){return K(this,r.RenderType.Canvas,e).then(function(e){return e.canvas()})},Y.toSVG=function(e){return K(this,r.RenderType.SVG,e).then(function(e){return e.svg()})},Y.getState=function(e){return this._runtime.getState(e||{data:D,signals:R,recurse:!0})},Y.setState=function(e){var n=this;return n._trigger=!1,n._runtime.setState(e),n.run().runAfter(function(){n._trigger=!0}),this},e.View=M,Object.defineProperty(e,"__esModule",{value:!0})});