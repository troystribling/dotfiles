Object.defineProperty(exports, "__esModule", {
  value: true
});

var _languageclient = require('../languageclient');

var _atom = require('atom');

var _vscodeJsonrpc = require('vscode-jsonrpc');

require('../server-manager');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _fuzzaldrinPlus = require('fuzzaldrin-plus');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Public: Adapts the language server protocol "textDocument/completion" to the Atom
// AutoComplete+ package.
class AutocompleteAdapter {
  constructor() {
    this._suggestionCache = new WeakMap();
    this._cancellationTokens = new WeakMap();
  }

  static canAdapt(serverCapabilities) {
    return serverCapabilities.completionProvider != null;
  }

  static canResolve(serverCapabilities) {
    return serverCapabilities.completionProvider != null && serverCapabilities.completionProvider.resolveProvider === true;
  }

  // Public: Obtain suggestion list for AutoComplete+ by querying the language server using
  // the `textDocument/completion` request.
  //
  // * `server` An {ActiveServer} pointing to the language server to query.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` An optional function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Promise} of an {Array} of {atom$AutocompleteSuggestion}s containing the
  // AutoComplete+ suggestions to display.
  async getSuggestions(server, request, onDidConvertCompletionItem) {
    const triggerChars = server.capabilities.completionProvider != null ? server.capabilities.completionProvider.triggerCharacters || [] : [];
    const triggerPoint = AutocompleteAdapter.getTriggerPoint(request, triggerChars);
    const prefixWithTrigger = AutocompleteAdapter.getPrefixWithTrigger(request, triggerPoint);

    const cache = this._suggestionCache.get(server);

    // We have cached suggestions and should use them
    if (cache && !cache.isIncomplete && cache.triggerPoint.isEqual(triggerPoint)) {
      const suggestions = Array.from(cache.suggestionMap.keys());
      AutocompleteAdapter.setReplacementPrefixOnSuggestions(suggestions, request.prefix);
      return prefixWithTrigger.length === 1 ? suggestions : (0, _fuzzaldrinPlus.filter)(suggestions, request.prefix, { key: 'text' });
    }

    // We either don't have suggestions or they are incomplete so request from the language server
    const completions = await _utils2.default.doWithCancellationToken(server.connection, this._cancellationTokens, cancellationToken => server.connection.completion(AutocompleteAdapter.createCompletionParams(request, prefixWithTrigger[0]), cancellationToken));
    const isIncomplete = !Array.isArray(completions) && completions.isIncomplete;
    const suggestionMap = this.completionItemsToSuggestions(completions, request, onDidConvertCompletionItem);
    this._suggestionCache.set(server, { isIncomplete, triggerPoint, suggestionMap });
    return Array.from(suggestionMap.keys());
  }

  // Public: Obtain a complete version of a suggestion with additional information
  // the language server can provide by way of the `completionItem/resolve` request.
  //
  // * `server` An {ActiveServer} pointing to the language server to query.
  // * `suggestion` An {atom$AutocompleteSuggestion} suggestion that should be resolved.
  // * `request` An {Object} with the AutoComplete+ request to satisfy.
  // * `onDidConvertCompletionItem` An optional function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Promise} of an {atom$AutocompleteSuggestion} with the resolved AutoComplete+ suggestion.
  async completeSuggestion(server, suggestion, request, onDidConvertCompletionItem) {
    const cache = this._suggestionCache.get(server);
    if (cache) {
      const originalCompletionItem = cache.suggestionMap.get(suggestion);
      if (originalCompletionItem != null && originalCompletionItem[1] === false) {
        const resolvedCompletionItem = await server.connection.completionItemResolve(originalCompletionItem[0]);
        if (resolvedCompletionItem != null) {
          AutocompleteAdapter.completionItemToSuggestion(resolvedCompletionItem, suggestion, request, onDidConvertCompletionItem);
          originalCompletionItem[1] = true;
        }
      }
    }

    return suggestion;
  }

  // Public: Set the replacementPrefix property on all given suggestions to the
  // prefix specified.
  //
  // * `suggestions` An {Array} of {atom$AutocompleteSuggestion}s to set the replacementPrefix on.
  // * `prefix` The {string} containing the prefix that should be set as replacementPrefix on all suggestions.
  static setReplacementPrefixOnSuggestions(suggestions, prefix) {
    for (const suggestion of suggestions) {
      suggestion.replacementPrefix = prefix;
    }
  }

  // Public: Get the point where the trigger character occurred.
  //
  // * `request` An {Array} of {atom$AutocompleteSuggestion}s to set the replacementPrefix on.
  // * `triggerChars` The {Array} of {string}s that can be trigger characters.
  //
  // Returns the {atom$Point} where the trigger occurred.
  static getTriggerPoint(request, triggerChars) {
    if (triggerChars.includes(request.prefix)) {
      return _atom.Point.fromObject(request.bufferPosition, true);
    }

    return new _atom.Point(request.bufferPosition.row, request.bufferPosition.column - request.prefix.length);
  }

  // Public: Create TextDocumentPositionParams to be sent to the language server
  // based on the editor and position from the AutoCompleteRequest.
  //
  // * `request` The {atom$AutocompleteRequest} to obtain the trigger and editor from.
  // * `triggerPoint` The {atom$Point} where the trigger started.
  //
  // Returns a {string} containing the prefix including the trigger character.
  static getPrefixWithTrigger(request, triggerPoint) {
    return request.editor.getBuffer().getTextInRange([[triggerPoint.row, triggerPoint.column - 1], request.bufferPosition]);
  }

  // Public: Create {CompletionParams} to be sent to the language server
  // based on the editor and position from the Autocomplete request etc.
  //
  // * `request` The {atom$AutocompleteRequest} containing the request details.
  // * `triggerCharacter` The nullable {string} containing the trigger character.
  //
  // Returns an {CompletionParams} with the keys:
  //  * `textDocument` the language server protocol textDocument identification.
  //  * `position` the position within the text document to display completion request for.
  //  * `context` containing the trigger character and kind.
  static createCompletionParams(request, triggerCharacter) {
    return {
      textDocument: _convert2.default.editorToTextDocumentIdentifier(request.editor),
      position: _convert2.default.pointToPosition(request.bufferPosition),
      context: AutocompleteAdapter.createCompletionContext(triggerCharacter)
    };
  }

  // Public: Create {CompletionContext} to be sent to the language server
  // based on the trigger character.
  //
  // * `triggerCharacter` The nullable {string} containing the trigger character.
  //
  // Returns an {CompletionContext} that specifies the triggerKind and the triggerCharacter
  // if there is one.
  static createCompletionContext(triggerCharacter) {
    return triggerCharacter == null ? { triggerKind: _languageclient.CompletionTriggerKind.Invoked } : { triggerKind: _languageclient.CompletionTriggerKind.TriggerCharacter, triggerCharacter };
  }

  // Public: Convert a language server protocol CompletionItem array or CompletionList to
  // an array of ordered AutoComplete+ suggestions.
  //
  // * `completionItems` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //           items to be converted.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` A function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Map} of AutoComplete+ suggestions ordered by the CompletionItems sortText.
  completionItemsToSuggestions(completionItems, request, onDidConvertCompletionItem) {
    return new Map((Array.isArray(completionItems) ? completionItems : completionItems.items || []).sort((a, b) => (a.sortText || a.label).localeCompare(b.sortText || b.label)).map(s => [AutocompleteAdapter.completionItemToSuggestion(s, {}, request, onDidConvertCompletionItem), [s, false]]));
  }

  // Public: Convert a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {CompletionItem} containing a completion item to be converted.
  // * `suggestion` A {atom$AutocompleteSuggestion} to have the conversion applied to.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` A function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns the {atom$AutocompleteSuggestion} passed in as suggestion with the conversion applied.
  static completionItemToSuggestion(item, suggestion, request, onDidConvertCompletionItem) {
    AutocompleteAdapter.applyCompletionItemToSuggestion(item, suggestion);
    AutocompleteAdapter.applyTextEditToSuggestion(item.textEdit, request.editor, suggestion);
    AutocompleteAdapter.applySnippetToSuggestion(item, suggestion);
    if (onDidConvertCompletionItem != null) {
      onDidConvertCompletionItem(item, suggestion, request);
    }

    return suggestion;
  }

  // Public: Convert the primary parts of a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {CompletionItem} containing the completion items to be merged into.
  // * `suggestion` The {atom$AutocompleteSuggestion} to merge the conversion into.
  //
  // Returns an {atom$AutocompleteSuggestion} created from the {CompletionItem}.
  static applyCompletionItemToSuggestion(item, suggestion) {
    suggestion.text = item.insertText || item.label;
    suggestion.displayText = item.label;
    suggestion.type = AutocompleteAdapter.completionKindToSuggestionType(item.kind);
    suggestion.rightLabel = item.detail;
    suggestion.description = item.documentation;
    suggestion.descriptionMarkdown = item.documentation;
  }

  // Public: Applies the textEdit part of a language server protocol CompletionItem to an
  // AutoComplete+ Suggestion via the replacementPrefix and text properties.
  //
  // * `textEdit` A {TextEdit} from a CompletionItem to apply.
  // * `editor` An Atom {TextEditor} used to obtain the necessary text replacement.
  // * `suggestion` An {atom$AutocompleteSuggestion} to set the replacementPrefix and text properties of.
  static applyTextEditToSuggestion(textEdit, editor, suggestion) {
    if (textEdit != null) {
      suggestion.replacementPrefix = editor.getTextInBufferRange(_convert2.default.lsRangeToAtomRange(textEdit.range));
      suggestion.text = textEdit.newText;
    }
  }

  // Public: Adds a snippet to the suggestion if the CompletionItem contains
  // snippet-formatted text
  //
  // * `item` An {CompletionItem} containing the completion items to be merged into.
  // * `suggestion` The {atom$AutocompleteSuggestion} to merge the conversion into.
  //
  static applySnippetToSuggestion(item, suggestion) {
    if (item.insertTextFormat === _languageclient.InsertTextFormat.Snippet) {
      suggestion.snippet = item.textEdit != null ? item.textEdit.newText : item.insertText;
    }
  }

  // Public: Obtain the textual suggestion type required by AutoComplete+ that
  // most closely maps to the numeric completion kind supplies by the language server.
  //
  // * `kind` A {Number} that represents the suggestion kind to be converted.
  //
  // Returns a {String} containing the AutoComplete+ suggestion type equivalent
  // to the given completion kind.
  static completionKindToSuggestionType(kind) {
    switch (kind) {
      case _languageclient.CompletionItemKind.Constant:
        return 'constant';
      case _languageclient.CompletionItemKind.Method:
        return 'method';
      case _languageclient.CompletionItemKind.Function:
      case _languageclient.CompletionItemKind.Constructor:
        return 'function';
      case _languageclient.CompletionItemKind.Field:
      case _languageclient.CompletionItemKind.Property:
        return 'property';
      case _languageclient.CompletionItemKind.Variable:
        return 'variable';
      case _languageclient.CompletionItemKind.Class:
        return 'class';
      case _languageclient.CompletionItemKind.Struct:
      case _languageclient.CompletionItemKind.TypeParameter:
        return 'type';
      case _languageclient.CompletionItemKind.Operator:
        return 'selector';
      case _languageclient.CompletionItemKind.Interface:
        return 'mixin';
      case _languageclient.CompletionItemKind.Module:
        return 'module';
      case _languageclient.CompletionItemKind.Unit:
        return 'builtin';
      case _languageclient.CompletionItemKind.Enum:
      case _languageclient.CompletionItemKind.EnumMember:
        return 'enum';
      case _languageclient.CompletionItemKind.Keyword:
        return 'keyword';
      case _languageclient.CompletionItemKind.Snippet:
        return 'snippet';
      case _languageclient.CompletionItemKind.File:
      case _languageclient.CompletionItemKind.Folder:
        return 'import';
      case _languageclient.CompletionItemKind.Reference:
        return 'require';
      default:
        return 'value';
    }
  }
}
exports.default = AutocompleteAdapter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlci5qcyJdLCJuYW1lcyI6WyJBdXRvY29tcGxldGVBZGFwdGVyIiwiX3N1Z2dlc3Rpb25DYWNoZSIsIldlYWtNYXAiLCJfY2FuY2VsbGF0aW9uVG9rZW5zIiwiY2FuQWRhcHQiLCJzZXJ2ZXJDYXBhYmlsaXRpZXMiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJjYW5SZXNvbHZlIiwicmVzb2x2ZVByb3ZpZGVyIiwiZ2V0U3VnZ2VzdGlvbnMiLCJzZXJ2ZXIiLCJyZXF1ZXN0Iiwib25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0iLCJ0cmlnZ2VyQ2hhcnMiLCJjYXBhYmlsaXRpZXMiLCJ0cmlnZ2VyQ2hhcmFjdGVycyIsInRyaWdnZXJQb2ludCIsImdldFRyaWdnZXJQb2ludCIsInByZWZpeFdpdGhUcmlnZ2VyIiwiZ2V0UHJlZml4V2l0aFRyaWdnZXIiLCJjYWNoZSIsImdldCIsImlzSW5jb21wbGV0ZSIsImlzRXF1YWwiLCJzdWdnZXN0aW9ucyIsIkFycmF5IiwiZnJvbSIsInN1Z2dlc3Rpb25NYXAiLCJrZXlzIiwic2V0UmVwbGFjZW1lbnRQcmVmaXhPblN1Z2dlc3Rpb25zIiwicHJlZml4IiwibGVuZ3RoIiwia2V5IiwiY29tcGxldGlvbnMiLCJkb1dpdGhDYW5jZWxsYXRpb25Ub2tlbiIsImNvbm5lY3Rpb24iLCJjYW5jZWxsYXRpb25Ub2tlbiIsImNvbXBsZXRpb24iLCJjcmVhdGVDb21wbGV0aW9uUGFyYW1zIiwiaXNBcnJheSIsImNvbXBsZXRpb25JdGVtc1RvU3VnZ2VzdGlvbnMiLCJzZXQiLCJjb21wbGV0ZVN1Z2dlc3Rpb24iLCJzdWdnZXN0aW9uIiwib3JpZ2luYWxDb21wbGV0aW9uSXRlbSIsInJlc29sdmVkQ29tcGxldGlvbkl0ZW0iLCJjb21wbGV0aW9uSXRlbVJlc29sdmUiLCJjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsInJlcGxhY2VtZW50UHJlZml4IiwiaW5jbHVkZXMiLCJmcm9tT2JqZWN0IiwiYnVmZmVyUG9zaXRpb24iLCJyb3ciLCJjb2x1bW4iLCJlZGl0b3IiLCJnZXRCdWZmZXIiLCJnZXRUZXh0SW5SYW5nZSIsInRyaWdnZXJDaGFyYWN0ZXIiLCJ0ZXh0RG9jdW1lbnQiLCJlZGl0b3JUb1RleHREb2N1bWVudElkZW50aWZpZXIiLCJwb3NpdGlvbiIsInBvaW50VG9Qb3NpdGlvbiIsImNvbnRleHQiLCJjcmVhdGVDb21wbGV0aW9uQ29udGV4dCIsInRyaWdnZXJLaW5kIiwiSW52b2tlZCIsIlRyaWdnZXJDaGFyYWN0ZXIiLCJjb21wbGV0aW9uSXRlbXMiLCJNYXAiLCJpdGVtcyIsInNvcnQiLCJhIiwiYiIsInNvcnRUZXh0IiwibGFiZWwiLCJsb2NhbGVDb21wYXJlIiwibWFwIiwicyIsIml0ZW0iLCJhcHBseUNvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uIiwiYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbiIsInRleHRFZGl0IiwiYXBwbHlTbmlwcGV0VG9TdWdnZXN0aW9uIiwidGV4dCIsImluc2VydFRleHQiLCJkaXNwbGF5VGV4dCIsInR5cGUiLCJjb21wbGV0aW9uS2luZFRvU3VnZ2VzdGlvblR5cGUiLCJraW5kIiwicmlnaHRMYWJlbCIsImRldGFpbCIsImRlc2NyaXB0aW9uIiwiZG9jdW1lbnRhdGlvbiIsImRlc2NyaXB0aW9uTWFya2Rvd24iLCJnZXRUZXh0SW5CdWZmZXJSYW5nZSIsImxzUmFuZ2VUb0F0b21SYW5nZSIsInJhbmdlIiwibmV3VGV4dCIsImluc2VydFRleHRGb3JtYXQiLCJTbmlwcGV0Iiwic25pcHBldCIsIkNvbnN0YW50IiwiTWV0aG9kIiwiRnVuY3Rpb24iLCJDb25zdHJ1Y3RvciIsIkZpZWxkIiwiUHJvcGVydHkiLCJWYXJpYWJsZSIsIkNsYXNzIiwiU3RydWN0IiwiVHlwZVBhcmFtZXRlciIsIk9wZXJhdG9yIiwiSW50ZXJmYWNlIiwiTW9kdWxlIiwiVW5pdCIsIkVudW0iLCJFbnVtTWVtYmVyIiwiS2V5d29yZCIsIkZp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O0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFdBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0UsZUFBTyxPQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE1BQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLGFBQXhCO0FBQ0UsZUFBTyxNQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFNBQXhCO0FBQ0UsZUFBTyxPQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE1BQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFVBQXhCO0FBQ0UsZUFBTyxNQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJsQixPQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGLFdBQUssbUNBQW1CbUIsSUFBeEI7QUFDQSxXQUFLLG1DQUFtQkMsTUFBeEI7QUFDRSxlQUFPLFFBQVA7QUFDRixXQUFLLG1DQUFtQkMsU0FBeEI7QUFDRSxlQUFPLFNBQVA7QUFDRjtBQUNFLGVBQU8sT0FBUDtBQXZDSjtBQXlDRDtBQWpTc0M7a0JBQXBCeEgsbUIiLCJmaWxlIjoiYXV0b2NvbXBsZXRlLWFkYXB0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0IHtcclxuICBDb21wbGV0aW9uSXRlbUtpbmQsXHJcbiAgQ29tcGxldGlvblRyaWdnZXJLaW5kLFxyXG4gIEluc2VydFRleHRGb3JtYXQsXHJcbiAgTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLFxyXG4gIHR5cGUgQ29tcGxldGlvbkNvbnRleHQsXHJcbiAgdHlwZSBDb21wbGV0aW9uSXRlbSxcclxuICB0eXBlIENvbXBsZXRpb25MaXN0LFxyXG4gIHR5cGUgQ29tcGxldGlvblBhcmFtcyxcclxuICB0eXBlIFNlcnZlckNhcGFiaWxpdGllcyxcclxuICB0eXBlIFRleHRFZGl0LFxyXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IHtQb2ludH0gZnJvbSAnYXRvbSc7XHJcbmltcG9ydCB7Q2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2V9IGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuaW1wb3J0IHt0eXBlIEFjdGl2ZVNlcnZlcn0gZnJvbSAnLi4vc2VydmVyLW1hbmFnZXInO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuLi9jb252ZXJ0JztcclxuaW1wb3J0IHtmaWx0ZXJ9IGZyb20gJ2Z1enphbGRyaW4tcGx1cyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi91dGlscyc7XHJcblxyXG50eXBlIFN1Z2dlc3Rpb25DYWNoZUVudHJ5ID0ge1xyXG4gIGlzSW5jb21wbGV0ZTogYm9vbGVhbixcclxuICB0cmlnZ2VyUG9pbnQ6IGF0b20kUG9pbnQsXHJcbiAgc3VnZ2VzdGlvbk1hcDogTWFwPGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgW0NvbXBsZXRpb25JdGVtLCBib29sZWFuXT4sXHJcbn07XHJcblxyXG4vLyBQdWJsaWM6IEFkYXB0cyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIFwidGV4dERvY3VtZW50L2NvbXBsZXRpb25cIiB0byB0aGUgQXRvbVxyXG4vLyBBdXRvQ29tcGxldGUrIHBhY2thZ2UuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9jb21wbGV0ZUFkYXB0ZXIge1xyXG4gIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHNlcnZlckNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIgIT0gbnVsbDtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBjYW5SZXNvbHZlKHNlcnZlckNhcGFiaWxpdGllczogU2VydmVyQ2FwYWJpbGl0aWVzKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gc2VydmVyQ2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlciAhPSBudWxsICYmIHNlcnZlckNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIucmVzb2x2ZVByb3ZpZGVyID09PSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgX3N1Z2dlc3Rpb25DYWNoZTogV2Vha01hcDxBY3RpdmVTZXJ2ZXIsIFN1Z2dlc3Rpb25DYWNoZUVudHJ5PiA9IG5ldyBXZWFrTWFwKCk7XHJcbiAgX2NhbmNlbGxhdGlvblRva2VuczogV2Vha01hcDxMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sIENhbmNlbGxhdGlvblRva2VuU291cmNlPiA9IG5ldyBXZWFrTWFwKCk7XHJcblxyXG4gIC8vIFB1YmxpYzogT2J0YWluIHN1Z2dlc3Rpb24gbGlzdCBmb3IgQXV0b0NvbXBsZXRlKyBieSBxdWVyeWluZyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHVzaW5nXHJcbiAgLy8gdGhlIGB0ZXh0RG9jdW1lbnQvY29tcGxldGlvbmAgcmVxdWVzdC5cclxuICAvL1xyXG4gIC8vICogYHNlcnZlcmAgQW4ge0FjdGl2ZVNlcnZlcn0gcG9pbnRpbmcgdG8gdGhlIGxhbmd1YWdlIHNlcnZlciB0byBxdWVyeS5cclxuICAvLyAqIGByZXF1ZXN0YCBUaGUge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHtDb21wbGV0aW9uSXRlbX0sIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259XHJcbiAgLy8gICBhbmQgYSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGNvbnZlcnRlZCBpdGVtcy5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7UHJvbWlzZX0gb2YgYW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgY29udGFpbmluZyB0aGVcclxuICAvLyBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zIHRvIGRpc3BsYXkuXHJcbiAgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMoXHJcbiAgICBzZXJ2ZXI6IEFjdGl2ZVNlcnZlcixcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICAgIG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtPzogKENvbXBsZXRpb25JdGVtLCBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sIGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCkgPT4gdm9pZCxcclxuICApOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcclxuICAgIGNvbnN0IHRyaWdnZXJDaGFycyA9IHNlcnZlci5jYXBhYmlsaXRpZXMuY29tcGxldGlvblByb3ZpZGVyICE9IG51bGwgPyBzZXJ2ZXIuY2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlci50cmlnZ2VyQ2hhcmFjdGVycyB8fCBbXSA6IFtdO1xyXG4gICAgY29uc3QgdHJpZ2dlclBvaW50ID0gQXV0b2NvbXBsZXRlQWRhcHRlci5nZXRUcmlnZ2VyUG9pbnQocmVxdWVzdCwgdHJpZ2dlckNoYXJzKTtcclxuICAgIGNvbnN0IHByZWZpeFdpdGhUcmlnZ2VyID0gQXV0b2NvbXBsZXRlQWRhcHRlci5nZXRQcmVmaXhXaXRoVHJpZ2dlcihyZXF1ZXN0LCB0cmlnZ2VyUG9pbnQpO1xyXG5cclxuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fc3VnZ2VzdGlvbkNhY2hlLmdldChzZXJ2ZXIpO1xyXG5cclxuICAgIC8vIFdlIGhhdmUgY2FjaGVkIHN1Z2dlc3Rpb25zIGFuZCBzaG91bGQgdXNlIHRoZW1cclxuICAgIGlmIChjYWNoZSAmJiAhY2FjaGUuaXNJbmNvbXBsZXRlICYmIGNhY2hlLnRyaWdnZXJQb2ludC5pc0VxdWFsKHRyaWdnZXJQb2ludCkpIHtcclxuICAgICAgY29uc3Qgc3VnZ2VzdGlvbnMgPSBBcnJheS5mcm9tKGNhY2hlLnN1Z2dlc3Rpb25NYXAua2V5cygpKTtcclxuICAgICAgQXV0b2NvbXBsZXRlQWRhcHRlci5zZXRSZXBsYWNlbWVudFByZWZpeE9uU3VnZ2VzdGlvbnMoc3VnZ2VzdGlvbnMsIHJlcXVlc3QucHJlZml4KTtcclxuICAgICAgcmV0dXJuIHByZWZpeFdpdGhUcmlnZ2VyLmxlbmd0aCA9PT0gMSA/IHN1Z2dlc3Rpb25zIDogZmlsdGVyKHN1Z2dlc3Rpb25zLCByZXF1ZXN0LnByZWZpeCwge2tleTogJ3RleHQnfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gV2UgZWl0aGVyIGRvbid0IGhhdmUgc3VnZ2VzdGlvbnMgb3IgdGhleSBhcmUgaW5jb21wbGV0ZSBzbyByZXF1ZXN0IGZyb20gdGhlIGxhbmd1YWdlIHNlcnZlclxyXG4gICAgY29uc3QgY29tcGxldGlvbnMgPSBhd2FpdCBVdGlscy5kb1dpdGhDYW5jZWxsYXRpb25Ub2tlbihzZXJ2ZXIuY29ubmVjdGlvbiwgdGhpcy5fY2FuY2VsbGF0aW9uVG9rZW5zLCBjYW5jZWxsYXRpb25Ub2tlbiA9PlxyXG4gICAgICBzZXJ2ZXIuY29ubmVjdGlvbi5jb21wbGV0aW9uKEF1dG9jb21wbGV0ZUFkYXB0ZXIuY3JlYXRlQ29tcGxldGlvblBhcmFtcyhyZXF1ZXN0LCBwcmVmaXhXaXRoVHJpZ2dlclswXSksIGNhbmNlbGxhdGlvblRva2VuKSxcclxuICAgICk7XHJcbiAgICBjb25zdCBpc0luY29tcGxldGUgPSAhQXJyYXkuaXNBcnJheShjb21wbGV0aW9ucykgJiYgY29tcGxldGlvbnMuaXNJbmNvbXBsZXRlO1xyXG4gICAgY29uc3Qgc3VnZ2VzdGlvbk1hcCA9IHRoaXMuY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyhjb21wbGV0aW9ucywgcmVxdWVzdCwgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0pO1xyXG4gICAgdGhpcy5fc3VnZ2VzdGlvbkNhY2hlLnNldChzZXJ2ZXIsIHtpc0luY29tcGxldGUsIHRyaWdnZXJQb2ludCwgc3VnZ2VzdGlvbk1hcH0pO1xyXG4gICAgcmV0dXJuIEFycmF5LmZyb20oc3VnZ2VzdGlvbk1hcC5rZXlzKCkpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBPYnRhaW4gYSBjb21wbGV0ZSB2ZXJzaW9uIG9mIGEgc3VnZ2VzdGlvbiB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cclxuICAvLyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGNhbiBwcm92aWRlIGJ5IHdheSBvZiB0aGUgYGNvbXBsZXRpb25JdGVtL3Jlc29sdmVgIHJlcXVlc3QuXHJcbiAgLy9cclxuICAvLyAqIGBzZXJ2ZXJgIEFuIHtBY3RpdmVTZXJ2ZXJ9IHBvaW50aW5nIHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdG8gcXVlcnkuXHJcbiAgLy8gKiBgc3VnZ2VzdGlvbmAgQW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gc3VnZ2VzdGlvbiB0aGF0IHNob3VsZCBiZSByZXNvbHZlZC5cclxuICAvLyAqIGByZXF1ZXN0YCBBbiB7T2JqZWN0fSB3aXRoIHRoZSBBdXRvQ29tcGxldGUrIHJlcXVlc3QgdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHtDb21wbGV0aW9uSXRlbX0sIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259XHJcbiAgLy8gICBhbmQgYSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGNvbnZlcnRlZCBpdGVtcy5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7UHJvbWlzZX0gb2YgYW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gd2l0aCB0aGUgcmVzb2x2ZWQgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIGFzeW5jIGNvbXBsZXRlU3VnZ2VzdGlvbihcclxuICAgIHNlcnZlcjogQWN0aXZlU2VydmVyLFxyXG4gICAgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICAgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0/OiAoQ29tcGxldGlvbkl0ZW0sIGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KSA9PiB2b2lkLFxyXG4gICk6IFByb21pc2U8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPiB7XHJcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuX3N1Z2dlc3Rpb25DYWNoZS5nZXQoc2VydmVyKTtcclxuICAgIGlmIChjYWNoZSkge1xyXG4gICAgICBjb25zdCBvcmlnaW5hbENvbXBsZXRpb25JdGVtID0gY2FjaGUuc3VnZ2VzdGlvbk1hcC5nZXQoc3VnZ2VzdGlvbik7XHJcbiAgICAgIGlmIChvcmlnaW5hbENvbXBsZXRpb25JdGVtICE9IG51bGwgJiYgb3JpZ2luYWxDb21wbGV0aW9uSXRlbVsxXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICBjb25zdCByZXNvbHZlZENvbXBsZXRpb25JdGVtID0gYXdhaXQgc2VydmVyLmNvbm5lY3Rpb24uY29tcGxldGlvbkl0ZW1SZXNvbHZlKG9yaWdpbmFsQ29tcGxldGlvbkl0ZW1bMF0pO1xyXG4gICAgICAgIGlmIChyZXNvbHZlZENvbXBsZXRpb25JdGVtICE9IG51bGwpIHtcclxuICAgICAgICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24ocmVzb2x2ZWRDb21wbGV0aW9uSXRlbSwgc3VnZ2VzdGlvbiwgcmVxdWVzdCwgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0pO1xyXG4gICAgICAgICAgb3JpZ2luYWxDb21wbGV0aW9uSXRlbVsxXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHN1Z2dlc3Rpb247XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IFNldCB0aGUgcmVwbGFjZW1lbnRQcmVmaXggcHJvcGVydHkgb24gYWxsIGdpdmVuIHN1Z2dlc3Rpb25zIHRvIHRoZVxyXG4gIC8vIHByZWZpeCBzcGVjaWZpZWQuXHJcbiAgLy9cclxuICAvLyAqIGBzdWdnZXN0aW9uc2AgQW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgdG8gc2V0IHRoZSByZXBsYWNlbWVudFByZWZpeCBvbi5cclxuICAvLyAqIGBwcmVmaXhgIFRoZSB7c3RyaW5nfSBjb250YWluaW5nIHRoZSBwcmVmaXggdGhhdCBzaG91bGQgYmUgc2V0IGFzIHJlcGxhY2VtZW50UHJlZml4IG9uIGFsbCBzdWdnZXN0aW9ucy5cclxuICBzdGF0aWMgc2V0UmVwbGFjZW1lbnRQcmVmaXhPblN1Z2dlc3Rpb25zKHN1Z2dlc3Rpb25zOiBBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+LCBwcmVmaXg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgZm9yIChjb25zdCBzdWdnZXN0aW9uIG9mIHN1Z2dlc3Rpb25zKSB7XHJcbiAgICAgIHN1Z2dlc3Rpb24ucmVwbGFjZW1lbnRQcmVmaXggPSBwcmVmaXg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IEdldCB0aGUgcG9pbnQgd2hlcmUgdGhlIHRyaWdnZXIgY2hhcmFjdGVyIG9jY3VycmVkLlxyXG4gIC8vXHJcbiAgLy8gKiBgcmVxdWVzdGAgQW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgdG8gc2V0IHRoZSByZXBsYWNlbWVudFByZWZpeCBvbi5cclxuICAvLyAqIGB0cmlnZ2VyQ2hhcnNgIFRoZSB7QXJyYXl9IG9mIHtzdHJpbmd9cyB0aGF0IGNhbiBiZSB0cmlnZ2VyIGNoYXJhY3RlcnMuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIHRoZSB7YXRvbSRQb2ludH0gd2hlcmUgdGhlIHRyaWdnZXIgb2NjdXJyZWQuXHJcbiAgc3RhdGljIGdldFRyaWdnZXJQb2ludChyZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsIHRyaWdnZXJDaGFyczogQXJyYXk8c3RyaW5nPik6IGF0b20kUG9pbnQge1xyXG4gICAgaWYgKHRyaWdnZXJDaGFycy5pbmNsdWRlcyhyZXF1ZXN0LnByZWZpeCkpIHtcclxuICAgICAgcmV0dXJuIFBvaW50LmZyb21PYmplY3QocmVxdWVzdC5idWZmZXJQb3NpdGlvbiwgdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQb2ludChyZXF1ZXN0LmJ1ZmZlclBvc2l0aW9uLnJvdywgcmVxdWVzdC5idWZmZXJQb3NpdGlvbi5jb2x1bW4gLSByZXF1ZXN0LnByZWZpeC5sZW5ndGgpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgdG8gYmUgc2VudCB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyXHJcbiAgLy8gYmFzZWQgb24gdGhlIGVkaXRvciBhbmQgcG9zaXRpb24gZnJvbSB0aGUgQXV0b0NvbXBsZXRlUmVxdWVzdC5cclxuICAvL1xyXG4gIC8vICogYHJlcXVlc3RgIFRoZSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSB0byBvYnRhaW4gdGhlIHRyaWdnZXIgYW5kIGVkaXRvciBmcm9tLlxyXG4gIC8vICogYHRyaWdnZXJQb2ludGAgVGhlIHthdG9tJFBvaW50fSB3aGVyZSB0aGUgdHJpZ2dlciBzdGFydGVkLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtzdHJpbmd9IGNvbnRhaW5pbmcgdGhlIHByZWZpeCBpbmNsdWRpbmcgdGhlIHRyaWdnZXIgY2hhcmFjdGVyLlxyXG4gIHN0YXRpYyBnZXRQcmVmaXhXaXRoVHJpZ2dlcihyZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsIHRyaWdnZXJQb2ludDogYXRvbSRQb2ludCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gcmVxdWVzdC5lZGl0b3JcclxuICAgICAgLmdldEJ1ZmZlcigpXHJcbiAgICAgIC5nZXRUZXh0SW5SYW5nZShbW3RyaWdnZXJQb2ludC5yb3csIHRyaWdnZXJQb2ludC5jb2x1bW4gLSAxXSwgcmVxdWVzdC5idWZmZXJQb3NpdGlvbl0pO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUge0NvbXBsZXRpb25QYXJhbXN9IHRvIGJlIHNlbnQgdG8gdGhlIGxhbmd1YWdlIHNlcnZlclxyXG4gIC8vIGJhc2VkIG9uIHRoZSBlZGl0b3IgYW5kIHBvc2l0aW9uIGZyb20gdGhlIEF1dG9jb21wbGV0ZSByZXF1ZXN0IGV0Yy5cclxuICAvL1xyXG4gIC8vICogYHJlcXVlc3RgIFRoZSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBjb250YWluaW5nIHRoZSByZXF1ZXN0IGRldGFpbHMuXHJcbiAgLy8gKiBgdHJpZ2dlckNoYXJhY3RlcmAgVGhlIG51bGxhYmxlIHtzdHJpbmd9IGNvbnRhaW5pbmcgdGhlIHRyaWdnZXIgY2hhcmFjdGVyLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhbiB7Q29tcGxldGlvblBhcmFtc30gd2l0aCB0aGUga2V5czpcclxuICAvLyAgKiBgdGV4dERvY3VtZW50YCB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIHRleHREb2N1bWVudCBpZGVudGlmaWNhdGlvbi5cclxuICAvLyAgKiBgcG9zaXRpb25gIHRoZSBwb3NpdGlvbiB3aXRoaW4gdGhlIHRleHQgZG9jdW1lbnQgdG8gZGlzcGxheSBjb21wbGV0aW9uIHJlcXVlc3QgZm9yLlxyXG4gIC8vICAqIGBjb250ZXh0YCBjb250YWluaW5nIHRoZSB0cmlnZ2VyIGNoYXJhY3RlciBhbmQga2luZC5cclxuICBzdGF0aWMgY3JlYXRlQ29tcGxldGlvblBhcmFtcyhyZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsIHRyaWdnZXJDaGFyYWN0ZXI6ID9zdHJpbmcpOiBDb21wbGV0aW9uUGFyYW1zIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRleHREb2N1bWVudDogQ29udmVydC5lZGl0b3JUb1RleHREb2N1bWVudElkZW50aWZpZXIocmVxdWVzdC5lZGl0b3IpLFxyXG4gICAgICBwb3NpdGlvbjogQ29udmVydC5wb2ludFRvUG9zaXRpb24ocmVxdWVzdC5idWZmZXJQb3NpdGlvbiksXHJcbiAgICAgIGNvbnRleHQ6IEF1dG9jb21wbGV0ZUFkYXB0ZXIuY3JlYXRlQ29tcGxldGlvbkNvbnRleHQodHJpZ2dlckNoYXJhY3RlciksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUge0NvbXBsZXRpb25Db250ZXh0fSB0byBiZSBzZW50IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXJcclxuICAvLyBiYXNlZCBvbiB0aGUgdHJpZ2dlciBjaGFyYWN0ZXIuXHJcbiAgLy9cclxuICAvLyAqIGB0cmlnZ2VyQ2hhcmFjdGVyYCBUaGUgbnVsbGFibGUge3N0cmluZ30gY29udGFpbmluZyB0aGUgdHJpZ2dlciBjaGFyYWN0ZXIuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGFuIHtDb21wbGV0aW9uQ29udGV4dH0gdGhhdCBzcGVjaWZpZXMgdGhlIHRyaWdnZXJLaW5kIGFuZCB0aGUgdHJpZ2dlckNoYXJhY3RlclxyXG4gIC8vIGlmIHRoZXJlIGlzIG9uZS5cclxuICBzdGF0aWMgY3JlYXRlQ29tcGxldGlvbkNvbnRleHQodHJpZ2dlckNoYXJhY3RlcjogP3N0cmluZyk6IENvbXBsZXRpb25Db250ZXh0IHtcclxuICAgIHJldHVybiB0cmlnZ2VyQ2hhcmFjdGVyID09IG51bGxcclxuICAgICAgPyB7dHJpZ2dlcktpbmQ6IENvbXBsZXRpb25UcmlnZ2VyS2luZC5JbnZva2VkfVxyXG4gICAgICA6IHt0cmlnZ2VyS2luZDogQ29tcGxldGlvblRyaWdnZXJLaW5kLlRyaWdnZXJDaGFyYWN0ZXIsIHRyaWdnZXJDaGFyYWN0ZXJ9O1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIGFycmF5IG9yIENvbXBsZXRpb25MaXN0IHRvXHJcbiAgLy8gYW4gYXJyYXkgb2Ygb3JkZXJlZCBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zLlxyXG4gIC8vXHJcbiAgLy8gKiBgY29tcGxldGlvbkl0ZW1zYCBBbiB7QXJyYXl9IG9mIHtDb21wbGV0aW9uSXRlbX0gb2JqZWN0cyBvciBhIHtDb21wbGV0aW9uTGlzdH0gY29udGFpbmluZyBjb21wbGV0aW9uXHJcbiAgLy8gICAgICAgICAgIGl0ZW1zIHRvIGJlIGNvbnZlcnRlZC5cclxuICAvLyAqIGByZXF1ZXN0YCBUaGUge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQSBmdW5jdGlvbiB0aGF0IHRha2VzIGEge0NvbXBsZXRpb25JdGVtfSwgYW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn1cclxuICAvLyAgIGFuZCBhIHthdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3R9IGFsbG93aW5nIHlvdSB0byBhZGp1c3QgY29udmVydGVkIGl0ZW1zLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtNYXB9IG9mIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbnMgb3JkZXJlZCBieSB0aGUgQ29tcGxldGlvbkl0ZW1zIHNvcnRUZXh0LlxyXG4gIGNvbXBsZXRpb25JdGVtc1RvU3VnZ2VzdGlvbnMoXHJcbiAgICBjb21wbGV0aW9uSXRlbXM6IEFycmF5PENvbXBsZXRpb25JdGVtPiB8IENvbXBsZXRpb25MaXN0LFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICAgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0/OiAoQ29tcGxldGlvbkl0ZW0sIGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KSA9PiB2b2lkLFxyXG4gICk6IE1hcDxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sIFtDb21wbGV0aW9uSXRlbSwgYm9vbGVhbl0+IHtcclxuICAgIHJldHVybiBuZXcgTWFwKChBcnJheS5pc0FycmF5KGNvbXBsZXRpb25JdGVtcykgPyBjb21wbGV0aW9uSXRlbXMgOiBjb21wbGV0aW9uSXRlbXMuaXRlbXMgfHwgW10pXHJcbiAgICAgIC5zb3J0KChhLCBiKSA9PiAoYS5zb3J0VGV4dCB8fCBhLmxhYmVsKS5sb2NhbGVDb21wYXJlKGIuc29ydFRleHQgfHwgYi5sYWJlbCkpXHJcbiAgICAgIC5tYXAocyA9PiBbQXV0b2NvbXBsZXRlQWRhcHRlci5jb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihzLCB7IH0sIHJlcXVlc3QsIG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtKSwgW3MsIGZhbHNlXV0pKTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXHJcbiAgLy9cclxuICAvLyAqIGBpdGVtYCBBbiB7Q29tcGxldGlvbkl0ZW19IGNvbnRhaW5pbmcgYSBjb21wbGV0aW9uIGl0ZW0gdG8gYmUgY29udmVydGVkLlxyXG4gIC8vICogYHN1Z2dlc3Rpb25gIEEge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gdG8gaGF2ZSB0aGUgY29udmVyc2lvbiBhcHBsaWVkIHRvLlxyXG4gIC8vICogYHJlcXVlc3RgIFRoZSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSB0byBzYXRpc2Z5LlxyXG4gIC8vICogYG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtYCBBIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYSB7Q29tcGxldGlvbkl0ZW19LCBhbiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufVxyXG4gIC8vICAgYW5kIGEge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gYWxsb3dpbmcgeW91IHRvIGFkanVzdCBjb252ZXJ0ZWQgaXRlbXMuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIHRoZSB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufSBwYXNzZWQgaW4gYXMgc3VnZ2VzdGlvbiB3aXRoIHRoZSBjb252ZXJzaW9uIGFwcGxpZWQuXHJcbiAgc3RhdGljIGNvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKFxyXG4gICAgaXRlbTogQ29tcGxldGlvbkl0ZW0sXHJcbiAgICBzdWdnZXN0aW9uOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sXHJcbiAgICByZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsXHJcbiAgICBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbT86IChDb21wbGV0aW9uSXRlbSwgYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLCBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QpID0+IHZvaWQsXHJcbiAgKTogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uIHtcclxuICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuYXBwbHlDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihpdGVtLCBzdWdnZXN0aW9uKTtcclxuICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbihpdGVtLnRleHRFZGl0LCByZXF1ZXN0LmVkaXRvciwgc3VnZ2VzdGlvbik7XHJcbiAgICBBdXRvY29tcGxldGVBZGFwdGVyLmFwcGx5U25pcHBldFRvU3VnZ2VzdGlvbihpdGVtLCBzdWdnZXN0aW9uKTtcclxuICAgIGlmIChvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbSAhPSBudWxsKSB7XHJcbiAgICAgIG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtKGl0ZW0sIHN1Z2dlc3Rpb24sIHJlcXVlc3QpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBzdWdnZXN0aW9uO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDb252ZXJ0IHRoZSBwcmltYXJ5IHBhcnRzIG9mIGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIHRvIGFuIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbi5cclxuICAvL1xyXG4gIC8vICogYGl0ZW1gIEFuIHtDb21wbGV0aW9uSXRlbX0gY29udGFpbmluZyB0aGUgY29tcGxldGlvbiBpdGVtcyB0byBiZSBtZXJnZWQgaW50by5cclxuICAvLyAqIGBzdWdnZXN0aW9uYCBUaGUge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gdG8gbWVyZ2UgdGhlIGNvbnZlcnNpb24gaW50by5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gY3JlYXRlZCBmcm9tIHRoZSB7Q29tcGxldGlvbkl0ZW19LlxyXG4gIHN0YXRpYyBhcHBseUNvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKGl0ZW06IENvbXBsZXRpb25JdGVtLCBzdWdnZXN0aW9uOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24pIHtcclxuICAgIHN1Z2dlc3Rpb24udGV4dCA9IGl0ZW0uaW5zZXJ0VGV4dCB8fCBpdGVtLmxhYmVsO1xyXG4gICAgc3VnZ2VzdGlvbi5kaXNwbGF5VGV4dCA9IGl0ZW0ubGFiZWw7XHJcbiAgICBzdWdnZXN0aW9uLnR5cGUgPSBBdXRvY29tcGxldGVBZGFwdGVyLmNvbXBsZXRpb25LaW5kVG9TdWdnZXN0aW9uVHlwZShpdGVtLmtpbmQpO1xyXG4gICAgc3VnZ2VzdGlvbi5yaWdodExhYmVsID0gaXRlbS5kZXRhaWw7XHJcbiAgICBzdWdnZXN0aW9uLmRlc2NyaXB0aW9uID0gaXRlbS5kb2N1bWVudGF0aW9uO1xyXG4gICAgc3VnZ2VzdGlvbi5kZXNjcmlwdGlvbk1hcmtkb3duID0gaXRlbS5kb2N1bWVudGF0aW9uO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBBcHBsaWVzIHRoZSB0ZXh0RWRpdCBwYXJ0IG9mIGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIHRvIGFuXHJcbiAgLy8gQXV0b0NvbXBsZXRlKyBTdWdnZXN0aW9uIHZpYSB0aGUgcmVwbGFjZW1lbnRQcmVmaXggYW5kIHRleHQgcHJvcGVydGllcy5cclxuICAvL1xyXG4gIC8vICogYHRleHRFZGl0YCBBIHtUZXh0RWRpdH0gZnJvbSBhIENvbXBsZXRpb25JdGVtIHRvIGFwcGx5LlxyXG4gIC8vICogYGVkaXRvcmAgQW4gQXRvbSB7VGV4dEVkaXRvcn0gdXNlZCB0byBvYnRhaW4gdGhlIG5lY2Vzc2FyeSB0ZXh0IHJlcGxhY2VtZW50LlxyXG4gIC8vICogYHN1Z2dlc3Rpb25gIEFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259IHRvIHNldCB0aGUgcmVwbGFjZW1lbnRQcmVmaXggYW5kIHRleHQgcHJvcGVydGllcyBvZi5cclxuICBzdGF0aWMgYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbihcclxuICAgIHRleHRFZGl0OiA/VGV4dEVkaXQsXHJcbiAgICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcclxuICAgIHN1Z2dlc3Rpb246IGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbixcclxuICApOiB2b2lkIHtcclxuICAgIGlmICh0ZXh0RWRpdCAhPSBudWxsKSB7XHJcbiAgICAgIHN1Z2dlc3Rpb24ucmVwbGFjZW1lbnRQcmVmaXggPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoQ29udmVydC5sc1JhbmdlVG9BdG9tUmFuZ2UodGV4dEVkaXQucmFuZ2UpKTtcclxuICAgICAgc3VnZ2VzdGlvbi50ZXh0ID0gdGV4dEVkaXQubmV3VGV4dDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQWRkcyBhIHNuaXBwZXQgdG8gdGhlIHN1Z2dlc3Rpb24gaWYgdGhlIENvbXBsZXRpb25JdGVtIGNvbnRhaW5zXHJcbiAgLy8gc25pcHBldC1mb3JtYXR0ZWQgdGV4dFxyXG4gIC8vXHJcbiAgLy8gKiBgaXRlbWAgQW4ge0NvbXBsZXRpb25JdGVtfSBjb250YWluaW5nIHRoZSBjb21wbGV0aW9uIGl0ZW1zIHRvIGJlIG1lcmdlZCBpbnRvLlxyXG4gIC8vICogYHN1Z2dlc3Rpb25gIFRoZSB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufSB0byBtZXJnZSB0aGUgY29udmVyc2lvbiBpbnRvLlxyXG4gIC8vXHJcbiAgc3RhdGljIGFwcGx5U25pcHBldFRvU3VnZ2VzdGlvbihpdGVtOiBDb21wbGV0aW9uSXRlbSwgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uKTogdm9pZCB7XHJcbiAgICBpZiAoaXRlbS5pbnNlcnRUZXh0Rm9ybWF0ID09PSBJbnNlcnRUZXh0Rm9ybWF0LlNuaXBwZXQpIHtcclxuICAgICAgc3VnZ2VzdGlvbi5zbmlwcGV0ID0gaXRlbS50ZXh0RWRpdCAhPSBudWxsID8gaXRlbS50ZXh0RWRpdC5uZXdUZXh0IDogaXRlbS5pbnNlcnRUZXh0O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8vIFB1YmxpYzogT2J0YWluIHRoZSB0ZXh0dWFsIHN1Z2dlc3Rpb24gdHlwZSByZXF1aXJlZCBieSBBdXRvQ29tcGxldGUrIHRoYXRcclxuICAvLyBtb3N0IGNsb3NlbHkgbWFwcyB0byB0aGUgbnVtZXJpYyBjb21wbGV0aW9uIGtpbmQgc3VwcGxpZXMgYnkgdGhlIGxhbmd1YWdlIHNlcnZlci5cclxuICAvL1xyXG4gIC8vICogYGtpbmRgIEEge051bWJlcn0gdGhhdCByZXByZXNlbnRzIHRoZSBzdWdnZXN0aW9uIGtpbmQgdG8gYmUgY29udmVydGVkLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtTdHJpbmd9IGNvbnRhaW5pbmcgdGhlIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbiB0eXBlIGVxdWl2YWxlbnRcclxuICAvLyB0byB0aGUgZ2l2ZW4gY29tcGxldGlvbiBraW5kLlxyXG4gIHN0YXRpYyBjb21wbGV0aW9uS2luZFRvU3VnZ2VzdGlvblR5cGUoa2luZDogP251bWJlcik6IHN0cmluZyB7XHJcbiAgICBzd2l0Y2ggKGtpbmQpIHtcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuQ29uc3RhbnQ6XHJcbiAgICAgICAgcmV0dXJuICdjb25zdGFudCc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLk1ldGhvZDpcclxuICAgICAgICByZXR1cm4gJ21ldGhvZCc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZ1bmN0aW9uOlxyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Db25zdHJ1Y3RvcjpcclxuICAgICAgICByZXR1cm4gJ2Z1bmN0aW9uJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuRmllbGQ6XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlByb3BlcnR5OlxyXG4gICAgICAgIHJldHVybiAncHJvcGVydHknO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5WYXJpYWJsZTpcclxuICAgICAgICByZXR1cm4gJ3ZhcmlhYmxlJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuQ2xhc3M6XHJcbiAgICAgICAgcmV0dXJuICdjbGFzcyc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlN0cnVjdDpcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuVHlwZVBhcmFtZXRlcjpcclxuICAgICAgICByZXR1cm4gJ3R5cGUnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5PcGVyYXRvcjpcclxuICAgICAgICByZXR1cm4gJ3NlbGVjdG9yJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuSW50ZXJmYWNlOlxyXG4gICAgICAgIHJldHVybiAnbWl4aW4nO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Nb2R1bGU6XHJcbiAgICAgICAgcmV0dXJuICdtb2R1bGUnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Vbml0OlxyXG4gICAgICAgIHJldHVybiAnYnVpbHRpbic7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkVudW06XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkVudW1NZW1iZXI6XHJcbiAgICAgICAgcmV0dXJuICdlbnVtJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuS2V5d29yZDpcclxuICAgICAgICByZXR1cm4gJ2tleXdvcmQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5TbmlwcGV0OlxyXG4gICAgICAgIHJldHVybiAnc25pcHBldCc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZpbGU6XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZvbGRlcjpcclxuICAgICAgICByZXR1cm4gJ2ltcG9ydCc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlJlZmVyZW5jZTpcclxuICAgICAgICByZXR1cm4gJ3JlcXVpcmUnO1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHJldHVybiAndmFsdWUnO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=