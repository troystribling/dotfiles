Object.defineProperty(exports, "__esModule", {
  value: true
});

var _languageclient = require('../languageclient');

var _atom = require('atom');

var _vscodeJsonrpc = require('vscode-jsonrpc');

require('../server-manager');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _fuzzaldrinPlus = require('fuzzaldrin-plus');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Public: Adapts the language server protocol "textDocument/completion" to the Atom
// AutoComplete+ package.
class AutocompleteAdapter {
  constructor() {
    this._suggestionCache = new WeakMap();
    this._cancellationTokens = new WeakMap();
  }

  static canAdapt(serverCapabilities) {
    return serverCapabilities.completionProvider != null;
  }

  static canResolve(serverCapabilities) {
    return serverCapabilities.completionProvider != null && serverCapabilities.completionProvider.resolveProvider === true;
  }

  // Public: Obtain suggestion list for AutoComplete+ by querying the language server using
  // the `textDocument/completion` request.
  //
  // * `server` An {ActiveServer} pointing to the language server to query.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` An optional function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Promise} of an {Array} of {atom$AutocompleteSuggestion}s containing the
  // AutoComplete+ suggestions to display.
  async getSuggestions(server, request, onDidConvertCompletionItem) {
    const triggerChars = server.capabilities.completionProvider != null ? server.capabilities.completionProvider.triggerCharacters || [] : [];
    const triggerPoint = AutocompleteAdapter.getTriggerPoint(request, triggerChars);
    const prefixWithTrigger = AutocompleteAdapter.getPrefixWithTrigger(request, triggerPoint);

    const cache = this._suggestionCache.get(server);

    // We have cached suggestions and should use them
    if (cache && !cache.isIncomplete && cache.triggerPoint.isEqual(triggerPoint)) {
      const suggestions = Array.from(cache.suggestionMap.keys());
      AutocompleteAdapter.setReplacementPrefixOnSuggestions(suggestions, request.prefix);
      return prefixWithTrigger.length === 1 ? suggestions : (0, _fuzzaldrinPlus.filter)(suggestions, request.prefix, { key: 'text' });
    }

    // We either don't have suggestions or they are incomplete so request from the language server
    const completions = await _utils2.default.doWithCancellationToken(server.connection, this._cancellationTokens, cancellationToken => server.connection.completion(AutocompleteAdapter.createCompletionParams(request, prefixWithTrigger[0]), cancellationToken));
    const isIncomplete = !Array.isArray(completions) && completions.isIncomplete;
    const suggestionMap = this.completionItemsToSuggestions(completions, request, onDidConvertCompletionItem);
    this._suggestionCache.set(server, { isIncomplete, triggerPoint, suggestionMap });
    return Array.from(suggestionMap.keys());
  }

  // Public: Obtain a complete version of a suggestion with additional information
  // the language server can provide by way of the `completionItem/resolve` request.
  //
  // * `server` An {ActiveServer} pointing to the language server to query.
  // * `suggestion` An {atom$AutocompleteSuggestion} suggestion that should be resolved.
  // * `request` An {Object} with the AutoComplete+ request to satisfy.
  // * `onDidConvertCompletionItem` An optional function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Promise} of an {atom$AutocompleteSuggestion} with the resolved AutoComplete+ suggestion.
  async completeSuggestion(server, suggestion, request, onDidConvertCompletionItem) {
    const cache = this._suggestionCache.get(server);
    if (cache) {
      const originalCompletionItem = cache.suggestionMap.get(suggestion);
      if (originalCompletionItem != null && originalCompletionItem[1] === false) {
        const resolvedCompletionItem = await server.connection.completionItemResolve(originalCompletionItem[0]);
        if (resolvedCompletionItem != null) {
          AutocompleteAdapter.completionItemToSuggestion(resolvedCompletionItem, suggestion, request, onDidConvertCompletionItem);
          originalCompletionItem[1] = true;
        }
      }
    }

    return suggestion;
  }

  // Public: Set the replacementPrefix property on all given suggestions to the
  // prefix specified.
  //
  // * `suggestions` An {Array} of {atom$AutocompleteSuggestion}s to set the replacementPrefix on.
  // * `prefix` The {string} containing the prefix that should be set as replacementPrefix on all suggestions.
  static setReplacementPrefixOnSuggestions(suggestions, prefix) {
    for (const suggestion of suggestions) {
      suggestion.replacementPrefix = prefix;
    }
  }

  // Public: Get the point where the trigger character occurred.
  //
  // * `request` An {Array} of {atom$AutocompleteSuggestion}s to set the replacementPrefix on.
  // * `triggerChars` The {Array} of {string}s that can be trigger characters.
  //
  // Returns the {atom$Point} where the trigger occurred.
  static getTriggerPoint(request, triggerChars) {
    if (triggerChars.includes(request.prefix)) {
      return _atom.Point.fromObject(request.bufferPosition, true);
    }

    return new _atom.Point(request.bufferPosition.row, request.bufferPosition.column - request.prefix.length);
  }

  // Public: Create TextDocumentPositionParams to be sent to the language server
  // based on the editor and position from the AutoCompleteRequest.
  //
  // * `request` The {atom$AutocompleteRequest} to obtain the trigger and editor from.
  // * `triggerPoint` The {atom$Point} where the trigger started.
  //
  // Returns a {string} containing the prefix including the trigger character.
  static getPrefixWithTrigger(request, triggerPoint) {
    return request.editor.getBuffer().getTextInRange([[triggerPoint.row, triggerPoint.column - 1], request.bufferPosition]);
  }

  // Public: Create CompletionParams to be sent to the language server
  // based on the editor and position from the Autocomplete request etc.
  //
  // * `request` The {atom$AutocompleteRequest} containing the request details.
  // * `triggerCharacter` The {string} containing the trigger character.
  //
  // Returns an {CompletionParams} with the keys:
  //  * `textDocument` the language server protocol textDocument identification.
  //  * `position` the position within the text document to display completion request for.
  //  * `context` containing the trigger character and kind.
  static createCompletionParams(request, triggerCharacter) {
    return {
      textDocument: _convert2.default.editorToTextDocumentIdentifier(request.editor),
      position: _convert2.default.pointToPosition(request.bufferPosition),
      context: {
        triggerKind: triggerCharacter != null ? _languageclient.CompletionTriggerKind.TriggerCharacter : _languageclient.CompletionTriggerKind.Invoked,
        triggerCharacter: undefined
      }
    };
  }

  // Public: Convert a language server protocol CompletionItem array or CompletionList to
  // an array of ordered AutoComplete+ suggestions.
  //
  // * `completionItems` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //           items to be converted.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` A function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns a {Map} of AutoComplete+ suggestions ordered by the CompletionItems sortText.
  completionItemsToSuggestions(completionItems, request, onDidConvertCompletionItem) {
    return new Map((Array.isArray(completionItems) ? completionItems : completionItems.items || []).sort((a, b) => (a.sortText || a.label).localeCompare(b.sortText || b.label)).map(s => [AutocompleteAdapter.completionItemToSuggestion(s, {}, request, onDidConvertCompletionItem), [s, false]]));
  }

  // Public: Convert a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {CompletionItem} containing a completion item to be converted.
  // * `suggestion` A {atom$AutocompleteSuggestion} to have the conversion applied to.
  // * `request` The {atom$AutocompleteRequest} to satisfy.
  // * `onDidConvertCompletionItem` A function that takes a {CompletionItem}, an {atom$AutocompleteSuggestion}
  //   and a {atom$AutocompleteRequest} allowing you to adjust converted items.
  //
  // Returns the {atom$AutocompleteSuggestion} passed in as suggestion with the conversion applied.
  static completionItemToSuggestion(item, suggestion, request, onDidConvertCompletionItem) {
    AutocompleteAdapter.applyCompletionItemToSuggestion(item, suggestion);
    AutocompleteAdapter.applyTextEditToSuggestion(item.textEdit, request.editor, suggestion);
    AutocompleteAdapter.applySnippetToSuggestion(item, suggestion);
    if (onDidConvertCompletionItem != null) {
      onDidConvertCompletionItem(item, suggestion, request);
    }

    return suggestion;
  }

  // Public: Convert the primary parts of a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {CompletionItem} containing the completion items to be merged into.
  // * `suggestion` The {atom$AutocompleteSuggestion} to merge the conversion into.
  //
  // Returns an {atom$AutocompleteSuggestion} created from the {CompletionItem}.
  static applyCompletionItemToSuggestion(item, suggestion) {
    suggestion.text = item.insertText || item.label;
    suggestion.displayText = item.label;
    suggestion.type = AutocompleteAdapter.completionKindToSuggestionType(item.kind);
    suggestion.rightLabel = item.detail;
    suggestion.description = item.documentation;
    suggestion.descriptionMarkdown = item.documentation;
  }

  // Public: Applies the textEdit part of a language server protocol CompletionItem to an
  // AutoComplete+ Suggestion via the replacementPrefix and text properties.
  //
  // * `textEdit` A {TextEdit} from a CompletionItem to apply.
  // * `editor` An Atom {TextEditor} used to obtain the necessary text replacement.
  // * `suggestion` An {atom$AutocompleteSuggestion} to set the replacementPrefix and text properties of.
  static applyTextEditToSuggestion(textEdit, editor, suggestion) {
    if (textEdit != null) {
      suggestion.replacementPrefix = editor.getTextInBufferRange(_convert2.default.lsRangeToAtomRange(textEdit.range));
      suggestion.text = textEdit.newText;
    }
  }

  // Public: Adds a snippet to the suggestion if the CompletionItem contains
  // snippet-formatted text
  //
  // * `item` An {CompletionItem} containing the completion items to be merged into.
  // * `suggestion` The {atom$AutocompleteSuggestion} to merge the conversion into.
  //
  static applySnippetToSuggestion(item, suggestion) {
    if (item.insertTextFormat === _languageclient.InsertTextFormat.Snippet) {
      suggestion.snippet = item.textEdit != null ? item.textEdit.newText : item.insertText;
    }
  }

  // Public: Obtain the textual suggestion type required by AutoComplete+ that
  // most closely maps to the numeric completion kind supplies by the language server.
  //
  // * `kind` A {Number} that represents the suggestion kind to be converted.
  //
  // Returns a {String} containing the AutoComplete+ suggestion type equivalent
  // to the given completion kind.
  static completionKindToSuggestionType(kind) {
    switch (kind) {
      case _languageclient.CompletionItemKind.Constant:
        return 'constant';
      case _languageclient.CompletionItemKind.Method:
        return 'method';
      case _languageclient.CompletionItemKind.Function:
      case _languageclient.CompletionItemKind.Constructor:
        return 'function';
      case _languageclient.CompletionItemKind.Field:
      case _languageclient.CompletionItemKind.Property:
        return 'property';
      case _languageclient.CompletionItemKind.Variable:
        return 'variable';
      case _languageclient.CompletionItemKind.Class:
        return 'class';
      case _languageclient.CompletionItemKind.Struct:
      case _languageclient.CompletionItemKind.TypeParameter:
        return 'type';
      case _languageclient.CompletionItemKind.Operator:
        return 'selector';
      case _languageclient.CompletionItemKind.Interface:
        return 'mixin';
      case _languageclient.CompletionItemKind.Module:
        return 'module';
      case _languageclient.CompletionItemKind.Unit:
        return 'builtin';
      case _languageclient.CompletionItemKind.Enum:
      case _languageclient.CompletionItemKind.EnumMember:
        return 'enum';
      case _languageclient.CompletionItemKind.Keyword:
        return 'keyword';
      case _languageclient.CompletionItemKind.Snippet:
        return 'snippet';
      case _languageclient.CompletionItemKind.File:
      case _languageclient.CompletionItemKind.Folder:
        return 'import';
      case _languageclient.CompletionItemKind.Reference:
        return 'require';
      default:
        return 'value';
    }
  }
}
exports.default = AutocompleteAdapter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlci5qcyJdLCJuYW1lcyI6WyJBdXRvY29tcGxldGVBZGFwdGVyIiwiX3N1Z2dlc3Rpb25DYWNoZSIsIldlYWtNYXAiLCJfY2FuY2VsbGF0aW9uVG9rZW5zIiwiY2FuQWRhcHQiLCJzZXJ2ZXJDYXBhYmlsaXRpZXMiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJjYW5SZXNvbHZlIiwicmVzb2x2ZVByb3ZpZGVyIiwiZ2V0U3VnZ2VzdGlvbnMiLCJzZXJ2ZXIiLCJyZXF1ZXN0Iiwib25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0iLCJ0cmlnZ2VyQ2hhcnMiLCJjYXBhYmlsaXRpZXMiLCJ0cmlnZ2VyQ2hhcmFjdGVycyIsInRyaWdnZXJQb2ludCIsImdldFRyaWdnZXJQb2ludCIsInByZWZpeFdpdGhUcmlnZ2VyIiwiZ2V0UHJlZml4V2l0aFRyaWdnZXIiLCJjYWNoZSIsImdldCIsImlzSW5jb21wbGV0ZSIsImlzRXF1YWwiLCJzdWdnZXN0aW9ucyIsIkFycmF5IiwiZnJvbSIsInN1Z2dlc3Rpb25NYXAiLCJrZXlzIiwic2V0UmVwbGFjZW1lbnRQcmVmaXhPblN1Z2dlc3Rpb25zIiwicHJlZml4IiwibGVuZ3RoIiwia2V5IiwiY29tcGxldGlvbnMiLCJkb1dpdGhDYW5jZWxsYXRpb25Ub2tlbiIsImNvbm5lY3Rpb24iLCJjYW5jZWxsYXRpb25Ub2tlbiIsImNvbXBsZXRpb24iLCJjcmVhdGVDb21wbGV0aW9uUGFyYW1zIiwiaXNBcnJheSIsImNvbXBsZXRpb25JdGVtc1RvU3VnZ2VzdGlvbnMiLCJzZXQiLCJjb21wbGV0ZVN1Z2dlc3Rpb24iLCJzdWdnZXN0aW9uIiwib3JpZ2luYWxDb21wbGV0aW9uSXRlbSIsInJlc29sdmVkQ29tcGxldGlvbkl0ZW0iLCJjb21wbGV0aW9uSXRlbVJlc29sdmUiLCJjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsInJlcGxhY2VtZW50UHJlZml4IiwiaW5jbHVkZXMiLCJmcm9tT2JqZWN0IiwiYnVmZmVyUG9zaXRpb24iLCJyb3ciLCJjb2x1bW4iLCJlZGl0b3IiLCJnZXRCdWZmZXIiLCJnZXRUZXh0SW5SYW5nZSIsInRyaWdnZXJDaGFyYWN0ZXIiLCJ0ZXh0RG9jdW1lbnQiLCJlZGl0b3JUb1RleHREb2N1bWVudElkZW50aWZpZXIiLCJwb3NpdGlvbiIsInBvaW50VG9Qb3NpdGlvbiIsImNvbnRleHQiLCJ0cmlnZ2VyS2luZCIsIlRyaWdnZXJDaGFyYWN0ZXIiLCJJbnZva2VkIiwidW5kZWZpbmVkIiwiY29tcGxldGlvbkl0ZW1zIiwiTWFwIiwiaXRlbXMiLCJzb3J0IiwiYSIsImIiLCJzb3J0VGV4dCIsImxhYmVsIiwibG9jYWxlQ29tcGFyZSIsIm1hcCIsInMiLCJpdGVtIiwiYXBwbHlDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsImFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24iLCJ0ZXh0RWRpdCIsImFwcGx5U25pcHBldFRvU3VnZ2VzdGlvbiIsInRleHQiLCJpbnNlcnRUZXh0IiwiZGlzcGxheVRleHQiLCJ0eXBlIiwiY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlIiwia2luZCIsInJpZ2h0TGFiZWwiLCJkZXRhaWwiLCJkZXNjcmlwdGlvbiIsImRvY3VtZW50YXRpb24iLCJkZXNjcmlwdGlvbk1hcmtkb3duIiwiZ2V0VGV4dEluQnVmZmVyUmFuZ2UiLCJsc1JhbmdlVG9BdG9tUmFuZ2UiLCJyYW5nZSIsIm5ld1RleHQiLCJpbnNlcnRUZXh0Rm9ybWF0IiwiU25pcHBldCIsInNuaXBwZXQiLCJDb25zdGFudCIsIk1ldGhvZCIsIkZ1bmN0aW9uIiwiQ29uc3RydWN0b3IiLCJGaWVsZCIsIlByb3BlcnR5IiwiVmFyaWFibGUiLCJDbGFzcyIsIlN0cnVjdCIsIlR5cGVQYXJhbWV0ZXIiLCJPcGVyYXRvciIsIkludGVyZmFjZSIsIk1vZHVsZSIsIlVuaXQiLCJFbnVtIiwiRW51bU1lbWJlciIsIktleXdvcmQiLCJGaWxlIiwiRm9sZGVyIiwi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QUFLLG1DQUFtQkMsUUFBeEI7QUFDRSxlQUFPLFVBQVA7QUFDRixXQUFLLG1DQUFtQkMsS0FBeEI7QUFDRSxlQUFPLE9BQVA7QUFDRixXQUFLLG1DQUFtQkMsTUFBeEI7QUFDQSxXQUFLLG1DQUFtQkMsYUFBeEI7QUFDRSxlQUFPLE1BQVA7QUFDRixXQUFLLG1DQUFtQkMsUUFBeEI7QUFDRSxlQUFPLFVBQVA7QUFDRixXQUFLLG1DQUFtQkMsU0FBeEI7QUFDRSxlQUFPLE9BQVA7QUFDRixXQUFLLG1DQUFtQkMsTUFBeEI7QUFDRSxlQUFPLFFBQVA7QUFDRixXQUFLLG1DQUFtQkMsSUFBeEI7QUFDRSxlQUFPLFNBQVA7QUFDRixXQUFLLG1DQUFtQkMsSUFBeEI7QUFDQSxXQUFLLG1DQUFtQkMsVUFBeEI7QUFDRSxlQUFPLE1BQVA7QUFDRixXQUFLLG1DQUFtQkMsT0FBeEI7QUFDRSxlQUFPLFNBQVA7QUFDRixXQUFLLG1DQUFtQmxCLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJtQixJQUF4QjtBQUNBLFdBQUssbUNBQW1CQyxNQUF4QjtBQUNFLGVBQU8sUUFBUDtBQUNGLFdBQUssbUNBQW1CQyxTQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGO0FBQ0UsZUFBTyxPQUFQO0FBdkNKO0FBeUNEO0FBdlJzQztrQkFBcEJ4SCxtQiIsImZpbGUiOiJhdXRvY29tcGxldGUtYWRhcHRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XHJcblxyXG5pbXBvcnQge1xyXG4gIENvbXBsZXRpb25JdGVtS2luZCxcclxuICBDb21wbGV0aW9uVHJpZ2dlcktpbmQsXHJcbiAgSW5zZXJ0VGV4dEZvcm1hdCxcclxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgdHlwZSBDb21wbGV0aW9uSXRlbSxcclxuICB0eXBlIENvbXBsZXRpb25MaXN0LFxyXG4gIHR5cGUgQ29tcGxldGlvblBhcmFtcyxcclxuICB0eXBlIFNlcnZlckNhcGFiaWxpdGllcyxcclxuICB0eXBlIFRleHRFZGl0LFxyXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IHtQb2ludH0gZnJvbSAnYXRvbSc7XHJcbmltcG9ydCB7Q2FuY2VsbGF0aW9uVG9rZW5Tb3VyY2V9IGZyb20gJ3ZzY29kZS1qc29ucnBjJztcclxuaW1wb3J0IHt0eXBlIEFjdGl2ZVNlcnZlcn0gZnJvbSAnLi4vc2VydmVyLW1hbmFnZXInO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuLi9jb252ZXJ0JztcclxuaW1wb3J0IHtmaWx0ZXJ9IGZyb20gJ2Z1enphbGRyaW4tcGx1cyc7XHJcbmltcG9ydCBVdGlscyBmcm9tICcuLi91dGlscyc7XHJcblxyXG50eXBlIFN1Z2dlc3Rpb25DYWNoZUVudHJ5ID0ge1xyXG4gIGlzSW5jb21wbGV0ZTogYm9vbGVhbixcclxuICB0cmlnZ2VyUG9pbnQ6IGF0b20kUG9pbnQsXHJcbiAgc3VnZ2VzdGlvbk1hcDogTWFwPGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgW0NvbXBsZXRpb25JdGVtLCBib29sZWFuXT4sXHJcbn07XHJcblxyXG4vLyBQdWJsaWM6IEFkYXB0cyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIFwidGV4dERvY3VtZW50L2NvbXBsZXRpb25cIiB0byB0aGUgQXRvbVxyXG4vLyBBdXRvQ29tcGxldGUrIHBhY2thZ2UuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9jb21wbGV0ZUFkYXB0ZXIge1xyXG4gIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHNlcnZlckNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIgIT0gbnVsbDtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBjYW5SZXNvbHZlKHNlcnZlckNhcGFiaWxpdGllczogU2VydmVyQ2FwYWJpbGl0aWVzKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gc2VydmVyQ2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlciAhPSBudWxsICYmIHNlcnZlckNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIucmVzb2x2ZVByb3ZpZGVyID09PSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgX3N1Z2dlc3Rpb25DYWNoZTogV2Vha01hcDxBY3RpdmVTZXJ2ZXIsIFN1Z2dlc3Rpb25DYWNoZUVudHJ5PiA9IG5ldyBXZWFrTWFwKCk7XHJcbiAgX2NhbmNlbGxhdGlvblRva2VuczogV2Vha01hcDxMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sIENhbmNlbGxhdGlvblRva2VuU291cmNlPiA9IG5ldyBXZWFrTWFwKCk7XHJcblxyXG4gIC8vIFB1YmxpYzogT2J0YWluIHN1Z2dlc3Rpb24gbGlzdCBmb3IgQXV0b0NvbXBsZXRlKyBieSBxdWVyeWluZyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHVzaW5nXHJcbiAgLy8gdGhlIGB0ZXh0RG9jdW1lbnQvY29tcGxldGlvbmAgcmVxdWVzdC5cclxuICAvL1xyXG4gIC8vICogYHNlcnZlcmAgQW4ge0FjdGl2ZVNlcnZlcn0gcG9pbnRpbmcgdG8gdGhlIGxhbmd1YWdlIHNlcnZlciB0byBxdWVyeS5cclxuICAvLyAqIGByZXF1ZXN0YCBUaGUge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHtDb21wbGV0aW9uSXRlbX0sIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259XHJcbiAgLy8gICBhbmQgYSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGNvbnZlcnRlZCBpdGVtcy5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7UHJvbWlzZX0gb2YgYW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgY29udGFpbmluZyB0aGVcclxuICAvLyBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zIHRvIGRpc3BsYXkuXHJcbiAgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMoXHJcbiAgICBzZXJ2ZXI6IEFjdGl2ZVNlcnZlcixcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICAgIG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtPzogKENvbXBsZXRpb25JdGVtLCBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sIGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCkgPT4gdm9pZCxcclxuICApOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcclxuICAgIGNvbnN0IHRyaWdnZXJDaGFycyA9IHNlcnZlci5jYXBhYmlsaXRpZXMuY29tcGxldGlvblByb3ZpZGVyICE9IG51bGwgPyBzZXJ2ZXIuY2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlci50cmlnZ2VyQ2hhcmFjdGVycyB8fCBbXSA6IFtdO1xyXG4gICAgY29uc3QgdHJpZ2dlclBvaW50ID0gQXV0b2NvbXBsZXRlQWRhcHRlci5nZXRUcmlnZ2VyUG9pbnQocmVxdWVzdCwgdHJpZ2dlckNoYXJzKTtcclxuICAgIGNvbnN0IHByZWZpeFdpdGhUcmlnZ2VyID0gQXV0b2NvbXBsZXRlQWRhcHRlci5nZXRQcmVmaXhXaXRoVHJpZ2dlcihyZXF1ZXN0LCB0cmlnZ2VyUG9pbnQpO1xyXG5cclxuICAgIGNvbnN0IGNhY2hlID0gdGhpcy5fc3VnZ2VzdGlvbkNhY2hlLmdldChzZXJ2ZXIpO1xyXG5cclxuICAgIC8vIFdlIGhhdmUgY2FjaGVkIHN1Z2dlc3Rpb25zIGFuZCBzaG91bGQgdXNlIHRoZW1cclxuICAgIGlmIChjYWNoZSAmJiAhY2FjaGUuaXNJbmNvbXBsZXRlICYmIGNhY2hlLnRyaWdnZXJQb2ludC5pc0VxdWFsKHRyaWdnZXJQb2ludCkpIHtcclxuICAgICAgY29uc3Qgc3VnZ2VzdGlvbnMgPSBBcnJheS5mcm9tKGNhY2hlLnN1Z2dlc3Rpb25NYXAua2V5cygpKTtcclxuICAgICAgQXV0b2NvbXBsZXRlQWRhcHRlci5zZXRSZXBsYWNlbWVudFByZWZpeE9uU3VnZ2VzdGlvbnMoc3VnZ2VzdGlvbnMsIHJlcXVlc3QucHJlZml4KTtcclxuICAgICAgcmV0dXJuIHByZWZpeFdpdGhUcmlnZ2VyLmxlbmd0aCA9PT0gMSA/IHN1Z2dlc3Rpb25zIDogZmlsdGVyKHN1Z2dlc3Rpb25zLCByZXF1ZXN0LnByZWZpeCwge2tleTogJ3RleHQnfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gV2UgZWl0aGVyIGRvbid0IGhhdmUgc3VnZ2VzdGlvbnMgb3IgdGhleSBhcmUgaW5jb21wbGV0ZSBzbyByZXF1ZXN0IGZyb20gdGhlIGxhbmd1YWdlIHNlcnZlclxyXG4gICAgY29uc3QgY29tcGxldGlvbnMgPSBhd2FpdCBVdGlscy5kb1dpdGhDYW5jZWxsYXRpb25Ub2tlbihzZXJ2ZXIuY29ubmVjdGlvbiwgdGhpcy5fY2FuY2VsbGF0aW9uVG9rZW5zLCBjYW5jZWxsYXRpb25Ub2tlbiA9PlxyXG4gICAgICBzZXJ2ZXIuY29ubmVjdGlvbi5jb21wbGV0aW9uKEF1dG9jb21wbGV0ZUFkYXB0ZXIuY3JlYXRlQ29tcGxldGlvblBhcmFtcyhyZXF1ZXN0LCBwcmVmaXhXaXRoVHJpZ2dlclswXSksIGNhbmNlbGxhdGlvblRva2VuKSxcclxuICAgICk7XHJcbiAgICBjb25zdCBpc0luY29tcGxldGUgPSAhQXJyYXkuaXNBcnJheShjb21wbGV0aW9ucykgJiYgY29tcGxldGlvbnMuaXNJbmNvbXBsZXRlO1xyXG4gICAgY29uc3Qgc3VnZ2VzdGlvbk1hcCA9IHRoaXMuY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyhjb21wbGV0aW9ucywgcmVxdWVzdCwgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0pO1xyXG4gICAgdGhpcy5fc3VnZ2VzdGlvbkNhY2hlLnNldChzZXJ2ZXIsIHtpc0luY29tcGxldGUsIHRyaWdnZXJQb2ludCwgc3VnZ2VzdGlvbk1hcH0pO1xyXG4gICAgcmV0dXJuIEFycmF5LmZyb20oc3VnZ2VzdGlvbk1hcC5rZXlzKCkpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBPYnRhaW4gYSBjb21wbGV0ZSB2ZXJzaW9uIG9mIGEgc3VnZ2VzdGlvbiB3aXRoIGFkZGl0aW9uYWwgaW5mb3JtYXRpb25cclxuICAvLyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGNhbiBwcm92aWRlIGJ5IHdheSBvZiB0aGUgYGNvbXBsZXRpb25JdGVtL3Jlc29sdmVgIHJlcXVlc3QuXHJcbiAgLy9cclxuICAvLyAqIGBzZXJ2ZXJgIEFuIHtBY3RpdmVTZXJ2ZXJ9IHBvaW50aW5nIHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdG8gcXVlcnkuXHJcbiAgLy8gKiBgc3VnZ2VzdGlvbmAgQW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gc3VnZ2VzdGlvbiB0aGF0IHNob3VsZCBiZSByZXNvbHZlZC5cclxuICAvLyAqIGByZXF1ZXN0YCBBbiB7T2JqZWN0fSB3aXRoIHRoZSBBdXRvQ29tcGxldGUrIHJlcXVlc3QgdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQW4gb3B0aW9uYWwgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHtDb21wbGV0aW9uSXRlbX0sIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259XHJcbiAgLy8gICBhbmQgYSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGNvbnZlcnRlZCBpdGVtcy5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7UHJvbWlzZX0gb2YgYW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gd2l0aCB0aGUgcmVzb2x2ZWQgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIGFzeW5jIGNvbXBsZXRlU3VnZ2VzdGlvbihcclxuICAgIHNlcnZlcjogQWN0aXZlU2VydmVyLFxyXG4gICAgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICAgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0/OiAoQ29tcGxldGlvbkl0ZW0sIGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KSA9PiB2b2lkLFxyXG4gICk6IFByb21pc2U8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPiB7XHJcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMuX3N1Z2dlc3Rpb25DYWNoZS5nZXQoc2VydmVyKTtcclxuICAgIGlmIChjYWNoZSkge1xyXG4gICAgICBjb25zdCBvcmlnaW5hbENvbXBsZXRpb25JdGVtID0gY2FjaGUuc3VnZ2VzdGlvbk1hcC5nZXQoc3VnZ2VzdGlvbik7XHJcbiAgICAgIGlmIChvcmlnaW5hbENvbXBsZXRpb25JdGVtICE9IG51bGwgJiYgb3JpZ2luYWxDb21wbGV0aW9uSXRlbVsxXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICBjb25zdCByZXNvbHZlZENvbXBsZXRpb25JdGVtID0gYXdhaXQgc2VydmVyLmNvbm5lY3Rpb24uY29tcGxldGlvbkl0ZW1SZXNvbHZlKG9yaWdpbmFsQ29tcGxldGlvbkl0ZW1bMF0pO1xyXG4gICAgICAgIGlmIChyZXNvbHZlZENvbXBsZXRpb25JdGVtICE9IG51bGwpIHtcclxuICAgICAgICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24ocmVzb2x2ZWRDb21wbGV0aW9uSXRlbSwgc3VnZ2VzdGlvbiwgcmVxdWVzdCwgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0pO1xyXG4gICAgICAgICAgb3JpZ2luYWxDb21wbGV0aW9uSXRlbVsxXSA9IHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHN1Z2dlc3Rpb247XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IFNldCB0aGUgcmVwbGFjZW1lbnRQcmVmaXggcHJvcGVydHkgb24gYWxsIGdpdmVuIHN1Z2dlc3Rpb25zIHRvIHRoZVxyXG4gIC8vIHByZWZpeCBzcGVjaWZpZWQuXHJcbiAgLy9cclxuICAvLyAqIGBzdWdnZXN0aW9uc2AgQW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgdG8gc2V0IHRoZSByZXBsYWNlbWVudFByZWZpeCBvbi5cclxuICAvLyAqIGBwcmVmaXhgIFRoZSB7c3RyaW5nfSBjb250YWluaW5nIHRoZSBwcmVmaXggdGhhdCBzaG91bGQgYmUgc2V0IGFzIHJlcGxhY2VtZW50UHJlZml4IG9uIGFsbCBzdWdnZXN0aW9ucy5cclxuICBzdGF0aWMgc2V0UmVwbGFjZW1lbnRQcmVmaXhPblN1Z2dlc3Rpb25zKHN1Z2dlc3Rpb25zOiBBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+LCBwcmVmaXg6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgZm9yIChjb25zdCBzdWdnZXN0aW9uIG9mIHN1Z2dlc3Rpb25zKSB7XHJcbiAgICAgIHN1Z2dlc3Rpb24ucmVwbGFjZW1lbnRQcmVmaXggPSBwcmVmaXg7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IEdldCB0aGUgcG9pbnQgd2hlcmUgdGhlIHRyaWdnZXIgY2hhcmFjdGVyIG9jY3VycmVkLlxyXG4gIC8vXHJcbiAgLy8gKiBgcmVxdWVzdGAgQW4ge0FycmF5fSBvZiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufXMgdG8gc2V0IHRoZSByZXBsYWNlbWVudFByZWZpeCBvbi5cclxuICAvLyAqIGB0cmlnZ2VyQ2hhcnNgIFRoZSB7QXJyYXl9IG9mIHtzdHJpbmd9cyB0aGF0IGNhbiBiZSB0cmlnZ2VyIGNoYXJhY3RlcnMuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIHRoZSB7YXRvbSRQb2ludH0gd2hlcmUgdGhlIHRyaWdnZXIgb2NjdXJyZWQuXHJcbiAgc3RhdGljIGdldFRyaWdnZXJQb2ludChyZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsIHRyaWdnZXJDaGFyczogQXJyYXk8c3RyaW5nPik6IGF0b20kUG9pbnQge1xyXG4gICAgaWYgKHRyaWdnZXJDaGFycy5pbmNsdWRlcyhyZXF1ZXN0LnByZWZpeCkpIHtcclxuICAgICAgcmV0dXJuIFBvaW50LmZyb21PYmplY3QocmVxdWVzdC5idWZmZXJQb3NpdGlvbiwgdHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQb2ludChyZXF1ZXN0LmJ1ZmZlclBvc2l0aW9uLnJvdywgcmVxdWVzdC5idWZmZXJQb3NpdGlvbi5jb2x1bW4gLSByZXF1ZXN0LnByZWZpeC5sZW5ndGgpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgdG8gYmUgc2VudCB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyXHJcbiAgLy8gYmFzZWQgb24gdGhlIGVkaXRvciBhbmQgcG9zaXRpb24gZnJvbSB0aGUgQXV0b0NvbXBsZXRlUmVxdWVzdC5cclxuICAvL1xyXG4gIC8vICogYHJlcXVlc3RgIFRoZSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSB0byBvYnRhaW4gdGhlIHRyaWdnZXIgYW5kIGVkaXRvciBmcm9tLlxyXG4gIC8vICogYHRyaWdnZXJQb2ludGAgVGhlIHthdG9tJFBvaW50fSB3aGVyZSB0aGUgdHJpZ2dlciBzdGFydGVkLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtzdHJpbmd9IGNvbnRhaW5pbmcgdGhlIHByZWZpeCBpbmNsdWRpbmcgdGhlIHRyaWdnZXIgY2hhcmFjdGVyLlxyXG4gIHN0YXRpYyBnZXRQcmVmaXhXaXRoVHJpZ2dlcihyZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsIHRyaWdnZXJQb2ludDogYXRvbSRQb2ludCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gcmVxdWVzdC5lZGl0b3JcclxuICAgICAgLmdldEJ1ZmZlcigpXHJcbiAgICAgIC5nZXRUZXh0SW5SYW5nZShbW3RyaWdnZXJQb2ludC5yb3csIHRyaWdnZXJQb2ludC5jb2x1bW4gLSAxXSwgcmVxdWVzdC5idWZmZXJQb3NpdGlvbl0pO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUgQ29tcGxldGlvblBhcmFtcyB0byBiZSBzZW50IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXJcclxuICAvLyBiYXNlZCBvbiB0aGUgZWRpdG9yIGFuZCBwb3NpdGlvbiBmcm9tIHRoZSBBdXRvY29tcGxldGUgcmVxdWVzdCBldGMuXHJcbiAgLy9cclxuICAvLyAqIGByZXF1ZXN0YCBUaGUge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gY29udGFpbmluZyB0aGUgcmVxdWVzdCBkZXRhaWxzLlxyXG4gIC8vICogYHRyaWdnZXJDaGFyYWN0ZXJgIFRoZSB7c3RyaW5nfSBjb250YWluaW5nIHRoZSB0cmlnZ2VyIGNoYXJhY3Rlci5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4ge0NvbXBsZXRpb25QYXJhbXN9IHdpdGggdGhlIGtleXM6XHJcbiAgLy8gICogYHRleHREb2N1bWVudGAgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCB0ZXh0RG9jdW1lbnQgaWRlbnRpZmljYXRpb24uXHJcbiAgLy8gICogYHBvc2l0aW9uYCB0aGUgcG9zaXRpb24gd2l0aGluIHRoZSB0ZXh0IGRvY3VtZW50IHRvIGRpc3BsYXkgY29tcGxldGlvbiByZXF1ZXN0IGZvci5cclxuICAvLyAgKiBgY29udGV4dGAgY29udGFpbmluZyB0aGUgdHJpZ2dlciBjaGFyYWN0ZXIgYW5kIGtpbmQuXHJcbiAgc3RhdGljIGNyZWF0ZUNvbXBsZXRpb25QYXJhbXMocmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LCB0cmlnZ2VyQ2hhcmFjdGVyOiA/c3RyaW5nKTogQ29tcGxldGlvblBhcmFtcyB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICB0ZXh0RG9jdW1lbnQ6IENvbnZlcnQuZWRpdG9yVG9UZXh0RG9jdW1lbnRJZGVudGlmaWVyKHJlcXVlc3QuZWRpdG9yKSxcclxuICAgICAgcG9zaXRpb246IENvbnZlcnQucG9pbnRUb1Bvc2l0aW9uKHJlcXVlc3QuYnVmZmVyUG9zaXRpb24pLFxyXG4gICAgICBjb250ZXh0OiB7XHJcbiAgICAgICAgdHJpZ2dlcktpbmQ6IHRyaWdnZXJDaGFyYWN0ZXIgIT0gbnVsbCA/IENvbXBsZXRpb25UcmlnZ2VyS2luZC5UcmlnZ2VyQ2hhcmFjdGVyIDogQ29tcGxldGlvblRyaWdnZXJLaW5kLkludm9rZWQsXHJcbiAgICAgICAgdHJpZ2dlckNoYXJhY3RlcjogdW5kZWZpbmVkLFxyXG4gICAgICB9LFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSBhcnJheSBvciBDb21wbGV0aW9uTGlzdCB0b1xyXG4gIC8vIGFuIGFycmF5IG9mIG9yZGVyZWQgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9ucy5cclxuICAvL1xyXG4gIC8vICogYGNvbXBsZXRpb25JdGVtc2AgQW4ge0FycmF5fSBvZiB7Q29tcGxldGlvbkl0ZW19IG9iamVjdHMgb3IgYSB7Q29tcGxldGlvbkxpc3R9IGNvbnRhaW5pbmcgY29tcGxldGlvblxyXG4gIC8vICAgICAgICAgICBpdGVtcyB0byBiZSBjb252ZXJ0ZWQuXHJcbiAgLy8gKiBgcmVxdWVzdGAgVGhlIHthdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3R9IHRvIHNhdGlzZnkuXHJcbiAgLy8gKiBgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW1gIEEgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHtDb21wbGV0aW9uSXRlbX0sIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259XHJcbiAgLy8gICBhbmQgYSB7YXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0fSBhbGxvd2luZyB5b3UgdG8gYWRqdXN0IGNvbnZlcnRlZCBpdGVtcy5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7TWFwfSBvZiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zIG9yZGVyZWQgYnkgdGhlIENvbXBsZXRpb25JdGVtcyBzb3J0VGV4dC5cclxuICBjb21wbGV0aW9uSXRlbXNUb1N1Z2dlc3Rpb25zKFxyXG4gICAgY29tcGxldGlvbkl0ZW1zOiBBcnJheTxDb21wbGV0aW9uSXRlbT4gfCBDb21wbGV0aW9uTGlzdCxcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICAgIG9uRGlkQ29udmVydENvbXBsZXRpb25JdGVtPzogKENvbXBsZXRpb25JdGVtLCBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sIGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCkgPT4gdm9pZCxcclxuICApOiBNYXA8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLCBbQ29tcGxldGlvbkl0ZW0sIGJvb2xlYW5dPiB7XHJcbiAgICByZXR1cm4gbmV3IE1hcCgoQXJyYXkuaXNBcnJheShjb21wbGV0aW9uSXRlbXMpID8gY29tcGxldGlvbkl0ZW1zIDogY29tcGxldGlvbkl0ZW1zLml0ZW1zIHx8IFtdKVxyXG4gICAgICAuc29ydCgoYSwgYikgPT4gKGEuc29ydFRleHQgfHwgYS5sYWJlbCkubG9jYWxlQ29tcGFyZShiLnNvcnRUZXh0IHx8IGIubGFiZWwpKVxyXG4gICAgICAubWFwKHMgPT4gW0F1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24ocywgeyB9LCByZXF1ZXN0LCBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbSksIFtzLCBmYWxzZV1dKSk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgQ29tcGxldGlvbkl0ZW0gdG8gYW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIC8vXHJcbiAgLy8gKiBgaXRlbWAgQW4ge0NvbXBsZXRpb25JdGVtfSBjb250YWluaW5nIGEgY29tcGxldGlvbiBpdGVtIHRvIGJlIGNvbnZlcnRlZC5cclxuICAvLyAqIGBzdWdnZXN0aW9uYCBBIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259IHRvIGhhdmUgdGhlIGNvbnZlcnNpb24gYXBwbGllZCB0by5cclxuICAvLyAqIGByZXF1ZXN0YCBUaGUge2F0b20kQXV0b2NvbXBsZXRlUmVxdWVzdH0gdG8gc2F0aXNmeS5cclxuICAvLyAqIGBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbWAgQSBmdW5jdGlvbiB0aGF0IHRha2VzIGEge0NvbXBsZXRpb25JdGVtfSwgYW4ge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn1cclxuICAvLyAgIGFuZCBhIHthdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3R9IGFsbG93aW5nIHlvdSB0byBhZGp1c3QgY29udmVydGVkIGl0ZW1zLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyB0aGUge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gcGFzc2VkIGluIGFzIHN1Z2dlc3Rpb24gd2l0aCB0aGUgY29udmVyc2lvbiBhcHBsaWVkLlxyXG4gIHN0YXRpYyBjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihcclxuICAgIGl0ZW06IENvbXBsZXRpb25JdGVtLFxyXG4gICAgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICAgb25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0/OiAoQ29tcGxldGlvbkl0ZW0sIGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiwgYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KSA9PiB2b2lkLFxyXG4gICk6IGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiB7XHJcbiAgICBBdXRvY29tcGxldGVBZGFwdGVyLmFwcGx5Q29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24oaXRlbSwgc3VnZ2VzdGlvbik7XHJcbiAgICBBdXRvY29tcGxldGVBZGFwdGVyLmFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24oaXRlbS50ZXh0RWRpdCwgcmVxdWVzdC5lZGl0b3IsIHN1Z2dlc3Rpb24pO1xyXG4gICAgQXV0b2NvbXBsZXRlQWRhcHRlci5hcHBseVNuaXBwZXRUb1N1Z2dlc3Rpb24oaXRlbSwgc3VnZ2VzdGlvbik7XHJcbiAgICBpZiAob25EaWRDb252ZXJ0Q29tcGxldGlvbkl0ZW0gIT0gbnVsbCkge1xyXG4gICAgICBvbkRpZENvbnZlcnRDb21wbGV0aW9uSXRlbShpdGVtLCBzdWdnZXN0aW9uLCByZXF1ZXN0KTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3VnZ2VzdGlvbjtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCB0aGUgcHJpbWFyeSBwYXJ0cyBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXHJcbiAgLy9cclxuICAvLyAqIGBpdGVtYCBBbiB7Q29tcGxldGlvbkl0ZW19IGNvbnRhaW5pbmcgdGhlIGNvbXBsZXRpb24gaXRlbXMgdG8gYmUgbWVyZ2VkIGludG8uXHJcbiAgLy8gKiBgc3VnZ2VzdGlvbmAgVGhlIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259IHRvIG1lcmdlIHRoZSBjb252ZXJzaW9uIGludG8uXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGFuIHthdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb259IGNyZWF0ZWQgZnJvbSB0aGUge0NvbXBsZXRpb25JdGVtfS5cclxuICBzdGF0aWMgYXBwbHlDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihpdGVtOiBDb21wbGV0aW9uSXRlbSwgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uKSB7XHJcbiAgICBzdWdnZXN0aW9uLnRleHQgPSBpdGVtLmluc2VydFRleHQgfHwgaXRlbS5sYWJlbDtcclxuICAgIHN1Z2dlc3Rpb24uZGlzcGxheVRleHQgPSBpdGVtLmxhYmVsO1xyXG4gICAgc3VnZ2VzdGlvbi50eXBlID0gQXV0b2NvbXBsZXRlQWRhcHRlci5jb21wbGV0aW9uS2luZFRvU3VnZ2VzdGlvblR5cGUoaXRlbS5raW5kKTtcclxuICAgIHN1Z2dlc3Rpb24ucmlnaHRMYWJlbCA9IGl0ZW0uZGV0YWlsO1xyXG4gICAgc3VnZ2VzdGlvbi5kZXNjcmlwdGlvbiA9IGl0ZW0uZG9jdW1lbnRhdGlvbjtcclxuICAgIHN1Z2dlc3Rpb24uZGVzY3JpcHRpb25NYXJrZG93biA9IGl0ZW0uZG9jdW1lbnRhdGlvbjtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQXBwbGllcyB0aGUgdGV4dEVkaXQgcGFydCBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhblxyXG4gIC8vIEF1dG9Db21wbGV0ZSsgU3VnZ2VzdGlvbiB2aWEgdGhlIHJlcGxhY2VtZW50UHJlZml4IGFuZCB0ZXh0IHByb3BlcnRpZXMuXHJcbiAgLy9cclxuICAvLyAqIGB0ZXh0RWRpdGAgQSB7VGV4dEVkaXR9IGZyb20gYSBDb21wbGV0aW9uSXRlbSB0byBhcHBseS5cclxuICAvLyAqIGBlZGl0b3JgIEFuIEF0b20ge1RleHRFZGl0b3J9IHVzZWQgdG8gb2J0YWluIHRoZSBuZWNlc3NhcnkgdGV4dCByZXBsYWNlbWVudC5cclxuICAvLyAqIGBzdWdnZXN0aW9uYCBBbiB7YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9ufSB0byBzZXQgdGhlIHJlcGxhY2VtZW50UHJlZml4IGFuZCB0ZXh0IHByb3BlcnRpZXMgb2YuXHJcbiAgc3RhdGljIGFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24oXHJcbiAgICB0ZXh0RWRpdDogP1RleHRFZGl0LFxyXG4gICAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbiAgICBzdWdnZXN0aW9uOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24sXHJcbiAgKTogdm9pZCB7XHJcbiAgICBpZiAodGV4dEVkaXQgIT0gbnVsbCkge1xyXG4gICAgICBzdWdnZXN0aW9uLnJlcGxhY2VtZW50UHJlZml4ID0gZWRpdG9yLmdldFRleHRJbkJ1ZmZlclJhbmdlKENvbnZlcnQubHNSYW5nZVRvQXRvbVJhbmdlKHRleHRFZGl0LnJhbmdlKSk7XHJcbiAgICAgIHN1Z2dlc3Rpb24udGV4dCA9IHRleHRFZGl0Lm5ld1RleHQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IEFkZHMgYSBzbmlwcGV0IHRvIHRoZSBzdWdnZXN0aW9uIGlmIHRoZSBDb21wbGV0aW9uSXRlbSBjb250YWluc1xyXG4gIC8vIHNuaXBwZXQtZm9ybWF0dGVkIHRleHRcclxuICAvL1xyXG4gIC8vICogYGl0ZW1gIEFuIHtDb21wbGV0aW9uSXRlbX0gY29udGFpbmluZyB0aGUgY29tcGxldGlvbiBpdGVtcyB0byBiZSBtZXJnZWQgaW50by5cclxuICAvLyAqIGBzdWdnZXN0aW9uYCBUaGUge2F0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbn0gdG8gbWVyZ2UgdGhlIGNvbnZlcnNpb24gaW50by5cclxuICAvL1xyXG4gIHN0YXRpYyBhcHBseVNuaXBwZXRUb1N1Z2dlc3Rpb24oaXRlbTogQ29tcGxldGlvbkl0ZW0sIHN1Z2dlc3Rpb246IGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbik6IHZvaWQge1xyXG4gICAgaWYgKGl0ZW0uaW5zZXJ0VGV4dEZvcm1hdCA9PT0gSW5zZXJ0VGV4dEZvcm1hdC5TbmlwcGV0KSB7XHJcbiAgICAgIHN1Z2dlc3Rpb24uc25pcHBldCA9IGl0ZW0udGV4dEVkaXQgIT0gbnVsbCA/IGl0ZW0udGV4dEVkaXQubmV3VGV4dCA6IGl0ZW0uaW5zZXJ0VGV4dDtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICAvLyBQdWJsaWM6IE9idGFpbiB0aGUgdGV4dHVhbCBzdWdnZXN0aW9uIHR5cGUgcmVxdWlyZWQgYnkgQXV0b0NvbXBsZXRlKyB0aGF0XHJcbiAgLy8gbW9zdCBjbG9zZWx5IG1hcHMgdG8gdGhlIG51bWVyaWMgY29tcGxldGlvbiBraW5kIHN1cHBsaWVzIGJ5IHRoZSBsYW5ndWFnZSBzZXJ2ZXIuXHJcbiAgLy9cclxuICAvLyAqIGBraW5kYCBBIHtOdW1iZXJ9IHRoYXQgcmVwcmVzZW50cyB0aGUgc3VnZ2VzdGlvbiBraW5kIHRvIGJlIGNvbnZlcnRlZC5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7U3RyaW5nfSBjb250YWluaW5nIHRoZSBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24gdHlwZSBlcXVpdmFsZW50XHJcbiAgLy8gdG8gdGhlIGdpdmVuIGNvbXBsZXRpb24ga2luZC5cclxuICBzdGF0aWMgY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlKGtpbmQ6ID9udW1iZXIpOiBzdHJpbmcge1xyXG4gICAgc3dpdGNoIChraW5kKSB7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkNvbnN0YW50OlxyXG4gICAgICAgIHJldHVybiAnY29uc3RhbnQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5NZXRob2Q6XHJcbiAgICAgICAgcmV0dXJuICdtZXRob2QnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GdW5jdGlvbjpcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuQ29uc3RydWN0b3I6XHJcbiAgICAgICAgcmV0dXJuICdmdW5jdGlvbic7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZpZWxkOlxyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Qcm9wZXJ0eTpcclxuICAgICAgICByZXR1cm4gJ3Byb3BlcnR5JztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuVmFyaWFibGU6XHJcbiAgICAgICAgcmV0dXJuICd2YXJpYWJsZSc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkNsYXNzOlxyXG4gICAgICAgIHJldHVybiAnY2xhc3MnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5TdHJ1Y3Q6XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlR5cGVQYXJhbWV0ZXI6XHJcbiAgICAgICAgcmV0dXJuICd0eXBlJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuT3BlcmF0b3I6XHJcbiAgICAgICAgcmV0dXJuICdzZWxlY3Rvcic7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkludGVyZmFjZTpcclxuICAgICAgICByZXR1cm4gJ21peGluJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuTW9kdWxlOlxyXG4gICAgICAgIHJldHVybiAnbW9kdWxlJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuVW5pdDpcclxuICAgICAgICByZXR1cm4gJ2J1aWx0aW4nO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5FbnVtOlxyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5FbnVtTWVtYmVyOlxyXG4gICAgICAgIHJldHVybiAnZW51bSc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLktleXdvcmQ6XHJcbiAgICAgICAgcmV0dXJuICdrZXl3b3JkJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuU25pcHBldDpcclxuICAgICAgICByZXR1cm4gJ3NuaXBwZXQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GaWxlOlxyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Gb2xkZXI6XHJcbiAgICAgICAgcmV0dXJuICdpbXBvcnQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5SZWZlcmVuY2U6XHJcbiAgICAgICAgcmV0dXJuICdyZXF1aXJlJztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gJ3ZhbHVlJztcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19