Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ServerManager = undefined;

require('./logger');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _languageclient = require('./languageclient');

var ls = _interopRequireWildcard(_languageclient);

var _convert = require('./convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Manages the language server lifecycles and their associated objects necessary
// for adapting them to Atom IDE.


// The necessary elements for a server that has started or is starting.
class ServerManager {

  constructor(startServer, logger, startForEditor, changeWatchedFileFilter, busySignalServiceGetter, languageServerName) {
    this._activeServers = [];
    this._startingServerPromises = new Map();
    this._restartCounterPerProject = new Map();
    this._stoppingServers = [];
    this._disposable = new _atom.CompositeDisposable();
    this._editorToServer = new Map();
    this._normalizedProjectPaths = [];
    this._isStarted = false;

    this._languageServerName = languageServerName;
    this._startServer = startServer;
    this._logger = logger;
    this._startForEditor = startForEditor;
    this.updateNormalizedProjectPaths();
    this._changeWatchedFileFilter = changeWatchedFileFilter;
    this._getBusySignalService = busySignalServiceGetter;
  }

  startListening() {
    if (!this._isStarted) {
      this._disposable = new _atom.CompositeDisposable();
      this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
      this._disposable.add(atom.project.onDidChangePaths(this.projectPathsChanged.bind(this)));
      if (atom.project.onDidChangeFiles) {
        this._disposable.add(atom.project.onDidChangeFiles(this.projectFilesChanged.bind(this)));
      }
    }
  }

  stopListening() {
    if (this._isStarted) {
      this._disposable.dispose();
      this._isStarted = false;
    }
  }

  observeTextEditors(editor) {
    // Track grammar changes for opened editors
    const listener = editor.observeGrammar(grammar => this._handleGrammarChange(editor));
    this._disposable.add(editor.onDidDestroy(() => listener.dispose()));
    // Try to see if editor can have LS connected to it
    this._handleTextEditor(editor);
  }

  async _handleTextEditor(editor) {
    if (!this._editorToServer.has(editor)) {
      // editor hasn't been processed yet, so process it by allocating LS for it if necessary
      const server = await this.getServer(editor, { shouldStart: true });
      if (server != null) {
        // There LS for the editor (either started now and already running)
        this._editorToServer.set(editor, server);
        this._disposable.add(editor.onDidDestroy(() => {
          this._editorToServer.delete(editor);
          this.stopUnusedServers();
        }));
      }
    }
  }

  _handleGrammarChange(editor) {
    if (this._startForEditor(editor)) {
      // If editor is interesting for LS process the editor further to attempt to start LS if needed
      this._handleTextEditor(editor);
    } else {
      // Editor is not supported by the LS
      const server = this._editorToServer.get(editor);
      // If LS is running for the unsupported editor then disconnect the editor from LS and shut down LS if necessary
      if (server) {
        // LS is up for unsupported server
        if (server.docSyncAdapter) {
          const syncAdapter = server.docSyncAdapter.getEditorSyncAdapter(editor);
          if (syncAdapter) {
            // Immitate editor close to disconnect LS from the editor
            syncAdapter.didClose();
          }
        }
        // Remove editor from the cache
        this._editorToServer.delete(editor);
        // Shut down LS if it's used by any other editor
        this.stopUnusedServers();
      }
    }
  }

  getActiveServers() {
    return this._activeServers.slice();
  }

  async getServer(textEditor, { shouldStart } = { shouldStart: false }) {
    const finalProjectPath = this.determineProjectPath(textEditor);
    if (finalProjectPath == null) {
      // Files not yet saved have no path
      return null;
    }

    const foundActiveServer = this._activeServers.find(s => finalProjectPath === s.projectPath);
    if (foundActiveServer) {
      return foundActiveServer;
    }

    const startingPromise = this._startingServerPromises.get(finalProjectPath);
    if (startingPromise) {
      return startingPromise;
    }

    return shouldStart && this._startForEditor(textEditor) ? await this.startServer(finalProjectPath) : null;
  }

  async startServer(projectPath) {
    this._logger.debug(`Server starting "${projectPath}"`);
    const startingPromise = this._startServer(projectPath);
    this._startingServerPromises.set(projectPath, startingPromise);
    try {
      const startedActiveServer = await startingPromise;
      this._activeServers.push(startedActiveServer);
      this._startingServerPromises.delete(projectPath);
      this._logger.debug(`Server started "${projectPath}" (pid ${startedActiveServer.process.pid})`);
      return startedActiveServer;
    } catch (e) {
      this._startingServerPromises.delete(projectPath);
      throw e;
    }
  }

  async stopUnusedServers() {
    const usedServers = new Set(this._editorToServer.values());
    const unusedServers = this._activeServers.filter(s => !usedServers.has(s));
    if (unusedServers.length > 0) {
      this._logger.debug(`Stopping ${unusedServers.length} unused servers`);
      await Promise.all(unusedServers.map(s => this.stopServer(s)));
    }
  }

  async stopAllServers() {
    for (const [projectPath, restartCounter] of this._restartCounterPerProject) {
      clearTimeout(restartCounter.timerId);
      this._restartCounterPerProject.delete(projectPath);
    }

    await Promise.all(this._activeServers.map(s => this.stopServer(s)));
  }

  async restartAllServers() {
    this.stopListening();
    await this.stopAllServers();
    this._editorToServer = new Map();
    this.startListening();
  }

  hasServerReachedRestartLimit(server) {
    let restartCounter = this._restartCounterPerProject.get(server.projectPath);

    if (!restartCounter) {
      restartCounter = {
        restarts: 0,
        timerId: setTimeout(() => {
          this._restartCounterPerProject.delete(server.projectPath);
        }, 3 * 60 * 1000 /* 3 minutes */)
      };

      this._restartCounterPerProject.set(server.projectPath, restartCounter);
    }

    return ++restartCounter.restarts > 5;
  }

  async stopServer(server) {
    const busySignalService = this._getBusySignalService();
    const signal = busySignalService && busySignalService.reportBusy(`Stopping ${this._languageServerName} for ${_path2.default.basename(server.projectPath)}`);
    try {
      this._logger.debug(`Server stopping "${server.projectPath}"`);
      // Immediately remove the server to prevent further usage.
      // If we re-open the file after this point, we'll get a new server.
      this._activeServers.splice(this._activeServers.indexOf(server), 1);
      this._stoppingServers.push(server);
      server.disposable.dispose();
      if (server.connection.isConnected) {
        await server.connection.shutdown();
      }

      for (const [editor, mappedServer] of this._editorToServer) {
        if (mappedServer === server) {
          this._editorToServer.delete(editor);
        }
      }

      this.exitServer(server);
      this._stoppingServers.splice(this._stoppingServers.indexOf(server), 1);
    } finally {
      signal && signal.dispose();
    }
  }

  exitServer(server) {
    const pid = server.process.pid;
    try {
      if (server.connection.isConnected) {
        server.connection.exit();
        server.connection.dispose();
      }
    } finally {
      server.process.kill();
    }
    this._logger.debug(`Server stopped "${server.projectPath}" (pid ${pid})`);
  }

  terminate() {
    this._stoppingServers.forEach(server => {
      this._logger.debug(`Server terminating "${server.projectPath}"`);
      this.exitServer(server);
    });
  }

  determineProjectPath(textEditor) {
    const filePath = textEditor.getPath();
    if (filePath == null) {
      return null;
    }
    return this._normalizedProjectPaths.find(d => filePath.startsWith(d));
  }

  updateNormalizedProjectPaths() {
    this._normalizedProjectPaths = atom.project.getDirectories().map(d => this.normalizePath(d.getPath()));
  }

  normalizePath(projectPath) {
    return !projectPath.endsWith(_path2.default.sep) ? _path2.default.join(projectPath, _path2.default.sep) : projectPath;
  }

  projectPathsChanged(projectPaths) {
    const pathsSet = new Set(projectPaths.map(this.normalizePath));
    const serversToStop = this._activeServers.filter(s => !pathsSet.has(s.projectPath));
    Promise.all(serversToStop.map(s => this.stopServer(s)));
    this.updateNormalizedProjectPaths();
  }

  projectFilesChanged(fileEvents) {
    if (this._activeServers.length === 0) {
      return;
    }

    for (const activeServer of this._activeServers) {
      const changes = [];
      for (const fileEvent of fileEvents) {
        if (fileEvent.path.startsWith(activeServer.projectPath) && this._changeWatchedFileFilter(fileEvent.path)) {
          changes.push(_convert2.default.atomFileEventToLSFileEvents(fileEvent)[0]);
        }
        if (fileEvent.oldPath && fileEvent.oldPath.startsWith(activeServer.projectPath) && this._changeWatchedFileFilter(fileEvent.oldPath)) {
          changes.push(_convert2.default.atomFileEventToLSFileEvents(fileEvent)[1]);
        }
      }
      if (changes.length > 0) {
        activeServer.connection.didChangeWatchedFiles({ changes });
      }
    }
  }
}
exports.ServerManager = ServerManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2ZXItbWFuYWdlci5qcyJdLCJuYW1lcyI6WyJscyIsIlNlcnZlck1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsInN0YXJ0U2VydmVyIiwibG9nZ2VyIiwic3RhcnRGb3JFZGl0b3IiLCJjaGFuZ2VXYXRjaGVkRmlsZUZpbHRlciIsImJ1c3lTaWduYWxTZXJ2aWNlR2V0dGVyIiwibGFuZ3VhZ2VTZXJ2ZXJOYW1lIiwiX2FjdGl2ZVNlcnZlcnMiLCJfc3RhcnRpbmdTZXJ2ZXJQcm9taXNlcyIsIk1hcCIsIl9yZXN0YXJ0Q291bnRlclBlclByb2plY3QiLCJfc3RvcHBpbmdTZXJ2ZXJzIiwiX2Rpc3Bvc2FibGUiLCJfZWRpdG9yVG9TZXJ2ZXIiLCJfbm9ybWFsaXplZFByb2plY3RQYXRocyIsIl9pc1N0YXJ0ZWQiLCJfbGFuZ3VhZ2VTZXJ2ZXJOYW1lIiwiX3N0YXJ0U2VydmVyIiwiX2xvZ2dlciIsIl9zdGFydEZvckVkaXRvciIsInVwZGF0ZU5vcm1hbGl6ZWRQcm9qZWN0UGF0aHMiLCJfY2hhbmdlV2F0Y2hlZEZpbGVGaWx0ZXIiLCJfZ2V0QnVzeVNpZ25hbFNlcnZpY2UiLCJzdGFydExpc3RlbmluZyIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJiaW5kIiwicHJvamVjdCIsIm9uRGlkQ2hhbmdlUGF0aHMiLCJwcm9qZWN0UGF0aHNDaGFuZ2VkIiwib25EaWRDaGFuZ2VGaWxlcyIsInByb2plY3RGaWxlc0NoYW5nZWQiLCJzdG9wTGlzdGVuaW5nIiwiZGlzcG9zZSIsImVkaXRvciIsImxpc3RlbmVyIiwib2JzZXJ2ZUdyYW1tYXIiLCJncmFtbWFyIiwiX2hhbmRsZUdyYW1tYXJDaGFuZ2UiLCJvbkRpZERlc3Ryb3kiLCJfaGFuZGxlVGV4dEVkaXRvciIsImhhcyIsInNlcnZlciIsImdldFNlcnZlciIsInNob3VsZFN0YXJ0Iiwic2V0IiwiZGVsZXRlIiwic3RvcFVudXNlZFNlcnZlcnMiLCJnZXQiLCJkb2NTeW5jQWRhcHRlciIsInN5bmNBZGFwdGVyIiwiZ2V0RWRpdG9yU3luY0FkYXB0ZXIiLCJkaWRDbG9zZSIsImdldEFjdGl2ZVNlcnZlcnMiLCJzbGljZSIsInRleHRFZGl0b3IiLCJmaW5hbFByb2plY3RQYXRoIiwiZGV0ZXJtaW5lUHJvamVjdFBhdGgiLCJmb3VuZEFjdGl2ZVNlcnZlciIsImZpbmQiLCJzIiwicHJvamVjdFBhdGgiLCJzdGFydGluZ1Byb21pc2UiLCJkZWJ1ZyIsInN0YXJ0ZWRBY3RpdmVTZXJ2ZXIiLCJwdXNoIiwicHJvY2VzcyIsInBpZCIsImUiLCJ1c2VkU2VydmVycyIsIlNldCIsInZhbHVlcyIsInVudXNlZFNlcnZlcnMiLCJmaWx0ZXIiLCJsZW5ndGgiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwic3RvcFNlcnZlciIsInN0b3BBbGxTZXJ2ZXJzIiwicmVzdGFydENvdW50ZXIiLCJjbGVhclRpbWVvdXQiLCJ0aW1lcklkIiwicmVzdGFydEFsbFNlcnZlcnMiLCJoYXNTZXJ2ZXJSZWFjaGVkUmVzdGFydExpbWl0IiwicmVzdGFydHMiLCJzZXRUaW1lb3V0IiwiYnVzeVNpZ25hbFNlcnZpY2UiLCJzaWduYWwiLCJyZXBvcnRCdXN5IiwiYmFzZW5hbWUiLCJzcGxpY2UiLCJpbmRleE9mIiwiZGlzcG9zYWJsZSIsImNvbm5lY3Rpb24iLCJpc0Nvbm5lY3RlZCIsInNodXRkb3duIiwibWFwcGVkU2VydmVyIiwiZXhpdFNlcnZlciIsImV4aXQiLCJraWxsIiwidGVybWluYXRlIiwiZm9yRWFjaCIsImZpbGVQYXRoIiwiZ2V0UGF0aCIsImQiLCJzdGFydHNXaXRoIiwiZ2V0RGlyZWN0b3JpZXMiLCJub3JtYWxpemVQYXRoIiwiZW5kc1dpdGgiLCJzZXAiLCJqb2luIiwicHJvamVjdFBhdGhzIiwicGF0aHNTZXQiLCJzZXJ2ZXJzVG9TdG9wIiwiZmlsZUV2ZW50cyIsImFjdGl2ZVNlcnZlciIsImNoYW5nZXMiLCJmaWxlRXZlbnQiLCJwYXRoIiwiYXRvbUZp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LFVBQXhCLEVBQW9DO0FBQ2xDLFlBQUlHLFVBQVVDLElBQVYsQ0FBZWIsVUFBZixDQUEwQlUsYUFBYXZELFdBQXZDLEtBQXVELEtBQUszQyx3QkFBTCxDQUE4Qm9HLFVBQVVDLElBQXhDLENBQTNELEVBQTBHO0FBQ3hHRixrQkFBUXBELElBQVIsQ0FBYSxrQkFBUXVELDJCQUFSLENBQW9DRixTQUFwQyxFQUErQyxDQUEvQyxDQUFiO0FBQ0Q7QUFDRCxZQUNFQSxVQUFVRyxPQUFWLElBQ0FILFVBQVVHLE9BQVYsQ0FBa0JmLFVBQWxCLENBQTZCVSxhQUFhdkQsV0FBMUMsQ0FEQSxJQUVBLEtBQUszQyx3QkFBTCxDQUE4Qm9HLFVBQVVHLE9BQXhDLENBSEYsRUFJRTtBQUNBSixrQkFBUXBELElBQVIsQ0FBYSxrQkFBUXVELDJCQUFSLENBQW9DRixTQUFwQyxFQUErQyxDQUEvQyxDQUFiO0FBQ0Q7QUFDRjtBQUNELFVBQUlELFFBQVEzQyxNQUFSLEdBQWlCLENBQXJCLEVBQXdCO0FBQ3RCMEMscUJBQWF0QixVQUFiLENBQXdCNEIscUJBQXhCLENBQThDLEVBQUNMLE9BQUQsRUFBOUM7QUFDRDtBQUNGO0FBQ0Y7QUF6UndCO1FBQWR6SCxhLEdBQUFBLGEiLCJmaWxlIjoic2VydmVyLW1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0IHt0eXBlIExvZ2dlcn0gZnJvbSAnLi9sb2dnZXInO1xyXG5pbXBvcnQgdHlwZSBMaW50ZXJQdXNoVjJBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvbGludGVyLXB1c2gtdjItYWRhcHRlcic7XHJcbmltcG9ydCB0eXBlIERvY3VtZW50U3luY0FkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9kb2N1bWVudC1zeW5jLWFkYXB0ZXInO1xyXG5pbXBvcnQgdHlwZSBTaWduYXR1cmVIZWxwQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL3NpZ25hdHVyZS1oZWxwLWFkYXB0ZXInO1xyXG5cclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIGxzIGZyb20gJy4vbGFuZ3VhZ2VjbGllbnQnO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuL2NvbnZlcnQnO1xyXG5pbXBvcnQge0NvbXBvc2l0ZURpc3Bvc2FibGV9IGZyb20gJ2F0b20nO1xyXG5cclxuLy8gVGhlIG5lY2Vzc2FyeSBlbGVtZW50cyBmb3IgYSBzZXJ2ZXIgdGhhdCBoYXMgc3RhcnRlZCBvciBpcyBzdGFydGluZy5cclxuZXhwb3J0IHR5cGUgQWN0aXZlU2VydmVyID0ge1xyXG4gIGRpc3Bvc2FibGU6IENvbXBvc2l0ZURpc3Bvc2FibGUsXHJcbiAgcHJvamVjdFBhdGg6IHN0cmluZyxcclxuICBwcm9jZXNzOiBjaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcyxcclxuICBjb25uZWN0aW9uOiBscy5MYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgY2FwYWJpbGl0aWVzOiBscy5TZXJ2ZXJDYXBhYmlsaXRpZXMsXHJcbiAgbGludGVyUHVzaFYyPzogTGludGVyUHVzaFYyQWRhcHRlcixcclxuICBkb2NTeW5jQWRhcHRlcj86IERvY3VtZW50U3luY0FkYXB0ZXIsXHJcbiAgc2lnbmF0dXJlSGVscEFkYXB0ZXI/OiBTaWduYXR1cmVIZWxwQWRhcHRlcixcclxufTtcclxuXHJcbnR5cGUgUmVzdGFydENvdW50ZXIgPSB7XHJcbiAgcmVzdGFydHM6IG51bWJlcjtcclxuICB0aW1lcklkOiBudW1iZXI7XHJcbn07XHJcblxyXG4vLyBNYW5hZ2VzIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgbGlmZWN5Y2xlcyBhbmQgdGhlaXIgYXNzb2NpYXRlZCBvYmplY3RzIG5lY2Vzc2FyeVxyXG4vLyBmb3IgYWRhcHRpbmcgdGhlbSB0byBBdG9tIElERS5cclxuZXhwb3J0IGNsYXNzIFNlcnZlck1hbmFnZXIge1xyXG4gIF9hY3RpdmVTZXJ2ZXJzOiBBcnJheTxBY3RpdmVTZXJ2ZXI+ID0gW107XHJcbiAgX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXM6IE1hcDxzdHJpbmcsIFByb21pc2U8QWN0aXZlU2VydmVyPj4gPSBuZXcgTWFwKCk7XHJcbiAgX3Jlc3RhcnRDb3VudGVyUGVyUHJvamVjdDogTWFwPHN0cmluZywgUmVzdGFydENvdW50ZXI+ID0gbmV3IE1hcCgpO1xyXG4gIF9zdG9wcGluZ1NlcnZlcnM6IEFycmF5PEFjdGl2ZVNlcnZlcj4gPSBbXTtcclxuICBfZGlzcG9zYWJsZTogQ29tcG9zaXRlRGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgX2VkaXRvclRvU2VydmVyOiBNYXA8YXRvbSRUZXh0RWRpdG9yLCBBY3RpdmVTZXJ2ZXI+ID0gbmV3IE1hcCgpO1xyXG4gIF9sb2dnZXI6IExvZ2dlcjtcclxuICBfbm9ybWFsaXplZFByb2plY3RQYXRoczogQXJyYXk8c3RyaW5nPiA9IFtdO1xyXG4gIF9zdGFydEZvckVkaXRvcjogKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSA9PiBib29sZWFuO1xyXG4gIF9zdGFydFNlcnZlcjogKHByb2plY3RQYXRoOiBzdHJpbmcpID0+IFByb21pc2U8QWN0aXZlU2VydmVyPjtcclxuICBfY2hhbmdlV2F0Y2hlZEZpbGVGaWx0ZXI6IChmaWxlUGF0aDogc3RyaW5nKSA9PiBib29sZWFuO1xyXG4gIF9nZXRCdXN5U2lnbmFsU2VydmljZTogKCkgPT4gP2F0b21JZGUkQnVzeVNpZ25hbFNlcnZpY2U7XHJcbiAgX2xhbmd1YWdlU2VydmVyTmFtZTogc3RyaW5nO1xyXG4gIF9pc1N0YXJ0ZWQgPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBzdGFydFNlcnZlcjogKHByb2plY3RQYXRoOiBzdHJpbmcpID0+IFByb21pc2U8QWN0aXZlU2VydmVyPixcclxuICAgIGxvZ2dlcjogTG9nZ2VyLFxyXG4gICAgc3RhcnRGb3JFZGl0b3I6IChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikgPT4gYm9vbGVhbixcclxuICAgIGNoYW5nZVdhdGNoZWRGaWxlRmlsdGVyOiAoZmlsZVBhdGg6IHN0cmluZykgPT4gYm9vbGVhbixcclxuICAgIGJ1c3lTaWduYWxTZXJ2aWNlR2V0dGVyOiAoKSA9PiA/YXRvbUlkZSRCdXN5U2lnbmFsU2VydmljZSxcclxuICAgIGxhbmd1YWdlU2VydmVyTmFtZTogc3RyaW5nLFxyXG4gICkge1xyXG4gICAgdGhpcy5fbGFuZ3VhZ2VTZXJ2ZXJOYW1lID0gbGFuZ3VhZ2VTZXJ2ZXJOYW1lO1xyXG4gICAgdGhpcy5fc3RhcnRTZXJ2ZXIgPSBzdGFydFNlcnZlcjtcclxuICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlcjtcclxuICAgIHRoaXMuX3N0YXJ0Rm9yRWRpdG9yID0gc3RhcnRGb3JFZGl0b3I7XHJcbiAgICB0aGlzLnVwZGF0ZU5vcm1hbGl6ZWRQcm9qZWN0UGF0aHMoKTtcclxuICAgIHRoaXMuX2NoYW5nZVdhdGNoZWRGaWxlRmlsdGVyID0gY2hhbmdlV2F0Y2hlZEZpbGVGaWx0ZXI7XHJcbiAgICB0aGlzLl9nZXRCdXN5U2lnbmFsU2VydmljZSA9IGJ1c3lTaWduYWxTZXJ2aWNlR2V0dGVyO1xyXG4gIH1cclxuXHJcbiAgc3RhcnRMaXN0ZW5pbmcoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuX2lzU3RhcnRlZCkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoYXRvbS50ZXh0RWRpdG9ycy5vYnNlcnZlKHRoaXMub2JzZXJ2ZVRleHRFZGl0b3JzLmJpbmQodGhpcykpKTtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHModGhpcy5wcm9qZWN0UGF0aHNDaGFuZ2VkLmJpbmQodGhpcykpKTtcclxuICAgICAgaWYgKGF0b20ucHJvamVjdC5vbkRpZENoYW5nZUZpbGVzKSB7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXModGhpcy5wcm9qZWN0RmlsZXNDaGFuZ2VkLmJpbmQodGhpcykpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgc3RvcExpc3RlbmluZygpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9pc1N0YXJ0ZWQpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICAgIHRoaXMuX2lzU3RhcnRlZCA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb2JzZXJ2ZVRleHRFZGl0b3JzKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogdm9pZCB7XHJcbiAgICAvLyBUcmFjayBncmFtbWFyIGNoYW5nZXMgZm9yIG9wZW5lZCBlZGl0b3JzXHJcbiAgICBjb25zdCBsaXN0ZW5lciA9IGVkaXRvci5vYnNlcnZlR3JhbW1hcihncmFtbWFyID0+IHRoaXMuX2hhbmRsZUdyYW1tYXJDaGFuZ2UoZWRpdG9yKSk7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IGxpc3RlbmVyLmRpc3Bvc2UoKSkpO1xyXG4gICAgLy8gVHJ5IHRvIHNlZSBpZiBlZGl0b3IgY2FuIGhhdmUgTFMgY29ubmVjdGVkIHRvIGl0XHJcbiAgICB0aGlzLl9oYW5kbGVUZXh0RWRpdG9yKGVkaXRvcik7XHJcbiAgfVxyXG5cclxuICBhc3luYyBfaGFuZGxlVGV4dEVkaXRvcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgaWYgKCF0aGlzLl9lZGl0b3JUb1NlcnZlci5oYXMoZWRpdG9yKSkge1xyXG4gICAgICAvLyBlZGl0b3IgaGFzbid0IGJlZW4gcHJvY2Vzc2VkIHlldCwgc28gcHJvY2VzcyBpdCBieSBhbGxvY2F0aW5nIExTIGZvciBpdCBpZiBuZWNlc3NhcnlcclxuICAgICAgY29uc3Qgc2VydmVyID0gYXdhaXQgdGhpcy5nZXRTZXJ2ZXIoZWRpdG9yLCB7c2hvdWxkU3RhcnQ6IHRydWV9KTtcclxuICAgICAgaWYgKHNlcnZlciAhPSBudWxsKSB7XHJcbiAgICAgICAgLy8gVGhlcmUgTFMgZm9yIHRoZSBlZGl0b3IgKGVpdGhlciBzdGFydGVkIG5vdyBhbmQgYWxyZWFkeSBydW5uaW5nKVxyXG4gICAgICAgIHRoaXMuX2VkaXRvclRvU2VydmVyLnNldChlZGl0b3IsIHNlcnZlcik7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgICAgICBlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuZGVsZXRlKGVkaXRvcik7XHJcbiAgICAgICAgICAgIHRoaXMuc3RvcFVudXNlZFNlcnZlcnMoKTtcclxuICAgICAgICAgIH0pLFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9oYW5kbGVHcmFtbWFyQ2hhbmdlKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKSB7XHJcbiAgICBpZiAodGhpcy5fc3RhcnRGb3JFZGl0b3IoZWRpdG9yKSkge1xyXG4gICAgICAvLyBJZiBlZGl0b3IgaXMgaW50ZXJlc3RpbmcgZm9yIExTIHByb2Nlc3MgdGhlIGVkaXRvciBmdXJ0aGVyIHRvIGF0dGVtcHQgdG8gc3RhcnQgTFMgaWYgbmVlZGVkXHJcbiAgICAgIHRoaXMuX2hhbmRsZVRleHRFZGl0b3IoZWRpdG9yKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIEVkaXRvciBpcyBub3Qgc3VwcG9ydGVkIGJ5IHRoZSBMU1xyXG4gICAgICBjb25zdCBzZXJ2ZXIgPSB0aGlzLl9lZGl0b3JUb1NlcnZlci5nZXQoZWRpdG9yKTtcclxuICAgICAgLy8gSWYgTFMgaXMgcnVubmluZyBmb3IgdGhlIHVuc3VwcG9ydGVkIGVkaXRvciB0aGVuIGRpc2Nvbm5lY3QgdGhlIGVkaXRvciBmcm9tIExTIGFuZCBzaHV0IGRvd24gTFMgaWYgbmVjZXNzYXJ5XHJcbiAgICAgIGlmIChzZXJ2ZXIpIHtcclxuICAgICAgICAvLyBMUyBpcyB1cCBmb3IgdW5zdXBwb3J0ZWQgc2VydmVyXHJcbiAgICAgICAgaWYgKHNlcnZlci5kb2NTeW5jQWRhcHRlcikge1xyXG4gICAgICAgICAgY29uc3Qgc3luY0FkYXB0ZXIgPSBzZXJ2ZXIuZG9jU3luY0FkYXB0ZXIuZ2V0RWRpdG9yU3luY0FkYXB0ZXIoZWRpdG9yKTtcclxuICAgICAgICAgIGlmIChzeW5jQWRhcHRlcikge1xyXG4gICAgICAgICAgICAvLyBJbW1pdGF0ZSBlZGl0b3IgY2xvc2UgdG8gZGlzY29ubmVjdCBMUyBmcm9tIHRoZSBlZGl0b3JcclxuICAgICAgICAgICAgc3luY0FkYXB0ZXIuZGlkQ2xvc2UoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gUmVtb3ZlIGVkaXRvciBmcm9tIHRoZSBjYWNoZVxyXG4gICAgICAgIHRoaXMuX2VkaXRvclRvU2VydmVyLmRlbGV0ZShlZGl0b3IpO1xyXG4gICAgICAgIC8vIFNodXQgZG93biBMUyBpZiBpdCdzIHVzZWQgYnkgYW55IG90aGVyIGVkaXRvclxyXG4gICAgICAgIHRoaXMuc3RvcFVudXNlZFNlcnZlcnMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0QWN0aXZlU2VydmVycygpOiBBcnJheTxBY3RpdmVTZXJ2ZXI+IHtcclxuICAgIHJldHVybiB0aGlzLl9hY3RpdmVTZXJ2ZXJzLnNsaWNlKCk7XHJcbiAgfVxyXG5cclxuICBhc3luYyBnZXRTZXJ2ZXIoXHJcbiAgICB0ZXh0RWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbiAgICB7c2hvdWxkU3RhcnR9OiB7c2hvdWxkU3RhcnQ/OiBib29sZWFufSA9IHtzaG91bGRTdGFydDogZmFsc2V9LFxyXG4gICk6IFByb21pc2U8P0FjdGl2ZVNlcnZlcj4ge1xyXG4gICAgY29uc3QgZmluYWxQcm9qZWN0UGF0aCA9IHRoaXMuZGV0ZXJtaW5lUHJvamVjdFBhdGgodGV4dEVkaXRvcik7XHJcbiAgICBpZiAoZmluYWxQcm9qZWN0UGF0aCA9PSBudWxsKSB7XHJcbiAgICAgIC8vIEZpbGVzIG5vdCB5ZXQgc2F2ZWQgaGF2ZSBubyBwYXRoXHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZvdW5kQWN0aXZlU2VydmVyID0gdGhpcy5fYWN0aXZlU2VydmVycy5maW5kKHMgPT4gZmluYWxQcm9qZWN0UGF0aCA9PT0gcy5wcm9qZWN0UGF0aCk7XHJcbiAgICBpZiAoZm91bmRBY3RpdmVTZXJ2ZXIpIHtcclxuICAgICAgcmV0dXJuIGZvdW5kQWN0aXZlU2VydmVyO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0YXJ0aW5nUHJvbWlzZSA9IHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuZ2V0KGZpbmFsUHJvamVjdFBhdGgpO1xyXG4gICAgaWYgKHN0YXJ0aW5nUHJvbWlzZSkge1xyXG4gICAgICByZXR1cm4gc3RhcnRpbmdQcm9taXNlO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBzaG91bGRTdGFydCAmJiB0aGlzLl9zdGFydEZvckVkaXRvcih0ZXh0RWRpdG9yKSA/IGF3YWl0IHRoaXMuc3RhcnRTZXJ2ZXIoZmluYWxQcm9qZWN0UGF0aCkgOiBudWxsO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc3RhcnRTZXJ2ZXIocHJvamVjdFBhdGg6IHN0cmluZyk6IFByb21pc2U8QWN0aXZlU2VydmVyPiB7XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdGFydGluZyBcIiR7cHJvamVjdFBhdGh9XCJgKTtcclxuICAgIGNvbnN0IHN0YXJ0aW5nUHJvbWlzZSA9IHRoaXMuX3N0YXJ0U2VydmVyKHByb2plY3RQYXRoKTtcclxuICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuc2V0KHByb2plY3RQYXRoLCBzdGFydGluZ1Byb21pc2UpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qgc3RhcnRlZEFjdGl2ZVNlcnZlciA9IGF3YWl0IHN0YXJ0aW5nUHJvbWlzZTtcclxuICAgICAgdGhpcy5fYWN0aXZlU2VydmVycy5wdXNoKHN0YXJ0ZWRBY3RpdmVTZXJ2ZXIpO1xyXG4gICAgICB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLmRlbGV0ZShwcm9qZWN0UGF0aCk7XHJcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgU2VydmVyIHN0YXJ0ZWQgXCIke3Byb2plY3RQYXRofVwiIChwaWQgJHtzdGFydGVkQWN0aXZlU2VydmVyLnByb2Nlc3MucGlkfSlgKTtcclxuICAgICAgcmV0dXJuIHN0YXJ0ZWRBY3RpdmVTZXJ2ZXI7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuZGVsZXRlKHByb2plY3RQYXRoKTtcclxuICAgICAgdGhyb3cgZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFzeW5jIHN0b3BVbnVzZWRTZXJ2ZXJzKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgdXNlZFNlcnZlcnMgPSBuZXcgU2V0KHRoaXMuX2VkaXRvclRvU2VydmVyLnZhbHVlcygpKTtcclxuICAgIGNvbnN0IHVudXNlZFNlcnZlcnMgPSB0aGlzLl9hY3RpdmVTZXJ2ZXJzLmZpbHRlcihzID0+ICF1c2VkU2VydmVycy5oYXMocykpO1xyXG4gICAgaWYgKHVudXNlZFNlcnZlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0b3BwaW5nICR7dW51c2VkU2VydmVycy5sZW5ndGh9IHVudXNlZCBzZXJ2ZXJzYCk7XHJcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHVudXNlZFNlcnZlcnMubWFwKHMgPT4gdGhpcy5zdG9wU2VydmVyKHMpKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhc3luYyBzdG9wQWxsU2VydmVycygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGZvciAoY29uc3QgW3Byb2plY3RQYXRoLCByZXN0YXJ0Q291bnRlcl0gb2YgdGhpcy5fcmVzdGFydENvdW50ZXJQZXJQcm9qZWN0KSB7XHJcbiAgICAgIGNsZWFyVGltZW91dChyZXN0YXJ0Q291bnRlci50aW1lcklkKTtcclxuICAgICAgdGhpcy5fcmVzdGFydENvdW50ZXJQZXJQcm9qZWN0LmRlbGV0ZShwcm9qZWN0UGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5fYWN0aXZlU2VydmVycy5tYXAocyA9PiB0aGlzLnN0b3BTZXJ2ZXIocykpKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIHJlc3RhcnRBbGxTZXJ2ZXJzKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7XHJcbiAgICBhd2FpdCB0aGlzLnN0b3BBbGxTZXJ2ZXJzKCk7XHJcbiAgICB0aGlzLl9lZGl0b3JUb1NlcnZlciA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTtcclxuICB9XHJcblxyXG4gIGhhc1NlcnZlclJlYWNoZWRSZXN0YXJ0TGltaXQoc2VydmVyOiBBY3RpdmVTZXJ2ZXIpIHtcclxuICAgIGxldCByZXN0YXJ0Q291bnRlciA9IHRoaXMuX3Jlc3RhcnRDb3VudGVyUGVyUHJvamVjdC5nZXQoc2VydmVyLnByb2plY3RQYXRoKTtcclxuXHJcbiAgICBpZiAoIXJlc3RhcnRDb3VudGVyKSB7XHJcbiAgICAgIHJlc3RhcnRDb3VudGVyID0ge1xyXG4gICAgICAgIHJlc3RhcnRzOiAwLFxyXG4gICAgICAgIHRpbWVySWQ6IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5fcmVzdGFydENvdW50ZXJQZXJQcm9qZWN0LmRlbGV0ZShzZXJ2ZXIucHJvamVjdFBhdGgpO1xyXG4gICAgICAgIH0sIDMgKiA2MCAqIDEwMDAgLyogMyBtaW51dGVzICovKSxcclxuICAgICAgfTtcclxuXHJcbiAgICAgIHRoaXMuX3Jlc3RhcnRDb3VudGVyUGVyUHJvamVjdC5zZXQoc2VydmVyLnByb2plY3RQYXRoLCByZXN0YXJ0Q291bnRlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuICsrcmVzdGFydENvdW50ZXIucmVzdGFydHMgPiA1O1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgc3RvcFNlcnZlcihzZXJ2ZXI6IEFjdGl2ZVNlcnZlcik6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgY29uc3QgYnVzeVNpZ25hbFNlcnZpY2UgPSB0aGlzLl9nZXRCdXN5U2lnbmFsU2VydmljZSgpO1xyXG4gICAgY29uc3Qgc2lnbmFsID0gYnVzeVNpZ25hbFNlcnZpY2UgJiYgYnVzeVNpZ25hbFNlcnZpY2UucmVwb3J0QnVzeShcclxuICAgICAgYFN0b3BwaW5nICR7dGhpcy5fbGFuZ3VhZ2VTZXJ2ZXJOYW1lfSBmb3IgJHtwYXRoLmJhc2VuYW1lKHNlcnZlci5wcm9qZWN0UGF0aCl9YCxcclxuICAgICk7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdG9wcGluZyBcIiR7c2VydmVyLnByb2plY3RQYXRofVwiYCk7XHJcbiAgICAgIC8vIEltbWVkaWF0ZWx5IHJlbW92ZSB0aGUgc2VydmVyIHRvIHByZXZlbnQgZnVydGhlciB1c2FnZS5cclxuICAgICAgLy8gSWYgd2UgcmUtb3BlbiB0aGUgZmlsZSBhZnRlciB0aGlzIHBvaW50LCB3ZSdsbCBnZXQgYSBuZXcgc2VydmVyLlxyXG4gICAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJzLnNwbGljZSh0aGlzLl9hY3RpdmVTZXJ2ZXJzLmluZGV4T2Yoc2VydmVyKSwgMSk7XHJcbiAgICAgIHRoaXMuX3N0b3BwaW5nU2VydmVycy5wdXNoKHNlcnZlcik7XHJcbiAgICAgIHNlcnZlci5kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICAgICAgaWYgKHNlcnZlci5jb25uZWN0aW9uLmlzQ29ubmVjdGVkKSB7XHJcbiAgICAgICAgYXdhaXQgc2VydmVyLmNvbm5lY3Rpb24uc2h1dGRvd24oKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgZm9yIChjb25zdCBbZWRpdG9yLCBtYXBwZWRTZXJ2ZXJdIG9mIHRoaXMuX2VkaXRvclRvU2VydmVyKSB7XHJcbiAgICAgICAgaWYgKG1hcHBlZFNlcnZlciA9PT0gc2VydmVyKSB7XHJcbiAgICAgICAgICB0aGlzLl9lZGl0b3JUb1NlcnZlci5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRoaXMuZXhpdFNlcnZlcihzZXJ2ZXIpO1xyXG4gICAgICB0aGlzLl9zdG9wcGluZ1NlcnZlcnMuc3BsaWNlKHRoaXMuX3N0b3BwaW5nU2VydmVycy5pbmRleE9mKHNlcnZlciksIDEpO1xyXG4gICAgfSBmaW5hbGx5IHtcclxuICAgICAgc2lnbmFsICYmIHNpZ25hbC5kaXNwb3NlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBleGl0U2VydmVyKHNlcnZlcjogQWN0aXZlU2VydmVyKTogdm9pZCB7XHJcbiAgICBjb25zdCBwaWQgPSBzZXJ2ZXIucHJvY2Vzcy5waWQ7XHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAoc2VydmVyLmNvbm5lY3Rpb24uaXNDb25uZWN0ZWQpIHtcclxuICAgICAgICBzZXJ2ZXIuY29ubmVjdGlvbi5leGl0KCk7XHJcbiAgICAgICAgc2VydmVyLmNvbm5lY3Rpb24uZGlzcG9zZSgpO1xyXG4gICAgICB9XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBzZXJ2ZXIucHJvY2Vzcy5raWxsKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdG9wcGVkIFwiJHtzZXJ2ZXIucHJvamVjdFBhdGh9XCIgKHBpZCAke3BpZH0pYCk7XHJcbiAgfVxyXG5cclxuICB0ZXJtaW5hdGUoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9zdG9wcGluZ1NlcnZlcnMuZm9yRWFjaChzZXJ2ZXIgPT4ge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciB0ZXJtaW5hdGluZyBcIiR7c2VydmVyLnByb2plY3RQYXRofVwiYCk7XHJcbiAgICAgIHRoaXMuZXhpdFNlcnZlcihzZXJ2ZXIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBkZXRlcm1pbmVQcm9qZWN0UGF0aCh0ZXh0RWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpOiA/c3RyaW5nIHtcclxuICAgIGNvbnN0IGZpbGVQYXRoID0gdGV4dEVkaXRvci5nZXRQYXRoKCk7XHJcbiAgICBpZiAoZmlsZVBhdGggPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVkUHJvamVjdFBhdGhzLmZpbmQoZCA9PiBmaWxlUGF0aC5zdGFydHNXaXRoKGQpKTtcclxuICB9XHJcblxyXG4gIHVwZGF0ZU5vcm1hbGl6ZWRQcm9qZWN0UGF0aHMoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9ub3JtYWxpemVkUHJvamVjdFBhdGhzID0gYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKCkubWFwKGQgPT4gdGhpcy5ub3JtYWxpemVQYXRoKGQuZ2V0UGF0aCgpKSk7XHJcbiAgfVxyXG5cclxuICBub3JtYWxpemVQYXRoKHByb2plY3RQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuICFwcm9qZWN0UGF0aC5lbmRzV2l0aChwYXRoLnNlcCkgPyBwYXRoLmpvaW4ocHJvamVjdFBhdGgsIHBhdGguc2VwKSA6IHByb2plY3RQYXRoO1xyXG4gIH1cclxuXHJcbiAgcHJvamVjdFBhdGhzQ2hhbmdlZChwcm9qZWN0UGF0aHM6IEFycmF5PHN0cmluZz4pOiB2b2lkIHtcclxuICAgIGNvbnN0IHBhdGhzU2V0ID0gbmV3IFNldChwcm9qZWN0UGF0aHMubWFwKHRoaXMubm9ybWFsaXplUGF0aCkpO1xyXG4gICAgY29uc3Qgc2VydmVyc1RvU3RvcCA9IHRoaXMuX2FjdGl2ZVNlcnZlcnMuZmlsdGVyKHMgPT4gIXBhdGhzU2V0LmhhcyhzLnByb2plY3RQYXRoKSk7XHJcbiAgICBQcm9taXNlLmFsbChzZXJ2ZXJzVG9TdG9wLm1hcChzID0+IHRoaXMuc3RvcFNlcnZlcihzKSkpO1xyXG4gICAgdGhpcy51cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk7XHJcbiAgfVxyXG5cclxuICBwcm9qZWN0RmlsZXNDaGFuZ2VkKGZpbGVFdmVudHM6IEFycmF5PGF0b20kUHJvamVjdEZpbGVFdmVudD4pOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9hY3RpdmVTZXJ2ZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBhY3RpdmVTZXJ2ZXIgb2YgdGhpcy5fYWN0aXZlU2VydmVycykge1xyXG4gICAgICBjb25zdCBjaGFuZ2VzID0gW107XHJcbiAgICAgIGZvciAoY29uc3QgZmlsZUV2ZW50IG9mIGZpbGVFdmVudHMpIHtcclxuICAgICAgICBpZiAoZmlsZUV2ZW50LnBhdGguc3RhcnRzV2l0aChhY3RpdmVTZXJ2ZXIucHJvamVjdFBhdGgpICYmIHRoaXMuX2NoYW5nZVdhdGNoZWRGaWxlRmlsdGVyKGZpbGVFdmVudC5wYXRoKSkge1xyXG4gICAgICAgICAgY2hhbmdlcy5wdXNoKENvbnZlcnQuYXRvbUZpbGVFdmVudFRvTFNGaWxlRXZlbnRzKGZpbGVFdmVudClbMF0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICBmaWxlRXZlbnQub2xkUGF0aCAmJlxyXG4gICAgICAgICAgZmlsZUV2ZW50Lm9sZFBhdGguc3RhcnRzV2l0aChhY3RpdmVTZXJ2ZXIucHJvamVjdFBhdGgpICYmXHJcbiAgICAgICAgICB0aGlzLl9jaGFuZ2VXYXRjaGVkRmlsZUZpbHRlcihmaWxlRXZlbnQub2xkUGF0aClcclxuICAgICAgICApIHtcclxuICAgICAgICAgIGNoYW5nZXMucHVzaChDb252ZXJ0LmF0b21GaWxlRXZlbnRUb0xTRmlsZUV2ZW50cyhmaWxlRXZlbnQpWzFdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGFjdGl2ZVNlcnZlci5jb25uZWN0aW9uLmRpZENoYW5nZVdhdGNoZWRGaWxlcyh7Y2hhbmdlc30pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==