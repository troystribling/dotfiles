var _atom = require('atom');

var _chai = require('chai');

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _languageclient = require('../../lib/languageclient');

var ls = _interopRequireWildcard(_languageclient);

var _codeActionAdapter = require('../../lib/adapters/code-action-adapter');

var _codeActionAdapter2 = _interopRequireDefault(_codeActionAdapter);

var _linterPushV2Adapter = require('../../lib/adapters/linter-push-v2-adapter');

var _linterPushV2Adapter2 = _interopRequireDefault(_linterPushV2Adapter);

var _helpers = require('../helpers.js');

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

describe('CodeActionAdapter', () => {
  describe('canAdapt', () => {
    it('returns true if range formatting is supported', () => {
      const result = _codeActionAdapter2.default.canAdapt({
        codeActionProvider: true
      });
      (0, _chai.expect)(result).to.be.true;
    });

    it('returns false it no formatting supported', () => {
      const result = _codeActionAdapter2.default.canAdapt({});
      (0, _chai.expect)(result).to.be.false;
    });
  });

  describe('getCodeActions', () => {
    it('fetches code actions from the connection', async () => {
      const connection = (0, _helpers.createSpyConnection)();
      const languageClient = new ls.LanguageClientConnection(connection);
      const testCommand = {
        command: 'testCommand',
        title: 'Test Command',
        arguments: ['a', 'b']
      };
      _sinon2.default.stub(languageClient, 'codeAction').returns(Promise.resolve([testCommand]));
      _sinon2.default.spy(languageClient, 'executeCommand');

      const linterAdapter = new _linterPushV2Adapter2.default(languageClient);
      _sinon2.default.stub(linterAdapter, 'getDiagnosticCode').returns('test code');

      const testPath = '/test.txt';
      const actions = await _codeActionAdapter2.default.getCodeActions(languageClient, { codeActionProvider: true }, linterAdapter, (0, _helpers.createFakeEditor)(testPath), new _atom.Range([1, 2], [3, 4]), [{
        filePath: testPath,
        type: 'Error',
        text: 'test message',
        range: new _atom.Range([1, 2], [3, 3]),
        providerName: 'test linter'
      }]);

      (0, _chai.expect)(languageClient.codeAction.called).to.be.true;
      const args = languageClient.codeAction.getCalls()[0].args;
      const params = args[0];
      (0, _chai.expect)(params.textDocument.uri).to.equal('file://' + testPath);
      (0, _chai.expect)(params.range).to.deep.equal({
        start: { line: 1, character: 2 },
        end: { line: 3, character: 4 }
      });
      (0, _chai.expect)(params.context.diagnostics).to.deep.equal([{
        range: {
          start: { line: 1, character: 2 },
          end: { line: 3, character: 3 }
        },
        severity: ls.DiagnosticSeverity.Error,
        code: 'test code',
        source: 'test linter',
        message: 'test message'
      }]);

      (0, _chai.expect)(actions.length).to.equal(1);
      const codeAction = actions[0];
      (0, _chai.expect)((await codeAction.getTitle())).to.equal('Test Command');
      await codeAction.apply();
      (0, _chai.expect)(languageClient.executeCommand.called).to.be.true;
      (0, _chai.expect)(languageClient.executeCommand.getCalls()[0].args).to.deep.equal([{
        command: 'testCommand',
        arguments: ['a', 'b']
      }]);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Rlc3QvYWRhcHRlcnMvY29kZS1hY3Rpb24tYWRhcHRlci50ZXN0LmpzIl0sIm5hbWVzIjpbImxzIiwiZGVzY3JpYmUiLCJpdCIsInJlc3VsdCIsImNhbkFkYXB0IiwiY29kZUFjdGlvblByb3ZpZGVyIiwidG8iLCJiZSIsInRydWUiLCJmYWxzZSIsImNvbm5lY3Rpb24iLCJsYW5ndWFnZUNsaWVudCIsIkxhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbiIsInRlc3RDb21tYW5kIiwiY29tbWFuZCIsInRpdGxlIiwiYXJndW1lbnRzIiwic3R1YiIsInJldHVybnMiLCJQcm9taXNlIiwicmVzb2x2ZSIsInNweSIsImxpbnRlckFkYXB0ZXIiLCJ0ZXN0UGF0aCIsImFjdGlvbnMiLCJnZXRDb2RlQWN0aW9ucyIsImZpbGVQYXRoIiwidHlwZSIsInRleHQiLCJyYW5nZSIsInByb3ZpZGVyTmFtZSIsImNvZGVBY3Rpb24iLCJjYWxsZWQiLCJhcmdzIiwiZ2V0Q2FsbHMiLCJwYXJhbXMiLCJ0ZXh0RG9jdW1lbnQiLCJ1cmkiLCJlcXVhbCIsImRlZXAiLCJzdGFydCIsImxpbmUiLCJjaGFyYWN0ZXIiLCJlbmQiLCJjb250ZXh0IiwiZGlhZ25vc3RpY3MiLCJzZXZlcml0eSIsIkRpYWdub3N0aWNTZXZlcml0eSIsIkVycm9yIiwiY29kZSIsInNvdXJjZSIsIm1lc3NhZ2UiLCJsZW5ndGgiLCJnZXRUaXRsZSIsImFwcGx5IiwiZXhlY3V0ZUNvbW1hbmQiXSwibWFwcGluZ3MiOiJBQUVBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0lBQVlBLEU7O0FBQ1o7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQUMsU0FBUyxtQkFBVCxFQUE4QixNQUFNO0FBQ2xDQSxXQUFTLFVBQVQsRUFBcUIsTUFBTTtBQUN6QkMsT0FBRywrQ0FBSCxFQUFvRCxNQUFNO0FBQ3hELFlBQU1DLFNBQVMsNEJBQWtCQyxRQUFsQixDQUEyQjtBQUN4Q0MsNEJBQW9CO0FBRG9CLE9BQTNCLENBQWY7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QVEsYUFQVjtBQVFFQyxpQkFBUztBQVJYLE9BRCtDLENBQWpEOztBQWFBLHdCQUFPM0IsUUFBUTRCLE1BQWYsRUFBdUI5QyxFQUF2QixDQUEwQmdDLEtBQTFCLENBQWdDLENBQWhDO0FBQ0EsWUFBTVAsYUFBYVAsUUFBUSxDQUFSLENBQW5CO0FBQ0EseUJBQU8sTUFBTU8sV0FBV3NCLFFBQVgsRUFBYixHQUFvQy9DLEVBQXBDLENBQXVDZ0MsS0FBdkMsQ0FBNkMsY0FBN0M7QUFDQSxZQUFNUCxXQUFXdUIsS0FBWCxFQUFOO0FBQ0Esd0JBQU8zQyxlQUFlNEMsY0FBZixDQUE4QnZCLE1BQXJDLEVBQTZDMUIsRUFBN0MsQ0FBZ0RDLEVBQWhELENBQW1EQyxJQUFuRDtBQUNBLHdCQUFPRyxlQUFlNEMsY0FBZixDQUE4QnJCLFFBQTlCLEdBQXlDLENBQXpDLEVBQTRDRCxJQUFuRCxFQUF5RDNCLEVBQXpELENBQTREaUMsSUFBNUQsQ0FBaUVELEtBQWpFLENBQXVFLENBQ3JFO0FBQ0V4QixpQkFBUyxhQURYO0FBRUVFLG1CQUFXLENBQUMsR0FBRCxFQUFNLEdBQU47QUFGYixPQURxRSxDQUF2RTtBQU1ELEtBaEVEO0FBaUVELEdBbEVEO0FBbUVELENBbEZEIiwiZmlsZSI6ImNvZGUtYWN0aW9uLWFkYXB0ZXIudGVzdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XHJcblxyXG5pbXBvcnQge1JhbmdlfSBmcm9tICdhdG9tJztcclxuaW1wb3J0IHtleHBlY3R9IGZyb20gJ2NoYWknO1xyXG5pbXBvcnQgc2lub24gZnJvbSAnc2lub24nO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuLi8uLi9saWIvbGFuZ3VhZ2VjbGllbnQnO1xyXG5pbXBvcnQgQ29kZUFjdGlvbkFkYXB0ZXIgZnJvbSAnLi4vLi4vbGliL2FkYXB0ZXJzL2NvZGUtYWN0aW9uLWFkYXB0ZXInO1xyXG5pbXBvcnQgTGludGVyUHVzaFYyQWRhcHRlciBmcm9tICcuLi8uLi9saWIvYWRhcHRlcnMvbGludGVyLXB1c2gtdjItYWRhcHRlcic7XHJcbmltcG9ydCB7Y3JlYXRlU3B5Q29ubmVjdGlvbiwgY3JlYXRlRmFrZUVkaXRvcn0gZnJvbSAnLi4vaGVscGVycy5qcyc7XHJcblxyXG5kZXNjcmliZSgnQ29kZUFjdGlvbkFkYXB0ZXInLCAoKSA9PiB7XHJcbiAgZGVzY3JpYmUoJ2NhbkFkYXB0JywgKCkgPT4ge1xyXG4gICAgaXQoJ3JldHVybnMgdHJ1ZSBpZiByYW5nZSBmb3JtYXR0aW5nIGlzIHN1cHBvcnRlZCcsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gQ29kZUFjdGlvbkFkYXB0ZXIuY2FuQWRhcHQoe1xyXG4gICAgICAgIGNvZGVBY3Rpb25Qcm92aWRlcjogdHJ1ZSxcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvLmJlLnRydWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgncmV0dXJucyBmYWxzZSBpdCBubyBmb3JtYXR0aW5nIHN1cHBvcnRlZCcsICgpID0+IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gQ29kZUFjdGlvbkFkYXB0ZXIuY2FuQWRhcHQoe30pO1xyXG4gICAgICBleHBlY3QocmVzdWx0KS50by5iZS5mYWxzZTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnZ2V0Q29kZUFjdGlvbnMnLCAoKSA9PiB7XHJcbiAgICBpdCgnZmV0Y2hlcyBjb2RlIGFjdGlvbnMgZnJvbSB0aGUgY29ubmVjdGlvbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGNyZWF0ZVNweUNvbm5lY3Rpb24oKTtcclxuICAgICAgY29uc3QgbGFuZ3VhZ2VDbGllbnQgPSBuZXcgbHMuTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uKGNvbm5lY3Rpb24pO1xyXG4gICAgICBjb25zdCB0ZXN0Q29tbWFuZDogbHMuQ29tbWFuZCA9IHtcclxuICAgICAgICBjb21tYW5kOiAndGVzdENvbW1hbmQnLFxyXG4gICAgICAgIHRpdGxlOiAnVGVzdCBDb21tYW5kJyxcclxuICAgICAgICBhcmd1bWVudHM6IFsnYScsICdiJ10sXHJcbiAgICAgIH07XHJcbiAgICAgIHNpbm9uLnN0dWIobGFuZ3VhZ2VDbGllbnQsICdjb2RlQWN0aW9uJykucmV0dXJucyhQcm9taXNlLnJlc29sdmUoW3Rlc3RDb21tYW5kXSkpO1xyXG4gICAgICBzaW5vbi5zcHkobGFuZ3VhZ2VDbGllbnQsICdleGVjdXRlQ29tbWFuZCcpO1xyXG5cclxuICAgICAgY29uc3QgbGludGVyQWRhcHRlciA9IG5ldyBMaW50ZXJQdXNoVjJBZGFwdGVyKGxhbmd1YWdlQ2xpZW50KTtcclxuICAgICAgc2lub24uc3R1YihsaW50ZXJBZGFwdGVyLCAnZ2V0RGlhZ25vc3RpY0NvZGUnKS5yZXR1cm5zKCd0ZXN0IGNvZGUnKTtcclxuXHJcbiAgICAgIGNvbnN0IHRlc3RQYXRoID0gJy90ZXN0LnR4dCc7XHJcbiAgICAgIGNvbnN0IGFjdGlvbnMgPSBhd2FpdCBDb2RlQWN0aW9uQWRhcHRlci5nZXRDb2RlQWN0aW9ucyhcclxuICAgICAgICBsYW5ndWFnZUNsaWVudCxcclxuICAgICAgICB7Y29kZUFjdGlvblByb3ZpZGVyOiB0cnVlfSxcclxuICAgICAgICBsaW50ZXJBZGFwdGVyLFxyXG4gICAgICAgIGNyZWF0ZUZha2VFZGl0b3IodGVzdFBhdGgpLFxyXG4gICAgICAgIG5ldyBSYW5nZShbMSwgMl0sIFszLCA0XSksXHJcbiAgICAgICAgW1xyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBmaWxlUGF0aDogdGVzdFBhdGgsXHJcbiAgICAgICAgICAgIHR5cGU6ICdFcnJvcicsXHJcbiAgICAgICAgICAgIHRleHQ6ICd0ZXN0IG1lc3NhZ2UnLFxyXG4gICAgICAgICAgICByYW5nZTogbmV3IFJhbmdlKFsxLCAyXSwgWzMsIDNdKSxcclxuICAgICAgICAgICAgcHJvdmlkZXJOYW1lOiAndGVzdCBsaW50ZXInLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICBdLFxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXhwZWN0KGxhbmd1YWdlQ2xpZW50LmNvZGVBY3Rpb24uY2FsbGVkKS50by5iZS50cnVlO1xyXG4gICAgICBjb25zdCBhcmdzID0gbGFuZ3VhZ2VDbGllbnQuY29kZUFjdGlvbi5nZXRDYWxscygpWzBdLmFyZ3M7XHJcbiAgICAgIGNvbnN0IHBhcmFtczogbHMuQ29kZUFjdGlvblBhcmFtcyA9IGFyZ3NbMF07XHJcbiAgICAgIGV4cGVjdChwYXJhbXMudGV4dERvY3VtZW50LnVyaSkudG8uZXF1YWwoJ2ZpbGU6Ly8nICsgdGVzdFBhdGgpO1xyXG4gICAgICBleHBlY3QocGFyYW1zLnJhbmdlKS50by5kZWVwLmVxdWFsKHtcclxuICAgICAgICBzdGFydDoge2xpbmU6IDEsIGNoYXJhY3RlcjogMn0sXHJcbiAgICAgICAgZW5kOiB7bGluZTogMywgY2hhcmFjdGVyOiA0fSxcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChwYXJhbXMuY29udGV4dC5kaWFnbm9zdGljcykudG8uZGVlcC5lcXVhbChbXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgcmFuZ2U6IHtcclxuICAgICAgICAgICAgc3RhcnQ6IHtsaW5lOiAxLCBjaGFyYWN0ZXI6IDJ9LFxyXG4gICAgICAgICAgICBlbmQ6IHtsaW5lOiAzLCBjaGFyYWN0ZXI6IDN9LFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIHNldmVyaXR5OiBscy5EaWFnbm9zdGljU2V2ZXJpdHkuRXJyb3IsXHJcbiAgICAgICAgICBjb2RlOiAndGVzdCBjb2RlJyxcclxuICAgICAgICAgIHNvdXJjZTogJ3Rlc3QgbGludGVyJyxcclxuICAgICAgICAgIG1lc3NhZ2U6ICd0ZXN0IG1lc3NhZ2UnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0pO1xyXG5cclxuICAgICAgZXhwZWN0KGFjdGlvbnMubGVuZ3RoKS50by5lcXVhbCgxKTtcclxuICAgICAgY29uc3QgY29kZUFjdGlvbiA9IGFjdGlvbnNbMF07XHJcbiAgICAgIGV4cGVjdChhd2FpdCBjb2RlQWN0aW9uLmdldFRpdGxlKCkpLnRvLmVxdWFsKCdUZXN0IENvbW1hbmQnKTtcclxuICAgICAgYXdhaXQgY29kZUFjdGlvbi5hcHBseSgpO1xyXG4gICAgICBleHBlY3QobGFuZ3VhZ2VDbGllbnQuZXhlY3V0ZUNvbW1hbmQuY2FsbGVkKS50by5iZS50cnVlO1xyXG4gICAgICBleHBlY3QobGFuZ3VhZ2VDbGllbnQuZXhlY3V0ZUNvbW1hbmQuZ2V0Q2FsbHMoKVswXS5hcmdzKS50by5kZWVwLmVxdWFsKFtcclxuICAgICAgICB7XHJcbiAgICAgICAgICBjb21tYW5kOiAndGVzdENvbW1hbmQnLFxyXG4gICAgICAgICAgYXJndW1lbnRzOiBbJ2EnLCAnYiddLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIF0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcbn0pO1xyXG4iXX0=