"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getDeviceInfo = getDeviceInfo;
exports.getProcesses = getProcesses;
exports.stopProcess = stopProcess;
exports.trackDevices = trackDevices;
exports.getDeviceList = getDeviceList;
exports.getPidFromPackageName = getPidFromPackageName;
exports.installPackage = installPackage;
exports.uninstallPackage = uninstallPackage;
exports.forwardJdwpPortToPid = forwardJdwpPortToPid;
exports.removeJdwpForwardSpec = removeJdwpForwardSpec;
exports.launchActivity = launchActivity;
exports.launchMainActivity = launchMainActivity;
exports.launchService = launchService;
exports.activityExists = activityExists;
exports.getAllAvailablePackages = getAllAvailablePackages;
exports.getJavaProcesses = getJavaProcesses;
exports.dumpsysPackage = dumpsysPackage;
exports.touchFile = touchFile;
exports.removeFile = removeFile;
exports.getAPIVersion = getAPIVersion;
exports.getDeviceArchitecture = getDeviceArchitecture;
exports.getInstalledPackages = getInstalledPackages;
exports.killServer = killServer;
exports.getApkManifest = getApkManifest;
exports.getVersion = getVersion;
exports.checkMuxStatus = checkMuxStatus;
exports.checkInMuxPort = checkInMuxPort;
exports.checkOutMuxPort = checkOutMuxPort;

var _fsPromise = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/fsPromise"));

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _Adb = require("./Adb");

var _Processes = require("./common/Processes");

var _process = require("@atom-ide-community/nuclide-commons/process");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
function getDeviceInfo(serial) {
  return new _Adb.Adb(serial).getDeviceInfo().publish();
}

function getProcesses(serial, timeout) {
  return new _Processes.Processes(new _Adb.Adb(serial)).fetch(timeout).publish();
}

async function stopProcess(serial, packageName, pid) {
  return new _Adb.Adb(serial).stopProcess(packageName, pid);
}

function trackDevices() {
  return (0, _process.observeProcessRaw)('adb', ['track-devices']).filter(event => event.kind !== 'stderr' || !event.data.startsWith('* daemon not running')).distinctUntilChanged() // track-devices doesn't provide the full output
  // we use its output as events to trigger an actual devices -l call
  .switchMap(() => getDeviceList()).publish();
}

function getDeviceList() {
  return _Adb.Adb.getDevices();
}

async function getPidFromPackageName(serial, packageName) {
  return new _Processes.Processes(new _Adb.Adb(serial)).getPidFromPackageName(packageName);
}

function installPackage(serial, packagePath) {
  return new _Adb.Adb(serial).installPackage(packagePath).publish();
}

function uninstallPackage(serial, packageName) {
  // TODO(T17463635)
  return new _Adb.Adb(serial).uninstallPackage(packageName).publish();
}

async function forwardJdwpPortToPid(serial, tcpPort, pid) {
  return new _Adb.Adb(serial).forwardJdwpPortToPid(tcpPort, pid);
}

async function removeJdwpForwardSpec(serial, spec) {
  return new _Adb.Adb(serial).removeJdwpForwardSpec(spec);
}

async function launchActivity(serial, packageName, activity, debug, action, parameters) {
  return new _Adb.Adb(serial).launchActivity(packageName, activity, debug, action, parameters);
}

async function launchMainActivity(serial, packageName, debug) {
  return new _Adb.Adb(serial).launchMainActivity(packageName, debug);
}

async function launchService(serial, packageName, serviceName, debug) {
  return new _Adb.Adb(serial).launchService(packageName, serviceName, debug);
}

async function activityExists(serial, packageName, activity) {
  return new _Adb.Adb(serial).activityExists(packageName, activity);
}

async function getAllAvailablePackages(serial) {
  return new _Adb.Adb(serial).getAllAvailablePackages();
}

function getJavaProcesses(serial) {
  return new _Adb.Adb(serial).getJavaProcesses().publish();
}

async function dumpsysPackage(serial, identifier) {
  return new _Adb.Adb(serial).dumpsysPackage(identifier);
}

async function touchFile(serial, path) {
  return new _Adb.Adb(serial).touchFile(path);
}

async function removeFile(serial, path) {
  return new _Adb.Adb(serial).removeFile(path);
}

async function getAPIVersion(serial) {
  return new _Adb.Adb(serial).getAPIVersion().toPromise();
}

async function getDeviceArchitecture(serial) {
  return new _Adb.Adb(serial).getDeviceArchitecture().toPromise();
}

async function getInstalledPackages(serial) {
  return new _Adb.Adb(serial).getInstalledPackages();
}

async function killServer() {
  return _Adb.Adb.killServer();
}

async function getAaptBinary(buildToolsVersion) {
  if (process.env.ANDROID_SDK == null || buildToolsVersion == null) {
    return 'aapt';
  } else {
    const allBuildToolsPath = _nuclideUri.default.join(process.env.ANDROID_SDK, 'build-tools');

    const exactBuildToolPath = _nuclideUri.default.join(allBuildToolsPath, buildToolsVersion);

    const aaptPath = _nuclideUri.default.join(exactBuildToolPath, 'aapt');

    if (await _fsPromise.default.exists(aaptPath)) {
      return aaptPath;
    } else {
      return 'aapt';
    }
  }
}

async function getApkManifest(apkPath, buildToolsVersion) {
  const aaptBinary = await getAaptBinary(buildToolsVersion);
  return (0, _process.runCommand)(aaptBinary, ['dump', 'badging', apkPath]).toPromise();
}

async function getVersion() {
  return _Adb.Adb.getVersion();
}

async function checkMuxStatus() {
  try {
    await (0, _process.runCommand)('adbmux', ['status']).ignoreElements().toPromise();
  } catch (_) {
    return false;
  }

  return true;
}

function checkInMuxPort(port) {
  return (0, _process.runCommand)('adbmux', ['checkin', `${port}`]).ignoreElements().toPromise();
}

function checkOutMuxPort(port) {
  return (0, _process.runCommand)('adbmux', ['checkout', `${port}`]).ignoreElements().toPromise();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1hZGIvbGliL0FkYlNlcnZpY2UuanMiXSwibmFtZXMiOlsiZ2V0RGV2aWNlSW5mbyIsInNlcmlhbCIsIkFkYiIsInB1Ymxpc2giLCJnZXRQcm9jZXNzZXMiLCJ0aW1lb3V0IiwiUHJvY2Vzc2VzIiwiZmV0Y2giLCJzdG9wUHJvY2VzcyIsInBhY2thZ2VOYW1lIiwicGlkIiwidHJhY2tEZXZpY2VzIiwiZmlsdGVyIiwiZXZlbnQiLCJraW5kIiwiZGF0YSIsInN0YXJ0c1dpdGgiLCJkaXN0aW5jdFVudGlsQ2hhbmdlZCIsInN3aXRjaE1hcCIsImdldERldmljZUxpc3QiLCJnZXREZXZpY2VzIiwiZ2V0UGlkRnJvbVBhY2thZ2VOYW1lIiwiaW5zdGFsbFBhY2thZ2UiLCJwYWNrYWdlUGF0aCIsInVuaW5zdGFsbFBhY2thZ2UiLCJmb3J3YXJkSmR3cFBvcnRUb1BpZCIsInRjcFBvcnQiLCJyZW1vdmVKZHdwRm9yd2FyZFNwZWMiLCJzcGVjIiwibGF1bmNoQWN0aXZpdHkiLCJhY3Rpdml0eSIsImRlYnVnIiwiYWN0aW9uIiwicGFyYW1ldGVycyIsImxhdW5jaE1haW5BY3Rpdml0eSIsImxhdW5jaFNlcnZpY2UiLCJzZXJ2aWNlTmFtZSIsImFjdGl2aXR5RXhpc3RzIiwiZ2V0QWxsQXZhaWxhYmxlUGFja2FnZXMiLCJnZXRKYXZhUHJvY2Vzc2VzIiwiZHVtcHN5c1BhY2thZ2UiLCJpZGVudGlmaWVyIiwidG91Y2hGaWxlIiwicGF0aCIsInJlbW92ZUZpbGUiLCJnZXRBUElWZXJzaW9uIiwidG9Qcm9taXNlIiwiZ2V0RGV2aWNlQXJjaGl0ZWN0dXJlIiwiZ2V0SW5zdGFsbGVkUGFja2FnZXMiLCJraWxsU2VydmVyIiwiZ2V0QWFwdEJpbmFyeSIsImJ1aWxkVG9vbHNWZXJzaW9uIiwicHJvY2VzcyIsImVudiIsIkFORFJPSURfU0RLIiwiYWxsQnVpbGRUb29sc1BhdGgiLCJudWNsaWRlVXJpIiwiam9pbiIsImV4YWN0QnVpbGRUb29sUGF0aCIsImFhcHRQYXRoIiwiZnNQcm9taXNlIiwiZXhpc3RzIiwiZ2V0QXBrTWFuaWZlc3QiLCJhcGtQYXRoIiwiYWFwdEJpbmFyeSIsImdldFZlcnNpb24iLCJjaGVja011eFN0YXR1cyIsImlnbm9yZUVsZW1lbnRzIiwiXyIsImNoZWNrSW5NdXhQb3J0IiwicG9ydCIsImNoZWNrT3V0TXV4UG9ydCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW1CQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQXhCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJPLFNBQVNBLGFBQVQsQ0FDTEMsTUFESyxFQUV1QztBQUM1QyxTQUFPLElBQUlDLFFBQUosQ0FBUUQsTUFBUixFQUFnQkQsYUFBaEIsR0FBZ0NHLE9BQWhDLEVBQVA7QUFDRDs7QUFFTSxTQUFTQyxZQUFULENBQ0xILE1BREssRUFFTEksT0FGSyxFQUdrQztBQUN2QyxTQUFPLElBQUlDLG9CQUFKLENBQWMsSUFBSUosUUFBSixDQUFRRCxNQUFSLENBQWQsRUFBK0JNLEtBQS9CLENBQXFDRixPQUFyQyxFQUE4Q0YsT0FBOUMsRUFBUDtBQUNEOztBQUVNLGVBQWVLLFdBQWYsQ0FDTFAsTUFESyxFQUVMUSxXQUZLLEVBR0xDLEdBSEssRUFJVTtBQUNmLFNBQU8sSUFBSVIsUUFBSixDQUFRRCxNQUFSLEVBQWdCTyxXQUFoQixDQUE0QkMsV0FBNUIsRUFBeUNDLEdBQXpDLENBQVA7QUFDRDs7QUFFTSxTQUFTQyxZQUFULEdBQWlFO0FBQ3RFLFNBQ0UsZ0NBQWtCLEtBQWxCLEVBQXlCLENBQUMsZUFBRCxDQUF6QixFQUNHQyxNQURILENBRUlDLEtBQUssSUFDSEEsS0FBSyxDQUFDQyxJQUFOLEtBQWUsUUFBZixJQUNBLENBQUNELEtBQUssQ0FBQ0UsSUFBTixDQUFXQyxVQUFYLENBQXNCLHNCQUF0QixDQUpQLEVBTUdDLG9CQU5ILEdB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ICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB0eXBlIHtcclxuICBMZWdhY3lQcm9jZXNzTWVzc2FnZSxcclxuICBQcm9jZXNzTWVzc2FnZSxcclxufSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9wcm9jZXNzJztcclxuaW1wb3J0IHR5cGUge0FkYkRldmljZSwgQW5kcm9pZEphdmFQcm9jZXNzLCBQcm9jZXNzfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbmltcG9ydCBmc1Byb21pc2UgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvZnNQcm9taXNlJztcclxuaW1wb3J0IG51Y2xpZGVVcmkgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB7Q29ubmVjdGFibGVPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5pbXBvcnQge0FkYn0gZnJvbSAnLi9BZGInO1xyXG5pbXBvcnQge1Byb2Nlc3Nlc30gZnJvbSAnLi9jb21tb24vUHJvY2Vzc2VzJztcclxuaW1wb3J0IHtydW5Db21tYW5kfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9wcm9jZXNzJztcclxuaW1wb3J0IHtvYnNlcnZlUHJvY2Vzc1Jhd30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvcHJvY2Vzcyc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGV2aWNlSW5mbyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPE1hcDxzdHJpbmcsIHN0cmluZz4+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmdldERldmljZUluZm8oKS5wdWJsaXNoKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQcm9jZXNzZXMoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgdGltZW91dDogbnVtYmVyLFxyXG4pOiBDb25uZWN0YWJsZU9ic2VydmFibGU8QXJyYXk8UHJvY2Vzcz4+IHtcclxuICByZXR1cm4gbmV3IFByb2Nlc3NlcyhuZXcgQWRiKHNlcmlhbCkpLmZldGNoKHRpbWVvdXQpLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHN0b3BQcm9jZXNzKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXHJcbiAgcGlkOiBudW1iZXIsXHJcbik6IFByb21pc2U8dm9pZD4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuc3RvcFByb2Nlc3MocGFja2FnZU5hbWUsIHBpZCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0cmFja0RldmljZXMoKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPEFycmF5PEFkYkRldmljZT4+IHtcclxuICByZXR1cm4gKFxyXG4gICAgb2JzZXJ2ZVByb2Nlc3NSYXcoJ2FkYicsIFsndHJhY2stZGV2aWNlcyddKVxyXG4gICAgICAuZmlsdGVyKFxyXG4gICAgICAgIGV2ZW50ID0+XHJcbiAgICAgICAgICBldmVudC5raW5kICE9PSAnc3RkZXJyJyB8fFxyXG4gICAgICAgICAgIWV2ZW50LmRhdGEuc3RhcnRzV2l0aCgnKiBkYWVtb24gbm90IHJ1bm5pbmcnKSxcclxuICAgICAgKVxyXG4gICAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoKVxyXG4gICAgICAvLyB0cmFjay1kZXZpY2VzIGRvZXNuJ3QgcHJvdmlkZSB0aGUgZnVsbCBvdXRwdXRcclxuICAgICAgLy8gd2UgdXNlIGl0cyBvdXRwdXQgYXMgZXZlbnRzIHRvIHRyaWdnZXIgYW4gYWN0dWFsIGRldmljZXMgLWwgY2FsbFxyXG4gICAgICAuc3dpdGNoTWFwKCgpID0+IGdldERldmljZUxpc3QoKSlcclxuICAgICAgLnB1Ymxpc2goKVxyXG4gICk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXREZXZpY2VMaXN0KCk6IFByb21pc2U8QXJyYXk8QWRiRGV2aWNlPj4ge1xyXG4gIHJldHVybiBBZGIuZ2V0RGV2aWNlcygpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UGlkRnJvbVBhY2thZ2VOYW1lKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXHJcbik6IFByb21pc2U8bnVtYmVyPiB7XHJcbiAgcmV0dXJuIG5ldyBQcm9jZXNzZXMobmV3IEFkYihzZXJpYWwpKS5nZXRQaWRGcm9tUGFja2FnZU5hbWUocGFja2FnZU5hbWUpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbFBhY2thZ2UoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZVBhdGg6IE51Y2xpZGVVcmksXHJcbik6IENvbm5lY3RhYmxlT2JzZXJ2YWJsZTxQcm9jZXNzTWVzc2FnZT4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuaW5zdGFsbFBhY2thZ2UocGFja2FnZVBhdGgpLnB1Ymxpc2goKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHVuaW5zdGFsbFBhY2thZ2UoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuKTogQ29ubmVjdGFibGVPYnNlcnZhYmxlPExlZ2FjeVByb2Nlc3NNZXNzYWdlPiB7XHJcbiAgLy8gVE9ETyhUMTc0NjM2MzUpXHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS51bmluc3RhbGxQYWNrYWdlKHBhY2thZ2VOYW1lKS5wdWJsaXNoKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBmb3J3YXJkSmR3cFBvcnRUb1BpZChcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICB0Y3BQb3J0OiBudW1iZXIsXHJcbiAgcGlkOiBudW1iZXIsXHJcbik6IFByb21pc2U8P3N0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuZm9yd2FyZEpkd3BQb3J0VG9QaWQodGNwUG9ydCwgcGlkKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUpkd3BGb3J3YXJkU3BlYyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBzcGVjOiA/c3RyaW5nLFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkucmVtb3ZlSmR3cEZvcndhcmRTcGVjKHNwZWMpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGF1bmNoQWN0aXZpdHkoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuICBhY3Rpdml0eTogc3RyaW5nLFxyXG4gIGRlYnVnOiBib29sZWFuLFxyXG4gIGFjdGlvbjogP3N0cmluZyxcclxuICBwYXJhbWV0ZXJzOiA/TWFwPHN0cmluZywgc3RyaW5nPixcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmxhdW5jaEFjdGl2aXR5KFxyXG4gICAgcGFja2FnZU5hbWUsXHJcbiAgICBhY3Rpdml0eSxcclxuICAgIGRlYnVnLFxyXG4gICAgYWN0aW9uLFxyXG4gICAgcGFyYW1ldGVycyxcclxuICApO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gbGF1bmNoTWFpbkFjdGl2aXR5KFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXHJcbiAgZGVidWc6IGJvb2xlYW4sXHJcbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5sYXVuY2hNYWluQWN0aXZpdHkocGFja2FnZU5hbWUsIGRlYnVnKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGxhdW5jaFNlcnZpY2UoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgcGFja2FnZU5hbWU6IHN0cmluZyxcclxuICBzZXJ2aWNlTmFtZTogc3RyaW5nLFxyXG4gIGRlYnVnOiBib29sZWFuLFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkubGF1bmNoU2VydmljZShwYWNrYWdlTmFtZSwgc2VydmljZU5hbWUsIGRlYnVnKTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFjdGl2aXR5RXhpc3RzKFxyXG4gIHNlcmlhbDogc3RyaW5nLFxyXG4gIHBhY2thZ2VOYW1lOiBzdHJpbmcsXHJcbiAgYWN0aXZpdHk6IHN0cmluZyxcclxuKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5hY3Rpdml0eUV4aXN0cyhwYWNrYWdlTmFtZSwgYWN0aXZpdHkpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QWxsQXZhaWxhYmxlUGFja2FnZXMoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbik6IFByb21pc2U8QXJyYXk8c3RyaW5nPj4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuZ2V0QWxsQXZhaWxhYmxlUGFja2FnZXMoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEphdmFQcm9jZXNzZXMoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbik6IENvbm5lY3RhYmxlT2JzZXJ2YWJsZTxBcnJheTxBbmRyb2lkSmF2YVByb2Nlc3M+PiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5nZXRKYXZhUHJvY2Vzc2VzKCkucHVibGlzaCgpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZHVtcHN5c1BhY2thZ2UoXHJcbiAgc2VyaWFsOiBzdHJpbmcsXHJcbiAgaWRlbnRpZmllcjogc3RyaW5nLFxyXG4pOiBQcm9taXNlPD9zdHJpbmc+IHtcclxuICByZXR1cm4gbmV3IEFkYihzZXJpYWwpLmR1bXBzeXNQYWNrYWdlKGlkZW50aWZpZXIpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdG91Y2hGaWxlKHNlcmlhbDogc3RyaW5nLCBwYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkudG91Y2hGaWxlKHBhdGgpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVtb3ZlRmlsZShcclxuICBzZXJpYWw6IHN0cmluZyxcclxuICBwYXRoOiBzdHJpbmcsXHJcbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5yZW1vdmVGaWxlKHBhdGgpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QVBJVmVyc2lvbihzZXJpYWw6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5nZXRBUElWZXJzaW9uKCkudG9Qcm9taXNlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZXZpY2VBcmNoaXRlY3R1cmUoc2VyaWFsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIHJldHVybiBuZXcgQWRiKHNlcmlhbCkuZ2V0RGV2aWNlQXJjaGl0ZWN0dXJlKCkudG9Qcm9taXNlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRJbnN0YWxsZWRQYWNrYWdlcyhcclxuICBzZXJpYWw6IHN0cmluZyxcclxuKTogUHJvbWlzZTxBcnJheTxzdHJpbmc+PiB7XHJcbiAgcmV0dXJuIG5ldyBBZGIoc2VyaWFsKS5nZXRJbnN0YWxsZWRQYWNrYWdlcygpO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24ga2lsbFNlcnZlcigpOiBQcm9taXNlPHZvaWQ+IHtcclxuICByZXR1cm4gQWRiLmtpbGxTZXJ2ZXIoKTtcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gZ2V0QWFwdEJpbmFyeShidWlsZFRvb2xzVmVyc2lvbjogP3N0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgaWYgKHByb2Nlc3MuZW52LkFORFJPSURfU0RLID09IG51bGwgfHwgYnVpbGRUb29sc1ZlcnNpb24gPT0gbnVsbCkge1xyXG4gICAgcmV0dXJuICdhYXB0JztcclxuICB9IGVsc2Uge1xyXG4gICAgY29uc3QgYWxsQnVpbGRUb29sc1BhdGggPSBudWNsaWRlVXJpLmpvaW4oXHJcbiAgICAgIHByb2Nlc3MuZW52LkFORFJPSURfU0RLLFxyXG4gICAgICAnYnVpbGQtdG9vbHMnLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IGV4YWN0QnVpbGRUb29sUGF0aCA9IG51Y2xpZGVVcmkuam9pbihcclxuICAgICAgYWxsQnVpbGRUb29sc1BhdGgsXHJcbiAgICAgIGJ1aWxkVG9vbHNWZXJzaW9uLFxyXG4gICAgKTtcclxuICAgIGNvbnN0IGFhcHRQYXRoID0gbnVjbGlkZVVyaS5qb2luKGV4YWN0QnVpbGRUb29sUGF0aCwgJ2FhcHQnKTtcclxuICAgIGlmIChhd2FpdCBmc1Byb21pc2UuZXhpc3RzKGFhcHRQYXRoKSkge1xyXG4gICAgICByZXR1cm4gYWFwdFBhdGg7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gJ2FhcHQnO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFwa01hbmlmZXN0KFxyXG4gIGFwa1BhdGg6IHN0cmluZyxcclxuICBidWlsZFRvb2xzVmVyc2lvbjogP3N0cmluZyxcclxuKTogUHJvbWlzZTxzdHJpbmc+IHtcclxuICBjb25zdCBhYXB0QmluYXJ5ID0gYXdhaXQgZ2V0QWFwdEJpbmFyeShidWlsZFRvb2xzVmVyc2lvbik7XHJcbiAgcmV0dXJuIHJ1bkNvbW1hbmQoYWFwdEJpbmFyeSwgWydkdW1wJywgJ2JhZGdpbmcnLCBhcGtQYXRoXSkudG9Qcm9taXNlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRWZXJzaW9uKCk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIEFkYi5nZXRWZXJzaW9uKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaGVja011eFN0YXR1cygpOiBQcm9taXNlPGJvb2xlYW4+IHtcclxuICB0cnkge1xyXG4gICAgYXdhaXQgcnVuQ29tbWFuZCgnYWRibXV4JywgWydzdGF0dXMnXSlcclxuICAgICAgLmlnbm9yZUVsZW1lbnRzKClcclxuICAgICAgLnRvUHJvbWlzZSgpO1xyXG4gIH0gY2F0Y2ggKF8pIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcbiAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGVja0luTXV4UG9ydChwb3J0OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcclxuICByZXR1cm4gcnVuQ29tbWFuZCgnYWRibXV4JywgWydjaGVja2luJywgYCR7cG9ydH1gXSlcclxuICAgIC5pZ25vcmVFbGVtZW50cygpXHJcbiAgICAudG9Qcm9taXNlKCk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjaGVja091dE11eFBvcnQocG9ydDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgcmV0dXJuIHJ1bkNvbW1hbmQoJ2FkYm11eCcsIFsnY2hlY2tvdXQnLCBgJHtwb3J0fWBdKVxyXG4gICAgLmlnbm9yZUVsZW1lbnRzKClcclxuICAgIC50b1Byb21pc2UoKTtcclxufVxyXG4iXX0=