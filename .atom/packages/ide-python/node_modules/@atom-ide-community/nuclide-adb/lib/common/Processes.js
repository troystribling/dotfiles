"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Processes = void 0;

var _collection = require("@atom-ide-community/nuclide-commons/collection");

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _os = _interopRequireDefault(require("os"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const VALID_PROCESS_REGEX = new RegExp(/\d+\s()/);

class Processes {
  constructor(adb) {
    this._adb = void 0;
    this._adb = adb;
  }

  _getGlobalProcessStat() {
    return this._adb.runShortCommand('shell', 'cat', '/proc/stat').map(stdout => stdout.split(/\n/)[0].trim());
  }

  _getProcStats() {
    return this._adb.runShortCommand('shell', 'for file in /proc/[0-9]*/stat; do cat "$file" 2>/dev/null || true; done').map(stdout => {
      return stdout.split(/\n/).filter(line => VALID_PROCESS_REGEX.test(line));
    });
  }

  fetch(timeout) {
    const internalTimeout = timeout * 2 / 3;
    return _rxjsCompatUmdMin.Observable.forkJoin(this._adb.getProcesses().timeout(internalTimeout).catch(() => _rxjsCompatUmdMin.Observable.of([])), this._adb.getDebuggableProcesses().timeout(internalTimeout).catch(() => _rxjsCompatUmdMin.Observable.of([])), this._getProcessAndMemoryUsage().timeout(internalTimeout).catch(() => _rxjsCompatUmdMin.Observable.of(new Map()))).map(([processes, javaProcesses, cpuAndMemUsage]) => {
      const javaPids = new Set(javaProcesses.map(javaProc => Number(javaProc.pid)));
      return (0, _collection.arrayCompact)(processes.map(simpleProcess => {
        const pid = parseInt(simpleProcess.pid, 10);

        if (!Number.isInteger(pid)) {
          return null;
        }

        const cpuAndMem = cpuAndMemUsage.get(pid);
        let cpu = null;
        let mem = null;

        if (cpuAndMem != null) {
          cpu = parseFloat(cpuAndMem[0]);
          mem = parseFloat(cpuAndMem[1]);
        }

        const isJava = javaPids.has(pid);
        return {
          user: simpleProcess.user,
          pid,
          name: simpleProcess.name,
          cpuUsage: cpu,
          memUsage: mem,
          isJava // TODO(wallace) rename this to debuggable or make this a list of possible debugger types

        };
      }));
    });
  }

  _getProcessAndMemoryUsage() {
    return _rxjsCompatUmdMin.Observable.interval(2000).startWith(0).switchMap(() => {
      return _rxjsCompatUmdMin.Observable.forkJoin(this._getProcessesTime(), this._getGlobalCPUTime());
    }).take(2).toArray().map(times => {
      const [procTimePrev, cpuTimePrev] = times[0];
      const [procTime, cpuTime] = times[1]; // pid => cpuUsage, memory usage

      const cpuAndMemUsage = new Map();
      const deltaCpu = cpuTime - cpuTimePrev;
      procTime.forEach((p1, pid) => {
        if (!procTimePrev.has(pid)) {
          return;
        }

        const p0 = procTimePrev.get(pid);

        if (p0 != null) {
          const deltaProc = p1[0] - p0[0];
          const memUsage = p1[1];
          cpuAndMemUsage.set(pid, [deltaProc / deltaCpu * 100, memUsage]);
        }
      });
      return cpuAndMemUsage;
    });
  }
  /**
   * Returns a map: pid => utime + stime
   */


  _getProcessesTime() {
    // We look for the all the /proc/PID/stat files failing silently if the process dies as the
    // command runs.
    return this._getProcStats().map(lines => {
      return new Map(lines.map(line => {
        const info = line.trim().split(/\s/);
        return [parseInt(info[0], 10), [parseInt(info[12], 10) + parseInt(info[13], 10), // stime + utime
        parseInt(info[23], 10) // RSS
        ]];
      }));
    });
  }

  _getGlobalCPUTime() {
    return this._getGlobalProcessStat().map(stdout => {
      return stdout.split(/\s+/).slice(1, -2).reduce((acc, current) => {
        return acc + parseInt(current, 10);
      }, 0);
    });
  }

  async getPidFromPackageName(packageName) {
    let pidLines;

    try {
      pidLines = await this._adb.runPsCommand('|', 'grep', '-i', packageName).toPromise();
    } catch (e) {
      pidLines = '';
    }

    const pidLine = pidLines.split(_os.default.EOL)[0];

    if (pidLine == null) {
      throw new Error(`Can not find a running process with package name: ${packageName}`);
    } // First column is 'USER', second is 'PID'.


    return parseInt(pidLine.trim().split(/\s+/)[1],
    /* radix */
    10);
  }

}

exports.Processes = Processes;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1hZGIvbGliL2NvbW1vbi9Qcm9jZXNzZXMuanMiXSwibmFtZXMiOlsiVkFMSURfUFJPQ0VTU19SRUdFWCIsIlJlZ0V4cCIsIlByb2Nlc3NlcyIsImNvbnN0cnVjdG9yIiwiYWRiIiwiX2FkYiIsIl9nZXRHbG9iYWxQcm9jZXNzU3RhdCIsInJ1blNob3J0Q29tbWFuZCIsIm1hcCIsInN0ZG91dCIsInNwbGl0IiwidHJpbSIsIl9nZXRQcm9jU3RhdHMiLCJmaWx0ZXIiLCJsaW5lIiwidGVzdCIsImZldGNoIiwidGltZW91dCIsImludGVybmFsVGltZW91dCIsIk9ic2VydmFibGUiLCJmb3JrSm9pbiIsImdldFByb2Nlc3NlcyIsImNhdGNoIiwib2YiLCJnZXREZWJ1Z2dhYmxlUHJvY2Vzc2VzIiwiX2dldFByb2Nlc3NBbmRNZW1vcnlVc2FnZSIsIk1hcCIsInByb2Nlc3NlcyIsImphdmFQcm9jZXNzZXMiLCJjcHVBbmRNZW1Vc2FnZSIsImphdmFQaWRzIiwiU2V0IiwiamF2YVByb2MiLCJOdW1iZXIiLCJwaWQiLCJzaW1wbGVQcm9jZXNzIiwicGFyc2VJbnQiLCJpc0ludGVnZXIiLCJjcHVBbmRNZW0iLCJnZXQiLCJjcHUiLCJtZW0iLCJwYXJzZUZsb2F0IiwiaXNKYXZhIiwiaGFzIiwidXNlciIsIm5hbWUiLCJjcHVVc2FnZSIsIm1lbVVzYWdlIiwiaW50ZXJ2YWwiLCJzdGFydFdpdGgiLCJzd2l0Y2hNYXAiLCJfZ2V0UHJvY2Vzc2VzVGltZSIsIl9nZXRHbG9iYWxDUFVUaW1lIiwidGFrZSIsInRvQXJyYXkiLCJ0aW1lcyIsInByb2NUaW1lUHJldiIsImNwdVRpbWVQcmV2IiwicHJvY1RpbWUiLCJjcHVUaW1lIiwiZGVsdGFDcHUiLCJmb3JFYWNoIiwicDEiLCJwMCIsImRlbHRhUHJvYyIsInNldCIsImxpbmVzIiwiaW5mbyIsInNsaWNlIiwicmVkdWNlIiwiYWNjIiwiY3VycmVudCIsImdldFBpZEZyb21QYWNrYWdlTmFtZSIsInBhY2thZ2VOYW1lIiwicGlkTGluZXMiLCJydW5Qc0NvbW1hbmQiLCJ0b1Byb21pc2UiLCJlIiwicGlkTGluZSIsIm9zIiwiRU9MIiwiRXJyb3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFlQTs7QUFDQTs7QUFDQTs7OztBQWpCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBV0EsTUFBTUEsbUJBQW1CLEdBQUcsSUFBSUMsTUFBSixDQUFXLFNBQVgsQ0FBNUI7O0FBRU8sTUFBTUMsU0FBTixDQUFnQjtBQUdyQkMsRUFBQUEsV0FBVyxDQUFDQyxHQUFELEVBQVc7QUFBQSxTQUZ0QkMsSUFFc0I7QUFDcEIsU0FBS0EsSUFBTCxHQUFZRCxHQUFaO0FBQ0Q7O0FBRURFLEVBQUFBLHFCQUFxQixHQUF1QjtBQUMxQyxXQUFPLEtBQUtELElBQUwsQ0FDSkUsZUFESSxDQUNZLE9BRFosRUFDcUIsS0FEckIsRUFDNEIsWUFENUIsRUFFSkMsR0FGSSxDQUVBQyxNQUFNLElBQUlBLE1BQU0sQ0FBQ0MsS0FBUCxDQUFhLElBQWIsRUFBbUIsQ0FBbkIsRUFBc0JDLElBQXRCLEVBRlYsQ0FBUDtBQUdEOztBQUVEQyxFQUFBQSxhQUFhLEdBQThCO0FBQ3pDLFdBQU8sS0FBS1AsSUFBTCxDQUNKRSxlQURJLENBRUgsT0FGRyxFQUdILHlFQUhHLEVBS0pDLEdBTEksQ0FLQUMsTUFBTSxJQUFJO0FBQ2IsYUFBT0EsTUFBTSxDQUNWQyxLQURJLENBQ0UsSUFERixFQUVKRyxNQUZJLENBRUdDLElBQUksSUFBSWQsbUJBQW1CLENBQUNlLElBQXBCLENBQXlCRCxJQUF6QixDQUZYLENBQVA7QUFHRCxLQVRJLENBQVA7QUFVRDs7QUFFREUsRUFBQUEsS0FBSyxDQUFDQyxPQUFELEVBQXlDO0FBQzVDLFVBQU1DLGVBQWUsR0FBSUQsT0FBTyxHQUFHLENBQVgsR0FBZ0IsQ0FBeEM7QUFDQSxXQUFPRSw2QkFBV0MsUUFBWCxDQUNMLEtBQUtmLElBQUwsQ0FDR2dC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OlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHR5cGUge0FkYn0gZnJvbSAnLi4vQWRiJztcclxuaW1wb3J0IHR5cGUge1Byb2Nlc3N9IGZyb20gJy4uL3R5cGVzJztcclxuXHJcbmltcG9ydCB7YXJyYXlDb21wYWN0fSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9jb2xsZWN0aW9uJztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xyXG5cclxudHlwZSBDUFVfTUVNID0gW251bWJlciwgbnVtYmVyXTtcclxuXHJcbmNvbnN0IFZBTElEX1BST0NFU1NfUkVHRVggPSBuZXcgUmVnRXhwKC9cXGQrXFxzKCkvKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBQcm9jZXNzZXMge1xyXG4gIF9hZGI6IEFkYjtcclxuXHJcbiAgY29uc3RydWN0b3IoYWRiOiBBZGIpIHtcclxuICAgIHRoaXMuX2FkYiA9IGFkYjtcclxuICB9XHJcblxyXG4gIF9nZXRHbG9iYWxQcm9jZXNzU3RhdCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX2FkYlxyXG4gICAgICAucnVuU2hvcnRDb21tYW5kKCdzaGVsbCcsICdjYXQnLCAnL3Byb2Mvc3RhdCcpXHJcbiAgICAgIC5tYXAoc3Rkb3V0ID0+IHN0ZG91dC5zcGxpdCgvXFxuLylbMF0udHJpbSgpKTtcclxuICB9XHJcblxyXG4gIF9nZXRQcm9jU3RhdHMoKTogT2JzZXJ2YWJsZTxBcnJheTxzdHJpbmc+PiB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWRiXHJcbiAgICAgIC5ydW5TaG9ydENvbW1hbmQoXHJcbiAgICAgICAgJ3NoZWxsJyxcclxuICAgICAgICAnZm9yIGZpbGUgaW4gL3Byb2MvWzAtOV0qL3N0YXQ7IGRvIGNhdCBcIiRmaWxlXCIgMj4vZGV2L251bGwgfHwgdHJ1ZTsgZG9uZScsXHJcbiAgICAgIClcclxuICAgICAgLm1hcChzdGRvdXQgPT4ge1xyXG4gICAgICAgIHJldHVybiBzdGRvdXRcclxuICAgICAgICAgIC5zcGxpdCgvXFxuLylcclxuICAgICAgICAgIC5maWx0ZXIobGluZSA9PiBWQUxJRF9QUk9DRVNTX1JFR0VYLnRlc3QobGluZSkpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIGZldGNoKHRpbWVvdXQ6IG51bWJlcik6IE9ic2VydmFibGU8UHJvY2Vzc1tdPiB7XHJcbiAgICBjb25zdCBpbnRlcm5hbFRpbWVvdXQgPSAodGltZW91dCAqIDIpIC8gMztcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLmZvcmtKb2luKFxyXG4gICAgICB0aGlzLl9hZGJcclxuICAgICAgICAuZ2V0UHJvY2Vzc2VzKClcclxuICAgICAgICAudGltZW91dChpbnRlcm5hbFRpbWVvdXQpXHJcbiAgICAgICAgLmNhdGNoKCgpID0+IE9ic2VydmFibGUub2YoW10pKSxcclxuICAgICAgdGhpcy5fYWRiXHJcbiAgICAgICAgLmdldERlYnVnZ2FibGVQcm9jZXNzZXMoKVxyXG4gICAgICAgIC50aW1lb3V0KGludGVybmFsVGltZW91dClcclxuICAgICAgICAuY2F0Y2goKCkgPT4gT2JzZXJ2YWJsZS5vZihbXSkpLFxyXG4gICAgICB0aGlzLl9nZXRQcm9jZXNzQW5kTWVtb3J5VXNhZ2UoKVxyXG4gICAgICAgIC50aW1lb3V0KGludGVybmFsVGltZW91dClcclxuICAgICAgICAuY2F0Y2goKCkgPT4gT2JzZXJ2YWJsZS5vZihuZXcgTWFwKCkpKSxcclxuICAgICkubWFwKChbcHJvY2Vzc2VzLCBqYXZhUHJvY2Vzc2VzLCBjcHVBbmRNZW1Vc2FnZV0pID0+IHtcclxuICAgICAgY29uc3QgamF2YVBpZHMgPSBuZXcgU2V0KFxyXG4gICAgICAgIGphdmFQcm9jZXNzZXMubWFwKGphdmFQcm9jID0+IE51bWJlcihqYXZhUHJvYy5waWQpKSxcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuIGFycmF5Q29tcGFjdChcclxuICAgICAgICBwcm9jZXNzZXMubWFwKHNpbXBsZVByb2Nlc3MgPT4ge1xyXG4gICAgICAgICAgY29uc3QgcGlkID0gcGFyc2VJbnQoc2ltcGxlUHJvY2Vzcy5waWQsIDEwKTtcclxuICAgICAgICAgIGlmICghTnVtYmVyLmlzSW50ZWdlcihwaWQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgY3B1QW5kTWVtID0gY3B1QW5kTWVtVXNhZ2UuZ2V0KHBpZCk7XHJcbiAgICAgICAgICBsZXQgY3B1ID0gbnVsbDtcclxuICAgICAgICAgIGxldCBtZW0gPSBudWxsO1xyXG4gICAgICAgICAgaWYgKGNwdUFuZE1lbSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNwdSA9IHBhcnNlRmxvYXQoY3B1QW5kTWVtWzBdKTtcclxuICAgICAgICAgICAgbWVtID0gcGFyc2VGbG9hdChjcHVBbmRNZW1bMV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgaXNKYXZhID0gamF2YVBpZHMuaGFzKHBpZCk7XHJcbiAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB1c2VyOiBzaW1wbGVQcm9jZXNzLnVzZXIsXHJcbiAgICAgICAgICAgIHBpZCxcclxuICAgICAgICAgICAgbmFtZTogc2ltcGxlUHJvY2Vzcy5uYW1lLFxyXG4gICAgICAgICAgICBjcHVVc2FnZTogY3B1LFxyXG4gICAgICAgICAgICBtZW1Vc2FnZTogbWVtLFxyXG4gICAgICAgICAgICBpc0phdmEsIC8vIFRPRE8od2FsbGFjZSkgcmVuYW1lIHRoaXMgdG8gZGVidWdnYWJsZSBvciBtYWtlIHRoaXMgYSBsaXN0IG9mIHBvc3NpYmxlIGRlYnVnZ2VyIHR5cGVzXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgIH0pLFxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBfZ2V0UHJvY2Vzc0FuZE1lbW9yeVVzYWdlKCk6IE9ic2VydmFibGU8TWFwPG51bWJlciwgQ1BVX01FTT4+IHtcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLmludGVydmFsKDIwMDApXHJcbiAgICAgIC5zdGFydFdpdGgoMClcclxuICAgICAgLnN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZm9ya0pvaW4oXHJcbiAgICAgICAgICB0aGlzLl9nZXRQcm9jZXNzZXNUaW1lKCksXHJcbiAgICAgICAgICB0aGlzLl9nZXRHbG9iYWxDUFVUaW1lKCksXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICAgLnRha2UoMilcclxuICAgICAgLnRvQXJyYXkoKVxyXG4gICAgICAubWFwKHRpbWVzID0+IHtcclxuICAgICAgICBjb25zdCBbcHJvY1RpbWVQcmV2LCBjcHVUaW1lUHJldl0gPSB0aW1lc1swXTtcclxuICAgICAgICBjb25zdCBbcHJvY1RpbWUsIGNwdVRpbWVdID0gdGltZXNbMV07XHJcbiAgICAgICAgLy8gcGlkID0+IGNwdVVzYWdlLCBtZW1vcnkgdXNhZ2VcclxuICAgICAgICBjb25zdCBjcHVBbmRNZW1Vc2FnZSA9IG5ldyBNYXAoKTtcclxuICAgICAgICBjb25zdCBkZWx0YUNwdSA9IGNwdVRpbWUgLSBjcHVUaW1lUHJldjtcclxuICAgICAgICBwcm9jVGltZS5mb3JFYWNoKChwMSwgcGlkKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXByb2NUaW1lUHJldi5oYXMocGlkKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBwMCA9IHByb2NUaW1lUHJldi5nZXQocGlkKTtcclxuICAgICAgICAgIGlmIChwMCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlbHRhUHJvYyA9IHAxWzBdIC0gcDBbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IG1lbVVzYWdlID0gcDFbMV07XHJcbiAgICAgICAgICAgIGNwdUFuZE1lbVVzYWdlLnNldChwaWQsIFsoZGVsdGFQcm9jIC8gZGVsdGFDcHUpICogMTAwLCBtZW1Vc2FnZV0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBjcHVBbmRNZW1Vc2FnZTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGEgbWFwOiBwaWQgPT4gdXRpbWUgKyBzdGltZVxyXG4gICAqL1xyXG4gIF9nZXRQcm9jZXNzZXNUaW1lKCk6IE9ic2VydmFibGU8TWFwPG51bWJlciwgQ1BVX01FTT4+IHtcclxuICAgIC8vIFdlIGxvb2sgZm9yIHRoZSBhbGwgdGhlIC9wcm9jL1BJRC9zdGF0IGZpbGVzIGZhaWxpbmcgc2lsZW50bHkgaWYgdGhlIHByb2Nlc3MgZGllcyBhcyB0aGVcclxuICAgIC8vIGNvbW1hbmQgcnVucy5cclxuICAgIHJldHVybiB0aGlzLl9nZXRQcm9jU3RhdHMoKS5tYXAobGluZXMgPT4ge1xyXG4gICAgICByZXR1cm4gbmV3IE1hcChcclxuICAgICAgICBsaW5lcy5tYXAobGluZSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBpbmZvID0gbGluZS50cmltKCkuc3BsaXQoL1xccy8pO1xyXG4gICAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgICAgcGFyc2VJbnQoaW5mb1swXSwgMTApLFxyXG4gICAgICAgICAgICBbXHJcbiAgICAgICAgICAgICAgcGFyc2VJbnQoaW5mb1sxMl0sIDEwKSArIHBhcnNlSW50KGluZm9bMTNdLCAxMCksIC8vIHN0aW1lICsgdXRpbWVcclxuICAgICAgICAgICAgICBwYXJzZUludChpbmZvWzIzXSwgMTApLCAvLyBSU1NcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgIF07XHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9nZXRHbG9iYWxDUFVUaW1lKCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fZ2V0R2xvYmFsUHJvY2Vzc1N0YXQoKS5tYXAoc3Rkb3V0ID0+IHtcclxuICAgICAgcmV0dXJuIHN0ZG91dFxyXG4gICAgICAgIC5zcGxpdCgvXFxzKy8pXHJcbiAgICAgICAgLnNsaWNlKDEsIC0yKVxyXG4gICAgICAgIC5yZWR1Y2UoKGFjYywgY3VycmVudCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIGFjYyArIHBhcnNlSW50KGN1cnJlbnQsIDEwKTtcclxuICAgICAgICB9LCAwKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZ2V0UGlkRnJvbVBhY2thZ2VOYW1lKHBhY2thZ2VOYW1lOiBzdHJpbmcpOiBQcm9taXNlPG51bWJlcj4ge1xyXG4gICAgbGV0IHBpZExpbmVzOiBzdHJpbmc7XHJcbiAgICB0cnkge1xyXG4gICAgICBwaWRMaW5lcyA9IGF3YWl0IHRoaXMuX2FkYlxyXG4gICAgICAgIC5ydW5Qc0NvbW1hbmQoJ3wnLCAnZ3JlcCcsICctaScsIHBhY2thZ2VOYW1lKVxyXG4gICAgICAgIC50b1Byb21pc2UoKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgcGlkTGluZXMgPSAnJztcclxuICAgIH1cclxuICAgIGNvbnN0IHBpZExpbmUgPSBwaWRMaW5lcy5zcGxpdChvcy5FT0wpWzBdO1xyXG4gICAgaWYgKHBpZExpbmUgPT0gbnVsbCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgYENhbiBub3QgZmluZCBhIHJ1bm5pbmcgcHJvY2VzcyB3aXRoIHBhY2thZ2UgbmFtZTogJHtwYWNrYWdlTmFtZX1gLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgLy8gRmlyc3QgY29sdW1uIGlzICdVU0VSJywgc2Vjb25kIGlzICdQSUQnLlxyXG4gICAgcmV0dXJuIHBhcnNlSW50KHBpZExpbmUudHJpbSgpLnNwbGl0KC9cXHMrLylbMV0sIC8qIHJhZGl4ICovIDEwKTtcclxuICB9XHJcbn1cclxuIl19