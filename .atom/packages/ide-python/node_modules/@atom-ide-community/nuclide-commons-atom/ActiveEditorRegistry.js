"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _debounced = require("./debounced");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _event = require("@atom-ide-community/nuclide-commons/event");

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _log4js = require("log4js");

var _paneItem = require("./pane-item");

var _ProviderRegistry = _interopRequireDefault(require("./ProviderRegistry"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * ActiveEditorRegistry provides abstractions for creating services that operate
 * on text editor contents.
 */
class ActiveEditorRegistry {
  constructor(resultFunction, eventSources = {}) {
    this._resultFunction = void 0;
    this._providerRegistry = void 0;
    this._newProviderEvents = void 0;
    this._resultsStream = void 0;
    this._resultFunction = resultFunction;
    this._providerRegistry = new _ProviderRegistry.default();
    this._newProviderEvents = new _rxjsCompatUmdMin.Subject();
    this._resultsStream = this._createResultsStream({
      activeEditors: eventSources.activeEditors || (0, _debounced.observeActiveEditorsDebounced)(),
      savesForEditor: eventSources.savesForEditor || (editor => {
        return (0, _event.observableFromSubscribeFunction)(callback => editor.onDidSave(callback)).mapTo(undefined);
      })
    });
  }

  consumeProvider(provider) {
    this._providerRegistry.addProvider(provider);

    this._newProviderEvents.next();

    return new _UniversalDisposable.default(() => {
      this._providerRegistry.removeProvider(provider);
    });
  }

  getResultsStream() {
    return this._resultsStream;
  }

  _createResultsStream(eventSources) {
    const repeatedEditors = eventSources.activeEditors.switchMap(editor => {
      if (editor == null) {
        return _rxjsCompatUmdMin.Observable.of(editor);
      }

      return _rxjsCompatUmdMin.Observable.concat(_rxjsCompatUmdMin.Observable.of(editor), this._newProviderEvents.mapTo(editor));
    });
    const results = repeatedEditors.switchMap(editorArg => {
      // Necessary so the type refinement holds in the callback later
      const editor = editorArg;

      if (editor == null) {
        return _rxjsCompatUmdMin.Observable.of({
          kind: 'not-text-editor'
        });
      }

      return _rxjsCompatUmdMin.Observable.concat( // Emit a pane change event first, so that clients can do something while waiting for a
      // provider to give a result.
      _rxjsCompatUmdMin.Observable.of({
        kind: 'pane-change',
        editor
      }), // wait for pending panes to no longer be pending, or if they're not,
      // get the result right away.
      ((0, _paneItem.isPending)(editor) ? (0, _paneItem.observePendingStateEnd)(editor).take(1) : _rxjsCompatUmdMin.Observable.of(null)).ignoreElements(), _rxjsCompatUmdMin.Observable.fromPromise(this._getResultForEditor(this._getProvidersForEditor(editor), editor)), this._resultsForEditor(editor, eventSources));
    });
    return (0, _observable.cacheWhileSubscribed)(results);
  }

  _resultsForEditor(editor, eventSources) {
    // It's possible that the active provider for an editor changes over time.
    // Thus, we have to subscribe to both edits and saves.
    return _rxjsCompatUmdMin.Observable.merge(eventSources.savesForEditor(editor).map(() => 'save')).flatMap(event => {
      const providers = this._getProvidersForEditor(editor);

      return _rxjsCompatUmdMin.Observable.concat( // $FlowIssue: {kind: save}
      _rxjsCompatUmdMin.Observable.of({
        kind: event,
        editor
      }), _rxjsCompatUmdMin.Observable.fromPromise(this._getResultForEditor(providers, editor)));
    });
  }

  _getProvidersForEditor(editor) {
    return [...this._providerRegistry.getAllProvidersForEditor(editor)];
  }

  async _getResultForEditor(providers, editor) {
    if (providers.length === 0) {
      return {
        kind: 'no-provider',
        grammar: editor.getGrammar()
      };
    }

    let errorResult;
    const results = await Promise.all(providers.map(async provider => {
      try {
        return await this._resultFunction(provider, editor);
      } catch (error) {
        (0, _log4js.getLogger)(this.constructor.name).error(`Error from provider for ${editor.getGrammar().scopeName}`, error);
        errorResult = {
          provider,
          kind: 'provider-error'
        };
      }
    }));

    if (errorResult != null) {
      return errorResult;
    }

    const resultIndex = results.findIndex(r => r != null);
    return {
      kind: 'result',
      result: results[resultIndex],
      provider: providers[resultIndex] || providers[0],
      editor
    };
  }

}

exports.default = ActiveEditorRegistry;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vQWN0aXZlRWRpdG9yUmVnaXN0cnkuanMiXSwibmFtZXMiOlsiQWN0aXZlRWRpdG9yUmVnaXN0cnkiLCJjb25zdHJ1Y3RvciIsInJlc3VsdEZ1bmN0aW9uIiwiZXZlbnRTb3VyY2VzIiwiX3Jlc3VsdEZ1bmN0aW9uIiwiX3Byb3ZpZGVyUmVnaXN0cnkiLCJfbmV3UHJvdmlkZXJFdmVudHMiLCJfcmVzdWx0c1N0cmVhbSIsIlByb3ZpZGVyUmVnaXN0cnkiLCJTdWJqZWN0IiwiX2NyZWF0ZVJlc3VsdHNTdHJlYW0iLCJhY3RpdmVFZGl0b3JzIiwic2F2ZXNGb3JFZGl0b3IiLCJlZGl0b3IiLCJjYWxsYmFjayIsIm9uRGlkU2F2ZSIsIm1hcFRvIiwidW5kZWZpbmVkIiwiY29uc3VtZVByb3ZpZGVyIiwicHJvdmlkZXIiLCJhZGRQcm92aWRlciIsIm5leHQiLCJVbml2ZXJzYWxEaXNwb3NhYmxlIiwicmVtb3ZlUHJvdmlkZXIiLCJnZXRSZXN1bHRzU3RyZWFtIiwicmVwZWF0ZWRFZGl0b3JzIiwic3dpdGNoTWFwIiwiT2JzZXJ2YWJsZSIsIm9mIiwiY29uY2F0IiwicmVzdWx0cyIsImVkaXRvckFyZyIsImtpbmQiLCJ0YWtlIiwiaWdub3JlRWxlbWVudHMiLCJmcm9tUHJvbWlzZSIsIl9nZXRSZXN1bHRGb3JFZGl0b3IiLCJfZ2V0UHJvdmlkZXJzRm9yRWRpdG9yIiwiX3Jlc3VsdHNGb3JFZGl0b3IiLCJtZXJnZSIsIm1hcCIsImZsYXRNYXAiLCJldmVudCIsInByb3ZpZGVycyIsImdldEFsbFByb3ZpZGVyc0ZvckVkaXRvciIsImxlbmd0aCIsImdyYW1tYXIiLCJnZXRHcmFtbWFyIiwiZXJyb3JSZXN1bHQiLCJQcm9taXNlIiwiYWxsIiwiZXJyb3IiLCJuYW1lIiwic2NvcGVOYW1lIiwicmVzdWx0SW5kZXgiLCJmaW5kSW5kZXgiLCJyIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBaUJBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUVBOztBQUNBOzs7O0FBMUJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFpRWUsTUFBTUEsb0JBQU4sQ0FBMkM7QUFNeERDLEVBQUFBLFdBQVcsQ0FDVEMsY0FEUyxFQUVUQyxZQUFpQyxHQUFHLEVBRjNCLEVBR1Q7QUFBQSxTQVJGQyxlQVFFO0FBQUEsU0FQRkMsaUJBT0U7QUFBQSxTQU5GQyxrQkFNRTtBQUFBLFNBTEZDLGNBS0U7QUFDQSxTQUFLSCxlQUFMLEdBQXVCRixjQUF2QjtBQUNBLFNBQUtHLGlCQUFMLEdBQXlCLElBQUlHLHlCQUFKLEVBQXpCO0FBQ0EsU0FBS0Ysa0JBQUwsR0FBMEIsSUFBSUcseUJBQUosRUFBMUI7QUFDQSxTQUFLRixjQUFMLEdBQXNCLEtBQUtHLG9CQUFMLENBQTBCO0FBQzlDQyxNQUFBQSxhQUFhLEVBQ1hSLFlBQVksQ0FBQ1EsYUFBYixJQUE4QiwrQ0FGYztBQUc5Q0MsTUFBQUEsY0FBYyxFQUNaVCxZQUFZLENBQUNTLGNBQWIsS0FDQ0MsTUFBTSxJQUFJO0FBQ1QsZUFBTyw0Q0FBZ0NDLFFBQVEsSUFDN0NELE1BQU0sQ0FBQ0UsU0FBUCxDQUFpQkQsUUFBakIsQ0FESyxFQUVMRSxLQUZLLENBRUNDLFNBRkQsQ0FBUDtBQUdELE9BTEQ7QUFKNEMsS0FBMUIsQ0FBdEI7QUFXRDs7QUFFREMsRUFBQUEsZUFBZSxDQUFDQyxRQUFELEVBQTJCO0FBQ3hDLFNBQUtkLGlCQUFMLENBQXVCZSxXQUF2QixDQUFtQ0QsUUFBbkM7O0FBQ0EsU0FBS2Isa0JBQUwsQ0FBd0JlLElBQXhCOztBQUNBLFdBQU8sSUFBSUMsNEJBQUosQ0FBd0IsTUFBTTtBQUNuQyxXQUFLakIsaUJBQUwsQ0FBdUJrQixjQUF2QixDQUFzQ0osUUFBdEM7QUFDRCxLQUZNLENBQVA7QUFHRDs7QUFFREssRUFBQUEsZ0JBQWdCLEdBQTZCO0FBQzNDLFdBQU8sS0FBS2pCLGNBQVo7QUFDRDs7QUFFREcsRUFBQUEsb0JBQW9CLENBQUNQLFlBQUQsRUFBdUQ7QUFDekUsVUFBTXNCLGVBQWUsR0FBR3RCLFlBQVksQ0FBQ1EsYUFBYixDQUEyQmUsU0FBM0IsQ0FBcUNiLE1BQU0sSUFBSTtBQUNyRSxVQUFJQSxNQUFNLElBQUksSUFBZCxFQUFvQjtBQUNsQixlQUFPYyw2QkFBV0MsRUFBWCxDQUFjZixNQUFkLENBQVA7QUFDRDs7QUFDRCxhQUFPYyw2QkFBV0UsTUFBWCxDQUNMRiw2QkFBV0MsRUFBWCxDQUFjZixNQUFkLENBREssRUFFTCxLQUFLUCxrQkFBTCxDQUF3QlUsS0FBeEIsQ0FBOEJILE1BQTlCLENBRkssQ0FBUDtBQUlELEtBUnVCLENBQXhCO0FBU0EsVUFBTWlCLE9BQU8sR0FBR0wsZUFBZSxDQUFDQyxTQUFoQixDQUEwQkssU0FBUyxJQUFJO0FBQ3JEO0FBQ0EsWUFBTWxCLE1BQU0sR0FBR2tCLFNBQWY7O0FBQ0EsVUFBSWxCLE1BQU0sSUFBSSxJQUFkLEVBQW9CO0FBQ2xCLGVBQU9jLDZCQUFXQyxFQUFYLENBQWM7QUFBQ0ksVUFBQUEsSUFBSSxFQUFFO0FBQVAsU0FBZCxDQUFQO0FBQ0Q7O0FBRUQsYUFBT0wsNkJBQVdFLE1BQVgsRUFDTDtBQUNBO0FBQ0FGLG1DQUFXQyxFQUFYLENBQWM7QUFDWkksUUFBQUEsSUFBSSxFQUFFLGFBRE07QUFFWm5CLFFBQUFBO0FBRlksT0FBZCxDQUhLLEVBT0w7QUFDQTtBQUNBLE9BQUMseUJBQVVBLE1BQVYsSUFDRyxzQ0FBdUJBLE1BQXZCLEVBQStCb0IsSUFBL0IsQ0FBb0MsQ0FBcEMsQ0FESCxHQUVHTiw2QkFBV0MsRUFBWCxDQUFjLElBQWQsQ0FGSixFQUdFTSxjQUhGLEVBVEssRUFhTFAsNkJBQVdRLFdBQVgsQ0FDRSxLQUFLQyxtQkFBTCxDQUF5QixLQUFLQyxzQkFBTCxDQUE0QnhCLE1BQTVCLENBQXpCLEVBQThEQSxNQUE5RCxDQURGLENBYkssRUFnQkwsS0FBS3lCLGlCQUFMLENBQXVCekIsTUFBdkIsRUFBK0JWLFlBQS9CLENBaEJLLENBQVA7QUFrQkQsS0F6QmUsQ0FBaEI7QUEwQkEsV0FBTyxzQ0FBcUIyQixPQUFyQixDQUFQO0FBQ0Q7O0FBRURRLEVBQUFBLGlCQUFpQixDQUNmekIsTUFEZSxFQUVmVixZQUZlLEVBR1c7QUFDMUI7QUFDQTtBQUNBLFdBQU93Qiw2QkFBV1ksS0FBWCxDQUNMcEMsWUFBWSxDQUFDUyxjQUFiLENBQTRCQyxNQUE1QixFQUFvQzJCLEdBQXBDLENBQXdDLE1BQU0sTUFBOUMsQ0FESyxFQUVMQyxPQUZLLENBRUdDLEtBQUssSUFBSTtBQUNqQixZQUFNQyxTQUFTLEdBQUcsS0FBS04sc0JBQUwsQ0FBNEJ4QixNQUE1QixDQUFsQjs7QUFDQSxhQUFPYyw2QkFBV0UsTUFBWCxFQUNMO0FBQ0FGLG1DQUFXQyxFQUFYLENBQWM7QUFBQ0ksUUFBQUEsSUFBSSxFQUFFVSxLQUFQO0FBQWM3QixRQUFBQTtBQUFkLE9BQWQsQ0FGSyxFQUdMYyw2QkFBV1EsV0FBWCxDQUF1QixLQUFLQyxtQkFBTCxDQUF5Qk8sU0FBekIsRUFBb0M5QixNQUFwQyxDQUF2QixDQUhLLENBQVA7QUFLRCxLQVRNLENBQVA7QUFVRDs7QUFFRHdCLEVBQUFBLHNCQUFzQixDQUFDeEIsTUFBRCxFQUFvQztBQUN4RCxXQUFPLENBQUMsR0FBRyxLQUFLUixpQkFBTCxDQUF1QnVDLHdCQUF2QixDQUFnRC9CLE1BQWhELENBQUosQ0FBUDtBQUNEOztBQUV3QixRQUFuQnVCLG1CQUFtQixDQUN2Qk8sU0FEdUIsRUFFdkI5QixNQUZ1QixFQUdBO0FBQ3ZCLFFBQUk4QixTQUFTLENBQUNFLE1BQVYsS0FBcUIsQ0FBekIsRUFBNEI7QUFDMUIsYUFBTztBQUNMYixRQUFBQSxJQUFJLEVBQUUsYUFERDtBQUVMYyxRQUFBQSxPQUFPLEVBQUVqQyxNQUFNLENBQUNrQyxVQUFQO0FBRkosT0FBUDtBQUlEOztBQUNELFFBQUlDLFdBQUo7QUFDQSxVQUFNbEIsT0FBTyxHQUFHLE1BQU1tQixPQUFPLENBQUNDLEdBQVIsQ0FDcEJQLFNBQVMsQ0FBQ0gsR0FBVixDQUFjLE1BQU1yQixRQUFOLElBQWtCO0FBQzlCLFVBQUk7QUFDRixlQUFPLE1BQU0sS0FBS2YsZUFBTCxDQUFxQmUsUUFBckIsRUFBK0JOLE1BQS9CLENBQWI7QUFDRCxPQUZELENBRUUsT0FBT3NDLEtBQVAsRUFBYztBQUNkLCtCQUFVLEtBQUtsRCxXQUFMLENBQWlCbUQsSUFBM0IsRUFBaUNELEtBQWpDLENBQ0csMkJBQTBCdEMsTUFBTSxDQUFDa0MsVUFBUCxHQUFvQk0sU0FBVSxFQUQzRCxFQUVFRixLQUZGO0FBSUFILFFBQUFBLFdBQVcsR0FBRztBQUNaN0IsVUFBQUEsUUFEWTtBQUVaYSxVQUFBQSxJQUFJLEVBQUU7QUFGTSxTQUFkO0FBSUQ7QUFDRixLQWJELENBRG9CLENBQXRCOztBQWdCQSxRQUFJZ0IsV0FBVyxJQUFJLElBQW5CLEVBQXlCO0FBQ3ZCLGFBQU9BLFdBQVA7QUFDRDs7QUFDRCxVQUFNTSxXQUFXLEdBQUd4QixPQUFPLENBQUN5QixTQUFSLENBQWtCQyxDQUFDLElBQUlBLENBQUMsSUFBSSxJQUE1QixDQUFwQjtBQUNBLFdBQU87QUFDTHhCLE1BQUFBLElBQUksRUFBRSxRQUREO0FBRUx5QixNQUFBQSxNQUFNLEVBQUczQixPQUFPLENBQUN3QixXQUFELENBRlg7QUFHTG5DLE1BQUFBLFFBQVEsRUFBRXdCLFNBQVMsQ0FBQ1csV0FBRCxDQUFULElBQTBCWCxTQUFTLENBQUMsQ0FBRCxDQUh4QztBQUlMOUIsTUFBQUE7QUFKSyxLQUFQO0FBTUQ7O0FBeEl1RCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBBY3RpdmVFZGl0b3JSZWdpc3RyeSBwcm92aWRlcyBhYnN0cmFjdGlvbnMgZm9yIGNyZWF0aW5nIHNlcnZpY2VzIHRoYXQgb3BlcmF0ZVxyXG4gKiBvbiB0ZXh0IGVkaXRvciBjb250ZW50cy5cclxuICovXHJcblxyXG5pbXBvcnQge09ic2VydmFibGUsIFN1YmplY3R9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcbmltcG9ydCB7b2JzZXJ2ZUFjdGl2ZUVkaXRvcnNEZWJvdW5jZWR9IGZyb20gJy4vZGVib3VuY2VkJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCB7b2JzZXJ2YWJsZUZyb21TdWJzY3JpYmVGdW5jdGlvbn0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvZXZlbnQnO1xyXG5pbXBvcnQge2NhY2hlV2hpbGVTdWJzY3JpYmVkfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9vYnNlcnZhYmxlJztcclxuXHJcbmltcG9ydCB7Z2V0TG9nZ2VyfSBmcm9tICdsb2c0anMnO1xyXG5cclxuaW1wb3J0IHtpc1BlbmRpbmcsIG9ic2VydmVQZW5kaW5nU3RhdGVFbmR9IGZyb20gJy4vcGFuZS1pdGVtJztcclxuaW1wb3J0IFByb3ZpZGVyUmVnaXN0cnkgZnJvbSAnLi9Qcm92aWRlclJlZ2lzdHJ5JztcclxuXHJcbmV4cG9ydCB0eXBlIFByb3ZpZGVyID0ge1xyXG4gIHByaW9yaXR5OiBudW1iZXIsXHJcbiAgK2dyYW1tYXJTY29wZXM/OiBBcnJheTxzdHJpbmc+LFxyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgUmVzdWx0PFQsIFY+ID1cclxuICB8IHtcclxuICAgICAga2luZDogJ25vdC10ZXh0LWVkaXRvcicsXHJcbiAgICB9XHJcbiAgfCB7XHJcbiAgICAgIGtpbmQ6ICduby1wcm92aWRlcicsXHJcbiAgICAgIGdyYW1tYXI6IGF0b20kR3JhbW1hcixcclxuICAgIH1cclxuICB8IHtcclxuICAgICAga2luZDogJ3Byb3ZpZGVyLWVycm9yJyxcclxuICAgICAgcHJvdmlkZXI6IFQsXHJcbiAgICB9XHJcbiAgfCB7XHJcbiAgICAgIC8vIFNpbmNlIHByb3ZpZGVycyBjYW4gYmUgc2xvdywgdGhlIHBhbmUtY2hhbmdlIGFuZCBlZGl0IGV2ZW50cyBhcmUgZW1pdHRlZCBpbW1lZGlhdGVseSBpbiBjYXNlXHJcbiAgICAgIC8vIHRoZSBVSSBuZWVkcyB0byBjbGVhciBvdXRkYXRlZCByZXN1bHRzLlxyXG4gICAgICBraW5kOiAncGFuZS1jaGFuZ2UnLFxyXG4gICAgICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcclxuICAgIH1cclxuICB8IHtcclxuICAgICAga2luZDogJ3NhdmUnLFxyXG4gICAgICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcclxuICAgIH1cclxuICB8IHtcclxuICAgICAga2luZDogJ3Jlc3VsdCcsXHJcbiAgICAgIHJlc3VsdDogVixcclxuICAgICAgLy8gVGhlIGVkaXRvciB0aGF0IHRoZSByZXN1bHQgd2FzIGNvbXB1dGVkIGZyb21cclxuICAgICAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbiAgICAgIC8vIFRoZSBwcm92aWRlciB0aGF0IGNvbXB1dGVkIHRoZSByZXN1bHRcclxuICAgICAgLy8gVE9ETyBVc2UgYSB0eXBlIHBhcmFtZXRlciBmb3IgdGhpcyB0eXBlXHJcbiAgICAgIHByb3ZpZGVyOiBULFxyXG4gICAgfTtcclxuXHJcbmV4cG9ydCB0eXBlIFJlc3VsdEZ1bmN0aW9uPFQsIFY+ID0gKFxyXG4gIHByb3ZpZGVyOiBULFxyXG4gIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxyXG4pID0+IFByb21pc2U8Vj47XHJcblxyXG50eXBlIFBhcnRpYWxFdmVudFNvdXJjZXMgPSB7XHJcbiAgK2FjdGl2ZUVkaXRvcnM/OiBPYnNlcnZhYmxlPD9hdG9tJFRleHRFZGl0b3I+LFxyXG4gICtzYXZlc0ZvckVkaXRvcj86IChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikgPT4gT2JzZXJ2YWJsZTx2b2lkPixcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEV2ZW50U291cmNlcyA9IHtcclxuICBhY3RpdmVFZGl0b3JzOiBPYnNlcnZhYmxlPD9hdG9tJFRleHRFZGl0b3I+LFxyXG4gIHNhdmVzRm9yRWRpdG9yOiAoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IpID0+IE9ic2VydmFibGU8dm9pZD4sXHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBY3RpdmVFZGl0b3JSZWdpc3RyeTxUOiBQcm92aWRlciwgVj4ge1xyXG4gIF9yZXN1bHRGdW5jdGlvbjogUmVzdWx0RnVuY3Rpb248VCwgVj47XHJcbiAgX3Byb3ZpZGVyUmVnaXN0cnk6IFByb3ZpZGVyUmVnaXN0cnk8VD47XHJcbiAgX25ld1Byb3ZpZGVyRXZlbnRzOiBTdWJqZWN0PHZvaWQ+O1xyXG4gIF9yZXN1bHRzU3RyZWFtOiBPYnNlcnZhYmxlPFJlc3VsdDxULCBWPj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcmVzdWx0RnVuY3Rpb246IFJlc3VsdEZ1bmN0aW9uPFQsIFY+LFxyXG4gICAgZXZlbnRTb3VyY2VzOiBQYXJ0aWFsRXZlbnRTb3VyY2VzID0ge30sXHJcbiAgKSB7XHJcbiAgICB0aGlzLl9yZXN1bHRGdW5jdGlvbiA9IHJlc3VsdEZ1bmN0aW9uO1xyXG4gICAgdGhpcy5fcHJvdmlkZXJSZWdpc3RyeSA9IG5ldyBQcm92aWRlclJlZ2lzdHJ5KCk7XHJcbiAgICB0aGlzLl9uZXdQcm92aWRlckV2ZW50cyA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICB0aGlzLl9yZXN1bHRzU3RyZWFtID0gdGhpcy5fY3JlYXRlUmVzdWx0c1N0cmVhbSh7XHJcbiAgICAgIGFjdGl2ZUVkaXRvcnM6XHJcbiAgICAgICAgZXZlbnRTb3VyY2VzLmFjdGl2ZUVkaXRvcnMgfHwgb2JzZXJ2ZUFjdGl2ZUVkaXRvcnNEZWJvdW5jZWQoKSxcclxuICAgICAgc2F2ZXNGb3JFZGl0b3I6XHJcbiAgICAgICAgZXZlbnRTb3VyY2VzLnNhdmVzRm9yRWRpdG9yIHx8XHJcbiAgICAgICAgKGVkaXRvciA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gb2JzZXJ2YWJsZUZyb21TdWJzY3JpYmVGdW5jdGlvbihjYWxsYmFjayA9PlxyXG4gICAgICAgICAgICBlZGl0b3Iub25EaWRTYXZlKGNhbGxiYWNrKSxcclxuICAgICAgICAgICkubWFwVG8odW5kZWZpbmVkKTtcclxuICAgICAgICB9KSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY29uc3VtZVByb3ZpZGVyKHByb3ZpZGVyOiBUKTogSURpc3Bvc2FibGUge1xyXG4gICAgdGhpcy5fcHJvdmlkZXJSZWdpc3RyeS5hZGRQcm92aWRlcihwcm92aWRlcik7XHJcbiAgICB0aGlzLl9uZXdQcm92aWRlckV2ZW50cy5uZXh0KCk7XHJcbiAgICByZXR1cm4gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoKCkgPT4ge1xyXG4gICAgICB0aGlzLl9wcm92aWRlclJlZ2lzdHJ5LnJlbW92ZVByb3ZpZGVyKHByb3ZpZGVyKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0UmVzdWx0c1N0cmVhbSgpOiBPYnNlcnZhYmxlPFJlc3VsdDxULCBWPj4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3Jlc3VsdHNTdHJlYW07XHJcbiAgfVxyXG5cclxuICBfY3JlYXRlUmVzdWx0c1N0cmVhbShldmVudFNvdXJjZXM6IEV2ZW50U291cmNlcyk6IE9ic2VydmFibGU8UmVzdWx0PFQsIFY+PiB7XHJcbiAgICBjb25zdCByZXBlYXRlZEVkaXRvcnMgPSBldmVudFNvdXJjZXMuYWN0aXZlRWRpdG9ycy5zd2l0Y2hNYXAoZWRpdG9yID0+IHtcclxuICAgICAgaWYgKGVkaXRvciA9PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUub2YoZWRpdG9yKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoXHJcbiAgICAgICAgT2JzZXJ2YWJsZS5vZihlZGl0b3IpLFxyXG4gICAgICAgIHRoaXMuX25ld1Byb3ZpZGVyRXZlbnRzLm1hcFRvKGVkaXRvciksXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IHJlc3VsdHMgPSByZXBlYXRlZEVkaXRvcnMuc3dpdGNoTWFwKGVkaXRvckFyZyA9PiB7XHJcbiAgICAgIC8vIE5lY2Vzc2FyeSBzbyB0aGUgdHlwZSByZWZpbmVtZW50IGhvbGRzIGluIHRoZSBjYWxsYmFjayBsYXRlclxyXG4gICAgICBjb25zdCBlZGl0b3IgPSBlZGl0b3JBcmc7XHJcbiAgICAgIGlmIChlZGl0b3IgPT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLm9mKHtraW5kOiAnbm90LXRleHQtZWRpdG9yJ30pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jb25jYXQoXHJcbiAgICAgICAgLy8gRW1pdCBhIHBhbmUgY2hhbmdlIGV2ZW50IGZpcnN0LCBzbyB0aGF0IGNsaWVudHMgY2FuIGRvIHNvbWV0aGluZyB3aGlsZSB3YWl0aW5nIGZvciBhXHJcbiAgICAgICAgLy8gcHJvdmlkZXIgdG8gZ2l2ZSBhIHJlc3VsdC5cclxuICAgICAgICBPYnNlcnZhYmxlLm9mKHtcclxuICAgICAgICAgIGtpbmQ6ICdwYW5lLWNoYW5nZScsXHJcbiAgICAgICAgICBlZGl0b3IsXHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgLy8gd2FpdCBmb3IgcGVuZGluZyBwYW5lcyB0byBubyBsb25nZXIgYmUgcGVuZGluZywgb3IgaWYgdGhleSdyZSBub3QsXHJcbiAgICAgICAgLy8gZ2V0IHRoZSByZXN1bHQgcmlnaHQgYXdheS5cclxuICAgICAgICAoaXNQZW5kaW5nKGVkaXRvcilcclxuICAgICAgICAgID8gb2JzZXJ2ZVBlbmRpbmdTdGF0ZUVuZChlZGl0b3IpLnRha2UoMSlcclxuICAgICAgICAgIDogT2JzZXJ2YWJsZS5vZihudWxsKVxyXG4gICAgICAgICkuaWdub3JlRWxlbWVudHMoKSxcclxuICAgICAgICBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKFxyXG4gICAgICAgICAgdGhpcy5fZ2V0UmVzdWx0Rm9yRWRpdG9yKHRoaXMuX2dldFByb3ZpZGVyc0ZvckVkaXRvcihlZGl0b3IpLCBlZGl0b3IpLFxyXG4gICAgICAgICksXHJcbiAgICAgICAgdGhpcy5fcmVzdWx0c0ZvckVkaXRvcihlZGl0b3IsIGV2ZW50U291cmNlcyksXHJcbiAgICAgICk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjYWNoZVdoaWxlU3Vic2NyaWJlZChyZXN1bHRzKTtcclxuICB9XHJcblxyXG4gIF9yZXN1bHRzRm9yRWRpdG9yKFxyXG4gICAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbiAgICBldmVudFNvdXJjZXM6IEV2ZW50U291cmNlcyxcclxuICApOiBPYnNlcnZhYmxlPFJlc3VsdDxULCBWPj4ge1xyXG4gICAgLy8gSXQncyBwb3NzaWJsZSB0aGF0IHRoZSBhY3RpdmUgcHJvdmlkZXIgZm9yIGFuIGVkaXRvciBjaGFuZ2VzIG92ZXIgdGltZS5cclxuICAgIC8vIFRodXMsIHdlIGhhdmUgdG8gc3Vic2NyaWJlIHRvIGJvdGggZWRpdHMgYW5kIHNhdmVzLlxyXG4gICAgcmV0dXJuIE9ic2VydmFibGUubWVyZ2UoXHJcbiAgICAgIGV2ZW50U291cmNlcy5zYXZlc0ZvckVkaXRvcihlZGl0b3IpLm1hcCgoKSA9PiAnc2F2ZScpLFxyXG4gICAgKS5mbGF0TWFwKGV2ZW50ID0+IHtcclxuICAgICAgY29uc3QgcHJvdmlkZXJzID0gdGhpcy5fZ2V0UHJvdmlkZXJzRm9yRWRpdG9yKGVkaXRvcik7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNvbmNhdChcclxuICAgICAgICAvLyAkRmxvd0lzc3VlOiB7a2luZDogc2F2ZX1cclxuICAgICAgICBPYnNlcnZhYmxlLm9mKHtraW5kOiBldmVudCwgZWRpdG9yfSksXHJcbiAgICAgICAgT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZSh0aGlzLl9nZXRSZXN1bHRGb3JFZGl0b3IocHJvdmlkZXJzLCBlZGl0b3IpKSxcclxuICAgICAgKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgX2dldFByb3ZpZGVyc0ZvckVkaXRvcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IEFycmF5PFQ+IHtcclxuICAgIHJldHVybiBbLi4udGhpcy5fcHJvdmlkZXJSZWdpc3RyeS5nZXRBbGxQcm92aWRlcnNGb3JFZGl0b3IoZWRpdG9yKV07XHJcbiAgfVxyXG5cclxuICBhc3luYyBfZ2V0UmVzdWx0Rm9yRWRpdG9yKFxyXG4gICAgcHJvdmlkZXJzOiBBcnJheTxUPixcclxuICAgIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxyXG4gICk6IFByb21pc2U8UmVzdWx0PFQsIFY+PiB7XHJcbiAgICBpZiAocHJvdmlkZXJzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIGtpbmQ6ICduby1wcm92aWRlcicsXHJcbiAgICAgICAgZ3JhbW1hcjogZWRpdG9yLmdldEdyYW1tYXIoKSxcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGxldCBlcnJvclJlc3VsdDtcclxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgICAgcHJvdmlkZXJzLm1hcChhc3luYyBwcm92aWRlciA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9yZXN1bHRGdW5jdGlvbihwcm92aWRlciwgZWRpdG9yKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgICAgZ2V0TG9nZ2VyKHRoaXMuY29uc3RydWN0b3IubmFtZSkuZXJyb3IoXHJcbiAgICAgICAgICAgIGBFcnJvciBmcm9tIHByb3ZpZGVyIGZvciAke2VkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lfWAsXHJcbiAgICAgICAgICAgIGVycm9yLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIGVycm9yUmVzdWx0ID0ge1xyXG4gICAgICAgICAgICBwcm92aWRlcixcclxuICAgICAgICAgICAga2luZDogJ3Byb3ZpZGVyLWVycm9yJyxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgICBpZiAoZXJyb3JSZXN1bHQgIT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gZXJyb3JSZXN1bHQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHRJbmRleCA9IHJlc3VsdHMuZmluZEluZGV4KHIgPT4gciAhPSBudWxsKTtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGtpbmQ6ICdyZXN1bHQnLFxyXG4gICAgICByZXN1bHQ6IChyZXN1bHRzW3Jlc3VsdEluZGV4XTogYW55KSxcclxuICAgICAgcHJvdmlkZXI6IHByb3ZpZGVyc1tyZXN1bHRJbmRleF0gfHwgcHJvdmlkZXJzWzBdLFxyXG4gICAgICBlZGl0b3IsXHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG4iXX0=