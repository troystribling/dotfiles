"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * A wrapper over the specified Atom's config functions.
 * Each individual loaded package's config is a subconfig of the root package.
 */
class ConfigManager {
  constructor(config) {
    this._packageName = void 0;
    this._config = void 0;
    this._config = config;
  }

  getConfig() {
    return this._config;
  }
  /**
   * Sets the root package name.
   * This gets automatically called from FeatureLoader.
   */


  setPackageName(name) {
    this._packageName = name;
  }

  getPackageName() {
    (0, _assert.default)(this._packageName != null, 'No package name available');
    return this._packageName;
  }

  formatKeyPath(keyPath) {
    if (this._packageName == null) {
      return keyPath;
    }

    return `${this._packageName}.${keyPath}`;
  }
  /*
   * Returns the value of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.get` except `keyPath` is not optional. To get the entire config object, use
   * `atom.config.get`.
   *
   * Note: This is intentionally typed as mixed, this way each call site has to
   * first cast it as any and it is obvious that this is an area that is not safe
   * and flow will not proceed if the callsite doesn't do it.
   *
   * Example:
   *   const config: MyConfigType = (featureConfig.get('config-name'): any);
   */


  get(keyPath, options) {
    // atom.config.get will crash if the second arg is present and undefined.
    // It does not crash if the second arg is missing.
    return this._config.get(this.formatKeyPath(keyPath), ...(options == null ? [] : [options]));
  }

  getWithDefaults(keyPath, defaults, options) {
    const current = this.get(keyPath, options);
    return current == null ? defaults : current;
  }
  /*
   * Gets the schema of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.getSchema`.
   */


  getSchema(keyPath) {
    return this._config.getSchema(this.formatKeyPath(keyPath));
  }
  /*
   * Similar to `atom.config.observe` except arguments are required, and options cannot be given.
   *
   * To observe changes on the entire config, use `atom.config.observe`.
   */


  observe(keyPath, optionsOrCallback, callback) {
    return this._config.observe(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Behaves similarly to the `observe` function, but returns a stream of values, rather
   * than receiving a callback.
   */


  observeAsStream(keyPath, options = {}) {
    return _rxjsCompatUmdMin.Observable.create(observer => {
      const disposable = this.observe(keyPath, options, observer.next.bind(observer));
      return disposable.dispose.bind(disposable);
    });
  }
  /*
   * Takes and returns the same types as `atom.config.onDidChange` except `keyPath` is not optional.
   * To listen to changes on all key paths, use `atom.config.onDidChange`.
   */


  onDidChange(keyPath, optionsOrCallback, callback) {
    return this._config.onDidChange(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Sets the value of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.set`.
   */


  set(keyPath, value, options) {
    return this._config.set(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Sets the schema of a setting for a Nuclide feature key. Takes and returns the same types as
   * `atom.config.setSchema`.
   */


  setSchema(keyPath, schema) {
    return this._config.setSchema(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /*
   * Restores a setting for a Nuclide feature key to its default value. Takes and returns the same
   * types as `atom.config.set`.
   */


  unset(keyPath, options) {
    return this._config.unset(this.formatKeyPath(keyPath), ...Array.prototype.slice.call(arguments, 1));
  }
  /**
   * Returns `true` if the feature with the given name is disabled either directly or because the
   * container package itself is disabled.
   */


  isFeatureDisabled(name) {
    if (this._packageName == null) {
      return atom.packages.isPackageDisabled(name);
    }

    return atom.packages.isPackageDisabled(this._packageName) || // $FlowFixMe flow doesn't register this._packageName as non-null here
    !this._config.get(`${this._packageName}.use.${name}`);
  }

}

exports.default = ConfigManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vQ29uZmlnTWFuYWdlci5qcyJdLCJuYW1lcyI6WyJDb25maWdNYW5hZ2VyIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJfcGFja2FnZU5hbWUiLCJfY29uZmlnIiwiZ2V0Q29uZmlnIiwic2V0UGFja2FnZU5hbWUiLCJuYW1lIiwiZ2V0UGFja2FnZU5hbWUiLCJmb3JtYXRLZXlQYXRoIiwia2V5UGF0aCIsImdldCIsIm9wdGlvbnMiLCJnZXRXaXRoRGVmYXVsdHMiLCJkZWZhdWx0cyIsImN1cnJlbnQiLCJnZXRTY2hlbWEiLCJvYnNlcnZlIiwib3B0aW9uc09yQ2FsbGJhY2siLCJjYWxsYmFjayIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiYXJndW1lbnRzIiwib2JzZXJ2ZUFzU3RyZWFtIiwiT2JzZXJ2YWJsZSIsImNyZWF0ZSIsIm9ic2VydmVyIiwiZGlzcG9zYWJsZSIsIm5leHQiLCJiaW5kIiwiZGlzcG9zZSIsIm9uRGlkQ2hhbmdlIiwic2V0IiwidmFsdWUiLCJzZXRTY2hlbWEiLCJzY2hlbWEiLCJ1bnNldCIsImlzRmVhdHVyZURpc2FibGVkIiwiYXRvbSIsInBhY2thZ2VzIiwiaXNQYWNrYWdlRGlzYWJsZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFZQTs7QUFDQTs7OztBQWJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBS0E7QUFDQTtBQUNBO0FBQ0E7QUFFZSxNQUFNQSxhQUFOLENBQW9CO0FBSWpDQyxFQUFBQSxXQUFXLENBQUNDLE1BQUQsRUFBc0I7QUFBQSxTQUhqQ0MsWUFHaUM7QUFBQSxTQUZqQ0MsT0FFaUM7QUFDL0IsU0FBS0EsT0FBTCxHQUFlRixNQUFmO0FBQ0Q7O0FBRURHLEVBQUFBLFNBQVMsR0FBZ0I7QUFDdkIsV0FBTyxLQUFLRCxPQUFaO0FBQ0Q7QUFFRDtBQUNGO0FBQ0E7QUFDQTs7O0FB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b3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuXHJcbi8qKlxyXG4gKiBBIHdyYXBwZXIgb3ZlciB0aGUgc3BlY2lmaWVkIEF0b20ncyBjb25maWcgZnVuY3Rpb25zLlxyXG4gKiBFYWNoIGluZGl2aWR1YWwgbG9hZGVkIHBhY2thZ2UncyBjb25maWcgaXMgYSBzdWJjb25maWcgb2YgdGhlIHJvb3QgcGFja2FnZS5cclxuICovXHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb25maWdNYW5hZ2VyIHtcclxuICBfcGFja2FnZU5hbWU6ID9zdHJpbmc7XHJcbiAgX2NvbmZpZzogYXRvbSRDb25maWc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogYXRvbSRDb25maWcpIHtcclxuICAgIHRoaXMuX2NvbmZpZyA9IGNvbmZpZztcclxuICB9XHJcblxyXG4gIGdldENvbmZpZygpOiBhdG9tJENvbmZpZyB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29uZmlnO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0cyB0aGUgcm9vdCBwYWNrYWdlIG5hbWUuXHJcbiAgICogVGhpcyBnZXRzIGF1dG9tYXRpY2FsbHkgY2FsbGVkIGZyb20gRmVhdHVyZUxvYWRlci5cclxuICAgKi9cclxuICBzZXRQYWNrYWdlTmFtZShuYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuX3BhY2thZ2VOYW1lID0gbmFtZTtcclxuICB9XHJcblxyXG4gIGdldFBhY2thZ2VOYW1lKCk6IHN0cmluZyB7XHJcbiAgICBpbnZhcmlhbnQodGhpcy5fcGFja2FnZU5hbWUgIT0gbnVsbCwgJ05vIHBhY2thZ2UgbmFtZSBhdmFpbGFibGUnKTtcclxuICAgIHJldHVybiB0aGlzLl9wYWNrYWdlTmFtZTtcclxuICB9XHJcblxyXG4gIGZvcm1hdEtleVBhdGgoa2V5UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIGlmICh0aGlzLl9wYWNrYWdlTmFtZSA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBrZXlQYXRoO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGAke3RoaXMuX3BhY2thZ2VOYW1lfS4ke2tleVBhdGh9YDtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogUmV0dXJucyB0aGUgdmFsdWUgb2YgYSBzZXR0aW5nIGZvciBhIE51Y2xpZGUgZmVhdHVyZSBrZXkuIFRha2VzIGFuZCByZXR1cm5zIHRoZSBzYW1lIHR5cGVzIGFzXHJcbiAgICogYGF0b20uY29uZmlnLmdldGAgZXhjZXB0IGBrZXlQYXRoYCBpcyBub3Qgb3B0aW9uYWwuIFRvIGdldCB0aGUgZW50aXJlIGNvbmZpZyBvYmplY3QsIHVzZVxyXG4gICAqIGBhdG9tLmNvbmZpZy5nZXRgLlxyXG4gICAqXHJcbiAgICogTm90ZTogVGhpcyBpcyBpbnRlbnRpb25hbGx5IHR5cGVkIGFzIG1peGVkLCB0aGlzIHdheSBlYWNoIGNhbGwgc2l0ZSBoYXMgdG9cclxuICAgKiBmaXJzdCBjYXN0IGl0IGFzIGFueSBhbmQgaXQgaXMgb2J2aW91cyB0aGF0IHRoaXMgaXMgYW4gYXJlYSB0aGF0IGlzIG5vdCBzYWZlXHJcbiAgICogYW5kIGZsb3cgd2lsbCBub3QgcHJvY2VlZCBpZiB0aGUgY2FsbHNpdGUgZG9lc24ndCBkbyBpdC5cclxuICAgKlxyXG4gICAqIEV4YW1wbGU6XHJcbiAgICogICBjb25zdCBjb25maWc6IE15Q29uZmlnVHlwZSA9IChmZWF0dXJlQ29uZmlnLmdldCgnY29uZmlnLW5hbWUnKTogYW55KTtcclxuICAgKi9cclxuICBnZXQoXHJcbiAgICBrZXlQYXRoOiBzdHJpbmcsXHJcbiAgICBvcHRpb25zPzoge1xyXG4gICAgICBleGNsdWRlU291cmNlcz86IEFycmF5PHN0cmluZz4sXHJcbiAgICAgIHNvdXJjZXM/OiBBcnJheTxzdHJpbmc+LFxyXG4gICAgICBzY29wZT86IGF0b20kU2NvcGVEZXNjcmlwdG9yTGlrZSxcclxuICAgIH0sXHJcbiAgKTogbWl4ZWQge1xyXG4gICAgLy8gYXRvbS5jb25maWcuZ2V0IHdpbGwgY3Jhc2ggaWYgdGhlIHNlY29uZCBhcmcgaXMgcHJlc2VudCBhbmQgdW5kZWZpbmVkLlxyXG4gICAgLy8gSXQgZG9lcyBub3QgY3Jhc2ggaWYgdGhlIHNlY29uZCBhcmcgaXMgbWlzc2luZy5cclxuICAgIHJldHVybiB0aGlzLl9jb25maWcuZ2V0KFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLihvcHRpb25zID09IG51bGwgPyBbXSA6IFtvcHRpb25zXSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgZ2V0V2l0aERlZmF1bHRzPFQ+KFxyXG4gICAga2V5UGF0aDogc3RyaW5nLFxyXG4gICAgZGVmYXVsdHM6IFQsXHJcbiAgICBvcHRpb25zPzoge1xyXG4gICAgICBleGNsdWRlU291cmNlcz86IEFycmF5PHN0cmluZz4sXHJcbiAgICAgIHNvdXJjZXM/OiBBcnJheTxzdHJpbmc+LFxyXG4gICAgICBzY29wZT86IGF0b20kU2NvcGVEZXNjcmlwdG9yTGlrZSxcclxuICAgIH0sXHJcbiAgKTogVCB7XHJcbiAgICBjb25zdCBjdXJyZW50OiBhbnkgPSB0aGlzLmdldChrZXlQYXRoLCBvcHRpb25zKTtcclxuICAgIHJldHVybiBjdXJyZW50ID09IG51bGwgPyBkZWZhdWx0cyA6IGN1cnJlbnQ7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIEdldHMgdGhlIHNjaGVtYSBvZiBhIHNldHRpbmcgZm9yIGEgTnVjbGlkZSBmZWF0dXJlIGtleS4gVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWUgdHlwZXMgYXNcclxuICAgKiBgYXRvbS5jb25maWcuZ2V0U2NoZW1hYC5cclxuICAgKi9cclxuICBnZXRTY2hlbWEoa2V5UGF0aDogc3RyaW5nKTogYXRvbSRDb25maWdTY2hlbWEge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbmZpZy5nZXRTY2hlbWEodGhpcy5mb3JtYXRLZXlQYXRoKGtleVBhdGgpKTtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogU2ltaWxhciB0byBgYXRvbS5jb25maWcub2JzZXJ2ZWAgZXhjZXB0IGFyZ3VtZW50cyBhcmUgcmVxdWlyZWQsIGFuZCBvcHRpb25zIGNhbm5vdCBiZSBnaXZlbi5cclxuICAgKlxyXG4gICAqIFRvIG9ic2VydmUgY2hhbmdlcyBvbiB0aGUgZW50aXJlIGNvbmZpZywgdXNlIGBhdG9tLmNvbmZpZy5vYnNlcnZlYC5cclxuICAgKi9cclxuICBvYnNlcnZlKFxyXG4gICAga2V5UGF0aDogc3RyaW5nLFxyXG4gICAgb3B0aW9uc09yQ2FsbGJhY2s/OlxyXG4gICAgICB8IHtzY29wZT86IGF0b20kU2NvcGVEZXNjcmlwdG9yTGlrZX1cclxuICAgICAgfCAoKHZhbHVlOiBhbnkpID0+IG1peGVkKSxcclxuICAgIGNhbGxiYWNrPzogKHZhbHVlOiBhbnkpID0+IG1peGVkLFxyXG4gICk6IElEaXNwb3NhYmxlIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWcub2JzZXJ2ZShcclxuICAgICAgdGhpcy5mb3JtYXRLZXlQYXRoKGtleVBhdGgpLFxyXG4gICAgICAuLi5BcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qXHJcbiAgICogQmVoYXZlcyBzaW1pbGFybHkgdG8gdGhlIGBvYnNlcnZlYCBmdW5jdGlvbiwgYnV0IHJldHVybnMgYSBzdHJlYW0gb2YgdmFsdWVzLCByYXRoZXJcclxuICAgKiB0aGFuIHJlY2VpdmluZyBhIGNhbGxiYWNrLlxyXG4gICAqL1xyXG4gIG9ic2VydmVBc1N0cmVhbShcclxuICAgIGtleVBhdGg6IHN0cmluZyxcclxuICAgIG9wdGlvbnM/OiB7c2NvcGU/OiBhdG9tJFNjb3BlRGVzY3JpcHRvckxpa2V9ID0ge30sXHJcbiAgKTogT2JzZXJ2YWJsZTxtaXhlZD4ge1xyXG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKG9ic2VydmVyID0+IHtcclxuICAgICAgY29uc3QgZGlzcG9zYWJsZSA9IHRoaXMub2JzZXJ2ZShcclxuICAgICAgICBrZXlQYXRoLFxyXG4gICAgICAgIG9wdGlvbnMsXHJcbiAgICAgICAgb2JzZXJ2ZXIubmV4dC5iaW5kKG9ic2VydmVyKSxcclxuICAgICAgKTtcclxuICAgICAgcmV0dXJuIGRpc3Bvc2FibGUuZGlzcG9zZS5iaW5kKGRpc3Bvc2FibGUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKlxyXG4gICAqIFRha2VzIGFuZCByZXR1cm5zIHRoZSBzYW1lIHR5cGVzIGFzIGBhdG9tLmNvbmZpZy5vbkRpZENoYW5nZWAgZXhjZXB0IGBrZXlQYXRoYCBpcyBub3Qgb3B0aW9uYWwuXHJcbiAgICogVG8gbGlzdGVuIHRvIGNoYW5nZXMgb24gYWxsIGtleSBwYXRocywgdXNlIGBhdG9tLmNvbmZpZy5vbkRpZENoYW5nZWAuXHJcbiAgICovXHJcbiAgb25EaWRDaGFuZ2UoXHJcbiAgICBrZXlQYXRoOiBzdHJpbmcsXHJcbiAgICBvcHRpb25zT3JDYWxsYmFjaz86XHJcbiAgICAgIHwge3Njb3BlPzogYXRvbSRTY29wZURlc2NyaXB0b3JMaWtlfVxyXG4gICAgICB8ICgoZXZlbnQ6IHtvbGRWYWx1ZTogbWl4ZWQsIG5ld1ZhbHVlOiBtaXhlZH0pID0+IG1peGVkKSxcclxuICAgIGNhbGxiYWNrPzogKGV2ZW50OiB7b2xkVmFsdWU6IG1peGVkLCBuZXdWYWx1ZTogbWl4ZWR9KSA9PiBtaXhlZCxcclxuICApOiBJRGlzcG9zYWJsZSB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29uZmlnLm9uRGlkQ2hhbmdlKFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLkFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBTZXRzIHRoZSB2YWx1ZSBvZiBhIHNldHRpbmcgZm9yIGEgTnVjbGlkZSBmZWF0dXJlIGtleS4gVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWUgdHlwZXMgYXNcclxuICAgKiBgYXRvbS5jb25maWcuc2V0YC5cclxuICAgKi9cclxuICBzZXQoXHJcbiAgICBrZXlQYXRoOiBzdHJpbmcsXHJcbiAgICB2YWx1ZTogP21peGVkLFxyXG4gICAgb3B0aW9ucz86IHtcclxuICAgICAgc2NvcGVTZWxlY3Rvcj86IHN0cmluZyxcclxuICAgICAgc291cmNlPzogc3RyaW5nLFxyXG4gICAgfSxcclxuICApOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWcuc2V0KFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLkFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBTZXRzIHRoZSBzY2hlbWEgb2YgYSBzZXR0aW5nIGZvciBhIE51Y2xpZGUgZmVhdHVyZSBrZXkuIFRha2VzIGFuZCByZXR1cm5zIHRoZSBzYW1lIHR5cGVzIGFzXHJcbiAgICogYGF0b20uY29uZmlnLnNldFNjaGVtYWAuXHJcbiAgICovXHJcbiAgc2V0U2NoZW1hKGtleVBhdGg6IHN0cmluZywgc2NoZW1hOiBPYmplY3QpOiB2b2lkIHtcclxuICAgIHJldHVybiB0aGlzLl9jb25maWcuc2V0U2NoZW1hKFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLkFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLypcclxuICAgKiBSZXN0b3JlcyBhIHNldHRpbmcgZm9yIGEgTnVjbGlkZSBmZWF0dXJlIGtleSB0byBpdHMgZGVmYXVsdCB2YWx1ZS4gVGFrZXMgYW5kIHJldHVybnMgdGhlIHNhbWVcclxuICAgKiB0eXBlcyBhcyBgYXRvbS5jb25maWcuc2V0YC5cclxuICAgKi9cclxuICB1bnNldChcclxuICAgIGtleVBhdGg6IHN0cmluZyxcclxuICAgIG9wdGlvbnM/OiB7XHJcbiAgICAgIHNjb3BlU2VsZWN0b3I/OiBzdHJpbmcsXHJcbiAgICAgIHNvdXJjZT86IHN0cmluZyxcclxuICAgIH0sXHJcbiAgKTogdm9pZCB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29uZmlnLnVuc2V0KFxyXG4gICAgICB0aGlzLmZvcm1hdEtleVBhdGgoa2V5UGF0aCksXHJcbiAgICAgIC4uLkFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGZlYXR1cmUgd2l0aCB0aGUgZ2l2ZW4gbmFtZSBpcyBkaXNhYmxlZCBlaXRoZXIgZGlyZWN0bHkgb3IgYmVjYXVzZSB0aGVcclxuICAgKiBjb250YWluZXIgcGFja2FnZSBpdHNlbGYgaXMgZGlzYWJsZWQuXHJcbiAgICovXHJcbiAgaXNGZWF0dXJlRGlzYWJsZWQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICBpZiAodGhpcy5fcGFja2FnZU5hbWUgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gYXRvbS5wYWNrYWdlcy5pc1BhY2thZ2VEaXNhYmxlZChuYW1lKTtcclxuICAgIH1cclxuICAgIHJldHVybiAoXHJcbiAgICAgIGF0b20ucGFja2FnZXMuaXNQYWNrYWdlRGlzYWJsZWQodGhpcy5fcGFja2FnZU5hbWUpIHx8XHJcbiAgICAgIC8vICRGbG93Rml4TWUgZmxvdyBkb2Vzbid0IHJlZ2lzdGVyIHRoaXMuX3BhY2thZ2VOYW1lIGFzIG5vbi1udWxsIGhlcmVcclxuICAgICAgIXRoaXMuX2NvbmZpZy5nZXQoYCR7dGhpcy5fcGFja2FnZU5hbWV9LnVzZS4ke25hbWV9YClcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==