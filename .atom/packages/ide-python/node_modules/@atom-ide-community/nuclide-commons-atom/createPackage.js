"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = createPackage;

var _assert = _interopRequireDefault(require("assert"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/**
 * Create an Atom package from an Activation constructor.
 *
 * Atom packages are obstensibly singletons, however they contain `activate()` and `deactivate()`
 * lifecycle methods which can be called multiple times. There's no use-case (so far as we know) for
 * invoking any other package methods while a package is not activated. Therefore, it makes more
 * sense to build packages as instances, constructed when a package is activated and destroyed when
 * the package is deactivated.
 *
 * Atom uses a plain `require` to load the module, and not babel's `require` interop. So if
 * `createPackage` were used as `export default createPackage(..)`, then Atom wouldn't be
 * able to find any package methods because the ES Module transform would output
 * `module.exports.default = {..};`. To workaround this, the module's `module.exports` is passed
 * to `createPackage` so we can attach whatever properties to it.
 *
 * It was a conscious decision to use `createPackage(module.exports, Activation)` instead of
 * `module.exports = createPackage(Activation)`, to avoid code style misunderstandings wrt
 * CommonJS vs ES Modules.
 */
function createPackage(moduleExports, Activation) {
  let activation = null; // Proxy method calls on the package to the activation object.

  for (const property of getPropertyList(Activation.prototype)) {
    if (typeof Activation.prototype[property] !== 'function') {
      continue;
    }

    if (property === 'constructor') {
      continue;
    }

    if (property === 'initialize') {
      throw new Error('Your activation class contains an "initialize" method, but that work should be done in the' + ' constructor.');
    }

    if (property === 'deactivate') {
      throw new Error('Your activation class contains an "deactivate" method. Please use "dispose" instead.');
    }

    moduleExports[property] = function (...args) {
      (0, _assert.default)(activation != null, 'Package not initialized');
      return activation[property](...args);
    };
  }
  /**
   * Calling `initialize()` creates a new instance.
   */


  moduleExports.initialize = initialState => {
    (0, _assert.default)(activation == null, 'Package already initialized');
    activation = new Activation(initialState);
  };
  /**
   * The `deactivate()` method is special-cased to null our activation instance reference.
   */


  moduleExports.deactivate = () => {
    (0, _assert.default)(activation != null, 'Package not initialized');

    if (typeof activation.dispose === 'function') {
      activation.dispose();
    }

    activation = null;
  };
}

function getPrototypeChain(prototype) {
  let currentPrototype = prototype;
  const prototypes = [];

  while (currentPrototype != null) {
    prototypes.push(currentPrototype);
    currentPrototype = Object.getPrototypeOf(currentPrototype);
  }

  return prototypes;
}
/**
 * List the properties (including inherited ones) of the provided prototype, excluding the ones
 * inherited from `Object`.
 */


function getPropertyList(prototype) {
  const properties = [];

  for (const proto of getPrototypeChain(prototype)) {
    if (proto === Object.prototype) {
      break;
    }

    for (const property of Object.getOwnPropertyNames(proto)) {
      properties.push(property);
    }
  }

  return properties;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vY3JlYXRlUGFja2FnZS5qcyJdLCJuYW1lcyI6WyJjcmVhdGVQYWNrYWdlIiwibW9kdWxlRXhwb3J0cyIsIkFjdGl2YXRpb24iLCJhY3RpdmF0aW9uIiwicHJvcGVydHkiLCJnZXRQcm9wZXJ0eUxpc3QiLCJwcm90b3R5cGUiLCJFcnJvciIsImFyZ3MiLCJpbml0aWFsaXplIiwiaW5pdGlhbFN0YXRlIiwiZGVhY3RpdmF0ZSIsImRpc3Bvc2UiLCJnZXRQcm90b3R5cGVDaGFpbiIsImN1cnJlbnRQcm90b3R5cGUiLCJwcm90b3R5cGVzIiwicHVzaCIsIk9iamVjdCIsImdldFByb3RvdHlwZU9mIiwicHJvcGVydGllcyIsInByb3RvIiwiZ2V0T3duUHJvcGVydHlOYW1lcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVlBOzs7O0FBWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUFJQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNlLFNBQVNBLGFBQVQsQ0FDYkMsYUFEYSxFQUViQyxVQUZhLEVBR1A7QUFDTixNQUFJQyxVQUFVLEdBQUcsSUFBakIsQ0FETSxDQUdOOztBQUNBLE9BQUssTUFBTUMsUUFBWCxJQUF1QkMsZUFBZSxDQUFDSCxVQUFVLENBQUNJLFNBQVosQ0FBdEMsRUFBOEQ7QUFDNUQsUUFBSSxPQUFPSixVQUFVLENBQUNJLFNBQVgsQ0FBcUJGLFFBQXJCLENBQVAsS0FBMEMsVUFBOUMsRUFBMEQ7QUFDeEQ7QUFDRDs7QUFDRCxRQUFJQSxRQUFRLEtBQUssYUFBakIsRUFBZ0M7QUFDOUI7QUFDRDs7QUFDRCxRQUFJQSxRQUFRLEtBQUssWUFBakIsRUFBK0I7QUFDN0IsWUFBTSxJQUFJRyxLQUFKLENBQ0osK0ZBQ0UsZUFGRSxDQUFOO0FBSUQ7O0FBQ0QsUUFBSUgsUUFBUSxLQUFLLFlBQWpCLEVBQStCO0FBQzdCLFlBQU0sSUFBSUcsS0FBSixDQUNKLHNGQURJLENBQU47QUFHRDs7QUFFRE4sSUFBQUEsYUFBYSxDQUFDRyxRQUFELENBQWIsR0FBMEIsVUFBUyxHQUFHSSxJQUFaLEVBQWtCO0FBQzFDLDJCQUFVTCxVQUFVLElBQUksSUFBeEIsRUFBOEIseUJBQTlCO0FBQ0EsYUFBT0EsVUFBVSxDQUFDQyxRQUFELENBQVYsQ0FBcUIsR0FBR0ksSUFBeEIsQ0FBUDtBQUNELEtBSEQ7QUFJRDtBQUVEO0FBQ0Y7QUFDQTs7O0FBQ0VQLEVBQUFBLGFBQWEsQ0FBQ1EsVUFBZCxHQUE0QkMsWUFBRCxJQUFpQztBQUMxRCx5QkFBVVAsVUFBVSxJQUFJLElBQXhCLEVBQThCLDZCQUE5QjtBQUNBQSxJQUFBQSxVQUFVLEdBQUcsSUFBSUQsVUFBSixDQUFlUSxZQUFmLENBQWI7QUFDRCxHQUhEO0FBS0E7QUFDRjtBQUNBOzs7QUFDRVQsRUFBQUEsYUFBYSxDQUFDVSxVQUFkLEdBQTJCLE1BQVk7QUFDckMseUJBQVVSLFVBQVUsSUFBSSxJQUF4QixFQUE4Qix5QkFBOUI7O0FBQ0EsUUFBSSxPQUFPQSxVQUFVLENBQUNTLE9BQWxCLEtBQThCLFVBQWxDLEVBQThDO0FBQzVDVCxNQUFBQSxVQUFVLENBQUNTLE9BQVg7QUFDRDs7QUFDRFQsSUFBQUEsVUFBVSxHQUFHLElBQWI7QUFDRCxHQU5EO0FBT0Q7O0FBRUQsU0FBU1UsaUJBQVQsQ0FBMkJQLFNBQTNCLEVBQXFFO0FBQ25FLE1BQUlRLGdCQUFnQixHQUFHUixTQUF2QjtBQUNBLFFBQU1TLFVBQVUsR0FBRyxFQUFuQjs7QUFDQSxTQUFPRCxnQkFBZ0IsSUFBSSxJQUEzQixFQUFpQztBQUMvQkMsSUFBQUEsVUFBVSxDQUFDQyxJQUFYLENBQWdCRixnQkFBaEI7QUFDQUEsSUFBQUEsZ0JBQWdCLEdBQUdHLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkosZ0JBQXRCLENBQW5CO0FBQ0Q7O0FBQ0QsU0FBT0MsVUFBUDtBQUNEO0FBRUQ7QUFDQTtBQUNBO0FBQ0E7OztBQUNBLFNBQVNWLGVBQVQsQ0FBeUJDLFNBQXpCLEVBQStEO0FBQzdELFFBQU1hLFVBQVUsR0FBRyxFQUFuQjs7QUFDQSxPQUFLLE1BQU1DLEtBQVgsSUFBb0JQLGlCQUFpQixDQUFDUCxTQUFELENBQXJDLEVBQWtEO0FBQ2hELFFBQUljLEtBQUssS0FBTUgsTUFBRCxDQUFjWCxTQUE1QixFQUF1QztBQUNyQztBQUNEOztBQUNELFNBQUssTUFBTUYsUUFBWCxJQUF1QmEsTUFBTSxDQUFDSSxtQkFBUCxDQUEyQkQsS0FBM0IsQ0FBdkIsRUFBMEQ7QUFDeERELE1BQUFBLFVBQVUsQ0FBQ0gsSUFBWCxDQUFnQlosUUFBaEI7QUFDRDtBQUNGOztBQUNELFNBQU9lLFVBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3dcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCBpbnZhcmlhbnQgZnJvbSAnYXNzZXJ0JztcclxuXHJcbi8qKlxyXG4gKiBDcmVhdGUgYW4gQXRvbSBwYWNrYWdlIGZyb20gYW4gQWN0aXZhdGlvbiBjb25zdHJ1Y3Rvci5cclxuICpcclxuICogQXRvbSBwYWNrYWdlcyBhcmUgb2JzdGVuc2libHkgc2luZ2xldG9ucywgaG93ZXZlciB0aGV5IGNvbnRhaW4gYGFjdGl2YXRlKClgIGFuZCBgZGVhY3RpdmF0ZSgpYFxyXG4gKiBsaWZlY3ljbGUgbWV0aG9kcyB3aGljaCBjYW4gYmUgY2FsbGVkIG11bHRpcGxlIHRpbWVzLiBUaGVyZSdzIG5vIHVzZS1jYXNlIChzbyBmYXIgYXMgd2Uga25vdykgZm9yXHJcbiAqIGludm9raW5nIGFueSBvdGhlciBwYWNrYWdlIG1ldGhvZHMgd2hpbGUgYSBwYWNrYWdlIGlzIG5vdCBhY3RpdmF0ZWQuIFRoZXJlZm9yZSwgaXQgbWFrZXMgbW9yZVxyXG4gKiBzZW5zZSB0byBidWlsZCBwYWNrYWdlcyBhcyBpbnN0YW5jZXMsIGNvbnN0cnVjdGVkIHdoZW4gYSBwYWNrYWdlIGlzIGFjdGl2YXRlZCBhbmQgZGVzdHJveWVkIHdoZW5cclxuICogdGhlIHBhY2thZ2UgaXMgZGVhY3RpdmF0ZWQuXHJcbiAqXHJcbiAqIEF0b20gdXNlcyBhIHBsYWluIGByZXF1aXJlYCB0byBsb2FkIHRoZSBtb2R1bGUsIGFuZCBub3QgYmFiZWwncyBgcmVxdWlyZWAgaW50ZXJvcC4gU28gaWZcclxuICogYGNyZWF0ZVBhY2thZ2VgIHdlcmUgdXNlZCBhcyBgZXhwb3J0IGRlZmF1bHQgY3JlYXRlUGFja2FnZSguLilgLCB0aGVuIEF0b20gd291bGRuJ3QgYmVcclxuICogYWJsZSB0byBmaW5kIGFueSBwYWNrYWdlIG1ldGhvZHMgYmVjYXVzZSB0aGUgRVMgTW9kdWxlIHRyYW5zZm9ybSB3b3VsZCBvdXRwdXRcclxuICogYG1vZHVsZS5leHBvcnRzLmRlZmF1bHQgPSB7Li59O2AuIFRvIHdvcmthcm91bmQgdGhpcywgdGhlIG1vZHVsZSdzIGBtb2R1bGUuZXhwb3J0c2AgaXMgcGFzc2VkXHJcbiAqIHRvIGBjcmVhdGVQYWNrYWdlYCBzbyB3ZSBjYW4gYXR0YWNoIHdoYXRldmVyIHByb3BlcnRpZXMgdG8gaXQuXHJcbiAqXHJcbiAqIEl0IHdhcyBhIGNvbnNjaW91cyBkZWNpc2lvbiB0byB1c2UgYGNyZWF0ZVBhY2thZ2UobW9kdWxlLmV4cG9ydHMsIEFjdGl2YXRpb24pYCBpbnN0ZWFkIG9mXHJcbiAqIGBtb2R1bGUuZXhwb3J0cyA9IGNyZWF0ZVBhY2thZ2UoQWN0aXZhdGlvbilgLCB0byBhdm9pZCBjb2RlIHN0eWxlIG1pc3VuZGVyc3RhbmRpbmdzIHdydFxyXG4gKiBDb21tb25KUyB2cyBFUyBNb2R1bGVzLlxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gY3JlYXRlUGFja2FnZShcclxuICBtb2R1bGVFeHBvcnRzOiBPYmplY3QsXHJcbiAgQWN0aXZhdGlvbjogQ2xhc3M8YW55PixcclxuKTogdm9pZCB7XHJcbiAgbGV0IGFjdGl2YXRpb24gPSBudWxsO1xyXG5cclxuICAvLyBQcm94eSBtZXRob2QgY2FsbHMgb24gdGhlIHBhY2thZ2UgdG8gdGhlIGFjdGl2YXRpb24gb2JqZWN0LlxyXG4gIGZvciAoY29uc3QgcHJvcGVydHkgb2YgZ2V0UHJvcGVydHlMaXN0KEFjdGl2YXRpb24ucHJvdG90eXBlKSkge1xyXG4gICAgaWYgKHR5cGVvZiBBY3RpdmF0aW9uLnByb3RvdHlwZVtwcm9wZXJ0eV0gIT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgY29udGludWU7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHkgPT09ICdjb25zdHJ1Y3RvcicpIHtcclxuICAgICAgY29udGludWU7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHkgPT09ICdpbml0aWFsaXplJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgJ1lvdXIgYWN0aXZhdGlvbiBjbGFzcyBjb250YWlucyBhbiBcImluaXRpYWxpemVcIiBtZXRob2QsIGJ1dCB0aGF0IHdvcmsgc2hvdWxkIGJlIGRvbmUgaW4gdGhlJyArXHJcbiAgICAgICAgICAnIGNvbnN0cnVjdG9yLicsXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHkgPT09ICdkZWFjdGl2YXRlJykge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgJ1lvdXIgYWN0aXZhdGlvbiBjbGFzcyBjb250YWlucyBhbiBcImRlYWN0aXZhdGVcIiBtZXRob2QuIFBsZWFzZSB1c2UgXCJkaXNwb3NlXCIgaW5zdGVhZC4nLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIG1vZHVsZUV4cG9ydHNbcHJvcGVydHldID0gZnVuY3Rpb24oLi4uYXJncykge1xyXG4gICAgICBpbnZhcmlhbnQoYWN0aXZhdGlvbiAhPSBudWxsLCAnUGFja2FnZSBub3QgaW5pdGlhbGl6ZWQnKTtcclxuICAgICAgcmV0dXJuIGFjdGl2YXRpb25bcHJvcGVydHldKC4uLmFyZ3MpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxpbmcgYGluaXRpYWxpemUoKWAgY3JlYXRlcyBhIG5ldyBpbnN0YW5jZS5cclxuICAgKi9cclxuICBtb2R1bGVFeHBvcnRzLmluaXRpYWxpemUgPSAoaW5pdGlhbFN0YXRlOiA/T2JqZWN0KTogdm9pZCA9PiB7XHJcbiAgICBpbnZhcmlhbnQoYWN0aXZhdGlvbiA9PSBudWxsLCAnUGFja2FnZSBhbHJlYWR5IGluaXRpYWxpemVkJyk7XHJcbiAgICBhY3RpdmF0aW9uID0gbmV3IEFjdGl2YXRpb24oaW5pdGlhbFN0YXRlKTtcclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgYGRlYWN0aXZhdGUoKWAgbWV0aG9kIGlzIHNwZWNpYWwtY2FzZWQgdG8gbnVsbCBvdXIgYWN0aXZhdGlvbiBpbnN0YW5jZSByZWZlcmVuY2UuXHJcbiAgICovXHJcbiAgbW9kdWxlRXhwb3J0cy5kZWFjdGl2YXRlID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgaW52YXJpYW50KGFjdGl2YXRpb24gIT0gbnVsbCwgJ1BhY2thZ2Ugbm90IGluaXRpYWxpemVkJyk7XHJcbiAgICBpZiAodHlwZW9mIGFjdGl2YXRpb24uZGlzcG9zZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBhY3RpdmF0aW9uLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuICAgIGFjdGl2YXRpb24gPSBudWxsO1xyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFByb3RvdHlwZUNoYWluKHByb3RvdHlwZTogQ2xhc3M8YW55Pik6IEFycmF5PENsYXNzPGFueT4+IHtcclxuICBsZXQgY3VycmVudFByb3RvdHlwZSA9IHByb3RvdHlwZTtcclxuICBjb25zdCBwcm90b3R5cGVzID0gW107XHJcbiAgd2hpbGUgKGN1cnJlbnRQcm90b3R5cGUgIT0gbnVsbCkge1xyXG4gICAgcHJvdG90eXBlcy5wdXNoKGN1cnJlbnRQcm90b3R5cGUpO1xyXG4gICAgY3VycmVudFByb3RvdHlwZSA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihjdXJyZW50UHJvdG90eXBlKTtcclxuICB9XHJcbiAgcmV0dXJuIHByb3RvdHlwZXM7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMaXN0IHRoZSBwcm9wZXJ0aWVzIChpbmNsdWRpbmcgaW5oZXJpdGVkIG9uZXMpIG9mIHRoZSBwcm92aWRlZCBwcm90b3R5cGUsIGV4Y2x1ZGluZyB0aGUgb25lc1xyXG4gKiBpbmhlcml0ZWQgZnJvbSBgT2JqZWN0YC5cclxuICovXHJcbmZ1bmN0aW9uIGdldFByb3BlcnR5TGlzdChwcm90b3R5cGU6IENsYXNzPGFueT4pOiBBcnJheTxzdHJpbmc+IHtcclxuICBjb25zdCBwcm9wZXJ0aWVzID0gW107XHJcbiAgZm9yIChjb25zdCBwcm90byBvZiBnZXRQcm90b3R5cGVDaGFpbihwcm90b3R5cGUpKSB7XHJcbiAgICBpZiAocHJvdG8gPT09IChPYmplY3Q6IGFueSkucHJvdG90eXBlKSB7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm90bykpIHtcclxuICAgICAgcHJvcGVydGllcy5wdXNoKHByb3BlcnR5KTtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHByb3BlcnRpZXM7XHJcbn1cclxuIl19