"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getValidProjectPaths = getValidProjectPaths;
exports.getAtomProjectRelativePath = getAtomProjectRelativePath;
exports.getAtomProjectRootPath = getAtomProjectRootPath;
exports.relativizePathWithDirectory = relativizePathWithDirectory;
exports.getDirectoryForPath = getDirectoryForPath;
exports.getFileForPath = getFileForPath;
exports.observeProjectPaths = observeProjectPaths;
exports.observeProjectPathsAll = observeProjectPathsAll;
exports.onDidChangeProjectPath = onDidChangeProjectPath;
exports.onDidAddProjectPath = onDidAddProjectPath;
exports.onDidRemoveProjectPath = onDidRemoveProjectPath;
exports.observeRemovedHostnames = observeRemovedHostnames;
exports.observeAddedHostnames = observeAddedHostnames;

var _atom = require("atom");

var _event = require("@atom-ide-community/nuclide-commons/event");

var _nuclideUri = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/nuclideUri"));

var _observable = require("@atom-ide-community/nuclide-commons/observable");

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
function getValidProjectPaths() {
  return atom.project.getDirectories().filter(directory => {
    // If a remote directory path is a local `Directory` instance, the project path
    // isn't yet ready for consumption.
    if (_nuclideUri.default.isRemote(directory.getPath()) && directory instanceof _atom.Directory) {
      return false;
    }

    return true;
  }).map(directory => directory.getPath());
}

function getAtomProjectRelativePath(path) {
  const [projectPath, relativePath] = atom.project.relativizePath(path);

  if (!projectPath) {
    return null;
  }

  return relativePath;
}

function getAtomProjectRootPath(path) {
  const [projectPath] = atom.project.relativizePath(path);
  return projectPath;
}
/**
 * Like `atom.project.relativizePath`, except it returns the `Directory` rather than the path.
 * It also works for non-children, i.e. this can return `../../x`.
 *
 * This is intended to be used as a way to get a File object for any path
 * without worrying about remote vs. local paths.
 */


function relativizePathWithDirectory(path) {
  for (const directory of atom.project.getDirectories()) {
    try {
      const relativePath = _nuclideUri.default.relative(directory.getPath(), path);

      return [directory, relativePath];
    } catch (e) {// We have a remote-local mismatch or hostname mismatch.
    }
  }

  return [null, path];
}

function getDirectoryForPath(path) {
  const [directory, relativePath] = relativizePathWithDirectory(path);

  if (directory == null) {
    return null;
  }

  return directory.getSubdirectory(relativePath);
}

function getFileForPath(path) {
  const [directory, relativePath] = relativizePathWithDirectory(path);

  if (directory == null) {
    return null;
  }

  return directory.getFile(relativePath);
}

function observeProjectPaths(callback) {
  getValidProjectPaths().forEach(existingPath => callback(existingPath, true));
  return onDidChangeProjectPath(callback);
}

function observeProjectPathsAll(callback) {
  let projectPaths = getValidProjectPaths();
  let changing = false;
  callback(projectPaths);
  return atom.project.onDidChangePaths(() => {
    if (changing) {
      throw new Error('Cannot update projects in the middle of an update');
    }

    changing = true;
    projectPaths = getValidProjectPaths();
    callback(projectPaths);
    changing = false;
  });
}

function onDidChangeProjectPath(callback) {
  let projectPaths = getValidProjectPaths();
  let changing = false;
  return observeProjectPathsAll(newProjectPaths => {
    if (changing) {
      throw new Error('Cannot update projects in the middle of an update');
    }

    changing = true; // Check to see if the change was the addition of a project.

    for (const newProjectPath of newProjectPaths) {
      if (!projectPaths.includes(newProjectPath)) {
        callback(newProjectPath, true);
      }
    } // Check to see if the change was the deletion of a project.


    for (const projectPath of projectPaths) {
      if (!newProjectPaths.includes(projectPath)) {
        callback(projectPath, false);
      }
    }

    changing = false;
    projectPaths = newProjectPaths;
  });
}

function onDidAddProjectPath(callback) {
  return onDidChangeProjectPath((projectPath, added) => {
    if (added) {
      callback(projectPath);
    }
  });
}

function onDidRemoveProjectPath(callback) {
  return onDidChangeProjectPath((projectPath, added) => {
    if (!added) {
      callback(projectPath);
    }
  });
}

function observeHostnames() {
  return (atom.packages.initialPackagesActivated ? _rxjsCompatUmdMin.Observable.of(null) : (0, _event.observableFromSubscribeFunction)(atom.packages.onDidActivateInitialPackages.bind(atom.packages))).switchMap(() => (0, _event.observableFromSubscribeFunction)(atom.project.onDidChangePaths.bind(atom.project)).startWith(null).map(() => new Set(atom.project.getPaths().filter(_nuclideUri.default.isRemote).map(_nuclideUri.default.getHostname))).let((0, _observable.diffSets)()));
}

function observeRemovedHostnames() {
  return observeHostnames().flatMap(diff => _rxjsCompatUmdMin.Observable.from(diff.removed));
}

function observeAddedHostnames() {
  return observeHostnames().flatMap(diff => _rxjsCompatUmdMin.Observable.from(diff.added));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vcHJvamVjdHMuanMiXSwibmFtZXMiOlsiZ2V0VmFsaWRQcm9qZWN0UGF0aHMiLCJhdG9tIiwicHJvamVjdCIsImdldERpcmVjdG9yaWVzIiwiZmlsdGVyIiwiZGlyZWN0b3J5IiwibnVjbGlkZVVyaSIsImlzUmVtb3RlIiwiZ2V0UGF0aCIsIkRpcmVjdG9yeSIsIm1hcCIsImdldEF0b21Qcm9qZWN0UmVsYXRpdmVQYXRoIiwicGF0aCIsInByb2plY3RQYXRoIiwicmVsYXRpdmVQYXRoIiwicmVsYXRpdml6ZVBhdGgiLCJnZXRBdG9tUHJvamVjdFJvb3RQYXRoIiwicmVsYXRpdml6ZVBhdGhXaXRoRGlyZWN0b3J5IiwicmVsYXRpdmUiLCJlIiwiZ2V0RGlyZWN0b3J5Rm9yUGF0aCIsImdldFN1YmRpcmVjdG9yeSIsImdldEZpbGVGb3JQYXRoIiwiZ2V0RmlsZSIsIm9ic2VydmVQcm9qZWN0UGF0aHMiLCJjYWxsYmFjayIsImZvckVhY2giLCJleGlzdGluZ1BhdGgiLCJvbkRpZENoYW5nZVByb2plY3RQYXRoIiwib2JzZXJ2ZVByb2plY3RQYXRoc0FsbCIsInByb2plY3RQYXRocyIsImNoYW5naW5nIiwib25EaWRDaGFuZ2VQYXRocyIsIkVycm9yIiwibmV3UHJvamVjdFBhdGhzIiwibmV3UHJvamVjdFBhdGgiLCJpbmNsdWRlcyIsIm9uRGlkQWRkUHJvamVjdFBhdGgiLCJhZGRlZCIsIm9uRGlkUmVtb3ZlUHJvamVjdFBhdGgiLCJvYnNlcnZlSG9zdG5hbWVzIiwicGFja2FnZXMiLCJpbml0aWFsUGFja2FnZXNBY3RpdmF0ZWQiLCJPYnNlcnZhYmxlIiwib2YiLCJvbkRpZEFjdGl2YXRlSW5pdGlhbFBhY2thZ2VzIiwiYmluZCIsInN3aXRjaE1hcCIsInN0YXJ0V2l0aCIsIlNldCIsImdldFBhdGhzIiwiZ2V0SG9zdG5hbWUiLCJsZXQiLCJvYnNlcnZlUmVtb3ZlZEhvc3RuYW1lcyIsImZsYXRNYXAiLCJkaWZmIiwiZnJvbSIsInJlbW92ZWQiLCJvYnNlcnZlQWRkZWRIb3N0bmFtZXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFjQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWxCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBVU8sU0FBU0Esb0JBQVQsR0FBK0M7QUFDcEQsU0FBT0MsSUFBSSxDQUFDQyxPQUFMLENBQ0pDLGNBREksR0FFSkMsTUFGSSxDQUVHQyxTQUFTLElBQUk7QUFDbkI7QUFDQTtBQUNBLFFBQ0VDLG9CQUFXQyxRQUFYLENBQW9CRixTQUFTLENBQUNHLE9BQVYsRUFBcEIsS0FDQUgsU0FBUyxZQUFZSSxlQUZ2QixFQUdFO0FBQ0EsYUFBTyxLQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxJQUFQO0FBQ0QsR0FaSSxFQWFKQyxHQWJJLENBYUFMLFNBQVMsSUFBSUEsU0FBUyxDQUFDRyxPQUFWLEVBYmIsQ0FBUDtBQWNEOztBQUVNLFNBQVNHLDBCQUFULENBQW9DQyxJQUFwQyxFQUErRDtBQUNwRSxRQUFNLENBQUNDLFdBQUQsRUFBY0MsWUFBZCxJQUE4QmIsSUFBSSxDQUFDQyxPQUFMLENBQWFhLGNBQWIsQ0FBNEJILElBQTVCLENBQXBDOztBQUNBLE1BQUksQ0FBQ0MsV0FBTCxFQUFrQjtBQUNoQixXQUFPLElBQVA7QUFDRDs7QUFDRCxTQUFPQyxZQUFQO0FBQ0Q7O0FBRU0sU0FBU0Usc0JBQVQsQ0FBZ0NKLElBQWhDLEVBQTJEO0FBQ2hFLFFBQU0sQ0FBQ0MsV0FBRCxJQUFnQlosSUFBSSxDQUFDQyxPQUFMLENBQWFhLGNBQWIsQ0FBNEJILElBQTVCLENBQXRCO0FBQ0EsU0FBT0MsV0FBUDtBQUNEO0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQUNPLFNBQVNJLDJCQUFULENBQ0xMLElBREssRUFFcUI7QUFDMUIsT0FBSyxNQUFNUCxTQUFYLElBQXdCSixJQUFJLENBQUNDLE9BQUwsQ0FBYUMsY0FBYixFQUF4QixFQUF1RDtBQUNyRCxRQUFJO0FBQ0YsWUFBTVcsWUFBWSxHQUFHUixvQkFBV1ksUUFBWCxDQUFvQmIsU0FBUyxDQUFDRyxPQUFWLEVBQXBCLEVBQXlDSSxJQUF6QyxDQUFyQjs7QUFDQSxhQUFPLENBQUNQLFNBQUQsRUFBWVMsWUFBWixDQUFQO0FBQ0QsS0FIRCxDQUdFLE9BQU9LLENBQVAsRUFBVSxDQUNWO0FBQ0Q7QUFDRjs7QUFDRCxTQUFPLENBQUMsSUFBRCxFQUFPUCxJQUFQLENBQVA7QUFDRDs7QUFFTSxTQUFTUSxtQkFBVCxDQUE2QlIsSUFBN0IsRUFBMkQ7QUFDaEUsUUFBTSxDQUFDUCxTQUFELEVBQVlTLFlBQVosSUFBNEJHLDJCQUEyQixDQUFDTCxJQUFELENBQTdEOztBQUNBLE1BQUlQLFNBQVMsSUFBSSxJQUFqQixFQUF1QjtBQUNyQixXQUFPLElBQVA7QUFDRDs7QUFDRCxTQUFPQSxTQUFTLENBQUNnQixlQUFWLENBQTBCUCxZQUExQixDQUFQO0FBQ0Q7O0FBRU0sU0FBU1EsY0FBVCxDQUF3QlYsSUFBeEIsRUFBaUQ7QUFDdEQsUUFBTSxDQUFDUCxTQUFELEVBQVlTLFlBQVosSUFBNEJHLDJCQUEyQixDQUFDTCxJQUFELENBQTdEOztBQUNBLE1BQUlQLFNBQVMsSUFBSSxJQUFqQixFQUF1QjtBQUNyQixXQUFPLElBQVA7QUFDRDs7QUFDRCxTQUFPQSxTQUFTLENBQUNrQixPQUFWLENBQWtCVCxZQUFsQixDQUFQO0FBQ0Q7O0FBRU0sU0FBU1UsbUJBQVQsQ0FDTEMsUUFESyxFQUVRO0FBQ2J6QixFQUFBQSxvQkFBb0IsR0FBRzBCLE9BQXZCLENBQStCQyxZQUFZLElBQUlGLFFBQVEsQ0FBQ0UsWUFBRCxFQUFlLElBQWYsQ0FBdkQ7QUFDQSxTQUFPQyxzQkFBc0IsQ0FBQ0gsUUFBRCxDQUE3QjtBQUNEOztBQUVNLFNBQVNJLHNCQUFULENBQ0xKLFFBREssRUFFUTtBQUNiLE1BQUlLLFlBQVksR0FBRzlCLG9CQUFvQixFQUF2QztBQUNBLE1BQUkrQixRQUFRLEdBQUcsS0FBZjtBQUNBTixFQUFBQSxRQUFRLENBQUNLLFlBQUQsQ0FBUjtBQUNBLFNBQU83QixJQUFJLENBQUNDLE9BQUwsQ0FBYThCLGdCQUFiLENBQThCLE1BQU07QUFDekMsUUFBSUQsUUFBSixFQUFjO0FBQ1osWUFBTSxJQUFJRSxLQUFKLENBQVUsbURBQVYsQ0FBTjtBQUNEOztBQUNERixJQUFBQSxRQUFRLEdBQUcsSUFBWDtBQUNBRCxJQUFBQSxZQUFZLEdBQUc5QixvQkFBb0IsRUFBbkM7QUFDQXlCLElBQUFBLFFBQVEsQ0FBQ0ssWUFBRCxDQUFSO0FBQ0FDLElBQUFBLFFBQVEsR0FBRyxLQUFYO0FBQ0QsR0FSTSxDQUFQO0FBU0Q7O0FBRU0sU0FBU0gsc0JBQVQsQ0FDTEgsUUFESyxFQUVRO0FBQ2IsTUFBSUssWUFBWSxHQUFHOUIsb0JBQW9CLEVBQXZDO0FBQ0EsTUFBSStCLFFBQVEsR0FBRyxLQUFmO0FBQ0EsU0FBT0Ysc0JBQXNCLENBQUNLLGVBQWUsSUFBSTtBQUMvQyxRQUFJSCxRQUFKLEVBQWM7QUFDWixZQUFNLElBQUlFLEtBQUosQ0FBVSxtREFBVixDQUFOO0FBQ0Q7O0FBQ0RGLElBQUFBLFFBQVEsR0FBRyxJQUFYLENBSitDLENBSy9DOztBQUNBLFNBQUssTUFBTUksY0FBWCxJQUE2QkQsZUFBN0IsRUFBOEM7QUFDNUMsVUFBSSxDQUFDSixZQUFZLENBQUNNLFFBQWIsQ0FBc0JELGNBQXRCLENBQUwsRUFBNEM7QUFDMUNWLFFBQUFBLFFBQVEsQ0FBQ1UsY0FBRCxFQUFpQixJQUFqQixDQUFSO0FBQ0Q7QUFDRixLQVY4QyxDQVcvQzs7O0FBQ0EsU0FBSyxNQUFNdEIsV0FBWCxJQUEwQmlCLFlBQTFCLEVBQXdDO0FBQ3RDLFVBQUksQ0FBQ0ksZUFBZSxDQUFDRSxRQUFoQixDQUF5QnZCLFdBQXpCLENBQUwsRUFBNEM7QUFDMUNZLFFBQUFBLFFBQVEsQ0FBQ1osV0FBRCxFQUFjLEtBQWQsQ0FBUjtBQUNEO0FBQ0Y7O0FBQ0RrQixJQUFBQSxRQUFRLEdBQUcsS0FBWDtBQUNBRCxJQUFBQSxZQUFZLEdBQUdJLGVBQWY7QUFDRCxHQW5CNEIsQ0FBN0I7QUFvQkQ7O0FBRU0sU0FBU0csbUJBQVQsQ0FDTFosUUFESyxFQUVRO0FBQ2IsU0FBT0csc0JBQXNCLENBQUMsQ0FBQ2YsV0FBRCxFQUFjeUIsS0FBZCxLQUF3QjtBQUNwRCxRQUFJQSxLQUFKLEVBQVc7QUFDVGIsTUFBQUEsUUFBUSxDQUFDWixXQUFELENBQVI7QUFDRDtBQUNGLEdBSjRCLENBQTdCO0FBS0Q7O0FBRU0sU0FBUzBCLHNCQUFULENBQ0xkLFFBREssRUFFUTtBQUNiLFNBQU9HLHNCQUFzQixDQUFDLENBQUNmLFdBQUQsRUFBY3lCLEtBQWQsS0FBd0I7QUFDcEQsUUFBSSxDQUFDQSxLQUFMLEVBQVk7QUFDVmIsTUFBQUEsUUFBUSxDQUFDWixXQUFELENBQVI7QUFDRDtBQUNGLEdBSjRCLENBQTdCO0FBS0Q7O0FBRUQsU0FBUzJCLGdCQUFULEdBQTRCO0FBQzFCLFNBQU8sQ0FBQ3ZDLElBQUksQ0FBQ3dDLFFBQUwsQ0FBY0Msd0JBQWQsR0FDSkMsNkJBQVdDLEVBQVgsQ0FBYyxJQUFkLENBREksR0FFSiw0Q0FDRTNDLElBQUksQ0FBQ3dDLFFBQUwsQ0FBY0ksNEJBQWQsQ0FBMkNDLElBQTNDLENBQWdEN0MsSUFBSSxDQUFDd0MsUUFBckQsQ0FERixDQUZHLEVBS0xNLFNBTEssQ0FLSyxNQUNWLDRDQUNFOUMsSUFBSSxDQUFDQyxPQUFMLENBQWE4QixnQkFBYixDQUE4QmMsSUFBOUIsQ0FBbUM3QyxJQUFJLENBQUNDLE9BQXhDLENBREYsRUFHRzhDLFNBSEgsQ0FHYSxJQUhiLEVBSUd0QyxHQUpILENBS0ksTUFDRSxJQUFJdUMsR0FBSixDQUNFaEQsSUFBSSxDQUFDQyxPQUFMLENBQ0dnRCxRQURILEdBRUc5QyxNQUZILENBRVVFLG9CQUFXQyxRQUZyQixFQUdHRyxHQUhILENBR09KLG9CQUFXNkMsV0FIbEIsQ0FERixDQU5OLEVBYUdDLEdBYkgsQ0FhTywyQkFiUCxDQU5LLENBQVA7QUFxQkQ7O0FBRU0sU0FBU0MsdUJBQVQsR0FBdUQ7QUFDNUQsU0FBT2IsZ0JBQWdCLEdBQUdjLE9BQW5CLENBQTJCQyxJQUFJLElBQUlaLDZCQUFXYSxJQUFYLENBQWdCRCxJQUFJLENBQUNFLE9BQXJCLENBQW5DLENBQVA7QUFDRDs7QUFFTSxTQUFTQyxxQkFBVCxHQUFxRDtBQUMxRCxTQUFPbEIsZ0JBQWdCLEdBQUdjLE9BQW5CLENBQTJCQyxJQUFJLElBQUlaLDZCQUFXYSxJQUFYLENBQWdCRCxJQUFJLENBQUNqQixLQUFyQixDQUFuQyxDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcblxyXG5pbXBvcnQge0ZpbGUsIERpcmVjdG9yeX0gZnJvbSAnYXRvbSc7XHJcbmltcG9ydCB7b2JzZXJ2YWJsZUZyb21TdWJzY3JpYmVGdW5jdGlvbn0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvZXZlbnQnO1xyXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9udWNsaWRlVXJpJztcclxuaW1wb3J0IHtkaWZmU2V0c30gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvb2JzZXJ2YWJsZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRWYWxpZFByb2plY3RQYXRocygpOiBBcnJheTxzdHJpbmc+IHtcclxuICByZXR1cm4gYXRvbS5wcm9qZWN0XHJcbiAgICAuZ2V0RGlyZWN0b3JpZXMoKVxyXG4gICAgLmZpbHRlcihkaXJlY3RvcnkgPT4ge1xyXG4gICAgICAvLyBJZiBhIHJlbW90ZSBkaXJlY3RvcnkgcGF0aCBpcyBhIGxvY2FsIGBEaXJlY3RvcnlgIGluc3RhbmNlLCB0aGUgcHJvamVjdCBwYXRoXHJcbiAgICAgIC8vIGlzbid0IHlldCByZWFkeSBmb3IgY29uc3VtcHRpb24uXHJcbiAgICAgIGlmIChcclxuICAgICAgICBudWNsaWRlVXJpLmlzUmVtb3RlKGRpcmVjdG9yeS5nZXRQYXRoKCkpICYmXHJcbiAgICAgICAgZGlyZWN0b3J5IGluc3RhbmNlb2YgRGlyZWN0b3J5XHJcbiAgICAgICkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0pXHJcbiAgICAubWFwKGRpcmVjdG9yeSA9PiBkaXJlY3RvcnkuZ2V0UGF0aCgpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEF0b21Qcm9qZWN0UmVsYXRpdmVQYXRoKHBhdGg6IE51Y2xpZGVVcmkpOiA/c3RyaW5nIHtcclxuICBjb25zdCBbcHJvamVjdFBhdGgsIHJlbGF0aXZlUGF0aF0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgocGF0aCk7XHJcbiAgaWYgKCFwcm9qZWN0UGF0aCkge1xyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG4gIHJldHVybiByZWxhdGl2ZVBhdGg7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRBdG9tUHJvamVjdFJvb3RQYXRoKHBhdGg6IE51Y2xpZGVVcmkpOiA/c3RyaW5nIHtcclxuICBjb25zdCBbcHJvamVjdFBhdGhdID0gYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKHBhdGgpO1xyXG4gIHJldHVybiBwcm9qZWN0UGF0aDtcclxufVxyXG5cclxuLyoqXHJcbiAqIExpa2UgYGF0b20ucHJvamVjdC5yZWxhdGl2aXplUGF0aGAsIGV4Y2VwdCBpdCByZXR1cm5zIHRoZSBgRGlyZWN0b3J5YCByYXRoZXIgdGhhbiB0aGUgcGF0aC5cclxuICogSXQgYWxzbyB3b3JrcyBmb3Igbm9uLWNoaWxkcmVuLCBpLmUuIHRoaXMgY2FuIHJldHVybiBgLi4vLi4veGAuXHJcbiAqXHJcbiAqIFRoaXMgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCBhcyBhIHdheSB0byBnZXQgYSBGaWxlIG9iamVjdCBmb3IgYW55IHBhdGhcclxuICogd2l0aG91dCB3b3JyeWluZyBhYm91dCByZW1vdGUgdnMuIGxvY2FsIHBhdGhzLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIHJlbGF0aXZpemVQYXRoV2l0aERpcmVjdG9yeShcclxuICBwYXRoOiBOdWNsaWRlVXJpLFxyXG4pOiBbP0RpcmVjdG9yeSwgTnVjbGlkZVVyaV0ge1xyXG4gIGZvciAoY29uc3QgZGlyZWN0b3J5IG9mIGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBudWNsaWRlVXJpLnJlbGF0aXZlKGRpcmVjdG9yeS5nZXRQYXRoKCksIHBhdGgpO1xyXG4gICAgICByZXR1cm4gW2RpcmVjdG9yeSwgcmVsYXRpdmVQYXRoXTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgLy8gV2UgaGF2ZSBhIHJlbW90ZS1sb2NhbCBtaXNtYXRjaCBvciBob3N0bmFtZSBtaXNtYXRjaC5cclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIFtudWxsLCBwYXRoXTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldERpcmVjdG9yeUZvclBhdGgocGF0aDogTnVjbGlkZVVyaSk6ID9EaXJlY3Rvcnkge1xyXG4gIGNvbnN0IFtkaXJlY3RvcnksIHJlbGF0aXZlUGF0aF0gPSByZWxhdGl2aXplUGF0aFdpdGhEaXJlY3RvcnkocGF0aCk7XHJcbiAgaWYgKGRpcmVjdG9yeSA9PSBudWxsKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgcmV0dXJuIGRpcmVjdG9yeS5nZXRTdWJkaXJlY3RvcnkocmVsYXRpdmVQYXRoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVGb3JQYXRoKHBhdGg6IE51Y2xpZGVVcmkpOiA/RmlsZSB7XHJcbiAgY29uc3QgW2RpcmVjdG9yeSwgcmVsYXRpdmVQYXRoXSA9IHJlbGF0aXZpemVQYXRoV2l0aERpcmVjdG9yeShwYXRoKTtcclxuICBpZiAoZGlyZWN0b3J5ID09IG51bGwpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICByZXR1cm4gZGlyZWN0b3J5LmdldEZpbGUocmVsYXRpdmVQYXRoKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9ic2VydmVQcm9qZWN0UGF0aHMoXHJcbiAgY2FsbGJhY2s6IChwcm9qZWN0UGF0aDogc3RyaW5nLCBhZGRlZDogYm9vbGVhbikgPT4gYW55LFxyXG4pOiBJRGlzcG9zYWJsZSB7XHJcbiAgZ2V0VmFsaWRQcm9qZWN0UGF0aHMoKS5mb3JFYWNoKGV4aXN0aW5nUGF0aCA9PiBjYWxsYmFjayhleGlzdGluZ1BhdGgsIHRydWUpKTtcclxuICByZXR1cm4gb25EaWRDaGFuZ2VQcm9qZWN0UGF0aChjYWxsYmFjayk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvYnNlcnZlUHJvamVjdFBhdGhzQWxsKFxyXG4gIGNhbGxiYWNrOiAocHJvamVjdFBhdGhzOiBBcnJheTxzdHJpbmc+KSA9PiBhbnksXHJcbik6IElEaXNwb3NhYmxlIHtcclxuICBsZXQgcHJvamVjdFBhdGhzID0gZ2V0VmFsaWRQcm9qZWN0UGF0aHMoKTtcclxuICBsZXQgY2hhbmdpbmcgPSBmYWxzZTtcclxuICBjYWxsYmFjayhwcm9qZWN0UGF0aHMpO1xyXG4gIHJldHVybiBhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VQYXRocygoKSA9PiB7XHJcbiAgICBpZiAoY2hhbmdpbmcpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgdXBkYXRlIHByb2plY3RzIGluIHRoZSBtaWRkbGUgb2YgYW4gdXBkYXRlJyk7XHJcbiAgICB9XHJcbiAgICBjaGFuZ2luZyA9IHRydWU7XHJcbiAgICBwcm9qZWN0UGF0aHMgPSBnZXRWYWxpZFByb2plY3RQYXRocygpO1xyXG4gICAgY2FsbGJhY2socHJvamVjdFBhdGhzKTtcclxuICAgIGNoYW5naW5nID0gZmFsc2U7XHJcbiAgfSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvbkRpZENoYW5nZVByb2plY3RQYXRoKFxyXG4gIGNhbGxiYWNrOiAocHJvamVjdFBhdGg6IHN0cmluZywgYWRkZWQ6IGJvb2xlYW4pID0+IHZvaWQsXHJcbik6IElEaXNwb3NhYmxlIHtcclxuICBsZXQgcHJvamVjdFBhdGhzID0gZ2V0VmFsaWRQcm9qZWN0UGF0aHMoKTtcclxuICBsZXQgY2hhbmdpbmcgPSBmYWxzZTtcclxuICByZXR1cm4gb2JzZXJ2ZVByb2plY3RQYXRoc0FsbChuZXdQcm9qZWN0UGF0aHMgPT4ge1xyXG4gICAgaWYgKGNoYW5naW5nKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVwZGF0ZSBwcm9qZWN0cyBpbiB0aGUgbWlkZGxlIG9mIGFuIHVwZGF0ZScpO1xyXG4gICAgfVxyXG4gICAgY2hhbmdpbmcgPSB0cnVlO1xyXG4gICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHRoZSBjaGFuZ2Ugd2FzIHRoZSBhZGRpdGlvbiBvZiBhIHByb2plY3QuXHJcbiAgICBmb3IgKGNvbnN0IG5ld1Byb2plY3RQYXRoIG9mIG5ld1Byb2plY3RQYXRocykge1xyXG4gICAgICBpZiAoIXByb2plY3RQYXRocy5pbmNsdWRlcyhuZXdQcm9qZWN0UGF0aCkpIHtcclxuICAgICAgICBjYWxsYmFjayhuZXdQcm9qZWN0UGF0aCwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIENoZWNrIHRvIHNlZSBpZiB0aGUgY2hhbmdlIHdhcyB0aGUgZGVsZXRpb24gb2YgYSBwcm9qZWN0LlxyXG4gICAgZm9yIChjb25zdCBwcm9qZWN0UGF0aCBvZiBwcm9qZWN0UGF0aHMpIHtcclxuICAgICAgaWYgKCFuZXdQcm9qZWN0UGF0aHMuaW5jbHVkZXMocHJvamVjdFBhdGgpKSB7XHJcbiAgICAgICAgY2FsbGJhY2socHJvamVjdFBhdGgsIGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY2hhbmdpbmcgPSBmYWxzZTtcclxuICAgIHByb2plY3RQYXRocyA9IG5ld1Byb2plY3RQYXRocztcclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uRGlkQWRkUHJvamVjdFBhdGgoXHJcbiAgY2FsbGJhY2s6IChwcm9qZWN0UGF0aDogc3RyaW5nKSA9PiB2b2lkLFxyXG4pOiBJRGlzcG9zYWJsZSB7XHJcbiAgcmV0dXJuIG9uRGlkQ2hhbmdlUHJvamVjdFBhdGgoKHByb2plY3RQYXRoLCBhZGRlZCkgPT4ge1xyXG4gICAgaWYgKGFkZGVkKSB7XHJcbiAgICAgIGNhbGxiYWNrKHByb2plY3RQYXRoKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uRGlkUmVtb3ZlUHJvamVjdFBhdGgoXHJcbiAgY2FsbGJhY2s6IChwcm9qZWN0UGF0aDogc3RyaW5nKSA9PiB2b2lkLFxyXG4pOiBJRGlzcG9zYWJsZSB7XHJcbiAgcmV0dXJuIG9uRGlkQ2hhbmdlUHJvamVjdFBhdGgoKHByb2plY3RQYXRoLCBhZGRlZCkgPT4ge1xyXG4gICAgaWYgKCFhZGRlZCkge1xyXG4gICAgICBjYWxsYmFjayhwcm9qZWN0UGF0aCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG9ic2VydmVIb3N0bmFtZXMoKSB7XHJcbiAgcmV0dXJuIChhdG9tLnBhY2thZ2VzLmluaXRpYWxQYWNrYWdlc0FjdGl2YXRlZFxyXG4gICAgPyBPYnNlcnZhYmxlLm9mKG51bGwpXHJcbiAgICA6IG9ic2VydmFibGVGcm9tU3Vic2NyaWJlRnVuY3Rpb24oXHJcbiAgICAgICAgYXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlSW5pdGlhbFBhY2thZ2VzLmJpbmQoYXRvbS5wYWNrYWdlcyksXHJcbiAgICAgIClcclxuICApLnN3aXRjaE1hcCgoKSA9PlxyXG4gICAgb2JzZXJ2YWJsZUZyb21TdWJzY3JpYmVGdW5jdGlvbihcclxuICAgICAgYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHMuYmluZChhdG9tLnByb2plY3QpLFxyXG4gICAgKVxyXG4gICAgICAuc3RhcnRXaXRoKG51bGwpXHJcbiAgICAgIC5tYXAoXHJcbiAgICAgICAgKCkgPT5cclxuICAgICAgICAgIG5ldyBTZXQoXHJcbiAgICAgICAgICAgIGF0b20ucHJvamVjdFxyXG4gICAgICAgICAgICAgIC5nZXRQYXRocygpXHJcbiAgICAgICAgICAgICAgLmZpbHRlcihudWNsaWRlVXJpLmlzUmVtb3RlKVxyXG4gICAgICAgICAgICAgIC5tYXAobnVjbGlkZVVyaS5nZXRIb3N0bmFtZSksXHJcbiAgICAgICAgICApLFxyXG4gICAgICApXHJcbiAgICAgIC5sZXQoZGlmZlNldHMoKSksXHJcbiAgKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9ic2VydmVSZW1vdmVkSG9zdG5hbWVzKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG9ic2VydmVIb3N0bmFtZXMoKS5mbGF0TWFwKGRpZmYgPT4gT2JzZXJ2YWJsZS5mcm9tKGRpZmYucmVtb3ZlZCkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gb2JzZXJ2ZUFkZGVkSG9zdG5hbWVzKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XHJcbiAgcmV0dXJuIG9ic2VydmVIb3N0bmFtZXMoKS5mbGF0TWFwKGRpZmYgPT4gT2JzZXJ2YWJsZS5mcm9tKGRpZmYuYWRkZWQpKTtcclxufVxyXG4iXX0=