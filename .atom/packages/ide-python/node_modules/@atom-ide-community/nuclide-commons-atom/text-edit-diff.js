"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.toUnifiedDiff = toUnifiedDiff;

var _assert = _interopRequireDefault(require("assert"));

var _atom = require("atom");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
function toUnifiedDiff(filename, buffer, edits, contextRows = 1) {
  const hunks = getHunks(buffer, edits, contextRows);
  return [`--- ${filename}`, `+++ ${filename}`].concat(mapHunkToString(buffer, hunks, contextRows)).join('\n');
}

function getHunks(buffer, edits, contextRows) {
  return edits.sort((e1, e2) => e1.oldRange.compare(e2.oldRange)).reduce((mergedEdits, nextEdit) => {
    const edit = mergedEdits[mergedEdits.length - 1];

    if (edit && nextEdit.oldRange.start.row <= edit.oldRange.end.row + contextRows) {
      mergedEdits[mergedEdits.length - 1] = mergeEdit(buffer, edit, nextEdit);
    } else {
      mergedEdits.push(nextEdit);
    }

    return mergedEdits;
  }, []).map(edit => {
    const oldRange = edit.oldRange;
    const rows = oldRange.getRows();
    const newText = buffer.lineForRow(rows[0]).substring(0, oldRange.start.column) + edit.newText + buffer.lineForRow(rows[rows.length - 1]).substring(oldRange.end.column);
    const newLines = newText.split(/\r\n|\r|\n/);
    return {
      rows,
      newLines
    };
  });
}

function mergeEdit(buffer, e1, e2) {
  (0, _assert.default)(e1.oldRange.end.isLessThanOrEqual(e2.oldRange.start));
  const mergedEdit = {};
  mergedEdit.newText = e1.newText + buffer.getTextInRange(new _atom.Range(e1.oldRange.end, e2.oldRange.start)) + e2.newText;
  mergedEdit.oldRange = e1.oldRange.union(e2.oldRange);
  return mergedEdit;
}

function mapHunkToString(buffer, hunks, contextRows) {
  // This requires storing some state across the map() to compute the row
  // numbers correctly.
  let newRowOffset = 0;
  return hunks.map(hunk => {
    const {
      rows,
      newLines
    } = hunk;
    const beforeRows = [];
    const afterRows = [];

    for (let i = 1; i <= contextRows; i++) {
      const beforeRow = rows[0] - i;
      const afterRow = rows[rows.length - 1] + i;

      if (beforeRow >= 0) {
        beforeRows.unshift(beforeRow);
      }

      if (afterRow <= buffer.getLastRow()) {
        afterRows.push(afterRow);
      }
    }

    const oldBeginRow = rows[0] - beforeRows.length + 1;
    const oldRowLength = rows.length + beforeRows.length + afterRows.length;
    const newBeginRow = oldBeginRow + newRowOffset;
    const newRowLength = newLines.length + beforeRows.length + afterRows.length;
    const parts = [];
    parts.push(`@@ -${oldBeginRow},${oldRowLength} +${newBeginRow},${newRowLength} @@`);
    beforeRows.forEach(row => {
      parts.push(' ' + buffer.lineForRow(row));
    });
    rows.forEach(row => {
      parts.push('-' + buffer.lineForRow(row));
    });
    newLines.forEach(line => {
      parts.push('+' + line);
    });
    afterRows.forEach(row => {
      parts.push(' ' + buffer.lineForRow(row));
    });
    newRowOffset += newLines.length - rows.length;
    return parts.join('\n');
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLWF0b20vdGV4dC1lZGl0LWRpZmYuanMiXSwibmFtZXMiOlsidG9VbmlmaWVkRGlmZiIsImZpbGVuYW1lIiwiYnVmZmVyIiwiZWRpdHMiLCJjb250ZXh0Um93cyIsImh1bmtzIiwiZ2V0SHVua3MiLCJjb25jYXQiLCJtYXBIdW5rVG9TdHJpbmciLCJqb2luIiwic29ydCIsImUxIiwiZTIiLCJvbGRSYW5nZSIsImNvbXBhcmUiLCJyZWR1Y2UiLCJtZXJnZWRFZGl0cyIsIm5leHRFZGl0IiwiZWRpdCIsImxlbmd0aCIsInN0YXJ0Iiwicm93IiwiZW5kIiwibWVyZ2VFZGl0IiwicHVzaCIsIm1hcCIsInJvd3MiLCJnZXRSb3dzIiwibmV3VGV4dCIsImxpbmVGb3JSb3ciLCJzdWJzdHJpbmciLCJjb2x1bW4iLCJuZXdMaW5lcyIsInNwbGl0IiwiaXNMZXNzVGhhbk9yRXF1YWwiLCJtZXJnZWRFZGl0IiwiZ2V0VGV4dEluUmFuZ2UiLCJSYW5nZSIsInVuaW9uIiwibmV3Um93T2Zmc2V0IiwiaHVuayIsImJlZm9yZVJvd3MiLCJhZnRlclJvd3MiLCJpIiwiYmVmb3JlUm93IiwiYWZ0ZXJSb3ciLCJ1bnNoaWZ0IiwiZ2V0TGFzdFJvdyIsIm9sZEJlZ2luUm93Iiwib2xkUm93TGVuZ3RoIiwibmV3QmVnaW5Sb3ciLCJuZXdSb3dMZW5ndGgiLCJwYXJ0cyIsImZvckVhY2giLCJsaW5lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBYUE7O0FBQ0E7Ozs7QUFkQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBV08sU0FBU0EsYUFBVCxDQUNMQyxRQURLLEVBRUxDLE1BRkssRUFHTEMsS0FISyxFQUlMQyxXQUFtQixHQUFHLENBSmpCLEVBS0c7QUFDUixRQUFNQyxLQUFrQixHQUFHQyxRQUFRLENBQUNKLE1BQUQsRUFBU0MsS0FBVCxFQUFnQkMsV0FBaEIsQ0FBbkM7QUFDQSxT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QUE3QixHQUFzQ3VCLFNBQVMsQ0FBQ3ZCLE1BQXJFO0FBRUEsVUFBTWlDLEtBQUssR0FBRyxFQUFkO0FBQ0FBLElBQUFBLEtBQUssQ0FBQzVCLElBQU4sQ0FDRyxPQUFNd0IsV0FBWSxJQUFHQyxZQUFhLEtBQUlDLFdBQVksSUFBR0MsWUFBYSxLQURyRTtBQUdBVixJQUFBQSxVQUFVLENBQUNZLE9BQVgsQ0FBbUJoQyxHQUFHLElBQUk7QUFDeEIrQixNQUFBQSxLQUFLLENBQUM1QixJQUFOLENBQVcsTUFBTXRCLE1BQU0sQ0FBQzJCLFVBQVAsQ0FBa0JSLEdBQWxCLENBQWpCO0FBQ0QsS0FGRDtBQUdBSyxJQUFBQSxJQUFJLENBQUMyQixPQUFMLENBQWFoQyxHQUFHLElBQUk7QUFDbEIrQixNQUFBQSxLQUFLLENBQUM1QixJQUFOLENBQVcsTUFBTXRCLE1BQU0sQ0FBQzJCLFVBQVAsQ0FBa0JSLEdBQWxCLENBQWpCO0FBQ0QsS0FGRDtBQUdBVyxJQUFBQSxRQUFRLENBQUNxQixPQUFULENBQWlCQyxJQUFJLElBQUk7QUFDdkJGLE1BQUFBLEtBQUssQ0FBQzVCLElBQU4sQ0FBVyxNQUFNOEIsSUFBakI7QUFDRCxLQUZEO0FBR0FaLElBQUFBLFNBQVMsQ0FBQ1csT0FBVixDQUFrQmhDLEdBQUcsSUFBSTtBQUN2QitCLE1BQUFBLEtBQUssQ0FBQzVCLElBQU4sQ0FBVyxNQUFNdEIsTUFBTSxDQUFDMkIsVUFBUCxDQUFrQlIsR0FBbEIsQ0FBakI7QUFDRCxLQUZEO0FBR0FrQixJQUFBQSxZQUFZLElBQUlQLFFBQVEsQ0FBQ2IsTUFBVCxHQUFrQk8sSUFBSSxDQUFDUCxNQUF2QztBQUNBLFdBQU9pQyxLQUFLLENBQUMzQyxJQUFOLENBQVcsSUFBWCxDQUFQO0FBQ0QsR0FyQ00sQ0FBUDtBQXNDRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQGZsb3cgc3RyaWN0LWxvY2FsXHJcbiAqIEBmb3JtYXRcclxuICovXHJcbmltcG9ydCB0eXBlIHtUZXh0RWRpdH0gZnJvbSAnLi90ZXh0LWVkaXQnO1xyXG5cclxuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xyXG5pbXBvcnQge1JhbmdlfSBmcm9tICdhdG9tJztcclxuXHJcbnR5cGUgSHVuayA9IHtcclxuICByb3dzOiBBcnJheTxudW1iZXI+LFxyXG4gIG5ld0xpbmVzOiBBcnJheTxzdHJpbmc+LFxyXG59O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRvVW5pZmllZERpZmYoXHJcbiAgZmlsZW5hbWU6IHN0cmluZyxcclxuICBidWZmZXI6IGF0b20kVGV4dEJ1ZmZlcixcclxuICBlZGl0czogQXJyYXk8VGV4dEVkaXQ+LFxyXG4gIGNvbnRleHRSb3dzOiBudW1iZXIgPSAxLFxyXG4pOiBzdHJpbmcge1xyXG4gIGNvbnN0IGh1bmtzOiBBcnJheTxIdW5rPiA9IGdldEh1bmtzKGJ1ZmZlciwgZWRpdHMsIGNvbnRleHRSb3dzKTtcclxuICByZXR1cm4gW2AtLS0gJHtmaWxlbmFtZX1gLCBgKysrICR7ZmlsZW5hbWV9YF1cclxuICAgIC5jb25jYXQobWFwSHVua1RvU3RyaW5nKGJ1ZmZlciwgaHVua3MsIGNvbnRleHRSb3dzKSlcclxuICAgIC5qb2luKCdcXG4nKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0SHVua3MoXHJcbiAgYnVmZmVyOiBhdG9tJFRleHRCdWZmZXIsXHJcbiAgZWRpdHM6IEFycmF5PFRleHRFZGl0PixcclxuICBjb250ZXh0Um93czogbnVtYmVyLFxyXG4pOiBBcnJheTxIdW5rPiB7XHJcbiAgcmV0dXJuIGVkaXRzXHJcbiAgICAuc29ydCgoZTEsIGUyKSA9PiBlMS5vbGRSYW5nZS5jb21wYXJlKGUyLm9sZFJhbmdlKSlcclxuICAgIC5yZWR1Y2UoKG1lcmdlZEVkaXRzOiBBcnJheTxUZXh0RWRpdD4sIG5leHRFZGl0OiBUZXh0RWRpdCkgPT4ge1xyXG4gICAgICBjb25zdCBlZGl0ID0gbWVyZ2VkRWRpdHNbbWVyZ2VkRWRpdHMubGVuZ3RoIC0gMV07XHJcbiAgICAgIGlmIChcclxuICAgICAgICBlZGl0ICYmXHJcbiAgICAgICAgbmV4dEVkaXQub2xkUmFuZ2Uuc3RhcnQucm93IDw9IGVkaXQub2xkUmFuZ2UuZW5kLnJvdyArIGNvbnRleHRSb3dzXHJcbiAgICAgICkge1xyXG4gICAgICAgIG1lcmdlZEVkaXRzW21lcmdlZEVkaXRzLmxlbmd0aCAtIDFdID0gbWVyZ2VFZGl0KGJ1ZmZlciwgZWRpdCwgbmV4dEVkaXQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1lcmdlZEVkaXRzLnB1c2gobmV4dEVkaXQpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBtZXJnZWRFZGl0cztcclxuICAgIH0sIFtdKVxyXG4gICAgLm1hcCgoZWRpdDogVGV4dEVkaXQpID0+IHtcclxuICAgICAgY29uc3Qgb2xkUmFuZ2UgPSBlZGl0Lm9sZFJhbmdlO1xyXG4gICAgICBjb25zdCByb3dzID0gb2xkUmFuZ2UuZ2V0Um93cygpO1xyXG4gICAgICBjb25zdCBuZXdUZXh0ID1cclxuICAgICAgICBidWZmZXIubGluZUZvclJvdyhyb3dzWzBdKS5zdWJzdHJpbmcoMCwgb2xkUmFuZ2Uuc3RhcnQuY29sdW1uKSArXHJcbiAgICAgICAgZWRpdC5uZXdUZXh0ICtcclxuICAgICAgICBidWZmZXIubGluZUZvclJvdyhyb3dzW3Jvd3MubGVuZ3RoIC0gMV0pLnN1YnN0cmluZyhvbGRSYW5nZS5lbmQuY29sdW1uKTtcclxuICAgICAgY29uc3QgbmV3TGluZXMgPSBuZXdUZXh0LnNwbGl0KC9cXHJcXG58XFxyfFxcbi8pO1xyXG4gICAgICByZXR1cm4ge3Jvd3MsIG5ld0xpbmVzfTtcclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBtZXJnZUVkaXQoXHJcbiAgYnVmZmVyOiBhdG9tJFRleHRCdWZmZXIsXHJcbiAgZTE6IFRleHRFZGl0LFxyXG4gIGUyOiBUZXh0RWRpdCxcclxuKTogVGV4dEVkaXQge1xyXG4gIGludmFyaWFudChlMS5vbGRSYW5nZS5lbmQuaXNMZXNzVGhhbk9yRXF1YWwoZTIub2xkUmFuZ2Uuc3RhcnQpKTtcclxuICBjb25zdCBtZXJnZWRFZGl0ID0ge307XHJcbiAgbWVyZ2VkRWRpdC5uZXdUZXh0ID1cclxuICAgIGUxLm5ld1RleHQgK1xyXG4gICAgYnVmZmVyLmdldFRleHRJblJhbmdlKG5ldyBSYW5nZShlMS5vbGRSYW5nZS5lbmQsIGUyLm9sZFJhbmdlLnN0YXJ0KSkgK1xyXG4gICAgZTIubmV3VGV4dDtcclxuICBtZXJnZWRFZGl0Lm9sZFJhbmdlID0gZTEub2xkUmFuZ2UudW5pb24oZTIub2xkUmFuZ2UpO1xyXG4gIHJldHVybiBtZXJnZWRFZGl0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBtYXBIdW5rVG9TdHJpbmcoXHJcbiAgYnVmZmVyOiBhdG9tJFRleHRCdWZmZXIsXHJcbiAgaHVua3M6IEFycmF5PEh1bms+LFxyXG4gIGNvbnRleHRSb3dzOiBudW1iZXIsXHJcbik6IEFycmF5PHN0cmluZz4ge1xyXG4gIC8vIFRoaXMgcmVxdWlyZXMgc3RvcmluZyBzb21lIHN0YXRlIGFjcm9zcyB0aGUgbWFwKCkgdG8gY29tcHV0ZSB0aGUgcm93XHJcbiAgLy8gbnVtYmVycyBjb3JyZWN0bHkuXHJcbiAgbGV0IG5ld1Jvd09mZnNldCA9IDA7XHJcbiAgcmV0dXJuIGh1bmtzLm1hcCgoaHVuazogSHVuaykgPT4ge1xyXG4gICAgY29uc3Qge3Jvd3MsIG5ld0xpbmVzfSA9IGh1bms7XHJcbiAgICBjb25zdCBiZWZvcmVSb3dzID0gW107XHJcbiAgICBjb25zdCBhZnRlclJvd3MgPSBbXTtcclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IGNvbnRleHRSb3dzOyBpKyspIHtcclxuICAgICAgY29uc3QgYmVmb3JlUm93ID0gcm93c1swXSAtIGk7XHJcbiAgICAgIGNvbnN0IGFmdGVyUm93ID0gcm93c1tyb3dzLmxlbmd0aCAtIDFdICsgaTtcclxuICAgICAgaWYgKGJlZm9yZVJvdyA+PSAwKSB7XHJcbiAgICAgICAgYmVmb3JlUm93cy51bnNoaWZ0KGJlZm9yZVJvdyk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKGFmdGVyUm93IDw9IGJ1ZmZlci5nZXRMYXN0Um93KCkpIHtcclxuICAgICAgICBhZnRlclJvd3MucHVzaChhZnRlclJvdyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IG9sZEJlZ2luUm93ID0gcm93c1swXSAtIGJlZm9yZVJvd3MubGVuZ3RoICsgMTtcclxuICAgIGNvbnN0IG9sZFJvd0xlbmd0aCA9IHJvd3MubGVuZ3RoICsgYmVmb3JlUm93cy5sZW5ndGggKyBhZnRlclJvd3MubGVuZ3RoO1xyXG4gICAgY29uc3QgbmV3QmVnaW5Sb3cgPSBvbGRCZWdpblJvdyArIG5ld1Jvd09mZnNldDtcclxuICAgIGNvbnN0IG5ld1Jvd0xlbmd0aCA9IG5ld0xpbmVzLmxlbmd0aCArIGJlZm9yZVJvd3MubGVuZ3RoICsgYWZ0ZXJSb3dzLmxlbmd0aDtcclxuXHJcbiAgICBjb25zdCBwYXJ0cyA9IFtdO1xyXG4gICAgcGFydHMucHVzaChcclxuICAgICAgYEBAIC0ke29sZEJlZ2luUm93fSwke29sZFJvd0xlbmd0aH0gKyR7bmV3QmVnaW5Sb3d9LCR7bmV3Um93TGVuZ3RofSBAQGAsXHJcbiAgICApO1xyXG4gICAgYmVmb3JlUm93cy5mb3JFYWNoKHJvdyA9PiB7XHJcbiAgICAgIHBhcnRzLnB1c2goJyAnICsgYnVmZmVyLmxpbmVGb3JSb3cocm93KSk7XHJcbiAgICB9KTtcclxuICAgIHJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICBwYXJ0cy5wdXNoKCctJyArIGJ1ZmZlci5saW5lRm9yUm93KHJvdykpO1xyXG4gICAgfSk7XHJcbiAgICBuZXdMaW5lcy5mb3JFYWNoKGxpbmUgPT4ge1xyXG4gICAgICBwYXJ0cy5wdXNoKCcrJyArIGxpbmUpO1xyXG4gICAgfSk7XHJcbiAgICBhZnRlclJvd3MuZm9yRWFjaChyb3cgPT4ge1xyXG4gICAgICBwYXJ0cy5wdXNoKCcgJyArIGJ1ZmZlci5saW5lRm9yUm93KHJvdykpO1xyXG4gICAgfSk7XHJcbiAgICBuZXdSb3dPZmZzZXQgKz0gbmV3TGluZXMubGVuZ3RoIC0gcm93cy5sZW5ndGg7XHJcbiAgICByZXR1cm4gcGFydHMuam9pbignXFxuJyk7XHJcbiAgfSk7XHJcbn1cclxuIl19