"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AtomTextEditor = void 0;

var _assert = _interopRequireDefault(require("assert"));

var _classnames = _interopRequireDefault(require("classnames"));

var React = _interopRequireWildcard(require("react"));

var _atom = require("atom");

var _textEditor = require("@atom-ide-community/nuclide-commons-atom/text-editor");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _atomTabIndexForwarder = _interopRequireDefault(require("./atomTabIndexForwarder"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const doNothing = () => {};

function setupTextEditor(props) {
  const textBuffer = props.textBuffer || new _atom.TextBuffer(); // flowlint-next-line sketchy-null-string:off

  if (props.path) {
    // $FlowIgnore
    textBuffer.setPath(props.path);
  }

  const disposables = new _UniversalDisposable.default();

  if (props.onDidTextBufferChange != null) {
    disposables.add(textBuffer.onDidChangeText(props.onDidTextBufferChange));
  }

  const textEditorParams = {
    buffer: textBuffer,
    lineNumberGutterVisible: !props.gutterHidden,
    autoHeight: props.autoGrow
  };
  const textEditor = atom.workspace.buildTextEditor(textEditorParams);
  disposables.add(() => textEditor.destroy());

  if (props.grammar != null) {
    textEditor.setGrammar(props.grammar);
  } else {
    atom.grammars.autoAssignLanguageMode(textBuffer);
  }

  disposables.add((0, _textEditor.enforceSoftWrap)(textEditor, props.softWrapped)); // flowlint-next-line sketchy-null-string:off

  if (props.placeholderText) {
    textEditor.setPlaceholderText(props.placeholderText);
  }

  if (props.readOnly) {
    (0, _textEditor.enforceReadOnlyEditor)(textEditor);
  }

  return {
    disposables,
    textEditor
  };
}

class AtomTextEditor extends React.Component {
  constructor(...args) {
    super(...args);
    this._rootElement = void 0;
    this._textEditorElement = void 0;
    this._editorDisposables = void 0;
  }

  componentDidMount() {
    this._editorDisposables = new _UniversalDisposable.default();

    this._updateTextEditor(setupTextEditor(this.props));

    this._onDidUpdateTextEditorElement(this.props);

    if (this.props.disabled) {
      this._updateDisabledState(true);
    }
  }

  _updateTextEditor(setup) {
    const container = this._rootElement;

    if (container == null) {
      return;
    }

    this._editorDisposables.dispose();

    const {
      textEditor,
      disposables
    } = setup;
    this._editorDisposables = new _UniversalDisposable.default(disposables);
    const textEditorElement = this._textEditorElement = document.createElement('atom-text-editor');
    textEditorElement.classList.add('nuclide-wrapped-editor');

    if (parseInt(this.props.tabIndex, 10) >= 0) {
      // Make tab move to next element instead of inserting a 'tab' character
      this._editorDisposables.add( // Make AtomTextEditor properly shift-tabbable
      (0, _atomTabIndexForwarder.default)(textEditorElement), // Make 'Tab' change focus instead of inserting tab character
      _rxjsCompatUmdMin.Observable.fromEvent(textEditorElement, 'keydown').subscribe(event => {
        if (event.key === 'Tab') {
          event.stopPropagation();
        }
      }));
    }

    textEditorElement.setModel(textEditor);
    textEditorElement.setAttribute('tabindex', this.props.tabIndex); // HACK! This is a workaround for the ViewRegistry where Atom has a default view provider for
    // TextEditor (that we cannot override), which is responsible for creating the view associated
    // with the TextEditor that we create and adding a mapping for it in its private views map.
    // To workaround this, we reach into the internals of the ViewRegistry and update the entry in
    // the map manually. Filed as https://github.com/atom/atom/issues/7954.
    // $FlowFixMe

    atom.views.views.set(textEditor, textEditorElement);

    if (this.props.correctContainerWidth) {
      this._editorDisposables.add(textEditorElement.onDidAttach(() => {
        const correctlySizedElement = textEditorElement.querySelector('.lines > :first-child');

        if (correctlySizedElement == null) {
          return;
        }

        container.style.width = correctlySizedElement.style.width;
      }));
    } // Attach to DOM.


    container.innerHTML = '';
    container.appendChild(textEditorElement);

    if (this.props.onConfirm != null) {
      this._editorDisposables.add(atom.commands.add(textEditorElement, {
        'core:confirm': () => {
          (0, _assert.default)(this.props.onConfirm != null);
          this.props.onConfirm();
        }
      }));
    }

    if (this.props.onInitialized != null) {
      this._editorDisposables.add(this.props.onInitialized(textEditor));
    }
  }

  UNSAFE_componentWillReceiveProps(nextProps) {
    if (nextProps.textBuffer !== this.props.textBuffer || nextProps.readOnly !== this.props.readOnly) {
      const previousTextContents = this.getTextBuffer().getText();
      const nextTextContents = nextProps.textBuffer == null ? nextProps.textBuffer : nextProps.textBuffer.getText();

      if (nextTextContents !== previousTextContents) {
        const textEditorSetup = setupTextEditor(nextProps);

        if (nextProps.syncTextContents) {
          textEditorSetup.textEditor.setText(previousTextContents);
        }

        this._updateTextEditor(textEditorSetup);

        this._onDidUpdateTextEditorElement(nextProps);
      }
    }

    if (nextProps.path !== this.props.path) {
      // $FlowIgnore
      this.getTextBuffer().setPath(nextProps.path || '');
    }

    if (nextProps.gutterHidden !== this.props.gutterHidden) {
      this.getModel().setLineNumberGutterVisible(nextProps.gutterHidden);
    }

    if (nextProps.grammar !== this.props.grammar) {
      this.getModel().setGrammar(nextProps.grammar);
    }

    if (nextProps.softWrapped !== this.props.softWrapped) {
      this.getModel().setSoftWrapped(nextProps.softWrapped);
    }

    if (nextProps.disabled !== this.props.disabled) {
      this._updateDisabledState(nextProps.disabled);
    }

    if (nextProps.placeholderText !== this.props.placeholderText) {
      this.getModel().setPlaceholderText(nextProps.placeholderText || '');
      this.getModel().scheduleComponentUpdate();
    }
  }

  _onDidUpdateTextEditorElement(props) {
    if (!props.readOnly) {
      return;
    } // TODO(most): t9929679 Remove this hack when Atom has a blinking cursor configuration API.


    const {
      component
    } = this.getElement();

    if (component == null) {
      return;
    }

    if (component.startCursorBlinking) {
      component.startCursorBlinking = doNothing;
      component.stopCursorBlinking();
    } else {
      const {
        presenter
      } = component;

      if (presenter == null) {
        return;
      }

      presenter.startBlinkingCursors = doNothing;
      presenter.stopBlinkingCursors(false);
    }
  }

  _updateDisabledState(isDisabled) {
    // Hack to set TextEditor to read-only mode, per https://github.com/atom/atom/issues/6880
    if (isDisabled) {
      this.getElement().removeAttribute('tabindex');
    } else {
      this.getElement().setAttribute('tabindex', this.props.tabIndex);
    }
  }

  getTextBuffer() {
    return this.getModel().getBuffer();
  }

  getModel() {
    return this.getElement().getModel();
  }

  getElement() {
    (0, _assert.default)(this._textEditorElement);
    return this._textEditorElement;
  }

  render() {
    const className = (0, _classnames.default)(this.props.className, 'nuclide-text-editor-container', {
      'no-auto-grow': !this.props.autoGrow
    });
    return /*#__PURE__*/React.createElement("div", {
      className: className,
      ref: rootElement => this._rootElement = rootElement
    });
  } // This component wraps the imperative API of `<atom-text-editor>`, and so React's rendering
  // should always pass because this subtree won't change.


  shouldComponentUpdate(nextProps, nextState) {
    return false;
  }

  componentWillUnmount() {
    process.nextTick(() => this._editorDisposables.dispose());
  }

}

exports.AtomTextEditor = AtomTextEditor;
AtomTextEditor.defaultProps = {
  correctContainerWidth: true,
  disabled: false,
  gutterHidden: false,
  lineNumberGutterVisible: true,
  readOnly: false,
  autoGrow: false,
  syncTextContents: true,
  tabIndex: '0',
  // Keep in line with other input elements.
  softWrapped: false
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL0F0b21UZXh0RWRpdG9yLmpzIl0sIm5hbWVzIjpbImRvTm90aGluZyIsInNldHVwVGV4dEVkaXRvciIsInByb3BzIiwidGV4dEJ1ZmZlciIsIlRleHRCdWZmZXIiLCJwYXRoIiwic2V0UGF0aCIsImRpc3Bvc2FibGVzIiwiVW5pdmVyc2FsRGlzcG9zYWJsZSIsIm9uRGlkVGV4dEJ1ZmZlckNoYW5nZSIsImFkZCIsIm9uRGlkQ2hhbmdlVGV4dCIsInRleHRFZGl0b3JQYXJhbXMiLCJidWZmZXIiLCJsaW5lTnVtYmVyR3V0dGVyVmlzaWJsZSIsImd1dHRlckhpZGRlbiIsImF1dG9IZWlnaHQiLCJhdXRvR3JvdyIsInRleHRFZGl0b3IiLCJhdG9tIiwid29ya3NwYWNlIiwiYnVpbGRUZXh0RWRpdG9yIiwiZGVzdHJveSIsImdyYW1tYXIiLCJzZXRHcmFtbWFyIiwiZ3JhbW1hcnMiLCJhdXRvQXNzaWduTGFuZ3VhZ2VNb2RlIiwic29mdFdyYXBwZWQiLCJwbGFjZWhvbGRlclRleHQiLCJzZXRQbGFjZWhvbGRlclRleHQiLCJyZWFkT25seSIsIkF0b21UZXh0RWRpdG9yIiwiUmVhY3QiLCJDb21wb25lbnQiLCJfcm9vdEVsZW1lbnQiLCJfdGV4dEVkaXRvckVsZW1lbnQiLCJfZWRpdG9yRGlzcG9zYWJsZXMiLCJjb21wb25lbnREaWRNb3VudCIsIl91cGRhdGVUZXh0RWRpdG9yIiwiX29uRGlkVXBkYXRlVGV4dEVkaXRvckVsZW1lbnQiLCJkaXNhYmxlZCIsIl91cGRhdGVEaXNhYmxlZFN0YXRlIiwic2V0dXAiLCJjb250YWluZXIiLCJkaXNwb3NlIiwidGV4dEVkaXRvckVsZW1lbnQiLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJjbGFzc0xpc3QiLCJwYXJzZUludCIsInRhYkluZGV4IiwiT2JzZXJ2YWJsZSIsImZyb21FdmVudCIsInN1YnNjcmliZSIsImV2ZW50Iiwia2V5Iiwic3RvcFByb3BhZ2F0aW9uIiwic2V0TW9kZWwiLCJzZXRBdHRyaWJ1dGUiLCJ2aWV3cyIsInNldCIsImNvcnJlY3RDb250YWluZXJXaWR0aCIsIm9uRGlkQXR0YWNoIiwiY29ycmVjdGx5U2l6ZWRFbGVtZW50IiwicXVlcnlTZWxlY3RvciIsInN0eWxlIiwid2lkdGgiLCJpbm5lckhUTUwiLCJhcHBlbmRDaGlsZCIsIm9uQ29uZmlybSIsImNvbW1hbmRzIiwib25Jbml0aWFsaXplZCIsIlVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIiwibmV4dFByb3BzIiwicHJldmlvdXNUZXh0Q29udGVudHMiLCJnZXRUZXh0QnVmZmVyIiwiZ2V0VGV4dCIsIm5leHRUZXh0Q29udGVudHMiLCJ0ZXh0RWRpdG9yU2V0dXAiLCJzeW5jVGV4dENvbnRlbnRzIiwic2V0VGV4dCIsImdldE1vZGVsIiwic2V0TGluZU51bWJlckd1dHRlclZpc2libGUiLCJzZXRTb2Z0V3JhcHBlZCIsInNjaGVkdWxlQ29tcG9uZW50VXBkYXRlIiwiY29tcG9uZW50IiwiZ2V0RWxlbWVudCIsInN0YXJ0Q3Vyc29yQmxpbmtpbmciLCJzdG9wQ3Vyc29yQmxpbmtpbmciLCJwcmVzZW50ZXIiLCJzdGFydEJsaW5raW5nQ3Vyc29ycyIsInN0b3BCbGlua2luZ0N1cnNvcnMiLCJpc0Rpc2FibGVkIiwicmVtb3ZlQXR0cmlidXRlIiwiZ2V0QnVmZmVyIiwicmVuZGVyIiwiY2xhc3NOYW1lIiwicm9vdEVsZW1lbnQiLCJzaG91bGRDb21wb25lbnRVcGRhdGUiLCJuZXh0U3RhdGUiLCJjb21wb25lbnRXaWxsVW5tb3VudCIsInByb2Nlc3MiLCJuZXh0VGljayIsImRlZmF1bHRQcm9wcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVlBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBOztBQUNBOztBQUNBOzs7Ozs7OztBQXRCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBY0EsTUFBTUEsU0FBUyxHQUFH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THdCO0FBTWxDYixFQUFBQSxRQUFRLEVBQUUsS0FOd0I7QUFPbEM4RCxFQUFBQSxnQkFBZ0IsRUFBRSxJQVBnQjtBQVFsQzdCLEVBQUFBLFFBQVEsRUFBRSxHQVJ3QjtBQVFuQjtBQUNmdkIsRUFBQUEsV0FBVyxFQUFFO0FBVHFCLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCB7VGV4dEJ1ZmZlcn0gZnJvbSAnYXRvbSc7XHJcbmltcG9ydCB7XHJcbiAgZW5mb3JjZVJlYWRPbmx5RWRpdG9yLFxyXG4gIGVuZm9yY2VTb2Z0V3JhcCxcclxufSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy1hdG9tL3RleHQtZWRpdG9yJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuaW1wb3J0IGF0b21UYWJJbmRleEZvcndhcmRlciBmcm9tICcuL2F0b21UYWJJbmRleEZvcndhcmRlcic7XHJcblxyXG5jb25zdCBkb05vdGhpbmcgPSAoKSA9PiB7fTtcclxuXHJcbnR5cGUgVGV4dEVkaXRvclNldHVwID0ge1xyXG4gIGRpc3Bvc2FibGVzOiBJRGlzcG9zYWJsZSxcclxuICB0ZXh0RWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbn07XHJcblxyXG5mdW5jdGlvbiBzZXR1cFRleHRFZGl0b3IocHJvcHM6IFByb3BzKTogVGV4dEVkaXRvclNldHVwIHtcclxuICBjb25zdCB0ZXh0QnVmZmVyID0gcHJvcHMudGV4dEJ1ZmZlciB8fCBuZXcgVGV4dEJ1ZmZlcigpO1xyXG4gIC8vIGZsb3dsaW50LW5leHQtbGluZSBza2V0Y2h5LW51bGwtc3RyaW5nOm9mZlxyXG4gIGlmIChwcm9wcy5wYXRoKSB7XHJcbiAgICAvLyAkRmxvd0lnbm9yZVxyXG4gICAgdGV4dEJ1ZmZlci5zZXRQYXRoKHByb3BzLnBhdGgpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZGlzcG9zYWJsZXMgPSBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZSgpO1xyXG4gIGlmIChwcm9wcy5vbkRpZFRleHRCdWZmZXJDaGFuZ2UgIT0gbnVsbCkge1xyXG4gICAgZGlzcG9zYWJsZXMuYWRkKHRleHRCdWZmZXIub25EaWRDaGFuZ2VUZXh0KHByb3BzLm9uRGlkVGV4dEJ1ZmZlckNoYW5nZSkpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgdGV4dEVkaXRvclBhcmFtcyA9IHtcclxuICAgIGJ1ZmZlcjogdGV4dEJ1ZmZlcixcclxuICAgIGxpbmVOdW1iZXJHdXR0ZXJWaXNpYmxlOiAhcHJvcHMuZ3V0dGVySGlkZGVuLFxyXG4gICAgYXV0b0hlaWdodDogcHJvcHMuYXV0b0dyb3csXHJcbiAgfTtcclxuICBjb25zdCB0ZXh0RWRpdG9yOiBhdG9tJFRleHRFZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5idWlsZFRleHRFZGl0b3IoXHJcbiAgICB0ZXh0RWRpdG9yUGFyYW1zLFxyXG4gICk7XHJcbiAgZGlzcG9zYWJsZXMuYWRkKCgpID0+IHRleHRFZGl0b3IuZGVzdHJveSgpKTtcclxuICBpZiAocHJvcHMuZ3JhbW1hciAhPSBudWxsKSB7XHJcbiAgICB0ZXh0RWRpdG9yLnNldEdyYW1tYXIocHJvcHMuZ3JhbW1hcik7XHJcbiAgfSBlbHNlIHtcclxuICAgIGF0b20uZ3JhbW1hcnMuYXV0b0Fzc2lnbkxhbmd1YWdlTW9kZSh0ZXh0QnVmZmVyKTtcclxuICB9XHJcbiAgZGlzcG9zYWJsZXMuYWRkKGVuZm9yY2VTb2Z0V3JhcCh0ZXh0RWRpdG9yLCBwcm9wcy5zb2Z0V3JhcHBlZCkpO1xyXG5cclxuICAvLyBmbG93bGludC1uZXh0LWxpbmUgc2tldGNoeS1udWxsLXN0cmluZzpvZmZcclxuICBpZiAocHJvcHMucGxhY2Vob2xkZXJUZXh0KSB7XHJcbiAgICB0ZXh0RWRpdG9yLnNldFBsYWNlaG9sZGVyVGV4dChwcm9wcy5wbGFjZWhvbGRlclRleHQpO1xyXG4gIH1cclxuXHJcbiAgaWYgKHByb3BzLnJlYWRPbmx5KSB7XHJcbiAgICBlbmZvcmNlUmVhZE9ubHlFZGl0b3IodGV4dEVkaXRvcik7XHJcbiAgfVxyXG4gIHJldHVybiB7XHJcbiAgICBkaXNwb3NhYmxlcyxcclxuICAgIHRleHRFZGl0b3IsXHJcbiAgfTtcclxufVxyXG5cclxudHlwZSBEZWZhdWx0UHJvcHMgPSB7XHJcbiAgYXV0b0dyb3c6IGJvb2xlYW4sXHJcbiAgY29ycmVjdENvbnRhaW5lcldpZHRoOiBib29sZWFuLFxyXG4gIGRpc2FibGVkOiBib29sZWFuLFxyXG4gIGd1dHRlckhpZGRlbjogYm9vbGVhbixcclxuICBsaW5lTnVtYmVyR3V0dGVyVmlzaWJsZTogYm9vbGVhbixcclxuICByZWFkT25seTogYm9vbGVhbixcclxuICBzeW5jVGV4dENvbnRlbnRzOiBib29sZWFuLFxyXG4gIHRhYkluZGV4OiBzdHJpbmcsXHJcbiAgc29mdFdyYXBwZWQ6IGJvb2xlYW4sXHJcbn07XHJcblxyXG50eXBlIFByb3BzID0ge1xyXG4gIGF1dG9Hcm93OiBib29sZWFuLFxyXG4gIGNsYXNzTmFtZT86IHN0cmluZyxcclxuICBjb3JyZWN0Q29udGFpbmVyV2lkdGg6IGJvb2xlYW4sXHJcbiAgZGlzYWJsZWQ6IGJvb2xlYW4sXHJcbiAgZ3V0dGVySGlkZGVuOiBib29sZWFuLFxyXG4gIGdyYW1tYXI/OiA/T2JqZWN0LFxyXG4gIC8vIHRoZXNlIGFyZSBwcm9jZXNzZWQgaW4gc2V0dXBUZXh0RWRpdG9yIGJlbG93XHJcbiAgLyogZXNsaW50LWRpc2FibGUgcmVhY3Qvbm8tdW51c2VkLXByb3AtdHlwZXMgKi9cclxuICBvbkRpZFRleHRCdWZmZXJDaGFuZ2U/OiA/KGV2ZW50OiBhdG9tJEFnZ3JlZ2F0ZWRUZXh0RWRpdEV2ZW50KSA9PiBtaXhlZCxcclxuICBwYXRoPzogc3RyaW5nLFxyXG4gIHBsYWNlaG9sZGVyVGV4dD86IHN0cmluZyxcclxuICBzeW5jVGV4dENvbnRlbnRzOiBib29sZWFuLFxyXG4gIC8qIGVzbGludC1lbmFibGUgcmVhY3Qvbm8tdW51c2VkLXByb3AtdHlwZXMgKi9cclxuICByZWFkT25seTogYm9vbGVhbixcclxuICB0ZXh0QnVmZmVyPzogVGV4dEJ1ZmZlcixcclxuICB0YWJJbmRleDogc3RyaW5nLFxyXG4gIHNvZnRXcmFwcGVkOiBib29sZWFuLFxyXG4gIG9uQ29uZmlybT86ICgpID0+IG1peGVkLFxyXG4gIC8vIENhbGxlZCB3aXRoIHRleHQgZWRpdG9yICBhcyBpbnB1dCBhZnRlciBpbml0aWFsaXppbmcgYW5kIGF0dGFjaGluZyB0byBET00uXHJcbiAgb25Jbml0aWFsaXplZD86IGF0b20kVGV4dEVkaXRvciA9PiBJRGlzcG9zYWJsZSxcclxufTtcclxuXHJcbmV4cG9ydCBjbGFzcyBBdG9tVGV4dEVkaXRvciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcywgdm9pZD4ge1xyXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHM6IERlZmF1bHRQcm9wcyA9IHtcclxuICAgIGNvcnJlY3RDb250YWluZXJXaWR0aDogdHJ1ZSxcclxuICAgIGRpc2FibGVkOiBmYWxzZSxcclxuICAgIGd1dHRlckhpZGRlbjogZmFsc2UsXHJcbiAgICBsaW5lTnVtYmVyR3V0dGVyVmlzaWJsZTogdHJ1ZSxcclxuICAgIHJlYWRPbmx5OiBmYWxzZSxcclxuICAgIGF1dG9Hcm93OiBmYWxzZSxcclxuICAgIHN5bmNUZXh0Q29udGVudHM6IHRydWUsXHJcbiAgICB0YWJJbmRleDogJzAnLCAvLyBLZWVwIGluIGxpbmUgd2l0aCBvdGhlciBpbnB1dCBlbGVtZW50cy5cclxuICAgIHNvZnRXcmFwcGVkOiBmYWxzZSxcclxuICB9O1xyXG5cclxuICBfcm9vdEVsZW1lbnQ6ID9IVE1MRGl2RWxlbWVudDtcclxuICBfdGV4dEVkaXRvckVsZW1lbnQ6ID9hdG9tJFRleHRFZGl0b3JFbGVtZW50O1xyXG4gIF9lZGl0b3JEaXNwb3NhYmxlczogVW5pdmVyc2FsRGlzcG9zYWJsZTtcclxuXHJcbiAgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9lZGl0b3JEaXNwb3NhYmxlcyA9IG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKCk7XHJcbiAgICB0aGlzLl91cGRhdGVUZXh0RWRpdG9yKHNldHVwVGV4dEVkaXRvcih0aGlzLnByb3BzKSk7XHJcbiAgICB0aGlzLl9vbkRpZFVwZGF0ZVRleHRFZGl0b3JFbGVtZW50KHRoaXMucHJvcHMpO1xyXG4gICAgaWYgKHRoaXMucHJvcHMuZGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy5fdXBkYXRlRGlzYWJsZWRTdGF0ZSh0cnVlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF91cGRhdGVUZXh0RWRpdG9yKHNldHVwOiBUZXh0RWRpdG9yU2V0dXApOiB2b2lkIHtcclxuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuX3Jvb3RFbGVtZW50O1xyXG4gICAgaWYgKGNvbnRhaW5lciA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9lZGl0b3JEaXNwb3NhYmxlcy5kaXNwb3NlKCk7XHJcbiAgICBjb25zdCB7dGV4dEVkaXRvciwgZGlzcG9zYWJsZXN9ID0gc2V0dXA7XHJcblxyXG4gICAgdGhpcy5fZWRpdG9yRGlzcG9zYWJsZXMgPSBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZShkaXNwb3NhYmxlcyk7XHJcblxyXG4gICAgY29uc3QgdGV4dEVkaXRvckVsZW1lbnQ6IGF0b20kVGV4dEVkaXRvckVsZW1lbnQgPSAodGhpcy5fdGV4dEVkaXRvckVsZW1lbnQgPSAoZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcclxuICAgICAgJ2F0b20tdGV4dC1lZGl0b3InLFxyXG4gICAgKTogYW55KSk7XHJcblxyXG4gICAgdGV4dEVkaXRvckVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnbnVjbGlkZS13cmFwcGVkLWVkaXRvcicpO1xyXG5cclxuICAgIGlmIChwYXJzZUludCh0aGlzLnByb3BzLnRhYkluZGV4LCAxMCkgPj0gMCkge1xyXG4gICAgICAvLyBNYWtlIHRhYiBtb3ZlIHRvIG5leHQgZWxlbWVudCBpbnN0ZWFkIG9mIGluc2VydGluZyBhICd0YWInIGNoYXJhY3RlclxyXG4gICAgICB0aGlzLl9lZGl0b3JEaXNwb3NhYmxlcy5hZGQoXHJcbiAgICAgICAgLy8gTWFrZSBBdG9tVGV4dEVkaXRvciBwcm9wZXJseSBzaGlmdC10YWJiYWJsZVxyXG4gICAgICAgIGF0b21UYWJJbmRleEZvcndhcmRlcih0ZXh0RWRpdG9yRWxlbWVudCksXHJcbiAgICAgICAgLy8gTWFrZSAnVGFiJyBjaGFuZ2UgZm9jdXMgaW5zdGVhZCBvZiBpbnNlcnRpbmcgdGFiIGNoYXJhY3RlclxyXG4gICAgICAgIE9ic2VydmFibGUuZnJvbUV2ZW50KHRleHRFZGl0b3JFbGVtZW50LCAna2V5ZG93bicpLnN1YnNjcmliZShldmVudCA9PiB7XHJcbiAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnVGFiJykge1xyXG4gICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KSxcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICB0ZXh0RWRpdG9yRWxlbWVudC5zZXRNb2RlbCh0ZXh0RWRpdG9yKTtcclxuICAgIHRleHRFZGl0b3JFbGVtZW50LnNldEF0dHJpYnV0ZSgndGFiaW5kZXgnLCB0aGlzLnByb3BzLnRhYkluZGV4KTtcclxuICAgIC8vIEhBQ0shIFRoaXMgaXMgYSB3b3JrYXJvdW5kIGZvciB0aGUgVmlld1JlZ2lzdHJ5IHdoZXJlIEF0b20gaGFzIGEgZGVmYXVsdCB2aWV3IHByb3ZpZGVyIGZvclxyXG4gICAgLy8gVGV4dEVkaXRvciAodGhhdCB3ZSBjYW5ub3Qgb3ZlcnJpZGUpLCB3aGljaCBpcyByZXNwb25zaWJsZSBmb3IgY3JlYXRpbmcgdGhlIHZpZXcgYXNzb2NpYXRlZFxyXG4gICAgLy8gd2l0aCB0aGUgVGV4dEVkaXRvciB0aGF0IHdlIGNyZWF0ZSBhbmQgYWRkaW5nIGEgbWFwcGluZyBmb3IgaXQgaW4gaXRzIHByaXZhdGUgdmlld3MgbWFwLlxyXG4gICAgLy8gVG8gd29ya2Fyb3VuZCB0aGlzLCB3ZSByZWFjaCBpbnRvIHRoZSBpbnRlcm5hbHMgb2YgdGhlIFZpZXdSZWdpc3RyeSBhbmQgdXBkYXRlIHRoZSBlbnRyeSBpblxyXG4gICAgLy8gdGhlIG1hcCBtYW51YWxseS4gRmlsZWQgYXMgaHR0cHM6Ly9naXRodWIuY29tL2F0b20vYXRvbS9pc3N1ZXMvNzk1NC5cclxuICAgIC8vICRGbG93Rml4TWVcclxuICAgIGF0b20udmlld3Mudmlld3Muc2V0KHRleHRFZGl0b3IsIHRleHRFZGl0b3JFbGVtZW50KTtcclxuXHJcbiAgICBpZiAodGhpcy5wcm9wcy5jb3JyZWN0Q29udGFpbmVyV2lkdGgpIHtcclxuICAgICAgdGhpcy5fZWRpdG9yRGlzcG9zYWJsZXMuYWRkKFxyXG4gICAgICAgIHRleHRFZGl0b3JFbGVtZW50Lm9uRGlkQXR0YWNoKCgpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGNvcnJlY3RseVNpemVkRWxlbWVudCA9IHRleHRFZGl0b3JFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoXHJcbiAgICAgICAgICAgICcubGluZXMgPiA6Zmlyc3QtY2hpbGQnLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIGlmIChjb3JyZWN0bHlTaXplZEVsZW1lbnQgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb250YWluZXIuc3R5bGUud2lkdGggPSBjb3JyZWN0bHlTaXplZEVsZW1lbnQuc3R5bGUud2lkdGg7XHJcbiAgICAgICAgfSksXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gQXR0YWNoIHRvIERPTS5cclxuICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJztcclxuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZCh0ZXh0RWRpdG9yRWxlbWVudCk7XHJcblxyXG4gICAgaWYgKHRoaXMucHJvcHMub25Db25maXJtICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5fZWRpdG9yRGlzcG9zYWJsZXMuYWRkKFxyXG4gICAgICAgIGF0b20uY29tbWFuZHMuYWRkKHRleHRFZGl0b3JFbGVtZW50LCB7XHJcbiAgICAgICAgICAnY29yZTpjb25maXJtJzogKCkgPT4ge1xyXG4gICAgICAgICAgICBpbnZhcmlhbnQodGhpcy5wcm9wcy5vbkNvbmZpcm0gIT0gbnVsbCk7XHJcbiAgICAgICAgICAgIHRoaXMucHJvcHMub25Db25maXJtKCk7XHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0pLFxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnByb3BzLm9uSW5pdGlhbGl6ZWQgIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9lZGl0b3JEaXNwb3NhYmxlcy5hZGQodGhpcy5wcm9wcy5vbkluaXRpYWxpemVkKHRleHRFZGl0b3IpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5leHRQcm9wczogUHJvcHMpOiB2b2lkIHtcclxuICAgIGlmIChcclxuICAgICAgbmV4dFByb3BzLnRleHRCdWZmZXIgIT09IHRoaXMucHJvcHMudGV4dEJ1ZmZlciB8fFxyXG4gICAgICBuZXh0UHJvcHMucmVhZE9ubHkgIT09IHRoaXMucHJvcHMucmVhZE9ubHlcclxuICAgICkge1xyXG4gICAgICBjb25zdCBwcmV2aW91c1RleHRDb250ZW50cyA9IHRoaXMuZ2V0VGV4dEJ1ZmZlcigpLmdldFRleHQoKTtcclxuICAgICAgY29uc3QgbmV4dFRleHRDb250ZW50cyA9XHJcbiAgICAgICAgbmV4dFByb3BzLnRleHRCdWZmZXIgPT0gbnVsbFxyXG4gICAgICAgICAgPyBuZXh0UHJvcHMudGV4dEJ1ZmZlclxyXG4gICAgICAgICAgOiBuZXh0UHJvcHMudGV4dEJ1ZmZlci5nZXRUZXh0KCk7XHJcbiAgICAgIGlmIChuZXh0VGV4dENvbnRlbnRzICE9PSBwcmV2aW91c1RleHRDb250ZW50cykge1xyXG4gICAgICAgIGNvbnN0IHRleHRFZGl0b3JTZXR1cCA9IHNldHVwVGV4dEVkaXRvcihuZXh0UHJvcHMpO1xyXG5cclxuICAgICAgICBpZiAobmV4dFByb3BzLnN5bmNUZXh0Q29udGVudHMpIHtcclxuICAgICAgICAgIHRleHRFZGl0b3JTZXR1cC50ZXh0RWRpdG9yLnNldFRleHQocHJldmlvdXNUZXh0Q29udGVudHMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLl91cGRhdGVUZXh0RWRpdG9yKHRleHRFZGl0b3JTZXR1cCk7XHJcbiAgICAgICAgdGhpcy5fb25EaWRVcGRhdGVUZXh0RWRpdG9yRWxlbWVudChuZXh0UHJvcHMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAobmV4dFByb3BzLnBhdGggIT09IHRoaXMucHJvcHMucGF0aCkge1xyXG4gICAgICAvLyAkRmxvd0lnbm9yZVxyXG4gICAgICB0aGlzLmdldFRleHRCdWZmZXIoKS5zZXRQYXRoKG5leHRQcm9wcy5wYXRoIHx8ICcnKTtcclxuICAgIH1cclxuICAgIGlmIChuZXh0UHJvcHMuZ3V0dGVySGlkZGVuICE9PSB0aGlzLnByb3BzLmd1dHRlckhpZGRlbikge1xyXG4gICAgICB0aGlzLmdldE1vZGVsKCkuc2V0TGluZU51bWJlckd1dHRlclZpc2libGUobmV4dFByb3BzLmd1dHRlckhpZGRlbik7XHJcbiAgICB9XHJcbiAgICBpZiAobmV4dFByb3BzLmdyYW1tYXIgIT09IHRoaXMucHJvcHMuZ3JhbW1hcikge1xyXG4gICAgICB0aGlzLmdldE1vZGVsKCkuc2V0R3JhbW1hcihuZXh0UHJvcHMuZ3JhbW1hcik7XHJcbiAgICB9XHJcbiAgICBpZiAobmV4dFByb3BzLnNvZnRXcmFwcGVkICE9PSB0aGlzLnByb3BzLnNvZnRXcmFwcGVkKSB7XHJcbiAgICAgIHRoaXMuZ2V0TW9kZWwoKS5zZXRTb2Z0V3JhcHBlZChuZXh0UHJvcHMuc29mdFdyYXBwZWQpO1xyXG4gICAgfVxyXG4gICAgaWYgKG5leHRQcm9wcy5kaXNhYmxlZCAhPT0gdGhpcy5wcm9wcy5kaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLl91cGRhdGVEaXNhYmxlZFN0YXRlKG5leHRQcm9wcy5kaXNhYmxlZCk7XHJcbiAgICB9XHJcbiAgICBpZiAobmV4dFByb3BzLnBsYWNlaG9sZGVyVGV4dCAhPT0gdGhpcy5wcm9wcy5wbGFjZWhvbGRlclRleHQpIHtcclxuICAgICAgdGhpcy5nZXRNb2RlbCgpLnNldFBsYWNlaG9sZGVyVGV4dChuZXh0UHJvcHMucGxhY2Vob2xkZXJUZXh0IHx8ICcnKTtcclxuICAgICAgdGhpcy5nZXRNb2RlbCgpLnNjaGVkdWxlQ29tcG9uZW50VXBkYXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfb25EaWRVcGRhdGVUZXh0RWRpdG9yRWxlbWVudChwcm9wczogUHJvcHMpOiB2b2lkIHtcclxuICAgIGlmICghcHJvcHMucmVhZE9ubHkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gVE9ETyhtb3N0KTogdDk5Mjk2NzkgUmVtb3ZlIHRoaXMgaGFjayB3aGVuIEF0b20gaGFzIGEgYmxpbmtpbmcgY3Vyc29yIGNvbmZpZ3VyYXRpb24gQVBJLlxyXG4gICAgY29uc3Qge2NvbXBvbmVudH0gPSB0aGlzLmdldEVsZW1lbnQoKTtcclxuICAgIGlmIChjb21wb25lbnQgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoY29tcG9uZW50LnN0YXJ0Q3Vyc29yQmxpbmtpbmcpIHtcclxuICAgICAgY29tcG9uZW50LnN0YXJ0Q3Vyc29yQmxpbmtpbmcgPSBkb05vdGhpbmc7XHJcbiAgICAgIGNvbXBvbmVudC5zdG9wQ3Vyc29yQmxpbmtpbmcoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHtwcmVzZW50ZXJ9ID0gY29tcG9uZW50O1xyXG4gICAgICBpZiAocHJlc2VudGVyID09IG51bGwpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgcHJlc2VudGVyLnN0YXJ0QmxpbmtpbmdDdXJzb3JzID0gZG9Ob3RoaW5nO1xyXG4gICAgICBwcmVzZW50ZXIuc3RvcEJsaW5raW5nQ3Vyc29ycyhmYWxzZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfdXBkYXRlRGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKTogdm9pZCB7XHJcbiAgICAvLyBIYWNrIHRvIHNldCBUZXh0RWRpdG9yIHRvIHJlYWQtb25seSBtb2RlLCBwZXIgaHR0cHM6Ly9naXRodWIuY29tL2F0b20vYXRvbS9pc3N1ZXMvNjg4MFxyXG4gICAgaWYgKGlzRGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy5nZXRFbGVtZW50KCkucmVtb3ZlQXR0cmlidXRlKCd0YWJpbmRleCcpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5nZXRFbGVtZW50KCkuc2V0QXR0cmlidXRlKCd0YWJpbmRleCcsIHRoaXMucHJvcHMudGFiSW5kZXgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0VGV4dEJ1ZmZlcigpOiBhdG9tJFRleHRCdWZmZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuZ2V0TW9kZWwoKS5nZXRCdWZmZXIoKTtcclxuICB9XHJcblxyXG4gIGdldE1vZGVsKCk6IGF0b20kVGV4dEVkaXRvciB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRFbGVtZW50KCkuZ2V0TW9kZWwoKTtcclxuICB9XHJcblxyXG4gIGdldEVsZW1lbnQoKTogYXRvbSRUZXh0RWRpdG9yRWxlbWVudCB7XHJcbiAgICBpbnZhcmlhbnQodGhpcy5fdGV4dEVkaXRvckVsZW1lbnQpO1xyXG4gICAgcmV0dXJuIHRoaXMuX3RleHRFZGl0b3JFbGVtZW50O1xyXG4gIH1cclxuXHJcbiAgcmVuZGVyKCk6IFJlYWN0Lk5vZGUge1xyXG4gICAgY29uc3QgY2xhc3NOYW1lID0gY2xhc3NuYW1lcyhcclxuICAgICAgdGhpcy5wcm9wcy5jbGFzc05hbWUsXHJcbiAgICAgICdudWNsaWRlLXRleHQtZWRpdG9yLWNvbnRhaW5lcicsXHJcbiAgICAgIHtcclxuICAgICAgICAnbm8tYXV0by1ncm93JzogIXRoaXMucHJvcHMuYXV0b0dyb3csXHJcbiAgICAgIH0sXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgPGRpdlxyXG4gICAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lfVxyXG4gICAgICAgIHJlZj17cm9vdEVsZW1lbnQgPT4gKHRoaXMuX3Jvb3RFbGVtZW50ID0gcm9vdEVsZW1lbnQpfVxyXG4gICAgICAvPlxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFRoaXMgY29tcG9uZW50IHdyYXBzIHRoZSBpbXBlcmF0aXZlIEFQSSBvZiBgPGF0b20tdGV4dC1lZGl0b3I+YCwgYW5kIHNvIFJlYWN0J3MgcmVuZGVyaW5nXHJcbiAgLy8gc2hvdWxkIGFsd2F5cyBwYXNzIGJlY2F1c2UgdGhpcyBzdWJ0cmVlIHdvbid0IGNoYW5nZS5cclxuICBzaG91bGRDb21wb25lbnRVcGRhdGUobmV4dFByb3BzOiBPYmplY3QsIG5leHRTdGF0ZTogdm9pZCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50V2lsbFVubW91bnQoKTogdm9pZCB7XHJcbiAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHRoaXMuX2VkaXRvckRpc3Bvc2FibGVzLmRpc3Bvc2UoKSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==