"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DateSelector = void 0;

var _classnames = _interopRequireDefault(require("classnames"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var React = _interopRequireWildcard(require("react"));

var _dateRangePicker = require("tiny-date-picker/dist/date-range-picker");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/* global Node */
class DateSelector extends React.Component {
  constructor(props) {
    super(props);
    this._refEl = void 0;
    this._datePicker = void 0;
    this._disposable = void 0;

    this._openDatePicker = () => {
      this.setState({
        isOpen: true
      });
    };

    this._closeDatePicker = () => {
      this.setState({
        isOpen: false
      });
      this._datePicker = null;
    };

    this._handleWindowClick = e => {
      if (!(e.target instanceof Node)) {
        return;
      }

      if (this._refEl.current && !this._refEl.current.contains(e.target)) {
        this._closeDatePicker();
      }
    };

    this._handleLostFocus = e => {
      if (!Boolean(this.props.showOnlyOnFocus)) {
        return;
      }

      const {
        target,
        relatedTarget
      } = e;

      if (!(target instanceof Node && (relatedTarget instanceof Node || relatedTarget == null))) {
        return;
      }

      if (this._refEl.current && !this._refEl.current.contains(target) && !this._refEl.current.contains(relatedTarget)) {
        this._closeDatePicker();
      }
    };

    this._checkDatesAreEqual = (date1, date2) => {
      const time1 = date1 ? date1.getTime() : null;
      const time2 = date2 ? date2.getTime() : null;
      return time1 === time2;
    };

    this._createDatePicker = hilightedDate => {
      if (!this._refEl.current) {
        return;
      }

      let {
        start,
        end
      } = this.props;
      const {
        earliestDate,
        latestDate
      } = this.props; // DateRangePicker can never have end without start

      if (start == null) {
        start = end;
        end = null;
      }

      this._datePicker = (0, _dateRangePicker.DateRangePicker)(this._refEl.current, {
        startOpts: {
          hilightedDate: hilightedDate || start || new Date(),
          min: earliestDate,
          max: latestDate,
          shouldFocusOnRender: false,
          dayOffset: 1
        }
      }).on('statechange', (_, dp) => {
        const newStart = dp.state.start;
        const newEnd = dp.state.end;

        if (!Boolean(this.props.selectRange)) {
          if (!this._checkDatesAreEqual(newStart, newEnd)) {
            dp.setState({
              start: newStart,
              end: newStart
            });
            return;
          }
        } // Call onDatesChange if new date was selected


        const prevEnd = Boolean(this.props.selectRange) ? this.props.end : this.props.start;

        if (!this._checkDatesAreEqual(this.props.start, newStart) || Boolean(this.props.selectRange) && !this._checkDatesAreEqual(this.props.end, newEnd)) {
          if (newEnd < newStart) {
            this.props.onDatesChange(newEnd, newStart);
          } else {
            this.props.onDatesChange(newStart, newEnd);
          }
        }

        if (Boolean(this.props.showOnlyOnFocus) && newEnd != null && !this._checkDatesAreEqual(newEnd, prevEnd)) {
          this._closeDatePicker();
        }
      });

      this._datePicker.setState({
        start,
        end
      });
    };

    this.state = {
      isOpen: Boolean(props.defaultOpen) || !props.showOnlyOnFocus
    };
    this._refEl = /*#__PURE__*/React.createRef();
  }

  componentDidMount() {
    if (Boolean(this.props.showOnlyOnFocus)) {
      this._disposable = new _UniversalDisposable.default(_rxjsCompatUmdMin.Observable.fromEvent(window, 'mousedown').subscribe(this._handleWindowClick));
    }

    this._createDatePicker();
  }

  componentDidUpdate(prevProps, prevState) {
    if (!this.state.isOpen) {
      return;
    }

    const {
      start,
      end
    } = this.props;

    if (!this._checkDatesAreEqual(start, prevProps.start)) {
      this._createDatePicker(start);
    } else if (!this._checkDatesAreEqual(end, prevProps.end)) {
      this._createDatePicker(end);
    } else if (!this._datePicker) {
      this._createDatePicker();
    }
  }

  componentWillUnmount() {
    if (this._disposable) {
      this._disposable.dispose();
    }
  }

  render() {
    const classname = (0, _classnames.default)(this.props.className, 'nuclide-ui-date-selector', {
      'nuclide-ui-dropdown-date-selector': this.props.showOnlyOnFocus
    });
    return /*#__PURE__*/React.createElement("div", {
      onFocus: this._openDatePicker,
      onBlur: this._handleLostFocus
    }, this.props.children, this.state.isOpen ? /*#__PURE__*/React.createElement("div", {
      className: classname,
      ref: this._refEl
    }) : null);
  }

}

exports.DateSelector = DateSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL0RhdGVTZWxlY3Rvci5qcyJdLCJuYW1lcyI6WyJEYXRlU2VsZWN0b3IiLCJSZWFjdCIsIkNvbXBvbmVudCIsImNvbnN0cnVjdG9yIiwicHJvcHMiLCJfcmVmRWwiLCJfZGF0ZVBpY2tlciIsIl9kaXNwb3NhYmxlIiwiX29wZW5EYXRlUGlja2VyIiwic2V0U3RhdGUiLCJpc09wZW4iLCJfY2xvc2VEYXRlUGlja2VyIiwiX2hhbmRsZVdpbmRvd0NsaWNrIiwiZSIsInRhcmdldCIsIk5vZGUiLCJjdXJyZW50IiwiY29udGFpbnMiLCJfaGFuZGxlTG9zdEZvY3VzIiwiQm9vbGVhbiIsInNob3dPbmx5T25Gb2N1cyIsInJlbGF0ZWRUYXJnZXQiLCJfY2hlY2tEYXRlc0FyZUVxdWFsIiwiZGF0ZTEiLCJkYXRlMiIsInRpbWUxIiwiZ2V0VGltZSIsInRpbWUyIiwiX2NyZWF0ZURhdGVQaWNrZXIiLCJoaWxpZ2h0ZWREYXRlIiwic3RhcnQiLCJlbmQiLCJlYXJsaWVzdERhdGUiLCJsYXRlc3REYXRlIiwic3RhcnRPcHRzIiwiRGF0ZSIsIm1pbiIsIm1heCIsInNob3VsZEZvY3VzT25SZW5kZXIiLCJkYXlPZmZzZXQiLCJvbiIsIl8iLCJkcCIsIm5ld1N0YXJ0Iiwic3RhdGUiLCJuZXdFbmQiLCJzZWxlY3RSYW5nZSIsInByZXZFbmQiLCJvbkRhdGVzQ2hhbmdlIiwiZGVmYXVsdE9wZW4iLCJjcmVhdGVSZWYiLCJjb21wb25lbnREaWRNb3VudCIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJPYnNlcnZhYmxlIiwiZnJvbUV2ZW50Iiwid2luZG93Iiwic3Vic2NyaWJlIiwiY29tcG9uZW50RGlkVXBkYXRlIiwicHJldlByb3BzIiwicHJldlN0YXRlIiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJkaXNwb3NlIiwicmVuZGVyIiwiY2xhc3NuYW1lIiwiY2xhc3NOYW1lIiwiY2hpbGRyZW4iXSwibWFwcGluZ3MiOiI7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LEdBQUcsRUFBRSxLQUFLMUQ7QUFBckMsTUFERCxHQUVHLElBSk4sQ0FERjtBQVFEOztBQW5LNkQiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG4vKiBnbG9iYWwgTm9kZSAqL1xyXG5cclxuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IHtEYXRlUmFuZ2VQaWNrZXJ9IGZyb20gJ3RpbnktZGF0ZS1waWNrZXIvZGlzdC9kYXRlLXJhbmdlLXBpY2tlcic7XHJcblxyXG50eXBlIFByb3BzID0ge3xcclxuICAvLyBTZWxlY3RlZCBzdGFydCBkYXRlXHJcbiAgc3RhcnQ6ID9EYXRlLFxyXG4gIC8vIFNlbGVjdGVkIGVuZCBkYXRlLCBpZ25vcmVkIGlmIHNlbGVjdFJhbmdlIGlzIGZhbHNlXHJcbiAgZW5kPzogP0RhdGUsXHJcbiAgLy8gRWFybGllc3QgZGF0ZSB0aGF0IGNhbiBiZSBzZWxlY3RlZFxyXG4gIGVhcmxpZXN0RGF0ZT86IERhdGUsXHJcbiAgLy8gTGF0ZXN0IGRhdGUgdGhhdCBjYW4gYmUgc2VsZWN0ZWRcclxuICBsYXRlc3REYXRlPzogRGF0ZSxcclxuICAvLyBPbmx5IGRpc3BsYXkgY2FsZW5kYXIgd2hlbiBpbiBmb2N1c1xyXG4gIHNob3dPbmx5T25Gb2N1cz86IGJvb2xlYW4sXHJcbiAgZGVmYXVsdE9wZW4/OiBib29sZWFuLFxyXG4gIC8vIEFsbG93IHVzZXIgdG8gc2VsZWN0IGEgcmFuZ2Ugb2YgZGF0ZXNcclxuICBzZWxlY3RSYW5nZT86IGJvb2xlYW4sXHJcbiAgb25EYXRlc0NoYW5nZTogKHN0YXJ0OiA/RGF0ZSwgZW5kOiA/RGF0ZSkgPT4gdm9pZCxcclxuICBjaGlsZHJlbj86IFJlYWN0Lk5vZGUsXHJcbiAgY2xhc3NOYW1lPzogc3RyaW5nLFxyXG58fTtcclxuXHJcbnR5cGUgU3RhdGUgPSB7fFxyXG4gIGlzT3BlbjogYm9vbGVhbixcclxufH07XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0ZVNlbGVjdG9yIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFByb3BzLCBTdGF0ZT4ge1xyXG4gIF9yZWZFbDogUmVhY3QuRWxlbWVudFJlZjxhbnk+O1xyXG4gIF9kYXRlUGlja2VyOiBhbnk7XHJcbiAgX2Rpc3Bvc2FibGU6ID9JRGlzcG9zYWJsZTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJvcHM6IFByb3BzKSB7XHJcbiAgICBzdXBlcihwcm9wcyk7XHJcbiAgICB0aGlzLnN0YXRlID0ge2lzT3BlbjogQm9vbGVhbihwcm9wcy5kZWZhdWx0T3BlbikgfHwgIXByb3BzLnNob3dPbmx5T25Gb2N1c307XHJcbiAgICB0aGlzLl9yZWZFbCA9IFJlYWN0LmNyZWF0ZVJlZigpO1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XHJcbiAgICBpZiAoQm9vbGVhbih0aGlzLnByb3BzLnNob3dPbmx5T25Gb2N1cykpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZSA9IG5ldyBVbml2ZXJzYWxEaXNwb3NhYmxlKFxyXG4gICAgICAgIE9ic2VydmFibGUuZnJvbUV2ZW50KHdpbmRvdywgJ21vdXNlZG93bicpLnN1YnNjcmliZShcclxuICAgICAgICAgIHRoaXMuX2hhbmRsZVdpbmRvd0NsaWNrLFxyXG4gICAgICAgICksXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9jcmVhdGVEYXRlUGlja2VyKCk7XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnREaWRVcGRhdGUocHJldlByb3BzOiBQcm9wcywgcHJldlN0YXRlOiBTdGF0ZSkge1xyXG4gICAgaWYgKCF0aGlzLnN0YXRlLmlzT3Blbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7c3RhcnQsIGVuZH0gPSB0aGlzLnByb3BzO1xyXG4gICAgaWYgKCF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwoc3RhcnQsIHByZXZQcm9wcy5zdGFydCkpIHtcclxuICAgICAgdGhpcy5fY3JlYXRlRGF0ZVBpY2tlcihzdGFydCk7XHJcbiAgICB9IGVsc2UgaWYgKCF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwoZW5kLCBwcmV2UHJvcHMuZW5kKSkge1xyXG4gICAgICB0aGlzLl9jcmVhdGVEYXRlUGlja2VyKGVuZCk7XHJcbiAgICB9IGVsc2UgaWYgKCF0aGlzLl9kYXRlUGlja2VyKSB7XHJcbiAgICAgIHRoaXMuX2NyZWF0ZURhdGVQaWNrZXIoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xyXG4gICAgaWYgKHRoaXMuX2Rpc3Bvc2FibGUpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfb3BlbkRhdGVQaWNrZXIgPSAoKTogdm9pZCA9PiB7XHJcbiAgICB0aGlzLnNldFN0YXRlKHtpc09wZW46IHRydWV9KTtcclxuICB9O1xyXG5cclxuICBfY2xvc2VEYXRlUGlja2VyID0gKCk6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7aXNPcGVuOiBmYWxzZX0pO1xyXG4gICAgdGhpcy5fZGF0ZVBpY2tlciA9IG51bGw7XHJcbiAgfTtcclxuXHJcbiAgX2hhbmRsZVdpbmRvd0NsaWNrID0gKGU6IFN5bnRoZXRpY01vdXNlRXZlbnQ8Pik6IHZvaWQgPT4ge1xyXG4gICAgaWYgKCEoZS50YXJnZXQgaW5zdGFuY2VvZiBOb2RlKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5fcmVmRWwuY3VycmVudCAmJiAhdGhpcy5fcmVmRWwuY3VycmVudC5jb250YWlucyhlLnRhcmdldCkpIHtcclxuICAgICAgdGhpcy5fY2xvc2VEYXRlUGlja2VyKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgX2hhbmRsZUxvc3RGb2N1cyA9IChlOiBTeW50aGV0aWNGb2N1c0V2ZW50PD4pID0+IHtcclxuICAgIGlmICghQm9vbGVhbih0aGlzLnByb3BzLnNob3dPbmx5T25Gb2N1cykpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHt0YXJnZXQsIHJlbGF0ZWRUYXJnZXR9ID0gZTtcclxuICAgIGlmIChcclxuICAgICAgIShcclxuICAgICAgICB0YXJnZXQgaW5zdGFuY2VvZiBOb2RlICYmXHJcbiAgICAgICAgKHJlbGF0ZWRUYXJnZXQgaW5zdGFuY2VvZiBOb2RlIHx8IHJlbGF0ZWRUYXJnZXQgPT0gbnVsbClcclxuICAgICAgKVxyXG4gICAgKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChcclxuICAgICAgdGhpcy5fcmVmRWwuY3VycmVudCAmJlxyXG4gICAgICAhdGhpcy5fcmVmRWwuY3VycmVudC5jb250YWlucyh0YXJnZXQpICYmXHJcbiAgICAgICF0aGlzLl9yZWZFbC5jdXJyZW50LmNvbnRhaW5zKHJlbGF0ZWRUYXJnZXQpXHJcbiAgICApIHtcclxuICAgICAgdGhpcy5fY2xvc2VEYXRlUGlja2VyKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgX2NoZWNrRGF0ZXNBcmVFcXVhbCA9IChkYXRlMTogP0RhdGUsIGRhdGUyOiA/RGF0ZSkgPT4ge1xyXG4gICAgY29uc3QgdGltZTEgPSBkYXRlMSA/IGRhdGUxLmdldFRpbWUoKSA6IG51bGw7XHJcbiAgICBjb25zdCB0aW1lMiA9IGRhdGUyID8gZGF0ZTIuZ2V0VGltZSgpIDogbnVsbDtcclxuICAgIHJldHVybiB0aW1lMSA9PT0gdGltZTI7XHJcbiAgfTtcclxuXHJcbiAgX2NyZWF0ZURhdGVQaWNrZXIgPSAoaGlsaWdodGVkRGF0ZTogP0RhdGUpOiB2b2lkID0+IHtcclxuICAgIGlmICghdGhpcy5fcmVmRWwuY3VycmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHtzdGFydCwgZW5kfSA9IHRoaXMucHJvcHM7XHJcbiAgICBjb25zdCB7ZWFybGllc3REYXRlLCBsYXRlc3REYXRlfSA9IHRoaXMucHJvcHM7XHJcbiAgICAvLyBEYXRlUmFuZ2VQaWNrZXIgY2FuIG5ldmVyIGhhdmUgZW5kIHdpdGhvdXQgc3RhcnRcclxuICAgIGlmIChzdGFydCA9PSBudWxsKSB7XHJcbiAgICAgIHN0YXJ0ID0gZW5kO1xyXG4gICAgICBlbmQgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2RhdGVQaWNrZXIgPSBEYXRlUmFuZ2VQaWNrZXIodGhpcy5fcmVmRWwuY3VycmVudCwge1xyXG4gICAgICBzdGFydE9wdHM6IHtcclxuICAgICAgICBoaWxpZ2h0ZWREYXRlOiBoaWxpZ2h0ZWREYXRlIHx8IHN0YXJ0IHx8IG5ldyBEYXRlKCksXHJcbiAgICAgICAgbWluOiBlYXJsaWVzdERhdGUsXHJcbiAgICAgICAgbWF4OiBsYXRlc3REYXRlLFxyXG4gICAgICAgIHNob3VsZEZvY3VzT25SZW5kZXI6IGZhbHNlLFxyXG4gICAgICAgIGRheU9mZnNldDogMSxcclxuICAgICAgfSxcclxuICAgIH0pLm9uKCdzdGF0ZWNoYW5nZScsIChfLCBkcCkgPT4ge1xyXG4gICAgICBjb25zdCBuZXdTdGFydCA9IGRwLnN0YXRlLnN0YXJ0O1xyXG4gICAgICBjb25zdCBuZXdFbmQgPSBkcC5zdGF0ZS5lbmQ7XHJcbiAgICAgIGlmICghQm9vbGVhbih0aGlzLnByb3BzLnNlbGVjdFJhbmdlKSkge1xyXG4gICAgICAgIGlmICghdGhpcy5fY2hlY2tEYXRlc0FyZUVxdWFsKG5ld1N0YXJ0LCBuZXdFbmQpKSB7XHJcbiAgICAgICAgICBkcC5zZXRTdGF0ZSh7c3RhcnQ6IG5ld1N0YXJ0LCBlbmQ6IG5ld1N0YXJ0fSk7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBDYWxsIG9uRGF0ZXNDaGFuZ2UgaWYgbmV3IGRhdGUgd2FzIHNlbGVjdGVkXHJcbiAgICAgIGNvbnN0IHByZXZFbmQgPSBCb29sZWFuKHRoaXMucHJvcHMuc2VsZWN0UmFuZ2UpXHJcbiAgICAgICAgPyB0aGlzLnByb3BzLmVuZFxyXG4gICAgICAgIDogdGhpcy5wcm9wcy5zdGFydDtcclxuICAgICAgaWYgKFxyXG4gICAgICAgICF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwodGhpcy5wcm9wcy5zdGFydCwgbmV3U3RhcnQpIHx8XHJcbiAgICAgICAgKEJvb2xlYW4odGhpcy5wcm9wcy5zZWxlY3RSYW5nZSkgJiZcclxuICAgICAgICAgICF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwodGhpcy5wcm9wcy5lbmQsIG5ld0VuZCkpXHJcbiAgICAgICkge1xyXG4gICAgICAgIGlmIChuZXdFbmQgPCBuZXdTdGFydCkge1xyXG4gICAgICAgICAgdGhpcy5wcm9wcy5vbkRhdGVzQ2hhbmdlKG5ld0VuZCwgbmV3U3RhcnQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnByb3BzLm9uRGF0ZXNDaGFuZ2UobmV3U3RhcnQsIG5ld0VuZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoXHJcbiAgICAgICAgQm9vbGVhbih0aGlzLnByb3BzLnNob3dPbmx5T25Gb2N1cykgJiZcclxuICAgICAgICBuZXdFbmQgIT0gbnVsbCAmJlxyXG4gICAgICAgICF0aGlzLl9jaGVja0RhdGVzQXJlRXF1YWwobmV3RW5kLCBwcmV2RW5kKVxyXG4gICAgICApIHtcclxuICAgICAgICB0aGlzLl9jbG9zZURhdGVQaWNrZXIoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5fZGF0ZVBpY2tlci5zZXRTdGF0ZSh7c3RhcnQsIGVuZH0pO1xyXG4gIH07XHJcblxyXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcclxuICAgIGNvbnN0IGNsYXNzbmFtZSA9IGNsYXNzbmFtZXMoXHJcbiAgICAgIHRoaXMucHJvcHMuY2xhc3NOYW1lLFxyXG4gICAgICAnbnVjbGlkZS11aS1kYXRlLXNlbGVjdG9yJyxcclxuICAgICAgeydudWNsaWRlLXVpLWRyb3Bkb3duLWRhdGUtc2VsZWN0b3InOiB0aGlzLnByb3BzLnNob3dPbmx5T25Gb2N1c30sXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxkaXYgb25Gb2N1cz17dGhpcy5fb3BlbkRhdGVQaWNrZXJ9IG9uQmx1cj17dGhpcy5faGFuZGxlTG9zdEZvY3VzfT5cclxuICAgICAgICB7dGhpcy5wcm9wcy5jaGlsZHJlbn1cclxuICAgICAgICB7dGhpcy5zdGF0ZS5pc09wZW4gPyAoXHJcbiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT17Y2xhc3NuYW1lfSByZWY9e3RoaXMuX3JlZkVsfSAvPlxyXG4gICAgICAgICkgOiBudWxsfVxyXG4gICAgICA8L2Rpdj5cclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==