"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _assert = _interopRequireDefault(require("assert"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _tabbable = _interopRequireDefault(require("tabbable"));

var _classnames = _interopRequireDefault(require("classnames"));

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/* eslint-env browser */
const TABBABLE_CLASS_NAME = 'nuclide-tabbable';
/**
 * Enables focusing between inputs with tab and shift-tab. Can also be used to
 * trap focus within the container by using the contained property.
 */

class TabbableContainer extends _react.default.Component {
  constructor(...args) {
    super(...args);
    this._disposables = void 0;
    this._rootNode = void 0;
  }

  componentDidMount() {
    const rootNode = this._rootNode;
    (0, _assert.default)(rootNode != null);
    const {
      focusOnMount
    } = this.props; // If focus has been deliberately set inside the container, don't try
    // to override it

    if (focusOnMount && !rootNode.contains(document.activeElement)) {
      const tabbableElements = (0, _tabbable.default)(rootNode);
      const firstTabbableElement = tabbableElements[0];

      if (firstTabbableElement instanceof HTMLElement) {
        firstTabbableElement.focus();
      }
    }

    this._disposables = new _UniversalDisposable.default(_rxjsCompatUmdMin.Observable.fromEvent(rootNode, 'keydown').subscribe(event => {
      if (event.altKey || event.ctrlKey || event.metaKey) {
        return;
      }

      if (event.key === 'Tab') {
        if (event.shiftKey) {
          focusPrevious();
        } else {
          focusNext();
        }

        event.preventDefault();
        event.stopPropagation();
      }
    }));
  }

  componentWillUnmount() {
    this._disposables.dispose();
  }

  render() {
    return /*#__PURE__*/_react.default.createElement("div", {
      className: (0, _classnames.default)(TABBABLE_CLASS_NAME, this.props.className),
      "data-contained": this.props.contained,
      ref: node => this._rootNode = node
    }, this.props.children);
  }

}

exports.default = TabbableContainer;
TabbableContainer.defaultProps = {
  contained: false,
  focusOnMount: true
};

function focusNext() {
  const currentElement = getFocusedElement();

  if (!(currentElement instanceof HTMLElement)) {
    return;
  }

  const focusedTabIndex = currentElement.tabIndex >= 0 ? currentElement.tabIndex : -Infinity;
  let nextElement = null;
  let nextTabIndex = Infinity;
  let lowestElement = null;
  let lowestTabIndex = Infinity;
  let container = findParentElement(currentElement, element => {
    return element.classList.contains(TABBABLE_CLASS_NAME);
  });

  if (container instanceof HTMLElement && container.dataset.contained === 'false') {
    container = null;
  }

  eachTabIndexedElement(currentElement, false
  /* reverse */
  , (element, tabIndex) => {
    if (tabIndex < lowestTabIndex) {
      lowestTabIndex = tabIndex;
      lowestElement = element;
    }

    if (focusedTabIndex <= tabIndex && tabIndex < nextTabIndex) {
      nextTabIndex = tabIndex;
      nextElement = element;

      if (focusedTabIndex === tabIndex || focusedTabIndex + 1 === tabIndex) {
        return true; // doneSearching
      }
    }

    return false; // doneSearching
  }, container);

  if (nextElement) {
    nextElement.focus();
  } else if (lowestElement) {
    lowestElement.focus();
  }
}

function focusPrevious() {
  const currentElement = getFocusedElement();

  if (!(currentElement instanceof HTMLElement)) {
    return;
  }

  const focusedTabIndex = currentElement.tabIndex >= 0 ? currentElement.tabIndex : Infinity;
  let previousElement = null;
  let previousTabIndex = -Infinity;
  let highestElement = null;
  let highestTabIndex = -Infinity;
  let container = findParentElement(currentElement, element => {
    return element.classList.contains(TABBABLE_CLASS_NAME);
  });

  if (container instanceof HTMLElement && container.dataset.contained === 'false') {
    container = null;
  }

  eachTabIndexedElement(currentElement, true
  /* reverse */
  , (element, tabIndex) => {
    if (tabIndex > highestTabIndex) {
      highestTabIndex = tabIndex;
      highestElement = element;
    }

    if (focusedTabIndex >= tabIndex && tabIndex > previousTabIndex) {
      previousTabIndex = tabIndex;
      previousElement = element;

      if (focusedTabIndex === tabIndex || focusedTabIndex - 1 === tabIndex) {
        return true; // doneSearching
      }
    }

    return false; // doneSearching
  }, container);

  if (previousElement) {
    previousElement.focus();
  } else if (highestElement) {
    highestElement.focus();
  }
}
/**
 * Traverses all focusable elements for the next element to focus.
 * curentElement is where the traversal starts.
 * reverse determines whether to traverse backwards or forwards.
 * updateNextCandidate is a method that determines if the element is the best
 *                     candidate to be focused next. A boolean is returned to
 *                     stop the traversal if that element is guaranteed to be
 *                     the next candidate.
 * container is where all of the focusable elements are searched.
 *           Default value is document.
 */


function eachTabIndexedElement(currentElement, reverse, updateNextCandidate, container) {
  const elements = (container || document).querySelectorAll('a, input, button, [tabindex]');
  let index = Array.from(elements).indexOf(currentElement);
  const increment = reverse ? -1 : 1;

  for (let i = 1; i < elements.length; ++i) {
    index = (index + elements.length + increment) % elements.length;
    const element = elements[index];

    if ( // $FlowFixMe(>=0.68.0) Flow suppress (T27187857)
    element.disabled === true || element.tabIndex == null || element.tabIndex < 0) {
      continue;
    }

    if (updateNextCandidate(element, element.tabIndex)) {
      break;
    }
  }
}

function getFocusedElement() {
  return document.activeElement;
}
/**
 * Finds a parent of currentElement that satisfies the condition.
 */


function findParentElement(currentElement, condition) {
  let element = currentElement;

  while (element && !condition(element)) {
    element = element.parentElement;
  }

  return element;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL1RhYmJhYmxlQ29udGFpbmVyLmpzIl0sIm5hbWVzIjpbIlRBQkJBQkxFX0NMQVNTX05BTUUiLCJUYWJiYWJsZUNvbnRhaW5lciIsIlJlYWN0IiwiQ29tcG9uZW50IiwiX2Rpc3Bvc2FibGVzIiwiX3Jvb3ROb2RlIiwiY29tcG9uZW50RGlkTW91bnQiLCJyb290Tm9kZSIsImZvY3VzT25Nb3VudCIsInByb3BzIiwiY29udGFpbnMiLCJkb2N1bWVudCIsImFjdGl2ZUVsZW1lbnQiLCJ0YWJiYWJsZUVsZW1lbnRzIiwiZmlyc3RUYWJiYWJsZUVsZW1lbnQiLCJIVE1MRWxlbWVudCIsImZvY3VzIiwiVW5pdmVyc2FsRGlzcG9zYWJsZSIsIk9ic2VydmFibGUiLCJmcm9tRXZlbnQiLCJzdWJzY3JpYmUiLCJldmVudCIsImFsdEtleSIsImN0cmxLZXkiLCJtZXRhS2V5Iiwia2V5Iiwic2hpZnRLZXkiLCJmb2N1c1ByZXZpb3VzIiwiZm9jdXNOZXh0IiwicHJldmVudERlZmF1bHQiLCJzdG9wUHJvcGFnYXRpb24iLCJjb21wb25lbnRXaWxsVW5tb3VudCIsImRpc3Bvc2UiLCJyZW5kZXIiLCJjbGFzc05hbWUiLCJjb250YWluZWQiLCJub2RlIiwiY2hpbGRyZW4iLCJkZWZhdWx0UHJvcHMiLCJjdXJyZW50RWxlbWVudCIsImdldEZvY3VzZWRFbGVtZW50IiwiZm9jdXNlZFRhYkluZGV4IiwidGFiSW5kZXgiLCJJbmZpbml0eSIsIm5leHRFbGVtZW50IiwibmV4dFRhYkluZGV4IiwibG93ZXN0RWxlbWVudCIsImxvd2VzdFRhYkluZGV4IiwiY29udGFpbmVyIiwiZmluZFBhcmVudEVsZW1lbnQiLCJlbGVtZW50IiwiY2xhc3NMaXN0IiwiZGF0YXNldCIsImVhY2hUYWJJbmRleGVkRWxlbWVudCIsInByZXZpb3VzRWxlbWVudCIsInByZXZpb3VzVGFiSW5kZXgiLCJoaWdoZXN0RWxlbWVudCIsImhpZ2hlc3RUYWJJbmRleCIsInJldmVyc2UiLCJ1cGRhdGVOZXh0Q2FuZGlkYXRlIiwiZWxlbWVudHMiLCJxdWVyeVNlbGVjdG9yQWxsIiwiaW5kZXgiLCJBcnJheSIsImZyb20iLCJpbmRleE9mIiwiaW5jcmVtZW50IiwiaSIsImxlbmd0aCIsImRpc2FibGVkIiwiY29uZGl0aW9uIiwicGFyZW50RWxlbWVudCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBbkJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFxQkEsTUFBTUEsbUJBQW1CLEdBQUcsa0JBQTVCO0FBRUE7QUFDQTtBQUNBO0FBQ0E7O0FBQ2UsTUFBTUMsaUJBQU4sU0FBZ0NDLGVBQU1DLFNBQXRDLENBQXVEO0FBQUE7QUFBQTtBQUFBLFNBQ3BFQyxZQURvRTtBQUFBLFNBRXBFQyxTQUZvRTtBQUFBOztBQVNwRUMsRUFBQUEsaUJBQWlCLEdBQUc7QUFDbEIsVUFBTUMsUUFBUSxHQUFHLEtBQUtGLFNBQXRCO0FBQ0EseUJBQVVFLFFBQVEsSUFBSSxJQUF0QjtBQUNBLFVBQU07QUFBQ0MsTUFBQUE7QUFBRCxRQUFpQixLQUFLQyxLQUE1QixDQUhrQixDQUtsQjtBQUNBOztBQUNBLFFBQUlELFlBQVksSUFBSSxDQUFDRCxRQUFRLENBQUNHLFFBQVQsQ0FBa0JDLFFBQVEsQ0FBQ0MsYUFBM0IsQ0FBckIsRUFBZ0U7QUFDOUQsWUFBTUMsZ0JBQWdCLEdBQUcsdUJBQVNOLFFBQVQsQ0FBekI7QUFDQSxZQUFNTyxvQkFBb0IsR0FBR0QsZ0JBQWdCLENBQUMsQ0FBRCxDQUE3Qzs7QUFDQSxVQUFJQyxvQkFBb0IsWUFBWUMsV0FBcEMsRUFBaUQ7QUFDL0NELFFBQUFBLG9CQUFvQixDQUFDRSxLQUFyQjtBQUNEO0FBQ0Y7O0FBRUQsU0FBS1osWUFBTCxHQUFvQixJQUFJYSw0QkFBSixDQUNsQkMsNkJBQVdDLFNBQVgsQ0FBcUJaLFFBQXJCLEVB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QXdDTixRQUFRLENBQUNRLE1BQXpEO0FBQ0EsVUFBTWxCLE9BQU8sR0FBR1UsUUFBUSxDQUFDRSxLQUFELENBQXhCOztBQUNBLFNBQ0U7QUFDQVosSUFBQUEsT0FBTyxDQUFDbUIsUUFBUixLQUFxQixJQUFyQixJQUNBbkIsT0FBTyxDQUFDUixRQUFSLElBQW9CLElBRHBCLElBRUFRLE9BQU8sQ0FBQ1IsUUFBUixHQUFtQixDQUpyQixFQUtFO0FBQ0E7QUFDRDs7QUFDRCxRQUFJaUIsbUJBQW1CLENBQUNULE9BQUQsRUFBVUEsT0FBTyxDQUFDUixRQUFsQixDQUF2QixFQUFvRDtBQUNsRDtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxTQUFTRixpQkFBVCxHQUF1QztBQUNyQyxTQUFPN0IsUUFBUSxDQUFDQyxhQUFoQjtBQUNEO0FBRUQ7QUFDQTtBQUNBOzs7QUFDQSxTQUFTcUMsaUJBQVQsQ0FDRVYsY0FERixFQUVFK0IsU0FGRixFQUdZO0FBQ1YsTUFBSXBCLE9BQU8sR0FBR1gsY0FBZDs7QUFDQSxTQUFPVyxPQUFPLElBQUksQ0FBQ29CLFNBQVMsQ0FBQ3BCLE9BQUQsQ0FBNUIsRUFBdUM7QUFDckNBLElBQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUFDcUIsYUFBbEI7QUFDRDs7QUFDRCxTQUFPckIsT0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvdyBzdHJpY3QtbG9jYWxcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbi8qIGVzbGludC1lbnYgYnJvd3NlciAqL1xyXG5cclxuaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IGludmFyaWFudCBmcm9tICdhc3NlcnQnO1xyXG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcbmltcG9ydCB0YWJiYWJsZSBmcm9tICd0YWJiYWJsZSc7XHJcbmltcG9ydCBjbGFzc25hbWVzIGZyb20gJ2NsYXNzbmFtZXMnO1xyXG5pbXBvcnQgVW5pdmVyc2FsRGlzcG9zYWJsZSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9Vbml2ZXJzYWxEaXNwb3NhYmxlJztcclxuXHJcbnR5cGUgRGVmYXVsdFByb3BzID0ge1xyXG4gIGNvbnRhaW5lZDogYm9vbGVhbixcclxuICBmb2N1c09uTW91bnQ6IGJvb2xlYW4sXHJcbn07XHJcblxyXG50eXBlIFByb3BzID0ge1xyXG4gIGNoaWxkcmVuPzogUmVhY3QkTm9kZSxcclxuICBjb250YWluZWQ6IGJvb2xlYW4sXHJcbiAgZm9jdXNPbk1vdW50OiBib29sZWFuLFxyXG4gIGNsYXNzTmFtZT86IHN0cmluZyxcclxufTtcclxuXHJcbmNvbnN0IFRBQkJBQkxFX0NMQVNTX05BTUUgPSAnbnVjbGlkZS10YWJiYWJsZSc7XHJcblxyXG4vKipcclxuICogRW5hYmxlcyBmb2N1c2luZyBiZXR3ZWVuIGlucHV0cyB3aXRoIHRhYiBhbmQgc2hpZnQtdGFiLiBDYW4gYWxzbyBiZSB1c2VkIHRvXHJcbiAqIHRyYXAgZm9jdXMgd2l0aGluIHRoZSBjb250YWluZXIgYnkgdXNpbmcgdGhlIGNvbnRhaW5lZCBwcm9wZXJ0eS5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhYmJhYmxlQ29udGFpbmVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFByb3BzPiB7XHJcbiAgX2Rpc3Bvc2FibGVzOiBVbml2ZXJzYWxEaXNwb3NhYmxlO1xyXG4gIF9yb290Tm9kZTogP0hUTUxEaXZFbGVtZW50O1xyXG5cclxuICBzdGF0aWMgZGVmYXVsdFByb3BzOiBEZWZhdWx0UHJvcHMgPSB7XHJcbiAgICBjb250YWluZWQ6IGZhbHNlLFxyXG4gICAgZm9jdXNPbk1vdW50OiB0cnVlLFxyXG4gIH07XHJcblxyXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xyXG4gICAgY29uc3Qgcm9vdE5vZGUgPSB0aGlzLl9yb290Tm9kZTtcclxuICAgIGludmFyaWFudChyb290Tm9kZSAhPSBudWxsKTtcclxuICAgIGNvbnN0IHtmb2N1c09uTW91bnR9ID0gdGhpcy5wcm9wcztcclxuXHJcbiAgICAvLyBJZiBmb2N1cyBoYXMgYmVlbiBkZWxpYmVyYXRlbHkgc2V0IGluc2lkZSB0aGUgY29udGFpbmVyLCBkb24ndCB0cnlcclxuICAgIC8vIHRvIG92ZXJyaWRlIGl0XHJcbiAgICBpZiAoZm9jdXNPbk1vdW50ICYmICFyb290Tm9kZS5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KSkge1xyXG4gICAgICBjb25zdCB0YWJiYWJsZUVsZW1lbnRzID0gdGFiYmFibGUocm9vdE5vZGUpO1xyXG4gICAgICBjb25zdCBmaXJzdFRhYmJhYmxlRWxlbWVudCA9IHRhYmJhYmxlRWxlbWVudHNbMF07XHJcbiAgICAgIGlmIChmaXJzdFRhYmJhYmxlRWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7XHJcbiAgICAgICAgZmlyc3RUYWJiYWJsZUVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2Rpc3Bvc2FibGVzID0gbmV3IFVuaXZlcnNhbERpc3Bvc2FibGUoXHJcbiAgICAgIE9ic2VydmFibGUuZnJvbUV2ZW50KHJvb3ROb2RlLCAna2V5ZG93bicpLnN1YnNjcmliZShcclxuICAgICAgICAoZXZlbnQ6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgICAgIGlmIChldmVudC5hbHRLZXkgfHwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnVGFiJykge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuc2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICBmb2N1c1ByZXZpb3VzKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgZm9jdXNOZXh0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIHJlbmRlcigpOiBSZWFjdCROb2RlIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxkaXZcclxuICAgICAgICBjbGFzc05hbWU9e2NsYXNzbmFtZXMoVEFCQkFCTEVfQ0xBU1NfTkFNRSwgdGhpcy5wcm9wcy5jbGFzc05hbWUpfVxyXG4gICAgICAgIGRhdGEtY29udGFpbmVkPXt0aGlzLnByb3BzLmNvbnRhaW5lZH1cclxuICAgICAgICByZWY9e25vZGUgPT4gKHRoaXMuX3Jvb3ROb2RlID0gbm9kZSl9PlxyXG4gICAgICAgIHt0aGlzLnByb3BzLmNoaWxkcmVufVxyXG4gICAgICA8L2Rpdj5cclxuICAgICk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBmb2N1c05leHQoKTogdm9pZCB7XHJcbiAgY29uc3QgY3VycmVudEVsZW1lbnQgPSBnZXRGb2N1c2VkRWxlbWVudCgpO1xyXG4gIGlmICghKGN1cnJlbnRFbGVtZW50IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGNvbnN0IGZvY3VzZWRUYWJJbmRleCA9XHJcbiAgICBjdXJyZW50RWxlbWVudC50YWJJbmRleCA+PSAwID8gY3VycmVudEVsZW1lbnQudGFiSW5kZXggOiAtSW5maW5pdHk7XHJcblxyXG4gIGxldCBuZXh0RWxlbWVudCA9IG51bGw7XHJcbiAgbGV0IG5leHRUYWJJbmRleCA9IEluZmluaXR5O1xyXG4gIGxldCBsb3dlc3RFbGVtZW50ID0gbnVsbDtcclxuICBsZXQgbG93ZXN0VGFiSW5kZXggPSBJbmZpbml0eTtcclxuXHJcbiAgbGV0IGNvbnRhaW5lciA9IGZpbmRQYXJlbnRFbGVtZW50KGN1cnJlbnRFbGVtZW50LCBlbGVtZW50ID0+IHtcclxuICAgIHJldHVybiBlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhUQUJCQUJMRV9DTEFTU19OQU1FKTtcclxuICB9KTtcclxuICBpZiAoXHJcbiAgICBjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJlxyXG4gICAgY29udGFpbmVyLmRhdGFzZXQuY29udGFpbmVkID09PSAnZmFsc2UnXHJcbiAgKSB7XHJcbiAgICBjb250YWluZXIgPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgZWFjaFRhYkluZGV4ZWRFbGVtZW50KFxyXG4gICAgY3VycmVudEVsZW1lbnQsXHJcbiAgICBmYWxzZSAvKiByZXZlcnNlICovLFxyXG4gICAgKGVsZW1lbnQsIHRhYkluZGV4KSA9PiB7XHJcbiAgICAgIGlmICh0YWJJbmRleCA8IGxvd2VzdFRhYkluZGV4KSB7XHJcbiAgICAgICAgbG93ZXN0VGFiSW5kZXggPSB0YWJJbmRleDtcclxuICAgICAgICBsb3dlc3RFbGVtZW50ID0gZWxlbWVudDtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGZvY3VzZWRUYWJJbmRleCA8PSB0YWJJbmRleCAmJiB0YWJJbmRleCA8IG5leHRUYWJJbmRleCkge1xyXG4gICAgICAgIG5leHRUYWJJbmRleCA9IHRhYkluZGV4O1xyXG4gICAgICAgIG5leHRFbGVtZW50ID0gZWxlbWVudDtcclxuICAgICAgICBpZiAoZm9jdXNlZFRhYkluZGV4ID09PSB0YWJJbmRleCB8fCBmb2N1c2VkVGFiSW5kZXggKyAxID09PSB0YWJJbmRleCkge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGRvbmVTZWFyY2hpbmdcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uZVNlYXJjaGluZ1xyXG4gICAgfSxcclxuICAgIGNvbnRhaW5lcixcclxuICApO1xyXG5cclxuICBpZiAobmV4dEVsZW1lbnQpIHtcclxuICAgIG5leHRFbGVtZW50LmZvY3VzKCk7XHJcbiAgfSBlbHNlIGlmIChsb3dlc3RFbGVtZW50KSB7XHJcbiAgICBsb3dlc3RFbGVtZW50LmZvY3VzKCk7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBmb2N1c1ByZXZpb3VzKCk6IHZvaWQge1xyXG4gIGNvbnN0IGN1cnJlbnRFbGVtZW50ID0gZ2V0Rm9jdXNlZEVsZW1lbnQoKTtcclxuICBpZiAoIShjdXJyZW50RWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkge1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuICBjb25zdCBmb2N1c2VkVGFiSW5kZXggPVxyXG4gICAgY3VycmVudEVsZW1lbnQudGFiSW5kZXggPj0gMCA/IGN1cnJlbnRFbGVtZW50LnRhYkluZGV4IDogSW5maW5pdHk7XHJcblxyXG4gIGxldCBwcmV2aW91c0VsZW1lbnQgPSBudWxsO1xyXG4gIGxldCBwcmV2aW91c1RhYkluZGV4ID0gLUluZmluaXR5O1xyXG4gIGxldCBoaWdoZXN0RWxlbWVudCA9IG51bGw7XHJcbiAgbGV0IGhpZ2hlc3RUYWJJbmRleCA9IC1JbmZpbml0eTtcclxuXHJcbiAgbGV0IGNvbnRhaW5lciA9IGZpbmRQYXJlbnRFbGVtZW50KGN1cnJlbnRFbGVtZW50LCBlbGVtZW50ID0+IHtcclxuICAgIHJldHVybiBlbGVtZW50LmNsYXNzTGlzdC5jb250YWlucyhUQUJCQUJMRV9DTEFTU19OQU1FKTtcclxuICB9KTtcclxuICBpZiAoXHJcbiAgICBjb250YWluZXIgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCAmJlxyXG4gICAgY29udGFpbmVyLmRhdGFzZXQuY29udGFpbmVkID09PSAnZmFsc2UnXHJcbiAgKSB7XHJcbiAgICBjb250YWluZXIgPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgZWFjaFRhYkluZGV4ZWRFbGVtZW50KFxyXG4gICAgY3VycmVudEVsZW1lbnQsXHJcbiAgICB0cnVlIC8qIHJldmVyc2UgKi8sXHJcbiAgICAoZWxlbWVudCwgdGFiSW5kZXgpID0+IHtcclxuICAgICAgaWYgKHRhYkluZGV4ID4gaGlnaGVzdFRhYkluZGV4KSB7XHJcbiAgICAgICAgaGlnaGVzdFRhYkluZGV4ID0gdGFiSW5kZXg7XHJcbiAgICAgICAgaGlnaGVzdEVsZW1lbnQgPSBlbGVtZW50O1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAoZm9jdXNlZFRhYkluZGV4ID49IHRhYkluZGV4ICYmIHRhYkluZGV4ID4gcHJldmlvdXNUYWJJbmRleCkge1xyXG4gICAgICAgIHByZXZpb3VzVGFiSW5kZXggPSB0YWJJbmRleDtcclxuICAgICAgICBwcmV2aW91c0VsZW1lbnQgPSBlbGVtZW50O1xyXG4gICAgICAgIGlmIChmb2N1c2VkVGFiSW5kZXggPT09IHRhYkluZGV4IHx8IGZvY3VzZWRUYWJJbmRleCAtIDEgPT09IHRhYkluZGV4KSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZG9uZVNlYXJjaGluZ1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIGZhbHNlOyAvLyBkb25lU2VhcmNoaW5nXHJcbiAgICB9LFxyXG4gICAgY29udGFpbmVyLFxyXG4gICk7XHJcblxyXG4gIGlmIChwcmV2aW91c0VsZW1lbnQpIHtcclxuICAgIHByZXZpb3VzRWxlbWVudC5mb2N1cygpO1xyXG4gIH0gZWxzZSBpZiAoaGlnaGVzdEVsZW1lbnQpIHtcclxuICAgIGhpZ2hlc3RFbGVtZW50LmZvY3VzKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogVHJhdmVyc2VzIGFsbCBmb2N1c2FibGUgZWxlbWVudHMgZm9yIHRoZSBuZXh0IGVsZW1lbnQgdG8gZm9jdXMuXHJcbiAqIGN1cmVudEVsZW1lbnQgaXMgd2hlcmUgdGhlIHRyYXZlcnNhbCBzdGFydHMuXHJcbiAqIHJldmVyc2UgZGV0ZXJtaW5lcyB3aGV0aGVyIHRvIHRyYXZlcnNlIGJhY2t3YXJkcyBvciBmb3J3YXJkcy5cclxuICogdXBkYXRlTmV4dENhbmRpZGF0ZSBpcyBhIG1ldGhvZCB0aGF0IGRldGVybWluZXMgaWYgdGhlIGVsZW1lbnQgaXMgdGhlIGJlc3RcclxuICogICAgICAgICAgICAgICAgICAgICBjYW5kaWRhdGUgdG8gYmUgZm9jdXNlZCBuZXh0LiBBIGJvb2xlYW4gaXMgcmV0dXJuZWQgdG9cclxuICogICAgICAgICAgICAgICAgICAgICBzdG9wIHRoZSB0cmF2ZXJzYWwgaWYgdGhhdCBlbGVtZW50IGlzIGd1YXJhbnRlZWQgdG8gYmVcclxuICogICAgICAgICAgICAgICAgICAgICB0aGUgbmV4dCBjYW5kaWRhdGUuXHJcbiAqIGNvbnRhaW5lciBpcyB3aGVyZSBhbGwgb2YgdGhlIGZvY3VzYWJsZSBlbGVtZW50cyBhcmUgc2VhcmNoZWQuXHJcbiAqICAgICAgICAgICBEZWZhdWx0IHZhbHVlIGlzIGRvY3VtZW50LlxyXG4gKi9cclxuZnVuY3Rpb24gZWFjaFRhYkluZGV4ZWRFbGVtZW50KFxyXG4gIGN1cnJlbnRFbGVtZW50OiBFbGVtZW50LFxyXG4gIHJldmVyc2U6IGJvb2xlYW4sXHJcbiAgdXBkYXRlTmV4dENhbmRpZGF0ZTogKGVsZW1lbnQ6IEVsZW1lbnQsIHRhYkluZGV4OiBudW1iZXIpID0+IGJvb2xlYW4sXHJcbiAgY29udGFpbmVyOiA/RWxlbWVudCxcclxuKTogdm9pZCB7XHJcbiAgY29uc3QgZWxlbWVudHMgPSAoY29udGFpbmVyIHx8IGRvY3VtZW50KS5xdWVyeVNlbGVjdG9yQWxsKFxyXG4gICAgJ2EsIGlucHV0LCBidXR0b24sIFt0YWJpbmRleF0nLFxyXG4gICk7XHJcbiAgbGV0IGluZGV4ID0gQXJyYXkuZnJvbShlbGVtZW50cykuaW5kZXhPZihjdXJyZW50RWxlbWVudCk7XHJcbiAgY29uc3QgaW5jcmVtZW50ID0gcmV2ZXJzZSA/IC0xIDogMTtcclxuICBmb3IgKGxldCBpID0gMTsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgKytpKSB7XHJcbiAgICBpbmRleCA9IChpbmRleCArIGVsZW1lbnRzLmxlbmd0aCArIGluY3JlbWVudCkgJSBlbGVtZW50cy5sZW5ndGg7XHJcbiAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHNbaW5kZXhdO1xyXG4gICAgaWYgKFxyXG4gICAgICAvLyAkRmxvd0ZpeE1lKD49MC42OC4wKSBGbG93IHN1cHByZXNzIChUMjcxODc4NTcpXHJcbiAgICAgIGVsZW1lbnQuZGlzYWJsZWQgPT09IHRydWUgfHxcclxuICAgICAgZWxlbWVudC50YWJJbmRleCA9PSBudWxsIHx8XHJcbiAgICAgIGVsZW1lbnQudGFiSW5kZXggPCAwXHJcbiAgICApIHtcclxuICAgICAgY29udGludWU7XHJcbiAgICB9XHJcbiAgICBpZiAodXBkYXRlTmV4dENhbmRpZGF0ZShlbGVtZW50LCBlbGVtZW50LnRhYkluZGV4KSkge1xyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEZvY3VzZWRFbGVtZW50KCk6ID9FbGVtZW50IHtcclxuICByZXR1cm4gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcclxufVxyXG5cclxuLyoqXHJcbiAqIEZpbmRzIGEgcGFyZW50IG9mIGN1cnJlbnRFbGVtZW50IHRoYXQgc2F0aXNmaWVzIHRoZSBjb25kaXRpb24uXHJcbiAqL1xyXG5mdW5jdGlvbiBmaW5kUGFyZW50RWxlbWVudChcclxuICBjdXJyZW50RWxlbWVudDogP0VsZW1lbnQsXHJcbiAgY29uZGl0aW9uOiAoZWxlbWVudDogRWxlbWVudCkgPT4gYm9vbGVhbixcclxuKTogP0VsZW1lbnQge1xyXG4gIGxldCBlbGVtZW50ID0gY3VycmVudEVsZW1lbnQ7XHJcbiAgd2hpbGUgKGVsZW1lbnQgJiYgIWNvbmRpdGlvbihlbGVtZW50KSkge1xyXG4gICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudDtcclxuICB9XHJcbiAgcmV0dXJuIGVsZW1lbnQ7XHJcbn1cclxuIl19