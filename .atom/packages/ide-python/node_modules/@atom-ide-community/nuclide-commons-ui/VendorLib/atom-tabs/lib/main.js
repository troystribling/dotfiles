"use strict";

// Generated by CoffeeScript 1.12.2
(function () {
  var CompositeDisposable, Disposable, FileIcons, MRUListView, TabBarView, _, layout, ref;

  ref = require('atom'), CompositeDisposable = ref.CompositeDisposable, Disposable = ref.Disposable;
  FileIcons = require('./file-icons');
  layout = require('./layout');
  TabBarView = require('./tab-bar-view');
  MRUListView = require('./mru-list-view');
  _ = require('underscore-plus');
  module.exports = {
    activate: function (state) {
      var base, base1, base2, base3, base4, configKey, keyBindSource, paneContainers, ref1;
      this.subscriptions = new CompositeDisposable();
      layout.activate();
      this.tabBarViews = [];
      this.mruListViews = [];
      keyBindSource = 'tabs package';
      configKey = 'tabs.enableMruTabSwitching';

      this.updateTraversalKeybinds = function () {
        var bindings, disabledBindings;
        bindings = atom.keymaps.findKeyBindings({
          target: document.body,
          keystrokes: 'ctrl-tab'
        });

        if (bindings.length > 1 && bindings[0].source !== keyBindSource) {
          return;
        }

        bindings = atom.keymaps.findKeyBindings({
          target: document.body,
          keystrokes: 'ctrl-shift-tab'
        });

        if (bindings.length > 1 && bindings[0].source !== keyBindSource) {
          return;
        }

        if (atom.config.get(configKey)) {
          return atom.keymaps.removeBindingsFromSource(keyBindSource);
        } else {
          disabledBindings = {
            'body': {
              'ctrl-tab': 'pane:show-next-item',
              'ctrl-tab ^ctrl': 'unset!',
              'ctrl-shift-tab': 'pane:show-previous-item',
              'ctrl-shift-tab ^ctrl': 'unset!'
            }
          };
          return atom.keymaps.add(keyBindSource, disabledBindings, 0);
        }
      };

      this.subscriptions.add(atom.config.observe(configKey, function (_this) {
        return function () {
          return _this.updateTraversalKeybinds();
        };
      }(this)));
      this.subscriptions.add(typeof (base = atom.keymaps).onDidLoadUserKeymap === "function" ? base.onDidLoadUserKeymap(function (_this) {
        return function () {
          return _this.updateTraversalKeybinds();
        };
      }(this)) : void 0);
      this.subscriptions.add(atom.commands.add('atom-workspace', {
        'tabs:close-all-tabs': function (_this) {
          return function () {
            var i, ref1, results, tabBarView;
            ref1 = _this.tabBarViews;
            results = [];

            for (i = ref1.length - 1; i >= 0; i += -1) {
              tabBarView = ref1[i];
              results.push(tabBarView.closeAllTabs());
            }

            return results;
          };
        }(this)
      }));
      paneContainers = {
        center: (ref1 = typeof (base1 = atom.workspace).getCenter === "function" ? base1.getCenter() : void 0) != null ? ref1 : atom.workspace,
        left: typeof (base2 = atom.workspace).getLeftDock === "function" ? base2.getLeftDock() : void 0,
        right: typeof (base3 = atom.workspace).getRightDock === "function" ? base3.getRightDock() : void 0,
        bottom: typeof (base4 = atom.workspace).getBottomDock === "function" ? base4.getBottomDock() : void 0
      };
      return Object.keys(paneContainers).forEach(function (_this) {
        return function (location) {
          var container;
          container = paneContainers[location];

          if (!container) {
            return;
          }

          return _this.subscriptions.add(container.observePanes(function (pane) {
            var mruListView, paneElement, tabBarView;
            tabBarView = new TabBarView(pane, location);
            mruListView = new MRUListView();
            mruListView.initialize(pane);
            paneElement = pane.getElement();
            paneElement.insertBefore(tabBarView.element, paneElement.firstChild);

            _this.tabBarViews.push(tabBarView);

            pane.onDidDestroy(function () {
              return _.remove(_this.tabBarViews, tabBarView);
            });

            _this.mruListViews.push(mruListView);

            return pane.onDidDestroy(function () {
              return _.remove(_this.mruListViews, mruListView);
            });
          }));
        };
      }(this));
    },
    deactivate: function () {
      var i, j, len, len1, mruListView, ref1, ref2, ref3, tabBarView;
      layout.deactivate();
      this.subscriptions.dispose();

      if ((ref1 = this.fileIconsDisposable) != null) {
        ref1.dispose();
      }

      ref2 = this.tabBarViews;

      for (i = 0, len = ref2.length; i < len; i++) {
        tabBarView = ref2[i];
        tabBarView.destroy();
      }

      ref3 = this.mruListViews;

      for (j = 0, len1 = ref3.length; j < len1; j++) {
        mruListView = ref3[j];
        mruListView.destroy();
      }
    },
    consumeFileIcons: function (service) {
      FileIcons.setService(service);
      this.updateFileIcons();
      return new Disposable(function (_this) {
        return function () {
          FileIcons.resetService();
          return _this.updateFileIcons();
        };
      }(this));
    },
    updateFileIcons: function () {
      var i, len, ref1, results, tabBarView, tabView;
      ref1 = this.tabBarViews;
      results = [];

      for (i = 0, len = ref1.length; i < len; i++) {
        tabBarView = ref1[i];
        results.push(function () {
          var j, len1, ref2, results1;
          ref2 = tabBarView.getTabs();
          results1 = [];

          for (j = 0, len1 = ref2.length; j < len1; j++) {
            tabView = ref2[j];
            results1.push(tabView.updateIcon());
          }

          return results1;
        }());
      }

      return results;
    }
  };
}).call(void 0);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL1ZlbmRvckxpYi9hdG9tLXRhYnMvbGliL21haW4uanMiXSwibmFtZXMiOlsiQ29tcG9zaXRlRGlzcG9zYWJsZSIsIkRpc3Bvc2FibGUiLCJGaWxlSWNvbnMiLCJNUlVMaXN0VmlldyIsIlRhYkJhclZpZXciLCJfIiwibGF5b3V0IiwicmVmIiwicmVxdWlyZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJhY3RpdmF0ZSIsInN0YXRlIiwiYmFzZSIsImJhc2UxIiwiYmFzZTIiLCJiYXNlMyIsImJhc2U0IiwiY29uZmlnS2V5Iiwia2V5QmluZFNvdXJjZSIsInBhbmVDb250YWluZXJzIiwicmVmMSIsInN1YnNjcmlwdGlvbnMiLCJ0YWJCYXJWaWV3cyIsIm1ydUxpc3RWaWV3cyIsInVwZGF0ZVRyYXZlcnNhbEtleWJpbmRzIiwiYmluZGluZ3MiLCJkaXNhYmxlZEJpbmRpbmdzIiwiYXRvbSIsImtleW1hcHMiLCJmaW5kS2V5QmluZGluZ3MiLCJ0YXJnZXQiLCJkb2N1bWVudCIsImJvZHkiLCJrZXlzdHJva2VzIiwibGVuZ3RoIiwic291cmNlIiwiY29uZmlnIiwiZ2V0IiwicmVtb3ZlQmluZGluZ3NGcm9tU291cmNlIiwiYWRkIiwib2JzZXJ2ZSIsIl90aGlzIiwib25EaWRMb2FkVXNlcktleW1hcCIsImNvbW1hbmRzIiwiaSIsInJlc3VsdHMiLCJ0YWJCYXJWaWV3IiwicHVzaCIsImNsb3NlQWxsVGFicyIsImNlbnRlciIsIndvcmtzcGFjZSIsImdldENlbnRlciIsImxlZnQiLCJnZXRMZWZ0RG9jayIsInJpZ2h0IiwiZ2V0UmlnaHREb2NrIiwiYm90dG9tIiwiZ2V0Qm90dG9tRG9jayIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwibG9jYXRpb24iLCJjb250YWluZXIiLCJvYnNlcnZlUGFuZXMiLCJwYW5lIiwibXJ1TGlzdFZpZXciLCJwYW5lRWxlbWVudCIsImluaXRpYWxpemUiLCJnZXRFbGVtZW50IiwiaW5zZXJ0QmVmb3JlIiwiZWxlbWVudCIsImZpcnN0Q2hpbGQiLCJvbkRpZERlc3Ryb3kiLCJyZW1vdmUiLCJkZWFjdGl2YXRlIiwiaiIsImxlbiIsImxlbjEiLCJyZWYyIiwicmVmMyIsImRpc3Bvc2UiLCJmaWxlSWNvbnNEaXNwb3NhYmxlIiwiZGVzdHJveSIsImNvbnN1bWVGaWxlSWNvbnMiLCJzZXJ2aWNlIiwic2V0U2VydmljZSIsInVwZGF0ZUZpbGVJY29ucyIsInJlc2V0U2VydmljZSIsInRhYlZpZXciLCJyZXN1bHRzMSIsImdldFRhYnMiLCJ1cGRhdGVJY29uIiwiY2FsbCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBLENBQUMsWUFBVztBQUNWLE1BQUlBLG1CQUFKLEVBQXlCQyxVQUF6QixFQUFxQ0MsU0FBckMsRUFBZ0RDLFdBQWhELEVBQTZEQyxVQUE3RCxFQUF5RUMsQ0FBekUsRUFBNEVDLE1BQTVFLEVBQW9GQyxHQUFwRjs7QUFFQUEsRUFBQUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsTUFBRCxDQUFiLEVBQXVCUixtQkFBbUIsR0FBR08sR0FBRyxDQUFDUCxtQkFBakQsRUFBc0VDLFVBQVUsR0FBR00sR0FBRyxDQUFDTixVQUF2RjtBQUVBQyxFQUFBQSxTQUFTLEdBQUdNLE9BQU8sQ0FBQyxjQUFELENBQW5CO0FBRUFGLEVBQUFBLE1BQU0sR0FBR0UsT0FBTyxDQUFDLFVBQUQsQ0FBaEI7QUFFQUosRUFBQUEsVUFBVSxHQUFHSSxPQUFPLENBQUMsZ0JBQUQsQ0FBcEI7QUFFQUwsRUFBQUEsV0FBVyxHQUFHSyxPQUFPLENBQUMsaUJBQUQsQ0FBckI7QUFFQUgsRUFBQUEsQ0FBQyxHQUFHRyxPQUFPLENBQUMsaUJBQUQsQ0FBWDtBQUVBQyxFQUFBQSxNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDZkMsSUFBQUEsUUFBUSxFQUFFLFVBQVNDLEtBQVQsRUFBZ0I7QUFDeEIsVUFBSUMsSUFBSixFQUFVQyxLQUFWLEVBQWlCQyxLQUFqQixFQUF3QkMsS0FBeEIsRUFBK0JD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R0FBRyxFQUFYOztBQUNBLGVBQUtkLENBQUMsR0FBRyxDQUFKLEVBQU9FLElBQUksR0FBR0MsSUFBSSxDQUFDNUMsTUFBeEIsRUFBZ0N5QyxDQUFDLEdBQUdFLElBQXBDLEVBQTBDRixDQUFDLEVBQTNDLEVBQStDO0FBQzdDYSxZQUFBQSxPQUFPLEdBQUdWLElBQUksQ0FBQ0gsQ0FBRCxDQUFkO0FBQ0FjLFlBQUFBLFFBQVEsQ0FBQzFDLElBQVQsQ0FBY3lDLE9BQU8sQ0FBQ0csVUFBUixFQUFkO0FBQ0Q7O0FBQ0QsaUJBQU9GLFFBQVA7QUFDRCxTQVRZLEVBQWI7QUFVRDs7QUFDRCxhQUFPNUMsT0FBUDtBQUNEO0FBN0ljLEdBQWpCO0FBZ0pELENBL0pELEVBK0pHK0MsSUEvSkgiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuMTIuMlxyXG4oZnVuY3Rpb24oKSB7XHJcbiAgdmFyIENvbXBvc2l0ZURpc3Bvc2FibGUsIERpc3Bvc2FibGUsIEZpbGVJY29ucywgTVJVTGlzdFZpZXcsIFRhYkJhclZpZXcsIF8sIGxheW91dCwgcmVmO1xyXG5cclxuICByZWYgPSByZXF1aXJlKCdhdG9tJyksIENvbXBvc2l0ZURpc3Bvc2FibGUgPSByZWYuQ29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSA9IHJlZi5EaXNwb3NhYmxlO1xyXG5cclxuICBGaWxlSWNvbnMgPSByZXF1aXJlKCcuL2ZpbGUtaWNvbnMnKTtcclxuXHJcbiAgbGF5b3V0ID0gcmVxdWlyZSgnLi9sYXlvdXQnKTtcclxuXHJcbiAgVGFiQmFyVmlldyA9IHJlcXVpcmUoJy4vdGFiLWJhci12aWV3Jyk7XHJcblxyXG4gIE1SVUxpc3RWaWV3ID0gcmVxdWlyZSgnLi9tcnUtbGlzdC12aWV3Jyk7XHJcblxyXG4gIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlLXBsdXMnKTtcclxuXHJcbiAgbW9kdWxlLmV4cG9ydHMgPSB7XHJcbiAgICBhY3RpdmF0ZTogZnVuY3Rpb24oc3RhdGUpIHtcclxuICAgICAgdmFyIGJhc2UsIGJhc2UxLCBiYXNlMiwgYmFzZTMsIGJhc2U0LCBjb25maWdLZXksIGtleUJpbmRTb3VyY2UsIHBhbmVDb250YWluZXJzLCByZWYxO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gICAgICBsYXlvdXQuYWN0aXZhdGUoKTtcclxuICAgICAgdGhpcy50YWJCYXJWaWV3cyA9IFtdO1xyXG4gICAgICB0aGlzLm1ydUxpc3RWaWV3cyA9IFtdO1xyXG4gICAgICBrZXlCaW5kU291cmNlID0gJ3RhYnMgcGFja2FnZSc7XHJcbiAgICAgIGNvbmZpZ0tleSA9ICd0YWJzLmVuYWJsZU1ydVRhYlN3aXRjaGluZyc7XHJcbiAgICAgIHRoaXMudXBkYXRlVHJhdmVyc2FsS2V5YmluZHMgPSBmdW5jdGlvbigpIHtcclxuICAgICAgICB2YXIgYmluZGluZ3MsIGRpc2FibGVkQmluZGluZ3M7XHJcbiAgICAgICAgYmluZGluZ3MgPSBhdG9tLmtleW1hcHMuZmluZEtleUJpbmRpbmdzKHtcclxuICAgICAgICAgIHRhcmdldDogZG9jdW1lbnQuYm9keSxcclxuICAgICAgICAgIGtleXN0cm9rZXM6ICdjdHJsLXRhYidcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoYmluZGluZ3MubGVuZ3RoID4gMSAmJiBiaW5kaW5nc1swXS5zb3VyY2UgIT09IGtleUJpbmRTb3VyY2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgYmluZGluZ3MgPSBhdG9tLmtleW1hcHMuZmluZEtleUJpbmRpbmdzKHtcclxuICAgICAgICAgIHRhcmdldDogZG9jdW1lbnQuYm9keSxcclxuICAgICAgICAgIGtleXN0cm9rZXM6ICdjdHJsLXNoaWZ0LXRhYidcclxuICAgICAgICB9KTtcclxuICAgICAgICBpZiAoYmluZGluZ3MubGVuZ3RoID4gMSAmJiBiaW5kaW5nc1swXS5zb3VyY2UgIT09IGtleUJpbmRTb3VyY2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGF0b20uY29uZmlnLmdldChjb25maWdLZXkpKSB7XHJcbiAgICAgICAgICByZXR1cm4gYXRvbS5rZXltYXBzLnJlbW92ZUJpbmRpbmdzRnJvbVNvdXJjZShrZXlCaW5kU291cmNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGlzYWJsZWRCaW5kaW5ncyA9IHtcclxuICAgICAgICAgICAgJ2JvZHknOiB7XHJcbiAgICAgICAgICAgICAgJ2N0cmwtdGFiJzogJ3BhbmU6c2hvdy1uZXh0LWl0ZW0nLFxyXG4gICAgICAgICAgICAgICdjdHJsLXRhYiBeY3RybCc6ICd1bnNldCEnLFxyXG4gICAgICAgICAgICAgICdjdHJsLXNoaWZ0LXRhYic6ICdwYW5lOnNob3ctcHJldmlvdXMtaXRlbScsXHJcbiAgICAgICAgICAgICAgJ2N0cmwtc2hpZnQtdGFiIF5jdHJsJzogJ3Vuc2V0ISdcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHJldHVybiBhdG9tLmtleW1hcHMuYWRkKGtleUJpbmRTb3VyY2UsIGRpc2FibGVkQmluZGluZ3MsIDApO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChhdG9tLmNvbmZpZy5vYnNlcnZlKGNvbmZpZ0tleSwgKGZ1bmN0aW9uKF90aGlzKSB7XHJcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZVRyYXZlcnNhbEtleWJpbmRzKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgfSkodGhpcykpKTtcclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZCh0eXBlb2YgKGJhc2UgPSBhdG9tLmtleW1hcHMpLm9uRGlkTG9hZFVzZXJLZXltYXAgPT09IFwiZnVuY3Rpb25cIiA/IGJhc2Uub25EaWRMb2FkVXNlcktleW1hcCgoZnVuY3Rpb24oX3RoaXMpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlVHJhdmVyc2FsS2V5YmluZHMoKTtcclxuICAgICAgICB9O1xyXG4gICAgICB9KSh0aGlzKSkgOiB2b2lkIDApO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcclxuICAgICAgICAndGFiczpjbG9zZS1hbGwtdGFicyc6IChmdW5jdGlvbihfdGhpcykge1xyXG4gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICB2YXIgaSwgcmVmMSwgcmVzdWx0cywgdGFiQmFyVmlldztcclxuICAgICAgICAgICAgcmVmMSA9IF90aGlzLnRhYkJhclZpZXdzO1xyXG4gICAgICAgICAgICByZXN1bHRzID0gW107XHJcbiAgICAgICAgICAgIGZvciAoaSA9IHJlZjEubGVuZ3RoIC0gMTsgaSA+PSAwOyBpICs9IC0xKSB7XHJcbiAgICAgICAgICAgICAgdGFiQmFyVmlldyA9IHJlZjFbaV07XHJcbiAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRhYkJhclZpZXcuY2xvc2VBbGxUYWJzKCkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRzO1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KSh0aGlzKVxyXG4gICAgICB9KSk7XHJcbiAgICAgIHBhbmVDb250YWluZXJzID0ge1xyXG4gICAgICAgIGNlbnRlcjogKHJlZjEgPSB0eXBlb2YgKGJhc2UxID0gYXRvbS53b3Jrc3BhY2UpLmdldENlbnRlciA9PT0gXCJmdW5jdGlvblwiID8gYmFzZTEuZ2V0Q2VudGVyKCkgOiB2b2lkIDApICE9IG51bGwgPyByZWYxIDogYXRvbS53b3Jrc3BhY2UsXHJcbiAgICAgICAgbGVmdDogdHlwZW9mIChiYXNlMiA9IGF0b20ud29ya3NwYWNlKS5nZXRMZWZ0RG9jayA9PT0gXCJmdW5jdGlvblwiID8gYmFzZTIuZ2V0TGVmdERvY2soKSA6IHZvaWQgMCxcclxuICAgICAgICByaWdodDogdHlwZW9mIChiYXNlMyA9IGF0b20ud29ya3NwYWNlKS5nZXRSaWdodERvY2sgPT09IFwiZnVuY3Rpb25cIiA/IGJhc2UzLmdldFJpZ2h0RG9jaygpIDogdm9pZCAwLFxyXG4gICAgICAgIGJvdHRvbTogdHlwZW9mIChiYXNlNCA9IGF0b20ud29ya3NwYWNlKS5nZXRCb3R0b21Eb2NrID09PSBcImZ1bmN0aW9uXCIgPyBiYXNlNC5nZXRCb3R0b21Eb2NrKCkgOiB2b2lkIDBcclxuICAgICAgfTtcclxuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKHBhbmVDb250YWluZXJzKS5mb3JFYWNoKChmdW5jdGlvbihfdGhpcykge1xyXG4gICAgICAgIHJldHVybiBmdW5jdGlvbihsb2NhdGlvbikge1xyXG4gICAgICAgICAgdmFyIGNvbnRhaW5lcjtcclxuICAgICAgICAgIGNvbnRhaW5lciA9IHBhbmVDb250YWluZXJzW2xvY2F0aW9uXTtcclxuICAgICAgICAgIGlmICghY29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBfdGhpcy5zdWJzY3JpcHRpb25zLmFkZChjb250YWluZXIub2JzZXJ2ZVBhbmVzKGZ1bmN0aW9uKHBhbmUpIHtcclxuICAgICAgICAgICAgdmFyIG1ydUxpc3RWaWV3LCBwYW5lRWxlbWVudCwgdGFiQmFyVmlldztcclxuICAgICAgICAgICAgdGFiQmFyVmlldyA9IG5ldyBUYWJCYXJWaWV3KHBhbmUsIGxvY2F0aW9uKTtcclxuICAgICAgICAgICAgbXJ1TGlzdFZpZXcgPSBuZXcgTVJVTGlzdFZpZXc7XHJcbiAgICAgICAgICAgIG1ydUxpc3RWaWV3LmluaXRpYWxpemUocGFuZSk7XHJcbiAgICAgICAgICAgIHBhbmVFbGVtZW50ID0gcGFuZS5nZXRFbGVtZW50KCk7XHJcbiAgICAgICAgICAgIHBhbmVFbGVtZW50Lmluc2VydEJlZm9yZSh0YWJCYXJWaWV3LmVsZW1lbnQsIHBhbmVFbGVtZW50LmZpcnN0Q2hpbGQpO1xyXG4gICAgICAgICAgICBfdGhpcy50YWJCYXJWaWV3cy5wdXNoKHRhYkJhclZpZXcpO1xyXG4gICAgICAgICAgICBwYW5lLm9uRGlkRGVzdHJveShmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICByZXR1cm4gXy5yZW1vdmUoX3RoaXMudGFiQmFyVmlld3MsIHRhYkJhclZpZXcpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgX3RoaXMubXJ1TGlzdFZpZXdzLnB1c2gobXJ1TGlzdFZpZXcpO1xyXG4gICAgICAgICAgICByZXR1cm4gcGFuZS5vbkRpZERlc3Ryb3koZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIF8ucmVtb3ZlKF90aGlzLm1ydUxpc3RWaWV3cywgbXJ1TGlzdFZpZXcpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH0pKTtcclxuICAgICAgICB9O1xyXG4gICAgICB9KSh0aGlzKSk7XHJcbiAgICB9LFxyXG4gICAgZGVhY3RpdmF0ZTogZnVuY3Rpb24oKSB7XHJcbiAgICAgIHZhciBpLCBqLCBsZW4sIGxlbjEsIG1ydUxpc3RWaWV3LCByZWYxLCByZWYyLCByZWYzLCB0YWJCYXJWaWV3O1xyXG4gICAgICBsYXlvdXQuZGVhY3RpdmF0ZSgpO1xyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xyXG4gICAgICBpZiAoKHJlZjEgPSB0aGlzLmZpbGVJY29uc0Rpc3Bvc2FibGUpICE9IG51bGwpIHtcclxuICAgICAgICByZWYxLmRpc3Bvc2UoKTtcclxuICAgICAgfVxyXG4gICAgICByZWYyID0gdGhpcy50YWJCYXJWaWV3cztcclxuICAgICAgZm9yIChpID0gMCwgbGVuID0gcmVmMi5sZW5ndGg7IGkgPCBsZW47IGkrKykge1xyXG4gICAgICAgIHRhYkJhclZpZXcgPSByZWYyW2ldO1xyXG4gICAgICAgIHRhYkJhclZpZXcuZGVzdHJveSgpO1xyXG4gICAgICB9XHJcbiAgICAgIHJlZjMgPSB0aGlzLm1ydUxpc3RWaWV3cztcclxuICAgICAgZm9yIChqID0gMCwgbGVuMSA9IHJlZjMubGVuZ3RoOyBqIDwgbGVuMTsgaisrKSB7XHJcbiAgICAgICAgbXJ1TGlzdFZpZXcgPSByZWYzW2pdO1xyXG4gICAgICAgIG1ydUxpc3RWaWV3LmRlc3Ryb3koKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGNvbnN1bWVGaWxlSWNvbnM6IGZ1bmN0aW9uKHNlcnZpY2UpIHtcclxuICAgICAgRmlsZUljb25zLnNldFNlcnZpY2Uoc2VydmljZSk7XHJcbiAgICAgIHRoaXMudXBkYXRlRmlsZUljb25zKCk7XHJcbiAgICAgIHJldHVybiBuZXcgRGlzcG9zYWJsZSgoZnVuY3Rpb24oX3RoaXMpIHtcclxuICAgICAgICByZXR1cm4gZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICBGaWxlSWNvbnMucmVzZXRTZXJ2aWNlKCk7XHJcbiAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlRmlsZUljb25zKCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgfSkodGhpcykpO1xyXG4gICAgfSxcclxuICAgIHVwZGF0ZUZpbGVJY29uczogZnVuY3Rpb24oKSB7XHJcbiAgICAgIHZhciBpLCBsZW4sIHJlZjEsIHJlc3VsdHMsIHRhYkJhclZpZXcsIHRhYlZpZXc7XHJcbiAgICAgIHJlZjEgPSB0aGlzLnRhYkJhclZpZXdzO1xyXG4gICAgICByZXN1bHRzID0gW107XHJcbiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IHJlZjEubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICB0YWJCYXJWaWV3ID0gcmVmMVtpXTtcclxuICAgICAgICByZXN1bHRzLnB1c2goKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgdmFyIGosIGxlbjEsIHJlZjIsIHJlc3VsdHMxO1xyXG4gICAgICAgICAgcmVmMiA9IHRhYkJhclZpZXcuZ2V0VGFicygpO1xyXG4gICAgICAgICAgcmVzdWx0czEgPSBbXTtcclxuICAgICAgICAgIGZvciAoaiA9IDAsIGxlbjEgPSByZWYyLmxlbmd0aDsgaiA8IGxlbjE7IGorKykge1xyXG4gICAgICAgICAgICB0YWJWaWV3ID0gcmVmMltqXTtcclxuICAgICAgICAgICAgcmVzdWx0czEucHVzaCh0YWJWaWV3LnVwZGF0ZUljb24oKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcmVzdWx0czE7XHJcbiAgICAgICAgfSkoKSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbn0pLmNhbGwodGhpcyk7XHJcbiJdfQ==