'use babel';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _mruItemView = _interopRequireDefault(require("./mru-item-view"));

var _atom = require("atom");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class MRUListView {
  initialize(pane) {
    this.ownerDiv = document.createElement('div');
    this.element = document.createElement('ol');
    this.ownerDiv.appendChild(this.element);
    this.ownerDiv.classList.add('select-list', 'tabs-mru-switcher');
    this.pane = pane;
    this.subscribe();
    this.panel = atom.workspace.addModalPanel({
      item: this.ownerDiv,
      visible: false
    });
    this.element.classList.add('list-group');
    this.hideClickHandler = this.hide.bind(this);
    this.preventPropagationClickHandler = this.preventPropagation.bind(this);
  }

  subscribe() {
    this.subscriptions = new _atom.CompositeDisposable();
    /* Check for existence of events. Allows package tests to pass until this
    change hits stable. */

    if (typeof this.pane.onChooseNextMRUItem === 'function') {
      /* Because the chosen item is passed in the callback, both the
      ChooseNext and ChooseLast events can call our our single choose
      method. */
      this.subscriptions.add(this.pane.onChooseNextMRUItem(item => this.choose(item)));
      this.subscriptions.add(this.pane.onChooseLastMRUItem(item => this.choose(item)));
      this.subscriptions.add(this.pane.onDoneChoosingMRUItem(() => this.stopChoosing()));
    }

    this.subscriptions.add(this.pane.onDidDestroy(() => this.destroy()));
    this.subscriptions.add(atom.commands.add('atom-workspace', {
      'core:cancel': event => {
        if (this.hide()) event.stopPropagation();
      }
    }));
  }

  destroy() {
    this.subscriptions.dispose();
    this.panel.destroy();
  }

  choose(selectedItem) {
    this.show(selectedItem);
  }

  stopChoosing() {
    this.hide();
  }

  show(selectedItem) {
    let selectedViewElement;

    if (!this.panel.visible) {
      selectedViewElement = this.buildListView(selectedItem);
      this.panel.show();
      this.addClickHandlers();
    } else {
      selectedViewElement = this.updateSelectedItem(selectedItem);
    }

    this.scrollToItemView(selectedViewElement);
  }

  preventPropagation() {
    event.stopPropagation();
  }

  addClickHandlers() {
    document.body.addEventListener('click', this.hideClickHandler);
    this.ownerDiv.addEventListener('click', this.preventPropagationClickHandler);
  }

  removeClickHandler() {
    document.body.removeEventListener('click', this.hideClickHandler);
    this.ownerDiv.removeEventListener('click', this.preventPropagationClickHandler);
  }

  hide() {
    const willClose = this.panel.visible;

    if (willClose) {
      this.removeClickHandler();
      this.panel.hide();
    }

    return willClose;
  }

  updateSelectedItem(selectedItem) {
    let selectedView;

    for (let viewElement of this.element.children) {
      if (viewElement.itemViewData.item === selectedItem) {
        viewElement.itemViewData.select();
        selectedView = viewElement;
      } else viewElement.itemViewData.unselect();
    }

    return selectedView;
  }

  scrollToItemView(view) {
    const desiredTop = view.offsetTop;
    const desiredBottom = desiredTop + view.offsetHeight;

    if (desiredTop < this.element.scrollTop) {
      this.element.scrollTop = desiredTop;
    } else if (desiredBottom > this.element.scrollTop + this.element.clientHeight) {
      this.element.scrollTop = desiredBottom - this.element.clientHeight;
    }
  }

  buildListView(selectedItem) {
    /* Making this more efficient, and not simply building the view for the
    entire stack every time it's shown, has significant complexity cost.
    The pane system completely owns the MRU stack. Adding events and
    handlers to incrementally update the UI here would mean two copies of
    the stack to maintain and keep in sync. Let's take on that complexity
    only if this exhibits real-world performance issues. */
    while (this.element.firstChild) this.element.removeChild(this.element.firstChild);

    let selectedViewElement;
    /* We're inserting each item at the top so we traverse the stack from
    the bottom, resulting in the most recently used item at the top of the
    UI. */

    for (let i = this.pane.itemStack.length - 1; i >= 0; i--) {
      let item = this.pane.itemStack[i];
      let itemView = new _mruItemView.default();
      itemView.initialize(this, item);
      this.element.appendChild(itemView.element);

      if (item === selectedItem) {
        itemView.select();
        selectedViewElement = itemView;
      }
    }

    return selectedViewElement.element;
  }

}

exports.default = MRUListView;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL1ZlbmRvckxpYi9hdG9tLXRhYnMvbGliL21ydS1saXN0LXZpZXcuanMiXSwibmFtZXMiOlsiTVJVTGlzdFZpZXciLCJpbml0aWFsaXplIiwicGFuZSIsIm93bmVyRGl2IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiZWxlbWVudCIsImFwcGVuZENoaWxkIiwiY2xhc3NMaXN0IiwiYWRkIiwic3Vic2NyaWJlIiwicGFuZWwiLCJhdG9tIiwid29ya3NwYWNlIiwiYWRkTW9kYWxQYW5lbCIsIml0ZW0iLCJ2aXNpYmxlIiwiaGlkZUNsaWNrSGFuZGxlciIsImhpZGUiLCJiaW5kIiwicHJldmVudFByb3BhZ2F0aW9uQ2xpY2tIYW5kbGVyIiwicHJldmVudFByb3BhZ2F0aW9uIiwic3Vic2NyaXB0aW9ucyIsIkNvbXBvc2l0ZURpc3Bvc2FibGUiLCJvbkNob29zZU5leHRNUlVJdGVtIiwiY2hvb3NlIiwib25DaG9vc2VMYXN0TVJVSXRlbSIsIm9uRG9uZUNob29zaW5nTVJVSXRlbSIsInN0b3BDaG9vc2luZyIsIm9uRGlkRGVzdHJveSIsImRlc3Ryb3kiLCJjb21tYW5kcyIsImV2ZW50Iiwic3RvcFByb3BhZ2F0aW9uIiwiZGlzcG9zZSIsInNlbGVjdGVkSXRlbSIsInNob3ciLCJzZWxlY3RlZFZpZXdFbGVtZW50IiwiYnVpbGRMaXN0VmlldyIsImFkZENsaWNrSGFuZGxlcnMiLCJ1cGRhdGVTZWxlY3RlZEl0ZW0iLCJzY3JvbGxUb0l0ZW1WaWV3IiwiYm9keSIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVDbGlja0hhbmRsZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwid2lsbENsb3NlIiwic2VsZWN0ZWRWaWV3Iiwidmlld0VsZW1lbnQiLCJjaGlsZHJlbiIsIml0ZW1WaWV3RGF0YSIsInNlbGVjdCIsInVuc2VsZWN0IiwidmlldyIsImRlc2lyZWRUb3AiLCJvZmZzZXRUb3AiLCJkZXNpcmVkQm90dG9tIiwib2Zmc2V0SGVpZ2h0Iiwic2Nyb2xsVG9wIiwiY2xpZW50SGVpZ2h0IiwiZmlyc3RDaGlsZCIsInJlbW92ZUNoaWxkIiwiaSIsIml0ZW1TdGFjayIsImxlbmd0aCIsIml0ZW1WaWV3IiwiTVJVSXRlbVZpZXciXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7Ozs7QUFFZSxNQUFNQSxXQUFOLENBQWtCO0FBQy9CQyxFQUFBQSxVQUFVLENBQUVDLElBQUYsRUFBUTtBQUNoQixTQUFLQyxRQUFMLEdBQWdCQyxRQUFRLENBQUNDLGFBQVQsQ0FBdUIsS0FBdkIsQ0FBaEI7QUFDQSxTQUFLQyxPQUFMLEdBQWVGLFFBQVEsQ0FBQ0MsYUFBVCxDQUF1QixJQUF2QixDQUFmO0FBQ0EsU0FBS0YsUUFBTCxDQUFjSSxXQUFkLENBQTBCLEtBQUtELE9BQS9CO0FBQ0EsU0FBS0gsUUFBTCxDQUFjSyxTQUFkLENBQXdCQyxHQUF4QixDQUE0QixhQUE1QixFQUEyQyxtQkFBM0M7QUFFQSxTQUFLUCxJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLUSxTQUFMO0FBQ0EsU0FBS0MsS0FBTCxHQUFhQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUMsYUFBZixDQUE2QjtBQUN4Q0MsTUFBQUEsSUFBSSxFQUFFLEtBQUtaLFFBRDZCO0FBRXhDYSxNQUFBQSxPQUFPLEVBQUU7QUFGK0IsS0FBN0IsQ0FBYjtBQUlBLFNBQUtWLE9BQUwsQ0FBYUUsU0FBYixDQUF1QkMsR0FBdkIsQ0FBMkIsWUFBM0I7QUFFQSxTQUFLUSxnQkFBTCxHQUF3QixLQUFLQyxJQUFMLENBQVVDLElBQVYsQ0FBZSxJQUFmLENBQXhCO0FBQ0EsU0FBS0MsOEJBQUwsR0FBc0MsS0FBS0Msa0JBQUwsQ0FBd0JGLElBQXhCLENBQTZCLElBQTdCLENBQXRDO0FBQ0Q7O0FBRURULEVBQUFBLFNBQVMsR0FBSTtBQUNYLFNBQUtZLGFBQUwsR0FBcUIsSUFBSUMseUJBQUosRUFBckI7QUFFQTtBQUNKOztBQUNJLFFBQUksT0FBTyxL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Q0FBMUMsRUFBNkNGLENBQUMsSUFBSSxDQUFsRCxFQUFxREEsQ0FBQyxFQUF0RCxFQUEwRDtBQUN4RCxVQUFJL0MsSUFBSSxHQUFHLEtBQUtiLElBQUwsQ0FBVTZELFNBQVYsQ0FBb0JELENBQXBCLENBQVg7QUFDQSxVQUFJRyxRQUFRLEdBQUcsSUFBSUMsb0JBQUosRUFBZjtBQUNBRCxNQUFBQSxRQUFRLENBQUNoRSxVQUFULENBQW9CLElBQXBCLEVBQTBCYyxJQUExQjtBQUNBLFdBQUtULE9BQUwsQ0FBYUMsV0FBYixDQUF5QjBELFFBQVEsQ0FBQzNELE9BQWxDOztBQUNBLFVBQUlTLElBQUksS0FBS29CLFlBQWIsRUFBMkI7QUFDekI4QixRQUFBQSxRQUFRLENBQUNkLE1BQVQ7QUFDQWQsUUFBQUEsbUJBQW1CLEdBQUc0QixRQUF0QjtBQUNEO0FBQ0Y7O0FBQ0QsV0FBTzVCLG1CQUFtQixDQUFDL0IsT0FBM0I7QUFDRDs7QUEvSThCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCdcclxuXHJcbmltcG9ydCBNUlVJdGVtVmlldyBmcm9tICcuL21ydS1pdGVtLXZpZXcnXHJcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSdcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1SVUxpc3RWaWV3IHtcclxuICBpbml0aWFsaXplIChwYW5lKSB7XHJcbiAgICB0aGlzLm93bmVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcclxuICAgIHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29sJylcclxuICAgIHRoaXMub3duZXJEaXYuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50KVxyXG4gICAgdGhpcy5vd25lckRpdi5jbGFzc0xpc3QuYWRkKCdzZWxlY3QtbGlzdCcsICd0YWJzLW1ydS1zd2l0Y2hlcicpXHJcblxyXG4gICAgdGhpcy5wYW5lID0gcGFuZVxyXG4gICAgdGhpcy5zdWJzY3JpYmUoKVxyXG4gICAgdGhpcy5wYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZE1vZGFsUGFuZWwoe1xyXG4gICAgICBpdGVtOiB0aGlzLm93bmVyRGl2LFxyXG4gICAgICB2aXNpYmxlOiBmYWxzZVxyXG4gICAgfSlcclxuICAgIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdsaXN0LWdyb3VwJylcclxuXHJcbiAgICB0aGlzLmhpZGVDbGlja0hhbmRsZXIgPSB0aGlzLmhpZGUuYmluZCh0aGlzKVxyXG4gICAgdGhpcy5wcmV2ZW50UHJvcGFnYXRpb25DbGlja0hhbmRsZXIgPSB0aGlzLnByZXZlbnRQcm9wYWdhdGlvbi5iaW5kKHRoaXMpXHJcbiAgfVxyXG5cclxuICBzdWJzY3JpYmUgKCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxyXG5cclxuICAgIC8qIENoZWNrIGZvciBleGlzdGVuY2Ugb2YgZXZlbnRzLiBBbGxvd3MgcGFja2FnZSB0ZXN0cyB0byBwYXNzIHVudGlsIHRoaXNcclxuICAgIGNoYW5nZSBoaXRzIHN0YWJsZS4gKi9cclxuICAgIGlmICh0eXBlb2YgdGhpcy5wYW5lLm9uQ2hvb3NlTmV4dE1SVUl0ZW0gPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgLyogQmVjYXVzZSB0aGUgY2hvc2VuIGl0ZW0gaXMgcGFzc2VkIGluIHRoZSBjYWxsYmFjaywgYm90aCB0aGVcclxuICAgICAgQ2hvb3NlTmV4dCBhbmQgQ2hvb3NlTGFzdCBldmVudHMgY2FuIGNhbGwgb3VyIG91ciBzaW5nbGUgY2hvb3NlXHJcbiAgICAgIG1ldGhvZC4gKi9cclxuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcclxuICAgICAgICB0aGlzLnBhbmUub25DaG9vc2VOZXh0TVJVSXRlbSgoaXRlbSkgPT4gdGhpcy5jaG9vc2UoaXRlbSkpKVxyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxyXG4gICAgICAgIHRoaXMucGFuZS5vbkNob29zZUxhc3RNUlVJdGVtKChpdGVtKSA9PiB0aGlzLmNob29zZShpdGVtKSkpXHJcblxyXG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbnMuYWRkKFxyXG4gICAgICAgIHRoaXMucGFuZS5vbkRvbmVDaG9vc2luZ01SVUl0ZW0oKCkgPT4gdGhpcy5zdG9wQ2hvb3NpbmcoKSkpXHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcclxuICAgICAgdGhpcy5wYW5lLm9uRGlkRGVzdHJveSgoKSA9PiB0aGlzLmRlc3Ryb3koKSkpXHJcblxyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcclxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xyXG4gICAgICAgICdjb3JlOmNhbmNlbCc6IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuaGlkZSgpKSBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgIClcclxuICB9XHJcblxyXG4gIGRlc3Ryb3kgKCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKVxyXG4gICAgdGhpcy5wYW5lbC5kZXN0cm95KClcclxuICB9XHJcblxyXG4gIGNob29zZSAoc2VsZWN0ZWRJdGVtKSB7XHJcbiAgICB0aGlzLnNob3coc2VsZWN0ZWRJdGVtKVxyXG4gIH1cclxuXHJcbiAgc3RvcENob29zaW5nICgpIHtcclxuICAgIHRoaXMuaGlkZSgpXHJcbiAgfVxyXG5cclxuICBzaG93IChzZWxlY3RlZEl0ZW0pIHtcclxuICAgIGxldCBzZWxlY3RlZFZpZXdFbGVtZW50XHJcbiAgICBpZiAoIXRoaXMucGFuZWwudmlzaWJsZSkge1xyXG4gICAgICBzZWxlY3RlZFZpZXdFbGVtZW50ID0gdGhpcy5idWlsZExpc3RWaWV3KHNlbGVjdGVkSXRlbSlcclxuICAgICAgdGhpcy5wYW5lbC5zaG93KClcclxuICAgICAgdGhpcy5hZGRDbGlja0hhbmRsZXJzKClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHNlbGVjdGVkVmlld0VsZW1lbnQgPSB0aGlzLnVwZGF0ZVNlbGVjdGVkSXRlbShzZWxlY3RlZEl0ZW0pXHJcbiAgICB9XHJcbiAgICB0aGlzLnNjcm9sbFRvSXRlbVZpZXcoc2VsZWN0ZWRWaWV3RWxlbWVudClcclxuICB9XHJcblxyXG4gIHByZXZlbnRQcm9wYWdhdGlvbiAoKSB7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKVxyXG4gIH1cclxuXHJcbiAgYWRkQ2xpY2tIYW5kbGVycyAoKSB7XHJcbiAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5oaWRlQ2xpY2tIYW5kbGVyKVxyXG4gICAgdGhpcy5vd25lckRpdi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMucHJldmVudFByb3BhZ2F0aW9uQ2xpY2tIYW5kbGVyKVxyXG4gIH1cclxuXHJcbiAgcmVtb3ZlQ2xpY2tIYW5kbGVyICgpIHtcclxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLmhpZGVDbGlja0hhbmRsZXIpXHJcbiAgICB0aGlzLm93bmVyRGl2LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5wcmV2ZW50UHJvcGFnYXRpb25DbGlja0hhbmRsZXIpXHJcbiAgfVxyXG5cclxuICBoaWRlICgpIHtcclxuICAgIGNvbnN0IHdpbGxDbG9zZSA9IHRoaXMucGFuZWwudmlzaWJsZVxyXG4gICAgaWYgKHdpbGxDbG9zZSkge1xyXG4gICAgICB0aGlzLnJlbW92ZUNsaWNrSGFuZGxlcigpXHJcbiAgICAgIHRoaXMucGFuZWwuaGlkZSgpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gd2lsbENsb3NlXHJcbiAgfVxyXG5cclxuICB1cGRhdGVTZWxlY3RlZEl0ZW0gKHNlbGVjdGVkSXRlbSkge1xyXG4gICAgbGV0IHNlbGVjdGVkVmlld1xyXG4gICAgZm9yIChsZXQgdmlld0VsZW1lbnQgb2YgdGhpcy5lbGVtZW50LmNoaWxkcmVuKSB7XHJcbiAgICAgIGlmICh2aWV3RWxlbWVudC5pdGVtVmlld0RhdGEuaXRlbSA9PT0gc2VsZWN0ZWRJdGVtKSB7XHJcbiAgICAgICAgdmlld0VsZW1lbnQuaXRlbVZpZXdEYXRhLnNlbGVjdCgpXHJcbiAgICAgICAgc2VsZWN0ZWRWaWV3ID0gdmlld0VsZW1lbnRcclxuICAgICAgfSBlbHNlIHZpZXdFbGVtZW50Lml0ZW1WaWV3RGF0YS51bnNlbGVjdCgpXHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2VsZWN0ZWRWaWV3XHJcbiAgfVxyXG5cclxuICBzY3JvbGxUb0l0ZW1WaWV3ICh2aWV3KSB7XHJcbiAgICBjb25zdCBkZXNpcmVkVG9wID0gdmlldy5vZmZzZXRUb3BcclxuICAgIGNvbnN0IGRlc2lyZWRCb3R0b20gPSBkZXNpcmVkVG9wICsgdmlldy5vZmZzZXRIZWlnaHRcclxuXHJcbiAgICBpZiAoZGVzaXJlZFRvcCA8IHRoaXMuZWxlbWVudC5zY3JvbGxUb3ApIHtcclxuICAgICAgdGhpcy5lbGVtZW50LnNjcm9sbFRvcCA9IGRlc2lyZWRUb3BcclxuICAgIH0gZWxzZSBpZiAoZGVzaXJlZEJvdHRvbSA+IHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgKyB0aGlzLmVsZW1lbnQuY2xpZW50SGVpZ2h0KSB7XHJcbiAgICAgIHRoaXMuZWxlbWVudC5zY3JvbGxUb3AgPSBkZXNpcmVkQm90dG9tIC0gdGhpcy5lbGVtZW50LmNsaWVudEhlaWdodFxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYnVpbGRMaXN0VmlldyAoc2VsZWN0ZWRJdGVtKSB7XHJcbiAgICAvKiBNYWtpbmcgdGhpcyBtb3JlIGVmZmljaWVudCwgYW5kIG5vdCBzaW1wbHkgYnVpbGRpbmcgdGhlIHZpZXcgZm9yIHRoZVxyXG4gICAgZW50aXJlIHN0YWNrIGV2ZXJ5IHRpbWUgaXQncyBzaG93biwgaGFzIHNpZ25pZmljYW50IGNvbXBsZXhpdHkgY29zdC5cclxuICAgIFRoZSBwYW5lIHN5c3RlbSBjb21wbGV0ZWx5IG93bnMgdGhlIE1SVSBzdGFjay4gQWRkaW5nIGV2ZW50cyBhbmRcclxuICAgIGhhbmRsZXJzIHRvIGluY3JlbWVudGFsbHkgdXBkYXRlIHRoZSBVSSBoZXJlIHdvdWxkIG1lYW4gdHdvIGNvcGllcyBvZlxyXG4gICAgdGhlIHN0YWNrIHRvIG1haW50YWluIGFuZCBrZWVwIGluIHN5bmMuIExldCdzIHRha2Ugb24gdGhhdCBjb21wbGV4aXR5XHJcbiAgICBvbmx5IGlmIHRoaXMgZXhoaWJpdHMgcmVhbC13b3JsZCBwZXJmb3JtYW5jZSBpc3N1ZXMuICovXHJcbiAgICB3aGlsZSAodGhpcy5lbGVtZW50LmZpcnN0Q2hpbGQpIHRoaXMuZWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZClcclxuXHJcbiAgICBsZXQgc2VsZWN0ZWRWaWV3RWxlbWVudFxyXG4gICAgLyogV2UncmUgaW5zZXJ0aW5nIGVhY2ggaXRlbSBhdCB0aGUgdG9wIHNvIHdlIHRyYXZlcnNlIHRoZSBzdGFjayBmcm9tXHJcbiAgICB0aGUgYm90dG9tLCByZXN1bHRpbmcgaW4gdGhlIG1vc3QgcmVjZW50bHkgdXNlZCBpdGVtIGF0IHRoZSB0b3Agb2YgdGhlXHJcbiAgICBVSS4gKi9cclxuICAgIGZvciAobGV0IGkgPSB0aGlzLnBhbmUuaXRlbVN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XHJcbiAgICAgIGxldCBpdGVtID0gdGhpcy5wYW5lLml0ZW1TdGFja1tpXVxyXG4gICAgICBsZXQgaXRlbVZpZXcgPSBuZXcgTVJVSXRlbVZpZXcoKVxyXG4gICAgICBpdGVtVmlldy5pbml0aWFsaXplKHRoaXMsIGl0ZW0pXHJcbiAgICAgIHRoaXMuZWxlbWVudC5hcHBlbmRDaGlsZChpdGVtVmlldy5lbGVtZW50KVxyXG4gICAgICBpZiAoaXRlbSA9PT0gc2VsZWN0ZWRJdGVtKSB7XHJcbiAgICAgICAgaXRlbVZpZXcuc2VsZWN0KClcclxuICAgICAgICBzZWxlY3RlZFZpZXdFbGVtZW50ID0gaXRlbVZpZXdcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHNlbGVjdGVkVmlld0VsZW1lbnQuZWxlbWVudFxyXG4gIH1cclxuXHJcbn1cclxuIl19