"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = showModal;

var _assert = _interopRequireDefault(require("assert"));

var React = _interopRequireWildcard(require("react"));

var _reactDom = _interopRequireDefault(require("react-dom"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var _TabbableContainer = _interopRequireDefault(require("./TabbableContainer"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */

/* global Node */

/* global HTMLElement */

/**
 * Shows a modal dialog that renders a React element as its content.
 * The modal is automatically hidden when the user clicks outside of it, and on core:cancel (esc).
 * The modal panel unmounts its React component and destroys the panel as soon as it is hidden;
 * you may not hide the panel and then re-show it later.
 * Returns a disposable that you may use to hide and destroy the modal.
 */
function showModal(contentFactory, options = defaults) {
  const hostElement = document.createElement('div');
  const atomPanel = atom.workspace.addModalPanel({
    item: hostElement,
    priority: options.priority,
    className: options.className
  });

  const shouldDismissOnClickOutsideModal = options.shouldDismissOnClickOutsideModal || (() => true);

  const shouldDismissOnPressEscape = options.shouldDismissOnPressEscape || (() => true);

  const element = atomPanel.getElement();
  const previouslyFocusedElement = document.activeElement;
  const disposable = new _UniversalDisposable.default(_rxjsCompatUmdMin.Observable.fromEvent(document, 'mousedown').subscribe(({
    target
  }) => {
    if (!shouldDismissOnClickOutsideModal()) {
      return;
    }

    (0, _assert.default)(target instanceof Node);

    if (!atomPanel.getItem().contains(target) && // don't count clicks on notifications or tooltips as clicks 'outside'
    target.closest('atom-notifications, .tooltip') == null) {
      atomPanel.hide();
    }
  }), atomPanel.onDidChangeVisible(visible => {
    if (!visible) {
      disposable.dispose();
    }
  }), atom.commands.add('body', 'core:cancel', () => {
    if (shouldDismissOnPressEscape()) {
      disposable.dispose();
    }
  }), () => {
    // Call onDismiss before unmounting the component and destroying the panel:
    if (options.onDismiss) {
      options.onDismiss();
    }

    _reactDom.default.unmountComponentAtNode(hostElement);

    atomPanel.destroy();

    if (previouslyFocusedElement != null) {
      previouslyFocusedElement.focus();
    }
  });

  _reactDom.default.render( /*#__PURE__*/React.createElement(ModalContainer, null, contentFactory({
    dismiss: disposable.dispose.bind(disposable),
    element
  })), hostElement, () => {
    if (options.onOpen) {
      options.onOpen();
    }
  });

  return disposable;
}
/** Flow makes {} an unsealed object (eyeroll) */


const defaults = Object.freeze({});

/**
 * Just exists to provide a div that we can focus on mount. This ensures we steal focus from any
 * editors or other panes while the modal is present.
 */
class ModalContainer extends React.Component {
  render() {
    return /*#__PURE__*/React.createElement("div", {
      tabIndex: "-1"
    }, /*#__PURE__*/React.createElement(_TabbableContainer.default, {
      contained: true
    }, this.props.children));
  }

  componentDidMount() {
    const node = _reactDom.default.findDOMNode(this);

    (0, _assert.default)(node instanceof HTMLElement); // Steal the focus away from any active editor or pane, setting it on the modal;
    // but don't steal focus away from a descendant. This can happen if a React element focuses
    // during its componentDidMount. For example, <AtomInput> does this since the underlying
    // <atom-text-editor> does not support the autofocus attribute.

    if (!node.contains(document.activeElement)) {
      node.focus();
    }
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zLXVpL3Nob3dNb2RhbC5qcyJdLCJuYW1lcyI6WyJzaG93TW9kYWwiLCJjb250ZW50RmFjdG9yeSIsIm9wdGlvbnMiLCJkZWZhdWx0cyIsImhvc3RFbGVtZW50IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwiYXRvbVBhbmVsIiwiYXRvbSIsIndvcmtzcGFjZSIsImFkZE1vZGFsUGFuZWwiLCJpdGVtIiwicHJpb3JpdHkiLCJjbGFzc05hbWUiLCJzaG91bGREaXNtaXNzT25DbGlja091dHNpZGVNb2RhbCIsInNob3VsZERpc21pc3NPblByZXNzRXNjYXBlIiwiZWxlbWVudCIsImdldEVsZW1lbnQiLCJwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQiLCJhY3RpdmVFbGVtZW50IiwiZGlzcG9zYWJsZSIsIlVuaXZlcnNhbERpc3Bvc2FibGUiLCJPYnNlcnZhYmxlIiwiZnJvbUV2ZW50Iiwic3Vic2NyaWJlIiwidGFyZ2V0IiwiTm9kZSIsImdldEl0ZW0iLCJjb250YWlucyIsImNsb3Nlc3QiLCJoaWRlIiwib25EaWRDaGFuZ2VWaXNpYmxlIiwidmlzaWJsZSIsImRpc3Bvc2UiLCJjb21tYW5kcyIsImFkZCIsIm9uRGlzbWlzcyIsIlJlYWN0RE9NIiwidW5tb3VudENvbXBvbmVudEF0Tm9kZSIsImRlc3Ryb3kiLCJmb2N1cyIsInJlbmRlciIsImRpc21pc3MiLCJiaW5kIiwib25PcGVuIiwiT2JqZWN0IiwiZnJlZXplIiwiTW9kYWxDb250YWluZXIiLCJSZWFjdCIsIkNvbXBvbmVudCIsInByb3BzIiwiY2hpbGRyZW4iLCJjb21wb25lbnREaWRNb3VudCIsIm5vZGUiLCJmaW5kRE9NTm9kZSIsIkhUTUxFbGVtZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBZUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7Ozs7Ozs7O0FBckJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7O0FBQ0E7O0FBd0NBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ2UsU0FBU0EsU0FBVCxDQUNiQyxjQURhLEVBRWJDLE9BQWdCLEdBQUdDLFFBRk4sRUFHQTtBQUNiLFFBQU1DLFdBQVcsR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLEtBQXZCLENBQXBCO0FBQ0EsUUFBTUMsU0FBUyxHQUFHQyxJQUFJLENBQUNDLFNBQUwsQ0FBZUMsYUFBZixDQUE2QjtBQUM3Q0MsSUFBQUEsSUFBSSxFQUFFUCxXQUR1QztBQUU3Q1EsSUFBQUEsUUFBUSxFQUFFVixPQUFPLENBQUNVLFFBRjJCO0FBRzdDQyxJQUFBQSxTQUFTLEVBQUVYLE9BQU8sQ0FBQ1c7QUFIMEIsR0FBN0IsQ0FBbEI7O0FBS0EsUUFBTUMsZ0NBQWdDLEdBQ3BDWixPQUFPLENBQUNZLGdDQUFSLEtBQTZDLE1BQU0sSUFBbkQsQ0FERjs7QUFFQSxRQUFNQywwQkFBMEIsR0FDOUJiLE9BQU8sQ0FBQ2EsMEJBQVIsS0FBdUMsTUFBTSxJQUE3QyxDQURGOztBQUdBLFFBQU1DLE9BQU8sR0FBR1QsU0FBUyxDQUFDVSxVQUFWLEVBQWhCO0FBQ0EsUUFBTUMsd0JBQXdCLEdBQUdiLFFBQVEsQ0FBQ2MsYUFBMUM7QUFDQSxRQUFNQyxVQUFVLEdBQUcsSUFBSUMsNEJBQUosQ0FDakJDLDZCQUFXQyxTQUFYLENBQXFCbEIsUUFBckIsRUFBK0IsV0FBL0IsRUFBNENtQixTQUE1QyxDQUFzRCxDQUFDO0FBQUNDLElBQUFBO0FBQUQsR0FBRCxLQUFjO0FBQ2xFLFFBQUksQ0FBQ1gsZ0NBQWdDLEVBQXJDLEVBQXlDO0FBQ3ZDO0FBQ0Q7O0FBQ0QseUJBQVVXLE1BQU0sWUFBWUMsSUFBNUI7O0FBQ0EsUUFDRSxDQUFDbkIsU0FBUyxDQUFDb0IsT0FBVixHQUFvQkMsUUFBcEIsQ0FBNkJILE1BQTdCLENBQUQsSUFDQTtBQUNBQSxJQUFBQSxNQUFNLENBQUNJLE9BQVAsQ0FBZSw4QkFBZixLQUFrRCxJQUhwRCxFQUlFO0FBQ0F0QixNQUFBQSxTQUFTLENBQUN1QixJQUFWO0FBQ0Q7QUFDRixHQVpELENBRGlCLEVBY2pCdkIsU0FBUyxDQUFDd0Isa0JBQVYsQ0FBNkJDLE9BQU8sSUFBSTtBQUN0QyxRQUFJLENBQUNBLE9BQUwsRUFBYztBQUNaWixNQUFBQSxVQUFVLENBQUNhLE9BQVg7QUFDRDtBQUNGLEdBSkQsQ0FkaUIsRUFtQmpCekIsSUFBSSxDQUFDMEIsUUFBTCxDQUFjQyxHQUFkLENBQWtCLE1BQWxCLEVBQTBCLGFBQTFCLEVBQXlDLE1BQU07QUFDN0MsUUFBSXBCLDBCQUEwQixFQUE5QixFQUFrQztBQUNoQ0ssTUFBQUEsVUFBVSxDQUFDYSxPQUFYO0FBQ0Q7QUFDRixHQUpELENBbkJpQixFQXdCakIsTUFBTTtBQUNKO0FBQ0EsUUFBSS9CLE9BQU8sQ0FBQ2tDLFNBQVosRUFBdUI7QUFDckJsQyxNQUFBQSxPQUFPLENBQUNrQyxTQUFSO0FBQ0Q7O0FBQ0RDLHNCQUFTQyxzQkFBVCxDQUFnQ2xDLFdBQWhDOztBQUNBRyxJQUFBQSxTQUFTLENBQUNnQyxPQUFWOztBQUNBLFFBQUlyQix3QkFBd0IsSUFBSSxJQUFoQyxFQUFzQztBQUNwQ0EsTUFBQUEsd0JBQXdCLENBQUNzQixLQUF6QjtBQUNEO0FBQ0YsR0FsQ2dCLENBQW5COztBQXFDQUgsb0JBQVNJLE1BQVQsZUFDRSxvQkFBQyxjQUFELFFBQ0d4QyxjQUFjLENBQUM7QUFBQ3lDLElBQUFBLE9BQU8sRUFBRXRCLFVBQVUsQ0FBQ2EsT0FBWCxDQUFtQlUsSUFBbkIsQ0FBd0J2QixVQUF4QixDQUFWO0FBQStDSixJQUFBQTtBQUEvQyxHQUFELENBRGpCLENBREYsRUFJRVosV0FKRixFQUtFLE1BQU07QUFDSixRQUFJRixPQUFPLENBQUMwQyxNQUFaLEVBQW9CO0FBQ2xCMUMsTUFBQUEsT0FBTyxDQUFDMEMsTUFBUjtBQUNEO0FBQ0YsR0FUSDs7QUFZQSxTQUFPeEIsVUFBUDtBQUNEO0FBRUQ7OztBQUNBLE1BQU1qQixRQUFpQixHQUFHMEMsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxDQUExQjs7QUFNQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1DLGNBQU4sU0FBNkJDLEtBQUssQ0FBQ0MsU0FBbkMsQ0FBb0Q7QUFDbERSLEVBQUFBLE1BQU0sR0FBZTtBQUNuQix3QkFDRTtBQUFLLE1BQUEsUUFBUSxFQUFDO0FBQWQsb0JBQ0Usb0JBQUMsMEJBQUQ7QUFBbUIsTUFBQSxTQUFTLEVBQUU7QUFBOUIsT0FDRyxLQUFLUyxLQUFMLENBQVdDLFFBRGQsQ0FERixDQURGO0FBT0Q7O0FBRURDLEVBQUFBLGlCQUFpQixHQUFTO0FBQ3hCLFVBQU1DLElBQUksR0FBR2hCLGtCQUFTaUIsV0FBVCxDQUFxQixJQUFyQixDQUFiOztBQUNBLHlCQUFVRCxJQUFJLFlBQVlFLFdBQTFCLEVBRndCLENBR3hCO0FBQ0E7QUFDQTtBQUNBOztBQUNBLFFBQUksQ0FBQ0YsSUFBSSxDQUFDekIsUUFBTCxDQUFjdkIsUUFBUSxDQUFDYyxhQUF2QixDQUFMLEVBQTRDO0FBQzFDa0MsTUFBQUEsSUFBSSxDQUFDYixLQUFMO0FBQ0Q7QUFDRjs7QUFyQmlEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuLyogZ2xvYmFsIE5vZGUgKi9cclxuLyogZ2xvYmFsIEhUTUxFbGVtZW50ICovXHJcblxyXG5pbXBvcnQgaW52YXJpYW50IGZyb20gJ2Fzc2VydCc7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XHJcbmltcG9ydCB7T2JzZXJ2YWJsZX0gZnJvbSAncnhqcy1jb21wYXQvYnVuZGxlcy9yeGpzLWNvbXBhdC51bWQubWluLmpzJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcblxyXG5pbXBvcnQgVGFiYmFibGVDb250YWluZXIgZnJvbSAnLi9UYWJiYWJsZUNvbnRhaW5lcic7XHJcblxyXG4vKipcclxuICogR2l2ZW4gYSBmdW5jdGlvbiB0byBkaXNtaXNzIHRoZSBtb2RhbCwgcmV0dXJuIGEgUmVhY3QgZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQuXHJcbiAqIENhbGwgdGhlIGZ1bmN0aW9uIHdoZW4gZS5nLiB0aGUgdXNlciBjbGlja3MgYSBDYW5jZWwgb3IgU3VibWl0IGJ1dHRvbi5cclxuICovXHJcbnR5cGUgQ29udGVudEZhY3RvcnkgPSAoe1xyXG4gIGRpc21pc3MoKTogdm9pZCxcclxuICBlbGVtZW50OiBFbGVtZW50LFxyXG59KSA9PiBSZWFjdC5Ob2RlO1xyXG5cclxuLyoqIFdyYXAgb3B0aW9ucyBpbiBhbiBvYmplY3Qgc28gd2UgY2FuIGFkZCBuZXcgb25lcyBsYXRlciB3aXRob3V0IGFuIGV4cGxvc2lvbiBvZiBwYXJhbXMgKi9cclxudHlwZSBPcHRpb25zID0ge3xcclxuICAvKiogQ2FsbGVkIHdoZW4gdGhlIG1vZGFsIGlzIGRpc21pc3NlZCAoanVzdCBiZWZvcmUgaXQgaXMgZGVzdHJveWVkKS4gKi9cclxuICBvbkRpc21pc3M/OiAoKSA9PiBtaXhlZCxcclxuICBvbk9wZW4/OiAoKSA9PiBtaXhlZCxcclxuICAvKipcclxuICAgKiBDYWxsZWQgd2hlbiB0aGUgdXNlciBjbGlja3Mgb3V0c2lkZSB0aGUgbW9kYWwsIHJldHVybiBmYWxzZSB0byBwcmV2ZW50IGRpc21pc3NhbC5cclxuICAgKiBJZiB1bnNwZWNpZmllZCB0aGUgbW9kYWwgd2lsbCBiZSBkaXNtaXNzZWQgaWYgdGhlIHVzZXIgY2xpY2tzIG91dHNpZGUgdGhlIG1vZGFsLlxyXG4gICAqL1xyXG4gIHNob3VsZERpc21pc3NPbkNsaWNrT3V0c2lkZU1vZGFsPzogKCkgPT4gYm9vbGVhbixcclxuICAvKipcclxuICAgKiBDYWxsZWQgd2hlbiB0aGUgdXNlciBwcmVzc2VzIHRoZSBlc2NhcGUga2V5LCByZXR1cm4gZmFsc2UgdG8gcHJldmVudCBkaXNtaXNzYWwuXHJcbiAgICogSWYgdW5zcGVjaWZpZWQgdGhlIG1vZGFsIHdpbGwgYmUgZGlzbWlzc2VkIGlmIHRoZSB1c2VyIHByZXNzZXMgZXNjYXBlLlxyXG4gICAqL1xyXG4gIHNob3VsZERpc21pc3NPblByZXNzRXNjYXBlPzogKCkgPT4gYm9vbGVhbixcclxuICAvKiogUGFzc2VkIHRvIGF0b20ncyB1bmRlcmx5aW5nIGFkZE1vZGFsUGFuZWwgZnVuY3Rpb24uICovXHJcbiAgcHJpb3JpdHk/OiBudW1iZXIsXHJcbiAgLyoqIFBhc3NlZCB0byBhdG9tJ3MgdW5kZXJseWluZyBhZGRNb2RhbFBhbmVsIGZ1bmN0aW9uLiAqL1xyXG4gIGNsYXNzTmFtZT86IHN0cmluZyxcclxufH07XHJcblxyXG4vKipcclxuICogU2hvd3MgYSBtb2RhbCBkaWFsb2cgdGhhdCByZW5kZXJzIGEgUmVhY3QgZWxlbWVudCBhcyBpdHMgY29udGVudC5cclxuICogVGhlIG1vZGFsIGlzIGF1dG9tYXRpY2FsbHkgaGlkZGVuIHdoZW4gdGhlIHVzZXIgY2xpY2tzIG91dHNpZGUgb2YgaXQsIGFuZCBvbiBjb3JlOmNhbmNlbCAoZXNjKS5cclxuICogVGhlIG1vZGFsIHBhbmVsIHVubW91bnRzIGl0cyBSZWFjdCBjb21wb25lbnQgYW5kIGRlc3Ryb3lzIHRoZSBwYW5lbCBhcyBzb29uIGFzIGl0IGlzIGhpZGRlbjtcclxuICogeW91IG1heSBub3QgaGlkZSB0aGUgcGFuZWwgYW5kIHRoZW4gcmUtc2hvdyBpdCBsYXRlci5cclxuICogUmV0dXJucyBhIGRpc3Bvc2FibGUgdGhhdCB5b3UgbWF5IHVzZSB0byBoaWRlIGFuZCBkZXN0cm95IHRoZSBtb2RhbC5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHNob3dNb2RhbChcclxuICBjb250ZW50RmFjdG9yeTogQ29udGVudEZhY3RvcnksXHJcbiAgb3B0aW9uczogT3B0aW9ucyA9IGRlZmF1bHRzLFxyXG4pOiBJRGlzcG9zYWJsZSB7XHJcbiAgY29uc3QgaG9zdEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICBjb25zdCBhdG9tUGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRNb2RhbFBhbmVsKHtcclxuICAgIGl0ZW06IGhvc3RFbGVtZW50LFxyXG4gICAgcHJpb3JpdHk6IG9wdGlvbnMucHJpb3JpdHksXHJcbiAgICBjbGFzc05hbWU6IG9wdGlvbnMuY2xhc3NOYW1lLFxyXG4gIH0pO1xyXG4gIGNvbnN0IHNob3VsZERpc21pc3NPbkNsaWNrT3V0c2lkZU1vZGFsID1cclxuICAgIG9wdGlvbnMuc2hvdWxkRGlzbWlzc09uQ2xpY2tPdXRzaWRlTW9kYWwgfHwgKCgpID0+IHRydWUpO1xyXG4gIGNvbnN0IHNob3VsZERpc21pc3NPblByZXNzRXNjYXBlID1cclxuICAgIG9wdGlvbnMuc2hvdWxkRGlzbWlzc09uUHJlc3NFc2NhcGUgfHwgKCgpID0+IHRydWUpO1xyXG5cclxuICBjb25zdCBlbGVtZW50ID0gYXRvbVBhbmVsLmdldEVsZW1lbnQoKTtcclxuICBjb25zdCBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xyXG4gIGNvbnN0IGRpc3Bvc2FibGUgPSBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZShcclxuICAgIE9ic2VydmFibGUuZnJvbUV2ZW50KGRvY3VtZW50LCAnbW91c2Vkb3duJykuc3Vic2NyaWJlKCh7dGFyZ2V0fSkgPT4ge1xyXG4gICAgICBpZiAoIXNob3VsZERpc21pc3NPbkNsaWNrT3V0c2lkZU1vZGFsKCkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgaW52YXJpYW50KHRhcmdldCBpbnN0YW5jZW9mIE5vZGUpO1xyXG4gICAgICBpZiAoXHJcbiAgICAgICAgIWF0b21QYW5lbC5nZXRJdGVtKCkuY29udGFpbnModGFyZ2V0KSAmJlxyXG4gICAgICAgIC8vIGRvbid0IGNvdW50IGNsaWNrcyBvbiBub3RpZmljYXRpb25zIG9yIHRvb2x0aXBzIGFzIGNsaWNrcyAnb3V0c2lkZSdcclxuICAgICAgICB0YXJnZXQuY2xvc2VzdCgnYXRvbS1ub3RpZmljYXRpb25zLCAudG9vbHRpcCcpID09IG51bGxcclxuICAgICAgKSB7XHJcbiAgICAgICAgYXRvbVBhbmVsLmhpZGUoKTtcclxuICAgICAgfVxyXG4gICAgfSksXHJcbiAgICBhdG9tUGFuZWwub25EaWRDaGFuZ2VWaXNpYmxlKHZpc2libGUgPT4ge1xyXG4gICAgICBpZiAoIXZpc2libGUpIHtcclxuICAgICAgICBkaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICAgICAgfVxyXG4gICAgfSksXHJcbiAgICBhdG9tLmNvbW1hbmRzLmFkZCgnYm9keScsICdjb3JlOmNhbmNlbCcsICgpID0+IHtcclxuICAgICAgaWYgKHNob3VsZERpc21pc3NPblByZXNzRXNjYXBlKCkpIHtcclxuICAgICAgICBkaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICAgICAgfVxyXG4gICAgfSksXHJcbiAgICAoKSA9PiB7XHJcbiAgICAgIC8vIENhbGwgb25EaXNtaXNzIGJlZm9yZSB1bm1vdW50aW5nIHRoZSBjb21wb25lbnQgYW5kIGRlc3Ryb3lpbmcgdGhlIHBhbmVsOlxyXG4gICAgICBpZiAob3B0aW9ucy5vbkRpc21pc3MpIHtcclxuICAgICAgICBvcHRpb25zLm9uRGlzbWlzcygpO1xyXG4gICAgICB9XHJcbiAgICAgIFJlYWN0RE9NLnVubW91bnRDb21wb25lbnRBdE5vZGUoaG9zdEVsZW1lbnQpO1xyXG4gICAgICBhdG9tUGFuZWwuZGVzdHJveSgpO1xyXG4gICAgICBpZiAocHJldmlvdXNseUZvY3VzZWRFbGVtZW50ICE9IG51bGwpIHtcclxuICAgICAgICBwcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgfVxyXG4gICAgfSxcclxuICApO1xyXG5cclxuICBSZWFjdERPTS5yZW5kZXIoXHJcbiAgICA8TW9kYWxDb250YWluZXI+XHJcbiAgICAgIHtjb250ZW50RmFjdG9yeSh7ZGlzbWlzczogZGlzcG9zYWJsZS5kaXNwb3NlLmJpbmQoZGlzcG9zYWJsZSksIGVsZW1lbnR9KX1cclxuICAgIDwvTW9kYWxDb250YWluZXI+LFxyXG4gICAgaG9zdEVsZW1lbnQsXHJcbiAgICAoKSA9PiB7XHJcbiAgICAgIGlmIChvcHRpb25zLm9uT3Blbikge1xyXG4gICAgICAgIG9wdGlvbnMub25PcGVuKCk7XHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgKTtcclxuXHJcbiAgcmV0dXJuIGRpc3Bvc2FibGU7XHJcbn1cclxuXHJcbi8qKiBGbG93IG1ha2VzIHt9IGFuIHVuc2VhbGVkIG9iamVjdCAoZXllcm9sbCkgKi9cclxuY29uc3QgZGVmYXVsdHM6IE9wdGlvbnMgPSBPYmplY3QuZnJlZXplKHt9KTtcclxuXHJcbnR5cGUgUHJvcHMgPSB7XHJcbiAgY2hpbGRyZW4/OiBhbnksXHJcbn07XHJcblxyXG4vKipcclxuICogSnVzdCBleGlzdHMgdG8gcHJvdmlkZSBhIGRpdiB0aGF0IHdlIGNhbiBmb2N1cyBvbiBtb3VudC4gVGhpcyBlbnN1cmVzIHdlIHN0ZWFsIGZvY3VzIGZyb20gYW55XHJcbiAqIGVkaXRvcnMgb3Igb3RoZXIgcGFuZXMgd2hpbGUgdGhlIG1vZGFsIGlzIHByZXNlbnQuXHJcbiAqL1xyXG5jbGFzcyBNb2RhbENvbnRhaW5lciBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxQcm9wcz4ge1xyXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcclxuICAgIHJldHVybiAoXHJcbiAgICAgIDxkaXYgdGFiSW5kZXg9XCItMVwiPlxyXG4gICAgICAgIDxUYWJiYWJsZUNvbnRhaW5lciBjb250YWluZWQ9e3RydWV9PlxyXG4gICAgICAgICAge3RoaXMucHJvcHMuY2hpbGRyZW59XHJcbiAgICAgICAgPC9UYWJiYWJsZUNvbnRhaW5lcj5cclxuICAgICAgPC9kaXY+XHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50RGlkTW91bnQoKTogdm9pZCB7XHJcbiAgICBjb25zdCBub2RlID0gUmVhY3RET00uZmluZERPTU5vZGUodGhpcyk7XHJcbiAgICBpbnZhcmlhbnQobm9kZSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KTtcclxuICAgIC8vIFN0ZWFsIHRoZSBmb2N1cyBhd2F5IGZyb20gYW55IGFjdGl2ZSBlZGl0b3Igb3IgcGFuZSwgc2V0dGluZyBpdCBvbiB0aGUgbW9kYWw7XHJcbiAgICAvLyBidXQgZG9uJ3Qgc3RlYWwgZm9jdXMgYXdheSBmcm9tIGEgZGVzY2VuZGFudC4gVGhpcyBjYW4gaGFwcGVuIGlmIGEgUmVhY3QgZWxlbWVudCBmb2N1c2VzXHJcbiAgICAvLyBkdXJpbmcgaXRzIGNvbXBvbmVudERpZE1vdW50LiBGb3IgZXhhbXBsZSwgPEF0b21JbnB1dD4gZG9lcyB0aGlzIHNpbmNlIHRoZSB1bmRlcmx5aW5nXHJcbiAgICAvLyA8YXRvbS10ZXh0LWVkaXRvcj4gZG9lcyBub3Qgc3VwcG9ydCB0aGUgYXV0b2ZvY3VzIGF0dHJpYnV0ZS5cclxuICAgIGlmICghbm9kZS5jb250YWlucyhkb2N1bWVudC5hY3RpdmVFbGVtZW50KSkge1xyXG4gICAgICBub2RlLmZvY3VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==