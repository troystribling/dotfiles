"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ConfigCache = void 0;

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _collection = require("./collection");

var _fsPromise = _interopRequireDefault(require("./fsPromise"));

var _nuclideUri = _interopRequireDefault(require("./nuclideUri"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
class ConfigCache {
  constructor(configPatterns, searchStrategy = 'nearest') {
    this._configPatterns = void 0;
    this._searchStrategy = void 0;
    this._configCache = void 0;
    this._configPatterns = configPatterns;
    this._searchStrategy = searchStrategy;
    this._configCache = (0, _lruCache.default)({
      max: 200,
      // Want this to exceed the maximum expected number of open files + dirs.
      maxAge: 1000 * 30 // 30 seconds

    });
  }

  getConfigDir(path) {
    let result = this._configCache.get(path);

    if (result == null) {
      result = this._findConfigDir(path);

      this._configCache.set(path, result);
    }

    return result;
  }

  async _findConfigDir(path) {
    if (this._searchStrategy === 'eclipse') {
      const configDirs = await Promise.all(this._configPatterns.map(configFile => _fsPromise.default.findFurthestFile(configFile, path)));
      return configDirs.filter(Boolean).reduce((previous, configDir) => {
        if (previous == null || configDir.length < previous.length) {
          return configDir;
        }

        return previous;
      }, null);
    } else if (this._searchStrategy === 'thrift') {
      // Find the first occurrence of a config segment in the path.
      const pathSplit = _nuclideUri.default.split(path);

      return this._configPatterns.map(configPattern => {
        const configSplit = _nuclideUri.default.split(configPattern);

        const foundIndex = (0, _collection.findSubArrayIndex)(pathSplit, configSplit);
        return foundIndex !== -1 ? _nuclideUri.default.join(...pathSplit.slice(0, foundIndex + configSplit.length)) : null;
      }).find(Boolean);
    } else if (this._searchStrategy === 'ocaml') {
      // ocaml-language-server (the LSP server) is the same single LSP server binary
      // for all ocaml projects and for all versions of merlin.
      //
      // It uses initializationOptions.path.ocamlmerlin from the initialize request
      // (or just the string "ocamlmerlin" if that was absent) to determine what
      // command to use for spawning merlin. (merlin itself has no notion of project root).
      //
      // It also uses projectRoot, but solely to customize which merlin binary to launch:
      // if it finds projectRoot/node_modules/.cache/_esy/build/bin/command-exec[.bat]
      // then it will launch "command-exec <ocamlmerlin>"; otherwise it just launches <ocamlmerlin>
      // using projectRoot as the current working directory.
      //
      // Therefore: to find project root for a given file, we'll either use the nearest
      // containing parent such that directory parent/node_modules/.cache/_esy/build/bin exists,
      // or "/" otherwise.
      let dir = _nuclideUri.default.dirname(path);

      while (true) {
        const wrapper = _nuclideUri.default.join(dir, 'node_modules', '.cache', '_esy', 'build', 'bin'); // eslint-disable-next-line no-await-in-loop


        if (await _fsPromise.default.exists(wrapper)) {
          return dir;
        } else if (_nuclideUri.default.isRoot(dir)) {
          return dir;
        } else {
          dir = _nuclideUri.default.dirname(dir);
        }
      }
    } else if (this._searchStrategy === 'aurora') {
      const candidateDir = await _fsPromise.default.findNearestFile('.hhconfig', path);

      if (candidateDir != null && (await _fsPromise.default.exists(_nuclideUri.default.join(candidateDir, '.arcconfig')))) {
        return candidateDir;
      }

      return null;
    } else {
      this._searchStrategy; // Find the result with the greatest length (the closest match).

      const configDirs = await Promise.all(this._configPatterns.map(configFile => _fsPromise.default.findNearestFile(configFile, path)));
      return configDirs.filter(Boolean).reduce((previous, configDir) => {
        if (previous == null || configDir.length > previous.length) {
          return configDir;
        }

        return previous;
      }, null);
    }
  }

  dispose() {
    this._configCache.reset();
  }

}

exports.ConfigCache = ConfigCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL0NvbmZpZ0NhY2hlLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ0NhY2hlIiwiY29uc3RydWN0b3IiLCJjb25maWdQYXR0ZXJucyIsInNlYXJjaFN0cmF0ZWd5IiwiX2NvbmZpZ1BhdHRlcm5zIiwiX3NlYXJjaFN0cmF0ZWd5IiwiX2NvbmZpZ0NhY2hlIiwibWF4IiwibWF4QWdlIiwiZ2V0Q29uZmlnRGlyIiwicGF0aCIsInJlc3VsdCIsImdldCIsIl9maW5kQ29uZmlnRGlyIiwic2V0IiwiY29uZmlnRGlycyIsIlByb21pc2UiLCJhbGwiLCJtYXAiLCJjb25maWdGaWxlIiwiZnNQcm9taXNlIiwiZmluZEZ1cnRoZXN0RmlsZSIsImZpbHRlciIsIkJvb2xlYW4iLCJyZWR1Y2UiLCJwcmV2aW91cyIsImNvbmZpZ0RpciIsImxlbmd0aCIsInBhdGhTcGxpdCIsIm51Y2xpZGVVcmkiLCJzcGxpdCIsImNvbmZpZ1BhdHRlcm4iLCJjb25maWdTcGxpdCIsImZvdW5kSW5kZXgiLCJqb2luIiwic2xpY2UiLCJmaW5kIiwiZGlyIiwiZGlybmFtZSIsIndyYXBwZXIiLCJleGlzdHMiLCJpc1Jvb3QiLCJjYW5kaWRhdGVEaXIiLCJmaW5kTmVhcmVzdEZpbGUiLCJkaXNwb3NlIiwicmVzZXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFlQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQWxCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBaUJPLE1BQU1BLFdBQU4sQ0FBa0I7QUFLdkJDLEVBQUFBLFdBQVcsQ0FDVEMsY0FEUyxFQUVUQyxjQUErQixHQUFHLFNBRnpCLEVBR1Q7QUFBQSxTQVBGQyxlQU9FO0FBQUEsU0FORkMsZUFNRTtBQUFBLFNBTEZDLFlBS0U7QUFDQSxTQUFLRixlQUFMLEdBQXVCRixjQUF2QjtBQUNBLFNBQUtHLGVBQUwsR0FBdUJGLGNBQXZCO0FBQ0EsU0FBS0cs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RCxHQUFuQixDQUFOO0FBQ0Q7QUFDRjtBQUNGLEtBcENNLE1Bb0NBLElBQUksS0FBS2hDLGVBQUwsS0FBeUIsUUFBN0IsRUFBdUM7QUFDNUMsWUFBTXFDLFlBQVksR0FBRyxNQUFNdEIsbUJBQVV1QixlQUFWLENBQTBCLFdBQTFCLEVBQXVDakMsSUFBdkMsQ0FBM0I7O0FBQ0EsVUFDRWdDLFlBQVksSUFBSSxJQUFoQixLQUNDLE1BQU10QixtQkFBVW9CLE1BQVYsQ0FBaUJYLG9CQUFXSyxJQUFYLENBQWdCUSxZQUFoQixFQUE4QixZQUE5QixDQUFqQixDQURQLENBREYsRUFHRTtBQUNBLGVBQU9BLFlBQVA7QUFDRDs7QUFDRCxhQUFPLElBQVA7QUFDRCxLQVRNLE1BU0E7QUFDSixXQUFLckMsZUFBTixDQURLLENBRUw7O0FBQ0EsWUFBTVUsVUFBVSxHQUFHLE1BQU1DLE9BQU8sQ0FBQ0MsR0FBUixDQUN2QixLQUFLYixlQUFMLENBQXFCYyxHQUFyQixDQUF5QkMsVUFBVSxJQUNqQ0MsbUJBQVV1QixlQUFWLENBQTBCeEIsVUFBMUIsRUFBc0NULElBQXRDLENBREYsQ0FEdUIsQ0FBekI7QUFLQSxhQUFPSyxVQUFVLENBQUNPLE1BQVgsQ0FBa0JDLE9BQWxCLEVBQTJCQyxNQUEzQixDQUFrQyxDQUFDQyxRQUFELEVBQVdDLFNBQVgsS0FBeUI7QUFDaEUsWUFBSUQsUUFBUSxJQUFJLElBQVosSUFBb0JDLFNBQVMsQ0FBQ0MsTUFBVixHQUFtQkYsUUFBUSxDQUFDRSxNQUFwRCxFQUE0RDtBQUMxRCxpQkFBT0QsU0FBUDtBQUNEOztBQUNELGVBQU9ELFFBQVA7QUFDRCxPQUxNLEVBS0osSUFMSSxDQUFQO0FBTUQ7QUFDRjs7QUFFRG1CLEVBQUFBLE9BQU8sR0FBUztBQUNkLFNBQUt0QyxZQUFMLENBQWtCdUMsS0FBbEI7QUFDRDs7QUFySHNCIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvdyBzdHJpY3QtbG9jYWxcclxuICogQGZvcm1hdFxyXG4gKi9cclxuXHJcbmltcG9ydCB0eXBlIHtMUlVDYWNoZX0gZnJvbSAnbHJ1LWNhY2hlJztcclxuaW1wb3J0IHR5cGUge051Y2xpZGVVcml9IGZyb20gJy4vbnVjbGlkZVVyaSc7XHJcblxyXG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XHJcbmltcG9ydCB7ZmluZFN1YkFycmF5SW5kZXh9IGZyb20gJy4vY29sbGVjdGlvbic7XHJcbmltcG9ydCBmc1Byb21pc2UgZnJvbSAnLi9mc1Byb21pc2UnO1xyXG5pbXBvcnQgbnVjbGlkZVVyaSBmcm9tICcuL251Y2xpZGVVcmknO1xyXG5cclxuZXhwb3J0IHR5cGUgU2VhcmNoU3RyYXRlZ3kgPVxyXG4gIHwgJ25lYXJlc3QnXHJcbiAgfCAnYXVyb3JhJ1xyXG4gIHwgJ2VjbGlwc2UnXHJcbiAgfCAnb2NhbWwnXHJcbiAgfCAndGhyaWZ0JztcclxuXHJcbmV4cG9ydCBjbGFzcyBDb25maWdDYWNoZSB7XHJcbiAgX2NvbmZpZ1BhdHRlcm5zOiBBcnJheTxzdHJpbmc+O1xyXG4gIF9zZWFyY2hTdHJhdGVneTogU2VhcmNoU3RyYXRlZ3k7XHJcbiAgX2NvbmZpZ0NhY2hlOiBMUlVDYWNoZTxOdWNsaWRlVXJpLCBQcm9taXNlPD9OdWNsaWRlVXJpPj47XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgY29uZmlnUGF0dGVybnM6IEFycmF5PHN0cmluZz4sXHJcbiAgICBzZWFyY2hTdHJhdGVneT86IFNlYXJjaFN0cmF0ZWd5ID0gJ25lYXJlc3QnLFxyXG4gICkge1xyXG4gICAgdGhpcy5fY29uZmlnUGF0dGVybnMgPSBjb25maWdQYXR0ZXJucztcclxuICAgIHRoaXMuX3NlYXJjaFN0cmF0ZWd5ID0gc2VhcmNoU3RyYXRlZ3k7XHJcbiAgICB0aGlzLl9jb25maWdDYWNoZSA9IExSVSh7XHJcbiAgICAgIG1heDogMjAwLCAvLyBXYW50IHRoaXMgdG8gZXhjZWVkIHRoZSBtYXhpbXVtIGV4cGVjdGVkIG51bWJlciBvZiBvcGVuIGZpbGVzICsgZGlycy5cclxuICAgICAgbWF4QWdlOiAxMDAwICogMzAsIC8vIDMwIHNlY29uZHNcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgZ2V0Q29uZmlnRGlyKHBhdGg6IE51Y2xpZGVVcmkpOiBQcm9taXNlPD9OdWNsaWRlVXJpPiB7XHJcbiAgICBsZXQgcmVzdWx0ID0gdGhpcy5fY29uZmlnQ2FjaGUuZ2V0KHBhdGgpO1xyXG4gICAgaWYgKHJlc3VsdCA9PSBudWxsKSB7XHJcbiAgICAgIHJlc3VsdCA9IHRoaXMuX2ZpbmRDb25maWdEaXIocGF0aCk7XHJcbiAgICAgIHRoaXMuX2NvbmZpZ0NhY2hlLnNldChwYXRoLCByZXN1bHQpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIGFzeW5jIF9maW5kQ29uZmlnRGlyKHBhdGg6IE51Y2xpZGVVcmkpOiBQcm9taXNlPD9OdWNsaWRlVXJpPiB7XHJcbiAgICBpZiAodGhpcy5fc2VhcmNoU3RyYXRlZ3kgPT09ICdlY2xpcHNlJykge1xyXG4gICAgICBjb25zdCBjb25maWdEaXJzID0gYXdhaXQgUHJvbWlzZS5hbGwoXHJcbiAgICAgICAgdGhpcy5fY29uZmlnUGF0dGVybnMubWFwKGNvbmZpZ0ZpbGUgPT5cclxuICAgICAgICAgIGZzUHJvbWlzZS5maW5kRnVydGhlc3RGaWxlKGNvbmZpZ0ZpbGUsIHBhdGgpLFxyXG4gICAgICAgICksXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybiBjb25maWdEaXJzLmZpbHRlcihCb29sZWFuKS5yZWR1Y2UoKHByZXZpb3VzLCBjb25maWdEaXIpID0+IHtcclxuICAgICAgICBpZiAocHJldmlvdXMgPT0gbnVsbCB8fCBjb25maWdEaXIubGVuZ3RoIDwgcHJldmlvdXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXR1cm4gY29uZmlnRGlyO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJldmlvdXM7XHJcbiAgICAgIH0sIG51bGwpO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLl9zZWFyY2hTdHJhdGVneSA9PT0gJ3RocmlmdCcpIHtcclxuICAgICAgLy8gRmluZCB0aGUgZmlyc3Qgb2NjdXJyZW5jZSBvZiBhIGNvbmZpZyBzZWdtZW50IGluIHRoZSBwYXRoLlxyXG4gICAgICBjb25zdCBwYXRoU3BsaXQgPSBudWNsaWRlVXJpLnNwbGl0KHBhdGgpO1xyXG4gICAgICByZXR1cm4gdGhpcy5fY29uZmlnUGF0dGVybnNcclxuICAgICAgICAubWFwKGNvbmZpZ1BhdHRlcm4gPT4ge1xyXG4gICAgICAgICAgY29uc3QgY29uZmlnU3BsaXQgPSBudWNsaWRlVXJpLnNwbGl0KGNvbmZpZ1BhdHRlcm4pO1xyXG4gICAgICAgICAgY29uc3QgZm91bmRJbmRleCA9IGZpbmRTdWJBcnJheUluZGV4KHBhdGhTcGxpdCwgY29uZmlnU3BsaXQpO1xyXG4gICAgICAgICAgcmV0dXJuIGZvdW5kSW5kZXggIT09IC0xXHJcbiAgICAgICAgICAgID8gbnVjbGlkZVVyaS5qb2luKFxyXG4gICAgICAgICAgICAgICAgLi4ucGF0aFNwbGl0LnNsaWNlKDAsIGZvdW5kSW5kZXggKyBjb25maWdTcGxpdC5sZW5ndGgpLFxyXG4gICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgOiBudWxsO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmZpbmQoQm9vbGVhbik7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3NlYXJjaFN0cmF0ZWd5ID09PSAnb2NhbWwnKSB7XHJcbiAgICAgIC8vIG9jYW1sLWxhbmd1YWdlLXNlcnZlciAodGhlIExTUCBzZXJ2ZXIpIGlzIHRoZSBzYW1lIHNpbmdsZSBMU1Agc2VydmVyIGJpbmFyeVxyXG4gICAgICAvLyBmb3IgYWxsIG9jYW1sIHByb2plY3RzIGFuZCBmb3IgYWxsIHZlcnNpb25zIG9mIG1lcmxpbi5cclxuICAgICAgLy9cclxuICAgICAgLy8gSXQgdXNlcyBpbml0aWFsaXphdGlvbk9wdGlvbnMucGF0aC5vY2FtbG1lcmxpbiBmcm9tIHRoZSBpbml0aWFsaXplIHJlcXVlc3RcclxuICAgICAgLy8gKG9yIGp1c3QgdGhlIHN0cmluZyBcIm9jYW1sbWVybGluXCIgaWYgdGhhdCB3YXMgYWJzZW50KSB0byBkZXRlcm1pbmUgd2hhdFxyXG4gICAgICAvLyBjb21tYW5kIHRvIHVzZSBmb3Igc3Bhd25pbmcgbWVybGluLiAobWVybGluIGl0c2VsZiBoYXMgbm8gbm90aW9uIG9mIHByb2plY3Qgcm9vdCkuXHJcbiAgICAgIC8vXHJcbiAgICAgIC8vIEl0IGFsc28gdXNlcyBwcm9qZWN0Um9vdCwgYnV0IHNvbGVseSB0byBjdXN0b21pemUgd2hpY2ggbWVybGluIGJpbmFyeSB0byBsYXVuY2g6XHJcbiAgICAgIC8vIGlmIGl0IGZpbmRzIHByb2plY3RSb290L25vZGVfbW9kdWxlcy8uY2FjaGUvX2VzeS9idWlsZC9iaW4vY29tbWFuZC1leGVjWy5iYXRdXHJcbiAgICAgIC8vIHRoZW4gaXQgd2lsbCBsYXVuY2ggXCJjb21tYW5kLWV4ZWMgPG9jYW1sbWVybGluPlwiOyBvdGhlcndpc2UgaXQganVzdCBsYXVuY2hlcyA8b2NhbWxtZXJsaW4+XHJcbiAgICAgIC8vIHVzaW5nIHByb2plY3RSb290IGFzIHRoZSBjdXJyZW50IHdvcmtpbmcgZGlyZWN0b3J5LlxyXG4gICAgICAvL1xyXG4gICAgICAvLyBUaGVyZWZvcmU6IHRvIGZpbmQgcHJvamVjdCByb290IGZvciBhIGdpdmVuIGZpbGUsIHdlJ2xsIGVpdGhlciB1c2UgdGhlIG5lYXJlc3RcclxuICAgICAgLy8gY29udGFpbmluZyBwYXJlbnQgc3VjaCB0aGF0IGRpcmVjdG9yeSBwYXJlbnQvbm9kZV9tb2R1bGVzLy5jYWNoZS9fZXN5L2J1aWxkL2JpbiBleGlzdHMsXHJcbiAgICAgIC8vIG9yIFwiL1wiIG90aGVyd2lzZS5cclxuXHJcbiAgICAgIGxldCBkaXIgPSBudWNsaWRlVXJpLmRpcm5hbWUocGF0aCk7XHJcbiAgICAgIHdoaWxlICh0cnVlKSB7XHJcbiAgICAgICAgY29uc3Qgd3JhcHBlciA9IG51Y2xpZGVVcmkuam9pbihcclxuICAgICAgICAgIGRpcixcclxuICAgICAgICAgICdub2RlX21vZHVsZXMnLFxyXG4gICAgICAgICAgJy5jYWNoZScsXHJcbiAgICAgICAgICAnX2VzeScsXHJcbiAgICAgICAgICAnYnVpbGQnLFxyXG4gICAgICAgICAgJ2JpbicsXHJcbiAgICAgICAgKTtcclxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tYXdhaXQtaW4tbG9vcFxyXG4gICAgICAgIGlmIChhd2FpdCBmc1Byb21pc2UuZXhpc3RzKHdyYXBwZXIpKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGlyO1xyXG4gICAgICAgIH0gZWxzZSBpZiAobnVjbGlkZVVyaS5pc1Jvb3QoZGlyKSkge1xyXG4gICAgICAgICAgcmV0dXJuIGRpcjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgZGlyID0gbnVjbGlkZVVyaS5kaXJuYW1lKGRpcik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuX3NlYXJjaFN0cmF0ZWd5ID09PSAnYXVyb3JhJykge1xyXG4gICAgICBjb25zdCBjYW5kaWRhdGVEaXIgPSBhd2FpdCBmc1Byb21pc2UuZmluZE5lYXJlc3RGaWxlKCcuaGhjb25maWcnLCBwYXRoKTtcclxuICAgICAgaWYgKFxyXG4gICAgICAgIGNhbmRpZGF0ZURpciAhPSBudWxsICYmXHJcbiAgICAgICAgKGF3YWl0IGZzUHJvbWlzZS5leGlzdHMobnVjbGlkZVVyaS5qb2luKGNhbmRpZGF0ZURpciwgJy5hcmNjb25maWcnKSkpXHJcbiAgICAgICkge1xyXG4gICAgICAgIHJldHVybiBjYW5kaWRhdGVEaXI7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAodGhpcy5fc2VhcmNoU3RyYXRlZ3k6ICduZWFyZXN0Jyk7XHJcbiAgICAgIC8vIEZpbmQgdGhlIHJlc3VsdCB3aXRoIHRoZSBncmVhdGVzdCBsZW5ndGggKHRoZSBjbG9zZXN0IG1hdGNoKS5cclxuICAgICAgY29uc3QgY29uZmlnRGlycyA9IGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgICAgIHRoaXMuX2NvbmZpZ1BhdHRlcm5zLm1hcChjb25maWdGaWxlID0+XHJcbiAgICAgICAgICBmc1Byb21pc2UuZmluZE5lYXJlc3RGaWxlKGNvbmZpZ0ZpbGUsIHBhdGgpLFxyXG4gICAgICAgICksXHJcbiAgICAgICk7XHJcbiAgICAgIHJldHVybiBjb25maWdEaXJzLmZpbHRlcihCb29sZWFuKS5yZWR1Y2UoKHByZXZpb3VzLCBjb25maWdEaXIpID0+IHtcclxuICAgICAgICBpZiAocHJldmlvdXMgPT0gbnVsbCB8fCBjb25maWdEaXIubGVuZ3RoID4gcHJldmlvdXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICByZXR1cm4gY29uZmlnRGlyO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcHJldmlvdXM7XHJcbiAgICAgIH0sIG51bGwpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2NvbmZpZ0NhY2hlLnJlc2V0KCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==