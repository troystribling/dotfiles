"use strict";

/**
Modified from https://github.com/substack/node-shell-quote/commit/72fb5a8.
Includes https://github.com/substack/node-shell-quote/pull/29, with minor
modifications to remove the unnecessary Array polyfills.

Use the typed wrappers in ./string.js to access these functions.

The MIT License

Copyright (c) 2013 James Halliday (mail@substack.net)

Permission is hereby granted, free of charge,
to any person obtaining a copy of this software and
associated documentation files (the "Software"), to
deal in the Software without restriction, including
without limitation the rights to use, copy, modify,
merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom
the Software is furnished to do so,
subject to the following conditions:

The above copyright notice and this permission notice
shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR
ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.


*/

/* eslint-disable */
exports.quote = function (xs) {
  return xs.map(function (s) {
    if (s && typeof s === 'object') {
      return s.op.replace(/(.)/g, '\\$1');
    } else if (/["\s]/.test(s) && !/'/.test(s)) {
      return "'" + s.replace(/(['\\])/g, '\\$1') + "'";
    } else if (/["'\s]/.test(s)) {
      return '"' + s.replace(/(["\\$`!])/g, '\\$1') + '"';
    } else {
      return String(s).replace(/([#!"$&'()*,:;<=>?@\[\\\]^`{|}])/g, '\\$1');
    }
  }).join(' ');
};

var CONTROL = '(?:' + ['\\|\\|', '\\&\\&', ';;', '\\|\\&', '[&;()|<>]'].join('|') + ')';
var META = '|&;()<> \\t';
var BAREWORD = '(\\\\[\'"' + META + ']|[^\\s\'"' + META + '])+';
var SINGLE_QUOTE = '"((\\\\"|[^"])*?)"';
var DOUBLE_QUOTE = '\'((\\\\\'|[^\'])*?)\'';
var TOKEN = '';

for (var i = 0; i < 4; i++) {
  TOKEN += (Math.pow(16, 8) * Math.random()).toString(16);
}

exports.parse = function (s, env, opts) {
  var mapped = parse(s, env, opts);
  if (typeof env !== 'function') return mapped;
  return mapped.reduce(function (acc, s) {
    if (typeof s === 'object') return acc.concat(s);
    var xs = s.split(RegExp('(' + TOKEN + '.*?' + TOKEN + ')', 'g'));
    if (xs.length === 1) return acc.concat(xs[0]);
    return acc.concat(xs.filter(Boolean).map(function (x) {
      if (RegExp('^' + TOKEN).test(x)) {
        return JSON.parse(x.split(TOKEN)[1]);
      } else return x;
    }));
  }, []);
};

function parse(s, env, opts) {
  var chunker = new RegExp(['(' + CONTROL + ')', // control chars
  '(' + BAREWORD + '|' + SINGLE_QUOTE + '|' + DOUBLE_QUOTE + ')*'].join('|'), 'g');
  var match = s.match(chunker).filter(Boolean);
  var commented = false;
  if (!match) return [];
  if (!env) env = {};
  if (!opts) opts = {};
  return match.map(function (s, j) {
    if (commented) {
      return;
    }

    if (s.charAt(0) === '#') {
      commented = true;
      return {
        comment: s.substr(1) + match.slice(j + 1).join(' ')
      };
    }

    if (RegExp('^' + CONTROL + '$').test(s)) {
      return {
        op: s
      };
    } // Hand-written scanner/parser for Bash quoting rules:
    //
    //  1. inside single quotes, all characters are printed literally.
    //  2. inside double quotes, all characters are printed literally
    //     except variables prefixed by '$' and backslashes followed by
    //     either a double quote or another backslash.
    //  3. outside of any quotes, backslashes are treated as escape
    //     characters and not printed (unless they are themselves escaped)
    //  4. quote context can switch mid-token if there is no whitespace
    //     between the two quote contexts (e.g. all'one'"token" parses as
    //     "allonetoken")


    var SQ = "'";
    var DQ = '"';
    var DS = '$';
    var BS = opts.escape || '\\';
    var quote = false;
    var esc = false;
    var out = '';
    var isGlob = false;

    for (var i = 0, len = s.length; i < len; i++) {
      var c = s.charAt(i);
      isGlob = isGlob || !quote && (c === '*' || c === '?');

      if (esc) {
        out += c;
        esc = false;
      } else if (quote) {
        if (c === quote) {
          quote = false;
        } else if (quote == SQ) {
          out += c;
        } else {
          // Double quote
          if (c === BS) {
            i += 1;
            c = s.charAt(i);

            if (c === DQ || c === BS || c === DS) {
              out += c;
            } else {
              out += BS + c;
            }
          } else if (c === DS) {
            out += parseEnvVar();
          } else {
            out += c;
          }
        }
      } else if (c === DQ || c === SQ) {
        quote = c;
      } else if (RegExp('^' + CONTROL + '$').test(c)) {
        return {
          op: s
        };
      } else if (c === BS) {
        esc = true;
      } else if (c === DS) {
        out += parseEnvVar();
      } else out += c;
    }

    if (isGlob) return {
      op: 'glob',
      pattern: out
    };
    return out;

    function parseEnvVar() {
      i += 1;
      var varend, varname; //debugger

      if (s.charAt(i) === '{') {
        i += 1;

        if (s.charAt(i) === '}') {
          throw new Error("Bad substitution: " + s.substr(i - 2, 3));
        }

        varend = s.indexOf('}', i);

        if (varend < 0) {
          throw new Error("Bad substitution: " + s.substr(i));
        }

        varname = s.substr(i, varend - i);
        i = varend;
      } else if (/[*@#?$!_\-]/.test(s.charAt(i))) {
        varname = s.charAt(i);
        i += 1;
      } else {
        varend = s.substr(i).match(/[^\w\d_]/);

        if (!varend) {
          varname = s.substr(i);
          i = s.length;
        } else {
          varname = s.substr(i, varend.index);
          i += varend.index - 1;
        }
      }

      return getVar(null, '', varname);
    }
  }) // finalize parsed aruments
  .reduce(function (prev, arg) {
    if (arg === undefined) {
      return prev;
    }

    return prev.concat(arg);
  }, []);

  function getVar(_, pre, key) {
    var r = typeof env === 'function' ? env(key) : env[key];
    if (r === undefined) r = '';

    if (typeof r === 'object') {
      return pre + TOKEN + JSON.stringify(r) + TOKEN;
    } else return pre + r;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL19zaGVsbC1xdW90ZS5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwicXVvdGUiLCJ4cyIsIm1hcCIsInMiLCJvcCIsInJlcGxhY2UiLCJ0ZXN0IiwiU3RyaW5nIiwiam9pbiIsIkNPTlRST0wiLCJNRVRBIiwiQkFSRVdPUkQiLCJTSU5HTEVfUVVPVEUiLCJET1VCTEVfUVVPVEUiLCJUT0tFTiIsImkiLCJNYXRoIiwicG93IiwicmFuZG9tIiwidG9TdHJpbmciLCJwYXJzZSIsImVudiIsIm9wdHMiLCJtYXBwZWQiLCJyZWR1Y2UiLCJhY2MiLCJjb25jYXQiLCJzcGxpdCIsIlJlZ0V4cCIsImxlbmd0aCIsImZpbHRlciIsIkJvb2xlYW4iLCJ4IiwiSlNPTiIsImNodW5rZXIiLCJtYXRjaCIsImNvbW1lbnRlZCIsImoiLCJjaGFyQXQiLCJjb21tZW50Iiwic3Vic3RyIiwic2xpY2UiLCJTUSIsIkRRIiwiRFMiLCJCUyIsImVzY2FwZSIsImVzYyIsIm91dCIsImlzR2xvYiIsImxlbiIsImMiLCJwYXJzZUVudlZhciIsInBhdHRlcm4iLCJ2YXJlbmQiLCJ2YXJuYW1lIiwiRXJyb3IiLCJpbmRleE9mIiwiaW5kZXgiLCJnZXRWYXIiLCJwcmV2IiwiYXJnIiwidW5kZWZpbmVkIiwiXyIsInByZSIsImtleSIsInIiLCJzdHJpbmdpZnkiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUE7QUFFQUEsT0FBTyxDQUFDQyxLQUFSLEdBQWdCLFVBQVVDLEVBQVYsRUFBYztBQUMxQixTQUFPQSxFQUFFLENBQUNDLEdBQUgsQ0FBTyxV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dUM1QyxHQUFHLENBQUM0QyxHQUFELENBQWxEO0FBQ0EsUUFBSUMsQ0FBQyxLQUFLSixTQUFWLEVBQXFCSSxDQUFDLEdBQUcsRUFBSjs7QUFFckIsUUFBSSxPQUFPQSxDQUFQLEtBQWEsUUFBakIsRUFBMkI7QUFDdkIsYUFBT0YsR0FBRyxHQUFHbEQsS0FBTixHQUFjbUIsSUFBSSxDQUFDa0MsU0FBTCxDQUFlRCxDQUFmLENBQWQsR0FBa0NwRCxLQUF6QztBQUNILEtBRkQsTUFHSyxPQUFPa0QsR0FBRyxHQUFHRSxDQUFiO0FBQ1I7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG5Nb2RpZmllZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9zdWJzdGFjay9ub2RlLXNoZWxsLXF1b3RlL2NvbW1pdC83MmZiNWE4LlxyXG5JbmNsdWRlcyBodHRwczovL2dpdGh1Yi5jb20vc3Vic3RhY2svbm9kZS1zaGVsbC1xdW90ZS9wdWxsLzI5LCB3aXRoIG1pbm9yXHJcbm1vZGlmaWNhdGlvbnMgdG8gcmVtb3ZlIHRoZSB1bm5lY2Vzc2FyeSBBcnJheSBwb2x5ZmlsbHMuXHJcblxyXG5Vc2UgdGhlIHR5cGVkIHdyYXBwZXJzIGluIC4vc3RyaW5nLmpzIHRvIGFjY2VzcyB0aGVzZSBmdW5jdGlvbnMuXHJcblxyXG5UaGUgTUlUIExpY2Vuc2VcclxuXHJcbkNvcHlyaWdodCAoYykgMjAxMyBKYW1lcyBIYWxsaWRheSAobWFpbEBzdWJzdGFjay5uZXQpXHJcblxyXG5QZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSxcclxudG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kXHJcbmFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvXHJcbmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZ1xyXG53aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSxcclxubWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXHJcbmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tXHJcbnRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sXHJcbnN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxyXG5cclxuVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Vcclxuc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXHJcblxyXG5USEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELFxyXG5FWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVNcclxuT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULlxyXG5JTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SXHJcbkFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULFxyXG5UT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRVxyXG5TT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRS5cclxuXHJcbkBub2Zsb3dcclxuKi9cclxuXHJcbi8qIGVzbGludC1kaXNhYmxlICovXHJcblxyXG5leHBvcnRzLnF1b3RlID0gZnVuY3Rpb24gKHhzKSB7XHJcbiAgICByZXR1cm4geHMubWFwKGZ1bmN0aW9uIChzKSB7XHJcbiAgICAgICAgaWYgKHMgJiYgdHlwZW9mIHMgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBzLm9wLnJlcGxhY2UoLyguKS9nLCAnXFxcXCQxJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgaWYgKC9bXCJcXHNdLy50ZXN0KHMpICYmICEvJy8udGVzdChzKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCInXCIgKyBzLnJlcGxhY2UoLyhbJ1xcXFxdKS9nLCAnXFxcXCQxJykgKyBcIidcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAoL1tcIidcXHNdLy50ZXN0KHMpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnXCInICsgcy5yZXBsYWNlKC8oW1wiXFxcXCRgIV0pL2csICdcXFxcJDEnKSArICdcIic7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gU3RyaW5nKHMpLnJlcGxhY2UoLyhbIyFcIiQmJygpKiw6Ozw9Pj9AXFxbXFxcXFxcXV5ge3x9XSkvZywgJ1xcXFwkMScpO1xyXG4gICAgICAgIH1cclxuICAgIH0pLmpvaW4oJyAnKTtcclxufTtcclxuXHJcbnZhciBDT05UUk9MID0gJyg/OicgKyBbXHJcbiAgICAnXFxcXHxcXFxcfCcsICdcXFxcJlxcXFwmJywgJzs7JywgJ1xcXFx8XFxcXCYnLCAnWyY7KCl8PD5dJ1xyXG5dLmpvaW4oJ3wnKSArICcpJztcclxudmFyIE1FVEEgPSAnfCY7KCk8PiBcXFxcdCc7XHJcbnZhciBCQVJFV09SRCA9ICcoXFxcXFxcXFxbXFwnXCInICsgTUVUQSArICddfFteXFxcXHNcXCdcIicgKyBNRVRBICsgJ10pKyc7XHJcbnZhciBTSU5HTEVfUVVPVEUgPSAnXCIoKFxcXFxcXFxcXCJ8W15cIl0pKj8pXCInO1xyXG52YXIgRE9VQkxFX1FVT1RFID0gJ1xcJygoXFxcXFxcXFxcXCd8W15cXCddKSo/KVxcJyc7XHJcblxyXG52YXIgVE9LRU4gPSAnJztcclxuZm9yICh2YXIgaSA9IDA7IGkgPCA0OyBpKyspIHtcclxuICAgIFRPS0VOICs9IChNYXRoLnBvdygxNiw4KSpNYXRoLnJhbmRvbSgpKS50b1N0cmluZygxNik7XHJcbn1cclxuXHJcbmV4cG9ydHMucGFyc2UgPSBmdW5jdGlvbiAocywgZW52LCBvcHRzKSB7XHJcbiAgICB2YXIgbWFwcGVkID0gcGFyc2UocywgZW52LCBvcHRzKTtcclxuICAgIGlmICh0eXBlb2YgZW52ICE9PSAnZnVuY3Rpb24nKSByZXR1cm4gbWFwcGVkO1xyXG4gICAgcmV0dXJuIG1hcHBlZC5yZWR1Y2UoZnVuY3Rpb24gKGFjYywgcykge1xyXG4gICAgICAgIGlmICh0eXBlb2YgcyA9PT0gJ29iamVjdCcpIHJldHVybiBhY2MuY29uY2F0KHMpO1xyXG4gICAgICAgIHZhciB4cyA9IHMuc3BsaXQoUmVnRXhwKCcoJyArIFRPS0VOICsgJy4qPycgKyBUT0tFTiArICcpJywgJ2cnKSk7XHJcbiAgICAgICAgaWYgKHhzLmxlbmd0aCA9PT0gMSkgcmV0dXJuIGFjYy5jb25jYXQoeHNbMF0pO1xyXG4gICAgICAgIHJldHVybiBhY2MuY29uY2F0KHhzLmZpbHRlcihCb29sZWFuKS5tYXAoZnVuY3Rpb24gKHgpIHtcclxuICAgICAgICAgICAgaWYgKFJlZ0V4cCgnXicgKyBUT0tFTikudGVzdCh4KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoeC5zcGxpdChUT0tFTilbMV0pOyB9XHJcbiAgICAgICAgICAgIGVsc2UgcmV0dXJuIHg7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgfSwgW10pO1xyXG59O1xyXG5cclxuZnVuY3Rpb24gcGFyc2UgKHMsIGVudiwgb3B0cykge1xyXG4gICAgdmFyIGNodW5rZXIgPSBuZXcgUmVnRXhwKFtcclxuICAgICAgICAnKCcgKyBDT05UUk9MICsgJyknLCAvLyBjb250cm9sIGNoYXJzXHJcbiAgICAgICAgJygnICsgQkFSRVdPUkQgKyAnfCcgKyBTSU5HTEVfUVVPVEUgKyAnfCcgKyBET1VCTEVfUVVPVEUgKyAnKSonXHJcbiAgICBdLmpvaW4oJ3wnKSwgJ2cnKTtcclxuICAgIHZhciBtYXRjaCA9IHMubWF0Y2goY2h1bmtlcikuZmlsdGVyKEJvb2xlYW4pO1xyXG4gICAgdmFyIGNvbW1lbnRlZCA9IGZhbHNlO1xyXG5cclxuICAgIGlmICghbWF0Y2gpIHJldHVybiBbXTtcclxuICAgIGlmICghZW52KSBlbnYgPSB7fTtcclxuICAgIGlmICghb3B0cykgb3B0cyA9IHt9O1xyXG4gICAgcmV0dXJuIG1hdGNoLm1hcChmdW5jdGlvbiAocywgaikge1xyXG4gICAgICAgIGlmIChjb21tZW50ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocy5jaGFyQXQoMCkgPT09ICcjJykge1xyXG4gICAgICAgICAgICBjb21tZW50ZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4geyBjb21tZW50OiBzLnN1YnN0cigxKSArIG1hdGNoLnNsaWNlKGorMSkuam9pbignICcpIH07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChSZWdFeHAoJ14nICsgQ09OVFJPTCArICckJykudGVzdChzKSkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBvcDogcyB9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gSGFuZC13cml0dGVuIHNjYW5uZXIvcGFyc2VyIGZvciBCYXNoIHF1b3RpbmcgcnVsZXM6XHJcbiAgICAgICAgLy9cclxuICAgICAgICAvLyAgMS4gaW5zaWRlIHNpbmdsZSBxdW90ZXMsIGFsbCBjaGFyYWN0ZXJzIGFyZSBwcmludGVkIGxpdGVyYWxseS5cclxuICAgICAgICAvLyAgMi4gaW5zaWRlIGRvdWJsZSBxdW90ZXMsIGFsbCBjaGFyYWN0ZXJzIGFyZSBwcmludGVkIGxpdGVyYWxseVxyXG4gICAgICAgIC8vICAgICBleGNlcHQgdmFyaWFibGVzIHByZWZpeGVkIGJ5ICckJyBhbmQgYmFja3NsYXNoZXMgZm9sbG93ZWQgYnlcclxuICAgICAgICAvLyAgICAgZWl0aGVyIGEgZG91YmxlIHF1b3RlIG9yIGFub3RoZXIgYmFja3NsYXNoLlxyXG4gICAgICAgIC8vICAzLiBvdXRzaWRlIG9mIGFueSBxdW90ZXMsIGJhY2tzbGFzaGVzIGFyZSB0cmVhdGVkIGFzIGVzY2FwZVxyXG4gICAgICAgIC8vICAgICBjaGFyYWN0ZXJzIGFuZCBub3QgcHJpbnRlZCAodW5sZXNzIHRoZXkgYXJlIHRoZW1zZWx2ZXMgZXNjYXBlZClcclxuICAgICAgICAvLyAgNC4gcXVvdGUgY29udGV4dCBjYW4gc3dpdGNoIG1pZC10b2tlbiBpZiB0aGVyZSBpcyBubyB3aGl0ZXNwYWNlXHJcbiAgICAgICAgLy8gICAgIGJldHdlZW4gdGhlIHR3byBxdW90ZSBjb250ZXh0cyAoZS5nLiBhbGwnb25lJ1widG9rZW5cIiBwYXJzZXMgYXNcclxuICAgICAgICAvLyAgICAgXCJhbGxvbmV0b2tlblwiKVxyXG4gICAgICAgIHZhciBTUSA9IFwiJ1wiO1xyXG4gICAgICAgIHZhciBEUSA9ICdcIic7XHJcbiAgICAgICAgdmFyIERTID0gJyQnO1xyXG4gICAgICAgIHZhciBCUyA9IG9wdHMuZXNjYXBlIHx8ICdcXFxcJztcclxuICAgICAgICB2YXIgcXVvdGUgPSBmYWxzZTtcclxuICAgICAgICB2YXIgZXNjID0gZmFsc2U7XHJcbiAgICAgICAgdmFyIG91dCA9ICcnO1xyXG4gICAgICAgIHZhciBpc0dsb2IgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHtcclxuICAgICAgICAgICAgdmFyIGMgPSBzLmNoYXJBdChpKTtcclxuICAgICAgICAgICAgaXNHbG9iID0gaXNHbG9iIHx8ICghcXVvdGUgJiYgKGMgPT09ICcqJyB8fCBjID09PSAnPycpKTtcclxuICAgICAgICAgICAgaWYgKGVzYykge1xyXG4gICAgICAgICAgICAgICAgb3V0ICs9IGM7XHJcbiAgICAgICAgICAgICAgICBlc2MgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChxdW90ZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGMgPT09IHF1b3RlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcXVvdGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHF1b3RlID09IFNRKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3V0ICs9IGM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbHNlIHsgLy8gRG91YmxlIHF1b3RlXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGMgPT09IEJTKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGkgKz0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYyA9IHMuY2hhckF0KGkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYyA9PT0gRFEgfHwgYyA9PT0gQlMgfHwgYyA9PT0gRFMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dCArPSBjO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0ICs9IEJTICsgYztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChjID09PSBEUykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvdXQgKz0gcGFyc2VFbnZWYXIoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG91dCArPSBjO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmIChjID09PSBEUSB8fCBjID09PSBTUSkge1xyXG4gICAgICAgICAgICAgICAgcXVvdGUgPSBjO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKFJlZ0V4cCgnXicgKyBDT05UUk9MICsgJyQnKS50ZXN0KGMpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBvcDogcyB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IEJTKSB7XHJcbiAgICAgICAgICAgICAgICBlc2MgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGMgPT09IERTKSB7XHJcbiAgICAgICAgICAgICAgICBvdXQgKz0gcGFyc2VFbnZWYXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIG91dCArPSBjO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGlzR2xvYikgcmV0dXJuIHtvcDogJ2dsb2InLCBwYXR0ZXJuOiBvdXR9O1xyXG5cclxuICAgICAgICByZXR1cm4gb3V0O1xyXG5cclxuICAgICAgICBmdW5jdGlvbiBwYXJzZUVudlZhcigpIHtcclxuICAgICAgICAgICAgaSArPSAxO1xyXG4gICAgICAgICAgICB2YXIgdmFyZW5kLCB2YXJuYW1lO1xyXG4gICAgICAgICAgICAvL2RlYnVnZ2VyXHJcbiAgICAgICAgICAgIGlmIChzLmNoYXJBdChpKSA9PT0gJ3snKSB7XHJcbiAgICAgICAgICAgICAgICBpICs9IDE7XHJcbiAgICAgICAgICAgICAgICBpZiAocy5jaGFyQXQoaSkgPT09ICd9Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkJhZCBzdWJzdGl0dXRpb246IFwiICsgcy5zdWJzdHIoaSAtIDIsIDMpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhcmVuZCA9IHMuaW5kZXhPZignfScsIGkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhcmVuZCA8IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCYWQgc3Vic3RpdHV0aW9uOiBcIiArIHMuc3Vic3RyKGkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHZhcm5hbWUgPSBzLnN1YnN0cihpLCB2YXJlbmQgLSBpKTtcclxuICAgICAgICAgICAgICAgIGkgPSB2YXJlbmQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAoL1sqQCM/JCFfXFwtXS8udGVzdChzLmNoYXJBdChpKSkpIHtcclxuICAgICAgICAgICAgICAgIHZhcm5hbWUgPSBzLmNoYXJBdChpKTtcclxuICAgICAgICAgICAgICAgIGkgKz0gMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhcmVuZCA9IHMuc3Vic3RyKGkpLm1hdGNoKC9bXlxcd1xcZF9dLyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXZhcmVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhcm5hbWUgPSBzLnN1YnN0cihpKTtcclxuICAgICAgICAgICAgICAgICAgICBpID0gcy5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhcm5hbWUgPSBzLnN1YnN0cihpLCB2YXJlbmQuaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGkgKz0gdmFyZW5kLmluZGV4IC0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZ2V0VmFyKG51bGwsICcnLCB2YXJuYW1lKTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgLy8gZmluYWxpemUgcGFyc2VkIGFydW1lbnRzXHJcbiAgICAucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGFyZyl7XHJcbiAgICAgICAgaWYgKGFyZyA9PT0gdW5kZWZpbmVkKXtcclxuICAgICAgICAgICAgcmV0dXJuIHByZXY7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwcmV2LmNvbmNhdChhcmcpO1xyXG4gICAgfSxbXSk7XHJcblxyXG4gICAgZnVuY3Rpb24gZ2V0VmFyIChfLCBwcmUsIGtleSkge1xyXG4gICAgICAgIHZhciByID0gdHlwZW9mIGVudiA9PT0gJ2Z1bmN0aW9uJyA/IGVudihrZXkpIDogZW52W2tleV07XHJcbiAgICAgICAgaWYgKHIgPT09IHVuZGVmaW5lZCkgciA9ICcnO1xyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHIgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBwcmUgKyBUT0tFTiArIEpTT04uc3RyaW5naWZ5KHIpICsgVE9LRU47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2UgcmV0dXJuIHByZSArIHI7XHJcbiAgICB9XHJcbn1cclxuIl19