"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DISPOSE_VALUE = exports.Cache = void 0;

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
// A Cache mapping keys to values which creates entries as they are requested.
class Cache {
  constructor(factory, disposeValue = value => {}) {
    this._values = void 0;
    this._factory = void 0;
    this._disposeValue = void 0;
    this._entriesSubject = void 0;
    this._values = new Map();
    this._factory = factory;
    this._disposeValue = disposeValue;
    this._entriesSubject = new _rxjsCompatUmdMin.Subject();
  }

  has(key) {
    return this._values.has(key);
  }

  get(key) {
    if (!this._values.has(key)) {
      const newValue = this._factory(key);

      this._values.set(key, newValue);

      this._entriesSubject.next([key, newValue]);

      return newValue;
    } else {
      // Cannot use invariant as ValueType may include null/undefined.
      return this._values.get(key);
    }
  } // After this method this._values.keys() === newKeys.
  // deletes all keys not in newKeys
  // gets all keys in newKeys


  setKeys(newKeys) {
    for (const existingKey of this._values.keys()) {
      if (!newKeys.has(existingKey)) {
        this.delete(existingKey);
      }
    }

    for (const newKey of newKeys) {
      this.get(newKey);
    }
  }

  entries() {
    return this._values.entries();
  }

  keys() {
    return this._values.keys();
  }

  values() {
    return this._values.values();
  }

  observeValues() {
    return this.observeEntries().map(entry => entry[1]);
  }

  observeEntries() {
    return _rxjsCompatUmdMin.Observable.concat(_rxjsCompatUmdMin.Observable.from(this._values.entries()), this._entriesSubject);
  }

  observeKeys() {
    return this.observeEntries().map(entry => entry[0]);
  }

  delete(key) {
    if (this.has(key)) {
      const value = this.get(key);

      this._values.delete(key);

      this._disposeValue(value);

      return true;
    } else {
      return false;
    }
  }

  clear() {
    // Defend against a dispose call removing elements from the Cache.
    const values = this._values;
    this._values = new Map();

    for (const value of values.values()) {
      this._disposeValue(value);
    }
  }

  dispose() {
    this.clear();

    this._entriesSubject.complete();
  }

} // Useful for optional second parameter to Cache constructor.


exports.Cache = Cache;

const DISPOSE_VALUE = value => {
  value.dispose();
};

exports.DISPOSE_VALUE = DISPOSE_VALUE;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL2NhY2hlLmpzIl0sIm5hbWVzIjpbIkNhY2hlIiwiY29uc3RydWN0b3IiLCJmYWN0b3J5IiwiZGlzcG9zZVZhbHVlIiwidmFsdWUiLCJfdmFsdWVzIiwiX2ZhY3RvcnkiLCJfZGlzcG9zZVZhbHVlIiwiX2VudHJpZXNTdWJqZWN0IiwiTWFwIiwiU3ViamVjdCIsImhhcyIsImtleSIsImdldCIsIm5ld1ZhbHVlIiwic2V0IiwibmV4dCIsInNldEtleXMiLCJuZXdLZXlzIiwiZXhpc3RpbmdLZXkiLCJrZXlzIiwiZGVsZXRlIiwibmV3S2V5IiwiZW50cmllcyIsInZhbHVlcyIsIm9ic2VydmVWYWx1ZXMiLCJvYnNlcnZlRW50cmllcyIsIm1hcCIsImVudHJ5IiwiT2JzZXJ2YWJsZSIsImNvbmNhdCIsImZyb20iLCJvYnNlcnZlS2V5cyIsImNsZWFyIiwiZGlzcG9zZSIsImNvbXBsZXRlIiwiRElTUE9TRV9WQUxVRSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQVlBOztBQVpBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFJQTtBQUNPLE1BQU1BLEtBQU4sQ0FBZ0M7QUFNckNDLEVBQUFBLFdBQVcsQ0FDVEMsT0FEUyxFQUVUQyxZQUF5QyxHQUFHQyxLQUFLLElBQUksQ0FBRSxDQUY5QyxFQUdUO0FBQUEsU0FSRkMsT0FRRTtBQUFBLFNBUEZDLFFBT0U7QUFBQSxTQU5GQyxhQU1FO0FBQUEsU0FMRkMsZUFLRTtBQUNBLFNBQUtILE9BQUwsR0FBZSxJQUFJSSxHQUFKLEVBQWY7QUFDQSxTQUFLSCxRQUFMLEdBQWdCSixPQUFoQjtBQUNBLFNBQUtLLGFBQUwsR0FBcUJKLFlBQXJCO0FBQ0EsU0FBS0ssZUFBTCxHQUF1QixJQUFJRSx5QkFBSixFQUF2QjtBQUNEOztBQUVEQyxFQUFBQSxHQUFHLENBQUNDLEdBQUQsRUFBd0I7QUFDekIsV0FBTyxLQUFLUCxPQUFMLENBQWFNLEdBQWIsQ0FBaUJDLEdBQWpCLENBQVA7QUFDRDs7QUFFREMsRUFBQUEsR0FBRyxDQUFDRCxHQUFELEVBQTBCO0FBQzNCLFFBQUksQ0FBQyxLQUFLUCxPQUFMLENBQWFNLEdBQWIsQ0FBaUJDLEdBQWpCLENBQUwsRUFBNEI7QUFDMUIsWUFBTUUsUUFBUSxHQUFHLEtBQUtSLFFBQUwsQ0FBY00sR0FBZCxDQUFqQjs7QUFDQSxXQUFLUCxPQUFMLENBQWFVLEdBQWIsQ0FBaUJILEdBQWpCLEVBQXNCRSxRQUF0Qjs7QUFDQSxXQUFLTixlQUFMLENBQXFCUSxJQUFyQixDQUEwQixDQUFDSixHQUFELEVBQU1FLFFBQU4sQ0FBMUI7O0FBQ0EsYUFBT0EsUUFBUDtBQUNELEtBTEQsTUFLTztBQUNMO0FBQ0EsYUFBUSxLQUFLVCxPQUFMLENBQWFRLEdBQWIsQ0FBaUJELEdBQWpCLENBQVI7QUFDRDtBQUNGLEdBOUJvQyxDQWdDckM7QUFDQTtBQUNBOzs7QUFDQUssRUFBQUEsT0FBTyxDQUFDQyxPQUFELEVBQThCO0FBQ25DLFNBQUssTUFBTUMsV0FBWCxJQUEwQixLQUFLZCxPQUFMLENBQWFlLElBQWIsRUFBMUIsRUFBK0M7QUFDN0MsVUFBSSxDQUFDRixPQUFPLENBQUNQLEdBQVIsQ0FBWVEsV0FBWixDQUFMLEVBQStCO0FBQzdCLGFBQUtFLE1BQUwsQ0FBWUYsV0FBWjtBQUNEO0FBQ0Y7O0FBRUQsU0FBSyxNQUFNRyxNQUFYLElBQXFCSixPQUFyQixFQUE4QjtBQUM1QixXQUFLTCxHQUFMLENBQVNTLE1BQVQ7QUFDRDtBQUNGOztBQUVEQyxFQUFBQSxPQUFPLEdBQW1DO0FBQ3hDLFdBQU8sS0FBS2xCLE9BQUwsQ0FBYWtCLE9BQWIsRUFBUDtBQUNEOztBQUVESCxFQUFBQSxJQUFJLEdBQXNCO0FBQ3hCLFdBQU8sS0FBS2YsT0FBTCxDQUFhZSxJQUFiLEVBQVA7QUFDRDs7QUFFREksRUFBQUEsTUFBTSxHQUF3QjtBQUM1QixXQUFPLEtBQUtuQixPQUFMLENBQWFtQixNQUFiLEVBQVA7QUFDRDs7QUFFREMsRUFBQUEsYUFBYSxHQUEwQjtBQUNyQyxXQUFPLEtBQUtDLGNBQUwsR0FBc0JDLEdBQXRCLENBQTBCQyxLQUFLLElBQUlBLEtBQUssQ0FBQyxDQUFELENBQXhDLENBQVA7QUFDRDs7QUFFREYsRUFBQUEsY0FBYyxHQUFxQztBQUNqRCxXQUFPRyw2QkFBV0MsTUFBWCxDQUNMRCw2QkFBV0UsSUFBWCxDQUFnQixLQUFLMUIsT0FBTCxDQUFha0IsT0FBYixFQUFoQixDQURLLEVBRUwsS0FBS2YsZUFGQSxDQUFQO0FBSUQ7O0FBRUR3QixFQUFBQSxXQUFXLEdBQXdCO0FBQ2pDLFdBQU8sS0FBS04sY0FBTCxHQUFzQkMsR0FBdEIsQ0FBMEJDLEtBQUssSUFBSUEsS0FBSyxDQUFDLENBQUQsQ0FBeEMsQ0FBUDtBQUNEOztBQUVEUCxFQUFBQSxNQUFNLENBQUNULEdBQUQsRUFBd0I7QUFDNUIsUUFBSSxLQUFLRCxHQUFMLENBQVNDLEdBQVQsQ0FBSixFQUFtQjtBQUNqQixZQUFNUixLQUFLLEdBQUcsS0FBS1MsR0FBTCxDQUFTRCxHQUFULENBQWQ7O0FBQ0EsV0FBS1AsT0FBTCxDQUFhZ0IsTUFBYixDQUFvQlQsR0FBcEI7O0FBQ0EsV0FBS0wsYUFBTCxDQUFtQkgsS0FBbkI7O0FBQ0EsYUFBTyxJQUFQO0FBQ0QsS0FMRCxNQUtPO0FBQ0wsYUFBTyxLQUFQO0FBQ0Q7QUFDRjs7QUFFRDZCLEVBQUFBLEtBQUssR0FBUztBQUNaO0FBQ0EsVUFBTVQsTUFBTSxHQUFHLEtBQUtuQixPQUFwQjtBQUNBLFNBQUtBLE9BQUwsR0FBZSxJQUFJSSxHQUFKLEVBQWY7O0FBQ0EsU0FBSyxNQUFNTCxLQUFYLElBQW9Cb0IsTUFBTSxDQUFDQSxNQUFQLEVBQXBCLEVBQXFDO0FBQ25DLFdBQUtqQixhQUFMLENBQW1CSCxLQUFuQjtBQUNEO0FBQ0Y7O0FBRUQ4QixFQUFBQSxPQUFPLEdBQVM7QUFDZCxTQUFLRCxLQUFMOztBQUNBLFNBQUt6QixlQUFMLENBQXFCMkIsUUFBckI7QUFDRDs7QUFqR29DLEMsQ0FvR3ZDOzs7OztBQUNPLE1BQU1DLGFBQWEsR0FBSWhDLEtBQUQsSUFBd0I7QUFDbkRBLEVBQUFBLEtBQUssQ0FBQzhCLE9BQU47QUFDRCxDQUZNIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHtPYnNlcnZhYmxlLCBTdWJqZWN0fSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5cclxuLy8gQSBDYWNoZSBtYXBwaW5nIGtleXMgdG8gdmFsdWVzIHdoaWNoIGNyZWF0ZXMgZW50cmllcyBhcyB0aGV5IGFyZSByZXF1ZXN0ZWQuXHJcbmV4cG9ydCBjbGFzcyBDYWNoZTxLZXlUeXBlLCBWYWx1ZVR5cGU+IHtcclxuICBfdmFsdWVzOiBNYXA8S2V5VHlwZSwgVmFsdWVUeXBlPjtcclxuICBfZmFjdG9yeTogKGtleTogS2V5VHlwZSkgPT4gVmFsdWVUeXBlO1xyXG4gIF9kaXNwb3NlVmFsdWU6ICh2YWx1ZTogVmFsdWVUeXBlKSA9PiBtaXhlZDtcclxuICBfZW50cmllc1N1YmplY3Q6IFN1YmplY3Q8W0tleVR5cGUsIFZhbHVlVHlwZV0+O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIGZhY3Rvcnk6IChrZXk6IEtleVR5cGUpID0+IFZhbHVlVHlwZSxcclxuICAgIGRpc3Bvc2VWYWx1ZTogKHZhbHVlOiBWYWx1ZVR5cGUpID0+IG1peGVkID0gdmFsdWUgPT4ge30sXHJcbiAgKSB7XHJcbiAgICB0aGlzLl92YWx1ZXMgPSBuZXcgTWFwKCk7XHJcbiAgICB0aGlzLl9mYWN0b3J5ID0gZmFjdG9yeTtcclxuICAgIHRoaXMuX2Rpc3Bvc2VWYWx1ZSA9IGRpc3Bvc2VWYWx1ZTtcclxuICAgIHRoaXMuX2VudHJpZXNTdWJqZWN0ID0gbmV3IFN1YmplY3QoKTtcclxuICB9XHJcblxyXG4gIGhhcyhrZXk6IEtleVR5cGUpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0aGlzLl92YWx1ZXMuaGFzKGtleSk7XHJcbiAgfVxyXG5cclxuICBnZXQoa2V5OiBLZXlUeXBlKTogVmFsdWVUeXBlIHtcclxuICAgIGlmICghdGhpcy5fdmFsdWVzLmhhcyhrZXkpKSB7XHJcbiAgICAgIGNvbnN0IG5ld1ZhbHVlID0gdGhpcy5fZmFjdG9yeShrZXkpO1xyXG4gICAgICB0aGlzLl92YWx1ZXMuc2V0KGtleSwgbmV3VmFsdWUpO1xyXG4gICAgICB0aGlzLl9lbnRyaWVzU3ViamVjdC5uZXh0KFtrZXksIG5ld1ZhbHVlXSk7XHJcbiAgICAgIHJldHVybiBuZXdWYWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIENhbm5vdCB1c2UgaW52YXJpYW50IGFzIFZhbHVlVHlwZSBtYXkgaW5jbHVkZSBudWxsL3VuZGVmaW5lZC5cclxuICAgICAgcmV0dXJuICh0aGlzLl92YWx1ZXMuZ2V0KGtleSk6IGFueSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBBZnRlciB0aGlzIG1ldGhvZCB0aGlzLl92YWx1ZXMua2V5cygpID09PSBuZXdLZXlzLlxyXG4gIC8vIGRlbGV0ZXMgYWxsIGtleXMgbm90IGluIG5ld0tleXNcclxuICAvLyBnZXRzIGFsbCBrZXlzIGluIG5ld0tleXNcclxuICBzZXRLZXlzKG5ld0tleXM6IFNldDxLZXlUeXBlPik6IHZvaWQge1xyXG4gICAgZm9yIChjb25zdCBleGlzdGluZ0tleSBvZiB0aGlzLl92YWx1ZXMua2V5cygpKSB7XHJcbiAgICAgIGlmICghbmV3S2V5cy5oYXMoZXhpc3RpbmdLZXkpKSB7XHJcbiAgICAgICAgdGhpcy5kZWxldGUoZXhpc3RpbmdLZXkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZm9yIChjb25zdCBuZXdLZXkgb2YgbmV3S2V5cykge1xyXG4gICAgICB0aGlzLmdldChuZXdLZXkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZW50cmllcygpOiBJdGVyYXRvcjxbS2V5VHlwZSwgVmFsdWVUeXBlXT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlcy5lbnRyaWVzKCk7XHJcbiAgfVxyXG5cclxuICBrZXlzKCk6IEl0ZXJhdG9yPEtleVR5cGU+IHtcclxuICAgIHJldHVybiB0aGlzLl92YWx1ZXMua2V5cygpO1xyXG4gIH1cclxuXHJcbiAgdmFsdWVzKCk6IEl0ZXJhdG9yPFZhbHVlVHlwZT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlcy52YWx1ZXMoKTtcclxuICB9XHJcblxyXG4gIG9ic2VydmVWYWx1ZXMoKTogT2JzZXJ2YWJsZTxWYWx1ZVR5cGU+IHtcclxuICAgIHJldHVybiB0aGlzLm9ic2VydmVFbnRyaWVzKCkubWFwKGVudHJ5ID0+IGVudHJ5WzFdKTtcclxuICB9XHJcblxyXG4gIG9ic2VydmVFbnRyaWVzKCk6IE9ic2VydmFibGU8W0tleVR5cGUsIFZhbHVlVHlwZV0+IHtcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLmNvbmNhdChcclxuICAgICAgT2JzZXJ2YWJsZS5mcm9tKHRoaXMuX3ZhbHVlcy5lbnRyaWVzKCkpLFxyXG4gICAgICB0aGlzLl9lbnRyaWVzU3ViamVjdCxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBvYnNlcnZlS2V5cygpOiBPYnNlcnZhYmxlPEtleVR5cGU+IHtcclxuICAgIHJldHVybiB0aGlzLm9ic2VydmVFbnRyaWVzKCkubWFwKGVudHJ5ID0+IGVudHJ5WzBdKTtcclxuICB9XHJcblxyXG4gIGRlbGV0ZShrZXk6IEtleVR5cGUpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmhhcyhrZXkpKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXQoa2V5KTtcclxuICAgICAgdGhpcy5fdmFsdWVzLmRlbGV0ZShrZXkpO1xyXG4gICAgICB0aGlzLl9kaXNwb3NlVmFsdWUodmFsdWUpO1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGNsZWFyKCk6IHZvaWQge1xyXG4gICAgLy8gRGVmZW5kIGFnYWluc3QgYSBkaXNwb3NlIGNhbGwgcmVtb3ZpbmcgZWxlbWVudHMgZnJvbSB0aGUgQ2FjaGUuXHJcbiAgICBjb25zdCB2YWx1ZXMgPSB0aGlzLl92YWx1ZXM7XHJcbiAgICB0aGlzLl92YWx1ZXMgPSBuZXcgTWFwKCk7XHJcbiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIHZhbHVlcy52YWx1ZXMoKSkge1xyXG4gICAgICB0aGlzLl9kaXNwb3NlVmFsdWUodmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZGlzcG9zZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuY2xlYXIoKTtcclxuICAgIHRoaXMuX2VudHJpZXNTdWJqZWN0LmNvbXBsZXRlKCk7XHJcbiAgfVxyXG59XHJcblxyXG4vLyBVc2VmdWwgZm9yIG9wdGlvbmFsIHNlY29uZCBwYXJhbWV0ZXIgdG8gQ2FjaGUgY29uc3RydWN0b3IuXHJcbmV4cG9ydCBjb25zdCBESVNQT1NFX1ZBTFVFID0gKHZhbHVlOiBJRGlzcG9zYWJsZSkgPT4ge1xyXG4gIHZhbHVlLmRpc3Bvc2UoKTtcclxufTtcclxuIl19