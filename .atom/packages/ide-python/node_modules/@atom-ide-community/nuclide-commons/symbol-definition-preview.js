"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getDefinitionPreview = getDefinitionPreview;

var _mimeTypes = _interopRequireDefault(require("mime-types"));

var _cr = _interopRequireDefault(require("cr"));

var _fsPromise = _interopRequireDefault(require("./fsPromise"));

var _string = require("./string");

var _nuclideUri = _interopRequireDefault(require("./nuclideUri"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const MAX_PREVIEW_LINES = 10;
const MAX_FILESIZE = 100000;
const WHITESPACE_REGEX = /^\s*/;

function getIndentLevel(line) {
  // $FlowFixMe (>= v0.75.0)
  const match = WHITESPACE_REGEX.exec(line);
  return match[0].length;
}

async function getDefinitionPreview(definition) {
  // ensure filesize not too big before reading in whole file
  const stats = await _fsPromise.default.stat(definition.path);

  if (stats.size > MAX_FILESIZE) {
    return null;
  } // if file is image, return base-64 encoded contents


  const fileBuffer = await _fsPromise.default.readFile(definition.path);
  const mime = _mimeTypes.default.contentType(_nuclideUri.default.extname(definition.path)) || 'text/plain';

  if (mime.startsWith('image/')) {
    return {
      mime,
      contents: fileBuffer.toString('base64'),
      encoding: 'base64'
    };
  }

  let contents = fileBuffer.toString('utf8');
  contents = (0, _cr.default)(contents);
  const lines = contents.split('\n');
  const start = definition.position.row;
  const initialIndentLevel = getIndentLevel(lines[start]);
  const buffer = [];

  for (let i = start, openParenCount = 0, closedParenCount = 0, openCurlyCount = 0, closedCurlyCount = 0; i < start + MAX_PREVIEW_LINES && i < lines.length; i++) {
    const line = lines[i];
    const indentLevel = getIndentLevel(line);
    openParenCount += (0, _string.countOccurrences)(line, '(');
    closedParenCount += (0, _string.countOccurrences)(line, ')');
    openCurlyCount += (0, _string.countOccurrences)(line, '{');
    closedCurlyCount += (0, _string.countOccurrences)(line, '}');
    buffer.push(line.substr(Math.min(indentLevel, initialIndentLevel))); // dedent
    // heuristic for the end of a function signature:

    if (indentLevel <= initialIndentLevel) {
      // we've returned back to the original indentation level
      if (openParenCount > 0 && openParenCount === closedParenCount) {
        // if we're in a fn definition, make sure we have balanced pairs of parens
        break;
      } else if (line.trim().endsWith(';')) {
        // c-style statement ending
        break;
      } else if ( // end of a property definition
      line.trim().endsWith(',') && // including complex types as values
      openCurlyCount === closedCurlyCount && // but still not before function signatures are closed
      openParenCount === closedParenCount) {
        break;
      }
    }
  }

  return {
    mime,
    contents: buffer.join('\n'),
    encoding: 'utf8'
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1jb21tb25zL3N5bWJvbC1kZWZpbml0aW9uLXByZXZpZXcuanMiXSwibmFtZXMiOlsiTUFYX1BSRVZJRVdfTElORVMiLCJNQVhfRklMRVNJWkUiLCJXSElURVNQQUNFX1JFR0VYIiwiZ2V0SW5kZW50TGV2ZWwiLCJsaW5lIiwibWF0Y2giLCJleGVjIiwibGVuZ3RoIiwiZ2V0RGVmaW5pdGlvblByZXZpZXciLCJkZWZpbml0aW9uIiwic3RhdHMiLCJmc1Byb21pc2UiLCJzdGF0IiwicGF0aCIsInNpemUiLCJmaWxlQnVmZmVyIiwicmVhZEZpbGUiLCJtaW1lIiwibWltZVR5cGVzIiwiY29udGVudFR5cGUiLCJudWNsaWRlVXJpIiwiZXh0bmFtZSIsInN0YXJ0c1dpdGgiLCJjb250ZW50cyIsInRvU3RyaW5nIiwiZW5jb2RpbmciLCJsaW5lcyIsInNwbGl0Iiwic3RhcnQiLCJwb3NpdGlvbiIsInJvdyIsImluaXRpYWxJbmRlbnRMZXZlbCIsImJ1ZmZlciIsImkiLCJvcGVuUGFyZW5Db3VudCIsImNsb3NlZFBhcmVuQ291bnQiLCJvcGVuQ3VybHlDb3VudCIsImNsb3NlZEN1cmx5Q291bnQiLCJpbmRlbnRMZXZlbCIsInB1c2giLCJzdWJzdHIiLCJNYXRoIiwibWluIiwidHJpbSIsImVuZHNXaXRoIiwiam9pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFjQSxNQUFNQSxpQkFBaUIsR0FBRyxFQUExQjtBQUNBLE1BQU1DLFlBQVksR0FBRyxNQUFyQjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLE1BQXpCOztBQUNBLFNBQVNDLGNBQVQsQ0FBd0JDLElBQXhCLEVBQXNDO0FBQ3BDO0FBQ0EsUUFBTUMsS0FBeUIsR0FBR0gsZ0JBQWdCLENBQUNJLElBQWpCLENBQXNCRixJ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QixHQUFyQixLQUNBO0FBQ0FSLE1BQUFBLGNBQWMsS0FBS0MsZ0JBRm5CLElBR0E7QUFDQUgsTUFBQUEsY0FBYyxLQUFLQyxnQkFOZCxFQU9MO0FBQ0E7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsU0FBTztBQUFDbEIsSUFBQUEsSUFBRDtBQUFPTSxJQUFBQSxRQUFRLEVBQUVTLE1BQU0sQ0FBQ2EsSUFBUCxDQUFZLElBQVosQ0FBakI7QUFBb0NwQixJQUFBQSxRQUFRLEVBQUU7QUFBOUMsR0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvcHlyaWdodCAoYykgMjAxNy1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxyXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4gKlxyXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBCU0Qtc3R5bGUgbGljZW5zZSBmb3VuZCBpbiB0aGVcclxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XHJcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxyXG4gKlxyXG4gKiBAZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG5cclxuaW1wb3J0IHR5cGUge051Y2xpZGVVcml9IGZyb20gJy4vbnVjbGlkZVVyaSc7XHJcbmltcG9ydCBtaW1lVHlwZXMgZnJvbSAnbWltZS10eXBlcyc7XHJcbmltcG9ydCBjciBmcm9tICdjcic7XHJcbmltcG9ydCBmc1Byb21pc2UgZnJvbSAnLi9mc1Byb21pc2UnO1xyXG5pbXBvcnQge2NvdW50T2NjdXJyZW5jZXN9IGZyb20gJy4vc3RyaW5nJztcclxuaW1wb3J0IG51Y2xpZGVVcmkgZnJvbSAnLi9udWNsaWRlVXJpJztcclxuXHJcbnR5cGUgRGVmaW5pdGlvbiA9IHtcclxuICBwYXRoOiBOdWNsaWRlVXJpLFxyXG4gIHBvc2l0aW9uOiBhdG9tJFBvaW50LFxyXG59O1xyXG5cclxuY29uc3QgTUFYX1BSRVZJRVdfTElORVMgPSAxMDtcclxuY29uc3QgTUFYX0ZJTEVTSVpFID0gMTAwMDAwO1xyXG5jb25zdCBXSElURVNQQUNFX1JFR0VYID0gL15cXHMqLztcclxuZnVuY3Rpb24gZ2V0SW5kZW50TGV2ZWwobGluZTogc3RyaW5nKSB7XHJcbiAgLy8gJEZsb3dGaXhNZSAoPj0gdjAuNzUuMClcclxuICBjb25zdCBtYXRjaDogUmVnRXhwJG1hdGNoUmVzdWx0ID0gV0hJVEVTUEFDRV9SRUdFWC5leGVjKGxpbmUpO1xyXG4gIHJldHVybiBtYXRjaFswXS5sZW5ndGg7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZWZpbml0aW9uUHJldmlldyhcclxuICBkZWZpbml0aW9uOiBEZWZpbml0aW9uLFxyXG4pOiBQcm9taXNlPD97XHJcbiAgbWltZTogc3RyaW5nLFxyXG4gIGNvbnRlbnRzOiBzdHJpbmcsXHJcbiAgZW5jb2Rpbmc6IHN0cmluZyxcclxufT4ge1xyXG4gIC8vIGVuc3VyZSBmaWxlc2l6ZSBub3QgdG9vIGJpZyBiZWZvcmUgcmVhZGluZyBpbiB3aG9sZSBmaWxlXHJcbiAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmc1Byb21pc2Uuc3RhdChkZWZpbml0aW9uLnBhdGgpO1xyXG4gIGlmIChzdGF0cy5zaXplID4gTUFYX0ZJTEVTSVpFKSB7XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8vIGlmIGZpbGUgaXMgaW1hZ2UsIHJldHVybiBiYXNlLTY0IGVuY29kZWQgY29udGVudHNcclxuICBjb25zdCBmaWxlQnVmZmVyID0gYXdhaXQgZnNQcm9taXNlLnJlYWRGaWxlKGRlZmluaXRpb24ucGF0aCk7XHJcblxyXG4gIGNvbnN0IG1pbWUgPVxyXG4gICAgbWltZVR5cGVzLmNvbnRlbnRUeXBlKG51Y2xpZGVVcmkuZXh0bmFtZShkZWZpbml0aW9uLnBhdGgpKSB8fCAndGV4dC9wbGFpbic7XHJcbiAgaWYgKG1pbWUuc3RhcnRzV2l0aCgnaW1hZ2UvJykpIHtcclxuICAgIHJldHVybiB7bWltZSwgY29udGVudHM6IGZpbGVCdWZmZXIudG9TdHJpbmcoJ2Jhc2U2NCcpLCBlbmNvZGluZzogJ2Jhc2U2NCd9O1xyXG4gIH1cclxuXHJcbiAgbGV0IGNvbnRlbnRzID0gZmlsZUJ1ZmZlci50b1N0cmluZygndXRmOCcpO1xyXG4gIGNvbnRlbnRzID0gY3IoY29udGVudHMpO1xyXG4gIGNvbnN0IGxpbmVzID0gY29udGVudHMuc3BsaXQoJ1xcbicpO1xyXG5cclxuICBjb25zdCBzdGFydCA9IGRlZmluaXRpb24ucG9zaXRpb24ucm93O1xyXG4gIGNvbnN0IGluaXRpYWxJbmRlbnRMZXZlbCA9IGdldEluZGVudExldmVsKGxpbmVzW3N0YXJ0XSk7XHJcblxyXG4gIGNvbnN0IGJ1ZmZlciA9IFtdO1xyXG4gIGZvciAoXHJcbiAgICBsZXQgaSA9IHN0YXJ0LFxyXG4gICAgICBvcGVuUGFyZW5Db3VudCA9IDAsXHJcbiAgICAgIGNsb3NlZFBhcmVuQ291bnQgPSAwLFxyXG4gICAgICBvcGVuQ3VybHlDb3VudCA9IDAsXHJcbiAgICAgIGNsb3NlZEN1cmx5Q291bnQgPSAwO1xyXG4gICAgaSA8IHN0YXJ0ICsgTUFYX1BSRVZJRVdfTElORVMgJiYgaSA8IGxpbmVzLmxlbmd0aDtcclxuICAgIGkrK1xyXG4gICkge1xyXG4gICAgY29uc3QgbGluZSA9IGxpbmVzW2ldO1xyXG4gICAgY29uc3QgaW5kZW50TGV2ZWwgPSBnZXRJbmRlbnRMZXZlbChsaW5lKTtcclxuICAgIG9wZW5QYXJlbkNvdW50ICs9IGNvdW50T2NjdXJyZW5jZXMobGluZSwgJygnKTtcclxuICAgIGNsb3NlZFBhcmVuQ291bnQgKz0gY291bnRPY2N1cnJlbmNlcyhsaW5lLCAnKScpO1xyXG4gICAgb3BlbkN1cmx5Q291bnQgKz0gY291bnRPY2N1cnJlbmNlcyhsaW5lLCAneycpO1xyXG4gICAgY2xvc2VkQ3VybHlDb3VudCArPSBjb3VudE9jY3VycmVuY2VzKGxpbmUsICd9Jyk7XHJcblxyXG4gICAgYnVmZmVyLnB1c2gobGluZS5zdWJzdHIoTWF0aC5taW4oaW5kZW50TGV2ZWwsIGluaXRpYWxJbmRlbnRMZXZlbCkpKTsgLy8gZGVkZW50XHJcblxyXG4gICAgLy8gaGV1cmlzdGljIGZvciB0aGUgZW5kIG9mIGEgZnVuY3Rpb24gc2lnbmF0dXJlOlxyXG4gICAgaWYgKGluZGVudExldmVsIDw9IGluaXRpYWxJbmRlbnRMZXZlbCkge1xyXG4gICAgICAvLyB3ZSd2ZSByZXR1cm5lZCBiYWNrIHRvIHRoZSBvcmlnaW5hbCBpbmRlbnRhdGlvbiBsZXZlbFxyXG4gICAgICBpZiAob3BlblBhcmVuQ291bnQgPiAwICYmIG9wZW5QYXJlbkNvdW50ID09PSBjbG9zZWRQYXJlbkNvdW50KSB7XHJcbiAgICAgICAgLy8gaWYgd2UncmUgaW4gYSBmbiBkZWZpbml0aW9uLCBtYWtlIHN1cmUgd2UgaGF2ZSBiYWxhbmNlZCBwYWlycyBvZiBwYXJlbnNcclxuICAgICAgICBicmVhaztcclxuICAgICAgfSBlbHNlIGlmIChsaW5lLnRyaW0oKS5lbmRzV2l0aCgnOycpKSB7XHJcbiAgICAgICAgLy8gYy1zdHlsZSBzdGF0ZW1lbnQgZW5kaW5nXHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH0gZWxzZSBpZiAoXHJcbiAgICAgICAgLy8gZW5kIG9mIGEgcHJvcGVydHkgZGVmaW5pdGlvblxyXG4gICAgICAgIGxpbmUudHJpbSgpLmVuZHNXaXRoKCcsJykgJiZcclxuICAgICAgICAvLyBpbmNsdWRpbmcgY29tcGxleCB0eXBlcyBhcyB2YWx1ZXNcclxuICAgICAgICBvcGVuQ3VybHlDb3VudCA9PT0gY2xvc2VkQ3VybHlDb3VudCAmJlxyXG4gICAgICAgIC8vIGJ1dCBzdGlsbCBub3QgYmVmb3JlIGZ1bmN0aW9uIHNpZ25hdHVyZXMgYXJlIGNsb3NlZFxyXG4gICAgICAgIG9wZW5QYXJlbkNvdW50ID09PSBjbG9zZWRQYXJlbkNvdW50XHJcbiAgICAgICkge1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4ge21pbWUsIGNvbnRlbnRzOiBidWZmZXIuam9pbignXFxuJyksIGVuY29kaW5nOiAndXRmOCd9O1xyXG59XHJcbiJdfQ==