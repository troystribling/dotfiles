"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DeviceAndProcess = void 0;

var _idx = _interopRequireDefault(require("idx"));

var _nuclideAdb = require("@atom-ide-community/nuclide-adb");

var _AtomInput = require("@atom-ide-community/nuclide-commons-ui/AtomInput");

var _LoadingSpinner = require("@atom-ide-community/nuclide-commons-ui/LoadingSpinner");

var _Table = require("@atom-ide-community/nuclide-commons-ui/Table");

var _collection = require("@atom-ide-community/nuclide-commons/collection");

var _expected = require("@atom-ide-community/nuclide-commons/expected");

var _UniversalDisposable = _interopRequireDefault(require("@atom-ide-community/nuclide-commons/UniversalDisposable"));

var React = _interopRequireWildcard(require("react"));

var _rxjsCompatUmdMin = require("rxjs-compat/bundles/rxjs-compat.umd.min.js");

var _AdbDeviceSelector = require("./AdbDeviceSelector");

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
class DeviceAndProcess extends React.Component {
  constructor(props) {
    super(props);
    this._disposables = void 0;
    this._javaProcessSubscription = void 0;

    this._handleDeviceChange = device => {
      const oldDeviceSerial = this.state.selectedDeviceSerial;

      if (oldDeviceSerial != null && device != null && oldDeviceSerial === device.serial) {
        // Same device selected.
        return;
      }

      if (this._javaProcessSubscription != null) {
        this._javaProcessSubscription.unsubscribe();

        this._javaProcessSubscription = null;
      }

      this.setState({
        selectedDeviceSerial: device === null || device === void 0 ? void 0 : device.serial,
        javaProcesses: device == null ? _expected.Expect.value([]) : _expected.Expect.pending(),
        selectedProcess: null,
        selectedProcessName: this.props.deserialize()
      }, () => {
        if (device != null) {
          // If a device is selected, observe the Java processes on the device.
          const adbService = (0, _nuclideAdb.getAdbServiceByNuclideUri)(this.props.targetUri);
          this._javaProcessSubscription = _rxjsCompatUmdMin.Observable.interval(2000).startWith(0).switchMap(() => adbService.getJavaProcesses(device.serial).refCount()).distinctUntilChanged((a, b) => (0, _collection.arrayEqual)(a, b, (x, y) => {
            return x.user === y.user && x.pid === y.pid && x.name === y.name;
          })).subscribe(javaProcesses => {
            this._javaProcessListChanged(_expected.Expect.value(javaProcesses));
          });
        }
      });
    };

    this._handleFilterTextChange = filterText => {
      // Check if we've filtered down to one option and select if so
      const filteredProcesses = this._filterJavaProcesses(filterText); // TODO: (goom) this setState depends on current state
      // and should use an updater function rather than an object
      // eslint-disable-next-line react/no-access-state-in-setstate


      let selectedProcess = this.state.selectedProcess;

      if (filteredProcesses.length === 1) {
        // Check if we've filtered down to one option and select if so
        selectedProcess = filteredProcesses[0];
      } else if (filteredProcesses.findIndex(processRow => {
        var _selectedProcess;

        return ((_selectedProcess = selectedProcess) === null || _selectedProcess === void 0 ? void 0 : _selectedProcess.pid) === processRow.pid;
      }) === -1) {
        // If we filter out our current selection,
        //   set our current selection to null
        selectedProcess = null;
      }

      this.setState({
        filterText,
        selectedProcess
      });
    };

    this._handleSort = (sortedColumn, sortDescending) => {
      this.setState({
        sortedColumn,
        sortDescending
      });
    };

    this._sortRows = (processes, sortedColumnName, sortDescending) => {
      if (sortedColumnName == null) {
        return processes;
      } // Use a numerical comparison for the pid column, string compare for all the others.


      const compare = sortedColumnName === 'pid' ? (a, b, isAsc) => {
        const cmp = (a || 0) - (b || 0);
        return isAsc ? cmp : -cmp;
      } : (a, b, isAsc) => {
        const cmp = String(a).toLowerCase().localeCompare(String(b).toLowerCase());
        return isAsc ? cmp : -cmp;
      };

      const getter = row => row.data[sortedColumnName];

      return [...processes].sort((a, b) => {
        return compare(getter(a), getter(b), !sortDescending);
      });
    };

    this._handleSelectTableRow = (item, selectedIndex) => {
      this.setState({
        selectedProcess: item,
        selectedProcessName: (0, _idx.default)(item, _ => _.name)
      });
    };

    this._disposables = new _UniversalDisposable.default();
    this._javaProcessSubscription = null;

    this._disposables.add(() => {
      if (this._javaProcessSubscription != null) {
        this._javaProcessSubscription.unsubscribe();
      }
    });

    let _filterText = ''; // the file is not available. This causes confusions for the bundlers and analyzers
    // try {
    //   // $FlowFB
    //   filterText = require('./fb-isFBProcessName').FB_PROCESS_NAME_REGEX_STRING;
    // } catch (e) {}

    this.state = {
      selectedDeviceSerial: null,
      javaProcesses: _expected.Expect.value([]),
      selectedProcess: null,
      selectedProcessName: null,
      sortedColumn: 'name',
      sortDescending: false,
      filterText: _filterText
    };
  }

  componentWillUnmount() {
    this._disposables.dispose();
  }

  setState(partialState, callback) {
    const fullState = { ...this.state,
      ...partialState
    };
    super.setState(fullState, () => {
      this.props.onSelect(fullState.selectedDeviceSerial, fullState.selectedProcess);
      callback && callback();
    });
  }

  _javaProcessListChanged(javaProcesses) {
    var _this$state$selectedP;

    const selectedPid = (_this$state$selectedP = this.state.selectedProcess) === null || _this$state$selectedP === void 0 ? void 0 : _this$state$selectedP.pid;
    const selectedProcess = javaProcesses.getOrDefault([]).find(process => this.state.selectedProcessName != null ? process.name === this.state.selectedProcessName : process.pid === selectedPid);
    this.setState({
      javaProcesses,
      selectedProcess,
      selectedProcessName: selectedProcess === null || selectedProcess === void 0 ? void 0 : selectedProcess.name
    });
  }

  _filterJavaProcesses(filterText) {
    // Show all results if invalid regex
    let filterRegex;

    try {
      filterRegex = new RegExp(filterText, 'i');
    } catch (e) {
      return this.state.javaProcesses.getOrDefault([]);
    } // $FlowFixMe (>=0.85.0) (T35986896) Flow upgrade suppress


    return this.state.javaProcesses.getOrDefault([]).filter(item => filterRegex.test(item.user) || filterRegex.test(item.pid) || filterRegex.test(item.name));
  }

  _getColumns() {
    return [{
      key: 'pid',
      title: 'PID',
      width: 0.1
    }, {
      key: 'user',
      title: 'User',
      width: 0.1
    }, {
      key: 'name',
      title: 'Name',
      width: 0.8
    }];
  }

  render() {
    const emptyMessage = this.state.selectedDeviceSerial == null ? 'No device selected' : 'No debuggable Java processes found!';

    const emptyComponent = () => /*#__PURE__*/React.createElement("div", null, this.state.javaProcesses.isPending ? /*#__PURE__*/React.createElement(_LoadingSpinner.LoadingSpinner, {
      size: "EXTRA_SMALL"
    }) : emptyMessage);

    const processListRows = this._sortRows(this._filterJavaProcesses(this.state.filterText).map(processRow => {
      const data = {
        pid: processRow.pid,
        user: processRow.user,
        name: processRow.name
      };
      return {
        data
      };
    }), this.state.sortedColumn, this.state.sortDescending);

    const selectedRowIndex = processListRows.findIndex(row => {
      var _this$state$selectedP2, _this$state$selectedP3;

      return row.data.pid === ((_this$state$selectedP2 = this.state.selectedProcess) === null || _this$state$selectedP2 === void 0 ? void 0 : _this$state$selectedP2.pid) && row.data.name === ((_this$state$selectedP3 = this.state.selectedProcess) === null || _this$state$selectedP3 === void 0 ? void 0 : _this$state$selectedP3.name);
    });
    return /*#__PURE__*/React.createElement("div", {
      className: "block"
    }, /*#__PURE__*/React.createElement("label", null, "Device:"), /*#__PURE__*/React.createElement(_AdbDeviceSelector.AdbDeviceSelector, {
      onChange: this._handleDeviceChange,
      targetUri: this.props.targetUri
    }), /*#__PURE__*/React.createElement("label", null, "Debuggable Java processes: "), /*#__PURE__*/React.createElement(_AtomInput.AtomInput, {
      placeholderText: "Search with regular expression...",
      value: this.state.filterText,
      onDidChange: this._handleFilterTextChange,
      size: "sm",
      autofocus: true
    }), /*#__PURE__*/React.createElement(_Table.Table, {
      collapsable: false,
      columns: this._getColumns(),
      emptyComponent: emptyComponent,
      fixedHeader: true,
      maxBodyHeight: "30em",
      rows: processListRows,
      sortable: true,
      onSort: this._handleSort,
      sortedColumn: this.state.sortedColumn,
      sortDescending: this.state.sortDescending,
      selectable: true,
      selectedIndex: selectedRowIndex,
      onSelect: this._handleSelectTableRow
    }));
  }

}

exports.DeviceAndProcess = DeviceAndProcess;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1kZWJ1Z2dlci1jb21tb24vRGV2aWNlQW5kUHJvY2Vzcy5qcyJdLCJuYW1lcyI6WyJEZXZpY2VBbmRQcm9jZXNzIiwiUmVhY3QiLCJDb21wb25lbnQiLCJjb25zdHJ1Y3RvciIsInByb3BzIiwiX2Rpc3Bvc2FibGVzIiwiX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uIiwiX2hhbmRsZURldmljZUNoYW5nZSIsImRldmljZSIsIm9sZERldmljZVNlcmlhbCIsInN0YXRlIiwic2VsZWN0ZWREZXZpY2VTZXJpYWwiLCJzZXJpYWwiLCJ1bnN1YnNjcmliZSIsInNldFN0YXRlIiwiamF2YVByb2Nlc3NlcyIsIkV4cGVjdCIsInZhbHVlIiwicGVuZGluZyIsInNlbGVjdGVkUHJvY2VzcyIsInNlbGVjdGVkUHJvY2Vzc05hbWUiLCJkZXNlcmlhbGl6ZSIsImFkYlNlcnZpY2UiLCJ0YXJnZXRVcmkiLCJPYnNlcnZhYmxlIiwiaW50ZXJ2YWwiLCJzdGFydFdpdGgiLCJzd2l0Y2hNYXAiLCJnZXRKYXZhUHJvY2Vzc2VzIiwicmVmQ291bnQiLCJkaXN0aW5jdFVudGlsQ2hhbmdlZCIsImEiLCJiIiwieCIsInkiLCJ1c2VyIiwicGlkIiwibmFtZSIsInN1YnNjcmliZSIsIl9qYXZhUHJvY2Vzc0xpc3RDaGFuZ2VkIiwiX2hhbmRsZUZpbHRlclRleHRDaGFuZ2UiLCJmaWx0ZXJUZXh0IiwiZmlsdGVyZWRQcm9jZXNzZXMiLCJfZmlsdGVySmF2YVByb2Nlc3NlcyIsImxlbmd0aCIsImZpbmRJbmRleCIsInByb2Nlc3NSb3ciLCJfaGFuZGxlU29ydCIsInNvcnRlZENvbHVtbiIsInNvcnREZXNjZW5kaW5nIiwiX3NvcnRSb3dzIiwicHJvY2Vzc2VzIiwic29ydGVkQ29sdW1uTmFtZSIsImNvbXBhcmUiLCJpc0FzYyIsImNtcCIsIlN0cmluZyIsInRvTG93ZXJDYXNlIiwibG9jYWxlQ29tcGFyZSIsImdldHRlciIsInJvdyIsImRhdGEiLCJzb3J0IiwiX2hhbmRsZVNlbGVjdFRhYmxlUm93IiwiaXRlbSIsInNlbGVjdGVkSW5kZXgiLCJfIiwiVW5pdmVyc2FsRGlzcG9zYWJsZSIsImFkZCIsImNvbXBvbmVudFdpbGxVbm1vdW50IiwiZGlzcG9zZSIsInBhcnRpYWxTdGF0ZSIsImNhbGxiYWNrIiwiZnVsbFN0YXRlIiwib25TZWxlY3QiLCJzZWxlY3RlZFBpZCIsImdldE9yRGVmYXVsdCIsImZpbmQiLCJwcm9jZXNzIiwiZmlsdGVyUmVnZXgiLCJSZWdFeHAiLCJlIiwiZmlsdGVyIiwidGVzdCIsIl9nZXRDb2x1bW5zIiwia2V5IiwidGl0bGUiLCJ3aWR0aCIsInJlbmRlciIsImVtcHR5TWVzc2FnZSIsImVtcHR5Q29tcG9uZW50IiwiaXNQZW5kaW5nIiwicHJvY2Vzc0xpc3RSb3dzIiwibWFwIiwic2VsZWN0ZWRSb3dJbmRleCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWtCQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7QUE1QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQXNDTyxNQUFNQSxnQkFBTixTQUErQkMsS0FBSyxDQUFDQyxTQUFyQyxDQUE2RDtBQUlsRUMsRUFBQUEsV0FBVyxDQUFDQyxLQUFELEVBQWU7QUFDeEIsVUFBTUEsS0FBTjtBQUR3QixTQUgxQkMsWUFHMEI7QUFBQSxTQUYxQkMsd0JBRTBCOztBQUFBLFNBK0MxQkMsbUJBL0MwQixHQStDSEMsTUFBRCxJQUE4QjtBQUNsRCxZQUFNQyxlQUFlLEdBQUcsS0FBS0MsS0FBTCxDQUFXQyxvQkFBbkM7O0FBQ0EsVUFDRUYsZUFBZSxJQUFJLElBQW5CLElBQ0FELE1BQU0sSUFBSSxJQURWLElBRUFDLGVBQWUsS0FBS0QsTUFBTSxDQUFDSSxNQUg3QixFQUlFO0FBQ0E7QUFDQTtBQUNEOztBQUVELFVBQUksS0FBS04sd0JBQUwsSUFBaUMsSUFBckMsRUFB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O0FBUUUsTUFBQSxNQUFNLEVBQUUsS0FBSzdDLFdBUmY7QUFTRSxNQUFBLFlBQVksRUFBRSxLQUFLckMsS0FBTCxDQUFXc0MsWUFUM0I7QUFVRSxNQUFBLGNBQWMsRUFBRSxLQUFLdEMsS0FBTCxDQUFXdUMsY0FWN0I7QUFXRSxNQUFBLFVBQVUsRUFBRSxJQVhkO0FBWUUsTUFBQSxhQUFhLEVBQUU2QyxnQkFaakI7QUFhRSxNQUFBLFFBQVEsRUFBRSxLQUFLL0I7QUFiakIsTUFkRixDQURGO0FBZ0NEOztBQXJTaUUiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQ29weXJpZ2h0IChjKSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgdHlwZSB7QWRiRGV2aWNlLCBBbmRyb2lkSmF2YVByb2Nlc3N9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1hZGIvbGliL3R5cGVzJztcclxuaW1wb3J0IHR5cGUge0NvbHVtbiwgUm93fSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy11aS9UYWJsZSc7XHJcbmltcG9ydCB0eXBlIHtFeHBlY3RlZH0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvZXhwZWN0ZWQnO1xyXG5pbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvbnVjbGlkZVVyaSc7XHJcbmltcG9ydCB0eXBlIHtTdWJzY3JpcHRpb259IGZyb20gJ3J4anMtY29tcGF0L2J1bmRsZXMvcnhqcy1jb21wYXQudW1kLm1pbi5qcyc7XHJcblxyXG5pbXBvcnQgaWR4IGZyb20gJ2lkeCc7XHJcbmltcG9ydCB7Z2V0QWRiU2VydmljZUJ5TnVjbGlkZVVyaX0gZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWFkYic7XHJcbmltcG9ydCB7QXRvbUlucHV0fSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy11aS9BdG9tSW5wdXQnO1xyXG5pbXBvcnQge0xvYWRpbmdTcGlubmVyfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy11aS9Mb2FkaW5nU3Bpbm5lcic7XHJcbmltcG9ydCB7VGFibGV9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zLXVpL1RhYmxlJztcclxuaW1wb3J0IHthcnJheUVxdWFsfSBmcm9tICdAYXRvbS1pZGUtY29tbXVuaXR5L251Y2xpZGUtY29tbW9ucy9jb2xsZWN0aW9uJztcclxuaW1wb3J0IHtFeHBlY3R9IGZyb20gJ0BhdG9tLWlkZS1jb21tdW5pdHkvbnVjbGlkZS1jb21tb25zL2V4cGVjdGVkJztcclxuaW1wb3J0IFVuaXZlcnNhbERpc3Bvc2FibGUgZnJvbSAnQGF0b20taWRlLWNvbW11bml0eS9udWNsaWRlLWNvbW1vbnMvVW5pdmVyc2FsRGlzcG9zYWJsZSc7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzLWNvbXBhdC9idW5kbGVzL3J4anMtY29tcGF0LnVtZC5taW4uanMnO1xyXG5pbXBvcnQge0FkYkRldmljZVNlbGVjdG9yfSBmcm9tICcuL0FkYkRldmljZVNlbGVjdG9yJztcclxuXHJcbnR5cGUgQ29sdW1uTmFtZSA9ICdwaWQnIHwgJ3VzZXInIHwgJ25hbWUnO1xyXG5cclxudHlwZSBQcm9wcyA9IHt8XHJcbiAgK3RhcmdldFVyaTogTnVjbGlkZVVyaSxcclxuICArb25TZWxlY3Q6IChkZXZpY2VTZXJpYWw6ID9zdHJpbmcsIGphdmFQcm9jZXNzOiA/QW5kcm9pZEphdmFQcm9jZXNzKSA9PiB2b2lkLFxyXG4gICtkZXNlcmlhbGl6ZTogKCkgPT4gP3N0cmluZyxcclxufH07XHJcblxyXG50eXBlIFN0YXRlID0ge1xyXG4gIHNlbGVjdGVkRGV2aWNlU2VyaWFsOiA/c3RyaW5nLFxyXG4gIGphdmFQcm9jZXNzZXM6IEV4cGVjdGVkPEFycmF5PEFuZHJvaWRKYXZhUHJvY2Vzcz4+LFxyXG4gIHNlbGVjdGVkUHJvY2VzczogP0FuZHJvaWRKYXZhUHJvY2VzcyxcclxuICBzZWxlY3RlZFByb2Nlc3NOYW1lOiA/c3RyaW5nLFxyXG4gIHNvcnRlZENvbHVtbjogP0NvbHVtbk5hbWUsXHJcbiAgc29ydERlc2NlbmRpbmc6IGJvb2xlYW4sXHJcbiAgZmlsdGVyVGV4dDogc3RyaW5nLFxyXG59O1xyXG5cclxuZXhwb3J0IGNsYXNzIERldmljZUFuZFByb2Nlc3MgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8UHJvcHMsIFN0YXRlPiB7XHJcbiAgX2Rpc3Bvc2FibGVzOiBVbml2ZXJzYWxEaXNwb3NhYmxlO1xyXG4gIF9qYXZhUHJvY2Vzc1N1YnNjcmlwdGlvbjogP1N1YnNjcmlwdGlvbjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJvcHM6IFByb3BzKSB7XHJcbiAgICBzdXBlcihwcm9wcyk7XHJcblxyXG4gICAgdGhpcy5fZGlzcG9zYWJsZXMgPSBuZXcgVW5pdmVyc2FsRGlzcG9zYWJsZSgpO1xyXG4gICAgdGhpcy5famF2YVByb2Nlc3NTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZXMuYWRkKCgpID0+IHtcclxuICAgICAgaWYgKHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uICE9IG51bGwpIHtcclxuICAgICAgICB0aGlzLl9qYXZhUHJvY2Vzc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICBsZXQgZmlsdGVyVGV4dCA9ICcnO1xyXG4gICAgLy8gdGhlIGZpbGUgaXMgbm90IGF2YWlsYWJsZS4gVGhpcyBjYXVzZXMgY29uZnVzaW9ucyBmb3IgdGhlIGJ1bmRsZXJzIGFuZCBhbmFseXplcnNcclxuICAgIC8vIHRyeSB7XHJcbiAgICAvLyAgIC8vICRGbG93RkJcclxuICAgIC8vICAgZmlsdGVyVGV4dCA9IHJlcXVpcmUoJy4vZmItaXNGQlByb2Nlc3NOYW1lJykuRkJfUFJPQ0VTU19OQU1FX1JFR0VYX1NUUklORztcclxuICAgIC8vIH0gY2F0Y2ggKGUpIHt9XHJcblxyXG4gICAgdGhpcy5zdGF0ZSA9IHtcclxuICAgICAgc2VsZWN0ZWREZXZpY2VTZXJpYWw6IG51bGwsXHJcbiAgICAgIGphdmFQcm9jZXNzZXM6IEV4cGVjdC52YWx1ZShbXSksXHJcbiAgICAgIHNlbGVjdGVkUHJvY2VzczogbnVsbCxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzTmFtZTogbnVsbCxcclxuICAgICAgc29ydGVkQ29sdW1uOiAnbmFtZScsXHJcbiAgICAgIHNvcnREZXNjZW5kaW5nOiBmYWxzZSxcclxuICAgICAgZmlsdGVyVGV4dCxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIHNldFN0YXRlKHBhcnRpYWxTdGF0ZTogT2JqZWN0LCBjYWxsYmFjaz86ICgpID0+IG1peGVkKTogdm9pZCB7XHJcbiAgICBjb25zdCBmdWxsU3RhdGU6IFN0YXRlID0ge1xyXG4gICAgICAuLi50aGlzLnN0YXRlLFxyXG4gICAgICAuLi5wYXJ0aWFsU3RhdGUsXHJcbiAgICB9O1xyXG4gICAgc3VwZXIuc2V0U3RhdGUoZnVsbFN0YXRlLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMucHJvcHMub25TZWxlY3QoXHJcbiAgICAgICAgZnVsbFN0YXRlLnNlbGVjdGVkRGV2aWNlU2VyaWFsLFxyXG4gICAgICAgIGZ1bGxTdGF0ZS5zZWxlY3RlZFByb2Nlc3MsXHJcbiAgICAgICk7XHJcbiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9oYW5kbGVEZXZpY2VDaGFuZ2UgPSAoZGV2aWNlOiA/QWRiRGV2aWNlKTogdm9pZCA9PiB7XHJcbiAgICBjb25zdCBvbGREZXZpY2VTZXJpYWwgPSB0aGlzLnN0YXRlLnNlbGVjdGVkRGV2aWNlU2VyaWFsO1xyXG4gICAgaWYgKFxyXG4gICAgICBvbGREZXZpY2VTZXJpYWwgIT0gbnVsbCAmJlxyXG4gICAgICBkZXZpY2UgIT0gbnVsbCAmJlxyXG4gICAgICBvbGREZXZpY2VTZXJpYWwgPT09IGRldmljZS5zZXJpYWxcclxuICAgICkge1xyXG4gICAgICAvLyBTYW1lIGRldmljZSBzZWxlY3RlZC5cclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9qYXZhUHJvY2Vzc1N1YnNjcmlwdGlvbiAhPSBudWxsKSB7XHJcbiAgICAgIHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuX2phdmFQcm9jZXNzU3Vic2NyaXB0aW9uID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnNldFN0YXRlKFxyXG4gICAgICB7XHJcbiAgICAgICAgc2VsZWN0ZWREZXZpY2VTZXJpYWw6IGRldmljZT8uc2VyaWFsLFxyXG4gICAgICAgIGphdmFQcm9jZXNzZXM6IGRldmljZSA9PSBudWxsID8gRXhwZWN0LnZhbHVlKFtdKSA6IEV4cGVjdC5wZW5kaW5nKCksXHJcbiAgICAgICAgc2VsZWN0ZWRQcm9jZXNzOiBudWxsLFxyXG4gICAgICAgIHNlbGVjdGVkUHJvY2Vzc05hbWU6IHRoaXMucHJvcHMuZGVzZXJpYWxpemUoKSxcclxuICAgICAgfSxcclxuICAgICAgKCkgPT4ge1xyXG4gICAgICAgIGlmIChkZXZpY2UgIT0gbnVsbCkge1xyXG4gICAgICAgICAgLy8gSWYgYSBkZXZpY2UgaXMgc2VsZWN0ZWQsIG9ic2VydmUgdGhlIEphdmEgcHJvY2Vzc2VzIG9uIHRoZSBkZXZpY2UuXHJcbiAgICAgICAgICBjb25zdCBhZGJTZXJ2aWNlID0gZ2V0QWRiU2VydmljZUJ5TnVjbGlkZVVyaSh0aGlzLnByb3BzLnRhcmdldFVyaSk7XHJcbiAgICAgICAgICB0aGlzLl9qYXZhUHJvY2Vzc1N1YnNjcmlwdGlvbiA9IE9ic2VydmFibGUuaW50ZXJ2YWwoMjAwMClcclxuICAgICAgICAgICAgLnN0YXJ0V2l0aCgwKVxyXG4gICAgICAgICAgICAuc3dpdGNoTWFwKCgpID0+XHJcbiAgICAgICAgICAgICAgYWRiU2VydmljZS5nZXRKYXZhUHJvY2Vzc2VzKGRldmljZS5zZXJpYWwpLnJlZkNvdW50KCksXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLmRpc3RpbmN0VW50aWxDaGFuZ2VkKChhLCBiKSA9PlxyXG4gICAgICAgICAgICAgIGFycmF5RXF1YWwoYSwgYiwgKHgsIHkpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgICAgICAgIHgudXNlciA9PT0geS51c2VyICYmIHgucGlkID09PSB5LnBpZCAmJiB4Lm5hbWUgPT09IHkubmFtZVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAuc3Vic2NyaWJlKGphdmFQcm9jZXNzZXMgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMuX2phdmFQcm9jZXNzTGlzdENoYW5nZWQoRXhwZWN0LnZhbHVlKGphdmFQcm9jZXNzZXMpKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgKTtcclxuICB9O1xyXG5cclxuICBfamF2YVByb2Nlc3NMaXN0Q2hhbmdlZChqYXZhUHJvY2Vzc2VzOiBFeHBlY3RlZDxBcnJheTxBbmRyb2lkSmF2YVByb2Nlc3M+Pikge1xyXG4gICAgY29uc3Qgc2VsZWN0ZWRQaWQgPSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvY2Vzcz8ucGlkO1xyXG4gICAgY29uc3Qgc2VsZWN0ZWRQcm9jZXNzID0gamF2YVByb2Nlc3Nlc1xyXG4gICAgICAuZ2V0T3JEZWZhdWx0KFtdKVxyXG4gICAgICAuZmluZChcclxuICAgICAgICBwcm9jZXNzID0+XHJcbiAgICAgICAgICB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvY2Vzc05hbWUgIT0gbnVsbFxyXG4gICAgICAgICAgICA/IHByb2Nlc3MubmFtZSA9PT0gdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2Nlc3NOYW1lXHJcbiAgICAgICAgICAgIDogcHJvY2Vzcy5waWQgPT09IHNlbGVjdGVkUGlkLFxyXG4gICAgICApO1xyXG5cclxuICAgIHRoaXMuc2V0U3RhdGUoe1xyXG4gICAgICBqYXZhUHJvY2Vzc2VzLFxyXG4gICAgICBzZWxlY3RlZFByb2Nlc3MsXHJcbiAgICAgIHNlbGVjdGVkUHJvY2Vzc05hbWU6IHNlbGVjdGVkUHJvY2Vzcz8ubmFtZSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgX2ZpbHRlckphdmFQcm9jZXNzZXMoZmlsdGVyVGV4dDogc3RyaW5nKSB7XHJcbiAgICAvLyBTaG93IGFsbCByZXN1bHRzIGlmIGludmFsaWQgcmVnZXhcclxuICAgIGxldCBmaWx0ZXJSZWdleDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGZpbHRlclJlZ2V4ID0gbmV3IFJlZ0V4cChmaWx0ZXJUZXh0LCAnaScpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5zdGF0ZS5qYXZhUHJvY2Vzc2VzLmdldE9yRGVmYXVsdChbXSk7XHJcbiAgICB9XHJcbiAgICAvLyAkRmxvd0ZpeE1lICg+PTAuODUuMCkgKFQzNTk4Njg5NikgRmxvdyB1cGdyYWRlIHN1cHByZXNzXHJcbiAgICByZXR1cm4gdGhpcy5zdGF0ZS5qYXZhUHJvY2Vzc2VzXHJcbiAgICAgIC5nZXRPckRlZmF1bHQoW10pXHJcbiAgICAgIC5maWx0ZXIoXHJcbiAgICAgICAgaXRlbSA9PlxyXG4gICAgICAgICAgZmlsdGVyUmVnZXgudGVzdChpdGVtLnVzZXIpIHx8XHJcbiAgICAgICAgICBmaWx0ZXJSZWdleC50ZXN0KGl0ZW0ucGlkKSB8fFxyXG4gICAgICAgICAgZmlsdGVyUmVnZXgudGVzdChpdGVtLm5hbWUpLFxyXG4gICAgICApO1xyXG4gIH1cclxuXHJcbiAgX2hhbmRsZUZpbHRlclRleHRDaGFuZ2UgPSAoZmlsdGVyVGV4dDogc3RyaW5nKTogdm9pZCA9PiB7XHJcbiAgICAvLyBDaGVjayBpZiB3ZSd2ZSBmaWx0ZXJlZCBkb3duIHRvIG9uZSBvcHRpb24gYW5kIHNlbGVjdCBpZiBzb1xyXG5cclxuICAgIGNvbnN0IGZpbHRlcmVkUHJvY2Vzc2VzID0gdGhpcy5fZmlsdGVySmF2YVByb2Nlc3NlcyhmaWx0ZXJUZXh0KTtcclxuICAgIC8vIFRPRE86IChnb29tKSB0aGlzIHNldFN0YXRlIGRlcGVuZHMgb24gY3VycmVudCBzdGF0ZVxyXG4gICAgLy8gYW5kIHNob3VsZCB1c2UgYW4gdXBkYXRlciBmdW5jdGlvbiByYXRoZXIgdGhhbiBhbiBvYmplY3RcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC9uby1hY2Nlc3Mtc3RhdGUtaW4tc2V0c3RhdGVcclxuICAgIGxldCBzZWxlY3RlZFByb2Nlc3MgPSB0aGlzLnN0YXRlLnNlbGVjdGVkUHJvY2VzcztcclxuICAgIGlmIChmaWx0ZXJlZFByb2Nlc3Nlcy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgLy8gQ2hlY2sgaWYgd2UndmUgZmlsdGVyZWQgZG93biB0byBvbmUgb3B0aW9uIGFuZCBzZWxlY3QgaWYgc29cclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzID0gZmlsdGVyZWRQcm9jZXNzZXNbMF07XHJcbiAgICB9IGVsc2UgaWYgKFxyXG4gICAgICBmaWx0ZXJlZFByb2Nlc3Nlcy5maW5kSW5kZXgoXHJcbiAgICAgICAgcHJvY2Vzc1JvdyA9PiBzZWxlY3RlZFByb2Nlc3M/LnBpZCA9PT0gcHJvY2Vzc1Jvdy5waWQsXHJcbiAgICAgICkgPT09IC0xXHJcbiAgICApIHtcclxuICAgICAgLy8gSWYgd2UgZmlsdGVyIG91dCBvdXIgY3VycmVudCBzZWxlY3Rpb24sXHJcbiAgICAgIC8vICAgc2V0IG91ciBjdXJyZW50IHNlbGVjdGlvbiB0byBudWxsXHJcbiAgICAgIHNlbGVjdGVkUHJvY2VzcyA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgIGZpbHRlclRleHQsXHJcbiAgICAgIHNlbGVjdGVkUHJvY2VzcyxcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIF9nZXRDb2x1bW5zKCk6IEFycmF5PENvbHVtbjwqPj4ge1xyXG4gICAgcmV0dXJuIFtcclxuICAgICAge1xyXG4gICAgICAgIGtleTogJ3BpZCcsXHJcbiAgICAgICAgdGl0bGU6ICdQSUQnLFxyXG4gICAgICAgIHdpZHRoOiAwLjEsXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBrZXk6ICd1c2VyJyxcclxuICAgICAgICB0aXRsZTogJ1VzZXInLFxyXG4gICAgICAgIHdpZHRoOiAwLjEsXHJcbiAgICAgIH0sXHJcbiAgICAgIHtcclxuICAgICAgICBrZXk6ICduYW1lJyxcclxuICAgICAgICB0aXRsZTogJ05hbWUnLFxyXG4gICAgICAgIHdpZHRoOiAwLjgsXHJcbiAgICAgIH0sXHJcbiAgICBdO1xyXG4gIH1cclxuXHJcbiAgX2hhbmRsZVNvcnQgPSAoc29ydGVkQ29sdW1uOiA/Q29sdW1uTmFtZSwgc29ydERlc2NlbmRpbmc6IGJvb2xlYW4pOiB2b2lkID0+IHtcclxuICAgIHRoaXMuc2V0U3RhdGUoe3NvcnRlZENvbHVtbiwgc29ydERlc2NlbmRpbmd9KTtcclxuICB9O1xyXG5cclxuICBfc29ydFJvd3MgPSAoXHJcbiAgICBwcm9jZXNzZXM6IEFycmF5PFJvdzwqPj4sXHJcbiAgICBzb3J0ZWRDb2x1bW5OYW1lOiA/Q29sdW1uTmFtZSxcclxuICAgIHNvcnREZXNjZW5kaW5nOiBib29sZWFuLFxyXG4gICk6IEFycmF5PFJvdzwqPj4gPT4ge1xyXG4gICAgaWYgKHNvcnRlZENvbHVtbk5hbWUgPT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gcHJvY2Vzc2VzO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVzZSBhIG51bWVyaWNhbCBjb21wYXJpc29uIGZvciB0aGUgcGlkIGNvbHVtbiwgc3RyaW5nIGNvbXBhcmUgZm9yIGFsbCB0aGUgb3RoZXJzLlxyXG4gICAgY29uc3QgY29tcGFyZTogYW55ID1cclxuICAgICAgc29ydGVkQ29sdW1uTmFtZSA9PT0gJ3BpZCdcclxuICAgICAgICA/IChhOiA/bnVtYmVyLCBiOiA/bnVtYmVyLCBpc0FzYzogYm9vbGVhbik6IG51bWJlciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNtcCA9IChhIHx8IDApIC0gKGIgfHwgMCk7XHJcbiAgICAgICAgICAgIHJldHVybiBpc0FzYyA/IGNtcCA6IC1jbXA7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgOiAoYTogP3N0cmluZywgYjogP3N0cmluZywgaXNBc2M6IGJvb2xlYW4pOiBudW1iZXIgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBjbXAgPSBTdHJpbmcoYSlcclxuICAgICAgICAgICAgICAudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICAgIC5sb2NhbGVDb21wYXJlKFN0cmluZyhiKS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgcmV0dXJuIGlzQXNjID8gY21wIDogLWNtcDtcclxuICAgICAgICAgIH07XHJcblxyXG4gICAgY29uc3QgZ2V0dGVyID0gcm93ID0+IHJvdy5kYXRhW3NvcnRlZENvbHVtbk5hbWVdO1xyXG4gICAgcmV0dXJuIFsuLi5wcm9jZXNzZXNdLnNvcnQoKGEsIGIpID0+IHtcclxuICAgICAgcmV0dXJuIGNvbXBhcmUoZ2V0dGVyKGEpLCBnZXR0ZXIoYiksICFzb3J0RGVzY2VuZGluZyk7XHJcbiAgICB9KTtcclxuICB9O1xyXG5cclxuICBfaGFuZGxlU2VsZWN0VGFibGVSb3cgPSAoXHJcbiAgICBpdGVtOiA/QW5kcm9pZEphdmFQcm9jZXNzLFxyXG4gICAgc2VsZWN0ZWRJbmRleDogbnVtYmVyLFxyXG4gICk6IHZvaWQgPT4ge1xyXG4gICAgdGhpcy5zZXRTdGF0ZSh7XHJcbiAgICAgIHNlbGVjdGVkUHJvY2VzczogaXRlbSxcclxuICAgICAgc2VsZWN0ZWRQcm9jZXNzTmFtZTogaWR4KGl0ZW0sIF8gPT4gXy5uYW1lKSxcclxuICAgIH0pO1xyXG4gIH07XHJcblxyXG4gIHJlbmRlcigpOiBSZWFjdC5Ob2RlIHtcclxuICAgIGNvbnN0IGVtcHR5TWVzc2FnZTogc3RyaW5nID1cclxuICAgICAgdGhpcy5zdGF0ZS5zZWxlY3RlZERldmljZVNlcmlhbCA9PSBudWxsXHJcbiAgICAgICAgPyAnTm8gZGV2aWNlIHNlbGVjdGVkJ1xyXG4gICAgICAgIDogJ05vIGRlYnVnZ2FibGUgSmF2YSBwcm9jZXNzZXMgZm91bmQhJztcclxuICAgIGNvbnN0IGVtcHR5Q29tcG9uZW50ID0gKCkgPT4gKFxyXG4gICAgICA8ZGl2PlxyXG4gICAgICAgIHt0aGlzLnN0YXRlLmphdmFQcm9jZXNzZXMuaXNQZW5kaW5nID8gKFxyXG4gICAgICAgICAgPExvYWRpbmdTcGlubmVyIHNpemU9XCJFWFRSQV9TTUFMTFwiIC8+XHJcbiAgICAgICAgKSA6IChcclxuICAgICAgICAgIGVtcHR5TWVzc2FnZVxyXG4gICAgICAgICl9XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBwcm9jZXNzTGlzdFJvd3MgPSB0aGlzLl9zb3J0Um93cyhcclxuICAgICAgdGhpcy5fZmlsdGVySmF2YVByb2Nlc3Nlcyh0aGlzLnN0YXRlLmZpbHRlclRleHQpLm1hcChwcm9jZXNzUm93ID0+IHtcclxuICAgICAgICBjb25zdCBkYXRhID0ge1xyXG4gICAgICAgICAgcGlkOiBwcm9jZXNzUm93LnBpZCxcclxuICAgICAgICAgIHVzZXI6IHByb2Nlc3NSb3cudXNlcixcclxuICAgICAgICAgIG5hbWU6IHByb2Nlc3NSb3cubmFtZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBkYXRhLFxyXG4gICAgICAgIH07XHJcbiAgICAgIH0pLFxyXG4gICAgICB0aGlzLnN0YXRlLnNvcnRlZENvbHVtbixcclxuICAgICAgdGhpcy5zdGF0ZS5zb3J0RGVzY2VuZGluZyxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3Qgc2VsZWN0ZWRSb3dJbmRleCA9IHByb2Nlc3NMaXN0Um93cy5maW5kSW5kZXgoXHJcbiAgICAgIHJvdyA9PlxyXG4gICAgICAgIHJvdy5kYXRhLnBpZCA9PT0gdGhpcy5zdGF0ZS5zZWxlY3RlZFByb2Nlc3M/LnBpZCAmJlxyXG4gICAgICAgIHJvdy5kYXRhLm5hbWUgPT09IHRoaXMuc3RhdGUuc2VsZWN0ZWRQcm9jZXNzPy5uYW1lLFxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICA8ZGl2IGNsYXNzTmFtZT1cImJsb2NrXCI+XHJcbiAgICAgICAgPGxhYmVsPkRldmljZTo8L2xhYmVsPlxyXG4gICAgICAgIDxBZGJEZXZpY2VTZWxlY3RvclxyXG4gICAgICAgICAgb25DaGFuZ2U9e3RoaXMuX2hhbmRsZURldmljZUNoYW5nZX1cclxuICAgICAgICAgIHRhcmdldFVyaT17dGhpcy5wcm9wcy50YXJnZXRVcml9XHJcbiAgICAgICAgLz5cclxuICAgICAgICA8bGFiZWw+RGVidWdnYWJsZSBKYXZhIHByb2Nlc3NlczogPC9sYWJlbD5cclxuICAgICAgICA8QXRvbUlucHV0XHJcbiAgICAgICAgICBwbGFjZWhvbGRlclRleHQ9XCJTZWFyY2ggd2l0aCByZWd1bGFyIGV4cHJlc3Npb24uLi5cIlxyXG4gICAgICAgICAgdmFsdWU9e3RoaXMuc3RhdGUuZmlsdGVyVGV4dH1cclxuICAgICAgICAgIG9uRGlkQ2hhbmdlPXt0aGlzLl9oYW5kbGVGaWx0ZXJUZXh0Q2hhbmdlfVxyXG4gICAgICAgICAgc2l6ZT1cInNtXCJcclxuICAgICAgICAgIGF1dG9mb2N1cz17dHJ1ZX1cclxuICAgICAgICAvPlxyXG4gICAgICAgIDxUYWJsZVxyXG4gICAgICAgICAgY29sbGFwc2FibGU9e2ZhbHNlfVxyXG4gICAgICAgICAgY29sdW1ucz17dGhpcy5fZ2V0Q29sdW1ucygpfVxyXG4gICAgICAgICAgZW1wdHlDb21wb25lbnQ9e2VtcHR5Q29tcG9uZW50fVxyXG4gICAgICAgICAgZml4ZWRIZWFkZXI9e3RydWV9XHJcbiAgICAgICAgICBtYXhCb2R5SGVpZ2h0PVwiMzBlbVwiXHJcbiAgICAgICAgICByb3dzPXtwcm9jZXNzTGlzdFJvd3N9XHJcbiAgICAgICAgICBzb3J0YWJsZT17dHJ1ZX1cclxuICAgICAgICAgIG9uU29ydD17dGhpcy5faGFuZGxlU29ydH1cclxuICAgICAgICAgIHNvcnRlZENvbHVtbj17dGhpcy5zdGF0ZS5zb3J0ZWRDb2x1bW59XHJcbiAgICAgICAgICBzb3J0RGVzY2VuZGluZz17dGhpcy5zdGF0ZS5zb3J0RGVzY2VuZGluZ31cclxuICAgICAgICAgIHNlbGVjdGFibGU9e3RydWV9XHJcbiAgICAgICAgICBzZWxlY3RlZEluZGV4PXtzZWxlY3RlZFJvd0luZGV4fVxyXG4gICAgICAgICAgb25TZWxlY3Q9e3RoaXMuX2hhbmRsZVNlbGVjdFRhYmxlUm93fVxyXG4gICAgICAgIC8+XHJcbiAgICAgIDwvZGl2PlxyXG4gICAgKTtcclxuICB9XHJcbn1cclxuIl19