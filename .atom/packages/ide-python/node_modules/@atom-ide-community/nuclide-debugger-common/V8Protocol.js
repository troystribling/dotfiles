"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var DebugProtocol = _interopRequireWildcard(require("vscode-debugprotocol"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function () { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
const TWO_CRLF = '\r\n\r\n';
/**
 * JSON-RPC protocol implementation over a read and write buffers.
 */

class V8Protocol {
  constructor(id, logger, sendPreprocessors, receivePreprocessors) {
    this._id = void 0;
    this._output = void 0;
    this._sequence = void 0;
    this._pendingRequests = void 0;
    this._rawData = void 0;
    this._contentLength = void 0;
    this._logger = void 0;
    this._sendPreprocessors = void 0;
    this._receivePreprocessors = void 0;
    this._id = id;
    this._logger = logger;
    this._sendPreprocessors = sendPreprocessors;
    this._receivePreprocessors = receivePreprocessors;
    this._sequence = 1;
    this._contentLength = -1;
    this._pendingRequests = new Map();
    this._rawData = new Buffer(0);
  }

  getId() {
    return this._id;
  }

  onServerError(error) {
    throw new Error('No implementation found!');
  }

  onEvent(event) {
    throw new Error('No implementation found!');
  }

  async dispatchRequest(request, response) {
    throw new Error('No implementation found!');
  }

  setOutput(output) {
    this._output = output;
  }

  send(command, args) {
    return new Promise((resolve, reject) => {
      this._doSend(command, args, result => {
        if (result.success) {
          resolve(result);
        } else {
          reject(result);
        }
      });
    });
  }

  sendResponse(response) {
    if (response.seq > 0) {
      this._logger.error(`attempt to send more than one response for command ${response.command}`);
    } else {
      this._sendMessage('response', response);
    }
  }

  _doSend(command, args, clb) {
    const request = {
      command
    };

    if (args && Object.keys(args).length > 0) {
      request.arguments = args;
    }

    this._sendMessage('request', request);

    if (clb) {
      // store callback for this request
      this._pendingRequests.set(request.seq, clb);
    }
  }

  _sendMessage(typ, message) {
    message.type = typ;
    message.seq = this._sequence++;

    this._sendPreprocessors.forEach(processor => processor(message));

    const json = JSON.stringify(message);
    const length = Buffer.byteLength(json, 'utf8');
    const packet = `Content-Length: ${length.toString()}${TWO_CRLF}${json}`;

    this._logger.info(`Sending: ${packet}`);

    this._output(packet);
  }

  handleData(data) {
    this._rawData = Buffer.concat([this._rawData, data]);

    while (true) {
      if (this._contentLength >= 0) {
        if (this._rawData.length >= this._contentLength) {
          const message = this._rawData.toString('utf8', 0, this._contentLength);

          this._rawData = this._rawData.slice(this._contentLength);
          this._contentLength = -1;

          if (message.length > 0) {
            this._logger.info(`Received message: ${message}`);

            this._dispatch(message);
          }

          continue; // there may be more complete messages to process
        }
      } else {
        const s = this._rawData.toString('utf8', 0, this._rawData.length);

        const idx = s.indexOf(TWO_CRLF);

        if (idx !== -1) {
          const match = /Content-Length: (\d+)/.exec(s);

          if (match && match[1]) {
            this._contentLength = Number(match[1]);
            this._rawData = this._rawData.slice(idx + TWO_CRLF.length);
            continue; // try to handle a complete message
          }
        }
      }

      break;
    }
  }

  _dispatch(body) {
    try {
      const rawData = JSON.parse(body);

      this._receivePreprocessors.forEach(processor => processor(rawData));

      switch (rawData.type) {
        case 'event':
          this.onEvent(rawData);
          break;

        case 'response':
          const response = rawData;

          const clb = this._pendingRequests.get(response.request_seq);

          if (clb) {
            this._pendingRequests.delete(response.request_seq);

            clb(response);
          }

          break;

        case 'request':
          const request = rawData;
          const resp = {
            type: 'response',
            seq: 0,
            command: request.command,
            request_seq: request.seq,
            success: true
          };
          this.dispatchRequest(request, resp);
          break;
      }
    } catch (e) {
      this.onServerError(new Error(e.message || e));
    }
  }

}

exports.default = V8Protocol;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL251Y2xpZGUvbnVjbGlkZS1kZWJ1Z2dlci1jb21tb24vVjhQcm90b2NvbC5qcyJdLCJuYW1lcyI6WyJUV09fQ1JMRiIsIlY4UHJvdG9jb2wiLCJjb25zdHJ1Y3RvciIsImlkIiwibG9nZ2VyIiwic2VuZFByZXByb2Nlc3NvcnMiLCJyZWNlaXZlUHJlcHJvY2Vzc29ycyIsIl9pZCIsIl9vdXRwdXQiLCJfc2VxdWVuY2UiLCJfcGVuZGluZ1JlcXVlc3RzIiwiX3Jhd0RhdGEiLCJfY29udGVudExlbmd0aCIsIl9sb2dnZXIiLCJfc2VuZFByZXByb2Nlc3NvcnMiLCJfcmVjZWl2ZVByZXByb2Nlc3NvcnMiLCJNYXAiLCJCdWZmZXIiLCJnZXRJZCIsIm9uU2VydmVyRXJyb3IiLCJlcnJvciIsIkVycm9yIiwib25FdmVudCIsImV2ZW50IiwiZGlzcGF0Y2hSZXF1ZXN0IiwicmVxdWVzdCIsInJlc3BvbnNlIiwic2V0T3V0cHV0Iiwib3V0cHV0Iiwic2VuZCIsImNvbW1hbmQiLCJhcmdzIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJfZG9TZW5kIiwicmVzdWx0Iiwic3VjY2VzcyIsInNlbmRSZXNwb25zZSIsInNlcSIsIl9zZW5kTWVzc2FnZSIsImNsYiIsIk9iamVjdCIsImtleXMiLCJsZW5ndGgiLCJhcmd1bWVudHMiLCJzZXQiLCJ0eXAiLCJtZXNzYWdlIiwidHlwZSIsImZvckVhY2giLCJwcm9jZXNzb3IiLCJqc29uIiwiSlNPTiIsInN0cmluZ2lmeSIsImJ5dGVMZW5ndGgiLCJwYWNrZXQiLCJ0b1N0cmluZyIsImluZm8iLCJoYW5kbGVEYXRhIiwiZGF0YSIsImNvbmNhdCIsInNsaWNlIiwiX2Rpc3BhdGNoIiwicyIsImlkeCIsImluZGV4T2YiLCJtYXRjaCIsImV4ZWMiLCJOdW1iZXIiLCJib2R5IiwicmF3RGF0YSIsInBhcnNlIiwiZ2V0IiwicmVxdWVzdF9zZXEiLCJkZWxldGUiLCJyZXNwIiwiZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7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KSAyMDE3LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXHJcbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxyXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcclxuICogb2YgcGF0ZW50IHJpZ2h0cyBjYW4gYmUgZm91bmQgaW4gdGhlIFBBVEVOVFMgZmlsZSBpbiB0aGUgc2FtZSBkaXJlY3RvcnkuXHJcbiAqXHJcbiAqIEBmbG93XHJcbiAqIEBmb3JtYXRcclxuICovXHJcblxyXG5pbXBvcnQgdHlwZSB7TWVzc2FnZVByb2Nlc3Nvcn0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCAqIGFzIERlYnVnUHJvdG9jb2wgZnJvbSAndnNjb2RlLWRlYnVncHJvdG9jb2wnO1xyXG5cclxuY29uc3QgVFdPX0NSTEYgPSAnXFxyXFxuXFxyXFxuJztcclxuXHJcbi8qKlxyXG4gKiBKU09OLVJQQyBwcm90b2NvbCBpbXBsZW1lbnRhdGlvbiBvdmVyIGEgcmVhZCBhbmQgd3JpdGUgYnVmZmVycy5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFY4UHJvdG9jb2wge1xyXG4gIF9pZDogc3RyaW5nO1xyXG4gIF9vdXRwdXQ6IChpbnB1dDogc3RyaW5nKSA9PiBtaXhlZDtcclxuICBfc2VxdWVuY2U6IG51bWJlcjtcclxuICBfcGVuZGluZ1JlcXVlc3RzOiBNYXA8bnVtYmVyLCAoZTogRGVidWdQcm90b2NvbC5SZXNwb25zZSkgPT4gdm9pZD47XHJcbiAgX3Jhd0RhdGE6IEJ1ZmZlcjtcclxuICBfY29udGVudExlbmd0aDogbnVtYmVyO1xyXG4gIF9sb2dnZXI6IGxvZzRqcyRMb2dnZXI7XHJcbiAgX3NlbmRQcmVwcm9jZXNzb3JzOiBNZXNzYWdlUHJvY2Vzc29yW107XHJcbiAgX3JlY2VpdmVQcmVwcm9jZXNzb3JzOiBNZXNzYWdlUHJvY2Vzc29yW107XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgaWQ6IHN0cmluZyxcclxuICAgIGxvZ2dlcjogbG9nNGpzJExvZ2dlcixcclxuICAgIHNlbmRQcmVwcm9jZXNzb3JzOiBNZXNzYWdlUHJvY2Vzc29yW10sXHJcbiAgICByZWNlaXZlUHJlcHJvY2Vzc29yczogTWVzc2FnZVByb2Nlc3NvcltdLFxyXG4gICkge1xyXG4gICAgdGhpcy5faWQgPSBpZDtcclxuICAgIHRoaXMuX2xvZ2dlciA9IGxvZ2dlcjtcclxuICAgIHRoaXMuX3NlbmRQcmVwcm9jZXNzb3JzID0gc2VuZFByZXByb2Nlc3NvcnM7XHJcbiAgICB0aGlzLl9yZWNlaXZlUHJlcHJvY2Vzc29ycyA9IHJlY2VpdmVQcmVwcm9jZXNzb3JzO1xyXG4gICAgdGhpcy5fc2VxdWVuY2UgPSAxO1xyXG4gICAgdGhpcy5fY29udGVudExlbmd0aCA9IC0xO1xyXG4gICAgdGhpcy5fcGVuZGluZ1JlcXVlc3RzID0gbmV3IE1hcCgpO1xyXG4gICAgdGhpcy5fcmF3RGF0YSA9IG5ldyBCdWZmZXIoMCk7XHJcbiAgfVxyXG5cclxuICBnZXRJZCgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuX2lkO1xyXG4gIH1cclxuXHJcbiAgb25TZXJ2ZXJFcnJvcihlcnJvcjogRXJyb3IpOiB2b2lkIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm8gaW1wbGVtZW50YXRpb24gZm91bmQhJyk7XHJcbiAgfVxyXG5cclxuICBvbkV2ZW50KGV2ZW50OiBEZWJ1Z1Byb3RvY29sLkV2ZW50KTogdm9pZCB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGltcGxlbWVudGF0aW9uIGZvdW5kIScpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgZGlzcGF0Y2hSZXF1ZXN0KFxyXG4gICAgcmVxdWVzdDogRGVidWdQcm90b2NvbC5SZXF1ZXN0LFxyXG4gICAgcmVzcG9uc2U6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UsXHJcbiAgKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGltcGxlbWVudGF0aW9uIGZvdW5kIScpO1xyXG4gIH1cclxuXHJcbiAgc2V0T3V0cHV0KG91dHB1dDogKGlucHV0OiBzdHJpbmcpID0+IG1peGVkKTogdm9pZCB7XHJcbiAgICB0aGlzLl9vdXRwdXQgPSBvdXRwdXQ7XHJcbiAgfVxyXG5cclxuICBzZW5kKGNvbW1hbmQ6IHN0cmluZywgYXJnczogYW55KTogUHJvbWlzZTxEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlPiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLl9kb1NlbmQoY29tbWFuZCwgYXJncywgcmVzdWx0ID0+IHtcclxuICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcclxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmVqZWN0KHJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgc2VuZFJlc3BvbnNlKHJlc3BvbnNlOiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKTogdm9pZCB7XHJcbiAgICBpZiAocmVzcG9uc2Uuc2VxID4gMCkge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZXJyb3IoXHJcbiAgICAgICAgYGF0dGVtcHQgdG8gc2VuZCBtb3JlIHRoYW4gb25lIHJlc3BvbnNlIGZvciBjb21tYW5kICR7XHJcbiAgICAgICAgICByZXNwb25zZS5jb21tYW5kXHJcbiAgICAgICAgfWAsXHJcbiAgICAgICk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZSgncmVzcG9uc2UnLCByZXNwb25zZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfZG9TZW5kKFxyXG4gICAgY29tbWFuZDogc3RyaW5nLFxyXG4gICAgYXJnczogYW55LFxyXG4gICAgY2xiOiAocmVzdWx0OiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlKSA9PiB2b2lkLFxyXG4gICk6IHZvaWQge1xyXG4gICAgY29uc3QgcmVxdWVzdDogYW55ID0ge1xyXG4gICAgICBjb21tYW5kLFxyXG4gICAgfTtcclxuICAgIGlmIChhcmdzICYmIE9iamVjdC5rZXlzKGFyZ3MpLmxlbmd0aCA+IDApIHtcclxuICAgICAgcmVxdWVzdC5hcmd1bWVudHMgPSBhcmdzO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX3NlbmRNZXNzYWdlKCdyZXF1ZXN0JywgcmVxdWVzdCk7XHJcblxyXG4gICAgaWYgKGNsYikge1xyXG4gICAgICAvLyBzdG9yZSBjYWxsYmFjayBmb3IgdGhpcyByZXF1ZXN0XHJcbiAgICAgIHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5zZXQocmVxdWVzdC5zZXEsIGNsYik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfc2VuZE1lc3NhZ2UoXHJcbiAgICB0eXA6ICdyZXF1ZXN0JyB8ICdyZXNwb25zZScgfCAnZXZlbnQnLFxyXG4gICAgbWVzc2FnZTogRGVidWdQcm90b2NvbC5Qcm90b2NvbE1lc3NhZ2UsXHJcbiAgKTogdm9pZCB7XHJcbiAgICBtZXNzYWdlLnR5cGUgPSAodHlwOiBhbnkpO1xyXG4gICAgbWVzc2FnZS5zZXEgPSB0aGlzLl9zZXF1ZW5jZSsrO1xyXG5cclxuICAgIHRoaXMuX3NlbmRQcmVwcm9jZXNzb3JzLmZvckVhY2gocHJvY2Vzc29yID0+IHByb2Nlc3NvcihtZXNzYWdlKSk7XHJcbiAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkobWVzc2FnZSk7XHJcbiAgICBjb25zdCBsZW5ndGggPSBCdWZmZXIuYnl0ZUxlbmd0aChqc29uLCAndXRmOCcpO1xyXG5cclxuICAgIGNvbnN0IHBhY2tldCA9IGBDb250ZW50LUxlbmd0aDogJHtsZW5ndGgudG9TdHJpbmcoKX0ke1RXT19DUkxGfSR7anNvbn1gO1xyXG5cclxuICAgIHRoaXMuX2xvZ2dlci5pbmZvKGBTZW5kaW5nOiAke3BhY2tldH1gKTtcclxuXHJcbiAgICB0aGlzLl9vdXRwdXQocGFja2V0KTtcclxuICB9XHJcblxyXG4gIGhhbmRsZURhdGEoZGF0YTogQnVmZmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLl9yYXdEYXRhID0gQnVmZmVyLmNvbmNhdChbdGhpcy5fcmF3RGF0YSwgZGF0YV0pO1xyXG4gICAgd2hpbGUgKHRydWUpIHtcclxuICAgICAgaWYgKHRoaXMuX2NvbnRlbnRMZW5ndGggPj0gMCkge1xyXG4gICAgICAgIGlmICh0aGlzLl9yYXdEYXRhLmxlbmd0aCA+PSB0aGlzLl9jb250ZW50TGVuZ3RoKSB7XHJcbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5fcmF3RGF0YS50b1N0cmluZyhcclxuICAgICAgICAgICAgJ3V0ZjgnLFxyXG4gICAgICAgICAgICAwLFxyXG4gICAgICAgICAgICB0aGlzLl9jb250ZW50TGVuZ3RoLFxyXG4gICAgICAgICAgKTtcclxuICAgICAgICAgIHRoaXMuX3Jhd0RhdGEgPSB0aGlzLl9yYXdEYXRhLnNsaWNlKHRoaXMuX2NvbnRlbnRMZW5ndGgpO1xyXG4gICAgICAgICAgdGhpcy5fY29udGVudExlbmd0aCA9IC0xO1xyXG4gICAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLl9sb2dnZXIuaW5mbyhgUmVjZWl2ZWQgbWVzc2FnZTogJHttZXNzYWdlfWApO1xyXG4gICAgICAgICAgICB0aGlzLl9kaXNwYXRjaChtZXNzYWdlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnRpbnVlOyAvLyB0aGVyZSBtYXkgYmUgbW9yZSBjb21wbGV0ZSBtZXNzYWdlcyB0byBwcm9jZXNzXHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IHMgPSB0aGlzLl9yYXdEYXRhLnRvU3RyaW5nKCd1dGY4JywgMCwgdGhpcy5fcmF3RGF0YS5sZW5ndGgpO1xyXG4gICAgICAgIGNvbnN0IGlkeCA9IHMuaW5kZXhPZihUV09fQ1JMRik7XHJcbiAgICAgICAgaWYgKGlkeCAhPT0gLTEpIHtcclxuICAgICAgICAgIGNvbnN0IG1hdGNoID0gL0NvbnRlbnQtTGVuZ3RoOiAoXFxkKykvLmV4ZWMocyk7XHJcbiAgICAgICAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcclxuICAgICAgICAgICAgdGhpcy5fY29udGVudExlbmd0aCA9IE51bWJlcihtYXRjaFsxXSk7XHJcbiAgICAgICAgICAgIHRoaXMuX3Jhd0RhdGEgPSB0aGlzLl9yYXdEYXRhLnNsaWNlKGlkeCArIFRXT19DUkxGLmxlbmd0aCk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlOyAvLyB0cnkgdG8gaGFuZGxlIGEgY29tcGxldGUgbWVzc2FnZVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIF9kaXNwYXRjaChib2R5OiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHJhd0RhdGEgPSBKU09OLnBhcnNlKGJvZHkpO1xyXG4gICAgICB0aGlzLl9yZWNlaXZlUHJlcHJvY2Vzc29ycy5mb3JFYWNoKHByb2Nlc3NvciA9PiBwcm9jZXNzb3IocmF3RGF0YSkpO1xyXG5cclxuICAgICAgc3dpdGNoIChyYXdEYXRhLnR5cGUpIHtcclxuICAgICAgICBjYXNlICdldmVudCc6XHJcbiAgICAgICAgICB0aGlzLm9uRXZlbnQoKHJhd0RhdGE6IERlYnVnUHJvdG9jb2wuRXZlbnQpKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3Jlc3BvbnNlJzpcclxuICAgICAgICAgIGNvbnN0IHJlc3BvbnNlOiBEZWJ1Z1Byb3RvY29sLlJlc3BvbnNlID0gcmF3RGF0YTtcclxuICAgICAgICAgIGNvbnN0IGNsYiA9IHRoaXMuX3BlbmRpbmdSZXF1ZXN0cy5nZXQocmVzcG9uc2UucmVxdWVzdF9zZXEpO1xyXG4gICAgICAgICAgaWYgKGNsYikge1xyXG4gICAgICAgICAgICB0aGlzLl9wZW5kaW5nUmVxdWVzdHMuZGVsZXRlKHJlc3BvbnNlLnJlcXVlc3Rfc2VxKTtcclxuICAgICAgICAgICAgY2xiKHJlc3BvbnNlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ3JlcXVlc3QnOlxyXG4gICAgICAgICAgY29uc3QgcmVxdWVzdDogRGVidWdQcm90b2NvbC5SZXF1ZXN0ID0gcmF3RGF0YTtcclxuICAgICAgICAgIGNvbnN0IHJlc3A6IERlYnVnUHJvdG9jb2wuUmVzcG9uc2UgPSB7XHJcbiAgICAgICAgICAgIHR5cGU6ICdyZXNwb25zZScsXHJcbiAgICAgICAgICAgIHNlcTogMCxcclxuICAgICAgICAgICAgY29tbWFuZDogcmVxdWVzdC5jb21tYW5kLFxyXG4gICAgICAgICAgICByZXF1ZXN0X3NlcTogcmVxdWVzdC5zZXEsXHJcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgdGhpcy5kaXNwYXRjaFJlcXVlc3QocmVxdWVzdCwgcmVzcCk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICB0aGlzLm9uU2VydmVyRXJyb3IobmV3IEVycm9yKGUubWVzc2FnZSB8fCBlKSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==