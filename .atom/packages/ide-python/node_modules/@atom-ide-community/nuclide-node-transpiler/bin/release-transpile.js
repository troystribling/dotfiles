#!/usr/bin/env node

/**
 * Copyright (c) 2017-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 * @format
 */
'use strict';
/* eslint nuclide-internal/no-commonjs: 0 */

/* eslint-disable no-console */
// This file is both the main and worker process.

if (process.send) {
  runChild();
} else {
  runParent();
}

function runParent() {
  const argv = require('yargs').usage('Usage: $0 [directory] [options]').option('overwrite', {
    describe: 'Overwrite original files with transpile output.',
    type: 'boolean'
  }).help('help').argv;

  const assert = require('assert');

  const child_process = require('child_process');

  const fs = require('fs');

  const os = require('os');

  const path = require('path');

  const pathRules = require('../lib/path-rules');

  const developmentFilePath = path.join(__dirname, '../../../DEVELOPMENT');
  const cpus = os.cpus();
  const numWorkers = cpus ? Math.max(cpus.length - 1, 1) : 1;
  const count = {
    skipped: 0,
    transpiled: 0
  };
  const directory = argv._[0] && path.resolve(argv._[0]);
  const jsFiles = pathRules.getIncludedFiles(directory); // Sanity checks

  jsFiles.forEach(filename => {
    assert(path.isAbsolute(filename));
  });
  console.log('%s workers. %s files...', numWorkers, jsFiles.length);

  const ProgressBar = require('progress');

  const progressBar = new ProgressBar('transpiling [:bar] (:current/:total) :etas', {
    complete: '=',
    incomplete: ' ',
    width: 20,
    total: jsFiles.length
  });

  for (let i = 0; i < numWorkers; i++) {
    child_process.fork(__filename).on('message', function (m) {
      if (m.transpiled === true) {
        count.transpiled++;
        progressBar.tick();
      } else if (m.skipped === true) {
        count.skipped++;
        progressBar.tick();
      }

      if (jsFiles.length) {
        this.send({
          cmd: 'next',
          filename: jsFiles.pop()
        });
      } else {
        this.kill();
      }
    }).on('exit', code => {
      if (code) {
        process.exit(code);
      }
    }).send({
      cmd: 'init',
      overwrite: argv.overwrite
    });
  }

  process.once('exit', code => {
    if (code !== 0) {
      return;
    }

    if (argv.overwrite && !directory && fs.existsSync(developmentFilePath)) {
      fs.unlinkSync(developmentFilePath);
    }

    console.log('transpiled: %s | skipped: %s | %ds', count.transpiled, count.skipped, process.uptime().toFixed(2));
  });
}

function runChild() {
  const fs = require('fs');

  const NodeTranspiler = require('../lib/NodeTranspiler');

  const nodeTranspiler = new NodeTranspiler();
  let overwrite;
  process.on('message', m => {
    const res = {};

    if (m.cmd === 'next' && fs.lstatSync(m.filename).isFile()) {
      const src = fs.readFileSync(m.filename);

      if (NodeTranspiler.shouldCompile(src)) {
        const code = nodeTranspiler.transformWithCache(src, m.filename);

        if (overwrite) {
          fs.writeFileSync(m.filename, code);
        }

        res.transpiled = true;
      } else {
        res.skipped = true;
      }
    } else if (m.cmd === 'init') {
      overwrite = m.overwrite;
    }

    process.send(res);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL251Y2xpZGUvbnVjbGlkZS1ub2RlLXRyYW5zcGlsZXIvYmluL3JlbGVhc2UtdHJhbnNwaWxlLmpzIl0sIm5hbWVzIjpbInByb2Nlc3MiLCJzZW5kIiwicnVuQ2hpbGQiLCJydW5QYXJlbnQiLCJhcmd2IiwicmVxdWlyZSIsInVzYWdlIiwib3B0aW9uIiwiZGVzY3JpYmUiLCJ0eXBlIiwiaGVscCIsImFzc2VydCIsImNoaWxkX3Byb2Nlc3MiLCJmcyIsIm9zIiwicGF0aCIsInBhdGhSdWxlcyIsImRldmVsb3BtZW50RmlsZVBhdGgiLCJqb2luIiwiX19kaXJuYW1lIiwiY3B1cyIsIm51bVdvcmtlcnMiLCJNYXRoIiwibWF4IiwibGVuZ3RoIiwiY291bnQiLCJza2lwcGVkIiwidHJhbnNwaWxlZCIsImRpcmVjdG9yeSIsIl8iLCJyZXNvbHZlIiwianNGaWxlcyIsImdldEluY2x1ZGVkRmlsZXMiLCJmb3JFYWNoIiwiZmlsZW5hbWUiLCJpc0Fic29sdXRlIiwiY29uc29sZSIsImxvZyIsIlByb2dyZXNzQmFyIiwicHJvZ3Jlc3NCYXIiLCJjb21wbGV0ZSIsImluY29tcGxldGUiLCJ3aWR0aCIsInRvdGFsIiwiaSIsImZvcmsiLCJfX2ZpbGVuYW1lIiwib24iLCJtIiwidGljayIsImNtZCIsInBvcCIsImtpbGwiLCJjb2RlIiwiZXhpdCIsIm92ZXJ3cml0ZSIsIm9uY2UiLCJleGlzdHNTeW5jIiwidW5saW5rU3luYyIsInVwdGltZSIsInRvRml4ZWQiLCJOb2RlVHJhbnNwaWxlciIsIm5vZGVUcmFuc3BpbGVyIiwicmVzIiwibHN0YXRTeW5jIiwiaXNGaWxlIiwic3JjIiwicmVhZEZpbGVTeW5jIiwic2hvdWxkQ29tcGlsZSIsInRyYW5zZm9ybVdpdGhDYWNoZSIsIndyaXRlRmlsZVN5bmMiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBOztB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RCxHQUFiO0FBQ0QsR0FqQkQ7QUFrQkQiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXHJcbi8qKlxyXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTctcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cclxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuICpcclxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXHJcbiAqIExJQ0VOU0UgZmlsZSBpbiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS4gQW4gYWRkaXRpb25hbCBncmFudFxyXG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cclxuICpcclxuICogQG5vZmxvd1xyXG4gKiBAZm9ybWF0XHJcbiAqL1xyXG4ndXNlIHN0cmljdCc7XHJcblxyXG4vKiBlc2xpbnQgbnVjbGlkZS1pbnRlcm5hbC9uby1jb21tb25qczogMCAqL1xyXG4vKiBlc2xpbnQtZGlzYWJsZSBuby1jb25zb2xlICovXHJcblxyXG4vLyBUaGlzIGZpbGUgaXMgYm90aCB0aGUgbWFpbiBhbmQgd29ya2VyIHByb2Nlc3MuXHJcbmlmIChwcm9jZXNzLnNlbmQpIHtcclxuICBydW5DaGlsZCgpO1xyXG59IGVsc2Uge1xyXG4gIHJ1blBhcmVudCgpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBydW5QYXJlbnQoKSB7XHJcbiAgY29uc3QgYXJndiA9IHJlcXVpcmUoJ3lhcmdzJylcclxuICAgIC51c2FnZSgnVXNhZ2U6ICQwIFtkaXJlY3RvcnldIFtvcHRpb25zXScpXHJcbiAgICAub3B0aW9uKCdvdmVyd3JpdGUnLCB7XHJcbiAgICAgIGRlc2NyaWJlOiAnT3ZlcndyaXRlIG9yaWdpbmFsIGZpbGVzIHdpdGggdHJhbnNwaWxlIG91dHB1dC4nLFxyXG4gICAgICB0eXBlOiAnYm9vbGVhbicsXHJcbiAgICB9KVxyXG4gICAgLmhlbHAoJ2hlbHAnKS5hcmd2O1xyXG5cclxuICBjb25zdCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKTtcclxuICBjb25zdCBjaGlsZF9wcm9jZXNzID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xyXG4gIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcclxuICBjb25zdCBvcyA9IHJlcXVpcmUoJ29zJyk7XHJcbiAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuXHJcbiAgY29uc3QgcGF0aFJ1bGVzID0gcmVxdWlyZSgnLi4vbGliL3BhdGgtcnVsZXMnKTtcclxuXHJcbiAgY29uc3QgZGV2ZWxvcG1lbnRGaWxlUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi8uLi9ERVZFTE9QTUVOVCcpO1xyXG5cclxuICBjb25zdCBjcHVzID0gb3MuY3B1cygpO1xyXG4gIGNvbnN0IG51bVdvcmtlcnMgPSBjcHVzID8gTWF0aC5tYXgoY3B1cy5sZW5ndGggLSAxLCAxKSA6IDE7XHJcblxyXG4gIGNvbnN0IGNvdW50ID0ge1xyXG4gICAgc2tpcHBlZDogMCxcclxuICAgIHRyYW5zcGlsZWQ6IDAsXHJcbiAgfTtcclxuXHJcbiAgY29uc3QgZGlyZWN0b3J5ID0gYXJndi5fWzBdICYmIHBhdGgucmVzb2x2ZShhcmd2Ll9bMF0pO1xyXG4gIGNvbnN0IGpzRmlsZXMgPSBwYXRoUnVsZXMuZ2V0SW5jbHVkZWRGaWxlcyhkaXJlY3RvcnkpO1xyXG5cclxuICAvLyBTYW5pdHkgY2hlY2tzXHJcbiAganNGaWxlcy5mb3JFYWNoKGZpbGVuYW1lID0+IHtcclxuICAgIGFzc2VydChwYXRoLmlzQWJzb2x1dGUoZmlsZW5hbWUpKTtcclxuICB9KTtcclxuXHJcbiAgY29uc29sZS5sb2coJyVzIHdvcmtlcnMuICVzIGZpbGVzLi4uJywgbnVtV29ya2VycywganNGaWxlcy5sZW5ndGgpO1xyXG5cclxuICBjb25zdCBQcm9ncmVzc0JhciA9IHJlcXVpcmUoJ3Byb2dyZXNzJyk7XHJcbiAgY29uc3QgcHJvZ3Jlc3NCYXIgPSBuZXcgUHJvZ3Jlc3NCYXIoXHJcbiAgICAndHJhbnNwaWxpbmcgWzpiYXJdICg6Y3VycmVudC86dG90YWwpIDpldGFzJyxcclxuICAgIHtcclxuICAgICAgY29tcGxldGU6ICc9JyxcclxuICAgICAgaW5jb21wbGV0ZTogJyAnLFxyXG4gICAgICB3aWR0aDogMjAsXHJcbiAgICAgIHRvdGFsOiBqc0ZpbGVzLmxlbmd0aCxcclxuICAgIH0sXHJcbiAgKTtcclxuXHJcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Xb3JrZXJzOyBpKyspIHtcclxuICAgIGNoaWxkX3Byb2Nlc3NcclxuICAgICAgLmZvcmsoX19maWxlbmFtZSlcclxuICAgICAgLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24obSkge1xyXG4gICAgICAgIGlmIChtLnRyYW5zcGlsZWQgPT09IHRydWUpIHtcclxuICAgICAgICAgIGNvdW50LnRyYW5zcGlsZWQrKztcclxuICAgICAgICAgIHByb2dyZXNzQmFyLnRpY2soKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG0uc2tpcHBlZCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgY291bnQuc2tpcHBlZCsrO1xyXG4gICAgICAgICAgcHJvZ3Jlc3NCYXIudGljaygpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoanNGaWxlcy5sZW5ndGgpIHtcclxuICAgICAgICAgIHRoaXMuc2VuZCh7Y21kOiAnbmV4dCcsIGZpbGVuYW1lOiBqc0ZpbGVzLnBvcCgpfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMua2lsbCgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSlcclxuICAgICAgLm9uKCdleGl0JywgY29kZSA9PiB7XHJcbiAgICAgICAgaWYgKGNvZGUpIHtcclxuICAgICAgICAgIHByb2Nlc3MuZXhpdChjb2RlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICAgIC5zZW5kKHtjbWQ6ICdpbml0Jywgb3ZlcndyaXRlOiBhcmd2Lm92ZXJ3cml0ZX0pO1xyXG4gIH1cclxuXHJcbiAgcHJvY2Vzcy5vbmNlKCdleGl0JywgY29kZSA9PiB7XHJcbiAgICBpZiAoY29kZSAhPT0gMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoYXJndi5vdmVyd3JpdGUgJiYgIWRpcmVjdG9yeSAmJiBmcy5leGlzdHNTeW5jKGRldmVsb3BtZW50RmlsZVBhdGgpKSB7XHJcbiAgICAgIGZzLnVubGlua1N5bmMoZGV2ZWxvcG1lbnRGaWxlUGF0aCk7XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLmxvZyhcclxuICAgICAgJ3RyYW5zcGlsZWQ6ICVzIHwgc2tpcHBlZDogJXMgfCAlZHMnLFxyXG4gICAgICBjb3VudC50cmFuc3BpbGVkLFxyXG4gICAgICBjb3VudC5za2lwcGVkLFxyXG4gICAgICBwcm9jZXNzLnVwdGltZSgpLnRvRml4ZWQoMiksXHJcbiAgICApO1xyXG4gIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBydW5DaGlsZCgpIHtcclxuICBjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XHJcblxyXG4gIGNvbnN0IE5vZGVUcmFuc3BpbGVyID0gcmVxdWlyZSgnLi4vbGliL05vZGVUcmFuc3BpbGVyJyk7XHJcbiAgY29uc3Qgbm9kZVRyYW5zcGlsZXIgPSBuZXcgTm9kZVRyYW5zcGlsZXIoKTtcclxuXHJcbiAgbGV0IG92ZXJ3cml0ZTtcclxuXHJcbiAgcHJvY2Vzcy5vbignbWVzc2FnZScsIG0gPT4ge1xyXG4gICAgY29uc3QgcmVzID0ge307XHJcbiAgICBpZiAobS5jbWQgPT09ICduZXh0JyAmJiBmcy5sc3RhdFN5bmMobS5maWxlbmFtZSkuaXNGaWxlKCkpIHtcclxuICAgICAgY29uc3Qgc3JjID0gZnMucmVhZEZpbGVTeW5jKG0uZmlsZW5hbWUpO1xyXG4gICAgICBpZiAoTm9kZVRyYW5zcGlsZXIuc2hvdWxkQ29tcGlsZShzcmMpKSB7XHJcbiAgICAgICAgY29uc3QgY29kZSA9IG5vZGVUcmFuc3BpbGVyLnRyYW5zZm9ybVdpdGhDYWNoZShzcmMsIG0uZmlsZW5hbWUpO1xyXG4gICAgICAgIGlmIChvdmVyd3JpdGUpIHtcclxuICAgICAgICAgIGZzLndyaXRlRmlsZVN5bmMobS5maWxlbmFtZSwgY29kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlcy50cmFuc3BpbGVkID0gdHJ1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXMuc2tpcHBlZCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAobS5jbWQgPT09ICdpbml0Jykge1xyXG4gICAgICBvdmVyd3JpdGUgPSBtLm92ZXJ3cml0ZTtcclxuICAgIH1cclxuICAgIHByb2Nlc3Muc2VuZChyZXMpO1xyXG4gIH0pO1xyXG59XHJcbiJdfQ==