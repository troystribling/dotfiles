import { TextEditor } from "atom";
import { scopeForFenceName, fenceNameForScope } from "./utils";
export async function highlightCodeFragments(domFragment, grammar) {
    const defaultLanguage = fenceNameForScope(grammar || "text.plain");
    const fontFamily = atom.config.get("editor.fontFamily");
    const fontSize = atom.config.get("editor.fontSize");
    if (fontFamily !== null) {
        domFragment.querySelectorAll("code").forEach((codeElement) => {
            codeElement.style.fontFamily = fontFamily;
            codeElement.style.fontSize = `${fontSize}`;
        });
    }
    const elements = [].slice.call(domFragment.querySelectorAll("pre"));
    const promises = elements.map(async (preElement) => {
        var _a, _b, _c, _d, _e, _f;
        const codeBlock = (_a = preElement.firstElementChild) !== null && _a !== void 0 ? _a : preElement;
        const fenceName = (_c = (_b = codeBlock
            .getAttribute("class")) === null || _b === void 0 ? void 0 : _b.replace(/^lang-/, "").replace(/^language-/, "")) !== null && _c !== void 0 ? _c : defaultLanguage;
        preElement.classList.add("editor-colors", `lang-${fenceName}`);
        const editor = new TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            softWrapped: true,
            softWrapAtPreferredLineLength: true,
            preferredLineLength: 80,
        });
        const editorElement = editor.getElement();
        editorElement.setUpdatedSynchronously(true);
        preElement.innerHTML = "";
        (_d = preElement.parentNode) === null || _d === void 0 ? void 0 : _d.insertBefore(editorElement, preElement);
        editor.setText((_f = (_e = codeBlock.textContent) === null || _e === void 0 ? void 0 : _e.replace(/\r?\n$/, "")) !== null && _f !== void 0 ? _f : "");
        atom.grammars.assignLanguageMode(editor.getBuffer(), scopeForFenceName(fenceName));
        editor.setVisible(true);
        return await tokenizeEditor(editorElement, preElement);
    });
    return await Promise.all(promises);
}
export function tokenizeEditor(editorElement, preElement) {
    const p = new Promise((resolve, reject) => {
        const done = () => {
            editorElement.querySelectorAll(".line:not(.dummy)").forEach((line) => {
                var _a, _b;
                const line2 = document.createElement("div");
                line2.className = "line";
                line2.innerHTML = (_b = (_a = line.firstElementChild) === null || _a === void 0 ? void 0 : _a.innerHTML) !== null && _b !== void 0 ? _b : "";
                preElement.appendChild(line2);
            });
            editorElement.remove();
            resolve();
        };
        const editor = editorElement.getModel();
        const languageMode = editor.getBuffer().getLanguageMode();
        if ("fullyTokenized" in languageMode || "tree" in languageMode) {
            editor.component
                .getNextUpdatePromise()
                .then(() => {
                done();
            })
                .catch(reject);
        }
        else {
            editor.onDidTokenize(() => {
                done();
            });
        }
    });
    return p;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3V0aWxzL3JlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsVUFBVSxFQUFxQixNQUFNLE1BQU0sQ0FBQTtBQUNwRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFVOUQsTUFBTSxDQUFDLEtBQUssVUFBVSxzQkFBc0IsQ0FBQyxXQUF3QixFQUFFLE9BQWU7SUFDcEYsTUFBTSxlQUFlLEdBQUcsaUJBQWlCLENBQUMsT0FBTyxJQUFJLFlBQVksQ0FBQyxDQUFBO0lBRWxFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUE7SUFDdkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsQ0FBQTtJQUNuRCxJQUFJLFVBQVUsS0FBSyxJQUFJLEVBQUU7UUFDdkIsV0FBVyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQzNELFdBQVcsQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQTtZQUN6QyxXQUFXLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxHQUFHLFFBQVEsRUFBRSxDQUFBO1FBQzVDLENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFFRCxNQUFNLFFBQVEsR0FBcUIsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7SUFDckYsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUU7O1FBQ2pELE1BQU0sU0FBUyxTQUFHLFVBQVUsQ0FBQyxpQkFBaUIsbUNBQUksVUFBVSxDQUFBO1FBQzVELE1BQU0sU0FBUyxlQUNiLFNBQVM7YUFDTixZQUFZLENBQUMsT0FBTyxDQUFDLDBDQUNwQixPQUFPLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFDckIsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLG9DQUFLLGVBQWUsQ0FBQTtRQUNqRCxVQUFVLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsUUFBUSxTQUFTLEVBQUUsQ0FBQyxDQUFBO1FBRTlELE1BQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDO1lBQzVCLFFBQVEsRUFBRSxJQUFJO1lBQ2Qsb0JBQW9CLEVBQUUsS0FBSztZQUMzQixXQUFXLEVBQUUsSUFBSTtZQUNqQiw2QkFBNkIsRUFBRSxJQUFJO1lBQ25DLG1CQUFtQixFQUFFLEVBQUU7U0FDeEIsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ3pDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUUzQyxVQUFVLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQTtRQUN6QixNQUFBLFVBQVUsQ0FBQyxVQUFVLDBDQUFFLFlBQVksQ0FBQyxhQUFhLEVBQUUsVUFBVSxFQUFDO1FBRTlELE1BQU0sQ0FBQyxPQUFPLGFBQUMsU0FBUyxDQUFDLFdBQVcsMENBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLG9DQUFLLEVBQUUsQ0FBQyxDQUFBO1FBRWxFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxFQUFFLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUE7UUFDbEYsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN2QixPQUFPLE1BQU0sY0FBYyxDQUFDLGFBQWEsRUFBRSxVQUFVLENBQUMsQ0FBQTtJQUN4RCxDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBQ3BDLENBQUM7QUFRRCxNQUFNLFVBQVUsY0FBYyxDQUFDLGFBQWdDLEVBQUUsVUFBMEI7SUFDekYsTUFBTSxDQUFDLEdBQUcsSUFBSSxPQUFPLENBQU8sQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDOUMsTUFBTSxJQUFJLEdBQUcsR0FBRyxFQUFFO1lBQ2hCLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFOztnQkFDbkUsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQTtnQkFDM0MsS0FBSyxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUE7Z0JBQ3hCLEtBQUssQ0FBQyxTQUFTLGVBQUcsSUFBSSxDQUFDLGlCQUFpQiwwQ0FBRSxTQUFTLG1DQUFJLEVBQUUsQ0FBQTtnQkFDekQsVUFBVSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUMvQixDQUFDLENBQUMsQ0FBQTtZQUNGLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQTtZQUN0QixPQUFPLEVBQUUsQ0FBQTtRQUNYLENBQUMsQ0FBQTtRQUNELE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUN2QyxNQUFNLFlBQVksR0FBRyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsZUFBZSxFQUFFLENBQUE7UUFDekQsSUFBSSxnQkFBZ0IsSUFBSSxZQUFZLElBQUksTUFBTSxJQUFJLFlBQVksRUFBRTtZQUM5RCxNQUFNLENBQUMsU0FBUztpQkFDYixvQkFBb0IsRUFBRTtpQkFDdEIsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDVCxJQUFJLEVBQUUsQ0FBQTtZQUNSLENBQUMsQ0FBQztpQkFDRCxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDakI7YUFBTTtZQUNMLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFO2dCQUN4QixJQUFJLEVBQUUsQ0FBQTtZQUNSLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDLENBQUMsQ0FBQTtJQUNGLE9BQU8sQ0FBQyxDQUFBO0FBQ1YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoZXNlIGZ1bmN0aW9ucyBhcmUgZGVwcmVjYXRlZCBiZWNhdXNlIHRoZXkgZWRpdCB0aGUgbWFya2Rvd24gb3V0cHV0LiBXZSBpbnN0ZWFkIHVzZSBhIGBoaWdobGlnaHRgIGhvb2sgdG8gdG9rZW5pemUgYW5kIGhpZ2hsaWdodCB0aGUgY29kZVxyXG5cclxuaW1wb3J0IHsgVGV4dEVkaXRvciwgVGV4dEVkaXRvckVsZW1lbnQgfSBmcm9tIFwiYXRvbVwiXHJcbmltcG9ydCB7IHNjb3BlRm9yRmVuY2VOYW1lLCBmZW5jZU5hbWVGb3JTY29wZSB9IGZyb20gXCIuL3V0aWxzXCJcclxuXHJcbi8qKlxyXG4gKiBpdGVyYXRlcyBvdmVyIHRoZSBjb250ZW50IG9mIHRoZSBIVE1MIGZyYWdtZW50IGFuZCByZXBsYWNlcyBhbnkgY29kZSBzZWN0aW9uXHJcbiAqIGZvdW5kIHdpdGggYW4gQXRvbSBUZXh0RWRpdG9yIGVsZW1lbnQgdGhhdCBpcyB1c2VkIGZvciBzeW50YXggaGlnaGxpZ2h0aW5nIHRoZSBjb2RlXHJcbiAqXHJcbiAqIEBwYXJhbSAge0hUTUxFbGVtZW50fSBkb21GcmFnbWVudCB0aGUgSFRNTCBmcmFnbWVudCB0byBiZSBhbmFseXplZCBhbmRcclxuICogQHBhcmFtICB7U3RyaW5nfSBncmFtbWFyIHRoZSBkZWZhdWx0IGdyYW1tYXIgdG8gYmUgdXNlZCBpZiB0aGUgY29kZSBzZWN0aW9uIGRvZXNuJ3QgaGF2ZSBhIHNwZWNpZmljIGdyYW1tYXIgc2V0XHJcbiAqIEByZXR1cm4gIGEgcHJvbWlzZSB0aGF0IGlzIHJlc29sdmVkIHdoZW4gdGhlIGZyYWdtZW50IGlzIHJlYWR5XHJcbiAqL1xyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGlnaGxpZ2h0Q29kZUZyYWdtZW50cyhkb21GcmFnbWVudDogSFRNTEVsZW1lbnQsIGdyYW1tYXI6IHN0cmluZyk6IFByb21pc2U8YW55PiB7XHJcbiAgY29uc3QgZGVmYXVsdExhbmd1YWdlID0gZmVuY2VOYW1lRm9yU2NvcGUoZ3JhbW1hciB8fCBcInRleHQucGxhaW5cIilcclxuICAvLyBzZXQgZWRpdG9yIGZvbnQgZmFtaWx5XHJcbiAgY29uc3QgZm9udEZhbWlseSA9IGF0b20uY29uZmlnLmdldChcImVkaXRvci5mb250RmFtaWx5XCIpXHJcbiAgY29uc3QgZm9udFNpemUgPSBhdG9tLmNvbmZpZy5nZXQoXCJlZGl0b3IuZm9udFNpemVcIilcclxuICBpZiAoZm9udEZhbWlseSAhPT0gbnVsbCkge1xyXG4gICAgZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbChcImNvZGVcIikuZm9yRWFjaCgoY29kZUVsZW1lbnQpID0+IHtcclxuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udEZhbWlseSA9IGZvbnRGYW1pbHlcclxuICAgICAgY29kZUVsZW1lbnQuc3R5bGUuZm9udFNpemUgPSBgJHtmb250U2l6ZX1gXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgY29uc3QgZWxlbWVudHM6IEhUTUxQcmVFbGVtZW50W10gPSBbXS5zbGljZS5jYWxsKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXCJwcmVcIikpXHJcbiAgY29uc3QgcHJvbWlzZXMgPSBlbGVtZW50cy5tYXAoYXN5bmMgKHByZUVsZW1lbnQpID0+IHtcclxuICAgIGNvbnN0IGNvZGVCbG9jayA9IHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgPz8gcHJlRWxlbWVudFxyXG4gICAgY29uc3QgZmVuY2VOYW1lID1cclxuICAgICAgY29kZUJsb2NrXHJcbiAgICAgICAgLmdldEF0dHJpYnV0ZShcImNsYXNzXCIpXHJcbiAgICAgICAgPy5yZXBsYWNlKC9ebGFuZy0vLCBcIlwiKVxyXG4gICAgICAgIC5yZXBsYWNlKC9ebGFuZ3VhZ2UtLywgXCJcIikgPz8gZGVmYXVsdExhbmd1YWdlXHJcbiAgICBwcmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoXCJlZGl0b3ItY29sb3JzXCIsIGBsYW5nLSR7ZmVuY2VOYW1lfWApXHJcblxyXG4gICAgY29uc3QgZWRpdG9yID0gbmV3IFRleHRFZGl0b3Ioe1xyXG4gICAgICByZWFkb25seTogdHJ1ZSxcclxuICAgICAga2V5Ym9hcmRJbnB1dEVuYWJsZWQ6IGZhbHNlLFxyXG4gICAgICBzb2Z0V3JhcHBlZDogdHJ1ZSxcclxuICAgICAgc29mdFdyYXBBdFByZWZlcnJlZExpbmVMZW5ndGg6IHRydWUsXHJcbiAgICAgIHByZWZlcnJlZExpbmVMZW5ndGg6IDgwLFxyXG4gICAgfSlcclxuICAgIGNvbnN0IGVkaXRvckVsZW1lbnQgPSBlZGl0b3IuZ2V0RWxlbWVudCgpXHJcbiAgICBlZGl0b3JFbGVtZW50LnNldFVwZGF0ZWRTeW5jaHJvbm91c2x5KHRydWUpXHJcblxyXG4gICAgcHJlRWxlbWVudC5pbm5lckhUTUwgPSBcIlwiXHJcbiAgICBwcmVFbGVtZW50LnBhcmVudE5vZGU/Lmluc2VydEJlZm9yZShlZGl0b3JFbGVtZW50LCBwcmVFbGVtZW50KVxyXG5cclxuICAgIGVkaXRvci5zZXRUZXh0KGNvZGVCbG9jay50ZXh0Q29udGVudD8ucmVwbGFjZSgvXFxyP1xcbiQvLCBcIlwiKSA/PyBcIlwiKVxyXG5cclxuICAgIGF0b20uZ3JhbW1hcnMuYXNzaWduTGFuZ3VhZ2VNb2RlKGVkaXRvci5nZXRCdWZmZXIoKSwgc2NvcGVGb3JGZW5jZU5hbWUoZmVuY2VOYW1lKSlcclxuICAgIGVkaXRvci5zZXRWaXNpYmxlKHRydWUpXHJcbiAgICByZXR1cm4gYXdhaXQgdG9rZW5pemVFZGl0b3IoZWRpdG9yRWxlbWVudCwgcHJlRWxlbWVudClcclxuICB9KVxyXG5cclxuICByZXR1cm4gYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpXHJcbn1cclxuXHJcbi8qKlxyXG4gKiB0YWtlcyBhbiBBdG9tIFRleHRFZGl0b3IgZWxlbWVudCwgdG9rZW5pemUgdGhlIGNvbnRlbnQgYW5kIG1vdmUgdGhlIHJlc3VsdGluZyBsaW5lcyB0byB0aGUgcHJlIGVsZW1lbnQgZ2l2ZW5cclxuICogQHBhcmFtICBlZGl0b3JFbGVtZW50IHRoZSBIVE1MIGVsZW1lbnQgY29udGFpbmluZyB0aGUgQXRvbSBUZXh0RWRpdG9yXHJcbiAqIEBwYXJhbSAgcHJlRWxlbWVudCAgICB0aGUgSFRNTCBwcmUgZWxlbWVudCB0aGF0IHNob3VsZCBob3N0IHRoZSByZXN1bHRpbmcgbGluZXNcclxuICogQHJldHVybiBhIHByb21pc2UgdGhhdCBpcyB0cmlnZ2VyZWQgYXMgc29vbiBhcyB0b2tlbml6YXRpb24gYW5kIG1vdmluZyB0aGUgY29udGVudCBpcyBkb25lXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdG9rZW5pemVFZGl0b3IoZWRpdG9yRWxlbWVudDogVGV4dEVkaXRvckVsZW1lbnQsIHByZUVsZW1lbnQ6IEhUTUxQcmVFbGVtZW50KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgY29uc3QgcCA9IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNvbnN0IGRvbmUgPSAoKSA9PiB7XHJcbiAgICAgIGVkaXRvckVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChcIi5saW5lOm5vdCguZHVtbXkpXCIpLmZvckVhY2goKGxpbmUpID0+IHtcclxuICAgICAgICBjb25zdCBsaW5lMiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIilcclxuICAgICAgICBsaW5lMi5jbGFzc05hbWUgPSBcImxpbmVcIlxyXG4gICAgICAgIGxpbmUyLmlubmVySFRNTCA9IGxpbmUuZmlyc3RFbGVtZW50Q2hpbGQ/LmlubmVySFRNTCA/PyBcIlwiXHJcbiAgICAgICAgcHJlRWxlbWVudC5hcHBlbmRDaGlsZChsaW5lMilcclxuICAgICAgfSlcclxuICAgICAgZWRpdG9yRWxlbWVudC5yZW1vdmUoKVxyXG4gICAgICByZXNvbHZlKClcclxuICAgIH1cclxuICAgIGNvbnN0IGVkaXRvciA9IGVkaXRvckVsZW1lbnQuZ2V0TW9kZWwoKVxyXG4gICAgY29uc3QgbGFuZ3VhZ2VNb2RlID0gZWRpdG9yLmdldEJ1ZmZlcigpLmdldExhbmd1YWdlTW9kZSgpXHJcbiAgICBpZiAoXCJmdWxseVRva2VuaXplZFwiIGluIGxhbmd1YWdlTW9kZSB8fCBcInRyZWVcIiBpbiBsYW5ndWFnZU1vZGUpIHtcclxuICAgICAgZWRpdG9yLmNvbXBvbmVudFxyXG4gICAgICAgIC5nZXROZXh0VXBkYXRlUHJvbWlzZSgpXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgZG9uZSgpXHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2gocmVqZWN0KVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZWRpdG9yLm9uRGlkVG9rZW5pemUoKCkgPT4ge1xyXG4gICAgICAgIGRvbmUoKVxyXG4gICAgICB9KVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgcmV0dXJuIHBcclxufVxyXG4iXX0=