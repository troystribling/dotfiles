Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

// Public: Adapts the language server protocol "textDocument/completion" to the Atom
// AutoComplete+ package.
let AutocompleteAdapter = class AutocompleteAdapter {
  static canAdapt(serverCapabilities) {
    return serverCapabilities.completionProvider != null;
  }

  // Public: Primary entry point for obtaining suggestions for AutoComplete+ by
  // querying the language server.
  //
  // * `connection` A {LanguageClientConnection} to the language server to query.
  // * `request` An {Object} with the AutoComplete+ request to satisfy.
  //
  // Returns a {Promise} of an {Array} of {Object}s containing the AutoComplete+
  // suggestions to display.
  getSuggestions(connection, request) {
    return _asyncToGenerator(function* () {
      const completionItems = yield connection.completion(AutocompleteAdapter.requestToTextDocumentPositionParams(request));
      return AutocompleteAdapter.completionItemsToSuggestions(completionItems, request);
    })();
  }

  // Public: Create TextDocumentPositionParams to be sent to the language server
  // based on the editor and position from the AutoCompleteRequest.
  //
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Object} containing the TextDocumentPositionParams object with the keys:
  //  * `textDocument` the language server protocol textDocument identification.
  //  * `position` the position within the text document to display completion request for.
  static requestToTextDocumentPositionParams(request) {
    return {
      textDocument: _convert2.default.editorToTextDocumentIdentifier(request.editor),
      position: _convert2.default.pointToPosition(request.bufferPosition)
    };
  }

  // Public: Convert a language server protocol CompletionItem array or CompletionList to
  // an array of AutoComplete+ suggestions.
  //
  // * `completionItems` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //           items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Array} of AutoComplete+ suggestions.
  static completionItemsToSuggestions(completionItems, request) {
    return (Array.isArray(completionItems) ? completionItems : completionItems.items || []).map(s => AutocompleteAdapter.completionItemToSuggestion(s, request));
  }

  // Public: Convert a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an AutoComplete+ suggestion.
  static completionItemToSuggestion(item, request) {
    const suggestion = AutocompleteAdapter.basicCompletionItemToSuggestion(item);
    AutocompleteAdapter.applyTextEditToSuggestion(item.textEdit, request.editor, suggestion);
    // TODO: Snippets
    return suggestion;
  }

  // Public: Convert the primary parts of a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  //
  // Returns an AutoComplete+ suggestion.
  static basicCompletionItemToSuggestion(item) {
    return {
      text: item.insertText || item.label,
      displayText: item.label,
      filterText: item.filterText || item.label,
      type: AutocompleteAdapter.completionKindToSuggestionType(item.kind),
      leftLabel: item.detail,
      description: item.documentation,
      descriptionMarkdown: item.documentation
    };
  }

  // Public: Applies the textEdit part of a language server protocol CompletionItem to an
  // AutoComplete+ Suggestion via the replacementPrefix and text properties.
  //
  // * `textEdit` A {TextEdit} from a CompletionItem to apply.
  // * `editor` An Atom {TextEditor} used to obtain the necessary text replacement.
  // * `suggestion` An AutoComplete+ suggestion to set the replacementPrefix and text properties of.
  static applyTextEditToSuggestion(textEdit, editor, suggestion) {
    if (textEdit != null) {
      suggestion.replacementPrefix = editor.getTextInBufferRange(_convert2.default.lsRangeToAtomRange(textEdit.range));
      suggestion.text = textEdit.newText;
    }
  }

  // Public: Obtain the textual suggestion type required by AutoComplete+ that
  // most closely maps to the numeric completion kind supplies by the language server.
  //
  // * `kind` A {Number} that represents the suggestion kind to be converted.
  //
  // Returns a {String} containing the AutoComplete+ suggestion type equivalent
  // to the given completion kind.
  static completionKindToSuggestionType(kind) {
    switch (kind) {
      case _languageclient.CompletionItemKind.Method:
        return 'method';
      case _languageclient.CompletionItemKind.Function:
      case _languageclient.CompletionItemKind.Constructor:
        return 'function';
      case _languageclient.CompletionItemKind.Field:
      case _languageclient.CompletionItemKind.Property:
        return 'property';
      case _languageclient.CompletionItemKind.Variable:
        return 'variable';
      case _languageclient.CompletionItemKind.Class:
        return 'class';
      case _languageclient.CompletionItemKind.Interface:
        return 'interface';
      case _languageclient.CompletionItemKind.Module:
        return 'module';
      case _languageclient.CompletionItemKind.Unit:
        return 'builtin';
      case _languageclient.CompletionItemKind.Enum:
        return 'enum';
      case _languageclient.CompletionItemKind.Keyword:
        return 'keyword';
      case _languageclient.CompletionItemKind.Snippet:
        return 'snippet';
      case _languageclient.CompletionItemKind.File:
        return 'import';
      case _languageclient.CompletionItemKind.Reference:
        return 'require';
      default:
        return 'value';
    }
  }
};
exports.default = AutocompleteAdapter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlci5qcyJdLCJuYW1lcyI6WyJBdXRvY29tcGxldGVBZGFwdGVyIiwiY2FuQWRhcHQiLCJzZXJ2ZXJDYXBhYmlsaXRpZXMiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJnZXRTdWdnZXN0aW9ucyIsImNvbm5lY3Rpb24iLCJyZXF1ZXN0IiwiY29tcGxldGlvbkl0ZW1zIiwiY29tcGxldGlvbiIsInJlcXVlc3RUb1RleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zIiwiY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyIsInRleHREb2N1bWVudCIsImVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllciIsImVkaXRvciIsInBvc2l0aW9uIiwicG9pbnRUb1Bvc2l0aW9uIiwiYnVmZmVyUG9zaXRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJpdGVtcyIsIm1hcCIsInMiLCJjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsIml0ZW0iLCJzdWdnZXN0aW9uIiwiYmFzaWNDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsImFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24iLCJ0ZXh0RWRpdCIsInRleHQiLCJpbnNlcnRUZXh0IiwibGFiZWwiLCJkaXNwbGF5VGV4dCIsImZpbHRlclRleHQiLCJ0eXBlIiwiY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlIiwia2luZCIsImxlZnRMYWJlbCIsImRldGFpbCIsImRlc2NyaXB0aW9uIiwiZG9jdW1lbnRhdGlvbiIsImRlc2NyaXB0aW9uTWFya2Rvd24iLCJyZXBsYWNlbWVudFByZWZpeCIsImdldFRleHRJbkJ1ZmZlclJhbmdlIiwibHNSYW5nZVRvQXRvbVJhbmdlIiwicmFuZ2UiLCJuZXdUZXh0IiwiTWV0aG9kIiwiRnVuY3Rpb24iLCJDb25zdHJ1Y3RvciIsIkZpZWxkIiwiUHJvcGVydHkiLCJWYXJpYWJsZSIsIkNsYXNzIiwiSW50ZXJmYWNlIiwiTW9kdWxlIiwiVW5pdCIsIkVudW0iLCJLZXl3b3JkIiwiU25pcHBldCIsIkZpbGUiLCJSZWZlcmVuY2UiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7O0FBU0E7Ozs7Ozs7O0FBRUE7QUFDQTtJQUNxQkEsbUIsR0FBTixNQUFNQSxtQkFBTixDQUEwQjtBQUN2QyxTQUFPQyxRQUFQLENBQWdCQyxrQkFBaEIsRUFBaUU7QUFDL0QsV0FBT0EsbUJBQW1CQyxrQkFBbkIsSUFBeUMsSUFBaEQ7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ01DLGdCQUFOLENBQ0VDLFVBREYsRUFFRUMsT0FGRixFQUcrQztBQUFBO0FBQzdDLFlBQU1DLGtCQUFrQixNQUFNRixXQUFXRyxVQUFYLENBQzVCUixvQkFBb0JTLG1DQUFwQixDQUF3REgsT0FBeEQsQ0FENEIsQ0FBOUI7QUFHQSxhQUFPTixvQkFBb0JVLDRCQUFwQixDQUFpREgsZUFBakQsRUFBa0VELE9BQWxFLENBQVA7QUFKNkM7QUFLOUM7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQU9HLG1DQUFQLENBQTJDSCxPQUEzQyxFQUEwRztBQUN4RyxXQUFPO0FBQ0xLLG9CQUFjLGtCQUFRQyw4QkFBUixDQUF1Q04sUUFBUU8sTUFBL0MsQ0FEVDtBQUVMQyxnQkFBVSxrQkFBUUMsZUFBUixDQUF3QlQsUUFBUVUsY0FBaEM7QUFGTCxLQUFQO0FBSUQ7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQU9OLDRCQUFQLENBQ0VILGVBREYsRUFFRUQsT0FGRixFQUdzQztBQUNwQyxXQUFPLENBQUNXLE1BQU1DLE9BQU4sQ0FBY1gsZUFBZCxJQUFpQ0EsZUFBakMsR0FBbURBLGdCQUFnQlksS0FBaEIsSUFBeUIsRUFBN0UsRUFBaUZDLEdBQWpGLENBQXFGQyxLQUMxRnJCLG9CQUFvQnNCLDBCQUFwQixDQUErQ0QsQ0FBL0MsRUFBa0RmLE9BQWxELENBREssQ0FBUDtBQUdEOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBT2dCLDBCQUFQLENBQ0VDLElBREYsRUFFRWpCLE9BRkYsRUFHK0I7QUFDN0IsVUFBTWtCLGFBQWF4QixvQkFBb0J5QiwrQkFBcEIsQ0FBb0RGLElBQXBELENBQW5CO0FBQ0F2Qix3QkFBb0IwQix5QkFBcEIsQ0FBOENILEtBQUtJLFFBQW5ELEVBQTZEckIsUUFBUU8sTUFBckUsRUFBNkVXLFVBQTdFO0FBQ0E7QUFDQSxXQUFPQSxVQUFQO0FBQ0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBT0MsK0JBQVAsQ0FBdUNGLElBQXZDLEVBQTBGO0FBQ3hGLFdBQU87QUFDTEssWUFBTUwsS0FBS00sVUFBTCxJQUFtQk4sS0FBS08sS0FEekI7QUFFTEMsbUJBQWFSLEtBQUtPLEtBRmI7QUFHTEUsa0JBQVlULEtBQUtTLFVBQUwsSUFBbUJULEtBQUtPLEtBSC9CO0FBSUxHLFlBQU1qQyxvQkFBb0JrQyw4QkFBcEIsQ0FBbURYLEtBQUtZLElBQXhELENBSkQ7QUFLTEMsaUJBQVdiLEtBQUtjLE1BTFg7QUFNTEMsbUJBQWFmLEtBQUtnQixhQU5iO0FBT0xDLDJCQUFxQmpCLEtBQUtnQjtBQVByQixLQUFQO0FBU0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBT2IseUJBQVAsQ0FDRUMsUUFERixFQUVFZCxNQUZGLEVBR0VXLFVBSEYsRUFJUTtBQUNOLFFBQUlHLFlBQVksSUFBaEIsRUFBc0I7QUFDcEJILGlCQUFXaUIsaUJBQVgsR0FBK0I1QixPQUFPNkIsb0JBQVAsQ0FBNEIsa0JBQVFDLGtCQUFSLENBQTJCaEIsU0FBU2lCLEtBQXBDLENBQTVCLENBQS9CO0FBQ0FwQixpQkFBV0ksSUFBWCxHQUFrQkQsU0FBU2tCLE9BQTNCO0FBQ0Q7QUFDRjs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQU9YLDhCQUFQLENBQXNDQyxJQUF0QyxFQUE2RDtBQUMzRCxZQUFRQSxJQUFSO0FBQ0UsV0FBSyxtQ0FBbUJXLE1BQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFdBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0UsZUFBTyxPQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFNBQXhCO0FBQ0UsZUFBTyxXQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE1BQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxNQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFNBQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0Y7QUFDRSxlQUFPLE9BQVA7QUE5Qko7QUFnQ0Q7QUFuSnNDLEM7a0JBQXBCNUQsbUIiLCJmaWxlIjoiYXV0b2NvbXBsZXRlLWFkYXB0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0IHtcclxuICBDb21wbGV0aW9uSXRlbUtpbmQsXHJcbiAgTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLFxyXG4gIHR5cGUgQ29tcGxldGlvbkl0ZW0sXHJcbiAgdHlwZSBDb21wbGV0aW9uTGlzdCxcclxuICB0eXBlIFRleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zLFxyXG4gIHR5cGUgVGV4dEVkaXQsXHJcbiAgdHlwZSBTZXJ2ZXJDYXBhYmlsaXRpZXMsXHJcbn0gZnJvbSAnLi4vbGFuZ3VhZ2VjbGllbnQnO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuLi9jb252ZXJ0JztcclxuXHJcbi8vIFB1YmxpYzogQWRhcHRzIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgXCJ0ZXh0RG9jdW1lbnQvY29tcGxldGlvblwiIHRvIHRoZSBBdG9tXHJcbi8vIEF1dG9Db21wbGV0ZSsgcGFja2FnZS5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0b2NvbXBsZXRlQWRhcHRlciB7XHJcbiAgc3RhdGljIGNhbkFkYXB0KHNlcnZlckNhcGFiaWxpdGllczogU2VydmVyQ2FwYWJpbGl0aWVzKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gc2VydmVyQ2FwYWJpbGl0aWVzLmNvbXBsZXRpb25Qcm92aWRlciAhPSBudWxsO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBQcmltYXJ5IGVudHJ5IHBvaW50IGZvciBvYnRhaW5pbmcgc3VnZ2VzdGlvbnMgZm9yIEF1dG9Db21wbGV0ZSsgYnlcclxuICAvLyBxdWVyeWluZyB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIC8vXHJcbiAgLy8gKiBgY29ubmVjdGlvbmAgQSB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9ufSB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHRvIHF1ZXJ5LlxyXG4gIC8vICogYHJlcXVlc3RgIEFuIHtPYmplY3R9IHdpdGggdGhlIEF1dG9Db21wbGV0ZSsgcmVxdWVzdCB0byBzYXRpc2Z5LlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtQcm9taXNlfSBvZiBhbiB7QXJyYXl9IG9mIHtPYmplY3R9cyBjb250YWluaW5nIHRoZSBBdXRvQ29tcGxldGUrXHJcbiAgLy8gc3VnZ2VzdGlvbnMgdG8gZGlzcGxheS5cclxuICBhc3luYyBnZXRTdWdnZXN0aW9ucyhcclxuICAgIGNvbm5lY3Rpb246IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbixcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICApOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcclxuICAgIGNvbnN0IGNvbXBsZXRpb25JdGVtcyA9IGF3YWl0IGNvbm5lY3Rpb24uY29tcGxldGlvbihcclxuICAgICAgQXV0b2NvbXBsZXRlQWRhcHRlci5yZXF1ZXN0VG9UZXh0RG9jdW1lbnRQb3NpdGlvblBhcmFtcyhyZXF1ZXN0KSxcclxuICAgICk7XHJcbiAgICByZXR1cm4gQXV0b2NvbXBsZXRlQWRhcHRlci5jb21wbGV0aW9uSXRlbXNUb1N1Z2dlc3Rpb25zKGNvbXBsZXRpb25JdGVtcywgcmVxdWVzdCk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENyZWF0ZSBUZXh0RG9jdW1lbnRQb3NpdGlvblBhcmFtcyB0byBiZSBzZW50IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXJcclxuICAvLyBiYXNlZCBvbiB0aGUgZWRpdG9yIGFuZCBwb3NpdGlvbiBmcm9tIHRoZSBBdXRvQ29tcGxldGVSZXF1ZXN0LlxyXG4gIC8vXHJcbiAgLy8gKiBgcmVxdWVzdGAgQW4ge09iamVjdH0gd2l0aCB0aGUgQXV0b0NvbXBsZXRlKyByZXF1ZXN0IHRvIHVzZS5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4ge09iamVjdH0gY29udGFpbmluZyB0aGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgb2JqZWN0IHdpdGggdGhlIGtleXM6XHJcbiAgLy8gICogYHRleHREb2N1bWVudGAgdGhlIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCB0ZXh0RG9jdW1lbnQgaWRlbnRpZmljYXRpb24uXHJcbiAgLy8gICogYHBvc2l0aW9uYCB0aGUgcG9zaXRpb24gd2l0aGluIHRoZSB0ZXh0IGRvY3VtZW50IHRvIGRpc3BsYXkgY29tcGxldGlvbiByZXF1ZXN0IGZvci5cclxuICBzdGF0aWMgcmVxdWVzdFRvVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMocmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KTogVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdGV4dERvY3VtZW50OiBDb252ZXJ0LmVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllcihyZXF1ZXN0LmVkaXRvciksXHJcbiAgICAgIHBvc2l0aW9uOiBDb252ZXJ0LnBvaW50VG9Qb3NpdGlvbihyZXF1ZXN0LmJ1ZmZlclBvc2l0aW9uKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgQ29tcGxldGlvbkl0ZW0gYXJyYXkgb3IgQ29tcGxldGlvbkxpc3QgdG9cclxuICAvLyBhbiBhcnJheSBvZiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zLlxyXG4gIC8vXHJcbiAgLy8gKiBgY29tcGxldGlvbkl0ZW1zYCBBbiB7QXJyYXl9IG9mIHtDb21wbGV0aW9uSXRlbX0gb2JqZWN0cyBvciBhIHtDb21wbGV0aW9uTGlzdH0gY29udGFpbmluZyBjb21wbGV0aW9uXHJcbiAgLy8gICAgICAgICAgIGl0ZW1zIHRvIGJlIGNvbnZlcnRlZC5cclxuICAvLyAqIGByZXF1ZXN0YCBBbiB7T2JqZWN0fSB3aXRoIHRoZSBBdXRvQ29tcGxldGUrIHJlcXVlc3QgdG8gdXNlLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhbiB7QXJyYXl9IG9mIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbnMuXHJcbiAgc3RhdGljIGNvbXBsZXRpb25JdGVtc1RvU3VnZ2VzdGlvbnMoXHJcbiAgICBjb21wbGV0aW9uSXRlbXM6IEFycmF5PENvbXBsZXRpb25JdGVtPiB8IENvbXBsZXRpb25MaXN0LFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICk6IEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4ge1xyXG4gICAgcmV0dXJuIChBcnJheS5pc0FycmF5KGNvbXBsZXRpb25JdGVtcykgPyBjb21wbGV0aW9uSXRlbXMgOiBjb21wbGV0aW9uSXRlbXMuaXRlbXMgfHwgW10pLm1hcChzID0+XHJcbiAgICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24ocywgcmVxdWVzdCksXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIHRvIGFuIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbi5cclxuICAvL1xyXG4gIC8vICogYGl0ZW1gIEFuIHtBcnJheX0gb2Yge0NvbXBsZXRpb25JdGVtfSBvYmplY3RzIG9yIGEge0NvbXBsZXRpb25MaXN0fSBjb250YWluaW5nIGNvbXBsZXRpb25cclxuICAvLyAgICAgICAgICAgICBpdGVtcyB0byBiZSBjb252ZXJ0ZWQuXHJcbiAgLy8gKiBgcmVxdWVzdGAgQW4ge09iamVjdH0gd2l0aCB0aGUgQXV0b0NvbXBsZXRlKyByZXF1ZXN0IHRvIHVzZS5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIHN0YXRpYyBjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihcclxuICAgIGl0ZW06IENvbXBsZXRpb25JdGVtLFxyXG4gICAgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0LFxyXG4gICk6IGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbiB7XHJcbiAgICBjb25zdCBzdWdnZXN0aW9uID0gQXV0b2NvbXBsZXRlQWRhcHRlci5iYXNpY0NvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKGl0ZW0pO1xyXG4gICAgQXV0b2NvbXBsZXRlQWRhcHRlci5hcHBseVRleHRFZGl0VG9TdWdnZXN0aW9uKGl0ZW0udGV4dEVkaXQsIHJlcXVlc3QuZWRpdG9yLCBzdWdnZXN0aW9uKTtcclxuICAgIC8vIFRPRE86IFNuaXBwZXRzXHJcbiAgICByZXR1cm4gc3VnZ2VzdGlvbjtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCB0aGUgcHJpbWFyeSBwYXJ0cyBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXHJcbiAgLy9cclxuICAvLyAqIGBpdGVtYCBBbiB7QXJyYXl9IG9mIHtDb21wbGV0aW9uSXRlbX0gb2JqZWN0cyBvciBhIHtDb21wbGV0aW9uTGlzdH0gY29udGFpbmluZyBjb21wbGV0aW9uXHJcbiAgLy8gICAgICAgICAgICAgaXRlbXMgdG8gYmUgY29udmVydGVkLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXHJcbiAgc3RhdGljIGJhc2ljQ29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24oaXRlbTogQ29tcGxldGlvbkl0ZW0pOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdGV4dDogaXRlbS5pbnNlcnRUZXh0IHx8IGl0ZW0ubGFiZWwsXHJcbiAgICAgIGRpc3BsYXlUZXh0OiBpdGVtLmxhYmVsLFxyXG4gICAgICBmaWx0ZXJUZXh0OiBpdGVtLmZpbHRlclRleHQgfHwgaXRlbS5sYWJlbCxcclxuICAgICAgdHlwZTogQXV0b2NvbXBsZXRlQWRhcHRlci5jb21wbGV0aW9uS2luZFRvU3VnZ2VzdGlvblR5cGUoaXRlbS5raW5kKSxcclxuICAgICAgbGVmdExhYmVsOiBpdGVtLmRldGFpbCxcclxuICAgICAgZGVzY3JpcHRpb246IGl0ZW0uZG9jdW1lbnRhdGlvbixcclxuICAgICAgZGVzY3JpcHRpb25NYXJrZG93bjogaXRlbS5kb2N1bWVudGF0aW9uLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQXBwbGllcyB0aGUgdGV4dEVkaXQgcGFydCBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhblxyXG4gIC8vIEF1dG9Db21wbGV0ZSsgU3VnZ2VzdGlvbiB2aWEgdGhlIHJlcGxhY2VtZW50UHJlZml4IGFuZCB0ZXh0IHByb3BlcnRpZXMuXHJcbiAgLy9cclxuICAvLyAqIGB0ZXh0RWRpdGAgQSB7VGV4dEVkaXR9IGZyb20gYSBDb21wbGV0aW9uSXRlbSB0byBhcHBseS5cclxuICAvLyAqIGBlZGl0b3JgIEFuIEF0b20ge1RleHRFZGl0b3J9IHVzZWQgdG8gb2J0YWluIHRoZSBuZWNlc3NhcnkgdGV4dCByZXBsYWNlbWVudC5cclxuICAvLyAqIGBzdWdnZXN0aW9uYCBBbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24gdG8gc2V0IHRoZSByZXBsYWNlbWVudFByZWZpeCBhbmQgdGV4dCBwcm9wZXJ0aWVzIG9mLlxyXG4gIHN0YXRpYyBhcHBseVRleHRFZGl0VG9TdWdnZXN0aW9uKFxyXG4gICAgdGV4dEVkaXQ6ID9UZXh0RWRpdCxcclxuICAgIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLFxyXG4gICAgc3VnZ2VzdGlvbjogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uLFxyXG4gICk6IHZvaWQge1xyXG4gICAgaWYgKHRleHRFZGl0ICE9IG51bGwpIHtcclxuICAgICAgc3VnZ2VzdGlvbi5yZXBsYWNlbWVudFByZWZpeCA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShDb252ZXJ0LmxzUmFuZ2VUb0F0b21SYW5nZSh0ZXh0RWRpdC5yYW5nZSkpO1xyXG4gICAgICBzdWdnZXN0aW9uLnRleHQgPSB0ZXh0RWRpdC5uZXdUZXh0O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBPYnRhaW4gdGhlIHRleHR1YWwgc3VnZ2VzdGlvbiB0eXBlIHJlcXVpcmVkIGJ5IEF1dG9Db21wbGV0ZSsgdGhhdFxyXG4gIC8vIG1vc3QgY2xvc2VseSBtYXBzIHRvIHRoZSBudW1lcmljIGNvbXBsZXRpb24ga2luZCBzdXBwbGllcyBieSB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIC8vXHJcbiAgLy8gKiBga2luZGAgQSB7TnVtYmVyfSB0aGF0IHJlcHJlc2VudHMgdGhlIHN1Z2dlc3Rpb24ga2luZCB0byBiZSBjb252ZXJ0ZWQuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEge1N0cmluZ30gY29udGFpbmluZyB0aGUgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uIHR5cGUgZXF1aXZhbGVudFxyXG4gIC8vIHRvIHRoZSBnaXZlbiBjb21wbGV0aW9uIGtpbmQuXHJcbiAgc3RhdGljIGNvbXBsZXRpb25LaW5kVG9TdWdnZXN0aW9uVHlwZShraW5kOiA/bnVtYmVyKTogc3RyaW5nIHtcclxuICAgIHN3aXRjaCAoa2luZCkge1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5NZXRob2Q6XHJcbiAgICAgICAgcmV0dXJuICdtZXRob2QnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GdW5jdGlvbjpcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuQ29uc3RydWN0b3I6XHJcbiAgICAgICAgcmV0dXJuICdmdW5jdGlvbic7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZpZWxkOlxyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Qcm9wZXJ0eTpcclxuICAgICAgICByZXR1cm4gJ3Byb3BlcnR5JztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuVmFyaWFibGU6XHJcbiAgICAgICAgcmV0dXJuICd2YXJpYWJsZSc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkNsYXNzOlxyXG4gICAgICAgIHJldHVybiAnY2xhc3MnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5JbnRlcmZhY2U6XHJcbiAgICAgICAgcmV0dXJuICdpbnRlcmZhY2UnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Nb2R1bGU6XHJcbiAgICAgICAgcmV0dXJuICdtb2R1bGUnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Vbml0OlxyXG4gICAgICAgIHJldHVybiAnYnVpbHRpbic7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkVudW06XHJcbiAgICAgICAgcmV0dXJuICdlbnVtJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuS2V5d29yZDpcclxuICAgICAgICByZXR1cm4gJ2tleXdvcmQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5TbmlwcGV0OlxyXG4gICAgICAgIHJldHVybiAnc25pcHBldCc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkZpbGU6XHJcbiAgICAgICAgcmV0dXJuICdpbXBvcnQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5SZWZlcmVuY2U6XHJcbiAgICAgICAgcmV0dXJuICdyZXF1aXJlJztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gJ3ZhbHVlJztcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19