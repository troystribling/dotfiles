"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const assert = require("assert");
const convert_1 = require("../convert");
const apply_edit_adapter_1 = require("./apply-edit-adapter");
const languageclient_1 = require("../languageclient");
class CodeActionAdapter {
    /** @returns A {Boolean} indicating this adapter can adapt the server based on the given serverCapabilities. */
    static canAdapt(serverCapabilities) {
        return serverCapabilities.codeActionProvider === true;
    }
    /**
     * Public: Retrieves code actions for a given editor, range, and context (diagnostics). Throws an error if
     * codeActionProvider is not a registered capability.
     *
     * @param connection A {LanguageClientConnection} to the language server that provides highlights.
     * @param serverCapabilities The {ServerCapabilities} of the language server that will be used.
     * @param editor The Atom {TextEditor} containing the diagnostics.
     * @param range The Atom {Range} to fetch code actions for.
     * @param linterMessages An {Array<linter$Message>} to fetch code actions for. This is typically a list of messages
     *   intersecting `range`.
     * @returns A {Promise} of an {Array} of {atomIde$CodeAction}s to display.
     */
    static getCodeActions(connection, serverCapabilities, linterAdapter, editor, range, linterMessages, filterActions = (actions) => actions, onApply = () => Promise.resolve(true)) {
        return __awaiter(this, void 0, void 0, function* () {
            if (linterAdapter == null) {
                return [];
            }
            assert(serverCapabilities.codeActionProvider, "Must have the textDocument/codeAction capability");
            const params = createCodeActionParams(linterAdapter, editor, range, linterMessages);
            const actions = filterActions(yield connection.codeAction(params));
            if (actions === null) {
                return [];
            }
            return actions.map((action) => CodeActionAdapter.createCodeAction(action, connection, onApply));
        });
    }
    static createCodeAction(action, connection, onApply) {
        return {
            apply() {
                return __awaiter(this, void 0, void 0, function* () {
                    if ((yield onApply(action)) === false) {
                        return;
                    }
                    if (languageclient_1.CodeAction.is(action)) {
                        CodeActionAdapter.applyWorkspaceEdit(action.edit);
                        yield CodeActionAdapter.executeCommand(action.command, connection);
                    }
                    else {
                        yield CodeActionAdapter.executeCommand(action, connection);
                    }
                });
            },
            getTitle() {
                return Promise.resolve(action.title);
            },
            dispose() { },
        };
    }
    static applyWorkspaceEdit(edit) {
        if (languageclient_1.WorkspaceEdit.is(edit)) {
            apply_edit_adapter_1.default.onApplyEdit({ edit });
        }
    }
    static executeCommand(command, connection) {
        return __awaiter(this, void 0, void 0, function* () {
            if (languageclient_1.Command.is(command)) {
                yield connection.executeCommand({
                    command: command.command,
                    arguments: command.arguments,
                });
            }
        });
    }
}
exports.default = CodeActionAdapter;
function createCodeActionParams(linterAdapter, editor, range, linterMessages) {
    let diagnostics;
    if (linterMessages.length === 0) {
        diagnostics = [];
    }
    else {
        // TODO compile time dispatch using function names
        diagnostics = areLinterMessages(linterMessages)
            ? linterAdapter.getLSDiagnosticsForMessages(linterMessages)
            : linterAdapter.getLSDiagnosticsForIdeDiagnostics(linterMessages, editor);
    }
    return {
        textDocument: convert_1.default.editorToTextDocumentIdentifier(editor),
        range: convert_1.default.atomRangeToLSRange(range),
        context: {
            diagnostics,
        },
    };
}
function areLinterMessages(linterMessages) {
    if ("excerpt" in linterMessages[0]) {
        return true;
    }
    return false;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1hY3Rpb24tYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9jb2RlLWFjdGlvbi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBS0EsaUNBQWlDO0FBQ2pDLHdDQUFnQztBQUNoQyw2REFBbUQ7QUFDbkQsc0RBUTBCO0FBRzFCLE1BQXFCLGlCQUFpQjtJQUNwQywrR0FBK0c7SUFDeEcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxrQkFBc0M7UUFDM0QsT0FBTyxrQkFBa0IsQ0FBQyxrQkFBa0IsS0FBSyxJQUFJLENBQUE7SUFDdkQsQ0FBQztJQUVEOzs7Ozs7Ozs7OztPQVdHO0lBQ0ksTUFBTSxDQUFPLGNBQWMsQ0FDaEMsVUFBb0MsRUFDcEMsa0JBQXNDLEVBQ3RDLGFBQXFFLEVBQ3JFLE1BQWtCLEVBQ2xCLEtBQVksRUFDWixjQUF1RCxFQUN2RCxnQkFBK0YsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFDbkgsVUFBOEQsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7O1lBRXpGLElBQUksYUFBYSxJQUFJLElBQUksRUFBRTtnQkFDekIsT0FBTyxFQUFFLENBQUE7YUFDVjtZQUNELE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxrQkFBa0IsRUFBRSxrREFBa0QsQ0FBQyxDQUFBO1lBRWpHLE1BQU0sTUFBTSxHQUFHLHNCQUFzQixDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFBO1lBQ25GLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxNQUFNLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtZQUNsRSxJQUFJLE9BQU8sS0FBSyxJQUFJLEVBQUU7Z0JBQ3BCLE9BQU8sRUFBRSxDQUFBO2FBQ1Y7WUFDRCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQTtRQUNqRyxDQUFDO0tBQUE7SUFFTyxNQUFNLENBQUMsZ0JBQWdCLENBQzdCLE1BQTRCLEVBQzVCLFVBQW9DLEVBQ3BDLE9BQTJEO1FBRTNELE9BQU87WUFDQyxLQUFLOztvQkFDVCxJQUFJLENBQUMsTUFBTSxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxLQUFLLEVBQUU7d0JBQ3JDLE9BQU07cUJBQ1A7b0JBQ0QsSUFBSSwyQkFBVSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDekIsaUJBQWlCLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBO3dCQUNqRCxNQUFNLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQVUsQ0FBQyxDQUFBO3FCQUNuRTt5QkFBTTt3QkFDTCxNQUFNLGlCQUFpQixDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUE7cUJBQzNEO2dCQUNILENBQUM7YUFBQTtZQUNELFFBQVE7Z0JBQ04sT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUN0QyxDQUFDO1lBQ0QsT0FBTyxLQUFVLENBQUM7U0FDbkIsQ0FBQTtJQUNILENBQUM7SUFFTyxNQUFNLENBQUMsa0JBQWtCLENBQUMsSUFBK0I7UUFDL0QsSUFBSSw4QkFBYSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMxQiw0QkFBZ0IsQ0FBQyxXQUFXLENBQUMsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVPLE1BQU0sQ0FBTyxjQUFjLENBQUMsT0FBWSxFQUFFLFVBQW9DOztZQUNwRixJQUFJLHdCQUFPLENBQUMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUN2QixNQUFNLFVBQVUsQ0FBQyxjQUFjLENBQUM7b0JBQzlCLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTztvQkFDeEIsU0FBUyxFQUFFLE9BQU8sQ0FBQyxTQUFTO2lCQUM3QixDQUFDLENBQUE7YUFDSDtRQUNILENBQUM7S0FBQTtDQUNGO0FBL0VELG9DQStFQztBQUVELFNBQVMsc0JBQXNCLENBQzdCLGFBQXlELEVBQ3pELE1BQWtCLEVBQ2xCLEtBQVksRUFDWixjQUF1RDtJQUV2RCxJQUFJLFdBQXlCLENBQUE7SUFDN0IsSUFBSSxjQUFjLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUMvQixXQUFXLEdBQUcsRUFBRSxDQUFBO0tBQ2pCO1NBQU07UUFDTCxrREFBa0Q7UUFDbEQsV0FBVyxHQUFHLGlCQUFpQixDQUFDLGNBQWMsQ0FBQztZQUM3QyxDQUFDLENBQUMsYUFBYSxDQUFDLDJCQUEyQixDQUFDLGNBQWtDLENBQUM7WUFDL0UsQ0FBQyxDQUFFLGFBQXNDLENBQUMsaUNBQWlDLENBQ3ZFLGNBQXNDLEVBQ3RDLE1BQU0sQ0FDUCxDQUFBO0tBQ047SUFDRCxPQUFPO1FBQ0wsWUFBWSxFQUFFLGlCQUFPLENBQUMsOEJBQThCLENBQUMsTUFBTSxDQUFDO1FBQzVELEtBQUssRUFBRSxpQkFBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQztRQUN4QyxPQUFPLEVBQUU7WUFDUCxXQUFXO1NBQ1o7S0FDRixDQUFBO0FBQ0gsQ0FBQztBQUVELFNBQVMsaUJBQWlCLENBQUMsY0FBdUQ7SUFDaEYsSUFBSSxTQUFTLElBQUksY0FBYyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ2xDLE9BQU8sSUFBSSxDQUFBO0tBQ1o7SUFDRCxPQUFPLEtBQUssQ0FBQTtBQUNkLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSAqIGFzIGF0b21JZGUgZnJvbSBcImF0b20taWRlLWJhc2VcIlxuaW1wb3J0ICogYXMgbGludGVyIGZyb20gXCJhdG9tL2xpbnRlclwiXG5pbXBvcnQgTGludGVyUHVzaFYyQWRhcHRlciBmcm9tIFwiLi9saW50ZXItcHVzaC12Mi1hZGFwdGVyXCJcbi8qIGVzbGludC1kaXNhYmxlIGltcG9ydC9uby1kZXByZWNhdGVkICovXG5pbXBvcnQgSWRlRGlhZ25vc3RpY0FkYXB0ZXIgZnJvbSBcIi4vZGlhZ25vc3RpYy1hZGFwdGVyXCJcbmltcG9ydCBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpXG5pbXBvcnQgQ29udmVydCBmcm9tIFwiLi4vY29udmVydFwiXG5pbXBvcnQgQXBwbHlFZGl0QWRhcHRlciBmcm9tIFwiLi9hcHBseS1lZGl0LWFkYXB0ZXJcIlxuaW1wb3J0IHtcbiAgQ29kZUFjdGlvbixcbiAgQ29kZUFjdGlvblBhcmFtcyxcbiAgQ29tbWFuZCxcbiAgRGlhZ25vc3RpYyxcbiAgTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLFxuICBTZXJ2ZXJDYXBhYmlsaXRpZXMsXG4gIFdvcmtzcGFjZUVkaXQsXG59IGZyb20gXCIuLi9sYW5ndWFnZWNsaWVudFwiXG5pbXBvcnQgeyBSYW5nZSwgVGV4dEVkaXRvciB9IGZyb20gXCJhdG9tXCJcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29kZUFjdGlvbkFkYXB0ZXIge1xuICAvKiogQHJldHVybnMgQSB7Qm9vbGVhbn0gaW5kaWNhdGluZyB0aGlzIGFkYXB0ZXIgY2FuIGFkYXB0IHRoZSBzZXJ2ZXIgYmFzZWQgb24gdGhlIGdpdmVuIHNlcnZlckNhcGFiaWxpdGllcy4gKi9cbiAgcHVibGljIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzZXJ2ZXJDYXBhYmlsaXRpZXMuY29kZUFjdGlvblByb3ZpZGVyID09PSB0cnVlXG4gIH1cblxuICAvKipcbiAgICogUHVibGljOiBSZXRyaWV2ZXMgY29kZSBhY3Rpb25zIGZvciBhIGdpdmVuIGVkaXRvciwgcmFuZ2UsIGFuZCBjb250ZXh0IChkaWFnbm9zdGljcykuIFRocm93cyBhbiBlcnJvciBpZlxuICAgKiBjb2RlQWN0aW9uUHJvdmlkZXIgaXMgbm90IGEgcmVnaXN0ZXJlZCBjYXBhYmlsaXR5LlxuICAgKlxuICAgKiBAcGFyYW0gY29ubmVjdGlvbiBBIHtMYW5ndWFnZUNsaWVudENvbm5lY3Rpb259IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdGhhdCBwcm92aWRlcyBoaWdobGlnaHRzLlxuICAgKiBAcGFyYW0gc2VydmVyQ2FwYWJpbGl0aWVzIFRoZSB7U2VydmVyQ2FwYWJpbGl0aWVzfSBvZiB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHRoYXQgd2lsbCBiZSB1c2VkLlxuICAgKiBAcGFyYW0gZWRpdG9yIFRoZSBBdG9tIHtUZXh0RWRpdG9yfSBjb250YWluaW5nIHRoZSBkaWFnbm9zdGljcy5cbiAgICogQHBhcmFtIHJhbmdlIFRoZSBBdG9tIHtSYW5nZX0gdG8gZmV0Y2ggY29kZSBhY3Rpb25zIGZvci5cbiAgICogQHBhcmFtIGxpbnRlck1lc3NhZ2VzIEFuIHtBcnJheTxsaW50ZXIkTWVzc2FnZT59IHRvIGZldGNoIGNvZGUgYWN0aW9ucyBmb3IuIFRoaXMgaXMgdHlwaWNhbGx5IGEgbGlzdCBvZiBtZXNzYWdlc1xuICAgKiAgIGludGVyc2VjdGluZyBgcmFuZ2VgLlxuICAgKiBAcmV0dXJucyBBIHtQcm9taXNlfSBvZiBhbiB7QXJyYXl9IG9mIHthdG9tSWRlJENvZGVBY3Rpb259cyB0byBkaXNwbGF5LlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBhc3luYyBnZXRDb2RlQWN0aW9ucyhcbiAgICBjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXG4gICAgc2VydmVyQ2FwYWJpbGl0aWVzOiBTZXJ2ZXJDYXBhYmlsaXRpZXMsXG4gICAgbGludGVyQWRhcHRlcjogTGludGVyUHVzaFYyQWRhcHRlciB8IElkZURpYWdub3N0aWNBZGFwdGVyIHwgdW5kZWZpbmVkLFxuICAgIGVkaXRvcjogVGV4dEVkaXRvcixcbiAgICByYW5nZTogUmFuZ2UsXG4gICAgbGludGVyTWVzc2FnZXM6IGxpbnRlci5NZXNzYWdlW10gfCBhdG9tSWRlLkRpYWdub3N0aWNbXSxcbiAgICBmaWx0ZXJBY3Rpb25zOiAoYWN0aW9uczogKENvbW1hbmQgfCBDb2RlQWN0aW9uKVtdIHwgbnVsbCkgPT4gKENvbW1hbmQgfCBDb2RlQWN0aW9uKVtdIHwgbnVsbCA9IChhY3Rpb25zKSA9PiBhY3Rpb25zLFxuICAgIG9uQXBwbHk6IChhY3Rpb246IENvbW1hbmQgfCBDb2RlQWN0aW9uKSA9PiBQcm9taXNlPGJvb2xlYW4+ID0gKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHRydWUpXG4gICk6IFByb21pc2U8YXRvbUlkZS5Db2RlQWN0aW9uW10+IHtcbiAgICBpZiAobGludGVyQWRhcHRlciA9PSBudWxsKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgYXNzZXJ0KHNlcnZlckNhcGFiaWxpdGllcy5jb2RlQWN0aW9uUHJvdmlkZXIsIFwiTXVzdCBoYXZlIHRoZSB0ZXh0RG9jdW1lbnQvY29kZUFjdGlvbiBjYXBhYmlsaXR5XCIpXG5cbiAgICBjb25zdCBwYXJhbXMgPSBjcmVhdGVDb2RlQWN0aW9uUGFyYW1zKGxpbnRlckFkYXB0ZXIsIGVkaXRvciwgcmFuZ2UsIGxpbnRlck1lc3NhZ2VzKVxuICAgIGNvbnN0IGFjdGlvbnMgPSBmaWx0ZXJBY3Rpb25zKGF3YWl0IGNvbm5lY3Rpb24uY29kZUFjdGlvbihwYXJhbXMpKVxuICAgIGlmIChhY3Rpb25zID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gW11cbiAgICB9XG4gICAgcmV0dXJuIGFjdGlvbnMubWFwKChhY3Rpb24pID0+IENvZGVBY3Rpb25BZGFwdGVyLmNyZWF0ZUNvZGVBY3Rpb24oYWN0aW9uLCBjb25uZWN0aW9uLCBvbkFwcGx5KSlcbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGNyZWF0ZUNvZGVBY3Rpb24oXG4gICAgYWN0aW9uOiBDb21tYW5kIHwgQ29kZUFjdGlvbixcbiAgICBjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXG4gICAgb25BcHBseTogKGFjdGlvbjogQ29tbWFuZCB8IENvZGVBY3Rpb24pID0+IFByb21pc2U8Ym9vbGVhbj5cbiAgKTogYXRvbUlkZS5Db2RlQWN0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAgYXN5bmMgYXBwbHkoKSB7XG4gICAgICAgIGlmICgoYXdhaXQgb25BcHBseShhY3Rpb24pKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICByZXR1cm5cbiAgICAgICAgfVxuICAgICAgICBpZiAoQ29kZUFjdGlvbi5pcyhhY3Rpb24pKSB7XG4gICAgICAgICAgQ29kZUFjdGlvbkFkYXB0ZXIuYXBwbHlXb3Jrc3BhY2VFZGl0KGFjdGlvbi5lZGl0KVxuICAgICAgICAgIGF3YWl0IENvZGVBY3Rpb25BZGFwdGVyLmV4ZWN1dGVDb21tYW5kKGFjdGlvbi5jb21tYW5kLCBjb25uZWN0aW9uKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IENvZGVBY3Rpb25BZGFwdGVyLmV4ZWN1dGVDb21tYW5kKGFjdGlvbiwgY29ubmVjdGlvbilcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGdldFRpdGxlKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoYWN0aW9uLnRpdGxlKVxuICAgICAgfSxcbiAgICAgIGRpc3Bvc2UoKTogdm9pZCB7fSxcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBhcHBseVdvcmtzcGFjZUVkaXQoZWRpdDogV29ya3NwYWNlRWRpdCB8IHVuZGVmaW5lZCk6IHZvaWQge1xuICAgIGlmIChXb3Jrc3BhY2VFZGl0LmlzKGVkaXQpKSB7XG4gICAgICBBcHBseUVkaXRBZGFwdGVyLm9uQXBwbHlFZGl0KHsgZWRpdCB9KVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RhdGljIGFzeW5jIGV4ZWN1dGVDb21tYW5kKGNvbW1hbmQ6IGFueSwgY29ubmVjdGlvbjogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKENvbW1hbmQuaXMoY29tbWFuZCkpIHtcbiAgICAgIGF3YWl0IGNvbm5lY3Rpb24uZXhlY3V0ZUNvbW1hbmQoe1xuICAgICAgICBjb21tYW5kOiBjb21tYW5kLmNvbW1hbmQsXG4gICAgICAgIGFyZ3VtZW50czogY29tbWFuZC5hcmd1bWVudHMsXG4gICAgICB9KVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVDb2RlQWN0aW9uUGFyYW1zKFxuICBsaW50ZXJBZGFwdGVyOiBMaW50ZXJQdXNoVjJBZGFwdGVyIHwgSWRlRGlhZ25vc3RpY0FkYXB0ZXIsXG4gIGVkaXRvcjogVGV4dEVkaXRvcixcbiAgcmFuZ2U6IFJhbmdlLFxuICBsaW50ZXJNZXNzYWdlczogbGludGVyLk1lc3NhZ2VbXSB8IGF0b21JZGUuRGlhZ25vc3RpY1tdXG4pOiBDb2RlQWN0aW9uUGFyYW1zIHtcbiAgbGV0IGRpYWdub3N0aWNzOiBEaWFnbm9zdGljW11cbiAgaWYgKGxpbnRlck1lc3NhZ2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIGRpYWdub3N0aWNzID0gW11cbiAgfSBlbHNlIHtcbiAgICAvLyBUT0RPIGNvbXBpbGUgdGltZSBkaXNwYXRjaCB1c2luZyBmdW5jdGlvbiBuYW1lc1xuICAgIGRpYWdub3N0aWNzID0gYXJlTGludGVyTWVzc2FnZXMobGludGVyTWVzc2FnZXMpXG4gICAgICA/IGxpbnRlckFkYXB0ZXIuZ2V0TFNEaWFnbm9zdGljc0Zvck1lc3NhZ2VzKGxpbnRlck1lc3NhZ2VzIGFzIGxpbnRlci5NZXNzYWdlW10pXG4gICAgICA6IChsaW50ZXJBZGFwdGVyIGFzIElkZURpYWdub3N0aWNBZGFwdGVyKS5nZXRMU0RpYWdub3N0aWNzRm9ySWRlRGlhZ25vc3RpY3MoXG4gICAgICAgICAgbGludGVyTWVzc2FnZXMgYXMgYXRvbUlkZS5EaWFnbm9zdGljW10sXG4gICAgICAgICAgZWRpdG9yXG4gICAgICAgIClcbiAgfVxuICByZXR1cm4ge1xuICAgIHRleHREb2N1bWVudDogQ29udmVydC5lZGl0b3JUb1RleHREb2N1bWVudElkZW50aWZpZXIoZWRpdG9yKSxcbiAgICByYW5nZTogQ29udmVydC5hdG9tUmFuZ2VUb0xTUmFuZ2UocmFuZ2UpLFxuICAgIGNvbnRleHQ6IHtcbiAgICAgIGRpYWdub3N0aWNzLFxuICAgIH0sXG4gIH1cbn1cblxuZnVuY3Rpb24gYXJlTGludGVyTWVzc2FnZXMobGludGVyTWVzc2FnZXM6IGxpbnRlci5NZXNzYWdlW10gfCBhdG9tSWRlLkRpYWdub3N0aWNbXSk6IGJvb2xlYW4ge1xuICBpZiAoXCJleGNlcnB0XCIgaW4gbGludGVyTWVzc2FnZXNbMF0pIHtcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuIl19