Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Public: Listen to diagnostics messages from the language server and publish them
// to the user by way of the Linter Push (Indie) v2 API supported by Atom IDE UI.
let LinterPushV2Adapter = class LinterPushV2Adapter {

  // Public: Create a new {LinterPushV2Adapter} that will listen for diagnostics
  // via the supplied {LanguageClientConnection}.
  //
  // * `connection` A {LanguageClientConnection} to the language server that will provide diagnostics.
  constructor(connection) {
    this._diagnosticMap = new Map();
    this._diagnosticCodes = new Map();
    this._indies = new Set();

    connection.onPublishDiagnostics(this.captureDiagnostics.bind(this));
  }

  // Public: Attach this {LinterPushV2Adapter} to a given {V2IndieDelegate} registry.
  //
  // * `indie` A {V2IndieDelegate} that wants to receive messages.
  attach(indie) {
    this._indies.add(indie);
    this._diagnosticMap.forEach((value, key) => indie.setMessages(key, value));
    indie.onDidDestroy(() => {
      this._indies.delete(indie);
    });
  }

  // Public: Remove all {V2IndieDelegate} registries attached to this adapter and clear them.
  //
  // * `indie` A {V2IndieDelegate} that wants to receive messages.
  detachAll() {
    this._indies.forEach(i => i.clearMessages());
    this._indies.clear();
  }

  // Public: Capture the diagnostics sent from a langguage server, convert them to the
  // Linter V2 format and forward them on to any attached {V2IndieDelegate}s.
  //
  // * `params` The {PublishDiagnosticsParams} received from the language server that should
  //            be captured and forwarded on to any attached {V2IndieDelegate}s.
  captureDiagnostics(params) {
    const path = _convert2.default.uriToPath(params.uri);
    const codeMap = new Map();
    const messages = params.diagnostics.map(d => {
      const linterMessage = this.diagnosticToV2Message(path, d);
      codeMap.set(getCodeKey(linterMessage.location.position, d.message), d.code);
      return linterMessage;
    });
    this._diagnosticMap.set(path, messages);
    this._diagnosticCodes.set(path, codeMap);
    this._indies.forEach(i => i.setMessages(path, messages));
  }

  // Public: Convert a single {Diagnostic} received from a language server into a single
  // {V2Message} expected by the Linter V2 API.
  //
  // * `path` A string representing the path of the file the diagnostic belongs to.
  // * `diagnostics` A {Diagnostic} object received from the language server.
  //
  // Returns a {V2Message} equivalent to the {Diagnostic} object supplied by the language server.
  diagnosticToV2Message(path, diagnostic) {
    return {
      location: {
        file: path,
        position: _convert2.default.lsRangeToAtomRange(diagnostic.range)
      },
      excerpt: diagnostic.message,
      linterName: diagnostic.source,
      severity: LinterPushV2Adapter.diagnosticSeverityToSeverity(diagnostic.severity || -1)
    };
  }

  // Public: Convert a diagnostic severity number obtained from the language server into
  // the textual equivalent for a Linter {V2Message}.
  //
  // * `severity` A number representing the severity of the diagnostic.
  //
  // Returns a string of 'error', 'warning' or 'info' depending on the severity.
  static diagnosticSeverityToSeverity(severity) {
    switch (severity) {
      case _languageclient.DiagnosticSeverity.Error:
        return 'error';
      case _languageclient.DiagnosticSeverity.Warning:
        return 'warning';
      case _languageclient.DiagnosticSeverity.Information:
      case _languageclient.DiagnosticSeverity.Hint:
      default:
        return 'info';
    }
  }

  // Private: Get the recorded diagnostic code for a range/message.
  // Diagnostic codes are tricky because there's no suitable place in the Linter API for them.
  // For now, we'll record the original code for each range/message combination and retrieve it
  // when needed (e.g. for passing back into code actions)
  getDiagnosticCode(editor, range, text) {
    const path = editor.getPath();
    if (path != null) {
      const diagnosticCodes = this._diagnosticCodes.get(path);
      if (diagnosticCodes != null) {
        return diagnosticCodes.get(getCodeKey(range, text));
      }
    }
    return null;
  }
};
exports.default = LinterPushV2Adapter;


function getCodeKey(range, text) {
  return [].concat(...range.serialize(), text).join(',');
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9saW50ZXItcHVzaC12Mi1hZGFwdGVyLmpzIl0sIm5hbWVzIjpbIkxpbnRlclB1c2hWMkFkYXB0ZXIiLCJjb25zdHJ1Y3RvciIsImNvbm5lY3Rpb24iLCJfZGlhZ25vc3RpY01hcCIsIk1hcCIsIl9kaWFnbm9zdGljQ29kZXMiLCJfaW5kaWVzIiwiU2V0Iiwib25QdWJsaXNoRGlhZ25vc3RpY3MiLCJjYXB0dXJlRGlhZ25vc3RpY3MiLCJiaW5kIiwiYXR0YWNoIiwiaW5kaWUiLCJhZGQiLCJmb3JFYWNoIiwidmFsdWUiLCJrZXkiLCJzZXRNZXNzYWdlcyIsIm9uRGlkRGVzdHJveSIsImRlbGV0ZSIsImRldGFjaEFsbCIsImkiLCJjbGVhck1lc3NhZ2VzIiwiY2xlYXIiLCJwYXJhbXMiLCJwYXRoIiwidXJpVG9QYXRoIiwidXJpIiwiY29kZU1hcCIsIm1lc3NhZ2VzIiwiZGlhZ25vc3RpY3MiLCJtYXAiLCJkIiwibGludGVyTWVzc2FnZSIsImRpYWdub3N0aWNUb1YyTWVzc2FnZSIsInNldCIsImdldENvZGVLZXkiLCJsb2NhdGlvbiIsInBvc2l0aW9uIiwibWVzc2FnZSIsImNvZGUiLCJkaWFnbm9zdGljIiwiZmlsZSIsImxzUmFuZ2VUb0F0b21SYW5nZSIsInJhbmdlIiwiZXhjZXJwdCIsImxpbnRlck5hbWUiLCJzb3VyY2UiLCJzZXZlcml0eSIsImRpYWdub3N0aWNTZXZlcml0eVRvU2V2ZXJpdHkiLCJFcnJvciIsIldhcm5pbmciLCJJbmZvcm1hdGlvbiIsIkhpbnQiLCJnZXREaWFnbm9zdGljQ29kZSIsImVkaXRvciIsInRleHQiLCJnZXRQYXRoIiwiZGlhZ25vc3RpY0NvZGVzIiwiZ2V0IiwiY29uY2F0Iiwic2VyaWFsaXplIiwiam9pbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7QUFPQTs7Ozs7O0FBRUE7QUFDQTtJQUNxQkEsbUIsR0FBTixNQUFNQSxtQkFBTixDQUEwQjs7QUFLdkM7QUFDQTtBQUNBO0FBQ0E7QUFDQUMsY0FBWUMsVUFBWixFQUFrRDtBQUFBLFNBUmxEQyxjQVFrRCxHQVJLLElBQUlDLEdBQUosRUFRTDtBQUFBLFNBUGxEQyxnQkFPa0QsR0FQWSxJQUFJRCxHQUFKLEVBT1o7QUFBQSxTQU5sREUsT0FNa0QsR0FOWCxJQUFJQyxHQUFKLEVBTVc7O0FBQ2hETCxlQUFXTSxvQkFBWCxDQUFnQyxLQUFLQyxrQkFBTCxDQUF3QkMsSUFBeEIsQ0FBNkIsSUFBN0IsQ0FBaEM7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQUMsU0FBT0MsS0FBUCxFQUE0QztBQUMxQyxTQUFLTixPQUFMLENBQWFPLEdBQWIsQ0FBaUJELEtBQWpCO0FBQ0EsU0FBS1QsY0FBTCxDQUFvQlcsT0FBcEIsQ0FBNEIsQ0FBQ0MsS0FBRCxFQUFRQyxHQUFSLEtBQWdCSixNQUFNSyxXQUFOLENBQWtCRCxHQUFsQixFQUF1QkQsS0FBdkIsQ0FBNUM7QUFDQUgsVUFBTU0sWUFBTixDQUFtQixNQUFNO0FBQ3ZCLFdBQUtaLE9BQUwsQ0FBYWEsTUFBYixDQUFvQlAsS0FBcEI7QUFDRCxLQUZEO0FBR0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0FRLGNBQWtCO0FBQ2hCLFNBQUtkLE9BQUwsQ0FBYVEsT0FBYixDQUFxQk8sS0FBS0EsRUFBRUMsYUFBRixFQUExQjtBQUNBLFNBQUtoQixPQUFMLENBQWFpQixLQUFiO0FBQ0Q7O0FBRUQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBZCxxQkFBbUJlLE1BQW5CLEVBQTJEO0FBQ3pELFVBQU1DLE9BQU8sa0JBQVFDLFNBQVIsQ0FBa0JGLE9BQU9HLEdBQXpCLENBQWI7QUFDQSxVQUFNQyxVQUFVLElBQUl4QixHQUFKLEVBQWhCO0FBQ0EsVUFBTXlCLFdBQVdMLE9BQU9NLFdBQVAsQ0FBbUJDLEdBQW5CLENBQXVCQyxLQUFLO0FBQzNDLFlBQU1DLGdCQUFnQixLQUFLQyxxQkFBTCxDQUEyQlQsSUFBM0IsRUFBaUNPLENBQWpDLENBQXRCO0FBQ0FKLGNBQVFPLEdBQVIsQ0FBWUMsV0FBV0gsY0FBY0ksUUFBZCxDQUF1QkMsUUFBbEMsRUFBNENOLEVBQUVPLE9BQTlDLENBQVosRUFBb0VQLEVBQUVRLElBQXRFO0FBQ0EsYUFBT1AsYUFBUDtBQUNELEtBSmdCLENBQWpCO0FBS0EsU0FBSzlCLGNBQUwsQ0FBb0JnQyxHQUFwQixDQUF3QlYsSUFBeEIsRUFBOEJJLFFBQTlCO0FBQ0EsU0FBS3hCLGdCQUFMLENBQXNCOEIsR0FBdEIsQ0FBMEJWLElBQTFCLEVBQWdDRyxPQUFoQztBQUNBLFNBQUt0QixPQUFMLENBQWFRLE9BQWIsQ0FBcUJPLEtBQUtBLEVBQUVKLFdBQUYsQ0FBY1EsSUFBZCxFQUFvQkksUUFBcEIsQ0FBMUI7QUFDRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBSyx3QkFBc0JULElBQXRCLEVBQW9DZ0IsVUFBcEMsRUFBOEU7QUFDNUUsV0FBTztBQUNMSixnQkFBVTtBQUNSSyxjQUFNakIsSUFERTtBQUVSYSxrQkFBVSxrQkFBUUssa0JBQVIsQ0FBMkJGLFdBQVdHLEtBQXRDO0FBRkYsT0FETDtBQUtMQyxlQUFTSixXQUFXRixPQUxmO0FBTUxPLGtCQUFZTCxXQUFXTSxNQU5sQjtBQU9MQyxnQkFBVWhELG9CQUFvQmlELDRCQUFwQixDQUFpRFIsV0FBV08sUUFBWCxJQUF1QixDQUFDLENBQXpFO0FBUEwsS0FBUDtBQVNEOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQU9DLDRCQUFQLENBQW9DRCxRQUFwQyxFQUFvRjtBQUNsRixZQUFRQSxRQUFSO0FBQ0UsV0FBSyxtQ0FBbUJFLEtBQXhCO0FBQ0UsZUFBTyxPQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFdBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0E7QUFDRSxlQUFPLE1BQVA7QUFSSjtBQVVEOztBQUVEO0FBQ0E7QUFDQTtBQUNBO0FBQ0FDLG9CQUFrQkMsTUFBbEIsRUFBMkNYLEtBQTNDLEVBQThEWSxJQUE5RCxFQUFnRztBQUM5RixVQUFNL0IsT0FBTzhCLE9BQU9FLE9BQVAsRUFBYjtBQUNBLFFBQUloQyxRQUFRLElBQVosRUFBa0I7QUFDaEIsWUFBTWlDLGtCQUFrQixLQUFLckQsZ0JBQUwsQ0FBc0JzRCxHQUF0QixDQUEwQmxDLElBQTFCLENBQXhCO0FBQ0EsVUFBSWlDLG1CQUFtQixJQUF2QixFQUE2QjtBQUMzQixlQUFPQSxnQkFBZ0JDLEdBQWhCLENBQW9CdkIsV0FBV1EsS0FBWCxFQUFrQlksSUFBbEIsQ0FBcEIsQ0FBUDtBQUNEO0FBQ0Y7QUFDRCxXQUFPLElBQVA7QUFDRDtBQXJHc0MsQztrQkFBcEJ4RCxtQjs7O0FBd0dyQixTQUFTb0MsVUFBVCxDQUFvQlEsS0FBcEIsRUFBdUNZLElBQXZDLEVBQTZEO0FBQzNELFNBQU8sR0FBR0ksTUFBSCxDQUFVLEdBQUdoQixNQUFNaUIsU0FBTixFQUFiLEVBQWdDTCxJQUFoQyxFQUFzQ00sSUFBdEMsQ0FBMkMsR0FBM0MsQ0FBUDtBQUNEIiwiZmlsZSI6ImxpbnRlci1wdXNoLXYyLWFkYXB0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0IHtcclxuICBEaWFnbm9zdGljU2V2ZXJpdHksXHJcbiAgTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLFxyXG4gIHR5cGUgRGlhZ25vc3RpYyxcclxuICB0eXBlIERpYWdub3N0aWNDb2RlLFxyXG4gIHR5cGUgUHVibGlzaERpYWdub3N0aWNzUGFyYW1zLFxyXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcblxyXG4vLyBQdWJsaWM6IExpc3RlbiB0byBkaWFnbm9zdGljcyBtZXNzYWdlcyBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgYW5kIHB1Ymxpc2ggdGhlbVxyXG4vLyB0byB0aGUgdXNlciBieSB3YXkgb2YgdGhlIExpbnRlciBQdXNoIChJbmRpZSkgdjIgQVBJIHN1cHBvcnRlZCBieSBBdG9tIElERSBVSS5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTGludGVyUHVzaFYyQWRhcHRlciB7XHJcbiAgX2RpYWdub3N0aWNNYXA6IE1hcDxzdHJpbmcsIEFycmF5PGxpbnRlciRWMk1lc3NhZ2U+PiA9IG5ldyBNYXAoKTtcclxuICBfZGlhZ25vc3RpY0NvZGVzOiBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCA/RGlhZ25vc3RpY0NvZGU+PiA9IG5ldyBNYXAoKTtcclxuICBfaW5kaWVzOiBTZXQ8bGludGVyJFYySW5kaWVEZWxlZ2F0ZT4gPSBuZXcgU2V0KCk7XHJcblxyXG4gIC8vIFB1YmxpYzogQ3JlYXRlIGEgbmV3IHtMaW50ZXJQdXNoVjJBZGFwdGVyfSB0aGF0IHdpbGwgbGlzdGVuIGZvciBkaWFnbm9zdGljc1xyXG4gIC8vIHZpYSB0aGUgc3VwcGxpZWQge0xhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbn0uXHJcbiAgLy9cclxuICAvLyAqIGBjb25uZWN0aW9uYCBBIHtMYW5ndWFnZUNsaWVudENvbm5lY3Rpb259IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdGhhdCB3aWxsIHByb3ZpZGUgZGlhZ25vc3RpY3MuXHJcbiAgY29uc3RydWN0b3IoY29ubmVjdGlvbjogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uKSB7XHJcbiAgICBjb25uZWN0aW9uLm9uUHVibGlzaERpYWdub3N0aWNzKHRoaXMuY2FwdHVyZURpYWdub3N0aWNzLmJpbmQodGhpcykpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBBdHRhY2ggdGhpcyB7TGludGVyUHVzaFYyQWRhcHRlcn0gdG8gYSBnaXZlbiB7VjJJbmRpZURlbGVnYXRlfSByZWdpc3RyeS5cclxuICAvL1xyXG4gIC8vICogYGluZGllYCBBIHtWMkluZGllRGVsZWdhdGV9IHRoYXQgd2FudHMgdG8gcmVjZWl2ZSBtZXNzYWdlcy5cclxuICBhdHRhY2goaW5kaWU6IGxpbnRlciRWMkluZGllRGVsZWdhdGUpOiB2b2lkIHtcclxuICAgIHRoaXMuX2luZGllcy5hZGQoaW5kaWUpO1xyXG4gICAgdGhpcy5fZGlhZ25vc3RpY01hcC5mb3JFYWNoKCh2YWx1ZSwga2V5KSA9PiBpbmRpZS5zZXRNZXNzYWdlcyhrZXksIHZhbHVlKSk7XHJcbiAgICBpbmRpZS5vbkRpZERlc3Ryb3koKCkgPT4ge1xyXG4gICAgICB0aGlzLl9pbmRpZXMuZGVsZXRlKGluZGllKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBSZW1vdmUgYWxsIHtWMkluZGllRGVsZWdhdGV9IHJlZ2lzdHJpZXMgYXR0YWNoZWQgdG8gdGhpcyBhZGFwdGVyIGFuZCBjbGVhciB0aGVtLlxyXG4gIC8vXHJcbiAgLy8gKiBgaW5kaWVgIEEge1YySW5kaWVEZWxlZ2F0ZX0gdGhhdCB3YW50cyB0byByZWNlaXZlIG1lc3NhZ2VzLlxyXG4gIGRldGFjaEFsbCgpOiB2b2lkIHtcclxuICAgIHRoaXMuX2luZGllcy5mb3JFYWNoKGkgPT4gaS5jbGVhck1lc3NhZ2VzKCkpO1xyXG4gICAgdGhpcy5faW5kaWVzLmNsZWFyKCk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENhcHR1cmUgdGhlIGRpYWdub3N0aWNzIHNlbnQgZnJvbSBhIGxhbmdndWFnZSBzZXJ2ZXIsIGNvbnZlcnQgdGhlbSB0byB0aGVcclxuICAvLyBMaW50ZXIgVjIgZm9ybWF0IGFuZCBmb3J3YXJkIHRoZW0gb24gdG8gYW55IGF0dGFjaGVkIHtWMkluZGllRGVsZWdhdGV9cy5cclxuICAvL1xyXG4gIC8vICogYHBhcmFtc2AgVGhlIHtQdWJsaXNoRGlhZ25vc3RpY3NQYXJhbXN9IHJlY2VpdmVkIGZyb20gdGhlIGxhbmd1YWdlIHNlcnZlciB0aGF0IHNob3VsZFxyXG4gIC8vICAgICAgICAgICAgYmUgY2FwdHVyZWQgYW5kIGZvcndhcmRlZCBvbiB0byBhbnkgYXR0YWNoZWQge1YySW5kaWVEZWxlZ2F0ZX1zLlxyXG4gIGNhcHR1cmVEaWFnbm9zdGljcyhwYXJhbXM6IFB1Ymxpc2hEaWFnbm9zdGljc1BhcmFtcyk6IHZvaWQge1xyXG4gICAgY29uc3QgcGF0aCA9IENvbnZlcnQudXJpVG9QYXRoKHBhcmFtcy51cmkpO1xyXG4gICAgY29uc3QgY29kZU1hcCA9IG5ldyBNYXAoKTtcclxuICAgIGNvbnN0IG1lc3NhZ2VzID0gcGFyYW1zLmRpYWdub3N0aWNzLm1hcChkID0+IHtcclxuICAgICAgY29uc3QgbGludGVyTWVzc2FnZSA9IHRoaXMuZGlhZ25vc3RpY1RvVjJNZXNzYWdlKHBhdGgsIGQpO1xyXG4gICAgICBjb2RlTWFwLnNldChnZXRDb2RlS2V5KGxpbnRlck1lc3NhZ2UubG9jYXRpb24ucG9zaXRpb24sIGQubWVzc2FnZSksIGQuY29kZSk7XHJcbiAgICAgIHJldHVybiBsaW50ZXJNZXNzYWdlO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLl9kaWFnbm9zdGljTWFwLnNldChwYXRoLCBtZXNzYWdlcyk7XHJcbiAgICB0aGlzLl9kaWFnbm9zdGljQ29kZXMuc2V0KHBhdGgsIGNvZGVNYXApO1xyXG4gICAgdGhpcy5faW5kaWVzLmZvckVhY2goaSA9PiBpLnNldE1lc3NhZ2VzKHBhdGgsIG1lc3NhZ2VzKSk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBzaW5nbGUge0RpYWdub3N0aWN9IHJlY2VpdmVkIGZyb20gYSBsYW5ndWFnZSBzZXJ2ZXIgaW50byBhIHNpbmdsZVxyXG4gIC8vIHtWMk1lc3NhZ2V9IGV4cGVjdGVkIGJ5IHRoZSBMaW50ZXIgVjIgQVBJLlxyXG4gIC8vXHJcbiAgLy8gKiBgcGF0aGAgQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBwYXRoIG9mIHRoZSBmaWxlIHRoZSBkaWFnbm9zdGljIGJlbG9uZ3MgdG8uXHJcbiAgLy8gKiBgZGlhZ25vc3RpY3NgIEEge0RpYWdub3N0aWN9IG9iamVjdCByZWNlaXZlZCBmcm9tIHRoZSBsYW5ndWFnZSBzZXJ2ZXIuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEge1YyTWVzc2FnZX0gZXF1aXZhbGVudCB0byB0aGUge0RpYWdub3N0aWN9IG9iamVjdCBzdXBwbGllZCBieSB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIGRpYWdub3N0aWNUb1YyTWVzc2FnZShwYXRoOiBzdHJpbmcsIGRpYWdub3N0aWM6IERpYWdub3N0aWMpOiBsaW50ZXIkVjJNZXNzYWdlIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIGxvY2F0aW9uOiB7XHJcbiAgICAgICAgZmlsZTogcGF0aCxcclxuICAgICAgICBwb3NpdGlvbjogQ29udmVydC5sc1JhbmdlVG9BdG9tUmFuZ2UoZGlhZ25vc3RpYy5yYW5nZSksXHJcbiAgICAgIH0sXHJcbiAgICAgIGV4Y2VycHQ6IGRpYWdub3N0aWMubWVzc2FnZSxcclxuICAgICAgbGludGVyTmFtZTogZGlhZ25vc3RpYy5zb3VyY2UsXHJcbiAgICAgIHNldmVyaXR5OiBMaW50ZXJQdXNoVjJBZGFwdGVyLmRpYWdub3N0aWNTZXZlcml0eVRvU2V2ZXJpdHkoZGlhZ25vc3RpYy5zZXZlcml0eSB8fCAtMSksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgZGlhZ25vc3RpYyBzZXZlcml0eSBudW1iZXIgb2J0YWluZWQgZnJvbSB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGludG9cclxuICAvLyB0aGUgdGV4dHVhbCBlcXVpdmFsZW50IGZvciBhIExpbnRlciB7VjJNZXNzYWdlfS5cclxuICAvL1xyXG4gIC8vICogYHNldmVyaXR5YCBBIG51bWJlciByZXByZXNlbnRpbmcgdGhlIHNldmVyaXR5IG9mIHRoZSBkaWFnbm9zdGljLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHN0cmluZyBvZiAnZXJyb3InLCAnd2FybmluZycgb3IgJ2luZm8nIGRlcGVuZGluZyBvbiB0aGUgc2V2ZXJpdHkuXHJcbiAgc3RhdGljIGRpYWdub3N0aWNTZXZlcml0eVRvU2V2ZXJpdHkoc2V2ZXJpdHk6IG51bWJlcik6ICdlcnJvcicgfCAnd2FybmluZycgfCAnaW5mbycge1xyXG4gICAgc3dpdGNoIChzZXZlcml0eSkge1xyXG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5FcnJvcjpcclxuICAgICAgICByZXR1cm4gJ2Vycm9yJztcclxuICAgICAgY2FzZSBEaWFnbm9zdGljU2V2ZXJpdHkuV2FybmluZzpcclxuICAgICAgICByZXR1cm4gJ3dhcm5pbmcnO1xyXG4gICAgICBjYXNlIERpYWdub3N0aWNTZXZlcml0eS5JbmZvcm1hdGlvbjpcclxuICAgICAgY2FzZSBEaWFnbm9zdGljU2V2ZXJpdHkuSGludDpcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICByZXR1cm4gJ2luZm8nO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gUHJpdmF0ZTogR2V0IHRoZSByZWNvcmRlZCBkaWFnbm9zdGljIGNvZGUgZm9yIGEgcmFuZ2UvbWVzc2FnZS5cclxuICAvLyBEaWFnbm9zdGljIGNvZGVzIGFyZSB0cmlja3kgYmVjYXVzZSB0aGVyZSdzIG5vIHN1aXRhYmxlIHBsYWNlIGluIHRoZSBMaW50ZXIgQVBJIGZvciB0aGVtLlxyXG4gIC8vIEZvciBub3csIHdlJ2xsIHJlY29yZCB0aGUgb3JpZ2luYWwgY29kZSBmb3IgZWFjaCByYW5nZS9tZXNzYWdlIGNvbWJpbmF0aW9uIGFuZCByZXRyaWV2ZSBpdFxyXG4gIC8vIHdoZW4gbmVlZGVkIChlLmcuIGZvciBwYXNzaW5nIGJhY2sgaW50byBjb2RlIGFjdGlvbnMpXHJcbiAgZ2V0RGlhZ25vc3RpY0NvZGUoZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsIHJhbmdlOiBhdG9tJFJhbmdlLCB0ZXh0OiBzdHJpbmcpOiA/KG51bWJlciB8IHN0cmluZykge1xyXG4gICAgY29uc3QgcGF0aCA9IGVkaXRvci5nZXRQYXRoKCk7XHJcbiAgICBpZiAocGF0aCAhPSBudWxsKSB7XHJcbiAgICAgIGNvbnN0IGRpYWdub3N0aWNDb2RlcyA9IHRoaXMuX2RpYWdub3N0aWNDb2Rlcy5nZXQocGF0aCk7XHJcbiAgICAgIGlmIChkaWFnbm9zdGljQ29kZXMgIT0gbnVsbCkge1xyXG4gICAgICAgIHJldHVybiBkaWFnbm9zdGljQ29kZXMuZ2V0KGdldENvZGVLZXkocmFuZ2UsIHRleHQpKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRDb2RlS2V5KHJhbmdlOiBhdG9tJFJhbmdlLCB0ZXh0OiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gIHJldHVybiBbXS5jb25jYXQoLi4ucmFuZ2Uuc2VyaWFsaXplKCksIHRleHQpLmpvaW4oJywnKTtcclxufVxyXG4iXX0=