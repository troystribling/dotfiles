"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ls = require("./languageclient");
const atom_1 = require("atom");
// eslint-disable-next-line import/no-deprecated
const diagnostic_adapter_1 = require("./adapters/diagnostic-adapter");
/**
 * Public: Class that contains a number of helper methods for general conversions between the language server protocol
 * and Atom/Atom packages.
 */
class Convert {
    /**
     * Public: Convert a path to a Uri.
     *
     * @param filePath A file path to convert to a Uri.
     * @returns The Uri corresponding to the path. e.g. file:///a/b/c.txt
     */
    static pathToUri(filePath) {
        let newPath = filePath.replace(/\\/g, "/");
        if (newPath[0] !== "/") {
            newPath = `/${newPath}`;
        }
        return encodeURI(`file://${newPath}`).replace(/[#?]/g, encodeURIComponent);
    }
    /**
     * Public: Convert a Uri to a path.
     *
     * @param uri A Uri to convert to a file path.
     * @returns A file path corresponding to the Uri. e.g. /a/b/c.txt If the Uri does not begin file: then it is returned
     *   as-is to allow Atom to deal with http/https sources in the future.
     */
    static uriToPath(uri) {
        const url = new URL(uri, "file://");
        if (url.protocol !== "file:" || url.pathname == null) {
            return uri;
        }
        let filePath = decodeURIComponent(url.pathname);
        if (process.platform === "win32") {
            // Deal with Windows drive names
            if (filePath[0] === "/") {
                filePath = filePath.substr(1);
            }
            return filePath.replace(/\//g, "\\");
        }
        return filePath;
    }
    /**
     * Public: Convert an Atom {Point} to a language server {Position}.
     *
     * @param point An Atom {Point} to convert from.
     * @returns The {Position} representation of the Atom {PointObject}.
     */
    static pointToPosition(point) {
        return { line: point.row, character: point.column };
    }
    /**
     * Public: Convert a language server {Position} into an Atom {PointObject}.
     *
     * @param position A language server {Position} to convert from.
     * @returns The Atom {PointObject} representation of the given {Position}.
     */
    static positionToPoint(position) {
        return new atom_1.Point(position.line, position.character);
    }
    /**
     * Public: Convert a language server {Range} into an Atom {Range}.
     *
     * @param range A language server {Range} to convert from.
     * @returns The Atom {Range} representation of the given language server {Range}.
     */
    static lsRangeToAtomRange(range) {
        return new atom_1.Range(Convert.positionToPoint(range.start), Convert.positionToPoint(range.end));
    }
    /**
     * Public: Convert an Atom {Range} into an language server {Range}.
     *
     * @param range An Atom {Range} to convert from.
     * @returns The language server {Range} representation of the given Atom {Range}.
     */
    static atomRangeToLSRange(range) {
        return {
            start: Convert.pointToPosition(range.start),
            end: Convert.pointToPosition(range.end),
        };
    }
    /**
     * Public: Create a {TextDocumentIdentifier} from an Atom {TextEditor}.
     *
     * @param editor A {TextEditor} that will be used to form the uri property.
     * @returns A {TextDocumentIdentifier} that has a `uri` property with the Uri for the given editor's path.
     */
    static editorToTextDocumentIdentifier(editor) {
        return { uri: Convert.pathToUri(editor.getPath() || "") };
    }
    /**
     * Public: Create a {TextDocumentPositionParams} from a {TextEditor} and optional {Point}.
     *
     * @param editor A {TextEditor} that will be used to form the uri property.
     * @param point An optional {Point} that will supply the position property. If not specified the current cursor
     *   position will be used.
     * @returns A {TextDocumentPositionParams} that has textDocument property with the editors {TextDocumentIdentifier}
     *   and a position property with the supplied point (or current cursor position when not specified).
     */
    static editorToTextDocumentPositionParams(editor, point) {
        return {
            textDocument: Convert.editorToTextDocumentIdentifier(editor),
            position: Convert.pointToPosition(point != null ? point : editor.getCursorBufferPosition()),
        };
    }
    /**
     * Public: Create a string of scopes for the atom text editor using the data-grammar selector from an {Array} of
     * grammarScope strings.
     *
     * @param grammarScopes An {Array} of grammar scope string to convert from.
     * @returns A single comma-separated list of CSS selectors targetting the grammars of Atom text editors. e.g. `['c',
     *   'cpp']` => `'atom-text-editor[data-grammar='c'], atom-text-editor[data-grammar='cpp']`
     */
    static grammarScopesToTextEditorScopes(grammarScopes) {
        return grammarScopes
            .map((g) => `atom-text-editor[data-grammar="${Convert.encodeHTMLAttribute(g.replace(/\./g, " "))}"]`)
            .join(", ");
    }
    /**
     * Public: Encode a string so that it can be safely used within a HTML attribute - i.e. replacing all quoted values
     * with their HTML entity encoded versions. e.g. `Hello"` becomes `Hello&quot;`
     *
     * @param s A string to be encoded.
     * @returns A string that is HTML attribute encoded by replacing &, <, >, " and ' with their HTML entity named equivalents.
     */
    static encodeHTMLAttribute(s) {
        const attributeMap = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&apos;",
        };
        return s.replace(/["&'<>]/g, (c) => attributeMap[c]);
    }
    /**
     * Public: Convert an Atom File Event as received from atom.project.onDidChangeFiles and convert it into an Array of
     * Language Server Protocol {FileEvent} objects. Normally this will be a 1-to-1 but renames will be represented by a
     * deletion and a subsequent creation as LSP does not know about renames.
     *
     * @param fileEvent An {atom$ProjectFileEvent} to be converted.
     * @returns An array of LSP {ls.FileEvent} objects that equivalent conversions to the fileEvent parameter.
     */
    static atomFileEventToLSFileEvents(fileEvent) {
        switch (fileEvent.action) {
            case "created":
                return [{ uri: Convert.pathToUri(fileEvent.path), type: ls.FileChangeType.Created }];
            case "modified":
                return [{ uri: Convert.pathToUri(fileEvent.path), type: ls.FileChangeType.Changed }];
            case "deleted":
                return [{ uri: Convert.pathToUri(fileEvent.path), type: ls.FileChangeType.Deleted }];
            case "renamed": {
                const results = [];
                if (fileEvent.oldPath) {
                    results.push({ uri: Convert.pathToUri(fileEvent.oldPath), type: ls.FileChangeType.Deleted });
                }
                if (fileEvent.path) {
                    results.push({ uri: Convert.pathToUri(fileEvent.path), type: ls.FileChangeType.Created });
                }
                return results;
            }
            default:
                return [];
        }
    }
    /** @deprecated Use Linter V2 service */
    static atomIdeDiagnosticToLSDiagnostic(diagnostic) {
        // eslint-disable-next-line import/no-deprecated
        return diagnostic_adapter_1.atomIdeDiagnosticToLSDiagnostic(diagnostic);
    }
    /** @deprecated Use Linter V2 service */
    static diagnosticTypeToLSSeverity(type) {
        // eslint-disable-next-line import/no-deprecated
        return diagnostic_adapter_1.diagnosticTypeToLSSeverity(type);
    }
    /**
     * Public: Convert an array of language server protocol {atomIde.TextEdit} objects to an equivalent array of Atom
     * {atomIde.TextEdit} objects.
     *
     * @param textEdits The language server protocol {atomIde.TextEdit} objects to convert.
     * @returns An {Array} of Atom {atomIde.TextEdit} objects.
     */
    static convertLsTextEdits(textEdits) {
        return (textEdits || []).map(Convert.convertLsTextEdit);
    }
    /**
     * Public: Convert a language server protocol {atomIde.TextEdit} object to the Atom equivalent {atomIde.TextEdit}.
     *
     * @param textEdits The language server protocol {atomIde.TextEdit} objects to convert.
     * @returns An Atom {atomIde.TextEdit} object.
     */
    static convertLsTextEdit(textEdit) {
        // TODO: support annotations
        return {
            oldRange: Convert.lsRangeToAtomRange(textEdit.range),
            newText: textEdit.newText,
        };
    }
}
exports.default = Convert;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9jb252ZXJ0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsdUNBQXNDO0FBQ3RDLCtCQUFpRTtBQUVqRSxnREFBZ0Q7QUFDaEQsc0VBQTJHO0FBRTNHOzs7R0FHRztBQUNILE1BQXFCLE9BQU87SUFDMUI7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQWdCO1FBQ3RDLElBQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQzFDLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUN0QixPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQTtTQUN4QjtRQUNELE9BQU8sU0FBUyxDQUFDLFVBQVUsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLGtCQUFrQixDQUFDLENBQUE7SUFDNUUsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLE1BQU0sQ0FBQyxTQUFTLENBQUMsR0FBVztRQUNqQyxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUUsU0FBUyxDQUFDLENBQUE7UUFDbkMsSUFBSSxHQUFHLENBQUMsUUFBUSxLQUFLLE9BQU8sSUFBSSxHQUFHLENBQUMsUUFBUSxJQUFJLElBQUksRUFBRTtZQUNwRCxPQUFPLEdBQUcsQ0FBQTtTQUNYO1FBRUQsSUFBSSxRQUFRLEdBQUcsa0JBQWtCLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQy9DLElBQUksT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLEVBQUU7WUFDaEMsZ0NBQWdDO1lBQ2hDLElBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtnQkFDdkIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7YUFDOUI7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QUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ3BELENBQUM7SUFFRCx3Q0FBd0M7SUFDakMsTUFBTSxDQUFDLDBCQUEwQixDQUFDLElBQTRCO1FBQ25FLGdEQUFnRDtRQUNoRCxPQUFPLCtDQUEwQixDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ3pDLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSSxNQUFNLENBQUMsa0JBQWtCLENBQUMsU0FBZ0M7UUFDL0QsT0FBTyxDQUFDLFNBQVMsSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUE7SUFDekQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksTUFBTSxDQUFDLGlCQUFpQixDQUFDLFFBQXFCO1FBQ25ELDRCQUE0QjtRQUM1QixPQUFPO1lBQ0wsUUFBUSxFQUFFLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO1lBQ3BELE9BQU8sRUFBRSxRQUFRLENBQUMsT0FBTztTQUMxQixDQUFBO0lBQ0gsQ0FBQztDQUNGO0FBL01ELDBCQStNQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlICogYXMgYXRvbUlkZSBmcm9tIFwiYXRvbS1pZGUtYmFzZVwiXG5pbXBvcnQgKiBhcyBscyBmcm9tIFwiLi9sYW5ndWFnZWNsaWVudFwiXG5pbXBvcnQgeyBQb2ludCwgRmlsZXN5c3RlbUNoYW5nZSwgUmFuZ2UsIFRleHRFZGl0b3IgfSBmcm9tIFwiYXRvbVwiXG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBpbXBvcnQvbm8tZGVwcmVjYXRlZFxuaW1wb3J0IHsgZGlhZ25vc3RpY1R5cGVUb0xTU2V2ZXJpdHksIGF0b21JZGVEaWFnbm9zdGljVG9MU0RpYWdub3N0aWMgfSBmcm9tIFwiLi9hZGFwdGVycy9kaWFnbm9zdGljLWFkYXB0ZXJcIlxuXG4vKipcbiAqIFB1YmxpYzogQ2xhc3MgdGhhdCBjb250YWlucyBhIG51bWJlciBvZiBoZWxwZXIgbWV0aG9kcyBmb3IgZ2VuZXJhbCBjb252ZXJzaW9ucyBiZXR3ZWVuIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2xcbiAqIGFuZCBBdG9tL0F0b20gcGFja2FnZXMuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbnZlcnQge1xuICAvKipcbiAgICogUHVibGljOiBDb252ZXJ0IGEgcGF0aCB0byBhIFVyaS5cbiAgICpcbiAgICogQHBhcmFtIGZpbGVQYXRoIEEgZmlsZSBwYXRoIHRvIGNvbnZlcnQgdG8gYSBVcmkuXG4gICAqIEByZXR1cm5zIFRoZSBVcmkgY29ycmVzcG9uZGluZyB0byB0aGUgcGF0aC4gZS5nLiBmaWxlOi8vL2EvYi9jLnR4dFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBwYXRoVG9VcmkoZmlsZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IG5ld1BhdGggPSBmaWxlUGF0aC5yZXBsYWNlKC9cXFxcL2csIFwiL1wiKVxuICAgIGlmIChuZXdQYXRoWzBdICE9PSBcIi9cIikge1xuICAgICAgbmV3UGF0aCA9IGAvJHtuZXdQYXRofWBcbiAgICB9XG4gICAgcmV0dXJuIGVuY29kZVVSSShgZmlsZTovLyR7bmV3UGF0aH1gKS5yZXBsYWNlKC9bIz9dL2csIGVuY29kZVVSSUNvbXBvbmVudClcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWM6IENvbnZlcnQgYSBVcmkgdG8gYSBwYXRoLlxuICAgKlxuICAgKiBAcGFyYW0gdXJpIEEgVXJpIHRvIGNvbnZlcnQgdG8gYSBmaWxlIHBhdGguXG4gICAqIEByZXR1cm5zIEEgZmlsZSBwYXRoIGNvcnJlc3BvbmRpbmcgdG8gdGhlIFVyaS4gZS5nLiAvYS9iL2MudHh0IElmIHRoZSBVcmkgZG9lcyBub3QgYmVnaW4gZmlsZTogdGhlbiBpdCBpcyByZXR1cm5lZFxuICAgKiAgIGFzLWlzIHRvIGFsbG93IEF0b20gdG8gZGVhbCB3aXRoIGh0dHAvaHR0cHMgc291cmNlcyBpbiB0aGUgZnV0dXJlLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyB1cmlUb1BhdGgodXJpOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodXJpLCBcImZpbGU6Ly9cIilcbiAgICBpZiAodXJsLnByb3RvY29sICE9PSBcImZpbGU6XCIgfHwgdXJsLnBhdGhuYW1lID09IG51bGwpIHtcbiAgICAgIHJldHVybiB1cmlcbiAgICB9XG5cbiAgICBsZXQgZmlsZVBhdGggPSBkZWNvZGVVUklDb21wb25lbnQodXJsLnBhdGhuYW1lKVxuICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIpIHtcbiAgICAgIC8vIERlYWwgd2l0aCBXaW5kb3dzIGRyaXZlIG5hbWVzXG4gICAgICBpZiAoZmlsZVBhdGhbMF0gPT09IFwiL1wiKSB7XG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGguc3Vic3RyKDEpXG4gICAgICB9XG4gICAgICByZXR1cm4gZmlsZVBhdGgucmVwbGFjZSgvXFwvL2csIFwiXFxcXFwiKVxuICAgIH1cbiAgICByZXR1cm4gZmlsZVBhdGhcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWM6IENvbnZlcnQgYW4gQXRvbSB7UG9pbnR9IHRvIGEgbGFuZ3VhZ2Ugc2VydmVyIHtQb3NpdGlvbn0uXG4gICAqXG4gICAqIEBwYXJhbSBwb2ludCBBbiBBdG9tIHtQb2ludH0gdG8gY29udmVydCBmcm9tLlxuICAgKiBAcmV0dXJucyBUaGUge1Bvc2l0aW9ufSByZXByZXNlbnRhdGlvbiBvZiB0aGUgQXRvbSB7UG9pbnRPYmplY3R9LlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBwb2ludFRvUG9zaXRpb24ocG9pbnQ6IFBvaW50KTogbHMuUG9zaXRpb24ge1xuICAgIHJldHVybiB7IGxpbmU6IHBvaW50LnJvdywgY2hhcmFjdGVyOiBwb2ludC5jb2x1bW4gfVxuICB9XG5cbiAgLyoqXG4gICAqIFB1YmxpYzogQ29udmVydCBhIGxhbmd1YWdlIHNlcnZlciB7UG9zaXRpb259IGludG8gYW4gQXRvbSB7UG9pbnRPYmplY3R9LlxuICAgKlxuICAgKiBAcGFyYW0gcG9zaXRpb24gQSBsYW5ndWFnZSBzZXJ2ZXIge1Bvc2l0aW9ufSB0byBjb252ZXJ0IGZyb20uXG4gICAqIEByZXR1cm5zIFRoZSBBdG9tIHtQb2ludE9iamVjdH0gcmVwcmVzZW50YXRpb24gb2YgdGhlIGdpdmVuIHtQb3NpdGlvbn0uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIHBvc2l0aW9uVG9Qb2ludChwb3NpdGlvbjogbHMuUG9zaXRpb24pOiBQb2ludCB7XG4gICAgcmV0dXJuIG5ldyBQb2ludChwb3NpdGlvbi5saW5lLCBwb3NpdGlvbi5jaGFyYWN0ZXIpXG4gIH1cblxuICAvKipcbiAgICogUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHtSYW5nZX0gaW50byBhbiBBdG9tIHtSYW5nZX0uXG4gICAqXG4gICAqIEBwYXJhbSByYW5nZSBBIGxhbmd1YWdlIHNlcnZlciB7UmFuZ2V9IHRvIGNvbnZlcnQgZnJvbS5cbiAgICogQHJldHVybnMgVGhlIEF0b20ge1JhbmdlfSByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gbGFuZ3VhZ2Ugc2VydmVyIHtSYW5nZX0uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGxzUmFuZ2VUb0F0b21SYW5nZShyYW5nZTogbHMuUmFuZ2UpOiBSYW5nZSB7XG4gICAgcmV0dXJuIG5ldyBSYW5nZShDb252ZXJ0LnBvc2l0aW9uVG9Qb2ludChyYW5nZS5zdGFydCksIENvbnZlcnQucG9zaXRpb25Ub1BvaW50KHJhbmdlLmVuZCkpXG4gIH1cblxuICAvKipcbiAgICogUHVibGljOiBDb252ZXJ0IGFuIEF0b20ge1JhbmdlfSBpbnRvIGFuIGxhbmd1YWdlIHNlcnZlciB7UmFuZ2V9LlxuICAgKlxuICAgKiBAcGFyYW0gcmFuZ2UgQW4gQXRvbSB7UmFuZ2V9IHRvIGNvbnZlcnQgZnJvbS5cbiAgICogQHJldHVybnMgVGhlIGxhbmd1YWdlIHNlcnZlciB7UmFuZ2V9IHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBBdG9tIHtSYW5nZX0uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGF0b21SYW5nZVRvTFNSYW5nZShyYW5nZTogUmFuZ2UpOiBscy5SYW5nZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXJ0OiBDb252ZXJ0LnBvaW50VG9Qb3NpdGlvbihyYW5nZS5zdGFydCksXG4gICAgICBlbmQ6IENvbnZlcnQucG9pbnRUb1Bvc2l0aW9uKHJhbmdlLmVuZCksXG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFB1YmxpYzogQ3JlYXRlIGEge1RleHREb2N1bWVudElkZW50aWZpZXJ9IGZyb20gYW4gQXRvbSB7VGV4dEVkaXRvcn0uXG4gICAqXG4gICAqIEBwYXJhbSBlZGl0b3IgQSB7VGV4dEVkaXRvcn0gdGhhdCB3aWxsIGJlIHVzZWQgdG8gZm9ybSB0aGUgdXJpIHByb3BlcnR5LlxuICAgKiBAcmV0dXJucyBBIHtUZXh0RG9jdW1lbnRJZGVudGlmaWVyfSB0aGF0IGhhcyBhIGB1cmlgIHByb3BlcnR5IHdpdGggdGhlIFVyaSBmb3IgdGhlIGdpdmVuIGVkaXRvcidzIHBhdGguXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllcihlZGl0b3I6IFRleHRFZGl0b3IpOiBscy5UZXh0RG9jdW1lbnRJZGVudGlmaWVyIHtcbiAgICByZXR1cm4geyB1cmk6IENvbnZlcnQucGF0aFRvVXJpKGVkaXRvci5nZXRQYXRoKCkgfHwgXCJcIikgfVxuICB9XG5cbiAgLyoqXG4gICAqIFB1YmxpYzogQ3JlYXRlIGEge1RleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zfSBmcm9tIGEge1RleHRFZGl0b3J9IGFuZCBvcHRpb25hbCB7UG9pbnR9LlxuICAgKlxuICAgKiBAcGFyYW0gZWRpdG9yIEEge1RleHRFZGl0b3J9IHRoYXQgd2lsbCBiZSB1c2VkIHRvIGZvcm0gdGhlIHVyaSBwcm9wZXJ0eS5cbiAgICogQHBhcmFtIHBvaW50IEFuIG9wdGlvbmFsIHtQb2ludH0gdGhhdCB3aWxsIHN1cHBseSB0aGUgcG9zaXRpb24gcHJvcGVydHkuIElmIG5vdCBzcGVjaWZpZWQgdGhlIGN1cnJlbnQgY3Vyc29yXG4gICAqICAgcG9zaXRpb24gd2lsbCBiZSB1c2VkLlxuICAgKiBAcmV0dXJucyBBIHtUZXh0RG9jdW1lbnRQb3NpdGlvblBhcmFtc30gdGhhdCBoYXMgdGV4dERvY3VtZW50IHByb3BlcnR5IHdpdGggdGhlIGVkaXRvcnMge1RleHREb2N1bWVudElkZW50aWZpZXJ9XG4gICAqICAgYW5kIGEgcG9zaXRpb24gcHJvcGVydHkgd2l0aCB0aGUgc3VwcGxpZWQgcG9pbnQgKG9yIGN1cnJlbnQgY3Vyc29yIHBvc2l0aW9uIHdoZW4gbm90IHNwZWNpZmllZCkuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGVkaXRvclRvVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMoZWRpdG9yOiBUZXh0RWRpdG9yLCBwb2ludD86IFBvaW50KTogbHMuVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0RG9jdW1lbnQ6IENvbnZlcnQuZWRpdG9yVG9UZXh0RG9jdW1lbnRJZGVudGlmaWVyKGVkaXRvciksXG4gICAgICBwb3NpdGlvbjogQ29udmVydC5wb2ludFRvUG9zaXRpb24ocG9pbnQgIT0gbnVsbCA/IHBvaW50IDogZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkpLFxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWM6IENyZWF0ZSBhIHN0cmluZyBvZiBzY29wZXMgZm9yIHRoZSBhdG9tIHRleHQgZWRpdG9yIHVzaW5nIHRoZSBkYXRhLWdyYW1tYXIgc2VsZWN0b3IgZnJvbSBhbiB7QXJyYXl9IG9mXG4gICAqIGdyYW1tYXJTY29wZSBzdHJpbmdzLlxuICAgKlxuICAgKiBAcGFyYW0gZ3JhbW1hclNjb3BlcyBBbiB7QXJyYXl9IG9mIGdyYW1tYXIgc2NvcGUgc3RyaW5nIHRvIGNvbnZlcnQgZnJvbS5cbiAgICogQHJldHVybnMgQSBzaW5nbGUgY29tbWEtc2VwYXJhdGVkIGxpc3Qgb2YgQ1NTIHNlbGVjdG9ycyB0YXJnZXR0aW5nIHRoZSBncmFtbWFycyBvZiBBdG9tIHRleHQgZWRpdG9ycy4gZS5nLiBgWydjJyxcbiAgICogICAnY3BwJ11gID0+IGAnYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXI9J2MnXSwgYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXI9J2NwcCddYFxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBncmFtbWFyU2NvcGVzVG9UZXh0RWRpdG9yU2NvcGVzKGdyYW1tYXJTY29wZXM6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gZ3JhbW1hclNjb3Blc1xuICAgICAgLm1hcCgoZykgPT4gYGF0b20tdGV4dC1lZGl0b3JbZGF0YS1ncmFtbWFyPVwiJHtDb252ZXJ0LmVuY29kZUhUTUxBdHRyaWJ1dGUoZy5yZXBsYWNlKC9cXC4vZywgXCIgXCIpKX1cIl1gKVxuICAgICAgLmpvaW4oXCIsIFwiKVxuICB9XG5cbiAgLyoqXG4gICAqIFB1YmxpYzogRW5jb2RlIGEgc3RyaW5nIHNvIHRoYXQgaXQgY2FuIGJlIHNhZmVseSB1c2VkIHdpdGhpbiBhIEhUTUwgYXR0cmlidXRlIC0gaS5lLiByZXBsYWNpbmcgYWxsIHF1b3RlZCB2YWx1ZXNcbiAgICogd2l0aCB0aGVpciBIVE1MIGVudGl0eSBlbmNvZGVkIHZlcnNpb25zLiBlLmcuIGBIZWxsb1wiYCBiZWNvbWVzIGBIZWxsbyZxdW90O2BcbiAgICpcbiAgICogQHBhcmFtIHMgQSBzdHJpbmcgdG8gYmUgZW5jb2RlZC5cbiAgICogQHJldHVybnMgQSBzdHJpbmcgdGhhdCBpcyBIVE1MIGF0dHJpYnV0ZSBlbmNvZGVkIGJ5IHJlcGxhY2luZyAmLCA8LCA+LCBcIiBhbmQgJyB3aXRoIHRoZWlyIEhUTUwgZW50aXR5IG5hbWVkIGVxdWl2YWxlbnRzLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBlbmNvZGVIVE1MQXR0cmlidXRlKHM6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgYXR0cmlidXRlTWFwOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xuICAgICAgXCImXCI6IFwiJmFtcDtcIixcbiAgICAgIFwiPFwiOiBcIiZsdDtcIixcbiAgICAgIFwiPlwiOiBcIiZndDtcIixcbiAgICAgICdcIic6IFwiJnF1b3Q7XCIsXG4gICAgICBcIidcIjogXCImYXBvcztcIixcbiAgICB9XG4gICAgcmV0dXJuIHMucmVwbGFjZSgvW1wiJic8Pl0vZywgKGMpID0+IGF0dHJpYnV0ZU1hcFtjXSlcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWM6IENvbnZlcnQgYW4gQXRvbSBGaWxlIEV2ZW50IGFzIHJlY2VpdmVkIGZyb20gYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXMgYW5kIGNvbnZlcnQgaXQgaW50byBhbiBBcnJheSBvZlxuICAgKiBMYW5ndWFnZSBTZXJ2ZXIgUHJvdG9jb2wge0ZpbGVFdmVudH0gb2JqZWN0cy4gTm9ybWFsbHkgdGhpcyB3aWxsIGJlIGEgMS10by0xIGJ1dCByZW5hbWVzIHdpbGwgYmUgcmVwcmVzZW50ZWQgYnkgYVxuICAgKiBkZWxldGlvbiBhbmQgYSBzdWJzZXF1ZW50IGNyZWF0aW9uIGFzIExTUCBkb2VzIG5vdCBrbm93IGFib3V0IHJlbmFtZXMuXG4gICAqXG4gICAqIEBwYXJhbSBmaWxlRXZlbnQgQW4ge2F0b20kUHJvamVjdEZpbGVFdmVudH0gdG8gYmUgY29udmVydGVkLlxuICAgKiBAcmV0dXJucyBBbiBhcnJheSBvZiBMU1Age2xzLkZpbGVFdmVudH0gb2JqZWN0cyB0aGF0IGVxdWl2YWxlbnQgY29udmVyc2lvbnMgdG8gdGhlIGZpbGVFdmVudCBwYXJhbWV0ZXIuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGF0b21GaWxlRXZlbnRUb0xTRmlsZUV2ZW50cyhmaWxlRXZlbnQ6IEZpbGVzeXN0ZW1DaGFuZ2UpOiBscy5GaWxlRXZlbnRbXSB7XG4gICAgc3dpdGNoIChmaWxlRXZlbnQuYWN0aW9uKSB7XG4gICAgICBjYXNlIFwiY3JlYXRlZFwiOlxuICAgICAgICByZXR1cm4gW3sgdXJpOiBDb252ZXJ0LnBhdGhUb1VyaShmaWxlRXZlbnQucGF0aCksIHR5cGU6IGxzLkZpbGVDaGFuZ2VUeXBlLkNyZWF0ZWQgfV1cbiAgICAgIGNhc2UgXCJtb2RpZmllZFwiOlxuICAgICAgICByZXR1cm4gW3sgdXJpOiBDb252ZXJ0LnBhdGhUb1VyaShmaWxlRXZlbnQucGF0aCksIHR5cGU6IGxzLkZpbGVDaGFuZ2VUeXBlLkNoYW5nZWQgfV1cbiAgICAgIGNhc2UgXCJkZWxldGVkXCI6XG4gICAgICAgIHJldHVybiBbeyB1cmk6IENvbnZlcnQucGF0aFRvVXJpKGZpbGVFdmVudC5wYXRoKSwgdHlwZTogbHMuRmlsZUNoYW5nZVR5cGUuRGVsZXRlZCB9XVxuICAgICAgY2FzZSBcInJlbmFtZWRcIjoge1xuICAgICAgICBjb25zdCByZXN1bHRzOiBBcnJheTx7IHVyaTogc3RyaW5nOyB0eXBlOiBscy5GaWxlQ2hhbmdlVHlwZSB9PiA9IFtdXG4gICAgICAgIGlmIChmaWxlRXZlbnQub2xkUGF0aCkge1xuICAgICAgICAgIHJlc3VsdHMucHVzaCh7IHVyaTogQ29udmVydC5wYXRoVG9VcmkoZmlsZUV2ZW50Lm9sZFBhdGgpLCB0eXBlOiBscy5GaWxlQ2hhbmdlVHlwZS5EZWxldGVkIH0pXG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZpbGVFdmVudC5wYXRoKSB7XG4gICAgICAgICAgcmVzdWx0cy5wdXNoKHsgdXJpOiBDb252ZXJ0LnBhdGhUb1VyaShmaWxlRXZlbnQucGF0aCksIHR5cGU6IGxzLkZpbGVDaGFuZ2VUeXBlLkNyZWF0ZWQgfSlcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0c1xuICAgICAgfVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIFtdXG4gICAgfVxuICB9XG5cbiAgLyoqIEBkZXByZWNhdGVkIFVzZSBMaW50ZXIgVjIgc2VydmljZSAqL1xuICBwdWJsaWMgc3RhdGljIGF0b21JZGVEaWFnbm9zdGljVG9MU0RpYWdub3N0aWMoZGlhZ25vc3RpYzogYXRvbUlkZS5EaWFnbm9zdGljKTogbHMuRGlhZ25vc3RpYyB7XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGltcG9ydC9uby1kZXByZWNhdGVkXG4gICAgcmV0dXJuIGF0b21JZGVEaWFnbm9zdGljVG9MU0RpYWdub3N0aWMoZGlhZ25vc3RpYylcbiAgfVxuXG4gIC8qKiBAZGVwcmVjYXRlZCBVc2UgTGludGVyIFYyIHNlcnZpY2UgKi9cbiAgcHVibGljIHN0YXRpYyBkaWFnbm9zdGljVHlwZVRvTFNTZXZlcml0eSh0eXBlOiBhdG9tSWRlLkRpYWdub3N0aWNUeXBlKTogbHMuRGlhZ25vc3RpY1NldmVyaXR5IHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgaW1wb3J0L25vLWRlcHJlY2F0ZWRcbiAgICByZXR1cm4gZGlhZ25vc3RpY1R5cGVUb0xTU2V2ZXJpdHkodHlwZSlcbiAgfVxuXG4gIC8qKlxuICAgKiBQdWJsaWM6IENvbnZlcnQgYW4gYXJyYXkgb2YgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIHthdG9tSWRlLlRleHRFZGl0fSBvYmplY3RzIHRvIGFuIGVxdWl2YWxlbnQgYXJyYXkgb2YgQXRvbVxuICAgKiB7YXRvbUlkZS5UZXh0RWRpdH0gb2JqZWN0cy5cbiAgICpcbiAgICogQHBhcmFtIHRleHRFZGl0cyBUaGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIHthdG9tSWRlLlRleHRFZGl0fSBvYmplY3RzIHRvIGNvbnZlcnQuXG4gICAqIEByZXR1cm5zIEFuIHtBcnJheX0gb2YgQXRvbSB7YXRvbUlkZS5UZXh0RWRpdH0gb2JqZWN0cy5cbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgY29udmVydExzVGV4dEVkaXRzKHRleHRFZGl0cz86IGxzLlRleHRFZGl0W10gfCBudWxsKTogYXRvbUlkZS5UZXh0RWRpdFtdIHtcbiAgICByZXR1cm4gKHRleHRFZGl0cyB8fCBbXSkubWFwKENvbnZlcnQuY29udmVydExzVGV4dEVkaXQpXG4gIH1cblxuICAvKipcbiAgICogUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIHthdG9tSWRlLlRleHRFZGl0fSBvYmplY3QgdG8gdGhlIEF0b20gZXF1aXZhbGVudCB7YXRvbUlkZS5UZXh0RWRpdH0uXG4gICAqXG4gICAqIEBwYXJhbSB0ZXh0RWRpdHMgVGhlIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCB7YXRvbUlkZS5UZXh0RWRpdH0gb2JqZWN0cyB0byBjb252ZXJ0LlxuICAgKiBAcmV0dXJucyBBbiBBdG9tIHthdG9tSWRlLlRleHRFZGl0fSBvYmplY3QuXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGNvbnZlcnRMc1RleHRFZGl0KHRleHRFZGl0OiBscy5UZXh0RWRpdCk6IGF0b21JZGUuVGV4dEVkaXQge1xuICAgIC8vIFRPRE86IHN1cHBvcnQgYW5ub3RhdGlvbnNcbiAgICByZXR1cm4ge1xuICAgICAgb2xkUmFuZ2U6IENvbnZlcnQubHNSYW5nZVRvQXRvbVJhbmdlKHRleHRFZGl0LnJhbmdlKSxcbiAgICAgIG5ld1RleHQ6IHRleHRFZGl0Lm5ld1RleHQsXG4gICAgfVxuICB9XG59XG4iXX0=