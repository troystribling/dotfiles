"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const convert_1 = require("./convert");
const path = require("path");
const atom_1 = require("atom");
// Manages the language server lifecycles and their associated objects necessary
// for adapting them to Atom IDE.
class ServerManager {
    constructor(startServer, logger, startForEditor, changeWatchedFileFilter, busySignalServiceGetter, languageServerName) {
        this._activeServers = [];
        this._startingServerPromises = new Map();
        this._restartCounterPerProject = new Map();
        this._stoppingServers = [];
        this._disposable = new atom_1.CompositeDisposable();
        this._editorToServer = new Map();
        this._normalizedProjectPaths = [];
        this._isStarted = false;
        this._languageServerName = languageServerName;
        this._startServer = startServer;
        this._logger = logger;
        this._startForEditor = startForEditor;
        this.updateNormalizedProjectPaths();
        this._changeWatchedFileFilter = changeWatchedFileFilter;
        this._getBusySignalService = busySignalServiceGetter;
    }
    startListening() {
        if (!this._isStarted) {
            this._disposable = new atom_1.CompositeDisposable();
            this._disposable.add(atom.textEditors.observe(this.observeTextEditors.bind(this)));
            this._disposable.add(atom.project.onDidChangePaths(this.projectPathsChanged.bind(this)));
            if (atom.project.onDidChangeFiles) {
                this._disposable.add(atom.project.onDidChangeFiles(this.projectFilesChanged.bind(this)));
            }
        }
    }
    stopListening() {
        if (this._isStarted) {
            this._disposable.dispose();
            this._isStarted = false;
        }
    }
    observeTextEditors(editor) {
        // Track grammar changes for opened editors
        const listener = editor.observeGrammar((grammar) => this._handleGrammarChange(editor));
        this._disposable.add(editor.onDidDestroy(() => listener.dispose()));
        // Try to see if editor can have LS connected to it
        this._handleTextEditor(editor);
    }
    _handleTextEditor(editor) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this._editorToServer.has(editor)) {
                // editor hasn't been processed yet, so process it by allocating LS for it if necessary
                const server = yield this.getServer(editor, { shouldStart: true });
                if (server != null) {
                    // There LS for the editor (either started now and already running)
                    this._editorToServer.set(editor, server);
                    this._disposable.add(editor.onDidDestroy(() => {
                        this._editorToServer.delete(editor);
                        this.stopUnusedServers();
                    }));
                }
            }
        });
    }
    _handleGrammarChange(editor) {
        if (this._startForEditor(editor)) {
            // If editor is interesting for LS process the editor further to attempt to start LS if needed
            this._handleTextEditor(editor);
        }
        else {
            // Editor is not supported by the LS
            const server = this._editorToServer.get(editor);
            // If LS is running for the unsupported editor then disconnect the editor from LS and shut down LS if necessary
            if (server) {
                // LS is up for unsupported server
                if (server.docSyncAdapter) {
                    const syncAdapter = server.docSyncAdapter.getEditorSyncAdapter(editor);
                    if (syncAdapter) {
                        // Immitate editor close to disconnect LS from the editor
                        syncAdapter.didClose();
                    }
                }
                // Remove editor from the cache
                this._editorToServer.delete(editor);
                // Shut down LS if it's used by any other editor
                this.stopUnusedServers();
            }
        }
    }
    getActiveServers() {
        return this._activeServers.slice();
    }
    getServer(textEditor, { shouldStart } = { shouldStart: false }) {
        return __awaiter(this, void 0, void 0, function* () {
            const finalProjectPath = this.determineProjectPath(textEditor);
            if (finalProjectPath == null) {
                // Files not yet saved have no path
                return null;
            }
            const foundActiveServer = this._activeServers.find((s) => finalProjectPath === s.projectPath);
            if (foundActiveServer) {
                return foundActiveServer;
            }
            const startingPromise = this._startingServerPromises.get(finalProjectPath);
            if (startingPromise) {
                return startingPromise;
            }
            return shouldStart && this._startForEditor(textEditor) ? yield this.startServer(finalProjectPath) : null;
        });
    }
    startServer(projectPath) {
        return __awaiter(this, void 0, void 0, function* () {
            this._logger.debug(`Server starting "${projectPath}"`);
            const startingPromise = this._startServer(projectPath);
            this._startingServerPromises.set(projectPath, startingPromise);
            try {
                const startedActiveServer = yield startingPromise;
                this._activeServers.push(startedActiveServer);
                this._startingServerPromises.delete(projectPath);
                this._logger.debug(`Server started "${projectPath}" (pid ${startedActiveServer.process.pid})`);
                return startedActiveServer;
            }
            catch (e) {
                this._startingServerPromises.delete(projectPath);
                throw e;
            }
        });
    }
    stopUnusedServers() {
        return __awaiter(this, void 0, void 0, function* () {
            const usedServers = new Set(this._editorToServer.values());
            const unusedServers = this._activeServers.filter((s) => !usedServers.has(s));
            if (unusedServers.length > 0) {
                this._logger.debug(`Stopping ${unusedServers.length} unused servers`);
                yield Promise.all(unusedServers.map((s) => this.stopServer(s)));
            }
        });
    }
    stopAllServers() {
        return __awaiter(this, void 0, void 0, function* () {
            for (const [projectPath, restartCounter] of this._restartCounterPerProject) {
                clearTimeout(restartCounter.timerId);
                this._restartCounterPerProject.delete(projectPath);
            }
            yield Promise.all(this._activeServers.map((s) => this.stopServer(s)));
        });
    }
    restartAllServers() {
        return __awaiter(this, void 0, void 0, function* () {
            this.stopListening();
            yield this.stopAllServers();
            this._editorToServer = new Map();
            this.startListening();
        });
    }
    hasServerReachedRestartLimit(server) {
        let restartCounter = this._restartCounterPerProject.get(server.projectPath);
        if (!restartCounter) {
            restartCounter = {
                restarts: 0,
                timerId: setTimeout(() => {
                    this._restartCounterPerProject.delete(server.projectPath);
                }, 3 * 60 * 1000 /* 3 minutes */),
            };
            this._restartCounterPerProject.set(server.projectPath, restartCounter);
        }
        return ++restartCounter.restarts > 5;
    }
    stopServer(server) {
        return __awaiter(this, void 0, void 0, function* () {
            const busySignalService = this._getBusySignalService();
            const signal = busySignalService && busySignalService.reportBusy(`Stopping ${this._languageServerName} for ${path.basename(server.projectPath)}`);
            try {
                this._logger.debug(`Server stopping "${server.projectPath}"`);
                // Immediately remove the server to prevent further usage.
                // If we re-open the file after this point, we'll get a new server.
                this._activeServers.splice(this._activeServers.indexOf(server), 1);
                this._stoppingServers.push(server);
                server.disposable.dispose();
                if (server.connection.isConnected) {
                    yield server.connection.shutdown();
                }
                for (const [editor, mappedServer] of this._editorToServer) {
                    if (mappedServer === server) {
                        this._editorToServer.delete(editor);
                    }
                }
                this.exitServer(server);
                this._stoppingServers.splice(this._stoppingServers.indexOf(server), 1);
            }
            finally {
                signal && signal.dispose();
            }
        });
    }
    exitServer(server) {
        const pid = server.process.pid;
        try {
            if (server.connection.isConnected) {
                server.connection.exit();
                server.connection.dispose();
            }
        }
        finally {
            server.process.kill();
        }
        this._logger.debug(`Server stopped "${server.projectPath}" (pid ${pid})`);
    }
    terminate() {
        this._stoppingServers.forEach((server) => {
            this._logger.debug(`Server terminating "${server.projectPath}"`);
            this.exitServer(server);
        });
    }
    determineProjectPath(textEditor) {
        const filePath = textEditor.getPath();
        if (filePath == null) {
            return null;
        }
        return this._normalizedProjectPaths.find((d) => filePath.startsWith(d)) || null;
    }
    updateNormalizedProjectPaths() {
        this._normalizedProjectPaths = atom.project.getDirectories().map((d) => this.normalizePath(d.getPath()));
    }
    normalizePath(projectPath) {
        return !projectPath.endsWith(path.sep) ? path.join(projectPath, path.sep) : projectPath;
    }
    projectPathsChanged(projectPaths) {
        return __awaiter(this, void 0, void 0, function* () {
            const pathsSet = new Set(projectPaths.map(this.normalizePath));
            const serversToStop = this._activeServers.filter((s) => !pathsSet.has(s.projectPath));
            yield Promise.all(serversToStop.map((s) => this.stopServer(s)));
            this.updateNormalizedProjectPaths();
        });
    }
    projectFilesChanged(fileEvents) {
        if (this._activeServers.length === 0) {
            return;
        }
        for (const activeServer of this._activeServers) {
            const changes = [];
            for (const fileEvent of fileEvents) {
                if (fileEvent.path.startsWith(activeServer.projectPath) && this._changeWatchedFileFilter(fileEvent.path)) {
                    changes.push(convert_1.default.atomFileEventToLSFileEvents(fileEvent)[0]);
                }
                if (fileEvent.oldPath &&
                    fileEvent.oldPath.startsWith(activeServer.projectPath) &&
                    this._changeWatchedFileFilter(fileEvent.oldPath)) {
                    changes.push(convert_1.default.atomFileEventToLSFileEvents(fileEvent)[1]);
                }
            }
            if (changes.length > 0) {
                activeServer.connection.didChangeWatchedFiles({ changes });
            }
        }
    }
}
exports.ServerManager = ServerManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvc2VydmVyLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUlBLHVDQUFnQztBQUNoQyw2QkFBNkI7QUFNN0IsK0JBSWM7QUFtQ2QsZ0ZBQWdGO0FBQ2hGLGlDQUFpQztBQUNqQztJQWdCRSxZQUNFLFdBQTJELEVBQzNELE1BQWMsRUFDZCxjQUErQyxFQUMvQyx1QkFBc0QsRUFDdEQsdUJBQStELEVBQy9ELGtCQUEwQjtRQXJCcEIsbUJBQWMsR0FBbUIsRUFBRSxDQUFDO1FBQ3BDLDRCQUF1QixHQUF1QyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3hFLDhCQUF5QixHQUFnQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ25FLHFCQUFnQixHQUFtQixFQUFFLENBQUM7UUFDdEMsZ0JBQVcsR0FBd0IsSUFBSSwwQkFBbUIsRUFBRSxDQUFDO1FBQzdELG9CQUFlLEdBQWtDLElBQUksR0FBRyxFQUFFLENBQUM7UUFFM0QsNEJBQXVCLEdBQWEsRUFBRSxDQUFDO1FBTXZDLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFVekIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGtCQUFrQixDQUFDO1FBQzlDLElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxlQUFlLEdBQUcsY0FBYyxDQUFDO1FBQ3RDLElBQUksQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO1FBQ3BDLElBQUksQ0FBQyx3QkFBd0IsR0FBRyx1QkFBdUIsQ0FBQztRQUN4RCxJQUFJLENBQUMscUJBQXFCLEdBQUcsdUJBQXVCLENBQUM7SUFDdkQsQ0FBQztJQUVNLGNBQWM7UUFDbkIsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztZQUNyQixJQUFJLENBQUMs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SUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUMvQyxNQUFNLE9BQU8sR0FBbUIsRUFBRSxDQUFDO1lBQ25DLEdBQUcsQ0FBQyxDQUFDLE1BQU0sU0FBUyxJQUFJLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ25DLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxJQUFJLENBQUMsd0JBQXdCLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDekcsT0FBTyxDQUFDLElBQUksQ0FBQyxpQkFBTyxDQUFDLDJCQUEyQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xFLENBQUM7Z0JBQ0QsRUFBRSxDQUFDLENBQ0QsU0FBUyxDQUFDLE9BQU87b0JBQ2pCLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUM7b0JBQ3RELElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUNqRCxDQUFDLENBQUMsQ0FBQztvQkFDRCxPQUFPLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsMkJBQTJCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDbEUsQ0FBQztZQUNILENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3ZCLFlBQVksQ0FBQyxVQUFVLENBQUMscUJBQXFCLENBQUMsRUFBQyxPQUFPLEVBQUMsQ0FBQyxDQUFDO1lBQzNELENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBMVJELHNDQTBSQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEb2N1bWVudFN5bmNBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvZG9jdW1lbnQtc3luYy1hZGFwdGVyJztcclxuaW1wb3J0IExpbnRlclB1c2hWMkFkYXB0ZXIgZnJvbSAnLi9hZGFwdGVycy9saW50ZXItcHVzaC12Mi1hZGFwdGVyJztcclxuaW1wb3J0IExvZ2dpbmdDb25zb2xlQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL2xvZ2dpbmctY29uc29sZS1hZGFwdGVyJztcclxuaW1wb3J0IFNpZ25hdHVyZUhlbHBBZGFwdGVyIGZyb20gJy4vYWRhcHRlcnMvc2lnbmF0dXJlLWhlbHAtYWRhcHRlcic7XHJcbmltcG9ydCBDb252ZXJ0IGZyb20gJy4vY29udmVydCc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCAqIGFzIHN0cmVhbSBmcm9tICdzdHJlYW0nO1xyXG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0ICogYXMgYXRvbUlkZSBmcm9tICdhdG9tLWlkZSc7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XHJcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcclxuaW1wb3J0IHtcclxuICBDb21wb3NpdGVEaXNwb3NhYmxlLFxyXG4gIFByb2plY3RGaWxlRXZlbnQsXHJcbiAgVGV4dEVkaXRvcixcclxufSBmcm9tICdhdG9tJztcclxuXHJcbi8vIFB1YmxpYzogRGVmaW5lcyB0aGUgbWluaW11bSBzdXJmYWNlIGFyZWEgZm9yIGFuIG9iamVjdCB0aGF0IHJlc2VtYmxlcyBhXHJcbi8vIENoaWxkUHJvY2Vzcy4gIFRoaXMgaXMgdXNlZCBzbyB0aGF0IGxhbmd1YWdlIHBhY2thZ2VzIHdpdGggYWx0ZXJuYXRpdmVcclxuLy8gbGFuZ3VhZ2Ugc2VydmVyIHByb2Nlc3MgaG9zdGluZyBzdHJhdGVnaWVzIGNhbiByZXR1cm4gc29tZXRoaW5nIGNvbXBhdGlibGVcclxuLy8gd2l0aCBBdXRvTGFuZ3VhZ2VDbGllbnQuc3RhcnRTZXJ2ZXJQcm9jZXNzLlxyXG5leHBvcnQgaW50ZXJmYWNlIExhbmd1YWdlU2VydmVyUHJvY2VzcyBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgc3RkaW46IHN0cmVhbS5Xcml0YWJsZTtcclxuICBzdGRvdXQ6IHN0cmVhbS5SZWFkYWJsZTtcclxuICBzdGRlcnI6IHN0cmVhbS5SZWFkYWJsZTtcclxuICBwaWQ6IG51bWJlcjtcclxuXHJcbiAga2lsbChzaWduYWw/OiBzdHJpbmcpOiB2b2lkO1xyXG4gIG9uKGV2ZW50OiAnZXJyb3InLCBsaXN0ZW5lcjogKGVycjogRXJyb3IpID0+IHZvaWQpOiB0aGlzO1xyXG4gIG9uKGV2ZW50OiAnZXhpdCcsIGxpc3RlbmVyOiAoY29kZTogbnVtYmVyLCBzaWduYWw6IHN0cmluZykgPT4gdm9pZCk6IHRoaXM7XHJcbn1cclxuXHJcbi8vIFRoZSBuZWNlc3NhcnkgZWxlbWVudHMgZm9yIGEgc2VydmVyIHRoYXQgaGFzIHN0YXJ0ZWQgb3IgaXMgc3RhcnRpbmcuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQWN0aXZlU2VydmVyIHtcclxuICBkaXNwb3NhYmxlOiBDb21wb3NpdGVEaXNwb3NhYmxlO1xyXG4gIHByb2plY3RQYXRoOiBzdHJpbmc7XHJcbiAgcHJvY2VzczogTGFuZ3VhZ2VTZXJ2ZXJQcm9jZXNzO1xyXG4gIGNvbm5lY3Rpb246IGxzLkxhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbjtcclxuICBjYXBhYmlsaXRpZXM6IGxzLlNlcnZlckNhcGFiaWxpdGllcztcclxuICBsaW50ZXJQdXNoVjI/OiBMaW50ZXJQdXNoVjJBZGFwdGVyO1xyXG4gIGxvZ2dpbmdDb25zb2xlPzogTG9nZ2luZ0NvbnNvbGVBZGFwdGVyO1xyXG4gIGRvY1N5bmNBZGFwdGVyPzogRG9jdW1lbnRTeW5jQWRhcHRlcjtcclxuICBzaWduYXR1cmVIZWxwQWRhcHRlcj86IFNpZ25hdHVyZUhlbHBBZGFwdGVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUmVzdGFydENvdW50ZXIge1xyXG4gIHJlc3RhcnRzOiBudW1iZXI7XHJcbiAgdGltZXJJZDogTm9kZUpTLlRpbWVyO1xyXG59XHJcblxyXG4vLyBNYW5hZ2VzIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgbGlmZWN5Y2xlcyBhbmQgdGhlaXIgYXNzb2NpYXRlZCBvYmplY3RzIG5lY2Vzc2FyeVxyXG4vLyBmb3IgYWRhcHRpbmcgdGhlbSB0byBBdG9tIElERS5cclxuZXhwb3J0IGNsYXNzIFNlcnZlck1hbmFnZXIge1xyXG4gIHByaXZhdGUgX2FjdGl2ZVNlcnZlcnM6IEFjdGl2ZVNlcnZlcltdID0gW107XHJcbiAgcHJpdmF0ZSBfc3RhcnRpbmdTZXJ2ZXJQcm9taXNlczogTWFwPHN0cmluZywgUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+PiA9IG5ldyBNYXAoKTtcclxuICBwcml2YXRlIF9yZXN0YXJ0Q291bnRlclBlclByb2plY3Q6IE1hcDxzdHJpbmcsIFJlc3RhcnRDb3VudGVyPiA9IG5ldyBNYXAoKTtcclxuICBwcml2YXRlIF9zdG9wcGluZ1NlcnZlcnM6IEFjdGl2ZVNlcnZlcltdID0gW107XHJcbiAgcHJpdmF0ZSBfZGlzcG9zYWJsZTogQ29tcG9zaXRlRGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgcHJpdmF0ZSBfZWRpdG9yVG9TZXJ2ZXI6IE1hcDxUZXh0RWRpdG9yLCBBY3RpdmVTZXJ2ZXI+ID0gbmV3IE1hcCgpO1xyXG4gIHByaXZhdGUgX2xvZ2dlcjogTG9nZ2VyO1xyXG4gIHByaXZhdGUgX25vcm1hbGl6ZWRQcm9qZWN0UGF0aHM6IHN0cmluZ1tdID0gW107XHJcbiAgcHJpdmF0ZSBfc3RhcnRGb3JFZGl0b3I6IChlZGl0b3I6IFRleHRFZGl0b3IpID0+IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBfc3RhcnRTZXJ2ZXI6IChwcm9qZWN0UGF0aDogc3RyaW5nKSA9PiBQcm9taXNlPEFjdGl2ZVNlcnZlcj47XHJcbiAgcHJpdmF0ZSBfY2hhbmdlV2F0Y2hlZEZpbGVGaWx0ZXI6IChmaWxlUGF0aDogc3RyaW5nKSA9PiBib29sZWFuO1xyXG4gIHByaXZhdGUgX2dldEJ1c3lTaWduYWxTZXJ2aWNlOiAoKSA9PiBhdG9tSWRlLkJ1c3lTaWduYWxTZXJ2aWNlIHwgbnVsbDtcclxuICBwcml2YXRlIF9sYW5ndWFnZVNlcnZlck5hbWU6IHN0cmluZztcclxuICBwcml2YXRlIF9pc1N0YXJ0ZWQgPSBmYWxzZTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBzdGFydFNlcnZlcjogKHByb2plY3RQYXRoOiBzdHJpbmcpID0+IFByb21pc2U8QWN0aXZlU2VydmVyPixcclxuICAgIGxvZ2dlcjogTG9nZ2VyLFxyXG4gICAgc3RhcnRGb3JFZGl0b3I6IChlZGl0b3I6IFRleHRFZGl0b3IpID0+IGJvb2xlYW4sXHJcbiAgICBjaGFuZ2VXYXRjaGVkRmlsZUZpbHRlcjogKGZpbGVQYXRoOiBzdHJpbmcpID0+IGJvb2xlYW4sXHJcbiAgICBidXN5U2lnbmFsU2VydmljZUdldHRlcjogKCkgPT4gYXRvbUlkZS5CdXN5U2lnbmFsU2VydmljZSB8IG51bGwsXHJcbiAgICBsYW5ndWFnZVNlcnZlck5hbWU6IHN0cmluZyxcclxuICApIHtcclxuICAgIHRoaXMuX2xhbmd1YWdlU2VydmVyTmFtZSA9IGxhbmd1YWdlU2VydmVyTmFtZTtcclxuICAgIHRoaXMuX3N0YXJ0U2VydmVyID0gc3RhcnRTZXJ2ZXI7XHJcbiAgICB0aGlzLl9sb2dnZXIgPSBsb2dnZXI7XHJcbiAgICB0aGlzLl9zdGFydEZvckVkaXRvciA9IHN0YXJ0Rm9yRWRpdG9yO1xyXG4gICAgdGhpcy51cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk7XHJcbiAgICB0aGlzLl9jaGFuZ2VXYXRjaGVkRmlsZUZpbHRlciA9IGNoYW5nZVdhdGNoZWRGaWxlRmlsdGVyO1xyXG4gICAgdGhpcy5fZ2V0QnVzeVNpZ25hbFNlcnZpY2UgPSBidXN5U2lnbmFsU2VydmljZUdldHRlcjtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGFydExpc3RlbmluZygpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5faXNTdGFydGVkKSB7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnRleHRFZGl0b3JzLm9ic2VydmUodGhpcy5vYnNlcnZlVGV4dEVkaXRvcnMuYmluZCh0aGlzKSkpO1xyXG4gICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VQYXRocyh0aGlzLnByb2plY3RQYXRoc0NoYW5nZWQuYmluZCh0aGlzKSkpO1xyXG4gICAgICBpZiAoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlRmlsZXMpIHtcclxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VGaWxlcyh0aGlzLnByb2plY3RGaWxlc0NoYW5nZWQuYmluZCh0aGlzKSkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RvcExpc3RlbmluZygpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9pc1N0YXJ0ZWQpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICAgIHRoaXMuX2lzU3RhcnRlZCA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvYnNlcnZlVGV4dEVkaXRvcnMoZWRpdG9yOiBUZXh0RWRpdG9yKTogdm9pZCB7XHJcbiAgICAvLyBUcmFjayBncmFtbWFyIGNoYW5nZXMgZm9yIG9wZW5lZCBlZGl0b3JzXHJcbiAgICBjb25zdCBsaXN0ZW5lciA9IGVkaXRvci5vYnNlcnZlR3JhbW1hcigoZ3JhbW1hcikgPT4gdGhpcy5faGFuZGxlR3JhbW1hckNoYW5nZShlZGl0b3IpKTtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4gbGlzdGVuZXIuZGlzcG9zZSgpKSk7XHJcbiAgICAvLyBUcnkgdG8gc2VlIGlmIGVkaXRvciBjYW4gaGF2ZSBMUyBjb25uZWN0ZWQgdG8gaXRcclxuICAgIHRoaXMuX2hhbmRsZVRleHRFZGl0b3IoZWRpdG9yKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgX2hhbmRsZVRleHRFZGl0b3IoZWRpdG9yOiBUZXh0RWRpdG9yKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBpZiAoIXRoaXMuX2VkaXRvclRvU2VydmVyLmhhcyhlZGl0b3IpKSB7XHJcbiAgICAgIC8vIGVkaXRvciBoYXNuJ3QgYmVlbiBwcm9jZXNzZWQgeWV0LCBzbyBwcm9jZXNzIGl0IGJ5IGFsbG9jYXRpbmcgTFMgZm9yIGl0IGlmIG5lY2Vzc2FyeVxyXG4gICAgICBjb25zdCBzZXJ2ZXIgPSBhd2FpdCB0aGlzLmdldFNlcnZlcihlZGl0b3IsIHtzaG91bGRTdGFydDogdHJ1ZX0pO1xyXG4gICAgICBpZiAoc2VydmVyICE9IG51bGwpIHtcclxuICAgICAgICAvLyBUaGVyZSBMUyBmb3IgdGhlIGVkaXRvciAoZWl0aGVyIHN0YXJ0ZWQgbm93IGFuZCBhbHJlYWR5IHJ1bm5pbmcpXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuc2V0KGVkaXRvciwgc2VydmVyKTtcclxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChcclxuICAgICAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLl9lZGl0b3JUb1NlcnZlci5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICAgICAgdGhpcy5zdG9wVW51c2VkU2VydmVycygpO1xyXG4gICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfaGFuZGxlR3JhbW1hckNoYW5nZShlZGl0b3I6IFRleHRFZGl0b3IpIHtcclxuICAgIGlmICh0aGlzLl9zdGFydEZvckVkaXRvcihlZGl0b3IpKSB7XHJcbiAgICAgIC8vIElmIGVkaXRvciBpcyBpbnRlcmVzdGluZyBmb3IgTFMgcHJvY2VzcyB0aGUgZWRpdG9yIGZ1cnRoZXIgdG8gYXR0ZW1wdCB0byBzdGFydCBMUyBpZiBuZWVkZWRcclxuICAgICAgdGhpcy5faGFuZGxlVGV4dEVkaXRvcihlZGl0b3IpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gRWRpdG9yIGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIExTXHJcbiAgICAgIGNvbnN0IHNlcnZlciA9IHRoaXMuX2VkaXRvclRvU2VydmVyLmdldChlZGl0b3IpO1xyXG4gICAgICAvLyBJZiBMUyBpcyBydW5uaW5nIGZvciB0aGUgdW5zdXBwb3J0ZWQgZWRpdG9yIHRoZW4gZGlzY29ubmVjdCB0aGUgZWRpdG9yIGZyb20gTFMgYW5kIHNodXQgZG93biBMUyBpZiBuZWNlc3NhcnlcclxuICAgICAgaWYgKHNlcnZlcikge1xyXG4gICAgICAgIC8vIExTIGlzIHVwIGZvciB1bnN1cHBvcnRlZCBzZXJ2ZXJcclxuICAgICAgICBpZiAoc2VydmVyLmRvY1N5bmNBZGFwdGVyKSB7XHJcbiAgICAgICAgICBjb25zdCBzeW5jQWRhcHRlciA9IHNlcnZlci5kb2NTeW5jQWRhcHRlci5nZXRFZGl0b3JTeW5jQWRhcHRlcihlZGl0b3IpO1xyXG4gICAgICAgICAgaWYgKHN5bmNBZGFwdGVyKSB7XHJcbiAgICAgICAgICAgIC8vIEltbWl0YXRlIGVkaXRvciBjbG9zZSB0byBkaXNjb25uZWN0IExTIGZyb20gdGhlIGVkaXRvclxyXG4gICAgICAgICAgICBzeW5jQWRhcHRlci5kaWRDbG9zZSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBSZW1vdmUgZWRpdG9yIGZyb20gdGhlIGNhY2hlXHJcbiAgICAgICAgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuZGVsZXRlKGVkaXRvcik7XHJcbiAgICAgICAgLy8gU2h1dCBkb3duIExTIGlmIGl0J3MgdXNlZCBieSBhbnkgb3RoZXIgZWRpdG9yXHJcbiAgICAgICAgdGhpcy5zdG9wVW51c2VkU2VydmVycygpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0QWN0aXZlU2VydmVycygpOiBBY3RpdmVTZXJ2ZXJbXSB7XHJcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlU2VydmVycy5zbGljZSgpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIGdldFNlcnZlcihcclxuICAgIHRleHRFZGl0b3I6IFRleHRFZGl0b3IsXHJcbiAgICB7c2hvdWxkU3RhcnR9OiB7c2hvdWxkU3RhcnQ/OiBib29sZWFufSA9IHtzaG91bGRTdGFydDogZmFsc2V9LFxyXG4gICk6IFByb21pc2U8QWN0aXZlU2VydmVyIHwgbnVsbD4ge1xyXG4gICAgY29uc3QgZmluYWxQcm9qZWN0UGF0aCA9IHRoaXMuZGV0ZXJtaW5lUHJvamVjdFBhdGgodGV4dEVkaXRvcik7XHJcbiAgICBpZiAoZmluYWxQcm9qZWN0UGF0aCA9PSBudWxsKSB7XHJcbiAgICAgIC8vIEZpbGVzIG5vdCB5ZXQgc2F2ZWQgaGF2ZSBubyBwYXRoXHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGZvdW5kQWN0aXZlU2VydmVyID0gdGhpcy5fYWN0aXZlU2VydmVycy5maW5kKChzKSA9PiBmaW5hbFByb2plY3RQYXRoID09PSBzLnByb2plY3RQYXRoKTtcclxuICAgIGlmIChmb3VuZEFjdGl2ZVNlcnZlcikge1xyXG4gICAgICByZXR1cm4gZm91bmRBY3RpdmVTZXJ2ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgc3RhcnRpbmdQcm9taXNlID0gdGhpcy5fc3RhcnRpbmdTZXJ2ZXJQcm9taXNlcy5nZXQoZmluYWxQcm9qZWN0UGF0aCk7XHJcbiAgICBpZiAoc3RhcnRpbmdQcm9taXNlKSB7XHJcbiAgICAgIHJldHVybiBzdGFydGluZ1Byb21pc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHNob3VsZFN0YXJ0ICYmIHRoaXMuX3N0YXJ0Rm9yRWRpdG9yKHRleHRFZGl0b3IpID8gYXdhaXQgdGhpcy5zdGFydFNlcnZlcihmaW5hbFByb2plY3RQYXRoKSA6IG51bGw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgc3RhcnRTZXJ2ZXIocHJvamVjdFBhdGg6IHN0cmluZyk6IFByb21pc2U8QWN0aXZlU2VydmVyPiB7XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdGFydGluZyBcIiR7cHJvamVjdFBhdGh9XCJgKTtcclxuICAgIGNvbnN0IHN0YXJ0aW5nUHJvbWlzZSA9IHRoaXMuX3N0YXJ0U2VydmVyKHByb2plY3RQYXRoKTtcclxuICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuc2V0KHByb2plY3RQYXRoLCBzdGFydGluZ1Byb21pc2UpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3Qgc3RhcnRlZEFjdGl2ZVNlcnZlciA9IGF3YWl0IHN0YXJ0aW5nUHJvbWlzZTtcclxuICAgICAgdGhpcy5fYWN0aXZlU2VydmVycy5wdXNoKHN0YXJ0ZWRBY3RpdmVTZXJ2ZXIpO1xyXG4gICAgICB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLmRlbGV0ZShwcm9qZWN0UGF0aCk7XHJcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgU2VydmVyIHN0YXJ0ZWQgXCIke3Byb2plY3RQYXRofVwiIChwaWQgJHtzdGFydGVkQWN0aXZlU2VydmVyLnByb2Nlc3MucGlkfSlgKTtcclxuICAgICAgcmV0dXJuIHN0YXJ0ZWRBY3RpdmVTZXJ2ZXI7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuZGVsZXRlKHByb2plY3RQYXRoKTtcclxuICAgICAgdGhyb3cgZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzdG9wVW51c2VkU2VydmVycygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHVzZWRTZXJ2ZXJzID0gbmV3IFNldCh0aGlzLl9lZGl0b3JUb1NlcnZlci52YWx1ZXMoKSk7XHJcbiAgICBjb25zdCB1bnVzZWRTZXJ2ZXJzID0gdGhpcy5fYWN0aXZlU2VydmVycy5maWx0ZXIoKHMpID0+ICF1c2VkU2VydmVycy5oYXMocykpO1xyXG4gICAgaWYgKHVudXNlZFNlcnZlcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0b3BwaW5nICR7dW51c2VkU2VydmVycy5sZW5ndGh9IHVudXNlZCBzZXJ2ZXJzYCk7XHJcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKHVudXNlZFNlcnZlcnMubWFwKChzKSA9PiB0aGlzLnN0b3BTZXJ2ZXIocykpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzdG9wQWxsU2VydmVycygpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGZvciAoY29uc3QgW3Byb2plY3RQYXRoLCByZXN0YXJ0Q291bnRlcl0gb2YgdGhpcy5fcmVzdGFydENvdW50ZXJQZXJQcm9qZWN0KSB7XHJcbiAgICAgIGNsZWFyVGltZW91dChyZXN0YXJ0Q291bnRlci50aW1lcklkKTtcclxuICAgICAgdGhpcy5fcmVzdGFydENvdW50ZXJQZXJQcm9qZWN0LmRlbGV0ZShwcm9qZWN0UGF0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5fYWN0aXZlU2VydmVycy5tYXAoKHMpID0+IHRoaXMuc3RvcFNlcnZlcihzKSkpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHJlc3RhcnRBbGxTZXJ2ZXJzKCk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7XHJcbiAgICBhd2FpdCB0aGlzLnN0b3BBbGxTZXJ2ZXJzKCk7XHJcbiAgICB0aGlzLl9lZGl0b3JUb1NlcnZlciA9IG5ldyBNYXAoKTtcclxuICAgIHRoaXMuc3RhcnRMaXN0ZW5pbmcoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBoYXNTZXJ2ZXJSZWFjaGVkUmVzdGFydExpbWl0KHNlcnZlcjogQWN0aXZlU2VydmVyKSB7XHJcbiAgICBsZXQgcmVzdGFydENvdW50ZXIgPSB0aGlzLl9yZXN0YXJ0Q291bnRlclBlclByb2plY3QuZ2V0KHNlcnZlci5wcm9qZWN0UGF0aCk7XHJcblxyXG4gICAgaWYgKCFyZXN0YXJ0Q291bnRlcikge1xyXG4gICAgICByZXN0YXJ0Q291bnRlciA9IHtcclxuICAgICAgICByZXN0YXJ0czogMCxcclxuICAgICAgICB0aW1lcklkOiBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuX3Jlc3RhcnRDb3VudGVyUGVyUHJvamVjdC5kZWxldGUoc2VydmVyLnByb2plY3RQYXRoKTtcclxuICAgICAgICB9LCAzICogNjAgKiAxMDAwIC8qIDMgbWludXRlcyAqLyksXHJcbiAgICAgIH07XHJcblxyXG4gICAgICB0aGlzLl9yZXN0YXJ0Q291bnRlclBlclByb2plY3Quc2V0KHNlcnZlci5wcm9qZWN0UGF0aCwgcmVzdGFydENvdW50ZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiArK3Jlc3RhcnRDb3VudGVyLnJlc3RhcnRzID4gNTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBzdG9wU2VydmVyKHNlcnZlcjogQWN0aXZlU2VydmVyKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBidXN5U2lnbmFsU2VydmljZSA9IHRoaXMuX2dldEJ1c3lTaWduYWxTZXJ2aWNlKCk7XHJcbiAgICBjb25zdCBzaWduYWwgPSBidXN5U2lnbmFsU2VydmljZSAmJiBidXN5U2lnbmFsU2VydmljZS5yZXBvcnRCdXN5KFxyXG4gICAgICBgU3RvcHBpbmcgJHt0aGlzLl9sYW5ndWFnZVNlcnZlck5hbWV9IGZvciAke3BhdGguYmFzZW5hbWUoc2VydmVyLnByb2plY3RQYXRoKX1gLFxyXG4gICAgKTtcclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgU2VydmVyIHN0b3BwaW5nIFwiJHtzZXJ2ZXIucHJvamVjdFBhdGh9XCJgKTtcclxuICAgICAgLy8gSW1tZWRpYXRlbHkgcmVtb3ZlIHRoZSBzZXJ2ZXIgdG8gcHJldmVudCBmdXJ0aGVyIHVzYWdlLlxyXG4gICAgICAvLyBJZiB3ZSByZS1vcGVuIHRoZSBmaWxlIGFmdGVyIHRoaXMgcG9pbnQsIHdlJ2xsIGdldCBhIG5ldyBzZXJ2ZXIuXHJcbiAgICAgIHRoaXMuX2FjdGl2ZVNlcnZlcnMuc3BsaWNlKHRoaXMuX2FjdGl2ZVNlcnZlcnMuaW5kZXhPZihzZXJ2ZXIpLCAxKTtcclxuICAgICAgdGhpcy5fc3RvcHBpbmdTZXJ2ZXJzLnB1c2goc2VydmVyKTtcclxuICAgICAgc2VydmVyLmRpc3Bvc2FibGUuZGlzcG9zZSgpO1xyXG4gICAgICBpZiAoc2VydmVyLmNvbm5lY3Rpb24uaXNDb25uZWN0ZWQpIHtcclxuICAgICAgICBhd2FpdCBzZXJ2ZXIuY29ubmVjdGlvbi5zaHV0ZG93bigpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBmb3IgKGNvbnN0IFtlZGl0b3IsIG1hcHBlZFNlcnZlcl0gb2YgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIpIHtcclxuICAgICAgICBpZiAobWFwcGVkU2VydmVyID09PSBzZXJ2ZXIpIHtcclxuICAgICAgICAgIHRoaXMuX2VkaXRvclRvU2VydmVyLmRlbGV0ZShlZGl0b3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5leGl0U2VydmVyKHNlcnZlcik7XHJcbiAgICAgIHRoaXMuX3N0b3BwaW5nU2VydmVycy5zcGxpY2UodGhpcy5fc3RvcHBpbmdTZXJ2ZXJzLmluZGV4T2Yoc2VydmVyKSwgMSk7XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBzaWduYWwgJiYgc2lnbmFsLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBleGl0U2VydmVyKHNlcnZlcjogQWN0aXZlU2VydmVyKTogdm9pZCB7XHJcbiAgICBjb25zdCBwaWQgPSBzZXJ2ZXIucHJvY2Vzcy5waWQ7XHJcbiAgICB0cnkge1xyXG4gICAgICBpZiAoc2VydmVyLmNvbm5lY3Rpb24uaXNDb25uZWN0ZWQpIHtcclxuICAgICAgICBzZXJ2ZXIuY29ubmVjdGlvbi5leGl0KCk7XHJcbiAgICAgICAgc2VydmVyLmNvbm5lY3Rpb24uZGlzcG9zZSgpO1xyXG4gICAgICB9XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBzZXJ2ZXIucHJvY2Vzcy5raWxsKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdG9wcGVkIFwiJHtzZXJ2ZXIucHJvamVjdFBhdGh9XCIgKHBpZCAke3BpZH0pYCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgdGVybWluYXRlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fc3RvcHBpbmdTZXJ2ZXJzLmZvckVhY2goKHNlcnZlcikgPT4ge1xyXG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciB0ZXJtaW5hdGluZyBcIiR7c2VydmVyLnByb2plY3RQYXRofVwiYCk7XHJcbiAgICAgIHRoaXMuZXhpdFNlcnZlcihzZXJ2ZXIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGV0ZXJtaW5lUHJvamVjdFBhdGgodGV4dEVkaXRvcjogVGV4dEVkaXRvcik6IHN0cmluZyB8IG51bGwge1xyXG4gICAgY29uc3QgZmlsZVBhdGggPSB0ZXh0RWRpdG9yLmdldFBhdGgoKTtcclxuICAgIGlmIChmaWxlUGF0aCA9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuX25vcm1hbGl6ZWRQcm9qZWN0UGF0aHMuZmluZCgoZCkgPT4gZmlsZVBhdGguc3RhcnRzV2l0aChkKSkgfHwgbnVsbDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyB1cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5fbm9ybWFsaXplZFByb2plY3RQYXRocyA9IGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLm1hcCgoZCkgPT4gdGhpcy5ub3JtYWxpemVQYXRoKGQuZ2V0UGF0aCgpKSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbm9ybWFsaXplUGF0aChwcm9qZWN0UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgIHJldHVybiAhcHJvamVjdFBhdGguZW5kc1dpdGgocGF0aC5zZXApID8gcGF0aC5qb2luKHByb2plY3RQYXRoLCBwYXRoLnNlcCkgOiBwcm9qZWN0UGF0aDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBwcm9qZWN0UGF0aHNDaGFuZ2VkKHByb2plY3RQYXRoczogc3RyaW5nW10pOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IHBhdGhzU2V0ID0gbmV3IFNldChwcm9qZWN0UGF0aHMubWFwKHRoaXMubm9ybWFsaXplUGF0aCkpO1xyXG4gICAgY29uc3Qgc2VydmVyc1RvU3RvcCA9IHRoaXMuX2FjdGl2ZVNlcnZlcnMuZmlsdGVyKChzKSA9PiAhcGF0aHNTZXQuaGFzKHMucHJvamVjdFBhdGgpKTtcclxuICAgIGF3YWl0IFByb21pc2UuYWxsKHNlcnZlcnNUb1N0b3AubWFwKChzKSA9PiB0aGlzLnN0b3BTZXJ2ZXIocykpKTtcclxuICAgIHRoaXMudXBkYXRlTm9ybWFsaXplZFByb2plY3RQYXRocygpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHByb2plY3RGaWxlc0NoYW5nZWQoZmlsZUV2ZW50czogUHJvamVjdEZpbGVFdmVudFtdKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5fYWN0aXZlU2VydmVycy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAoY29uc3QgYWN0aXZlU2VydmVyIG9mIHRoaXMuX2FjdGl2ZVNlcnZlcnMpIHtcclxuICAgICAgY29uc3QgY2hhbmdlczogbHMuRmlsZUV2ZW50W10gPSBbXTtcclxuICAgICAgZm9yIChjb25zdCBmaWxlRXZlbnQgb2YgZmlsZUV2ZW50cykge1xyXG4gICAgICAgIGlmIChmaWxlRXZlbnQucGF0aC5zdGFydHNXaXRoKGFjdGl2ZVNlcnZlci5wcm9qZWN0UGF0aCkgJiYgdGhpcy5fY2hhbmdlV2F0Y2hlZEZpbGVGaWx0ZXIoZmlsZUV2ZW50LnBhdGgpKSB7XHJcbiAgICAgICAgICBjaGFuZ2VzLnB1c2goQ29udmVydC5hdG9tRmlsZUV2ZW50VG9MU0ZpbGVFdmVudHMoZmlsZUV2ZW50KVswXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIGZpbGVFdmVudC5vbGRQYXRoICYmXHJcbiAgICAgICAgICBmaWxlRXZlbnQub2xkUGF0aC5zdGFydHNXaXRoKGFjdGl2ZVNlcnZlci5wcm9qZWN0UGF0aCkgJiZcclxuICAgICAgICAgIHRoaXMuX2NoYW5nZVdhdGNoZWRGaWxlRmlsdGVyKGZpbGVFdmVudC5vbGRQYXRoKVxyXG4gICAgICAgICkge1xyXG4gICAgICAgICAgY2hhbmdlcy5wdXNoKENvbnZlcnQuYXRvbUZpbGVFdmVudFRvTFNGaWxlRXZlbnRzKGZpbGVFdmVudClbMV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICBpZiAoY2hhbmdlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgYWN0aXZlU2VydmVyLmNvbm5lY3Rpb24uZGlkQ2hhbmdlV2F0Y2hlZEZpbGVzKHtjaGFuZ2VzfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19