Object.defineProperty(exports, "__esModule", {
  value: true
});

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Public: Adapts the language server protocol "textDocument/completion" to the Atom
// AutoComplete+ package.
class AutocompleteAdapter {
  static canAdapt(serverCapabilities) {
    return serverCapabilities.completionProvider != null;
  }

  // Public: Primary entry point for obtaining suggestions for AutoComplete+ by
  // querying the language server.
  //
  // * `connection` A {LanguageClientConnection} to the language server to query.
  // * `request` An {Object} with the AutoComplete+ request to satisfy.
  //
  // Returns a {Promise} of an {Array} of {Object}s containing the AutoComplete+
  // suggestions to display.
  async getSuggestions(connection, request) {
    const completionItems = await connection.completion(AutocompleteAdapter.requestToTextDocumentPositionParams(request));
    return AutocompleteAdapter.completionItemsToSuggestions(completionItems, request);
  }

  // Public: Create TextDocumentPositionParams to be sent to the language server
  // based on the editor and position from the AutoCompleteRequest.
  //
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Object} containing the TextDocumentPositionParams object with the keys:
  //  * `textDocument` the language server protocol textDocument identification.
  //  * `position` the position within the text document to display completion request for.
  static requestToTextDocumentPositionParams(request) {
    return {
      textDocument: _convert2.default.editorToTextDocumentIdentifier(request.editor),
      position: _convert2.default.pointToPosition(request.bufferPosition)
    };
  }

  // Public: Convert a language server protocol CompletionItem array or CompletionList to
  // an array of AutoComplete+ suggestions.
  //
  // * `completionItems` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //           items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Array} of AutoComplete+ suggestions.
  static completionItemsToSuggestions(completionItems, request) {
    return (Array.isArray(completionItems) ? completionItems : completionItems.items || []).map(s => AutocompleteAdapter.completionItemToSuggestion(s, request));
  }

  // Public: Convert a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an AutoComplete+ suggestion.
  static completionItemToSuggestion(item, request) {
    const suggestion = AutocompleteAdapter.basicCompletionItemToSuggestion(item);
    AutocompleteAdapter.applyTextEditToSuggestion(item.textEdit, request.editor, suggestion);
    // TODO: Snippets
    return suggestion;
  }

  // Public: Convert the primary parts of a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  //
  // Returns an AutoComplete+ suggestion.
  static basicCompletionItemToSuggestion(item) {
    return {
      text: item.insertText || item.label,
      displayText: item.label,
      filterText: item.filterText || item.label,
      type: AutocompleteAdapter.completionKindToSuggestionType(item.kind),
      leftLabel: item.detail,
      description: item.documentation,
      descriptionMarkdown: item.documentation
    };
  }

  // Public: Applies the textEdit part of a language server protocol CompletionItem to an
  // AutoComplete+ Suggestion via the replacementPrefix and text properties.
  //
  // * `textEdit` A {TextEdit} from a CompletionItem to apply.
  // * `editor` An Atom {TextEditor} used to obtain the necessary text replacement.
  // * `suggestion` An AutoComplete+ suggestion to set the replacementPrefix and text properties of.
  static applyTextEditToSuggestion(textEdit, editor, suggestion) {
    if (textEdit != null) {
      suggestion.replacementPrefix = editor.getTextInBufferRange(_convert2.default.lsRangeToAtomRange(textEdit.range));
      suggestion.text = textEdit.newText;
    }
  }

  // Public: Obtain the textual suggestion type required by AutoComplete+ that
  // most closely maps to the numeric completion kind supplies by the language server.
  //
  // * `kind` A {Number} that represents the suggestion kind to be converted.
  //
  // Returns a {String} containing the AutoComplete+ suggestion type equivalent
  // to the given completion kind.
  static completionKindToSuggestionType(kind) {
    switch (kind) {
      case _languageclient.CompletionItemKind.Method:
        return 'method';
      case _languageclient.CompletionItemKind.Function:
      case _languageclient.CompletionItemKind.Constructor:
        return 'function';
      case _languageclient.CompletionItemKind.Field:
      case _languageclient.CompletionItemKind.Property:
        return 'property';
      case _languageclient.CompletionItemKind.Variable:
        return 'variable';
      case _languageclient.CompletionItemKind.Class:
        return 'class';
      case _languageclient.CompletionItemKind.Interface:
        return 'interface';
      case _languageclient.CompletionItemKind.Module:
        return 'module';
      case _languageclient.CompletionItemKind.Unit:
        return 'builtin';
      case _languageclient.CompletionItemKind.Enum:
        return 'enum';
      case _languageclient.CompletionItemKind.Keyword:
        return 'keyword';
      case _languageclient.CompletionItemKind.Snippet:
        return 'snippet';
      case _languageclient.CompletionItemKind.File:
        return 'import';
      case _languageclient.CompletionItemKind.Reference:
        return 'require';
      default:
        return 'value';
    }
  }
}
exports.default = AutocompleteAdapter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlci5qcyJdLCJuYW1lcyI6WyJBdXRvY29tcGxldGVBZGFwdGVyIiwiY2FuQWRhcHQiLCJzZXJ2ZXJDYXBhYmlsaXRpZXMiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJnZXRTdWdnZXN0aW9ucyIsImNvbm5lY3Rpb24iLCJyZXF1ZXN0IiwiY29tcGxldGlvbkl0ZW1zIiwiY29tcGxldGlvbiIsInJlcXVlc3RUb1RleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zIiwiY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyIsInRleHREb2N1bWVudCIsImVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllciIsImVkaXRvciIsInBvc2l0aW9uIiwicG9pbnRUb1Bvc2l0aW9uIiwiYnVmZmVyUG9zaXRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJpdGVtcyIsIm1hcCIsInMiLCJjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsIml0ZW0iLCJzdWdnZXN0aW9uIiwiYmFzaWNDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsImFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24iLCJ0ZXh0RWRpdCIsInRleHQiLCJpbnNlcnRUZXh0IiwibGFiZWwiLCJkaXNwbGF5VGV4dCIsImZpbHRlclRleHQiLCJ0eXBlIiwiY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlIiwia2luZCIsImxlZnRMYWJlbCIsImRldGFpbCIsImRlc2NyaXB0aW9uIiwiZG9jdW1lbnRhdGlvbiIsImRlc2NyaXB0aW9uTWFya2Rvd24iLCJyZXBsYWNlbWVudFByZWZpeCIsImdldFRleHRJbkJ1ZmZlclJhbmdlIiwibHNSYW5nZVRvQXRvbVJhbmdlIiwicmFuZ2UiLCJuZXdUZXh0IiwiTWV0aG9kIiwiRnVuY3Rpb24iLCJDb25zdHJ1Y3RvciIsIkZpZWxkIiwiUHJvcGVydHkiLCJWYXJpYWJsZSIsIkNsYXNzIiwiSW50ZXJmYWNlIiwi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O0FBQ0UsV0FBSyxtQ0FBbUJXLE1BQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFdBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0EsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFFBQXhCO0FBQ0UsZUFBTyxVQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLEtBQXhCO0FBQ0UsZUFBTyxPQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFNBQXhCO0FBQ0UsZUFBTyxXQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE1BQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxNQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLE9BQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLElBQXhCO0FBQ0UsZUFBTyxRQUFQO0FBQ0YsV0FBSyxtQ0FBbUJDLFNBQXhCO0FBQ0UsZUFBTyxTQUFQO0FBQ0Y7QUFDRSxlQUFPLE9BQVA7QUE5Qko7QUFnQ0Q7QUFuSnNDO2tCQUFwQjVELG1CIiwiZmlsZSI6ImF1dG9jb21wbGV0ZS1hZGFwdGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB7XHJcbiAgQ29tcGxldGlvbkl0ZW1LaW5kLFxyXG4gIExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbixcclxuICB0eXBlIENvbXBsZXRpb25JdGVtLFxyXG4gIHR5cGUgQ29tcGxldGlvbkxpc3QsXHJcbiAgdHlwZSBUZXh0RG9jdW1lbnRQb3NpdGlvblBhcmFtcyxcclxuICB0eXBlIFRleHRFZGl0LFxyXG4gIHR5cGUgU2VydmVyQ2FwYWJpbGl0aWVzLFxyXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcclxuaW1wb3J0IENvbnZlcnQgZnJvbSAnLi4vY29udmVydCc7XHJcblxyXG4vLyBQdWJsaWM6IEFkYXB0cyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIFwidGV4dERvY3VtZW50L2NvbXBsZXRpb25cIiB0byB0aGUgQXRvbVxyXG4vLyBBdXRvQ29tcGxldGUrIHBhY2thZ2UuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9jb21wbGV0ZUFkYXB0ZXIge1xyXG4gIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHNlcnZlckNhcGFiaWxpdGllcy5jb21wbGV0aW9uUHJvdmlkZXIgIT0gbnVsbDtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogUHJpbWFyeSBlbnRyeSBwb2ludCBmb3Igb2J0YWluaW5nIHN1Z2dlc3Rpb25zIGZvciBBdXRvQ29tcGxldGUrIGJ5XHJcbiAgLy8gcXVlcnlpbmcgdGhlIGxhbmd1YWdlIHNlcnZlci5cclxuICAvL1xyXG4gIC8vICogYGNvbm5lY3Rpb25gIEEge0xhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbn0gdG8gdGhlIGxhbmd1YWdlIHNlcnZlciB0byBxdWVyeS5cclxuICAvLyAqIGByZXF1ZXN0YCBBbiB7T2JqZWN0fSB3aXRoIHRoZSBBdXRvQ29tcGxldGUrIHJlcXVlc3QgdG8gc2F0aXNmeS5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYSB7UHJvbWlzZX0gb2YgYW4ge0FycmF5fSBvZiB7T2JqZWN0fXMgY29udGFpbmluZyB0aGUgQXV0b0NvbXBsZXRlK1xyXG4gIC8vIHN1Z2dlc3Rpb25zIHRvIGRpc3BsYXkuXHJcbiAgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMoXHJcbiAgICBjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgICByZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QsXHJcbiAgKTogUHJvbWlzZTxBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+PiB7XHJcbiAgICBjb25zdCBjb21wbGV0aW9uSXRlbXMgPSBhd2FpdCBjb25uZWN0aW9uLmNvbXBsZXRpb24oXHJcbiAgICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIucmVxdWVzdFRvVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMocmVxdWVzdCksXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyhjb21wbGV0aW9uSXRlbXMsIHJlcXVlc3QpO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgdG8gYmUgc2VudCB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyXHJcbiAgLy8gYmFzZWQgb24gdGhlIGVkaXRvciBhbmQgcG9zaXRpb24gZnJvbSB0aGUgQXV0b0NvbXBsZXRlUmVxdWVzdC5cclxuICAvL1xyXG4gIC8vICogYHJlcXVlc3RgIEFuIHtPYmplY3R9IHdpdGggdGhlIEF1dG9Db21wbGV0ZSsgcmVxdWVzdCB0byB1c2UuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGFuIHtPYmplY3R9IGNvbnRhaW5pbmcgdGhlIFRleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zIG9iamVjdCB3aXRoIHRoZSBrZXlzOlxyXG4gIC8vICAqIGB0ZXh0RG9jdW1lbnRgIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgdGV4dERvY3VtZW50IGlkZW50aWZpY2F0aW9uLlxyXG4gIC8vICAqIGBwb3NpdGlvbmAgdGhlIHBvc2l0aW9uIHdpdGhpbiB0aGUgdGV4dCBkb2N1bWVudCB0byBkaXNwbGF5IGNvbXBsZXRpb24gcmVxdWVzdCBmb3IuXHJcbiAgc3RhdGljIHJlcXVlc3RUb1RleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zKHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCk6IFRleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRleHREb2N1bWVudDogQ29udmVydC5lZGl0b3JUb1RleHREb2N1bWVudElkZW50aWZpZXIocmVxdWVzdC5lZGl0b3IpLFxyXG4gICAgICBwb3NpdGlvbjogQ29udmVydC5wb2ludFRvUG9zaXRpb24ocmVxdWVzdC5idWZmZXJQb3NpdGlvbiksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIGFycmF5IG9yIENvbXBsZXRpb25MaXN0IHRvXHJcbiAgLy8gYW4gYXJyYXkgb2YgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9ucy5cclxuICAvL1xyXG4gIC8vICogYGNvbXBsZXRpb25JdGVtc2AgQW4ge0FycmF5fSBvZiB7Q29tcGxldGlvbkl0ZW19IG9iamVjdHMgb3IgYSB7Q29tcGxldGlvbkxpc3R9IGNvbnRhaW5pbmcgY29tcGxldGlvblxyXG4gIC8vICAgICAgICAgICBpdGVtcyB0byBiZSBjb252ZXJ0ZWQuXHJcbiAgLy8gKiBgcmVxdWVzdGAgQW4ge09iamVjdH0gd2l0aCB0aGUgQXV0b0NvbXBsZXRlKyByZXF1ZXN0IHRvIHVzZS5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4ge0FycmF5fSBvZiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb25zLlxyXG4gIHN0YXRpYyBjb21wbGV0aW9uSXRlbXNUb1N1Z2dlc3Rpb25zKFxyXG4gICAgY29tcGxldGlvbkl0ZW1zOiBBcnJheTxDb21wbGV0aW9uSXRlbT4gfCBDb21wbGV0aW9uTGlzdCxcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICApOiBBcnJheTxhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24+IHtcclxuICAgIHJldHVybiAoQXJyYXkuaXNBcnJheShjb21wbGV0aW9uSXRlbXMpID8gY29tcGxldGlvbkl0ZW1zIDogY29tcGxldGlvbkl0ZW1zLml0ZW1zIHx8IFtdKS5tYXAocyA9PlxyXG4gICAgICBBdXRvY29tcGxldGVBZGFwdGVyLmNvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKHMsIHJlcXVlc3QpLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXHJcbiAgLy9cclxuICAvLyAqIGBpdGVtYCBBbiB7QXJyYXl9IG9mIHtDb21wbGV0aW9uSXRlbX0gb2JqZWN0cyBvciBhIHtDb21wbGV0aW9uTGlzdH0gY29udGFpbmluZyBjb21wbGV0aW9uXHJcbiAgLy8gICAgICAgICAgICAgaXRlbXMgdG8gYmUgY29udmVydGVkLlxyXG4gIC8vICogYHJlcXVlc3RgIEFuIHtPYmplY3R9IHdpdGggdGhlIEF1dG9Db21wbGV0ZSsgcmVxdWVzdCB0byB1c2UuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGFuIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbi5cclxuICBzdGF0aWMgY29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24oXHJcbiAgICBpdGVtOiBDb21wbGV0aW9uSXRlbSxcclxuICAgIHJlcXVlc3Q6IGF0b20kQXV0b2NvbXBsZXRlUmVxdWVzdCxcclxuICApOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24ge1xyXG4gICAgY29uc3Qgc3VnZ2VzdGlvbiA9IEF1dG9jb21wbGV0ZUFkYXB0ZXIuYmFzaWNDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihpdGVtKTtcclxuICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbihpdGVtLnRleHRFZGl0LCByZXF1ZXN0LmVkaXRvciwgc3VnZ2VzdGlvbik7XHJcbiAgICAvLyBUT0RPOiBTbmlwcGV0c1xyXG4gICAgcmV0dXJuIHN1Z2dlc3Rpb247XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IENvbnZlcnQgdGhlIHByaW1hcnkgcGFydHMgb2YgYSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgQ29tcGxldGlvbkl0ZW0gdG8gYW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIC8vXHJcbiAgLy8gKiBgaXRlbWAgQW4ge0FycmF5fSBvZiB7Q29tcGxldGlvbkl0ZW19IG9iamVjdHMgb3IgYSB7Q29tcGxldGlvbkxpc3R9IGNvbnRhaW5pbmcgY29tcGxldGlvblxyXG4gIC8vICAgICAgICAgICAgIGl0ZW1zIHRvIGJlIGNvbnZlcnRlZC5cclxuICAvL1xyXG4gIC8vIFJldHVybnMgYW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxyXG4gIHN0YXRpYyBiYXNpY0NvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKGl0ZW06IENvbXBsZXRpb25JdGVtKTogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHRleHQ6IGl0ZW0uaW5zZXJ0VGV4dCB8fCBpdGVtLmxhYmVsLFxyXG4gICAgICBkaXNwbGF5VGV4dDogaXRlbS5sYWJlbCxcclxuICAgICAgZmlsdGVyVGV4dDogaXRlbS5maWx0ZXJUZXh0IHx8IGl0ZW0ubGFiZWwsXHJcbiAgICAgIHR5cGU6IEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlKGl0ZW0ua2luZCksXHJcbiAgICAgIGxlZnRMYWJlbDogaXRlbS5kZXRhaWwsXHJcbiAgICAgIGRlc2NyaXB0aW9uOiBpdGVtLmRvY3VtZW50YXRpb24sXHJcbiAgICAgIGRlc2NyaXB0aW9uTWFya2Rvd246IGl0ZW0uZG9jdW1lbnRhdGlvbixcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IEFwcGxpZXMgdGhlIHRleHRFZGl0IHBhcnQgb2YgYSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgQ29tcGxldGlvbkl0ZW0gdG8gYW5cclxuICAvLyBBdXRvQ29tcGxldGUrIFN1Z2dlc3Rpb24gdmlhIHRoZSByZXBsYWNlbWVudFByZWZpeCBhbmQgdGV4dCBwcm9wZXJ0aWVzLlxyXG4gIC8vXHJcbiAgLy8gKiBgdGV4dEVkaXRgIEEge1RleHRFZGl0fSBmcm9tIGEgQ29tcGxldGlvbkl0ZW0gdG8gYXBwbHkuXHJcbiAgLy8gKiBgZWRpdG9yYCBBbiBBdG9tIHtUZXh0RWRpdG9yfSB1c2VkIHRvIG9idGFpbiB0aGUgbmVjZXNzYXJ5IHRleHQgcmVwbGFjZW1lbnQuXHJcbiAgLy8gKiBgc3VnZ2VzdGlvbmAgQW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uIHRvIHNldCB0aGUgcmVwbGFjZW1lbnRQcmVmaXggYW5kIHRleHQgcHJvcGVydGllcyBvZi5cclxuICBzdGF0aWMgYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbihcclxuICAgIHRleHRFZGl0OiA/VGV4dEVkaXQsXHJcbiAgICBlZGl0b3I6IGF0b20kVGV4dEVkaXRvcixcclxuICAgIHN1Z2dlc3Rpb246IGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbixcclxuICApOiB2b2lkIHtcclxuICAgIGlmICh0ZXh0RWRpdCAhPSBudWxsKSB7XHJcbiAgICAgIHN1Z2dlc3Rpb24ucmVwbGFjZW1lbnRQcmVmaXggPSBlZGl0b3IuZ2V0VGV4dEluQnVmZmVyUmFuZ2UoQ29udmVydC5sc1JhbmdlVG9BdG9tUmFuZ2UodGV4dEVkaXQucmFuZ2UpKTtcclxuICAgICAgc3VnZ2VzdGlvbi50ZXh0ID0gdGV4dEVkaXQubmV3VGV4dDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogT2J0YWluIHRoZSB0ZXh0dWFsIHN1Z2dlc3Rpb24gdHlwZSByZXF1aXJlZCBieSBBdXRvQ29tcGxldGUrIHRoYXRcclxuICAvLyBtb3N0IGNsb3NlbHkgbWFwcyB0byB0aGUgbnVtZXJpYyBjb21wbGV0aW9uIGtpbmQgc3VwcGxpZXMgYnkgdGhlIGxhbmd1YWdlIHNlcnZlci5cclxuICAvL1xyXG4gIC8vICogYGtpbmRgIEEge051bWJlcn0gdGhhdCByZXByZXNlbnRzIHRoZSBzdWdnZXN0aW9uIGtpbmQgdG8gYmUgY29udmVydGVkLlxyXG4gIC8vXHJcbiAgLy8gUmV0dXJucyBhIHtTdHJpbmd9IGNvbnRhaW5pbmcgdGhlIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbiB0eXBlIGVxdWl2YWxlbnRcclxuICAvLyB0byB0aGUgZ2l2ZW4gY29tcGxldGlvbiBraW5kLlxyXG4gIHN0YXRpYyBjb21wbGV0aW9uS2luZFRvU3VnZ2VzdGlvblR5cGUoa2luZDogP251bWJlcik6IHN0cmluZyB7XHJcbiAgICBzd2l0Y2ggKGtpbmQpIHtcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuTWV0aG9kOlxyXG4gICAgICAgIHJldHVybiAnbWV0aG9kJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuRnVuY3Rpb246XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkNvbnN0cnVjdG9yOlxyXG4gICAgICAgIHJldHVybiAnZnVuY3Rpb24nO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GaWVsZDpcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuUHJvcGVydHk6XHJcbiAgICAgICAgcmV0dXJuICdwcm9wZXJ0eSc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlZhcmlhYmxlOlxyXG4gICAgICAgIHJldHVybiAndmFyaWFibGUnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5DbGFzczpcclxuICAgICAgICByZXR1cm4gJ2NsYXNzJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuSW50ZXJmYWNlOlxyXG4gICAgICAgIHJldHVybiAnaW50ZXJmYWNlJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuTW9kdWxlOlxyXG4gICAgICAgIHJldHVybiAnbW9kdWxlJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuVW5pdDpcclxuICAgICAgICByZXR1cm4gJ2J1aWx0aW4nO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5FbnVtOlxyXG4gICAgICAgIHJldHVybiAnZW51bSc7XHJcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLktleXdvcmQ6XHJcbiAgICAgICAgcmV0dXJuICdrZXl3b3JkJztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuU25pcHBldDpcclxuICAgICAgICByZXR1cm4gJ3NuaXBwZXQnO1xyXG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GaWxlOlxyXG4gICAgICAgIHJldHVybiAnaW1wb3J0JztcclxuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuUmVmZXJlbmNlOlxyXG4gICAgICAgIHJldHVybiAncmVxdWlyZSc7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgcmV0dXJuICd2YWx1ZSc7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==