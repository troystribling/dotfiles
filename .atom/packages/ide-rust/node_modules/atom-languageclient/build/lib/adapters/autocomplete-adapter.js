Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

// Public: Adapts the language server protocol "textDocument/completion" to the Atom
// AutoComplete+ package.
let AutocompleteAdapter = class AutocompleteAdapter {
  static canAdapt(serverCapabilities) {
    return serverCapabilities.completionProvider != null;
  }

  // Public: Primary entry point for obtaining suggestions for AutoComplete+ by
  // querying the language server.
  //
  // * `connection` A {LanguageClientConnection} to the language server to query.
  // * `request` An {Object} with the AutoComplete+ request to satisfy.
  //
  // Returns a {Promise} of an {Array} of {Object}s containing the AutoComplete+
  // suggestions to display.
  getSuggestions(connection, request) {
    return _asyncToGenerator(function* () {
      const completionItems = yield connection.completion(AutocompleteAdapter.requestToTextDocumentPositionParams(request));
      return AutocompleteAdapter.completionItemsToSuggestions(completionItems, request);
    })();
  }

  // Public: Create TextDocumentPositionParams to be sent to the language server
  // based on the editor and position from the AutoCompleteRequest.
  //
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Object} containing the TextDocumentPositionParams object with the keys:
  //  * `textDocument` the language server protocol textDocument identification.
  //  * `position` the position within the text document to display completion request for.
  static requestToTextDocumentPositionParams(request) {
    return {
      textDocument: _convert2.default.editorToTextDocumentIdentifier(request.editor),
      position: _convert2.default.pointToPosition(request.bufferPosition)
    };
  }

  // Public: Convert a language server protocol CompletionItem array or CompletionList to
  // an array of AutoComplete+ suggestions.
  //
  // * `completionItems` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //           items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an {Array} of AutoComplete+ suggestions.
  static completionItemsToSuggestions(completionItems, request) {
    return (Array.isArray(completionItems) ? completionItems : completionItems.items || []).map(s => AutocompleteAdapter.completionItemToSuggestion(s, request));
  }

  // Public: Convert a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  // * `request` An {Object} with the AutoComplete+ request to use.
  //
  // Returns an AutoComplete+ suggestion.
  static completionItemToSuggestion(item, request) {
    const suggestion = AutocompleteAdapter.basicCompletionItemToSuggestion(item);
    AutocompleteAdapter.applyTextEditToSuggestion(item.textEdit, request.editor, suggestion);
    // TODO: Snippets
    return suggestion;
  }

  // Public: Convert the primary parts of a language server protocol CompletionItem to an AutoComplete+ suggestion.
  //
  // * `item` An {Array} of {CompletionItem} objects or a {CompletionList} containing completion
  //             items to be converted.
  //
  // Returns an AutoComplete+ suggestion.
  static basicCompletionItemToSuggestion(item) {
    return {
      text: item.insertText || item.label,
      displayText: item.label,
      filterText: item.filterText || item.label,
      type: AutocompleteAdapter.completionKindToSuggestionType(item.kind),
      leftLabel: item.detail,
      description: item.documentation
    };
  }

  // Public: Applies the textEdit part of a language server protocol CompletionItem to an
  // AutoComplete+ Suggestion via the replacementPrefix and text properties.
  //
  // * `textEdit` A {TextEdit} from a CompletionItem to apply.
  // * `editor` An Atom {TextEditor} used to obtain the necessary text replacement.
  // * `suggestion` An AutoComplete+ suggestion to set the replacementPrefix and text properties of.
  static applyTextEditToSuggestion(textEdit, editor, suggestion) {
    if (textEdit != null) {
      suggestion.replacementPrefix = editor.getTextInBufferRange(_convert2.default.lsRangeToAtomRange(textEdit.range));
      suggestion.text = textEdit.newText;
    }
  }

  // Public: Obtain the textual suggestion type required by AutoComplete+ that
  // most closely maps to the numeric completion kind supplies by the language server.
  //
  // * `kind` A {Number} that represents the suggestion kind to be converted.
  //
  // Returns a {String} containing the AutoComplete+ suggestion type equivalent
  // to the given completion kind.
  static completionKindToSuggestionType(kind) {
    switch (kind) {
      case _languageclient.CompletionItemKind.Method:
        return 'method';
      case _languageclient.CompletionItemKind.Function:
      case _languageclient.CompletionItemKind.Constructor:
        return 'function';
      case _languageclient.CompletionItemKind.Field:
      case _languageclient.CompletionItemKind.Property:
        return 'property';
      case _languageclient.CompletionItemKind.Variable:
        return 'variable';
      case _languageclient.CompletionItemKind.Class:
        return 'class';
      case _languageclient.CompletionItemKind.Interface:
        return 'interface';
      case _languageclient.CompletionItemKind.Module:
        return 'module';
      case _languageclient.CompletionItemKind.Unit:
        return 'builtin';
      case _languageclient.CompletionItemKind.Enum:
        return 'enum';
      case _languageclient.CompletionItemKind.Keyword:
        return 'keyword';
      case _languageclient.CompletionItemKind.Snippet:
        return 'snippet';
      case _languageclient.CompletionItemKind.File:
        return 'import';
      case _languageclient.CompletionItemKind.Reference:
        return 'require';
      default:
        return 'value';
    }
  }
};
exports.default = AutocompleteAdapter;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9hdXRvY29tcGxldGUtYWRhcHRlci5qcyJdLCJuYW1lcyI6WyJBdXRvY29tcGxldGVBZGFwdGVyIiwiY2FuQWRhcHQiLCJzZXJ2ZXJDYXBhYmlsaXRpZXMiLCJjb21wbGV0aW9uUHJvdmlkZXIiLCJnZXRTdWdnZXN0aW9ucyIsImNvbm5lY3Rpb24iLCJyZXF1ZXN0IiwiY29tcGxldGlvbkl0ZW1zIiwiY29tcGxldGlvbiIsInJlcXVlc3RUb1RleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zIiwiY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyIsInRleHREb2N1bWVudCIsImVkaXRvclRvVGV4dERvY3VtZW50SWRlbnRpZmllciIsImVkaXRvciIsInBvc2l0aW9uIiwicG9pbnRUb1Bvc2l0aW9uIiwiYnVmZmVyUG9zaXRpb24iLCJBcnJheSIsImlzQXJyYXkiLCJpdGVtcyIsIm1hcCIsInMiLCJjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsIml0ZW0iLCJzdWdnZXN0aW9uIiwiYmFzaWNDb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbiIsImFwcGx5VGV4dEVkaXRUb1N1Z2dlc3Rpb24iLCJ0ZXh0RWRpdCIsInRleHQiLCJpbnNlcnRUZXh0IiwibGFiZWwiLCJkaXNwbGF5VGV4dCIsImZpbHRlclRleHQiLCJ0eXBlIiwiY29tcGxldGlvbktpbmRUb1N1Z2dlc3Rpb25UeXBlIiwia2luZCIsImxlZnRMYWJlbCIsImRldGFpbCIsImRlc2NyaXB0aW9uIiwiZG9jdW1lbnRhdGlvbiIsInJlcGxhY2VtZW50UHJlZml4IiwiZ2V0VGV4dEluQnVmZmVyUmFuZ2UiLCJsc1JhbmdlVG9BdG9tUmFuZ2UiLCJyYW5nZSIsIm5ld1RleHQiLCJNZXRob2QiLCJGdW5jdGlvbiIsIkNvbnN0cnVjdG9yIiwiRmllbGQiLCJQcm9wZXJ0eSIsIlZhcmlhYmxlIiwiQ2xhc3MiLCJJbnRlcmZhY2UiLCJNb2R1bGUiLCJVbml0IiwiRW51bSIs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QW1CVSxNQUF4QjtBQUNFLGVBQU8sUUFBUDtBQUNGLFdBQUssbUNBQW1CQyxRQUF4QjtBQUNBLFdBQUssbUNBQW1CQyxXQUF4QjtBQUNFLGVBQU8sVUFBUDtBQUNGLFdBQUssbUNBQW1CQyxLQUF4QjtBQUNBLFdBQUssbUNBQW1CQyxRQUF4QjtBQUNFLGVBQU8sVUFBUDtBQUNGLFdBQUssbUNBQW1CQyxRQUF4QjtBQUNFLGVBQU8sVUFBUDtBQUNGLFdBQUssbUNBQW1CQyxLQUF4QjtBQUNFLGVBQU8sT0FBUDtBQUNGLFdBQUssbUNBQW1CQyxTQUF4QjtBQUNFLGVBQU8sV0FBUDtBQUNGLFdBQUssbUNBQW1CQyxNQUF4QjtBQUNFLGVBQU8sUUFBUDtBQUNGLFdBQUssbUNBQW1CQyxJQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGLFdBQUssbUNBQW1CQyxJQUF4QjtBQUNFLGVBQU8sTUFBUDtBQUNGLFdBQUssbUNBQW1CQyxPQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGLFdBQUssbUNBQW1CQyxPQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGLFdBQUssbUNBQW1CQyxJQUF4QjtBQUNFLGVBQU8sUUFBUDtBQUNGLFdBQUssbUNBQW1CQyxTQUF4QjtBQUNFLGVBQU8sU0FBUDtBQUNGO0FBQ0UsZUFBTyxPQUFQO0FBOUJKO0FBZ0NEO0FBbElzQyxDO2tCQUFwQjNELG1CIiwiZmlsZSI6ImF1dG9jb21wbGV0ZS1hZGFwdGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHtcbiAgQ29tcGxldGlvbkl0ZW1LaW5kLFxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXG4gIHR5cGUgQ29tcGxldGlvbkl0ZW0sXG4gIHR5cGUgQ29tcGxldGlvbkxpc3QsXG4gIHR5cGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMsXG4gIHR5cGUgVGV4dEVkaXQsXG4gIHR5cGUgU2VydmVyQ2FwYWJpbGl0aWVzXG59IGZyb20gJy4uL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCBDb252ZXJ0IGZyb20gJy4uL2NvbnZlcnQnO1xuXG4vLyBQdWJsaWM6IEFkYXB0cyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIFwidGV4dERvY3VtZW50L2NvbXBsZXRpb25cIiB0byB0aGUgQXRvbVxuLy8gQXV0b0NvbXBsZXRlKyBwYWNrYWdlLlxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0b2NvbXBsZXRlQWRhcHRlciB7XG4gIHN0YXRpYyBjYW5BZGFwdChzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBzZXJ2ZXJDYXBhYmlsaXRpZXMuY29tcGxldGlvblByb3ZpZGVyICE9IG51bGw7XG4gIH1cblxuICAvLyBQdWJsaWM6IFByaW1hcnkgZW50cnkgcG9pbnQgZm9yIG9idGFpbmluZyBzdWdnZXN0aW9ucyBmb3IgQXV0b0NvbXBsZXRlKyBieVxuICAvLyBxdWVyeWluZyB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxuICAvL1xuICAvLyAqIGBjb25uZWN0aW9uYCBBIHtMYW5ndWFnZUNsaWVudENvbm5lY3Rpb259IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdG8gcXVlcnkuXG4gIC8vICogYHJlcXVlc3RgIEFuIHtPYmplY3R9IHdpdGggdGhlIEF1dG9Db21wbGV0ZSsgcmVxdWVzdCB0byBzYXRpc2Z5LlxuICAvL1xuICAvLyBSZXR1cm5zIGEge1Byb21pc2V9IG9mIGFuIHtBcnJheX0gb2Yge09iamVjdH1zIGNvbnRhaW5pbmcgdGhlIEF1dG9Db21wbGV0ZStcbiAgLy8gc3VnZ2VzdGlvbnMgdG8gZGlzcGxheS5cbiAgYXN5bmMgZ2V0U3VnZ2VzdGlvbnMoY29ubmVjdGlvbjogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uLCByZXF1ZXN0OiBhdG9tJEF1dG9jb21wbGV0ZVJlcXVlc3QpOiBQcm9taXNlPEFycmF5PGF0b20kQXV0b2NvbXBsZXRlU3VnZ2VzdGlvbj4+IHtcbiAgICBjb25zdCBjb21wbGV0aW9uSXRlbXMgPSBhd2FpdCBjb25uZWN0aW9uLmNvbXBsZXRpb24oQXV0b2NvbXBsZXRlQWRhcHRlci5yZXF1ZXN0VG9UZXh0RG9jdW1lbnRQb3NpdGlvblBhcmFtcyhyZXF1ZXN0KSk7XG4gICAgcmV0dXJuIEF1dG9jb21wbGV0ZUFkYXB0ZXIuY29tcGxldGlvbkl0ZW1zVG9TdWdnZXN0aW9ucyhjb21wbGV0aW9uSXRlbXMsIHJlcXVlc3QpO1xuICB9XG5cbiAgLy8gUHVibGljOiBDcmVhdGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgdG8gYmUgc2VudCB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyXG4gIC8vIGJhc2VkIG9uIHRoZSBlZGl0b3IgYW5kIHBvc2l0aW9uIGZyb20gdGhlIEF1dG9Db21wbGV0ZVJlcXVlc3QuXG4gIC8vXG4gIC8vICogYHJlcXVlc3RgIEFuIHtPYmplY3R9IHdpdGggdGhlIEF1dG9Db21wbGV0ZSsgcmVxdWVzdCB0byB1c2UuXG4gIC8vXG4gIC8vIFJldHVybnMgYW4ge09iamVjdH0gY29udGFpbmluZyB0aGUgVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMgb2JqZWN0IHdpdGggdGhlIGtleXM6XG4gIC8vICAqIGB0ZXh0RG9jdW1lbnRgIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgdGV4dERvY3VtZW50IGlkZW50aWZpY2F0aW9uLlxuICAvLyAgKiBgcG9zaXRpb25gIHRoZSBwb3NpdGlvbiB3aXRoaW4gdGhlIHRleHQgZG9jdW1lbnQgdG8gZGlzcGxheSBjb21wbGV0aW9uIHJlcXVlc3QgZm9yLlxuICBzdGF0aWMgcmVxdWVzdFRvVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMocmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KTogVGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0RG9jdW1lbnQ6IENvbnZlcnQuZWRpdG9yVG9UZXh0RG9jdW1lbnRJZGVudGlmaWVyKHJlcXVlc3QuZWRpdG9yKSxcbiAgICAgIHBvc2l0aW9uOiBDb252ZXJ0LnBvaW50VG9Qb3NpdGlvbihyZXF1ZXN0LmJ1ZmZlclBvc2l0aW9uKSxcbiAgICB9O1xuICB9XG5cbiAgLy8gUHVibGljOiBDb252ZXJ0IGEgbGFuZ3VhZ2Ugc2VydmVyIHByb3RvY29sIENvbXBsZXRpb25JdGVtIGFycmF5IG9yIENvbXBsZXRpb25MaXN0IHRvXG4gIC8vIGFuIGFycmF5IG9mIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbnMuXG4gIC8vXG4gIC8vICogYGNvbXBsZXRpb25JdGVtc2AgQW4ge0FycmF5fSBvZiB7Q29tcGxldGlvbkl0ZW19IG9iamVjdHMgb3IgYSB7Q29tcGxldGlvbkxpc3R9IGNvbnRhaW5pbmcgY29tcGxldGlvblxuICAvLyAgICAgICAgICAgaXRlbXMgdG8gYmUgY29udmVydGVkLlxuICAvLyAqIGByZXF1ZXN0YCBBbiB7T2JqZWN0fSB3aXRoIHRoZSBBdXRvQ29tcGxldGUrIHJlcXVlc3QgdG8gdXNlLlxuICAvL1xuICAvLyBSZXR1cm5zIGFuIHtBcnJheX0gb2YgQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9ucy5cbiAgc3RhdGljIGNvbXBsZXRpb25JdGVtc1RvU3VnZ2VzdGlvbnMoY29tcGxldGlvbkl0ZW1zOiBBcnJheTxDb21wbGV0aW9uSXRlbT4gfCBDb21wbGV0aW9uTGlzdCwgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KTogQXJyYXk8YXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uPiB7XG4gICAgcmV0dXJuIChBcnJheS5pc0FycmF5KGNvbXBsZXRpb25JdGVtcykgPyBjb21wbGV0aW9uSXRlbXMgOiBjb21wbGV0aW9uSXRlbXMuaXRlbXMgfHwgW10pXG4gICAgICAubWFwKHMgPT4gQXV0b2NvbXBsZXRlQWRhcHRlci5jb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihzLCByZXF1ZXN0KSk7XG4gIH1cblxuICAvLyBQdWJsaWM6IENvbnZlcnQgYSBsYW5ndWFnZSBzZXJ2ZXIgcHJvdG9jb2wgQ29tcGxldGlvbkl0ZW0gdG8gYW4gQXV0b0NvbXBsZXRlKyBzdWdnZXN0aW9uLlxuICAvL1xuICAvLyAqIGBpdGVtYCBBbiB7QXJyYXl9IG9mIHtDb21wbGV0aW9uSXRlbX0gb2JqZWN0cyBvciBhIHtDb21wbGV0aW9uTGlzdH0gY29udGFpbmluZyBjb21wbGV0aW9uXG4gIC8vICAgICAgICAgICAgIGl0ZW1zIHRvIGJlIGNvbnZlcnRlZC5cbiAgLy8gKiBgcmVxdWVzdGAgQW4ge09iamVjdH0gd2l0aCB0aGUgQXV0b0NvbXBsZXRlKyByZXF1ZXN0IHRvIHVzZS5cbiAgLy9cbiAgLy8gUmV0dXJucyBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXG4gIHN0YXRpYyBjb21wbGV0aW9uSXRlbVRvU3VnZ2VzdGlvbihpdGVtOiBDb21wbGV0aW9uSXRlbSwgcmVxdWVzdDogYXRvbSRBdXRvY29tcGxldGVSZXF1ZXN0KTogYXRvbSRBdXRvY29tcGxldGVTdWdnZXN0aW9uIHtcbiAgICBjb25zdCBzdWdnZXN0aW9uID0gQXV0b2NvbXBsZXRlQWRhcHRlci5iYXNpY0NvbXBsZXRpb25JdGVtVG9TdWdnZXN0aW9uKGl0ZW0pO1xuICAgIEF1dG9jb21wbGV0ZUFkYXB0ZXIuYXBwbHlUZXh0RWRpdFRvU3VnZ2VzdGlvbihpdGVtLnRleHRFZGl0LCByZXF1ZXN0LmVkaXRvciwgc3VnZ2VzdGlvbik7XG4gICAgLy8gVE9ETzogU25pcHBldHNcbiAgICByZXR1cm4gc3VnZ2VzdGlvbjtcbiAgfVxuXG4gIC8vIFB1YmxpYzogQ29udmVydCB0aGUgcHJpbWFyeSBwYXJ0cyBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhbiBBdXRvQ29tcGxldGUrIHN1Z2dlc3Rpb24uXG4gIC8vXG4gIC8vICogYGl0ZW1gIEFuIHtBcnJheX0gb2Yge0NvbXBsZXRpb25JdGVtfSBvYmplY3RzIG9yIGEge0NvbXBsZXRpb25MaXN0fSBjb250YWluaW5nIGNvbXBsZXRpb25cbiAgLy8gICAgICAgICAgICAgaXRlbXMgdG8gYmUgY29udmVydGVkLlxuICAvL1xuICAvLyBSZXR1cm5zIGFuIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbi5cbiAgc3RhdGljIGJhc2ljQ29tcGxldGlvbkl0ZW1Ub1N1Z2dlc3Rpb24oaXRlbTogQ29tcGxldGlvbkl0ZW0pOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB0ZXh0OiBpdGVtLmluc2VydFRleHQgfHwgaXRlbS5sYWJlbCxcbiAgICAgIGRpc3BsYXlUZXh0OiBpdGVtLmxhYmVsLFxuICAgICAgZmlsdGVyVGV4dDogaXRlbS5maWx0ZXJUZXh0IHx8IGl0ZW0ubGFiZWwsXG4gICAgICB0eXBlOiBBdXRvY29tcGxldGVBZGFwdGVyLmNvbXBsZXRpb25LaW5kVG9TdWdnZXN0aW9uVHlwZShpdGVtLmtpbmQpLFxuICAgICAgbGVmdExhYmVsOiBpdGVtLmRldGFpbCxcbiAgICAgIGRlc2NyaXB0aW9uOiBpdGVtLmRvY3VtZW50YXRpb24sXG4gICAgfTtcbiAgfVxuXG4gIC8vIFB1YmxpYzogQXBwbGllcyB0aGUgdGV4dEVkaXQgcGFydCBvZiBhIGxhbmd1YWdlIHNlcnZlciBwcm90b2NvbCBDb21wbGV0aW9uSXRlbSB0byBhblxuICAvLyBBdXRvQ29tcGxldGUrIFN1Z2dlc3Rpb24gdmlhIHRoZSByZXBsYWNlbWVudFByZWZpeCBhbmQgdGV4dCBwcm9wZXJ0aWVzLlxuICAvL1xuICAvLyAqIGB0ZXh0RWRpdGAgQSB7VGV4dEVkaXR9IGZyb20gYSBDb21wbGV0aW9uSXRlbSB0byBhcHBseS5cbiAgLy8gKiBgZWRpdG9yYCBBbiBBdG9tIHtUZXh0RWRpdG9yfSB1c2VkIHRvIG9idGFpbiB0aGUgbmVjZXNzYXJ5IHRleHQgcmVwbGFjZW1lbnQuXG4gIC8vICogYHN1Z2dlc3Rpb25gIEFuIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbiB0byBzZXQgdGhlIHJlcGxhY2VtZW50UHJlZml4IGFuZCB0ZXh0IHByb3BlcnRpZXMgb2YuXG4gIHN0YXRpYyBhcHBseVRleHRFZGl0VG9TdWdnZXN0aW9uKHRleHRFZGl0OiA/VGV4dEVkaXQsIGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yLCBzdWdnZXN0aW9uOiBhdG9tJEF1dG9jb21wbGV0ZVN1Z2dlc3Rpb24pOiB2b2lkIHtcbiAgICBpZiAodGV4dEVkaXQgIT0gbnVsbCkge1xuICAgICAgc3VnZ2VzdGlvbi5yZXBsYWNlbWVudFByZWZpeCA9IGVkaXRvci5nZXRUZXh0SW5CdWZmZXJSYW5nZShDb252ZXJ0LmxzUmFuZ2VUb0F0b21SYW5nZSh0ZXh0RWRpdC5yYW5nZSkpO1xuICAgICAgc3VnZ2VzdGlvbi50ZXh0ID0gdGV4dEVkaXQubmV3VGV4dDtcbiAgICB9XG4gIH1cblxuICAvLyBQdWJsaWM6IE9idGFpbiB0aGUgdGV4dHVhbCBzdWdnZXN0aW9uIHR5cGUgcmVxdWlyZWQgYnkgQXV0b0NvbXBsZXRlKyB0aGF0XG4gIC8vIG1vc3QgY2xvc2VseSBtYXBzIHRvIHRoZSBudW1lcmljIGNvbXBsZXRpb24ga2luZCBzdXBwbGllcyBieSB0aGUgbGFuZ3VhZ2Ugc2VydmVyLlxuICAvL1xuICAvLyAqIGBraW5kYCBBIHtOdW1iZXJ9IHRoYXQgcmVwcmVzZW50cyB0aGUgc3VnZ2VzdGlvbiBraW5kIHRvIGJlIGNvbnZlcnRlZC5cbiAgLy9cbiAgLy8gUmV0dXJucyBhIHtTdHJpbmd9IGNvbnRhaW5pbmcgdGhlIEF1dG9Db21wbGV0ZSsgc3VnZ2VzdGlvbiB0eXBlIGVxdWl2YWxlbnRcbiAgLy8gdG8gdGhlIGdpdmVuIGNvbXBsZXRpb24ga2luZC5cbiAgc3RhdGljIGNvbXBsZXRpb25LaW5kVG9TdWdnZXN0aW9uVHlwZShraW5kOiA/bnVtYmVyKTogc3RyaW5nIHtcbiAgICBzd2l0Y2ggKGtpbmQpIHtcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLk1ldGhvZDpcbiAgICAgICAgcmV0dXJuICdtZXRob2QnO1xuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuRnVuY3Rpb246XG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Db25zdHJ1Y3RvcjpcbiAgICAgICAgcmV0dXJuICdmdW5jdGlvbic7XG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5GaWVsZDpcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlByb3BlcnR5OlxuICAgICAgICByZXR1cm4gJ3Byb3BlcnR5JztcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLlZhcmlhYmxlOlxuICAgICAgICByZXR1cm4gJ3ZhcmlhYmxlJztcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkNsYXNzOlxuICAgICAgICByZXR1cm4gJ2NsYXNzJztcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLkludGVyZmFjZTpcbiAgICAgICAgcmV0dXJuICdpbnRlcmZhY2UnO1xuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuTW9kdWxlOlxuICAgICAgICByZXR1cm4gJ21vZHVsZSc7XG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5Vbml0OlxuICAgICAgICByZXR1cm4gJ2J1aWx0aW4nO1xuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuRW51bTpcbiAgICAgICAgcmV0dXJuICdlbnVtJztcbiAgICAgIGNhc2UgQ29tcGxldGlvbkl0ZW1LaW5kLktleXdvcmQ6XG4gICAgICAgIHJldHVybiAna2V5d29yZCc7XG4gICAgICBjYXNlIENvbXBsZXRpb25JdGVtS2luZC5TbmlwcGV0OlxuICAgICAgICByZXR1cm4gJ3NuaXBwZXQnO1xuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuRmlsZTpcbiAgICAgICAgcmV0dXJuICdpbXBvcnQnO1xuICAgICAgY2FzZSBDb21wbGV0aW9uSXRlbUtpbmQuUmVmZXJlbmNlOlxuICAgICAgICByZXR1cm4gJ3JlcXVpcmUnO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuICd2YWx1ZSc7XG4gICAgfVxuICB9XG59XG4iXX0=