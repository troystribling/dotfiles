Object.defineProperty(exports, "__esModule", {
  value: true
});

var _languageclient = require('../languageclient');

var _convert = require('../convert');

var _convert2 = _interopRequireDefault(_convert);

var _atom = require('atom');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// Public: Synchronizes the documents between Atom and the language server by notifying
// each end of changes, opening, closing and other events as well as sending and applying
// changes either in whole or in part depending on what the language server supports.
class DocumentSyncAdapter {

  // Public: Determine whether this adapter can be used to adapt a language server
  // based on the serverCapabilities matrix textDocumentSync capability either being Full or
  // Incremental.
  //
  // * `serverCapabilities` The {ServerCapabilities} of the language server to consider.
  //
  // Returns a {Boolean} indicating adapter can adapt the server based on the
  // given serverCapabilities.
  static canAdapt(serverCapabilities) {
    return this.canAdaptV2(serverCapabilities) || this.canAdaptV3(serverCapabilities);
  }

  static canAdaptV2(serverCapabilities) {
    return serverCapabilities.textDocumentSync === _languageclient.TextDocumentSyncKind.Incremental || serverCapabilities.textDocumentSync === _languageclient.TextDocumentSyncKind.Full;
  }

  static canAdaptV3(serverCapabilities) {
    const options = serverCapabilities.textDocumentSync;
    return options !== null && typeof options === 'object' && (options.change === _languageclient.TextDocumentSyncKind.Incremental || options.change === _languageclient.TextDocumentSyncKind.Full);
  }

  // Public: Create a new {DocumentSyncAdapter} for the given language server.
  //
  // * `connection` A {LanguageClientConnection} to the language server to be kept in sync.
  // * `documentSyncKind` The type of document syncing supported - Full or Incremental.
  // * `editorSelector` A predicate function that takes a {TextEditor} and returns a {boolean}
  //                    indicating whether this adapter should care about the contents of the editor.
  constructor(connection, documentSyncKind, editorSelector) {
    this._disposable = new _atom.CompositeDisposable();
    this._editors = new WeakMap();
    this._versions = new Map();

    this._connection = connection;
    if (typeof documentSyncKind === 'number') {
      this._documentSyncKind = documentSyncKind;
    } else if (documentSyncKind != null && documentSyncKind.change != null) {
      this._documentSyncKind = documentSyncKind.change;
    } else {
      this._documentSyncKind = _languageclient.TextDocumentSyncKind.Full;
    }
    this._editorSelector = editorSelector;
    this._disposable.add(atom.textEditors.observe(this.observeTextEditor.bind(this)));
  }

  // Dispose this adapter ensuring any resources are freed and events unhooked.
  dispose() {
    this._disposable.dispose();
  }

  // Examine a {TextEditor} and decide if we wish to observe it. If so ensure that we stop observing it
  // when it is closed or otherwise destroyed.
  //
  // * `editor` A {TextEditor} to consider for observation.
  observeTextEditor(editor) {
    const listener = editor.observeGrammar(grammar => this._handleGrammarChange(editor));
    this._disposable.add(editor.onDidDestroy(() => {
      this._disposable.remove(listener);
      listener.dispose();
    }));
    this._disposable.add(listener);
    if (!this._editors.has(editor) && this._editorSelector(editor)) {
      this._handleNewEditor(editor);
    }
  }

  _handleGrammarChange(editor) {
    const sync = this._editors.get(editor);
    if (sync != null && !this._editorSelector(editor)) {
      this._editors.delete(editor);
      this._disposable.remove(sync);
      sync.dispose();
    } else if (sync == null && this._editorSelector(editor)) {
      this._handleNewEditor(editor);
    }
  }

  _handleNewEditor(editor) {
    const sync = new TextEditorSyncAdapter(editor, this._connection, this._documentSyncKind, this._versions);
    this._editors.set(editor, sync);
    this._disposable.add(sync);
    this._disposable.add(editor.onDidDestroy(() => {
      const destroyedSync = this._editors.get(editor);
      if (destroyedSync) {
        this._editors.delete(editor);
        this._disposable.remove(destroyedSync);
        destroyedSync.dispose();
      }
    }));
  }

  getEditorSyncAdapter(editor) {
    return this._editors.get(editor);
  }
}

exports.default = DocumentSyncAdapter; // Public: Keep a single {TextEditor} in sync with a given language server.

class TextEditorSyncAdapter {

  // Public: Create a {TextEditorSyncAdapter} in sync with a given language server.
  //
  // * `editor` A {TextEditor} to keep in sync.
  // * `connection` A {LanguageClientConnection} to a language server to keep in sync.
  // * `documentSyncKind` Whether to use Full (1) or Incremental (2) when sending changes.
  constructor(editor, connection, documentSyncKind, versions) {
    this._disposable = new _atom.CompositeDisposable();

    this._editor = editor;
    this._connection = connection;
    this._versions = versions;
    this._fakeDidChangeWatchedFiles = atom.project.onDidChangeFiles == null;

    const changeTracking = this.setupChangeTracking(documentSyncKind);
    if (changeTracking != null) {
      this._disposable.add(changeTracking);
    }

    this._disposable.add(editor.getBuffer().onWillSave(this.willSave.bind(this)), editor.onDidSave(this.didSave.bind(this)), editor.onDidDestroy(this.didClose.bind(this)), editor.onDidChangePath(this.didRename.bind(this)));

    this._currentUri = this.getEditorUri();
    this.didOpen();
  }

  // The change tracking disposable listener that will ensure that changes are sent to the
  // language server as appropriate.
  setupChangeTracking(documentSyncKind) {
    switch (documentSyncKind) {
      case _languageclient.TextDocumentSyncKind.Full:
        return this._editor.onDidChange(this.sendFullChanges.bind(this));
      case _languageclient.TextDocumentSyncKind.Incremental:
        return this._editor.getBuffer().onDidChangeText(this.sendIncrementalChanges.bind(this));
    }
    return null;
  }

  // Dispose this adapter ensuring any resources are freed and events unhooked.
  dispose() {
    this._disposable.dispose();
  }

  // Get the languageId field that will be sent to the language server by simply
  // using the grammar name.
  getLanguageId() {
    return this._editor.getGrammar().name;
  }

  // Public: Create a {VersionedTextDocumentIdentifier} for the document observed by
  // this adapter including both the Uri and the current Version.
  getVersionedTextDocumentIdentifier() {
    return {
      uri: this.getEditorUri(),
      version: this._getVersion(this._editor.getPath() || '')
    };
  }

  // Public: Send the entire document to the language server. This is used when
  // operating in Full (1) sync mode.
  sendFullChanges() {
    if (!this._isPrimaryAdapter()) {
      return;
    } // Multiple editors, we are not first

    this._bumpVersion();
    this._connection.didChangeTextDocument({
      textDocument: this.getVersionedTextDocumentIdentifier(),
      contentChanges: [{ text: this._editor.getText() }]
    });
  }

  // Public: Send the incremental text changes to the language server. This is used
  // when operating in Incremental (2) sync mode.
  //
  // * `event` The event fired by Atom to indicate the document has stopped changing
  //           including a list of changes since the last time this event fired for this
  //           text editor.
  // Note: The order of changes in the event is guaranteed top to bottom.  Language server
  // expects this in reverse.
  sendIncrementalChanges(event) {
    if (event.changes.length > 0) {
      if (!this._isPrimaryAdapter()) {
        return;
      } // Multiple editors, we are not first

      this._bumpVersion();
      this._connection.didChangeTextDocument({
        textDocument: this.getVersionedTextDocumentIdentifier(),
        contentChanges: event.changes.map(TextEditorSyncAdapter.textEditToContentChange).reverse()
      });
    }
  }

  // Public: Convert an Atom {TextEditEvent} to a language server {TextDocumentContentChangeEvent}
  // object.
  //
  // * `change` The Atom {TextEditEvent} to convert.
  //
  // Returns a {TextDocumentContentChangeEvent} that represents the converted {TextEditEvent}.
  static textEditToContentChange(change) {
    return {
      range: _convert2.default.atomRangeToLSRange(change.oldRange),
      rangeLength: change.oldText.length,
      text: change.newText
    };
  }

  _isPrimaryAdapter() {
    const lowestIdForBuffer = Math.min(...atom.workspace.getTextEditors().filter(t => t.getBuffer() === this._editor.getBuffer()).map(t => t.id));
    return lowestIdForBuffer === this._editor.id;
  }

  _bumpVersion() {
    const filePath = this._editor.getPath();
    if (filePath == null) {
      return;
    }
    this._versions.set(filePath, this._getVersion(filePath) + 1);
  }

  // Ensure when the document is opened we send notification to the language server
  // so it can load it in and keep track of diagnostics etc.
  didOpen() {
    const filePath = this._editor.getPath();
    if (filePath == null) {
      return;
    } // Not yet saved

    if (!this._isPrimaryAdapter()) {
      return;
    } // Multiple editors, we are not first

    this._connection.didOpenTextDocument({
      textDocument: {
        uri: this.getEditorUri(),
        languageId: this.getLanguageId().toLowerCase(),
        version: this._getVersion(filePath),
        text: this._editor.getText()
      }
    });
  }

  _getVersion(filePath) {
    return this._versions.get(filePath) || 1;
  }

  // Called when the {TextEditor} is closed and sends the 'didCloseTextDocument' notification to
  // the connected language server.
  didClose() {
    if (this._editor.getPath() == null) {
      return;
    } // Not yet saved

    const fileStillOpen = atom.workspace.getTextEditors().find(t => t.getBuffer() === this._editor.getBuffer());
    if (fileStillOpen) {
      return; // Other windows or editors still have this file open
    }

    this._connection.didCloseTextDocument({ textDocument: { uri: this.getEditorUri() } });
  }

  // Called just before the {TextEditor} saves and sends the 'willSaveTextDocument' notification to
  // the connected language server.
  willSave() {
    if (!this._isPrimaryAdapter()) {
      return;
    }

    const uri = this.getEditorUri();
    this._connection.willSaveTextDocument({
      textDocument: { uri },
      reason: _languageclient.TextDocumentSaveReason.Manual
    });
  }

  // Called when the {TextEditor} saves and sends the 'didSaveTextDocument' notification to
  // the connected language server.
  // Note: Right now this also sends the `didChangeWatchedFiles` notification as well but that
  // will be sent from elsewhere soon.
  didSave() {
    if (!this._isPrimaryAdapter()) {
      return;
    }

    const uri = this.getEditorUri();
    this._connection.didSaveTextDocument({ textDocument: { uri } });
    if (this._fakeDidChangeWatchedFiles) {
      this._connection.didChangeWatchedFiles({
        changes: [{ uri, type: _languageclient.FileChangeType.Changed }]
      });
    }
  }

  didRename() {
    if (!this._isPrimaryAdapter()) {
      return;
    }

    const oldUri = this._currentUri;
    this._currentUri = this.getEditorUri();
    if (!oldUri) {
      return; // Didn't previously have a name
    }

    this._connection.didCloseTextDocument({
      textDocument: { uri: oldUri }
    });

    if (this._fakeDidChangeWatchedFiles) {
      this._connection.didChangeWatchedFiles({
        changes: [{ uri: oldUri, type: _languageclient.FileChangeType.Deleted }, { uri: this._currentUri, type: _languageclient.FileChangeType.Created }]
      });
    }

    // Send an equivalent open event for this editor, which will now use the new
    // file path.
    this.didOpen();
  }

  // Public: Obtain the current {TextEditor} path and convert it to a Uri.
  getEditorUri() {
    return _convert2.default.pathToUri(this._editor.getPath() || '');
  }
}
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9hZGFwdGVycy9kb2N1bWVudC1zeW5jLWFkYXB0ZXIuanMiXSwibmFtZXMiOlsiRG9jdW1lbnRTeW5jQWRhcHRlciIsImNhbkFkYXB0Iiwic2VydmVyQ2FwYWJpbGl0aWVzIiwiY2FuQWRhcHRWMiIsImNhbkFkYXB0VjMiLCJ0ZXh0RG9jdW1lbnRTeW5jIiwiSW5jcmVtZW50YWwiLCJGdWxsIiwib3B0aW9ucyIsImNoYW5nZSIsImNvbnN0cnVjdG9yIiwiY29ubmVjdGlvbiIsImRvY3VtZW50U3luY0tpbmQiLCJlZGl0b3JTZWxlY3RvciIsIl9kaXNwb3NhYmxlIiwiX2VkaXRvcnMiLCJXZWFrTWFwIiwiX3ZlcnNpb25zIiwiTWFwIiwiX2Nvbm5lY3Rpb24iLCJfZG9jdW1lbnRTeW5jS2luZCIsIl9lZGl0b3JTZWxlY3RvciIsImFkZCIsImF0b20iLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvciIsImJpbmQiLCJkaXNwb3NlIiwiZWRpdG9yIiwibGlzdGVuZXIiLCJvYnNlcnZlR3JhbW1hciIsImdyYW1tYXIiLCJfaGFuZGxlR3JhbW1hckNoYW5nZSIsIm9uRGlkRGVzdHJveSIsInJlbW92ZSIsImhhcyIsIl9oYW5kbGVOZXdFZGl0b3IiLCJzeW5jIiwiZ2V0IiwiZGVsZXRlIiwiVGV4dEVkaXRvclN5bmNBZGFwdGVyIiwic2V0IiwiZGVzdHJveWVkU3luYyIsImdldEVkaXRvclN5bmNBZGFwdGVyIiwidmVyc2lvbnMiLCJfZWRpdG9yIiwiX2Zha2VEaWRDaGFuZ2VXYXRjaGVkRmlsZXMiLCJwcm9qZWN0Iiwib25EaWRDaGFuZ2VGaWxlcyIsImNoYW5nZVRyYWNraW5nIiwic2V0dXBDaGFuZ2VUcmFja2luZyIsImdldEJ1ZmZlciIsIm9uV2lsbFNhdmUiLCJ3aWxsU2F2ZSIsIm9uRGlkU2F2ZSIsImRpZFNhdmUiLCJkaWRDbG9zZSIsIm9uRGlkQ2hhbmdlUGF0aCIsImRpZFJlbmFtZSIsIl9jdXJyZW50VXJpIiwiZ2V0RWRpdG9yVXJpIiwiZGlkT3BlbiIsIm9uRGlkQ2hhbmdlIiwic2VuZEZ1bGxDaGFuZ2VzIiwib25EaWRDaGFuZ2VUZXh0Iiwic2VuZEluY3JlbWVudGFsQ2hhbmdlcyIsImdldExhbmd1YWdlSWQiLCJnZXRHcmFtbWFyIiwibmFtZSIsImdldFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIiLCJ1cmkiLCJ2ZXJzaW9uIiwiX2dldFZlcnNpb24iLCJnZXRQYXRoIiwiX2lzUHJpbWFyeUFkYXB0ZXIiLCJfYnVtcFZlcnNpb24iLCJkaWRDaGFuZ2VUZXh0RG9jdW1lbnQiLCJ0ZXh0RG9jdW1lbnQiLCJjb250ZW50Q2hhbmdlcyIsInRleHQiLCJnZXRUZXh0IiwiZXZlbnQiLCJjaGFuZ2VzIiwibGVuZ3RoIiwibWFwIiwidGV4dEVkaXRUb0NvbnRlbnRDaGFuZ2UiLCJyZXZlcnNlIiwicmFuZ2UiLCJhdG9tUmFuZ2VUb0xTUmFuZ2UiLCJvbGRSYW5nZSIsInJhbmdlTGVuZ3RoIiwib2xkVGV4dCIsIm5ld1RleHQiLCJsb3dlc3RJZEZvckJ1ZmZlciIsIk1hdGgiLCJtaW4iLCJ3b3Jrc3BhY2UiLCJnZXRUZXh0RWRpdG9ycyIsImZpbHRlciIsInQiLCJpZCIsImZpbGVQYXRoIiwiZGlkT3BlblRleHREb2N1bWVudCIsImxhbmd1YWdlSWQiLCJ0b0xvd2VyQ2FzZSIsImZpbGVTdGlsbE9wZW4iLCJmaW5kIiwiZGlkQ2xvc2VUZXh0RG9jdW1lbnQiLCJ3aWxsU2F2ZVRleHREb2N1bWVudCIsInJlYXNvbiIsIk1hbnVhbCIsImRpZFNhdmVUZXh0RG9jdW1lbnQiLCJkaWRDaGFuZ2VXYXRjaGVkRmlsZXMiLCJ0eXBlIiwiQ2hhbmdlZCIsIm9sZFVyaSIsIkRlbGV0ZWQiLCJDcmVhdGVkIiwicGF0aFRvVXJpIl0sIm1hcHBpbmdzIjoiOzs7O0FBRUE7O0FBVUE7Ozs7QUFDQTs7OztBQUVBO0FBQ0E7QUFDQTtBQUNlLE1BQU1BLG1CQUFOLENBQTBCOztBQVF2QztBQUNBO0FBQ0E7QUFDQTtB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QUwsQ0FBYTRCLE9BQWIsTUFBMEIsRUFBNUMsQ0FBUDtBQUNEO0FBaE95QiIsImZpbGUiOiJkb2N1bWVudC1zeW5jLWFkYXB0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xyXG5cclxuaW1wb3J0IHtcclxuICBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgRmlsZUNoYW5nZVR5cGUsXHJcbiAgVGV4dERvY3VtZW50U2F2ZVJlYXNvbixcclxuICBUZXh0RG9jdW1lbnRTeW5jS2luZCxcclxuICBUZXh0RG9jdW1lbnRTeW5jT3B0aW9ucyxcclxuICB0eXBlIFRleHREb2N1bWVudENvbnRlbnRDaGFuZ2VFdmVudCxcclxuICB0eXBlIFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIsXHJcbiAgdHlwZSBTZXJ2ZXJDYXBhYmlsaXRpZXMsXHJcbn0gZnJvbSAnLi4vbGFuZ3VhZ2VjbGllbnQnO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuLi9jb252ZXJ0JztcclxuaW1wb3J0IHtDb21wb3NpdGVEaXNwb3NhYmxlfSBmcm9tICdhdG9tJztcclxuXHJcbi8vIFB1YmxpYzogU3luY2hyb25pemVzIHRoZSBkb2N1bWVudHMgYmV0d2VlbiBBdG9tIGFuZCB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGJ5IG5vdGlmeWluZ1xyXG4vLyBlYWNoIGVuZCBvZiBjaGFuZ2VzLCBvcGVuaW5nLCBjbG9zaW5nIGFuZCBvdGhlciBldmVudHMgYXMgd2VsbCBhcyBzZW5kaW5nIGFuZCBhcHBseWluZ1xyXG4vLyBjaGFuZ2VzIGVpdGhlciBpbiB3aG9sZSBvciBpbiBwYXJ0IGRlcGVuZGluZyBvbiB3aGF0IHRoZSBsYW5ndWFnZSBzZXJ2ZXIgc3VwcG9ydHMuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIERvY3VtZW50U3luY0FkYXB0ZXIge1xyXG4gIF9lZGl0b3JTZWxlY3RvcjogYXRvbSRUZXh0RWRpdG9yID0+IGJvb2xlYW47XHJcbiAgX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gIF9kb2N1bWVudFN5bmNLaW5kOiBudW1iZXI7XHJcbiAgX2VkaXRvcnM6IFdlYWtNYXA8YXRvbSRUZXh0RWRpdG9yLCBUZXh0RWRpdG9yU3luY0FkYXB0ZXI+ID0gbmV3IFdlYWtNYXAoKTtcclxuICBfY29ubmVjdGlvbjogTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uO1xyXG4gIF92ZXJzaW9uczogTWFwPHN0cmluZywgbnVtYmVyPiA9IG5ldyBNYXAoKTtcclxuXHJcbiAgLy8gUHVibGljOiBEZXRlcm1pbmUgd2hldGhlciB0aGlzIGFkYXB0ZXIgY2FuIGJlIHVzZWQgdG8gYWRhcHQgYSBsYW5ndWFnZSBzZXJ2ZXJcclxuICAvLyBiYXNlZCBvbiB0aGUgc2VydmVyQ2FwYWJpbGl0aWVzIG1hdHJpeCB0ZXh0RG9jdW1lbnRTeW5jIGNhcGFiaWxpdHkgZWl0aGVyIGJlaW5nIEZ1bGwgb3JcclxuICAvLyBJbmNyZW1lbnRhbC5cclxuICAvL1xyXG4gIC8vICogYHNlcnZlckNhcGFiaWxpdGllc2AgVGhlIHtTZXJ2ZXJDYXBhYmlsaXRpZXN9IG9mIHRoZSBsYW5ndWFnZSBzZXJ2ZXIgdG8gY29uc2lkZXIuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEge0Jvb2xlYW59IGluZGljYXRpbmcgYWRhcHRlciBjYW4gYWRhcHQgdGhlIHNlcnZlciBiYXNlZCBvbiB0aGVcclxuICAvLyBnaXZlbiBzZXJ2ZXJDYXBhYmlsaXRpZXMuXHJcbiAgc3RhdGljIGNhbkFkYXB0KHNlcnZlckNhcGFiaWxpdGllczogU2VydmVyQ2FwYWJpbGl0aWVzKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5jYW5BZGFwdFYyKHNlcnZlckNhcGFiaWxpdGllcykgfHwgdGhpcy5jYW5BZGFwdFYzKHNlcnZlckNhcGFiaWxpdGllcyk7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgY2FuQWRhcHRWMihzZXJ2ZXJDYXBhYmlsaXRpZXM6IFNlcnZlckNhcGFiaWxpdGllcyk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgc2VydmVyQ2FwYWJpbGl0aWVzLnRleHREb2N1bWVudFN5bmMgPT09IFRleHREb2N1bWVudFN5bmNLaW5kLkluY3JlbWVudGFsIHx8XHJcbiAgICAgIHNlcnZlckNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jID09PSBUZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGNhbkFkYXB0VjMoc2VydmVyQ2FwYWJpbGl0aWVzOiBTZXJ2ZXJDYXBhYmlsaXRpZXMpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSBzZXJ2ZXJDYXBhYmlsaXRpZXMudGV4dERvY3VtZW50U3luYztcclxuICAgIHJldHVybiAoXHJcbiAgICAgIG9wdGlvbnMgIT09IG51bGwgJiZcclxuICAgICAgdHlwZW9mIG9wdGlvbnMgPT09ICdvYmplY3QnICYmXHJcbiAgICAgIChvcHRpb25zLmNoYW5nZSA9PT0gVGV4dERvY3VtZW50U3luY0tpbmQuSW5jcmVtZW50YWwgfHwgb3B0aW9ucy5jaGFuZ2UgPT09IFRleHREb2N1bWVudFN5bmNLaW5kLkZ1bGwpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBDcmVhdGUgYSBuZXcge0RvY3VtZW50U3luY0FkYXB0ZXJ9IGZvciB0aGUgZ2l2ZW4gbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIC8vXHJcbiAgLy8gKiBgY29ubmVjdGlvbmAgQSB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9ufSB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyIHRvIGJlIGtlcHQgaW4gc3luYy5cclxuICAvLyAqIGBkb2N1bWVudFN5bmNLaW5kYCBUaGUgdHlwZSBvZiBkb2N1bWVudCBzeW5jaW5nIHN1cHBvcnRlZCAtIEZ1bGwgb3IgSW5jcmVtZW50YWwuXHJcbiAgLy8gKiBgZWRpdG9yU2VsZWN0b3JgIEEgcHJlZGljYXRlIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYSB7VGV4dEVkaXRvcn0gYW5kIHJldHVybnMgYSB7Ym9vbGVhbn1cclxuICAvLyAgICAgICAgICAgICAgICAgICAgaW5kaWNhdGluZyB3aGV0aGVyIHRoaXMgYWRhcHRlciBzaG91bGQgY2FyZSBhYm91dCB0aGUgY29udGVudHMgb2YgdGhlIGVkaXRvci5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIGNvbm5lY3Rpb246IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbixcclxuICAgIGRvY3VtZW50U3luY0tpbmQ6ID8oVGV4dERvY3VtZW50U3luY09wdGlvbnMgfCBudW1iZXIpLFxyXG4gICAgZWRpdG9yU2VsZWN0b3I6IGF0b20kVGV4dEVkaXRvciA9PiBib29sZWFuLFxyXG4gICkge1xyXG4gICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247XHJcbiAgICBpZiAodHlwZW9mIGRvY3VtZW50U3luY0tpbmQgPT09ICdudW1iZXInKSB7XHJcbiAgICAgIHRoaXMuX2RvY3VtZW50U3luY0tpbmQgPSBkb2N1bWVudFN5bmNLaW5kO1xyXG4gICAgfSBlbHNlIGlmIChkb2N1bWVudFN5bmNLaW5kICE9IG51bGwgJiYgZG9jdW1lbnRTeW5jS2luZC5jaGFuZ2UgIT0gbnVsbCkge1xyXG4gICAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gZG9jdW1lbnRTeW5jS2luZC5jaGFuZ2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLl9kb2N1bWVudFN5bmNLaW5kID0gVGV4dERvY3VtZW50U3luY0tpbmQuRnVsbDtcclxuICAgIH1cclxuICAgIHRoaXMuX2VkaXRvclNlbGVjdG9yID0gZWRpdG9yU2VsZWN0b3I7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChhdG9tLnRleHRFZGl0b3JzLm9ic2VydmUodGhpcy5vYnNlcnZlVGV4dEVkaXRvci5iaW5kKHRoaXMpKSk7XHJcbiAgfVxyXG5cclxuICAvLyBEaXNwb3NlIHRoaXMgYWRhcHRlciBlbnN1cmluZyBhbnkgcmVzb3VyY2VzIGFyZSBmcmVlZCBhbmQgZXZlbnRzIHVuaG9va2VkLlxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8vIEV4YW1pbmUgYSB7VGV4dEVkaXRvcn0gYW5kIGRlY2lkZSBpZiB3ZSB3aXNoIHRvIG9ic2VydmUgaXQuIElmIHNvIGVuc3VyZSB0aGF0IHdlIHN0b3Agb2JzZXJ2aW5nIGl0XHJcbiAgLy8gd2hlbiBpdCBpcyBjbG9zZWQgb3Igb3RoZXJ3aXNlIGRlc3Ryb3llZC5cclxuICAvL1xyXG4gIC8vICogYGVkaXRvcmAgQSB7VGV4dEVkaXRvcn0gdG8gY29uc2lkZXIgZm9yIG9ic2VydmF0aW9uLlxyXG4gIG9ic2VydmVUZXh0RWRpdG9yKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogdm9pZCB7XHJcbiAgICBjb25zdCBsaXN0ZW5lciA9IGVkaXRvci5vYnNlcnZlR3JhbW1hcihncmFtbWFyID0+IHRoaXMuX2hhbmRsZUdyYW1tYXJDaGFuZ2UoZWRpdG9yKSk7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChcclxuICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5yZW1vdmUobGlzdGVuZXIpO1xyXG4gICAgICAgIGxpc3RlbmVyLmRpc3Bvc2UoKTtcclxuICAgICAgfSksXHJcbiAgICApO1xyXG4gICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQobGlzdGVuZXIpO1xyXG4gICAgaWYgKCF0aGlzLl9lZGl0b3JzLmhhcyhlZGl0b3IpICYmIHRoaXMuX2VkaXRvclNlbGVjdG9yKGVkaXRvcikpIHtcclxuICAgICAgdGhpcy5faGFuZGxlTmV3RWRpdG9yKGVkaXRvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfaGFuZGxlR3JhbW1hckNoYW5nZShlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IHZvaWQge1xyXG4gICAgY29uc3Qgc3luYyA9IHRoaXMuX2VkaXRvcnMuZ2V0KGVkaXRvcik7XHJcbiAgICBpZiAoc3luYyAhPSBudWxsICYmICF0aGlzLl9lZGl0b3JTZWxlY3RvcihlZGl0b3IpKSB7XHJcbiAgICAgIHRoaXMuX2VkaXRvcnMuZGVsZXRlKGVkaXRvcik7XHJcbiAgICAgIHRoaXMuX2Rpc3Bvc2FibGUucmVtb3ZlKHN5bmMpO1xyXG4gICAgICBzeW5jLmRpc3Bvc2UoKTtcclxuICAgIH0gZWxzZSBpZiAoc3luYyA9PSBudWxsICYmIHRoaXMuX2VkaXRvclNlbGVjdG9yKGVkaXRvcikpIHtcclxuICAgICAgdGhpcy5faGFuZGxlTmV3RWRpdG9yKGVkaXRvcik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBfaGFuZGxlTmV3RWRpdG9yKGVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogdm9pZCB7XHJcbiAgICBjb25zdCBzeW5jID0gbmV3IFRleHRFZGl0b3JTeW5jQWRhcHRlcihlZGl0b3IsIHRoaXMuX2Nvbm5lY3Rpb24sIHRoaXMuX2RvY3VtZW50U3luY0tpbmQsIHRoaXMuX3ZlcnNpb25zKTtcclxuICAgIHRoaXMuX2VkaXRvcnMuc2V0KGVkaXRvciwgc3luYyk7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZChzeW5jKTtcclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICBlZGl0b3Iub25EaWREZXN0cm95KCgpID0+IHtcclxuICAgICAgICBjb25zdCBkZXN0cm95ZWRTeW5jID0gdGhpcy5fZWRpdG9ycy5nZXQoZWRpdG9yKTtcclxuICAgICAgICBpZiAoZGVzdHJveWVkU3luYykge1xyXG4gICAgICAgICAgdGhpcy5fZWRpdG9ycy5kZWxldGUoZWRpdG9yKTtcclxuICAgICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUucmVtb3ZlKGRlc3Ryb3llZFN5bmMpO1xyXG4gICAgICAgICAgZGVzdHJveWVkU3luYy5kaXNwb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBnZXRFZGl0b3JTeW5jQWRhcHRlcihlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6ID9UZXh0RWRpdG9yU3luY0FkYXB0ZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX2VkaXRvcnMuZ2V0KGVkaXRvcik7XHJcbiAgfVxyXG59XHJcblxyXG4vLyBQdWJsaWM6IEtlZXAgYSBzaW5nbGUge1RleHRFZGl0b3J9IGluIHN5bmMgd2l0aCBhIGdpdmVuIGxhbmd1YWdlIHNlcnZlci5cclxuY2xhc3MgVGV4dEVkaXRvclN5bmNBZGFwdGVyIHtcclxuICBfZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XHJcbiAgX2VkaXRvcjogYXRvbSRUZXh0RWRpdG9yO1xyXG4gIF9jdXJyZW50VXJpOiBzdHJpbmc7XHJcbiAgX2Nvbm5lY3Rpb246IExhbmd1YWdlQ2xpZW50Q29ubmVjdGlvbjtcclxuICBfZmFrZURpZENoYW5nZVdhdGNoZWRGaWxlczogYm9vbGVhbjtcclxuICBfdmVyc2lvbnM6IE1hcDxzdHJpbmcsIG51bWJlcj47XHJcblxyXG4gIC8vIFB1YmxpYzogQ3JlYXRlIGEge1RleHRFZGl0b3JTeW5jQWRhcHRlcn0gaW4gc3luYyB3aXRoIGEgZ2l2ZW4gbGFuZ3VhZ2Ugc2VydmVyLlxyXG4gIC8vXHJcbiAgLy8gKiBgZWRpdG9yYCBBIHtUZXh0RWRpdG9yfSB0byBrZWVwIGluIHN5bmMuXHJcbiAgLy8gKiBgY29ubmVjdGlvbmAgQSB7TGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9ufSB0byBhIGxhbmd1YWdlIHNlcnZlciB0byBrZWVwIGluIHN5bmMuXHJcbiAgLy8gKiBgZG9jdW1lbnRTeW5jS2luZGAgV2hldGhlciB0byB1c2UgRnVsbCAoMSkgb3IgSW5jcmVtZW50YWwgKDIpIHdoZW4gc2VuZGluZyBjaGFuZ2VzLlxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgZWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXHJcbiAgICBjb25uZWN0aW9uOiBMYW5ndWFnZUNsaWVudENvbm5lY3Rpb24sXHJcbiAgICBkb2N1bWVudFN5bmNLaW5kOiBudW1iZXIsXHJcbiAgICB2ZXJzaW9uczogTWFwPHN0cmluZywgbnVtYmVyPixcclxuICApIHtcclxuICAgIHRoaXMuX2VkaXRvciA9IGVkaXRvcjtcclxuICAgIHRoaXMuX2Nvbm5lY3Rpb24gPSBjb25uZWN0aW9uO1xyXG4gICAgdGhpcy5fdmVyc2lvbnMgPSB2ZXJzaW9ucztcclxuICAgIHRoaXMuX2Zha2VEaWRDaGFuZ2VXYXRjaGVkRmlsZXMgPSBhdG9tLnByb2plY3Qub25EaWRDaGFuZ2VGaWxlcyA9PSBudWxsO1xyXG5cclxuICAgIGNvbnN0IGNoYW5nZVRyYWNraW5nID0gdGhpcy5zZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQpO1xyXG4gICAgaWYgKGNoYW5nZVRyYWNraW5nICE9IG51bGwpIHtcclxuICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoY2hhbmdlVHJhY2tpbmcpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICBlZGl0b3IuZ2V0QnVmZmVyKCkub25XaWxsU2F2ZSh0aGlzLndpbGxTYXZlLmJpbmQodGhpcykpLFxyXG4gICAgICBlZGl0b3Iub25EaWRTYXZlKHRoaXMuZGlkU2F2ZS5iaW5kKHRoaXMpKSxcclxuICAgICAgZWRpdG9yLm9uRGlkRGVzdHJveSh0aGlzLmRpZENsb3NlLmJpbmQodGhpcykpLFxyXG4gICAgICBlZGl0b3Iub25EaWRDaGFuZ2VQYXRoKHRoaXMuZGlkUmVuYW1lLmJpbmQodGhpcykpLFxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLl9jdXJyZW50VXJpID0gdGhpcy5nZXRFZGl0b3JVcmkoKTtcclxuICAgIHRoaXMuZGlkT3BlbigpO1xyXG4gIH1cclxuXHJcbiAgLy8gVGhlIGNoYW5nZSB0cmFja2luZyBkaXNwb3NhYmxlIGxpc3RlbmVyIHRoYXQgd2lsbCBlbnN1cmUgdGhhdCBjaGFuZ2VzIGFyZSBzZW50IHRvIHRoZVxyXG4gIC8vIGxhbmd1YWdlIHNlcnZlciBhcyBhcHByb3ByaWF0ZS5cclxuICBzZXR1cENoYW5nZVRyYWNraW5nKGRvY3VtZW50U3luY0tpbmQ6IG51bWJlcik6ID9JRGlzcG9zYWJsZSB7XHJcbiAgICBzd2l0Y2ggKGRvY3VtZW50U3luY0tpbmQpIHtcclxuICAgICAgY2FzZSBUZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsOlxyXG4gICAgICAgIHJldHVybiB0aGlzLl9lZGl0b3Iub25EaWRDaGFuZ2UodGhpcy5zZW5kRnVsbENoYW5nZXMuYmluZCh0aGlzKSk7XHJcbiAgICAgIGNhc2UgVGV4dERvY3VtZW50U3luY0tpbmQuSW5jcmVtZW50YWw6XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2VkaXRvci5nZXRCdWZmZXIoKS5vbkRpZENoYW5nZVRleHQodGhpcy5zZW5kSW5jcmVtZW50YWxDaGFuZ2VzLmJpbmQodGhpcykpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfVxyXG5cclxuICAvLyBEaXNwb3NlIHRoaXMgYWRhcHRlciBlbnN1cmluZyBhbnkgcmVzb3VyY2VzIGFyZSBmcmVlZCBhbmQgZXZlbnRzIHVuaG9va2VkLlxyXG4gIGRpc3Bvc2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIC8vIEdldCB0aGUgbGFuZ3VhZ2VJZCBmaWVsZCB0aGF0IHdpbGwgYmUgc2VudCB0byB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGJ5IHNpbXBseVxyXG4gIC8vIHVzaW5nIHRoZSBncmFtbWFyIG5hbWUuXHJcbiAgZ2V0TGFuZ3VhZ2VJZCgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMuX2VkaXRvci5nZXRHcmFtbWFyKCkubmFtZTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ3JlYXRlIGEge1ZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXJ9IGZvciB0aGUgZG9jdW1lbnQgb2JzZXJ2ZWQgYnlcclxuICAvLyB0aGlzIGFkYXB0ZXIgaW5jbHVkaW5nIGJvdGggdGhlIFVyaSBhbmQgdGhlIGN1cnJlbnQgVmVyc2lvbi5cclxuICBnZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCk6IFZlcnNpb25lZFRleHREb2N1bWVudElkZW50aWZpZXIge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdXJpOiB0aGlzLmdldEVkaXRvclVyaSgpLFxyXG4gICAgICB2ZXJzaW9uOiB0aGlzLl9nZXRWZXJzaW9uKHRoaXMuX2VkaXRvci5nZXRQYXRoKCkgfHwgJycpLFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogU2VuZCB0aGUgZW50aXJlIGRvY3VtZW50IHRvIHRoZSBsYW5ndWFnZSBzZXJ2ZXIuIFRoaXMgaXMgdXNlZCB3aGVuXHJcbiAgLy8gb3BlcmF0aW5nIGluIEZ1bGwgKDEpIHN5bmMgbW9kZS5cclxuICBzZW5kRnVsbENoYW5nZXMoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuX2lzUHJpbWFyeUFkYXB0ZXIoKSkgeyByZXR1cm47IH0gLy8gTXVsdGlwbGUgZWRpdG9ycywgd2UgYXJlIG5vdCBmaXJzdFxyXG5cclxuICAgIHRoaXMuX2J1bXBWZXJzaW9uKCk7XHJcbiAgICB0aGlzLl9jb25uZWN0aW9uLmRpZENoYW5nZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgIGNvbnRlbnRDaGFuZ2VzOiBbe3RleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KCl9XSxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gUHVibGljOiBTZW5kIHRoZSBpbmNyZW1lbnRhbCB0ZXh0IGNoYW5nZXMgdG8gdGhlIGxhbmd1YWdlIHNlcnZlci4gVGhpcyBpcyB1c2VkXHJcbiAgLy8gd2hlbiBvcGVyYXRpbmcgaW4gSW5jcmVtZW50YWwgKDIpIHN5bmMgbW9kZS5cclxuICAvL1xyXG4gIC8vICogYGV2ZW50YCBUaGUgZXZlbnQgZmlyZWQgYnkgQXRvbSB0byBpbmRpY2F0ZSB0aGUgZG9jdW1lbnQgaGFzIHN0b3BwZWQgY2hhbmdpbmdcclxuICAvLyAgICAgICAgICAgaW5jbHVkaW5nIGEgbGlzdCBvZiBjaGFuZ2VzIHNpbmNlIHRoZSBsYXN0IHRpbWUgdGhpcyBldmVudCBmaXJlZCBmb3IgdGhpc1xyXG4gIC8vICAgICAgICAgICB0ZXh0IGVkaXRvci5cclxuICAvLyBOb3RlOiBUaGUgb3JkZXIgb2YgY2hhbmdlcyBpbiB0aGUgZXZlbnQgaXMgZ3VhcmFudGVlZCB0b3AgdG8gYm90dG9tLiAgTGFuZ3VhZ2Ugc2VydmVyXHJcbiAgLy8gZXhwZWN0cyB0aGlzIGluIHJldmVyc2UuXHJcbiAgc2VuZEluY3JlbWVudGFsQ2hhbmdlcyhldmVudDogYXRvbSREaWRTdG9wQ2hhbmdpbmdFdmVudCk6IHZvaWQge1xyXG4gICAgaWYgKGV2ZW50LmNoYW5nZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICBpZiAoIXRoaXMuX2lzUHJpbWFyeUFkYXB0ZXIoKSkgeyByZXR1cm47IH0gLy8gTXVsdGlwbGUgZWRpdG9ycywgd2UgYXJlIG5vdCBmaXJzdFxyXG5cclxuICAgICAgdGhpcy5fYnVtcFZlcnNpb24oKTtcclxuICAgICAgdGhpcy5fY29ubmVjdGlvbi5kaWRDaGFuZ2VUZXh0RG9jdW1lbnQoe1xyXG4gICAgICAgIHRleHREb2N1bWVudDogdGhpcy5nZXRWZXJzaW9uZWRUZXh0RG9jdW1lbnRJZGVudGlmaWVyKCksXHJcbiAgICAgICAgY29udGVudENoYW5nZXM6IGV2ZW50LmNoYW5nZXMubWFwKFRleHRFZGl0b3JTeW5jQWRhcHRlci50ZXh0RWRpdFRvQ29udGVudENoYW5nZSkucmV2ZXJzZSgpLFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIFB1YmxpYzogQ29udmVydCBhbiBBdG9tIHtUZXh0RWRpdEV2ZW50fSB0byBhIGxhbmd1YWdlIHNlcnZlciB7VGV4dERvY3VtZW50Q29udGVudENoYW5nZUV2ZW50fVxyXG4gIC8vIG9iamVjdC5cclxuICAvL1xyXG4gIC8vICogYGNoYW5nZWAgVGhlIEF0b20ge1RleHRFZGl0RXZlbnR9IHRvIGNvbnZlcnQuXHJcbiAgLy9cclxuICAvLyBSZXR1cm5zIGEge1RleHREb2N1bWVudENvbnRlbnRDaGFuZ2VFdmVudH0gdGhhdCByZXByZXNlbnRzIHRoZSBjb252ZXJ0ZWQge1RleHRFZGl0RXZlbnR9LlxyXG4gIHN0YXRpYyB0ZXh0RWRpdFRvQ29udGVudENoYW5nZShjaGFuZ2U6IGF0b20kVGV4dEVkaXRFdmVudCk6IFRleHREb2N1bWVudENvbnRlbnRDaGFuZ2VFdmVudCB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICByYW5nZTogQ29udmVydC5hdG9tUmFuZ2VUb0xTUmFuZ2UoY2hhbmdlLm9sZFJhbmdlKSxcclxuICAgICAgcmFuZ2VMZW5ndGg6IGNoYW5nZS5vbGRUZXh0Lmxlbmd0aCxcclxuICAgICAgdGV4dDogY2hhbmdlLm5ld1RleHQsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgX2lzUHJpbWFyeUFkYXB0ZXIoKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBsb3dlc3RJZEZvckJ1ZmZlciA9IE1hdGgubWluKFxyXG4gICAgICAuLi5hdG9tLndvcmtzcGFjZVxyXG4gICAgICAgIC5nZXRUZXh0RWRpdG9ycygpXHJcbiAgICAgICAgLmZpbHRlcih0ID0+IHQuZ2V0QnVmZmVyKCkgPT09IHRoaXMuX2VkaXRvci5nZXRCdWZmZXIoKSlcclxuICAgICAgICAubWFwKHQgPT4gdC5pZCksXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIGxvd2VzdElkRm9yQnVmZmVyID09PSB0aGlzLl9lZGl0b3IuaWQ7XHJcbiAgfVxyXG5cclxuICBfYnVtcFZlcnNpb24oKTogdm9pZCB7XHJcbiAgICBjb25zdCBmaWxlUGF0aCA9IHRoaXMuX2VkaXRvci5nZXRQYXRoKCk7XHJcbiAgICBpZiAoZmlsZVBhdGggPT0gbnVsbCkgeyByZXR1cm47IH1cclxuICAgIHRoaXMuX3ZlcnNpb25zLnNldChmaWxlUGF0aCwgdGhpcy5fZ2V0VmVyc2lvbihmaWxlUGF0aCkgKyAxKTtcclxuICB9XHJcblxyXG4gIC8vIEVuc3VyZSB3aGVuIHRoZSBkb2N1bWVudCBpcyBvcGVuZWQgd2Ugc2VuZCBub3RpZmljYXRpb24gdG8gdGhlIGxhbmd1YWdlIHNlcnZlclxyXG4gIC8vIHNvIGl0IGNhbiBsb2FkIGl0IGluIGFuZCBrZWVwIHRyYWNrIG9mIGRpYWdub3N0aWNzIGV0Yy5cclxuICBkaWRPcGVuKCk6IHZvaWQge1xyXG4gICAgY29uc3QgZmlsZVBhdGggPSB0aGlzLl9lZGl0b3IuZ2V0UGF0aCgpO1xyXG4gICAgaWYgKGZpbGVQYXRoID09IG51bGwpIHsgcmV0dXJuOyB9IC8vIE5vdCB5ZXQgc2F2ZWRcclxuXHJcbiAgICBpZiAoIXRoaXMuX2lzUHJpbWFyeUFkYXB0ZXIoKSkgeyByZXR1cm47IH0gLy8gTXVsdGlwbGUgZWRpdG9ycywgd2UgYXJlIG5vdCBmaXJzdFxyXG5cclxuICAgIHRoaXMuX2Nvbm5lY3Rpb24uZGlkT3BlblRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDoge1xyXG4gICAgICAgIHVyaTogdGhpcy5nZXRFZGl0b3JVcmkoKSxcclxuICAgICAgICBsYW5ndWFnZUlkOiB0aGlzLmdldExhbmd1YWdlSWQoKS50b0xvd2VyQ2FzZSgpLFxyXG4gICAgICAgIHZlcnNpb246IHRoaXMuX2dldFZlcnNpb24oZmlsZVBhdGgpLFxyXG4gICAgICAgIHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KCksXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIF9nZXRWZXJzaW9uKGZpbGVQYXRoOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMuX3ZlcnNpb25zLmdldChmaWxlUGF0aCkgfHwgMTtcclxuICB9XHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIHRoZSB7VGV4dEVkaXRvcn0gaXMgY2xvc2VkIGFuZCBzZW5kcyB0aGUgJ2RpZENsb3NlVGV4dERvY3VtZW50JyBub3RpZmljYXRpb24gdG9cclxuICAvLyB0aGUgY29ubmVjdGVkIGxhbmd1YWdlIHNlcnZlci5cclxuICBkaWRDbG9zZSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLl9lZGl0b3IuZ2V0UGF0aCgpID09IG51bGwpIHsgcmV0dXJuOyB9IC8vIE5vdCB5ZXQgc2F2ZWRcclxuXHJcbiAgICBjb25zdCBmaWxlU3RpbGxPcGVuID0gYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKS5maW5kKHQgPT4gdC5nZXRCdWZmZXIoKSA9PT0gdGhpcy5fZWRpdG9yLmdldEJ1ZmZlcigpKTtcclxuICAgIGlmIChmaWxlU3RpbGxPcGVuKSB7XHJcbiAgICAgIHJldHVybjsgLy8gT3RoZXIgd2luZG93cyBvciBlZGl0b3JzIHN0aWxsIGhhdmUgdGhpcyBmaWxlIG9wZW5cclxuICAgIH1cclxuXHJcbiAgICB0aGlzLl9jb25uZWN0aW9uLmRpZENsb3NlVGV4dERvY3VtZW50KHt0ZXh0RG9jdW1lbnQ6IHt1cmk6IHRoaXMuZ2V0RWRpdG9yVXJpKCl9fSk7XHJcbiAgfVxyXG5cclxuICAvLyBDYWxsZWQganVzdCBiZWZvcmUgdGhlIHtUZXh0RWRpdG9yfSBzYXZlcyBhbmQgc2VuZHMgdGhlICd3aWxsU2F2ZVRleHREb2N1bWVudCcgbm90aWZpY2F0aW9uIHRvXHJcbiAgLy8gdGhlIGNvbm5lY3RlZCBsYW5ndWFnZSBzZXJ2ZXIuXHJcbiAgd2lsbFNhdmUoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuX2lzUHJpbWFyeUFkYXB0ZXIoKSkgeyByZXR1cm47IH1cclxuXHJcbiAgICBjb25zdCB1cmkgPSB0aGlzLmdldEVkaXRvclVyaSgpO1xyXG4gICAgdGhpcy5fY29ubmVjdGlvbi53aWxsU2F2ZVRleHREb2N1bWVudCh7XHJcbiAgICAgIHRleHREb2N1bWVudDoge3VyaX0sXHJcbiAgICAgIHJlYXNvbjogVGV4dERvY3VtZW50U2F2ZVJlYXNvbi5NYW51YWwsXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIHRoZSB7VGV4dEVkaXRvcn0gc2F2ZXMgYW5kIHNlbmRzIHRoZSAnZGlkU2F2ZVRleHREb2N1bWVudCcgbm90aWZpY2F0aW9uIHRvXHJcbiAgLy8gdGhlIGNvbm5lY3RlZCBsYW5ndWFnZSBzZXJ2ZXIuXHJcbiAgLy8gTm90ZTogUmlnaHQgbm93IHRoaXMgYWxzbyBzZW5kcyB0aGUgYGRpZENoYW5nZVdhdGNoZWRGaWxlc2Agbm90aWZpY2F0aW9uIGFzIHdlbGwgYnV0IHRoYXRcclxuICAvLyB3aWxsIGJlIHNlbnQgZnJvbSBlbHNld2hlcmUgc29vbi5cclxuICBkaWRTYXZlKCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLl9pc1ByaW1hcnlBZGFwdGVyKCkpIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgY29uc3QgdXJpID0gdGhpcy5nZXRFZGl0b3JVcmkoKTtcclxuICAgIHRoaXMuX2Nvbm5lY3Rpb24uZGlkU2F2ZVRleHREb2N1bWVudCh7dGV4dERvY3VtZW50OiB7dXJpfX0pO1xyXG4gICAgaWYgKHRoaXMuX2Zha2VEaWRDaGFuZ2VXYXRjaGVkRmlsZXMpIHtcclxuICAgICAgdGhpcy5fY29ubmVjdGlvbi5kaWRDaGFuZ2VXYXRjaGVkRmlsZXMoe1xyXG4gICAgICAgIGNoYW5nZXM6IFt7dXJpLCB0eXBlOiBGaWxlQ2hhbmdlVHlwZS5DaGFuZ2VkfV0sXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZGlkUmVuYW1lKCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLl9pc1ByaW1hcnlBZGFwdGVyKCkpIHsgcmV0dXJuOyB9XHJcblxyXG4gICAgY29uc3Qgb2xkVXJpID0gdGhpcy5fY3VycmVudFVyaTtcclxuICAgIHRoaXMuX2N1cnJlbnRVcmkgPSB0aGlzLmdldEVkaXRvclVyaSgpO1xyXG4gICAgaWYgKCFvbGRVcmkpIHtcclxuICAgICAgcmV0dXJuOyAvLyBEaWRuJ3QgcHJldmlvdXNseSBoYXZlIGEgbmFtZVxyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2Nvbm5lY3Rpb24uZGlkQ2xvc2VUZXh0RG9jdW1lbnQoe1xyXG4gICAgICB0ZXh0RG9jdW1lbnQ6IHt1cmk6IG9sZFVyaX0sXHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAodGhpcy5fZmFrZURpZENoYW5nZVdhdGNoZWRGaWxlcykge1xyXG4gICAgICB0aGlzLl9jb25uZWN0aW9uLmRpZENoYW5nZVdhdGNoZWRGaWxlcyh7XHJcbiAgICAgICAgY2hhbmdlczogW3t1cmk6IG9sZFVyaSwgdHlwZTogRmlsZUNoYW5nZVR5cGUuRGVsZXRlZH0sIHt1cmk6IHRoaXMuX2N1cnJlbnRVcmksIHR5cGU6IEZpbGVDaGFuZ2VUeXBlLkNyZWF0ZWR9XSxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gU2VuZCBhbiBlcXVpdmFsZW50IG9wZW4gZXZlbnQgZm9yIHRoaXMgZWRpdG9yLCB3aGljaCB3aWxsIG5vdyB1c2UgdGhlIG5ld1xyXG4gICAgLy8gZmlsZSBwYXRoLlxyXG4gICAgdGhpcy5kaWRPcGVuKCk7XHJcbiAgfVxyXG5cclxuICAvLyBQdWJsaWM6IE9idGFpbiB0aGUgY3VycmVudCB7VGV4dEVkaXRvcn0gcGF0aCBhbmQgY29udmVydCBpdCB0byBhIFVyaS5cclxuICBnZXRFZGl0b3JVcmkoKTogc3RyaW5nIHtcclxuICAgIHJldHVybiBDb252ZXJ0LnBhdGhUb1VyaSh0aGlzLl9lZGl0b3IuZ2V0UGF0aCgpIHx8ICcnKTtcclxuICB9XHJcbn1cclxuIl19