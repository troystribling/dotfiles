Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ServerManager = undefined;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _languageclient = require('./languageclient');

var ls = _interopRequireWildcard(_languageclient);

var _atom = require('atom');

require('./logger');

var _linterPushV2Adapter = require('./adapters/linter-push-v2-adapter');

var _linterPushV2Adapter2 = _interopRequireDefault(_linterPushV2Adapter);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

// Manages the language server lifecycles and their associated objects necessary
// for adapting them to Atom and Atom IDE UI.


// The necessary elements for a server that has started or is starting.
let ServerManager = exports.ServerManager = class ServerManager {

  constructor(startServer, logger, startForEditor) {
    this._activeServers = [];
    this._startingServerPromises = new Map();
    this._editorToServer = new Map();
    this._normalizedProjectPaths = [];

    this._startServer = startServer;
    this._logger = logger;
    this._startForEditor = startForEditor;
    this.updateNormalizedProjectPaths();
    this._disposable = new _atom.CompositeDisposable(atom.project.onDidChangePaths(this.projectPathsChanged.bind(this)), atom.textEditors.observe(this.observeTextEditors.bind(this)));
  }

  dispose() {
    this.stopAllServers();
    this._disposable.dispose();
  }

  observeTextEditors(editor) {
    var _this = this;

    return _asyncToGenerator(function* () {
      if (!_this._editorToServer.has(editor)) {
        const server = yield _this.getServer(editor, { shouldStart: true });
        if (server != null) {
          _this._editorToServer.set(editor, server);
          _this._disposable.add(editor.onDidDestroy(function () {
            _this._editorToServer.delete(editor);
            _this.stopUnusedServers();
          }));
        }
      }
    })();
  }

  getActiveServers() {
    return this._activeServers.splice();
  }

  getServer(textEditor, { shouldStart } = { shouldStart: false }) {
    var _this2 = this;

    return _asyncToGenerator(function* () {
      const finalProjectPath = _this2.determineProjectPath(textEditor);
      if (finalProjectPath == null) {
        // Files not yet saved have no path
        return null;
      }

      const foundActiveServer = _this2._activeServers.find(function (s) {
        return finalProjectPath == s.projectPath;
      });
      if (foundActiveServer) {
        return foundActiveServer;
      }

      const startingPromise = _this2._startingServerPromises.get(finalProjectPath);
      if (startingPromise) {
        return startingPromise;
      }

      return shouldStart && _this2._startForEditor(textEditor) ? yield _this2.startServer(finalProjectPath) : null;
    })();
  }

  startServer(projectPath) {
    var _this3 = this;

    return _asyncToGenerator(function* () {
      _this3._logger.debug(`Server starting "${projectPath}"`);
      const startingPromise = _this3._startServer(projectPath);
      _this3._startingServerPromises.set(projectPath, startingPromise);
      const startedActiveServer = yield startingPromise;
      _this3._activeServers.push(startedActiveServer);
      _this3._startingServerPromises.delete(projectPath);
      _this3._logger.debug(`Server started "${projectPath}"`);
      return startedActiveServer;
    })();
  }

  stopUnusedServers() {
    var _this4 = this;

    return _asyncToGenerator(function* () {
      const usedServers = new Set(_this4._editorToServer.values());
      const unusedServers = _this4._activeServers.filter(function (s) {
        return !usedServers.has(s);
      });
      if (unusedServers.length > 0) {
        _this4._logger.debug(`Stopping ${unusedServers.length} unused servers`);
        yield Promise.all(unusedServers.map(function (s) {
          return _this4.stopServer(s);
        }));
      }
    })();
  }

  stopAllServers() {
    var _this5 = this;

    return _asyncToGenerator(function* () {
      _this5._logger.debug("Stopping all servers");
      yield Promise.all(_this5._activeServers.map(function (s) {
        return _this5.stopServer(s);
      }));
    })();
  }

  stopServer(server) {
    var _this6 = this;

    return _asyncToGenerator(function* () {
      _this6._logger.debug(`Server stopping "${server.projectPath}"`);
      // Immediately remove the server to prevent further usage.
      // If we re-open the file after this point, we'll get a new server.
      const serverIndex = _this6._activeServers.indexOf(server);
      _this6._activeServers.splice(serverIndex, 1);
      server.disposable.dispose();
      yield server.connection.shutdown();
      server.process.kill();
      _this6._logger.debug(`Server stopped "${server.projectPath}"`);
    })();
  }

  determineProjectPath(textEditor) {
    const filePath = textEditor.getPath();
    if (filePath == null) {
      return null;
    }
    return this._normalizedProjectPaths.find(d => filePath.startsWith(d));
  }

  updateNormalizedProjectPaths() {
    this._normalizedProjectPaths = atom.project.getDirectories().map(d => this.normalizePath(d.getPath()));
  }

  normalizePath(projectPath) {
    return !projectPath.endsWith(_path2.default.sep) ? _path2.default.join(projectPath, _path2.default.sep) : projectPath;
  }

  projectPathsChanged(projectPaths) {
    const pathsSet = new Set(projectPaths.map(this.normalizePath));
    const serversToStop = this._activeServers.filter(s => !pathsSet.has(s.projectPath));
    Promise.all(serversToStop.map(s => this.stopServer(s)));
    this.updateNormalizedProjectPaths();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9zZXJ2ZXItbWFuYWdlci5qcyJdLCJuYW1lcyI6WyJscyIsIlNlcnZlck1hbmFnZXIiLCJjb25zdHJ1Y3RvciIsInN0YXJ0U2VydmVyIiwibG9nZ2VyIiwic3RhcnRGb3JFZGl0b3IiLCJfYWN0aXZlU2VydmVycyIsIl9zdGFydGluZ1NlcnZlclByb21pc2VzIiwiTWFwIiwiX2VkaXRvclRvU2VydmVyIiwiX25vcm1hbGl6ZWRQcm9qZWN0UGF0aHMiLCJfc3RhcnRTZXJ2ZXIiLCJfbG9nZ2VyIiwiX3N0YXJ0Rm9yRWRpdG9yIiwidXBkYXRlTm9ybWFsaXplZFByb2plY3RQYXRocyIsIl9kaXNwb3NhYmxlIiwiYXRvbSIsInByb2plY3QiLCJvbkRpZENoYW5nZVBhdGhzIiwicHJvamVjdFBhdGhzQ2hhbmdlZCIsImJpbmQiLCJ0ZXh0RWRpdG9ycyIsIm9ic2VydmUiLCJvYnNlcnZlVGV4dEVkaXRvcnMiLCJkaXNwb3NlIiwic3RvcEFsbFNlcnZlcnMiLCJlZGl0b3IiLCJoYXMiLCJzZXJ2ZXIiLCJnZXRTZXJ2ZXIiLCJzaG91bGRTdGFydCIsInNldCIsImFkZCIsIm9uRGlkRGVzdHJveSIsImRlbGV0ZSIsInN0b3BVbnVzZWRTZXJ2ZXJzIiwiZ2V0QWN0aXZlU2VydmVycyIsInNwbGljZSIsInRleHRFZGl0b3IiLCJmaW5hbFByb2plY3RQYXRoIiwiZGV0ZXJtaW5lUHJvamVjdFBhdGgiLCJmb3VuZEFjdGl2ZVNlcnZlciIsImZpbmQiLCJzIiwicHJvamVjdFBhdGgiLCJzdGFydGluZ1Byb21pc2UiLCJnZXQiLCJkZWJ1ZyIsInN0YXJ0ZWRBY3RpdmVTZXJ2ZXIiLCJwdXNoIiwidXNlZFNlcnZlcnMiLCJTZXQiLCJ2YWx1ZXMiLCJ1bnVzZWRTZXJ2ZXJzIiwiZmlsdGVyIiwibGVuZ3RoIiwiUHJvbWlzZSIsImFsbCIsIm1hcCIsInN0b3BTZXJ2ZXIiLCJzZXJ2ZXJJbmRleCIsImluZGV4T2YiLCJkaXNwb3NhYmxlIiwiY29ubmVjdGlvbiIsInNodXRkb3duIiwicHJvY2VzcyIsImtpbGwiLCJmaWxlUGF0aCIsImdldFBhdGgiLCJkIiwic3RhcnRzV2l0aCIsImdldERpcmVjdG9yaWVzIiwibm9ybWFsaXplUGF0aCIsImVuZHNXaXRoIiwic2VwIiwiam9pbiIsInByb2plY3RQYXRocyIsInBhdGhzU2V0Iiwic2VydmVyc1RvU3RvcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFFQTs7OztBQUNBOztJQUFZQSxFOztBQUNaOztBQUNBOztBQUNBOzs7Ozs7Ozs7O0FBWUE7QUFDQTs7O0FBWEE7SUFZYUMsYSxXQUFBQSxhLEdBQU4sTUFBTUEsYUFBTixDQUFvQjs7QUFVekJDLGNBQVlDLFdBQVosRUFBeUVDLE1BQXpFLEVBQXlGQyxjQUF6RixFQUErSTtBQUFBLFNBVC9JQyxjQVMrSSxHQVR6RyxFQVN5RztBQUFBLFNBUi9JQyx1QkFRK0ksR0FSakYsSUFBSUMsR0FBSixFQVFpRjtBQUFBLFNBTi9JQyxlQU0rSSxHQU56RixJQUFJRCxHQUFKLEVBTXlGO0FBQUEsU0FKL0lFLHVCQUkrSSxHQUp0RyxFQUlzRzs7QUFDN0ksU0FBS0MsWUFBTCxHQUFvQlIsV0FBcEI7QUFDQSxTQUFLUyxPQUFMLEdBQWVSLE1BQWY7QUFDQSxTQUFLUyxlQUFMLEdBQXVCUixjQUF2QjtBQUNBLFNBQUtTLDRCQUFMO0FBQ0EsU0FBS0MsV0FBTCxHQUFtQiw4QkFDakJDLEtBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsQ0FBOEIsS0FBS0MsbUJBQUwsQ0FBeUJDLElBQXpCLENBQThCLElBQTlCLENBQTlCLENBRGlCLEVBRWpCSixLQUFLSyxXQUFMLENBQWlCQyxPQUFqQixDQUF5QixLQUFLQyxrQkFBTCxDQUF3QkgsSUFBeEIsQ0FBNkIsSUFBN0IsQ0FBekIsQ0FGaUIsQ0FBbkI7QUFJRDs7QUFFREksWUFBZ0I7QUFDZCxTQUFLQyxjQUFMO0FBQ0EsU0FBS1YsV0FBTCxDQUFpQlMsT0FBakI7QUFDRDs7QUFFS0Qsb0JBQU4sQ0FBeUJHLE1BQXpCLEVBQWlFO0FBQUE7O0FBQUE7QUFD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cUM7QUFDbkMsU0FBS0osdUJBQUwsR0FBK0JNLEtBQUtDLE9BQUwsQ0FBYXNELGNBQWIsR0FBOEJiLEdBQTlCLENBQWtDVyxLQUFLLEtBQUtHLGFBQUwsQ0FBbUJILEVBQUVELE9BQUYsRUFBbkIsQ0FBdkMsQ0FBL0I7QUFDRDs7QUFFREksZ0JBQWM1QixXQUFkLEVBQTJDO0FBQ3pDLFdBQU8sQ0FBQ0EsWUFBWTZCLFFBQVosQ0FBcUIsZUFBS0MsR0FBMUIsQ0FBRCxHQUFrQyxlQUFLQyxJQUFMLENBQVUvQixXQUFWLEVBQXVCLGVBQUs4QixHQUE1QixDQUFsQyxHQUFxRTlCLFdBQTVFO0FBQ0Q7O0FBRUR6QixzQkFBb0J5RCxZQUFwQixFQUF1RDtBQUNyRCxVQUFNQyxXQUFXLElBQUkxQixHQUFKLENBQVF5QixhQUFhbEIsR0FBYixDQUFpQixLQUFLYyxhQUF0QixDQUFSLENBQWpCO0FBQ0EsVUFBTU0sZ0JBQWdCLEtBQUt4RSxjQUFMLENBQW9CZ0QsTUFBcEIsQ0FBMkJYLEtBQUssQ0FBQ2tDLFNBQVNsRCxHQUFULENBQWFnQixFQUFFQyxXQUFmLENBQWpDLENBQXRCO0FBQ0FZLFlBQVFDLEdBQVIsQ0FBWXFCLGNBQWNwQixHQUFkLENBQWtCZixLQUFLLEtBQUtnQixVQUFMLENBQWdCaEIsQ0FBaEIsQ0FBdkIsQ0FBWjtBQUNBLFNBQUs3Qiw0QkFBTDtBQUNEO0FBckh3QixDIiwiZmlsZSI6InNlcnZlci1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBscyBmcm9tICcuL2xhbmd1YWdlY2xpZW50JztcbmltcG9ydCB7Q29tcG9zaXRlRGlzcG9zYWJsZX0gZnJvbSAnYXRvbSc7XG5pbXBvcnQge3R5cGUgTG9nZ2VyfSBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgTGludGVyUHVzaFYyQWRhcHRlciBmcm9tICcuL2FkYXB0ZXJzL2xpbnRlci1wdXNoLXYyLWFkYXB0ZXInO1xuXG4vLyBUaGUgbmVjZXNzYXJ5IGVsZW1lbnRzIGZvciBhIHNlcnZlciB0aGF0IGhhcyBzdGFydGVkIG9yIGlzIHN0YXJ0aW5nLlxuZXhwb3J0IHR5cGUgQWN0aXZlU2VydmVyID0ge1xuICBkaXNwb3NhYmxlOiBDb21wb3NpdGVEaXNwb3NhYmxlO1xuICBwcm9qZWN0UGF0aDogc3RyaW5nO1xuICBwcm9jZXNzOiBjaGlsZF9wcm9jZXNzJENoaWxkUHJvY2VzcztcbiAgY29ubmVjdGlvbjogbHMuTGFuZ3VhZ2VDbGllbnRDb25uZWN0aW9uO1xuICBjYXBhYmlsaXRpZXM6IGxzLlNlcnZlckNhcGFiaWxpdGllcztcbiAgbGludGVyUHVzaFYyPzogTGludGVyUHVzaFYyQWRhcHRlcjtcbn1cblxuLy8gTWFuYWdlcyB0aGUgbGFuZ3VhZ2Ugc2VydmVyIGxpZmVjeWNsZXMgYW5kIHRoZWlyIGFzc29jaWF0ZWQgb2JqZWN0cyBuZWNlc3Nhcnlcbi8vIGZvciBhZGFwdGluZyB0aGVtIHRvIEF0b20gYW5kIEF0b20gSURFIFVJLlxuZXhwb3J0IGNsYXNzIFNlcnZlck1hbmFnZXIge1xuICBfYWN0aXZlU2VydmVyczogQXJyYXk8QWN0aXZlU2VydmVyPiA9IFtdO1xuICBfc3RhcnRpbmdTZXJ2ZXJQcm9taXNlczogTWFwPHN0cmluZywgUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+PiA9IG5ldyBNYXAoKTtcbiAgX2Rpc3Bvc2FibGU6IENvbXBvc2l0ZURpc3Bvc2FibGU7XG4gIF9lZGl0b3JUb1NlcnZlcjogTWFwPGF0b20kVGV4dEVkaXRvciwgQWN0aXZlU2VydmVyPiA9IG5ldyBNYXAoKTtcbiAgX2xvZ2dlcjogTG9nZ2VyO1xuICBfbm9ybWFsaXplZFByb2plY3RQYXRoczogQXJyYXk8c3RyaW5nPiA9IFtdO1xuICBfc3RhcnRGb3JFZGl0b3I6IChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikgPT4gYm9vbGVhbjtcbiAgX3N0YXJ0U2VydmVyOiAocHJvamVjdFBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+O1xuXG4gIGNvbnN0cnVjdG9yKHN0YXJ0U2VydmVyOiAocHJvamVjdFBhdGg6IHN0cmluZykgPT4gUHJvbWlzZTxBY3RpdmVTZXJ2ZXI+LCBsb2dnZXI6IExvZ2dlciwgc3RhcnRGb3JFZGl0b3I6IChlZGl0b3I6IGF0b20kVGV4dEVkaXRvcikgPT4gYm9vbGVhbikge1xuICAgIHRoaXMuX3N0YXJ0U2VydmVyID0gc3RhcnRTZXJ2ZXI7XG4gICAgdGhpcy5fbG9nZ2VyID0gbG9nZ2VyO1xuICAgIHRoaXMuX3N0YXJ0Rm9yRWRpdG9yID0gc3RhcnRGb3JFZGl0b3I7XG4gICAgdGhpcy51cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk7XG4gICAgdGhpcy5fZGlzcG9zYWJsZSA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKFxuICAgICAgYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHModGhpcy5wcm9qZWN0UGF0aHNDaGFuZ2VkLmJpbmQodGhpcykpLFxuICAgICAgYXRvbS50ZXh0RWRpdG9ycy5vYnNlcnZlKHRoaXMub2JzZXJ2ZVRleHRFZGl0b3JzLmJpbmQodGhpcykpLFxuICAgICk7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcEFsbFNlcnZlcnMoKTtcbiAgICB0aGlzLl9kaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIGFzeW5jIG9ic2VydmVUZXh0RWRpdG9ycyhlZGl0b3I6IGF0b20kVGV4dEVkaXRvcik6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuaGFzKGVkaXRvcikpIHtcbiAgICAgIGNvbnN0IHNlcnZlciA9IGF3YWl0IHRoaXMuZ2V0U2VydmVyKGVkaXRvciwge3Nob3VsZFN0YXJ0OiB0cnVlfSk7XG4gICAgICBpZiAoc2VydmVyICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuc2V0KGVkaXRvciwgc2VydmVyKTtcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5fZWRpdG9yVG9TZXJ2ZXIuZGVsZXRlKGVkaXRvcik7XG4gICAgICAgICAgdGhpcy5zdG9wVW51c2VkU2VydmVycygpO1xuICAgICAgICB9KSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZ2V0QWN0aXZlU2VydmVycygpOiBBcnJheTxBY3RpdmVTZXJ2ZXI+IHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlU2VydmVycy5zcGxpY2UoKTtcbiAgfVxuXG4gIGFzeW5jIGdldFNlcnZlcih0ZXh0RWRpdG9yOiBhdG9tJFRleHRFZGl0b3IsXG4gICAge3Nob3VsZFN0YXJ0fToge3Nob3VsZFN0YXJ0PzogYm9vbGVhbn0gPSB7c2hvdWxkU3RhcnQ6IGZhbHNlfSk6IFByb21pc2U8P0FjdGl2ZVNlcnZlcj4ge1xuICAgIGNvbnN0IGZpbmFsUHJvamVjdFBhdGggPSB0aGlzLmRldGVybWluZVByb2plY3RQYXRoKHRleHRFZGl0b3IpO1xuICAgIGlmIChmaW5hbFByb2plY3RQYXRoID09IG51bGwpIHsgLy8gRmlsZXMgbm90IHlldCBzYXZlZCBoYXZlIG5vIHBhdGhcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGZvdW5kQWN0aXZlU2VydmVyID0gdGhpcy5fYWN0aXZlU2VydmVycy5maW5kKHMgPT4gZmluYWxQcm9qZWN0UGF0aCA9PSBzLnByb2plY3RQYXRoKTtcbiAgICBpZiAoZm91bmRBY3RpdmVTZXJ2ZXIpIHsgcmV0dXJuIGZvdW5kQWN0aXZlU2VydmVyOyB9XG5cbiAgICBjb25zdCBzdGFydGluZ1Byb21pc2UgPSB0aGlzLl9zdGFydGluZ1NlcnZlclByb21pc2VzLmdldChmaW5hbFByb2plY3RQYXRoKTtcbiAgICBpZiAoc3RhcnRpbmdQcm9taXNlKSB7XG4gICAgICByZXR1cm4gc3RhcnRpbmdQcm9taXNlO1xuICAgIH1cblxuICAgIHJldHVybiBzaG91bGRTdGFydCAmJiB0aGlzLl9zdGFydEZvckVkaXRvcih0ZXh0RWRpdG9yKSA/IGF3YWl0IHRoaXMuc3RhcnRTZXJ2ZXIoZmluYWxQcm9qZWN0UGF0aCkgOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXJ2ZXIocHJvamVjdFBhdGg6IHN0cmluZyk6IFByb21pc2U8QWN0aXZlU2VydmVyPiB7XG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgc3RhcnRpbmcgXCIke3Byb2plY3RQYXRofVwiYCk7XG4gICAgY29uc3Qgc3RhcnRpbmdQcm9taXNlID0gdGhpcy5fc3RhcnRTZXJ2ZXIocHJvamVjdFBhdGgpO1xuICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuc2V0KHByb2plY3RQYXRoLCBzdGFydGluZ1Byb21pc2UpO1xuICAgIGNvbnN0IHN0YXJ0ZWRBY3RpdmVTZXJ2ZXIgPSBhd2FpdCBzdGFydGluZ1Byb21pc2U7XG4gICAgdGhpcy5fYWN0aXZlU2VydmVycy5wdXNoKHN0YXJ0ZWRBY3RpdmVTZXJ2ZXIpO1xuICAgIHRoaXMuX3N0YXJ0aW5nU2VydmVyUHJvbWlzZXMuZGVsZXRlKHByb2plY3RQYXRoKTtcbiAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFNlcnZlciBzdGFydGVkIFwiJHtwcm9qZWN0UGF0aH1cImApO1xuICAgIHJldHVybiBzdGFydGVkQWN0aXZlU2VydmVyO1xuICB9XG5cbiAgYXN5bmMgc3RvcFVudXNlZFNlcnZlcnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdXNlZFNlcnZlcnMgPSBuZXcgU2V0KHRoaXMuX2VkaXRvclRvU2VydmVyLnZhbHVlcygpKTtcbiAgICBjb25zdCB1bnVzZWRTZXJ2ZXJzID0gdGhpcy5fYWN0aXZlU2VydmVycy5maWx0ZXIocyA9PiAhdXNlZFNlcnZlcnMuaGFzKHMpKTtcbiAgICBpZiAodW51c2VkU2VydmVycy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLl9sb2dnZXIuZGVidWcoYFN0b3BwaW5nICR7dW51c2VkU2VydmVycy5sZW5ndGh9IHVudXNlZCBzZXJ2ZXJzYCk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbCh1bnVzZWRTZXJ2ZXJzLm1hcChzID0+IHRoaXMuc3RvcFNlcnZlcihzKSkpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0b3BBbGxTZXJ2ZXJzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhcIlN0b3BwaW5nIGFsbCBzZXJ2ZXJzXCIpO1xuICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMuX2FjdGl2ZVNlcnZlcnMubWFwKHMgPT4gdGhpcy5zdG9wU2VydmVyKHMpKSk7XG4gIH1cblxuICBhc3luYyBzdG9wU2VydmVyKHNlcnZlcjogQWN0aXZlU2VydmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5fbG9nZ2VyLmRlYnVnKGBTZXJ2ZXIgc3RvcHBpbmcgXCIke3NlcnZlci5wcm9qZWN0UGF0aH1cImApO1xuICAgIC8vIEltbWVkaWF0ZWx5IHJlbW92ZSB0aGUgc2VydmVyIHRvIHByZXZlbnQgZnVydGhlciB1c2FnZS5cbiAgICAvLyBJZiB3ZSByZS1vcGVuIHRoZSBmaWxlIGFmdGVyIHRoaXMgcG9pbnQsIHdlJ2xsIGdldCBhIG5ldyBzZXJ2ZXIuXG4gICAgY29uc3Qgc2VydmVySW5kZXggPSB0aGlzLl9hY3RpdmVTZXJ2ZXJzLmluZGV4T2Yoc2VydmVyKTtcbiAgICB0aGlzLl9hY3RpdmVTZXJ2ZXJzLnNwbGljZShzZXJ2ZXJJbmRleCwgMSk7XG4gICAgc2VydmVyLmRpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgIGF3YWl0IHNlcnZlci5jb25uZWN0aW9uLnNodXRkb3duKCk7XG4gICAgc2VydmVyLnByb2Nlc3Mua2lsbCgpO1xuICAgIHRoaXMuX2xvZ2dlci5kZWJ1ZyhgU2VydmVyIHN0b3BwZWQgXCIke3NlcnZlci5wcm9qZWN0UGF0aH1cImApO1xuICB9XG5cbiAgZGV0ZXJtaW5lUHJvamVjdFBhdGgodGV4dEVkaXRvcjogYXRvbSRUZXh0RWRpdG9yKTogP3N0cmluZyB7XG4gICAgY29uc3QgZmlsZVBhdGggPSB0ZXh0RWRpdG9yLmdldFBhdGgoKTtcbiAgICBpZiAoZmlsZVBhdGggPT0gbnVsbCkgeyByZXR1cm4gbnVsbDsgfVxuICAgIHJldHVybiB0aGlzLl9ub3JtYWxpemVkUHJvamVjdFBhdGhzLmZpbmQoZCA9PiBmaWxlUGF0aC5zdGFydHNXaXRoKGQpKTtcbiAgfVxuXG4gIHVwZGF0ZU5vcm1hbGl6ZWRQcm9qZWN0UGF0aHMoKTogdm9pZCB7XG4gICAgdGhpcy5fbm9ybWFsaXplZFByb2plY3RQYXRocyA9IGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLm1hcChkID0+IHRoaXMubm9ybWFsaXplUGF0aChkLmdldFBhdGgoKSkpO1xuICB9XG5cbiAgbm9ybWFsaXplUGF0aChwcm9qZWN0UGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gIXByb2plY3RQYXRoLmVuZHNXaXRoKHBhdGguc2VwKSA/IHBhdGguam9pbihwcm9qZWN0UGF0aCwgcGF0aC5zZXApIDogcHJvamVjdFBhdGg7XG4gIH1cblxuICBwcm9qZWN0UGF0aHNDaGFuZ2VkKHByb2plY3RQYXRoczogQXJyYXk8c3RyaW5nPik6IHZvaWQge1xuICAgIGNvbnN0IHBhdGhzU2V0ID0gbmV3IFNldChwcm9qZWN0UGF0aHMubWFwKHRoaXMubm9ybWFsaXplUGF0aCkpO1xuICAgIGNvbnN0IHNlcnZlcnNUb1N0b3AgPSB0aGlzLl9hY3RpdmVTZXJ2ZXJzLmZpbHRlcihzID0+ICFwYXRoc1NldC5oYXMocy5wcm9qZWN0UGF0aCkpO1xuICAgIFByb21pc2UuYWxsKHNlcnZlcnNUb1N0b3AubWFwKHMgPT4gdGhpcy5zdG9wU2VydmVyKHMpKSk7XG4gICAgdGhpcy51cGRhdGVOb3JtYWxpemVkUHJvamVjdFBhdGhzKCk7XG4gIH1cbn1cbiJdfQ==