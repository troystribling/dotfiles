var _chai = require('chai');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _sinon = require('sinon');

var _sinon2 = _interopRequireDefault(_sinon);

var _applyEditAdapter = require('../../lib/adapters/apply-edit-adapter');

var _applyEditAdapter2 = _interopRequireDefault(_applyEditAdapter);

var _convert = require('../../lib/convert');

var _convert2 = _interopRequireDefault(_convert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const TEST_PATH1 = _path2.default.join(__dirname, 'test.txt');

const TEST_PATH2 = _path2.default.join(__dirname, 'test2.txt');
const TEST_PATH3 = _path2.default.join(__dirname, 'test3.txt');
const TEST_PATH4 = _path2.default.join(__dirname, 'test4.txt');

describe('ApplyEditAdapter', () => {
  describe('onApplyEdit', () => {
    beforeEach(() => {
      _sinon2.default.spy(atom.notifications, 'addError');
    });

    afterEach(() => {
      atom.notifications.addError.restore();
    });

    it('works for open files', async () => {
      const editor = await atom.workspace.open(TEST_PATH1);
      editor.setText('abc\ndef\n');

      const result = await _applyEditAdapter2.default.onApplyEdit({
        edit: {
          changes: {
            [_convert2.default.pathToUri(TEST_PATH1)]: [{
              range: {
                start: { line: 0, character: 0 },
                end: { line: 0, character: 3 }
              },
              newText: 'def'
            }, {
              range: {
                start: { line: 1, character: 0 },
                end: { line: 1, character: 3 }
              },
              newText: 'ghi'
            }]
          }
        }
      });

      (0, _chai.expect)(result.applied).to.equal(true);
      (0, _chai.expect)(editor.getText()).to.equal('def\nghi\n');

      // Undo should be atomic.
      editor.getBuffer().undo();
      (0, _chai.expect)(editor.getText()).to.equal('abc\ndef\n');
    });

    it('works with TextDocumentEdits', async () => {
      const editor = await atom.workspace.open(TEST_PATH1);
      editor.setText('abc\ndef\n');

      const result = await _applyEditAdapter2.default.onApplyEdit({
        edit: {
          documentChanges: [{
            textDocument: {
              version: 1,
              uri: _convert2.default.pathToUri(TEST_PATH1)
            },
            edits: [{
              range: {
                start: { line: 0, character: 0 },
                end: { line: 0, character: 3 }
              },
              newText: 'def'
            }, {
              range: {
                start: { line: 1, character: 0 },
                end: { line: 1, character: 3 }
              },
              newText: 'ghi'
            }]
          }]
        }
      });

      (0, _chai.expect)(result.applied).to.equal(true);
      (0, _chai.expect)(editor.getText()).to.equal('def\nghi\n');

      // Undo should be atomic.
      editor.getBuffer().undo();
      (0, _chai.expect)(editor.getText()).to.equal('abc\ndef\n');
    });

    it('opens files that are not already open', async () => {
      const result = await _applyEditAdapter2.default.onApplyEdit({
        edit: {
          changes: {
            [TEST_PATH2]: [{
              range: {
                start: { line: 0, character: 0 },
                end: { line: 0, character: 0 }
              },
              newText: 'abc'
            }]
          }
        }
      });

      (0, _chai.expect)(result.applied).to.equal(true);
      const editor = await atom.workspace.open(TEST_PATH2);
      (0, _chai.expect)(editor.getText()).to.equal('abc');
    });

    it('fails with overlapping edits', async () => {
      const editor = await atom.workspace.open(TEST_PATH3);
      editor.setText('abcdef\n');

      const result = await _applyEditAdapter2.default.onApplyEdit({
        edit: {
          changes: {
            [TEST_PATH3]: [{
              range: {
                start: { line: 0, character: 0 },
                end: { line: 0, character: 3 }
              },
              newText: 'def'
            }, {
              range: {
                start: { line: 0, character: 2 },
                end: { line: 0, character: 4 }
              },
              newText: 'ghi'
            }]
          }
        }
      });

      (0, _chai.expect)(result.applied).to.equal(false);
      (0, _chai.expect)(atom.notifications.addError.calledWith('workspace/applyEdits failed', {
        description: 'Failed to apply edits.',
        detail: `Found overlapping edit ranges in ${TEST_PATH3}`
      })).to.equal(true);
      // No changes.
      (0, _chai.expect)(editor.getText()).to.equal('abcdef\n');
    });

    it('fails with out-of-range edits', async () => {
      const result = await _applyEditAdapter2.default.onApplyEdit({
        edit: {
          changes: {
            [TEST_PATH4]: [{
              range: {
                start: { line: 0, character: 1 },
                end: { line: 0, character: 2 }
              },
              newText: 'def'
            }]
          }
        }
      });

      (0, _chai.expect)(result.applied).to.equal(false);
      const errorCalls = atom.notifications.addError.getCalls();
      (0, _chai.expect)(errorCalls.length).to.equal(1);
      (0, _chai.expect)(errorCalls[0].args[1].detail).to.equal(`Out of range edit on ${TEST_PATH4}:1:2`);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Rlc3QvYWRhcHRlcnMvYXBwbHktZWRpdC1hZGFwdGVyLnRlc3QuanMiXSwibmFtZXMiOlsiVEVTVF9QQVRIMSIsImpvaW4iLCJfX2Rpcm5hbWUiLCJURVNUX1BBVEgyIiwiVEVTVF9QQVRIMyIsIlRFU1RfUEFUSDQiLCJkZXNjcmliZSIsImJlZm9yZUVhY2giLCJzcHkiLCJhdG9tIiwibm90aWZpY2F0aW9ucyIsImFmdGVyRWFjaCIsImFkZEVycm9yIiwicmVzdG9yZSIsIml0IiwiZWRpdG9yIiwid29ya3NwYWNlIiwib3BlbiIsInNldFRleHQiLCJyZXN1bHQiLCJvbkFwcGx5RWRpdCIsImVkaXQiLCJjaGFuZ2VzIiwicGF0aFRvVXJpIiwicmFuZ2UiLCJzdGFydCIsImxpbmUiLCJjaGFyYWN0ZXIiLCJlbmQiLCJuZXdUZXh0IiwiYXBwbGllZCIsInRvIiwiZXF1YWwiLCJnZXRUZXh0IiwiZ2V0QnVmZmVyIiwidW5kbyIsImRvY3VtZW50Q2hhbmdlcyIsInRleHREb2N1bWVudCIsInZlcnNpb24iLCJ1cmkiLCJlZGl0cyIsImNhbGxlZFdpdGgiLCJkZXNjcmlwdGlvbiIsImRldGFpbCIsImVycm9yQ2FsbHMiLCJnZXRDYWxscyIsImxlbmd0aCIsImFyZ3MiXSwibWFwcGluZ3MiOiJBQUVBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxhQUFhLGVBQUtDLElBQUwsQ0FBVUMsU0FBVixFQUFxQixVQUFyQixDQUFuQjs7QUFDQSxNQUFNQyxhQUFhLGVBQUtGLElBQUwsQ0FBVUMsU0FBVixFQUFxQixXQUFyQixDQUFuQjtBQUNBLE1BQU1FLGFBQWEsZUFBS0gsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLFdBQXJCLENBQW5CO0FBQ0EsTUFBTUcsYUFBYSxlQUFLSixJQUFMLENBQVVDLFNBQVYsRUFBcUIsV0FBckIsQ0FBbkI7O0FBRUFJLFNBQVMsa0JBQVQsRUFBNkIsTUFBTTtBQUNqQ0EsV0FBUyxhQUFULEVB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QUExQixDQUE2QkMsS0FBN0IsQ0FBbUMsQ0FBbkM7QUFDQSx3QkFBT1ksV0FBVyxDQUFYLEVBQWNHLElBQWQsQ0FBbUIsQ0FBbkIsRUFBc0JKLE1BQTdCLEVBQXFDWixFQUFyQyxDQUF3Q0MsS0FBeEMsQ0FBK0Msd0JBQXVCM0IsVUFBVyxNQUFqRjtBQUNELEtBckJEO0FBc0JELEdBcktEO0FBc0tELENBdktEIiwiZmlsZSI6ImFwcGx5LWVkaXQtYWRhcHRlci50ZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcclxuXHJcbmltcG9ydCB7ZXhwZWN0fSBmcm9tICdjaGFpJztcclxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XHJcbmltcG9ydCBzaW5vbiBmcm9tICdzaW5vbic7XHJcbmltcG9ydCBBcHBseUVkaXRBZGFwdGVyIGZyb20gJy4uLy4uL2xpYi9hZGFwdGVycy9hcHBseS1lZGl0LWFkYXB0ZXInO1xyXG5pbXBvcnQgQ29udmVydCBmcm9tICcuLi8uLi9saWIvY29udmVydCc7XHJcblxyXG5jb25zdCBURVNUX1BBVEgxID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJ3Rlc3QudHh0Jyk7XHJcbmNvbnN0IFRFU1RfUEFUSDIgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdDIudHh0Jyk7XHJcbmNvbnN0IFRFU1RfUEFUSDMgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdDMudHh0Jyk7XHJcbmNvbnN0IFRFU1RfUEFUSDQgPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAndGVzdDQudHh0Jyk7XHJcblxyXG5kZXNjcmliZSgnQXBwbHlFZGl0QWRhcHRlcicsICgpID0+IHtcclxuICBkZXNjcmliZSgnb25BcHBseUVkaXQnLCAoKSA9PiB7XHJcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcclxuICAgICAgc2lub24uc3B5KGF0b20ubm90aWZpY2F0aW9ucywgJ2FkZEVycm9yJyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBhZnRlckVhY2goKCkgPT4ge1xyXG4gICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IucmVzdG9yZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3dvcmtzIGZvciBvcGVuIGZpbGVzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKFRFU1RfUEFUSDEpO1xyXG4gICAgICBlZGl0b3Iuc2V0VGV4dCgnYWJjXFxuZGVmXFxuJyk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBBcHBseUVkaXRBZGFwdGVyLm9uQXBwbHlFZGl0KHtcclxuICAgICAgICBlZGl0OiB7XHJcbiAgICAgICAgICBjaGFuZ2VzOiB7XHJcbiAgICAgICAgICAgIFtDb252ZXJ0LnBhdGhUb1VyaShURVNUX1BBVEgxKV06IFtcclxuICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByYW5nZToge1xyXG4gICAgICAgICAgICAgICAgICBzdGFydDoge2xpbmU6IDAsIGNoYXJhY3RlcjogMH0sXHJcbiAgICAgICAgICAgICAgICAgIGVuZDoge2xpbmU6IDAsIGNoYXJhY3RlcjogM30sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbmV3VGV4dDogJ2RlZicsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByYW5nZToge1xyXG4gICAgICAgICAgICAgICAgICBzdGFydDoge2xpbmU6IDEsIGNoYXJhY3RlcjogMH0sXHJcbiAgICAgICAgICAgICAgICAgIGVuZDoge2xpbmU6IDEsIGNoYXJhY3RlcjogM30sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbmV3VGV4dDogJ2doaScsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LmFwcGxpZWQpLnRvLmVxdWFsKHRydWUpO1xyXG4gICAgICBleHBlY3QoZWRpdG9yLmdldFRleHQoKSkudG8uZXF1YWwoJ2RlZlxcbmdoaVxcbicpO1xyXG5cclxuICAgICAgLy8gVW5kbyBzaG91bGQgYmUgYXRvbWljLlxyXG4gICAgICBlZGl0b3IuZ2V0QnVmZmVyKCkudW5kbygpO1xyXG4gICAgICBleHBlY3QoZWRpdG9yLmdldFRleHQoKSkudG8uZXF1YWwoJ2FiY1xcbmRlZlxcbicpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3dvcmtzIHdpdGggVGV4dERvY3VtZW50RWRpdHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGVkaXRvciA9IGF3YWl0IGF0b20ud29ya3NwYWNlLm9wZW4oVEVTVF9QQVRIMSk7XHJcbiAgICAgIGVkaXRvci5zZXRUZXh0KCdhYmNcXG5kZWZcXG4nKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEFwcGx5RWRpdEFkYXB0ZXIub25BcHBseUVkaXQoe1xyXG4gICAgICAgIGVkaXQ6IHtcclxuICAgICAgICAgIGRvY3VtZW50Q2hhbmdlczogW3tcclxuICAgICAgICAgICAgdGV4dERvY3VtZW50OiB7XHJcbiAgICAgICAgICAgICAgdmVyc2lvbjogMSxcclxuICAgICAgICAgICAgICB1cmk6IENvbnZlcnQucGF0aFRvVXJpKFRFU1RfUEFUSDEpLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBlZGl0czogW1xyXG4gICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXJ0OiB7bGluZTogMCwgY2hhcmFjdGVyOiAwfSxcclxuICAgICAgICAgICAgICAgICAgZW5kOiB7bGluZTogMCwgY2hhcmFjdGVyOiAzfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBuZXdUZXh0OiAnZGVmJyxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXJ0OiB7bGluZTogMSwgY2hhcmFjdGVyOiAwfSxcclxuICAgICAgICAgICAgICAgICAgZW5kOiB7bGluZTogMSwgY2hhcmFjdGVyOiAzfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBuZXdUZXh0OiAnZ2hpJyxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgfV0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LmFwcGxpZWQpLnRvLmVxdWFsKHRydWUpO1xyXG4gICAgICBleHBlY3QoZWRpdG9yLmdldFRleHQoKSkudG8uZXF1YWwoJ2RlZlxcbmdoaVxcbicpO1xyXG5cclxuICAgICAgLy8gVW5kbyBzaG91bGQgYmUgYXRvbWljLlxyXG4gICAgICBlZGl0b3IuZ2V0QnVmZmVyKCkudW5kbygpO1xyXG4gICAgICBleHBlY3QoZWRpdG9yLmdldFRleHQoKSkudG8uZXF1YWwoJ2FiY1xcbmRlZlxcbicpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ29wZW5zIGZpbGVzIHRoYXQgYXJlIG5vdCBhbHJlYWR5IG9wZW4nLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IEFwcGx5RWRpdEFkYXB0ZXIub25BcHBseUVkaXQoe1xyXG4gICAgICAgIGVkaXQ6IHtcclxuICAgICAgICAgIGNoYW5nZXM6IHtcclxuICAgICAgICAgICAgW1RFU1RfUEFUSDJdOiBbXHJcbiAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgcmFuZ2U6IHtcclxuICAgICAgICAgICAgICAgICAgc3RhcnQ6IHtsaW5lOiAwLCBjaGFyYWN0ZXI6IDB9LFxyXG4gICAgICAgICAgICAgICAgICBlbmQ6IHtsaW5lOiAwLCBjaGFyYWN0ZXI6IDB9LFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIG5ld1RleHQ6ICdhYmMnLFxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIF0sXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3VsdC5hcHBsaWVkKS50by5lcXVhbCh0cnVlKTtcclxuICAgICAgY29uc3QgZWRpdG9yID0gYXdhaXQgYXRvbS53b3Jrc3BhY2Uub3BlbihURVNUX1BBVEgyKTtcclxuICAgICAgZXhwZWN0KGVkaXRvci5nZXRUZXh0KCkpLnRvLmVxdWFsKCdhYmMnKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdmYWlscyB3aXRoIG92ZXJsYXBwaW5nIGVkaXRzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBlZGl0b3IgPSBhd2FpdCBhdG9tLndvcmtzcGFjZS5vcGVuKFRFU1RfUEFUSDMpO1xyXG4gICAgICBlZGl0b3Iuc2V0VGV4dCgnYWJjZGVmXFxuJyk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBBcHBseUVkaXRBZGFwdGVyLm9uQXBwbHlFZGl0KHtcclxuICAgICAgICBlZGl0OiB7XHJcbiAgICAgICAgICBjaGFuZ2VzOiB7XHJcbiAgICAgICAgICAgIFtURVNUX1BBVEgzXTogW1xyXG4gICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXJ0OiB7bGluZTogMCwgY2hhcmFjdGVyOiAwfSxcclxuICAgICAgICAgICAgICAgICAgZW5kOiB7bGluZTogMCwgY2hhcmFjdGVyOiAzfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBuZXdUZXh0OiAnZGVmJyxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIHJhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAgIHN0YXJ0OiB7bGluZTogMCwgY2hhcmFjdGVyOiAyfSxcclxuICAgICAgICAgICAgICAgICAgZW5kOiB7bGluZTogMCwgY2hhcmFjdGVyOiA0fSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBuZXdUZXh0OiAnZ2hpJyxcclxuICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBdLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXN1bHQuYXBwbGllZCkudG8uZXF1YWwoZmFsc2UpO1xyXG4gICAgICBleHBlY3QoXHJcbiAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yLmNhbGxlZFdpdGgoJ3dvcmtzcGFjZS9hcHBseUVkaXRzIGZhaWxlZCcsIHtcclxuICAgICAgICAgIGRlc2NyaXB0aW9uOiAnRmFpbGVkIHRvIGFwcGx5IGVkaXRzLicsXHJcbiAgICAgICAgICBkZXRhaWw6IGBGb3VuZCBvdmVybGFwcGluZyBlZGl0IHJhbmdlcyBpbiAke1RFU1RfUEFUSDN9YCxcclxuICAgICAgICB9KSxcclxuICAgICAgKS50by5lcXVhbCh0cnVlKTtcclxuICAgICAgLy8gTm8gY2hhbmdlcy5cclxuICAgICAgZXhwZWN0KGVkaXRvci5nZXRUZXh0KCkpLnRvLmVxdWFsKCdhYmNkZWZcXG4nKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdmYWlscyB3aXRoIG91dC1vZi1yYW5nZSBlZGl0cycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgQXBwbHlFZGl0QWRhcHRlci5vbkFwcGx5RWRpdCh7XHJcbiAgICAgICAgZWRpdDoge1xyXG4gICAgICAgICAgY2hhbmdlczoge1xyXG4gICAgICAgICAgICBbVEVTVF9QQVRINF06IFtcclxuICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICByYW5nZToge1xyXG4gICAgICAgICAgICAgICAgICBzdGFydDoge2xpbmU6IDAsIGNoYXJhY3RlcjogMX0sXHJcbiAgICAgICAgICAgICAgICAgIGVuZDoge2xpbmU6IDAsIGNoYXJhY3RlcjogMn0sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgbmV3VGV4dDogJ2RlZicsXHJcbiAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgXSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgfSxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzdWx0LmFwcGxpZWQpLnRvLmVxdWFsKGZhbHNlKTtcclxuICAgICAgY29uc3QgZXJyb3JDYWxscyA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvci5nZXRDYWxscygpO1xyXG4gICAgICBleHBlY3QoZXJyb3JDYWxscy5sZW5ndGgpLnRvLmVxdWFsKDEpO1xyXG4gICAgICBleHBlY3QoZXJyb3JDYWxsc1swXS5hcmdzWzFdLmRldGFpbCkudG8uZXF1YWwoYE91dCBvZiByYW5nZSBlZGl0IG9uICR7VEVTVF9QQVRINH06MToyYCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdfQ==